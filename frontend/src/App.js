import React, { useState, useEffect, createContext, useContext, useRef } from 'react';
import { BrowserRouter, Routes, Route, Navigate, useNavigate } from 'react-router-dom';
import axios from 'axios';
import { Toaster } from './components/ui/sonner';
import { toast } from 'sonner';
import './App.css';

const BACKEND_URL = process.env.REACT_APP_BACKEND_URL;
const API = `${BACKEND_URL}/api`;

// Common Maritime Certificate Names for dropdown (matching Add Crew Certificate modal)
const COMMON_CERTIFICATE_NAMES = [
  'Certificate of Competency (COC)',
  'Certificate of Endorsement (COE)',
  'Seaman Book for COC',
  'Seaman book for GMDSS',
  'GMDSS Certificate',
  'Medical Certificate',
  'Basic Safety Training',
  'Advanced Fire Fighting',
  'Ship Security Officer',
  'Survival Craft and Rescue Boats',
  'Medical First Aid',
  'Medical Care',
  'Crowd Management',
  'Crisis Management and Human Behaviour',
  'Designated Security Duties'
];

// Custom hook for draggable modals
const useDraggable = () => {
  const [position, setPosition] = useState({ x: 0, y: 0 });
  const [isDragging, setIsDragging] = useState(false);
  const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
  const modalRef = useRef(null);

  const handleMouseDown = (e) => {
    // Only start drag if clicking on header (not on buttons)
    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
      return;
    }
    
    setIsDragging(true);
    setDragStart({
      x: e.clientX - position.x,
      y: e.clientY - position.y
    });
  };

  const handleMouseMove = (e) => {
    if (!isDragging) return;

    const newX = e.clientX - dragStart.x;
    const newY = e.clientY - dragStart.y;

    setPosition({ x: newX, y: newY });
  };

  const handleMouseUp = () => {
    setIsDragging(false);
  };

  useEffect(() => {
    if (isDragging) {
      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);
      
      return () => {
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
      };
    }
  }, [isDragging, dragStart, position]);

  const resetPosition = () => {
    setPosition({ x: 0, y: 0 });
  };

  return {
    position,
    handleMouseDown,
    isDragging,
    resetPosition,
    modalRef
  };
};

// Date utility function to handle consistent date formatting without time shift
const formatDateDisplay = (dateValue) => {
  if (!dateValue) return '-';
  
  // Handle different date formats consistently
  let dateStr = dateValue;
  if (typeof dateValue === 'object' && dateValue.toString) {
    dateStr = dateValue.toString();
  }
  
  // If it's already in DD/MM/YYYY format, return as is
  if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
    return dateStr;
  }
  
  // Parse ISO date string (YYYY-MM-DD or YYYY-MM-DDTHH:mm:ss) without creating Date object
  // This avoids timezone conversion issues
  if (typeof dateStr === 'string') {
    // Extract just the date part (YYYY-MM-DD)
    const datePart = dateStr.split('T')[0]; // Remove time component if present
    const dateMatch = datePart.match(/^(\d{4})-(\d{2})-(\d{2})/);
    
    if (dateMatch) {
      const [, year, month, day] = dateMatch;
      return `${day}/${month}/${year}`;
    }
  }
  
  // Fallback: try to parse with Date (may have timezone issues)
  try {
    const date = new Date(dateStr);
    if (!isNaN(date.getTime())) {
      // Use UTC methods to avoid timezone shift for dates that might be stored as UTC
      const day = String(date.getUTCDate()).padStart(2, '0');
      const month = String(date.getUTCMonth() + 1).padStart(2, '0');
      const year = date.getUTCFullYear();
      return `${day}/${month}/${year}`;
    }
  } catch (e) {
    console.warn('Date parsing error:', e);
  }
  
  return dateStr; // Return original value if all parsing fails
};

// Get abbreviation from full organization name (first letters of each word)
const getAbbreviation = (fullName) => {
  if (!fullName || fullName === '-') return '-';
  
  // Split by spaces and get first letter of each word
  const words = fullName.trim().split(/\s+/);
  
  // Get first letter of each word (uppercase)
  const abbreviation = words
    .map(word => word.charAt(0).toUpperCase())
    .join('');
  
  return abbreviation;
};

// Vietnamese diacritic removal function
const removeVietnameseDiacritics = (str) => {
  if (!str) return '';
  
  const vietnameseMap = {
    '√†': 'a', '√°': 'a', '·∫°': 'a', '·∫£': 'a', '√£': 'a',
    '√¢': 'a', '·∫ß': 'a', '·∫•': 'a', '·∫≠': 'a', '·∫©': 'a', '·∫´': 'a',
    'ƒÉ': 'a', '·∫±': 'a', '·∫Ø': 'a', '·∫∑': 'a', '·∫≥': 'a', '·∫µ': 'a',
    '√®': 'e', '√©': 'e', '·∫π': 'e', '·∫ª': 'e', '·∫Ω': 'e',
    '√™': 'e', '·ªÅ': 'e', '·∫ø': 'e', '·ªá': 'e', '·ªÉ': 'e', '·ªÖ': 'e',
    '√¨': 'i', '√≠': 'i', '·ªã': 'i', '·ªâ': 'i', 'ƒ©': 'i',
    '√≤': 'o', '√≥': 'o', '·ªç': 'o', '·ªè': 'o', '√µ': 'o',
    '√¥': 'o', '·ªì': 'o', '·ªë': 'o', '·ªô': 'o', '·ªï': 'o', '·ªó': 'o',
    '∆°': 'o', '·ªù': 'o', '·ªõ': 'o', '·ª£': 'o', '·ªü': 'o', '·ª°': 'o',
    '√π': 'u', '√∫': 'u', '·ª•': 'u', '·ªß': 'u', '≈©': 'u',
    '∆∞': 'u', '·ª´': 'u', '·ª©': 'u', '·ª±': 'u', '·ª≠': 'u', '·ªØ': 'u',
    '·ª≥': 'y', '√Ω': 'y', '·ªµ': 'y', '·ª∑': 'y', '·ªπ': 'y',
    'ƒë': 'd',
    // Uppercase versions
    '√Ä': 'A', '√Å': 'A', '·∫†': 'A', '·∫¢': 'A', '√É': 'A',
    '√Ç': 'A', '·∫¶': 'A', '·∫§': 'A', '·∫¨': 'A', '·∫®': 'A', '·∫™': 'A',
    'ƒÇ': 'A', '·∫∞': 'A', '·∫Æ': 'A', '·∫∂': 'A', '·∫≤': 'A', '·∫¥': 'A',
    '√à': 'E', '√â': 'E', '·∫∏': 'E', '·∫∫': 'E', '·∫º': 'E',
    '√ä': 'E', '·ªÄ': 'E', '·∫æ': 'E', '·ªÜ': 'E', '·ªÇ': 'E', '·ªÑ': 'E',
    '√å': 'I', '√ç': 'I', '·ªä': 'I', '·ªà': 'I', 'ƒ®': 'I',
    '√í': 'O', '√ì': 'O', '·ªå': 'O', '·ªé': 'O', '√ï': 'O',
    '√î': 'O', '·ªí': 'O', '·ªê': 'O', '·ªò': 'O', '·ªî': 'O', '·ªñ': 'O',
    '∆†': 'O', '·ªú': 'O', '·ªö': 'O', '·ª¢': 'O', '·ªû': 'O', '·ª†': 'O',
    '√ô': 'U', '√ö': 'U', '·ª§': 'U', '·ª¶': 'U', '≈®': 'U',
    '∆Ø': 'U', '·ª™': 'U', '·ª®': 'U', '·ª∞': 'U', '·ª¨': 'U', '·ªÆ': 'U',
    '·ª≤': 'Y', '√ù': 'Y', '·ª¥': 'Y', '·ª∂': 'Y', '·ª∏': 'Y',
    'ƒê': 'D'
  };

  return str.replace(/./g, char => vietnameseMap[char] || char);
};

// Auto-fill English field from Vietnamese field
const autoFillEnglishField = (vietnameseText) => {
  if (!vietnameseText || vietnameseText.trim() === '') return '';
  return removeVietnameseDiacritics(vietnameseText.trim());
};

// Rank options for quick edit dropdown
const RANK_OPTIONS = [
  { value: 'CAPT', label_vi: 'Thuy·ªÅn tr∆∞·ªüng', label_en: 'CAPT' },
  { value: 'C/O', label_vi: 'ƒê·∫°i ph√≥', label_en: 'C/O' },
  { value: '2/O', label_vi: 'Ph√≥ hai', label_en: '2/O' },
  { value: '3/O', label_vi: 'Ph√≥ ba', label_en: '3/O' },
  { value: 'CE', label_vi: 'M√°y tr∆∞·ªüng', label_en: 'CE' },
  { value: '2/E', label_vi: 'M√°y hai', label_en: '2/E' },
  { value: '3/E', label_vi: 'M√°y ba', label_en: '3/E' },
  { value: '4/E', label_vi: 'M√°y t∆∞', label_en: '4/E' },
  { value: 'BOSUN', label_vi: 'Th·ªßy th·ªß tr∆∞·ªüng', label_en: 'BOSUN' },
  { value: 'ABD', label_vi: 'Thuy·ªÅn vi√™n', label_en: 'ABD' },
  { value: 'ELEC', label_vi: 'Th·ª£ ƒëi·ªán', label_en: 'ELEC' },
  { value: 'FITTER', label_vi: 'Th·ª£ m√°y', label_en: 'FITTER' },
  { value: 'ABE', label_vi: 'Th·ª£ m√°y ph·ªï th√¥ng', label_en: 'ABE' },
  { value: 'OSE', label_vi: 'Th·ª£ m√°y t·∫≠p s·ª±', label_en: 'OSE' },
  { value: 'C/COOK', label_vi: 'B·∫øp tr∆∞·ªüng', label_en: 'C/COOK' },
  { value: 'MESS', label_vi: 'Ph·ª•c v·ª•', label_en: 'MESS' }
];

// Auth Context
const AuthContext = createContext();

const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};

// Auth Provider
const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [language, setLanguage] = useState(localStorage.getItem('language') || 'en');

  // Check for token in both localStorage and sessionStorage
  const getStoredToken = () => {
    return localStorage.getItem('token') || sessionStorage.getItem('token');
  };

  const [token, setToken] = useState(getStoredToken());

  useEffect(() => {
    const initializeAuth = async () => {
      if (token) {
        axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
        // Only verify token if we don't already have user data
        if (!user) {
          await verifyToken();
        }
      }
      setLoading(false);
    };

    initializeAuth();
  }, [token, user]);

  const verifyToken = async () => {
    try {
      // Check if token exists
      if (!token) {
        console.log('No token found');
        return;
      }
      
      // Try to decode token to get user info
      const tokenData = token.split('.')[1];
      const decoded = JSON.parse(atob(tokenData));
      
      // Check if token is expired
      const currentTime = Math.floor(Date.now() / 1000);
      if (decoded.exp && decoded.exp < currentTime) {
        console.warn('Token expired - logging out');
        logout();
        return;
      }
      
      // Create user object from token data
      const userData = {
        id: decoded.sub,
        username: decoded.username,
        role: decoded.role,
        company: decoded.company,
        full_name: decoded.full_name || decoded.username // fallback
      };
      setUser(userData);
    } catch (error) {
      console.warn('Token verification failed:', error.message);
      logout();
    }
  };

  const login = async (credentials) => {
    try {
      const response = await axios.post(`${API}/auth/login`, credentials);
      const { access_token, user, remember_me } = response.data;
      
      setToken(access_token);
      setUser(user);
      
      // Store token based on remember_me preference
      if (remember_me) {
        localStorage.setItem('token', access_token);
        localStorage.setItem('remember_me', 'true');
        // Clear session token
        sessionStorage.removeItem('token');
      } else {
        // Use sessionStorage for session-only login
        sessionStorage.setItem('token', access_token);
        localStorage.removeItem('remember_me');
        // Clear persistent token
        localStorage.removeItem('token');
      }
      
      axios.defaults.headers.common['Authorization'] = `Bearer ${access_token}`;
      
      toast.success(language === 'vi' ? 'ƒêƒÉng nh·∫≠p th√†nh c√¥ng!' : 'Login successful!');
      
      // Note: Upcoming surveys will be checked when HomePage component mounts with token
      // See HomePage useEffect that triggers checkUpcomingSurveys when token && user are available
      
      return true;
    } catch (error) {
      toast.error(language === 'vi' ? 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i!' : 'Login failed!');
      return false;
    }
  };

  const logout = () => {
    setToken(null);
    setUser(null);
    localStorage.removeItem('token');
    localStorage.removeItem('remember_me');
    sessionStorage.removeItem('token');
    delete axios.defaults.headers.common['Authorization'];
    toast.info(language === 'vi' ? 'ƒê√£ ƒëƒÉng xu·∫•t' : 'Logged out');
  };

  const toggleLanguage = () => {
    const newLang = language === 'en' ? 'vi' : 'en';
    setLanguage(newLang);
    localStorage.setItem('language', newLang);
  };

  return (
    <AuthContext.Provider value={{
      user,
      token,
      loading,
      language,
      login,
      logout,
      toggleLanguage,
      isAuthenticated: !!token
    }}>
      {children}
    </AuthContext.Provider>
  );
};

// Protected Route Component
const ProtectedRoute = ({ children }) => {
  const { isAuthenticated, loading } = useAuth();
  
  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-blue-50">
        <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600"></div>
      </div>
    );
  }
  
  return isAuthenticated ? children : <Navigate to="/login" />;
};

// Language Translations
const translations = {
  en: {
    // Navigation
    introduction: "Introduction",
    guide: "Guide", 
    contact: "Contact",
    back: "Back",
    
    // Login Page
    loginTitle: "Ship Management System",
    loginSubtitle: "With AI Support",
    loginDescription: "Maritime document management system built with AI support to help manage documents and records related to ship management and operations automatically and user-friendly. Reducing time and effort for shipping companies.",
    systemNote: "The system is being developed and improved, so we need feedback from companies. All feedback can be sent to Email:",
    username: "Username",
    password: "Password",
    loginButton: "Login",
    version: "Version V.0.0.1",
    
    // Home Page
    homeTitle: "Ship Management System",
    accountManagement: "Account Management",
    documentManagement: "Document Management",
    certificates: "Certificates",
    inspectionRecords: "Class Survey Report", 
    surveyReports: "Test Report",
    drawingsManuals: "Drawings & Manuals",
    otherDocuments: "Other Documents",
    addNew: "Add New",
    
    // Translations
    systemSettings: "System Settings", 
    systemGoogleDrive: "System Google Drive Configuration",
    accountControl: "Account Control",
    companyLogo: "Company Logo",
    addUser: "Add User",
    permissions: "Permissions",
    uploadLogo: "Upload Logo",
    
    // Contact
    contactTitle: "Please contact us through the following methods:",
    email: "Email",
    phone: "Phone",
    
    // Ship Details
    shipName: "Ship Name",
    class: "Class",
    flag: "Flag", 
    grossTonnage: "Gross Tonnage",
    deadweight: "Deadweight",
    certName: "Certificate Name",
    certNo: "Certificate No",
    issueDate: "Issue Date",
    validDate: "Valid Date",
    lastEndorse: "Last Endorse",
    nextSurvey: "Next Survey",
    
    // Permissions
    viewer: "Crew",
    editor: "Ship Officer", 
    manager: "Company Officer",
    admin: "Admin",
    superAdmin: "Super Admin",
    
    // AI Features
    aiAnalysis: "AI Analysis",
    smartSearch: "Smart Search",
    documentSummary: "Document Summary",
    complianceCheck: "Compliance Check",
    expiryAlert: "Expiry Alert"
  },
  vi: {
    // Navigation
    introduction: "Gi·ªõi thi·ªáu",
    guide: "H∆∞·ªõng d·∫´n",
    contact: "Li√™n h·ªá", 
    back: "Quay l·∫°i",
    
    // Login Page
    loginTitle: "H·ªá th·ªëng qu·∫£n l√≠ t√†u bi·ªÉn",
    loginSubtitle: "V·ªõi s·ª± h·ªó tr·ª£ AI",
    loginDescription: "H·ªá th·ªëng qu·∫£n l√≠ d·ªØ li·ªáu t√†u bi·ªÉn ƒë∆∞·ª£c x√¢y d·ª±ng v·ªõi s·ª± h·ªó tr·ª£ c·ªßa c√¥ng ngh·ªá tr√≠ tu·ªá nh√¢n t·∫°o (AI) gi√∫p qu·∫£n l√Ω c√°c t√†i li·ªáu, h·ªì s∆° li√™n quan ƒë·∫øn qu·∫£n l√Ω, v·∫≠n h√†nh khai th√°c t√†u bi·ªÉn m·ªôt c√°ch t·ª± ƒë·ªông, th√¢n thi·ªán v·ªõi ng∆∞·ªùi d√πng. Gi·∫£m b·ªõt th·ªùi gian v√† c√¥ng s·ª©c cho c√°c c√¥ng ty v·∫≠n t·∫£i bi·ªÉn.",
    systemNote: "H·ªá th·ªëng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn v√† ho√†n thi·ªán n√™n r·∫•t c·∫ßn s·ª± ƒë√≥ng g√≥p √Ω ki·∫øn c·ªßa c√°c c√¥ng ty. M·ªçi √Ω ki·∫øn ƒë√≥ng g√≥p xin g·ª≠i v·ªÅ Email:",
    username: "T√™n ƒëƒÉng nh·∫≠p",
    password: "M·∫≠t kh·∫©u",
    loginButton: "ƒêƒÉng nh·∫≠p",
    version: "Phi√™n b·∫£n V.0.0.1",
    
    // Home Page
    homeTitle: "H·ªá th·ªëng qu·∫£n l√≠ t√†u bi·ªÉn",
    accountManagement: "Qu·∫£n l√Ω t√†i kho·∫£n",
    documentManagement: "Qu·∫£n l√Ω t√†i li·ªáu",
    certificates: "Gi·∫•y ch·ª©ng nh·∫≠n",
    inspectionRecords: "H·ªì s∆° ƒêƒÉng ki·ªÉm",
    surveyReports: "B√°o c√°o ki·ªÉm tra", 
    drawingsManuals: "B·∫£n v·∫Ω - S·ªï tay",
    otherDocuments: "H·ªì s∆° kh√°c",
    addNew: "Th√™m",
    
    // Translations
    systemSettings: "C√†i ƒë·∫∑t h·ªá th·ªëng", 
    systemGoogleDrive: "C·∫•u h√¨nh Google Drive h·ªá th·ªëng",
    accountControl: "Qu·∫£n l√Ω t√†i kho·∫£n",
    companyLogo: "Logo c√¥ng ty",
    addUser: "Th√™m ng∆∞·ªùi d√πng",
    permissions: "Ph√¢n quy·ªÅn",
    uploadLogo: "T·∫£i l√™n Logo",
    
    // Contact
    contactTitle: "Vui l√≤ng li√™n h·ªá v·ªõi ch√∫ng t√¥i qua c√°c h√¨nh th·ª©c sau:",
    email: "Email",
    phone: "ƒêi·ªán tho·∫°i",
    
    // Ship Details
    shipName: "T√™n t√†u",
    class: "H·∫°ng",
    flag: "C·ªù",
    grossTonnage: "T·ªïng Dung T√≠ch",
    deadweight: "Tr·ªçng T·∫£i",
    certName: "T√™n ch·ª©ng ch·ªâ",
    certNo: "S·ªë ch·ª©ng ch·ªâ", 
    issueDate: "Ng√†y c·∫•p",
    validDate: "Ng√†y h·∫øt h·∫°n",
    lastEndorse: "X√°c nh·∫≠n cu·ªëi",
    nextSurvey: "Ki·ªÉm tra t·ªõi",
    
    // Permissions
    viewer: "Thuy·ªÅn vi√™n",
    editor: "Sƒ© quan",
    manager: "C√°n b·ªô c√¥ng ty",
    admin: "Qu·∫£n tr·ªã vi√™n", 
    superAdmin: "Si√™u qu·∫£n tr·ªã",
    
    // AI Features
    aiAnalysis: "Ph√¢n t√≠ch AI",
    smartSearch: "T√¨m ki·∫øm th√¥ng minh", 
    documentSummary: "T√≥m t·∫Øt t√†i li·ªáu",
    complianceCheck: "Ki·ªÉm tra tu√¢n th·ªß",
    expiryAlert: "C·∫£nh b√°o h·∫øt h·∫°n"
  }
};

// Login Page Component
const LoginPage = () => {
  const [credentials, setCredentials] = useState({ 
    username: '', 
    password: '', 
    remember_me: localStorage.getItem('remember_me') === 'true' 
  });
  const [currentPage, setCurrentPage] = useState('login');
  const { login, language, toggleLanguage } = useAuth();
  const navigate = useNavigate();
  
  const t = translations[language];

  const handleLogin = async (e) => {
    e.preventDefault();
    const success = await login(credentials);
    if (success) {
      navigate('/home');
    }
  };

  const NavigationBar = ({ currentPage, onNavigate }) => (
    <nav className="flex justify-center space-x-8 mb-8">
      <button
        onClick={() => onNavigate('introduction')}
        className={`px-6 py-2 rounded-full transition-all ${
          currentPage === 'introduction' 
            ? 'bg-blue-600 text-white shadow-lg' 
            : 'bg-white text-blue-600 hover:bg-blue-50 border border-blue-200'
        }`}
      >
        {t.introduction}
      </button>
      <button
        onClick={() => onNavigate('guide')}
        className={`px-6 py-2 rounded-full transition-all ${
          currentPage === 'guide'
            ? 'bg-blue-600 text-white shadow-lg'
            : 'bg-white text-blue-600 hover:bg-blue-50 border border-blue-200'
        }`}
      >
        {t.guide}
      </button>
      <button
        onClick={() => onNavigate('contact')}
        className={`px-6 py-2 rounded-full transition-all ${
          currentPage === 'contact'
            ? 'bg-blue-600 text-white shadow-lg'
            : 'bg-white text-blue-600 hover:bg-blue-50 border border-blue-200'
        }`}
      >
        {t.contact}
      </button>
    </nav>
  );

  if (currentPage === 'introduction') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-slate-50">
        <div className="container mx-auto px-6 py-12">
          <div className="text-center mb-8">
            <h1 className="text-4xl font-bold text-gray-800 mb-2">{t.loginTitle}</h1>
            <p className="text-xl text-blue-600 mb-8">{t.loginSubtitle}</p>
          </div>

          <NavigationBar currentPage={currentPage} onNavigate={setCurrentPage} />

          <div className="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-8 backdrop-blur-sm bg-opacity-95">
            <h2 className="text-2xl font-semibold text-gray-800 mb-6">{t.introduction}</h2>
            <p className="text-gray-600 leading-relaxed mb-6">
              {t.loginDescription}
            </p>
            <p className="text-gray-600 leading-relaxed">
              {t.systemNote} <a href="mailto:AiSMS@gmail.com" className="text-blue-600 hover:underline">AiSMS@gmail.com</a>
            </p>
            
            <div className="mt-8 text-center">
              <button
                onClick={() => setCurrentPage('login')}
                className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-full transition-all shadow-lg hover:shadow-xl"
              >
                {t.back}
              </button>
            </div>
          </div>

          <div className="text-center mt-8">
            <p className="text-sm text-gray-500">{t.loginTitle}</p>
            <p className="text-sm text-gray-400">{t.version}</p>
          </div>
        </div>
      </div>
    );
  }

  if (currentPage === 'guide') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-slate-50">
        <div className="container mx-auto px-6 py-12">
          <div className="text-center mb-8">
            <h1 className="text-4xl font-bold text-gray-800 mb-2">{t.loginTitle}</h1>
            <p className="text-xl text-blue-600 mb-8">{t.loginSubtitle}</p>
          </div>

          <NavigationBar currentPage={currentPage} onNavigate={setCurrentPage} />

          <div className="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-8 backdrop-blur-sm bg-opacity-95">
            <h2 className="text-2xl font-semibold text-gray-800 mb-6">{t.guide}</h2>
            <div className="space-y-4 text-gray-600">
              <div className="p-4 bg-blue-50 rounded-lg">
                <h3 className="font-semibold mb-2">1. {language === 'vi' ? 'ƒêƒÉng nh·∫≠p h·ªá th·ªëng' : 'System Login'}</h3>
                <p>{language === 'vi' ? 'S·ª≠ d·ª•ng t√†i kho·∫£n ƒë∆∞·ª£c c·∫•p ƒë·ªÉ ƒëƒÉng nh·∫≠p v√†o h·ªá th·ªëng' : 'Use your assigned credentials to login to the system'}</p>
              </div>
              <div className="p-4 bg-green-50 rounded-lg">
                <h3 className="font-semibold mb-2">2. {language === 'vi' ? 'Qu·∫£n l√Ω t√†i li·ªáu' : 'Document Management'}</h3>
                <p>{language === 'vi' ? 'Qu·∫£n l√Ω c√°c lo·∫°i ch·ª©ng ch·ªâ, h·ªì s∆° t√†u theo t·ª´ng danh m·ª•c' : 'Manage certificates and ship records by categories'}</p>
              </div>
              <div className="p-4 bg-purple-50 rounded-lg">
                <h3 className="font-semibold mb-2">3. {language === 'vi' ? 'Ph√¢n quy·ªÅn ng∆∞·ªùi d√πng' : 'User Permissions'}</h3>
                <p>{language === 'vi' ? 'H·ªá th·ªëng c√≥ 5 c·∫•p ƒë·ªô quy·ªÅn t·ª´ Thuy·ªÅn vi√™n ƒë·∫øn Super Admin' : 'System has 5 permission levels from Crew to Super Admin'}</p>
              </div>
              <div className="p-4 bg-yellow-50 rounded-lg">
                <h3 className="font-semibold mb-2">4. {language === 'vi' ? 'T√≠nh nƒÉng AI' : 'AI Features'}</h3>
                <p>{language === 'vi' ? 'S·ª≠ d·ª•ng AI ƒë·ªÉ ph√¢n t√≠ch t√†i li·ªáu v√† t√¨m ki·∫øm th√¥ng minh' : 'Use AI for document analysis and smart search'}</p>
              </div>
            </div>
            
            <div className="mt-8 text-center">
              <button
                onClick={() => setCurrentPage('login')}
                className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-full transition-all shadow-lg hover:shadow-xl"
              >
                {t.back}
              </button>
            </div>
          </div>

          <div className="text-center mt-8">
            <p className="text-sm text-gray-500">{t.loginTitle}</p>
            <p className="text-sm text-gray-400">{t.version}</p>
          </div>
        </div>
      </div>
    );
  }

  if (currentPage === 'contact') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-slate-50">
        <div className="container mx-auto px-6 py-12">
          <div className="text-center mb-8">
            <h1 className="text-4xl font-bold text-gray-800 mb-2">{t.loginTitle}</h1>
            <p className="text-xl text-blue-600 mb-8">{t.loginSubtitle}</p>
          </div>

          <NavigationBar currentPage={currentPage} onNavigate={setCurrentPage} />

          <div className="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-8 backdrop-blur-sm bg-opacity-95">
            <h2 className="text-2xl font-semibold text-gray-800 mb-6">{t.contact}</h2>
            <p className="text-gray-600 mb-8">{t.contactTitle}</p>
            
            <div className="grid md:grid-cols-2 gap-8">
              <div className="bg-blue-50 p-6 rounded-xl">
                <h3 className="font-semibold text-lg mb-4 text-blue-800">{t.email}</h3>
                <p className="text-blue-600">
                  <a href="mailto:AiSMS@gmail.com" className="hover:underline">AiSMS@gmail.com</a>
                </p>
              </div>
              
              <div className="bg-green-50 p-6 rounded-xl">
                <h3 className="font-semibold text-lg mb-4 text-green-800">Zalo</h3>
                <p className="text-green-600">AiSMS (0989357282)</p>
              </div>
            </div>
            
            <div className="mt-8 text-center">
              <button
                onClick={() => setCurrentPage('login')}
                className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-full transition-all shadow-lg hover:shadow-xl"
              >
                {t.back}
              </button>
            </div>
          </div>

          <div className="text-center mt-8">
            <p className="text-sm text-gray-500">{t.loginTitle}</p>
            <p className="text-sm text-gray-400">{t.version}</p>
          </div>
        </div>
      </div>
    );
  }

  // Main Login Page
  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-slate-50">
      <div className="container mx-auto px-6 py-12">
        {/* Language Toggle */}
        <div className="absolute top-4 right-4">
          <button
            onClick={toggleLanguage}
            className="bg-white hover:bg-gray-50 border border-gray-200 px-4 py-2 rounded-full text-sm font-medium transition-all shadow-sm"
          >
            {language === 'en' ? 'Ti·∫øng Vi·ªát' : 'English'}
          </button>
        </div>

        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold text-gray-800 mb-2">{t.loginTitle}</h1>
          <p className="text-xl text-blue-600 mb-8">{t.loginSubtitle}</p>
        </div>

        <NavigationBar currentPage={currentPage} onNavigate={setCurrentPage} />

        <div className="max-w-md mx-auto bg-white rounded-2xl shadow-xl p-8 backdrop-blur-sm bg-opacity-95">
          <form onSubmit={handleLogin} className="space-y-6">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                {t.username}
              </label>
              <input
                type="text"
                required
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                value={credentials.username}
                onChange={(e) => setCredentials(prev => ({ ...prev, username: e.target.value }))}
                placeholder={t.username}
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                {t.password}
              </label>
              <input
                type="password"
                required
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                value={credentials.password}
                onChange={(e) => setCredentials(prev => ({ ...prev, password: e.target.value }))}
                placeholder={t.password}
              />
            </div>

            {/* Remember Me Checkbox */}
            <div className="flex items-center">
              <input
                id="remember-me"
                type="checkbox"
                checked={credentials.remember_me}
                onChange={(e) => setCredentials(prev => ({ ...prev, remember_me: e.target.checked }))}
                className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              />
              <label htmlFor="remember-me" className="ml-2 block text-sm text-gray-700">
                {language === 'vi' ? 'Ghi nh·ªõ ƒëƒÉng nh·∫≠p' : 'Remember me'}
              </label>
            </div>

            <button
              type="submit"
              className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg transition-all shadow-lg hover:shadow-xl font-medium"
            >
              {t.loginButton}
            </button>
          </form>

          <div className="mt-6 text-center text-sm text-gray-500">
            <p>{language === 'vi' ? 'T√†i kho·∫£n demo: admin / admin123' : 'Demo account: admin / admin123'}</p>
            <p className="mt-2 text-xs text-gray-400">
              {language === 'vi' ? 
                '"Ghi nh·ªõ ƒëƒÉng nh·∫≠p" s·∫Ω gi·ªØ b·∫°n ƒëƒÉng nh·∫≠p trong 30 ng√†y' : 
                '"Remember me" will keep you logged in for 30 days'
              }
            </p>
          </div>
        </div>

        <div className="text-center mt-8">
          <p className="text-sm text-gray-500">{t.loginTitle}</p>
          <p className="text-sm text-gray-400">{t.version}</p>
        </div>
      </div>
    </div>
  );
};

// Main App Component
const App = () => {
  return (
    <AuthProvider>
      <BrowserRouter>
        <AppContent />
        <Toaster position="top-right" />
      </BrowserRouter>
    </AuthProvider>
  );
};

// App Content Component (inside AuthProvider)
const AppContent = () => {
  const { language } = useAuth();
  const [gdriveConfig, setGdriveConfig] = useState({
    folder_id: ''
  });

  // Handle OAuth 2.0 callback
  useEffect(() => {
    const handleOAuthCallback = async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      const state = urlParams.get('state');
      const storedState = sessionStorage.getItem('oauth_state');

      if (window.location.pathname === '/oauth2callback' && code && state && state === storedState) {
        try {
          const response = await axios.post(`${API}/gdrive/oauth/callback`, {
            authorization_code: code,
            state: state,
            folder_id: gdriveConfig.folder_id
          });

          if (response.data.success) {
            toast.success(language === 'vi' ? 'OAuth x√°c th·ª±c th√†nh c√¥ng!' : 'OAuth authorization successful!');
            
            // Clean up
            sessionStorage.removeItem('oauth_state');
            
            // Redirect back to settings page
            window.location.href = '/';
          } else {
            toast.error(language === 'vi' ? 'OAuth x√°c th·ª±c th·∫•t b·∫°i' : 'OAuth authorization failed');
          }
        } catch (error) {
          console.error('OAuth callback error:', error);
          toast.error(language === 'vi' ? 'L·ªói x·ª≠ l√Ω OAuth callback' : 'OAuth callback processing error');
        }
      }
    };

    handleOAuthCallback();
  }, []);

  // OAuth callback route handling
  if (window.location.pathname === '/oauth2callback') {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p className="text-gray-600">
            {language === 'vi' ? 'ƒêang x·ª≠ l√Ω x√°c th·ª±c OAuth...' : 'Processing OAuth authorization...'}
          </p>
        </div>
      </div>
    );
  }

  return (
    <Routes>
      <Route path="/login" element={<LoginPage />} />
      <Route path="/home" element={<ProtectedRoute><HomePage /></ProtectedRoute>} />
      <Route path="/account-control" element={<ProtectedRoute><AccountControlPage /></ProtectedRoute>} />
      <Route path="/ships" element={<ProtectedRoute><ShipsPage /></ProtectedRoute>} />
      <Route path="/ships/:shipId" element={<ProtectedRoute><ShipDetailPage /></ProtectedRoute>} />
      <Route path="/oauth2callback" element={<div>Processing OAuth...</div>} />
      <Route path="/" element={<Navigate to="/login" />} />
    </Routes>
  );
};

// HomePage Component (Main Dashboard)
const HomePage = () => {
  const { user, token, logout, language, toggleLanguage } = useAuth();
  const [ships, setShips] = useState([]);
  const [selectedCategory, setSelectedCategory] = useState('documents');
  const [hoveredCategory, setHoveredCategory] = useState(null);
  const [selectedShip, setSelectedShip] = useState(null);
  const [selectedSubMenu, setSelectedSubMenu] = useState('certificates');
  const [certificates, setCertificates] = useState([]);
  const [certificateLinksCache, setCertificateLinksCache] = useState({}); // Per-ship cache: {shipId: {certId: {link, url}}}
  const [linksFetching, setLinksFetching] = useState(false); // Loading state for links
  const [companyLogo, setCompanyLogo] = useState(null);
  const [hoverTimeout, setHoverTimeout] = useState(null);
  const [showAddRecord, setShowAddRecord] = useState(false);
  const [addRecordDefaultTab, setAddRecordDefaultTab] = useState(null);
  const [addRecordDefaultDocumentType, setAddRecordDefaultDocumentType] = useState(null);
  const [availableCompanies, setAvailableCompanies] = useState([]);
  const [showFullShipInfo, setShowFullShipInfo] = useState(false);
  const [showShipListModal, setShowShipListModal] = useState(false);
  const [showEditShipModal, setShowEditShipModal] = useState(false);
  const [editingShipData, setEditingShipData] = useState(null);
  const [showDeleteShipModal, setShowDeleteShipModal] = useState(false);
  const [deleteShipData, setDeleteShipData] = useState(null);
  const [deleteShipOption, setDeleteShipOption] = useState('database_only'); // 'database_only' or 'with_gdrive'
  const [isDeletingShip, setIsDeletingShip] = useState(false);
  const [isUpdatingSurveyTypes, setIsUpdatingSurveyTypes] = useState(false);
  const [pendingManualReviews, setPendingManualReviews] = useState([]); // Files requiring manual review
  const [showFileViewer, setShowFileViewer] = useState(false);
  const [fileViewerData, setFileViewerData] = useState(null);
  const [aiConfig, setAiConfig] = useState({ provider: 'Unknown', model: 'Unknown' });
  const [showShipSelector, setShowShipSelector] = useState(false);
  const shipSelectorRef = useRef(null);
  const certFileInputRef = useRef(null);
  
  // Add Crew Modal States
  const [showAddCrewModal, setShowAddCrewModal] = useState(false);
  const [isAddCrewModalMinimized, setIsAddCrewModalMinimized] = useState(false);
  const [showShipDropdown, setShowShipDropdown] = useState(false); // Ship dropdown in Add Crew Modal
  const [newCrewData, setNewCrewData] = useState({
    full_name: '',           // Required - Vietnamese name
    full_name_en: '',        // Optional - English name
    sex: 'M',               // Required 
    date_of_birth: '',      // Required
    place_of_birth: '',     // Required - Vietnamese place
    place_of_birth_en: '',  // Optional - English place
    passport: '',           // Required (PASSPORT No.)
    nationality: '',        // Optional - Nationality
    passport_expiry_date: '', // Optional - Passport expiry date
    rank: '',               // Optional
    seamen_book: '',        // Optional
    status: 'Sign on',      // Optional - Default to 'Sign on'
    ship_sign_on: selectedShip?.name || '-',      // Optional - Default to selected ship or '-'
    place_sign_on: '',      // Optional - Place where crew signs on
    date_sign_on: '',       // Optional
    date_sign_off: ''       // Optional
  });
  
  // Passport Upload States
  const [passportFile, setPassportFile] = useState(null);
  const [passportAnalysis, setPassportAnalysis] = useState(null);
  const [isAnalyzingPassport, setIsAnalyzingPassport] = useState(false);
  const [passportError, setPassportError] = useState('');
  
  // Batch processing states
  const [selectedFiles, setSelectedFiles] = useState([]);
  const [isBatchProcessing, setIsBatchProcessing] = useState(false);
  const [currentFileIndex, setCurrentFileIndex] = useState(0);
  const [batchResults, setBatchResults] = useState([]);
  const [batchProgress, setBatchProgress] = useState({ current: 0, total: 0 });
  const [showProcessingResultsModal, setShowProcessingResultsModal] = useState(false);
  const [processingResults, setProcessingResults] = useState([]);
  
  // Draggable modal hooks
  const processingResultsDrag = useDraggable();
  const addCrewDrag = useDraggable();
  const editCrewDrag = useDraggable();
  const shipListDrag = useDraggable();
  const editShipDrag = useDraggable();
  const deleteShipDrag = useDraggable();
  const editCertDrag = useDraggable();
  const shipConfirmDrag = useDraggable();

  // Crew table sorting
  const [crewSort, setCrewSort] = useState({
    column: null,
    direction: 'asc' // 'asc' or 'desc'
  });
  
  const handleCrewSort = (column) => {
    setCrewSort(prev => ({
      column: column,
      direction: prev.column === column && prev.direction === 'asc' ? 'desc' : 'asc'
    }));
  };

  const getCrewSortIcon = (column) => {
    if (crewSort.column !== column) {
      return null; // No icon when not sorted
    }
    return (
      <span className="ml-1 text-blue-600 text-sm font-bold">
        {crewSort.direction === 'asc' ? '‚ñ≤' : '‚ñº'}
      </span>
    );
  };

  // Crew Submission States
  const [isSubmittingCrew, setIsSubmittingCrew] = useState(false);
  const [crewList, setCrewList] = useState([]);

  // ============================================
  // CREW CERTIFICATES STATES (Steps 6-7)
  // ============================================
  const [showCertificatesView, setShowCertificatesView] = useState(false);
  const [selectedCrewForCertificates, setSelectedCrewForCertificates] = useState(null);
  const [crewCertificates, setCrewCertificates] = useState([]);
  const [certificatesSearch, setCertificatesSearch] = useState('');
  
  // Certificate Filters
  const [certFilters, setCertFilters] = useState({
    shipSignOn: 'all',  // all, specific ship name, or "-" for Standby
    status: 'all',      // all, Valid, Expiring Soon, Expired, Unknown
    crewName: 'all'     // all, or specific crew name
  });
  
  // Auto-reset crew filter when ship sign on filter changes
  useEffect(() => {
    if (showCertificatesView && certFilters.shipSignOn !== 'all') {
      // Reset crew filter to 'all' when ship filter changes
      // User can then select specific crew from the filtered list
      setCertFilters(prev => ({ ...prev, crewName: 'all' }));
    }
  }, [certFilters.shipSignOn, showCertificatesView]);
  
  const [certificateSort, setCertificateSort] = useState({
    column: null,
    direction: 'asc'
  });

  const handleCertificateSort = (column) => {
    setCertificateSort(prev => ({
      column: column,
      direction: prev.column === column && prev.direction === 'asc' ? 'desc' : 'asc'
    }));
  };

  const getCertificateSortIcon = (column) => {
    if (certificateSort.column !== column) {
      return null;
    }
    return (
      <span className="ml-1 text-blue-600 text-sm font-bold">
        {certificateSort.direction === 'asc' ? '‚ñ≤' : '‚ñº'}
      </span>
    );
  };

  // Certificate Context Menu State
  const [certContextMenu, setCertContextMenu] = useState({
    show: false,
    x: 0,
    y: 0,
    cert: null
  });

  // ============================================
  // ADD CREW CERTIFICATE MODAL STATES (Step 10)
  // ============================================
  const [showAddCrewCertModal, setShowAddCrewCertModal] = useState(false);
  const [isAddCrewCertModalMinimized, setIsAddCrewCertModalMinimized] = useState(false);
  const [selectedCrewForCert, setSelectedCrewForCert] = useState(null); // Track selected crew in modal
  const [newCrewCertificate, setNewCrewCertificate] = useState({
    crew_id: '',
    crew_name: '',
    crew_name_en: '',  // English name
    passport: '',
    rank: '',  // Rank
    date_of_birth: '',  // Date of birth
    cert_name: '',
    cert_no: '',
    issued_by: '',
    issued_date: '',
    cert_expiry: '',
    note: '',
    crew_cert_file_id: '',
    crew_cert_summary_file_id: ''  // Summary file ID
  });
  const [isSubmittingCert, setIsSubmittingCert] = useState(false);
  const [showDuplicateCertWarning, setShowDuplicateCertWarning] = useState(false);
  const [duplicateCertInfo, setDuplicateCertInfo] = useState(null);
  
  // Certificate Name Dropdown States (for Edit Modal)
  const [showCertNameDropdown, setShowCertNameDropdown] = useState(false);
  const [certNameSearchTerm, setCertNameSearchTerm] = useState('');
  const certNameDropdownRef = useRef(null);
  
  // Custom Certificate Names (user-added names saved to localStorage)
  const [customCertificateNames, setCustomCertificateNames] = useState([]);
  
  // File upload states (Step 11)
  const [certFile, setCertFile] = useState(null);
  const [isAnalyzingCert, setIsAnalyzingCert] = useState(false);
  const [certAnalysis, setCertAnalysis] = useState(null);
  const [certError, setCertError] = useState('');
  
  // Certificate Holder Mismatch Modal State
  const [certHolderMismatchModal, setCertHolderMismatchModal] = useState({
    show: false,
    holderName: '',
    crewName: '',
    crewNameEn: '',
    file: null
  });

  // Date of Birth Mismatch Modal State
  const [certDobMismatchModal, setCertDobMismatchModal] = useState({
    show: false,
    aiExtractedDob: '',
    crewDob: '',
    crewName: '',
    file: null,
    analysisWithFiles: null  // Store analysis result with files for continuation
  });

  // Edit Crew Certificate Modal States
  const [showEditCrewCertModal, setShowEditCrewCertModal] = useState(false);
  const [editingCrewCert, setEditingCrewCert] = useState(null);
  const [editCrewCertData, setEditCrewCertData] = useState({
    crew_id: '',
    crew_name: '',
    crew_name_en: '',
    passport: '',
    rank: '',
    date_of_birth: '',
    cert_name: '',
    cert_no: '',
    issued_by: '',
    issued_date: '',
    cert_expiry: '',
    note: ''
  });

  // Crew List Filters
  const [crewFilters, setCrewFilters] = useState({
    ship_sign_on: 'All',
    status: 'All', 
    search: ''
  });

  // Crew Selection and Context Menu States
  const [selectedCrewMembers, setSelectedCrewMembers] = useState(new Set());
  const [crewContextMenu, setCrewContextMenu] = useState({
    show: false,
    x: 0,
    y: 0,
    crew: null
  });
  
  // Crew Certificates Selection State
  const [selectedCrewCertificates, setSelectedCrewCertificates] = useState(new Set());
  
  // Batch Upload State for Crew Certificates
  const [isBatchProcessingCerts, setIsBatchProcessingCerts] = useState(false);
  const [certBatchProgress, setCertBatchProgress] = useState({ current: 0, total: 0 });
  const [certBatchResults, setCertBatchResults] = useState([]);
  const [currentCertFileIndex, setCurrentCertFileIndex] = useState(0);
  const [showCertProcessingResultsModal, setShowCertProcessingResultsModal] = useState(false);
  const [certProcessingResults, setCertProcessingResults] = useState([]);
  const [passportContextMenu, setPassportContextMenu] = useState({
    show: false,
    x: 0,
    y: 0,
    crew: null
  });
  const [seamenBookContextMenu, setSeamenBookContextMenu] = useState({
    show: false,
    x: 0,
    y: 0,
    crew: null
  });
  
  // Bulk edit Place Sign On states  
  const [showBulkEditPlaceSignOn, setShowBulkEditPlaceSignOn] = useState(false);
  const [bulkPlaceSignOn, setBulkPlaceSignOn] = useState('');
  
  // Bulk edit Ship Sign On states
  const [showBulkEditShipSignOn, setShowBulkEditShipSignOn] = useState(false);
  const [bulkShipSignOn, setBulkShipSignOn] = useState('');
  
  // Bulk edit Date Sign On states
  const [showBulkEditDateSignOn, setShowBulkEditDateSignOn] = useState(false);
  const [bulkDateSignOn, setBulkDateSignOn] = useState('');
  
  // Bulk edit Date Sign Off states
  const [showBulkEditDateSignOff, setShowBulkEditDateSignOff] = useState(false);
  const [bulkDateSignOff, setBulkDateSignOff] = useState('');
  const [rankContextMenu, setRankContextMenu] = useState({
    show: false,
    x: 0,
    y: 0,
    crew: null
  });

  // Edit Crew Modal States
  const [showEditCrewModal, setShowEditCrewModal] = useState(false);
  const [editingCrew, setEditingCrew] = useState(null);
  const [editCrewData, setEditCrewData] = useState({
    full_name: '',
    full_name_en: '',
    sex: 'M',
    date_of_birth: '',
    place_of_birth: '',
    place_of_birth_en: '',
    passport: '',
    nationality: '',
    passport_expiry_date: '',
    rank: '',
    seamen_book: '',
    status: 'Sign on',
    ship_sign_on: '-',
    place_sign_on: '',
    date_sign_on: '',
    date_sign_off: ''
  });

  // Mock Crew Data (TODO: Replace with actual API data)
  const mockCrewData = [
    {
      id: 1,
      full_name: 'V≈® NG·ªåC T√ÇN',
      sex: 'M',
      rank: 'Captain',
      date_of_birth: '14/02/1983',
      place_of_birth: 'H·∫¢I PH√íNG',
      passport: 'C1571189',
      seamen_book: 'SB123456',
      status: 'Sign on',
      ship_sign_on: 'BROTHER 36',
      date_sign_on: '15/01/2024',
      date_sign_off: ''
    },
    {
      id: 2,
      full_name: 'NGUY·ªÑN VƒÇN A',
      sex: 'M', 
      rank: 'Chief Engineer',
      date_of_birth: '20/05/1985',
      place_of_birth: 'H·ªí CH√ç MINH',
      passport: 'C2345678',
      seamen_book: 'SB234567',
      status: 'Standby',
      ship_sign_on: '-',
      date_sign_on: '',
      date_sign_off: '20/12/2023'
    },
    {
      id: 3,
      full_name: 'TR·∫¶N TH·ªä B',
      sex: 'F',
      rank: 'Cook',
      date_of_birth: '12/08/1990',
      place_of_birth: 'ƒê√Ä N·∫¥NG',
      passport: 'C3456789',
      seamen_book: 'SB345678',
      status: 'Sign on',
      ship_sign_on: 'GRACE 88',
      date_sign_on: '10/03/2024',
      date_sign_off: ''
    },
    {
      id: 4,
      full_name: 'L√ä VƒÇN C',
      sex: 'M',
      rank: 'AB Seaman',
      date_of_birth: '25/11/1988',
      place_of_birth: 'C·∫¶N TH∆†',
      passport: 'C4567890',
      seamen_book: 'SB456789',
      status: 'Leave',
      ship_sign_on: 'BROTHER 36',
      date_sign_on: '01/01/2024',
      date_sign_off: '15/06/2024'
    },
    {
      id: 5,
      full_name: 'PH·∫†M TH·ªä D',
      sex: 'F',
      rank: 'Steward',
      date_of_birth: '08/09/1992',
      place_of_birth: 'HU·∫æ',
      passport: 'C5678901',
      seamen_book: 'SB567890',
      status: 'Sign on',
      ship_sign_on: 'GRACE 88',
      date_sign_on: '20/02/2024',
      date_sign_off: ''
    }
  ];

  // Filtered Crew Data based on current filters (now uses real data from backend)
  const filteredCrewData = crewList.filter(crew => {
    // Search filter (local filtering)
    if (crewFilters.search && crewFilters.search.trim() !== '') {
      const searchTerm = crewFilters.search.toLowerCase();
      return crew.full_name.toLowerCase().includes(searchTerm) ||
             (crew.rank && crew.rank.toLowerCase().includes(searchTerm)) ||
             crew.passport.toLowerCase().includes(searchTerm);
    }

    return true;
  });
  
  // Debug logging for crew list display
  console.log('üîç Crew Data Debug:', {
    crewListLength: crewList.length,
    filteredCrewDataLength: filteredCrewData.length,
    crewFilters,
    selectedCategory
  });

  // Apply sorting to filtered crew data
  const sortedCrewData = (() => {
    if (!crewSort.column) return filteredCrewData;
    
    return [...filteredCrewData].sort((a, b) => {
      let aValue, bValue;
      
      switch (crewSort.column) {
        case 'full_name':
          aValue = (a.full_name || '').toLowerCase();
          bValue = (b.full_name || '').toLowerCase();
          break;
        case 'rank':
          aValue = (a.rank || '').toLowerCase();
          bValue = (b.rank || '').toLowerCase();
          break;
        case 'sex':
          aValue = (a.sex || '').toLowerCase();
          bValue = (b.sex || '').toLowerCase();
          break;
        case 'date_of_birth':
          aValue = a.date_of_birth ? new Date(a.date_of_birth) : new Date(0);
          bValue = b.date_of_birth ? new Date(b.date_of_birth) : new Date(0);
          break;
        case 'place_of_birth':
          aValue = (a.place_of_birth || '').toLowerCase();
          bValue = (b.place_of_birth || '').toLowerCase();
          break;
        case 'passport':
          aValue = (a.passport || '').toLowerCase();
          bValue = (b.passport || '').toLowerCase();
          break;
        case 'nationality':
          aValue = (a.nationality || '').toLowerCase();
          bValue = (b.nationality || '').toLowerCase();
          break;
        case 'passport_expiry_date':
          aValue = a.passport_expiry_date ? new Date(a.passport_expiry_date) : new Date(0);
          bValue = b.passport_expiry_date ? new Date(b.passport_expiry_date) : new Date(0);
          break;
        case 'seamen_book':
          aValue = (a.seamen_book || '').toLowerCase();
          bValue = (b.seamen_book || '').toLowerCase();
          break;
        case 'status':
          aValue = (a.status || '').toLowerCase();
          bValue = (b.status || '').toLowerCase();
          break;
        case 'ship_sign_on':
          aValue = (a.ship_sign_on || '').toLowerCase();
          bValue = (b.ship_sign_on || '').toLowerCase();
          break;
        case 'place_sign_on':
          aValue = (a.place_sign_on || '').toLowerCase();
          bValue = (b.place_sign_on || '').toLowerCase();
          break;
        case 'date_sign_on':
          aValue = a.date_sign_on ? new Date(a.date_sign_on) : new Date(0);
          bValue = b.date_sign_on ? new Date(b.date_sign_on) : new Date(0);
          break;
        case 'date_sign_off':
          aValue = a.date_sign_off ? new Date(a.date_sign_off) : new Date(0);
          bValue = b.date_sign_off ? new Date(b.date_sign_off) : new Date(0);
          break;
        default:
          return 0;
      }
      
      if (aValue < bValue) return crewSort.direction === 'asc' ? -1 : 1;
      if (aValue > bValue) return crewSort.direction === 'asc' ? 1 : -1;
      return 0;
    });
  })();
  
  console.log('üìä sortedCrewData length:', sortedCrewData.length);
  
  // Certificate List filters and sorting
  const [certificateFilters, setCertificateFilters] = useState({
    certificateType: 'all',
    status: 'all',
    search: '' // Add search field
  });
  const [isRefreshing, setIsRefreshing] = useState(false);
  
  // Survey Report List states
  const [surveyReports, setSurveyReports] = useState([]);
  const [surveyReportSort, setSurveyReportSort] = useState({
    column: null,
    direction: 'asc'
  });
  const [surveyReportFilters, setSurveyReportFilters] = useState({
    status: 'all',
    search: ''
  });
  const [showAddSurveyModal, setShowAddSurveyModal] = useState(false);
  const [showEditSurveyModal, setShowEditSurveyModal] = useState(false);
  const [newSurveyReport, setNewSurveyReport] = useState({
    survey_report_name: '',
    report_form: '',  // NEW: Report Form field
    survey_report_no: '',
    issued_date: '',
    issued_by: '',
    status: 'Valid',
    note: '',
    surveyor_name: ''  // NEW: Surveyor name from AI analysis
  });
  const [editingSurveyReport, setEditingSurveyReport] = useState(null);
  
  // Survey Report File Upload States
  const [surveyReportFiles, setSurveyReportFiles] = useState([]);
  const [isAnalyzingSurveyReport, setIsAnalyzingSurveyReport] = useState(false);
  const [surveyReportFileError, setSurveyReportFileError] = useState('');
  const [analyzedSurveyReportData, setAnalyzedSurveyReportData] = useState(null);
  
  // Batch processing states
  const [isBatchProcessingSurveyReports, setIsBatchProcessingSurveyReports] = useState(false);
  const [surveyReportBatchProgress, setSurveyReportBatchProgress] = useState({ current: 0, total: 0 });
  const [surveyReportBatchResults, setSurveyReportBatchResults] = useState([]);
  const [showSurveyReportProcessingResultsModal, setShowSurveyReportProcessingResultsModal] = useState(false);
  const [selectedSurveyReports, setSelectedSurveyReports] = useState(new Set());

  
  // Survey Report Context Menu
  const [surveyReportContextMenu, setSurveyReportContextMenu] = useState({
    show: false,
    x: 0,
    y: 0,
    report: null
  });
  
  // Survey Report Note Tooltip
  const [surveyReportNoteTooltip, setSurveyReportNoteTooltip] = useState({
    show: false,
    x: 0,
    y: 0,
    content: '',
    showBelow: false,
    width: 300
  });


  
  // Certificate table sorting - REMOVED DUPLICATE (now at line 964)

  const getSortIcon = (column) => {
    if (certificateSort.column !== column) {
      return null; // No icon when not sorted
    }
    return (
      <span className="ml-1 text-blue-600 text-sm font-bold">
        {certificateSort.direction === 'asc' ? '‚ñ≤' : '‚ñº'}
      </span>
    );
  };

  const getCertificateStatus = (certificate) => {
    // Rule 1: Certificates without Valid Date always have Valid status
    if (!certificate.valid_date) {
      return 'Valid';
    }
    
    const validDate = new Date(certificate.valid_date);
    const currentDate = new Date();
    currentDate.setHours(0, 0, 0, 0); // Reset time for date-only comparison
    
    // Rule 2: Check if expired first (basic expiry logic)
    if (validDate < currentDate) {
      return 'Expired';
    }
    
    // Rule 3: Enhanced Over Due logic for Full Term Certificates based on Anniversary Date
    if (certificate.cert_type === 'Full Term' && selectedShip?.anniversary_date?.day && selectedShip?.anniversary_date?.month) {
      const currentYear = currentDate.getFullYear();
      
      // Create Anniversary Date for current year
      const anniversaryDate = new Date(currentYear, selectedShip.anniversary_date.month - 1, selectedShip.anniversary_date.day);
      anniversaryDate.setHours(0, 0, 0, 0);
      
      // Add 3-month window after Anniversary Date
      const overdueThreshold = new Date(anniversaryDate);
      overdueThreshold.setMonth(overdueThreshold.getMonth() + 3);
      
      // If current date is past Anniversary Date + 3 months, mark as Over Due
      if (currentDate > overdueThreshold) {
        return 'Over Due';
      }
    }
    
    // Rule 4: Default to Valid if certificate is within valid_date and not over due
    return 'Valid';
  };

  // Certificate selection functions
  const handleSelectCertificate = (certificateId) => {
    const newSelected = new Set(selectedCertificates);
    if (newSelected.has(certificateId)) {
      newSelected.delete(certificateId);
    } else {
      newSelected.add(certificateId);
    }
    setSelectedCertificates(newSelected);
  };

  const handleSelectAllCertificates = (checked) => {
    if (checked) {
      const allVisibleIds = new Set(getFilteredCertificates().map(cert => cert.id));
      setSelectedCertificates(allVisibleIds);
    } else {
      setSelectedCertificates(new Set());
    }
  };

  const isAllSelected = () => {
    const visibleCerts = getFilteredCertificates();
    return visibleCerts.length > 0 && visibleCerts.every(cert => selectedCertificates.has(cert.id));
  };

  const isIndeterminate = () => {
    const visibleCerts = getFilteredCertificates();
    const selectedVisible = visibleCerts.filter(cert => selectedCertificates.has(cert.id));
    return selectedVisible.length > 0 && selectedVisible.length < visibleCerts.length;
  };

  // Survey Report Selection Handlers
  const handleSelectAllSurveyReports = (checked) => {
    if (checked) {
      const allVisibleIds = new Set(getFilteredSurveyReports().map(report => report.id));
      setSelectedSurveyReports(allVisibleIds);
    } else {
      setSelectedSurveyReports(new Set());
    }
  };

  const isSurveyReportsAllSelected = () => {
    const visibleReports = getFilteredSurveyReports();
    return visibleReports.length > 0 && visibleReports.every(report => selectedSurveyReports.has(report.id));
  };

  const isSurveyReportsIndeterminate = () => {
    const visibleReports = getFilteredSurveyReports();
    const selectedVisible = visibleReports.filter(report => selectedSurveyReports.has(report.id));
    return selectedVisible.length > 0 && selectedVisible.length < visibleReports.length;
  };

  const handleSurveyReportSelect = (reportId) => {
    const newSelected = new Set(selectedSurveyReports);
    if (newSelected.has(reportId)) {
      newSelected.delete(reportId);
    } else {
      newSelected.add(reportId);
    }
    setSelectedSurveyReports(newSelected);
  };


  // Column resize functionality
  useEffect(() => {
    let activeColumn = null;
    let startX = 0;
    let startWidth = 0;
    
    const handleMouseMove = (e) => {
      if (!activeColumn) return;
      
      const newWidth = startWidth + (e.clientX - startX);
      
      if (newWidth > 50) { // Minimum width
        activeColumn.style.width = newWidth + 'px';
      }
    };
    
    const handleMouseUp = () => {
      if (activeColumn) {
        activeColumn.removeAttribute('data-resizing');
        activeColumn = null;
      }
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
    };
    
    const initResizeHandlers = () => {
      document.querySelectorAll('.resize-handle').forEach(th => {
        // Remove existing listeners
        th.removeEventListener('mousedown', th._resizeHandler);
        
        th._resizeHandler = (e) => {
          const rect = th.getBoundingClientRect();
          const isNearRightEdge = e.clientX > rect.right - 8;
          
          if (isNearRightEdge) {
            e.preventDefault();
            e.stopPropagation();
            
            activeColumn = th;
            startX = e.clientX;
            startWidth = parseInt(window.getComputedStyle(th).width, 10);
            
            th.setAttribute('data-resizing', 'true');
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
            
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
          }
        };
        
        th.addEventListener('mousedown', th._resizeHandler);
      });
    };
    
    // Initialize after DOM is ready
    const timer = setTimeout(initResizeHandlers, 200);
    
    return () => {
      clearTimeout(timer);
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
    };
  }, [certificates]); // Re-initialize when certificates change

  const sortCertificates = (certificates) => {
    if (!certificateSort.column) return certificates;
    
    return [...certificates].sort((a, b) => {
      let aValue, bValue;
      
      switch (certificateSort.column) {
        case 'cert_abbreviation':
          aValue = (a.cert_abbreviation || '').toLowerCase();
          bValue = (b.cert_abbreviation || '').toLowerCase();
          break;
        case 'cert_type':
          aValue = (a.cert_type || '').toLowerCase();
          bValue = (b.cert_type || '').toLowerCase();
          break;
        case 'cert_no':
          aValue = (a.cert_no || '').toLowerCase();
          bValue = (b.cert_no || '').toLowerCase();
          break;
        case 'issued_by':
          aValue = (a.issued_by || '').toLowerCase();
          bValue = (b.issued_by || '').toLowerCase();
          break;
        case 'issue_date':
          aValue = a.issue_date ? new Date(a.issue_date) : new Date(0);
          bValue = b.issue_date ? new Date(b.issue_date) : new Date(0);
          break;
        case 'valid_date':
          aValue = a.valid_date ? new Date(a.valid_date) : new Date(0);
          bValue = b.valid_date ? new Date(b.valid_date) : new Date(0);
          break;
        case 'status':
          aValue = getCertificateStatus(a);
          bValue = getCertificateStatus(b);
          break;
        case 'last_endorse':
          aValue = a.last_endorse ? new Date(a.last_endorse) : new Date(0);
          bValue = b.last_endorse ? new Date(b.last_endorse) : new Date(0);
          break;
        case 'next_survey':
          aValue = a.next_survey ? new Date(a.next_survey) : new Date(0);
          bValue = b.next_survey ? new Date(b.next_survey) : new Date(0);
          break;
        case 'next_survey_type':
          aValue = (a.next_survey_type || '').toLowerCase();
          bValue = (b.next_survey_type || '').toLowerCase();
          break;
        case 'notes':
          aValue = (a.notes || '').toLowerCase();
          bValue = (b.notes || '').toLowerCase();
          break;
        default:
          return 0;
      }
      
      if (aValue < bValue) return certificateSort.direction === 'asc' ? -1 : 1;
      if (aValue > bValue) return certificateSort.direction === 'asc' ? 1 : -1;
      return 0;
    });
  };

  // Context Menu for Certificate List
  const [contextMenu, setContextMenu] = useState({
    show: false,
    x: 0,
    y: 0,
    certificate: null
  });
  const [selectedCertificates, setSelectedCertificates] = useState(new Set());
  const [showDeleteConfirmation, setShowDeleteConfirmation] = useState(false);
  const [showEditCertModal, setShowEditCertModal] = useState(false);
  const [editingCertificate, setEditingCertificate] = useState(null);
  const [isRenaming, setIsRenaming] = useState(false);
  const [showAutoRenameDialog, setShowAutoRenameDialog] = useState(false);
  const [batchRenameProgress, setBatchRenameProgress] = useState({
    isRunning: false,
    completed: 0,
    total: 0,
    current: '',
    errors: []
  });
  
  // Quick Edit Survey Type states
  const [quickEditMenu, setQuickEditMenu] = useState({
    show: false,
    certificateId: null,
    position: { x: 0, y: 0 },
    currentValue: ''
  });

  // Quick Edit Survey Type functions
  const handleSurveyTypeRightClick = (e, certificateId, currentValue) => {
    console.log('üñ±Ô∏è Survey Type right-click detected:', { certificateId, currentValue, x: e.clientX, y: e.clientY });
    e.preventDefault();
    e.stopPropagation(); // Prevent row context menu from showing
    
    // Close existing context menus
    if (contextMenu.show) {
      setContextMenu({ show: false, x: 0, y: 0, certificate: null });
    }
    
    const menuState = {
      show: true,
      certificateId,
      position: { x: e.clientX, y: e.clientY },
      currentValue: currentValue || ''
    };
    
    console.log('üìã Setting quickEditMenu state:', menuState);
    setQuickEditMenu(menuState);
  };

  const handleQuickUpdateSurveyType = async (newSurveyType) => {
    try {
      const response = await axios.put(`${API}/certificates/${quickEditMenu.certificateId}`, {
        next_survey_type: newSurveyType
      }, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token') || sessionStorage.getItem('token')}`
        }
      });

      // Check for successful response (200 status) instead of success field
      if (response.status === 200 && response.data) {
        // Refresh certificate list from server to ensure data synchronization
        if (selectedShip && selectedShip.id) {
          await fetchCertificates(selectedShip.id);
        }

        toast.success(language === 'vi' 
          ? `‚úÖ ƒê√£ c·∫≠p nh·∫≠t lo·∫°i ki·ªÉm tra th√†nh "${formatSurveyTypeForDisplay(newSurveyType)}"`
          : `‚úÖ Survey type updated to "${formatSurveyTypeForDisplay(newSurveyType)}"`
        );
      }
    } catch (error) {
      console.error('Error updating survey type:', error);
      
      toast.error(language === 'vi' 
        ? '‚ùå L·ªói c·∫≠p nh·∫≠t lo·∫°i ki·ªÉm tra'
        : '‚ùå Failed to update survey type'
      );
    } finally {
      setQuickEditMenu({ show: false, certificateId: null, position: { x: 0, y: 0 }, currentValue: '' });
    }
  };

  const closeQuickEditMenu = () => {
    setQuickEditMenu({ show: false, certificateId: null, position: { x: 0, y: 0 }, currentValue: '' });
  };
  
  // Multi Cert Upload States
  const [multiCertUploads, setMultiCertUploads] = useState([]);
  const [isMultiCertProcessing, setIsMultiCertProcessing] = useState(false);
  const [uploadSummary, setUploadSummary] = useState(null);
  const [duplicateModal, setDuplicateModal] = useState({
    show: false,
    currentFile: '',
    duplicates: [],
    fileIndex: -1,
    resolution: null
  });
  
  // Duplicate resolution modal for multi-cert upload
  const [duplicateResolutionModal, setDuplicateResolutionModal] = useState({
    show: false,
    fileData: null,
    analysisResult: null,
    duplicateInfo: null,
    shipId: null,
    fileIndex: -1,
    fileName: ''
  });

  // Queue system for sequential duplicate resolution
  const [duplicateQueue, setDuplicateQueue] = useState([]);

  // Upcoming surveys notification system
  const [upcomingSurveysModal, setUpcomingSurveysModal] = useState({
    show: false,
    surveys: [],
    totalCount: 0,
    company: '',
    checkDate: ''
  });

  

  // Function to add duplicate to queue and show if none is currently shown
  const addToduplicateQueue = (duplicateData) => {
    setDuplicateQueue(prev => {
      const newQueue = [...prev, duplicateData];
      
      // If no modal is currently shown and this is the first item, show it immediately
      if (!duplicateResolutionModal.show && newQueue.length === 1) {
        setDuplicateResolutionModal({
          show: true,
          fileData: duplicateData.fileData,
          analysisResult: duplicateData.analysisResult,
          duplicateInfo: duplicateData.duplicateInfo,
          shipId: duplicateData.shipId,
          fileIndex: duplicateData.fileIndex,
          fileName: duplicateData.fileName
        });
      }
      
      return newQueue;
    });
  };

  // Function to process next duplicate in queue
  const processNextDuplicate = () => {
    setDuplicateQueue(prev => {
      const newQueue = [...prev];
      newQueue.shift(); // Remove current duplicate
      
      // Show next duplicate if exists
      if (newQueue.length > 0) {
        const nextDuplicate = newQueue[0];
        setDuplicateResolutionModal({
          show: true,
          fileData: nextDuplicate.fileData,
          analysisResult: nextDuplicate.analysisResult,
          duplicateInfo: nextDuplicate.duplicateInfo,
          shipId: nextDuplicate.shipId,
          fileIndex: nextDuplicate.fileIndex,
          fileName: nextDuplicate.fileName
        });
      } else {
        // No more duplicates, hide modal
        setDuplicateResolutionModal({
          show: false,
          fileData: null,
          analysisResult: null,
          duplicateInfo: null,
          shipId: null,
          fileIndex: -1,
          fileName: ''
        });
      }
      
      return newQueue;
    });
  };

  const navigate = useNavigate();
  
  // Function to check upcoming surveys after login
  const checkUpcomingSurveys = async () => {
    try {
      if (!token) return;
      
      const response = await fetch(`${API}/certificates/upcoming-surveys`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (response.ok) {
        const data = await response.json();
        
        if (data.upcoming_surveys && data.upcoming_surveys.length > 0) {
          // Show notification modal using functional update to ensure state change
          setUpcomingSurveysModal(prev => ({
            ...prev,
            show: true,
            surveys: data.upcoming_surveys,
            totalCount: data.total_count,
            company: data.company,
            checkDate: data.check_date
          }));
        }
      }
    } catch (error) {
      console.error('Error checking upcoming surveys:', error);
    }
  };
  
  // Expose checkUpcomingSurveys to global scope for login function to access
  useEffect(() => {
    window.checkUpcomingSurveys = checkUpcomingSurveys;
    return () => {
      delete window.checkUpcomingSurveys;
    };
  }, [token]);
  
  const t = translations[language];

  useEffect(() => {
    fetchShips();
    fetchSettings();
    fetchAvailableCompanies();
    fetchAiConfig(); // Fetch AI config when component mounts
  }, []);

  // Fetch company logo when user logs in
  useEffect(() => {
    if (user && user.company) {
      fetchUserCompanyLogo();
    }
  }, [user]);

  // Check for upcoming surveys when component mounts and token is available
  useEffect(() => {
    if (token && user) {
      setTimeout(() => {
        checkUpcomingSurveys();
      }, 1500); // Delay to ensure component is fully ready
    }
  }, [token, user]);

  // Close quick edit menu when pressing Escape key
  useEffect(() => {
    const handleEscapeKey = (event) => {
      if (event.key === 'Escape' && quickEditMenu.show) {
        closeQuickEditMenu();
      }
    };

    document.addEventListener('keydown', handleEscapeKey);
    return () => {
      document.removeEventListener('keydown', handleEscapeKey);
    };
  }, [quickEditMenu.show]);

  useEffect(() => {
    if (selectedShip && selectedSubMenu === 'certificates') {
      fetchCertificates(selectedShip.id);
    }
  }, [selectedShip, selectedSubMenu]);

  // Fetch survey reports when ship is selected and on class_survey_reports submenu
  useEffect(() => {
    if (selectedShip && selectedSubMenu === 'class_survey_reports') {
      fetchSurveyReports(selectedShip.id);
    }
  }, [selectedShip, selectedSubMenu]);

  // Close survey report context menu on click outside
  useEffect(() => {
    const handleClick = () => {
      if (surveyReportContextMenu.show) {
        setSurveyReportContextMenu({ show: false, x: 0, y: 0, report: null });
      }
    };
    
    if (surveyReportContextMenu.show) {
      document.addEventListener('click', handleClick);
      return () => document.removeEventListener('click', handleClick);
    }
  }, [surveyReportContextMenu.show]);


  // Update newCrewData ship_sign_on and status when selectedShip changes
  useEffect(() => {
    if (selectedShip?.name) {
      setNewCrewData(prevData => ({
        ...prevData,
        ship_sign_on: selectedShip.name,
        status: 'Sign on' // Auto-set status to Sign on when ship is selected
      }));
    }
  }, [selectedShip]);

  // Load custom certificate names from localStorage on mount
  useEffect(() => {
    try {
      const savedCustomNames = localStorage.getItem('customCertificateNames');
      if (savedCustomNames) {
        const parsedNames = JSON.parse(savedCustomNames);
        setCustomCertificateNames(parsedNames);
        console.log('üìö Loaded custom certificate names from localStorage:', parsedNames);
      }
    } catch (error) {
      console.error('Error loading custom certificate names:', error);
    }
  }, []);

  // Handle click outside for Certificate Name dropdown
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (certNameDropdownRef.current && !certNameDropdownRef.current.contains(event.target)) {
        setShowCertNameDropdown(false);
      }
    };

    if (showCertNameDropdown) {
      document.addEventListener('mousedown', handleClickOutside);
      return () => {
        document.removeEventListener('mousedown', handleClickOutside);
      };
    }
  }, [showCertNameDropdown]);

  // Handle click outside for Ship dropdown in Add Crew Modal
  useEffect(() => {
    const handleClickOutside = (event) => {
      // Check if click is outside the ship dropdown
      if (showShipDropdown) {
        const shipDropdown = document.querySelector('.absolute.left-0.top-full.mt-2.bg-white.rounded-lg.shadow-2xl');
        const shipButton = event.target.closest('button');
        
        if (shipDropdown && !shipDropdown.contains(event.target) && !shipButton?.textContent.includes('Ship Select') && !shipButton?.textContent.includes('Ch·ªçn t√†u')) {
          setShowShipDropdown(false);
        }
      }
    };

    if (showShipDropdown) {
      document.addEventListener('mousedown', handleClickOutside);
      return () => {
        document.removeEventListener('mousedown', handleClickOutside);
      };
    }
  }, [showShipDropdown]);

  // Crew selection functions
  const handleSelectCrewMember = (crewId) => {
    const newSelected = new Set(selectedCrewMembers);
    if (newSelected.has(crewId)) {
      newSelected.delete(crewId);
    } else {
      newSelected.add(crewId);
    }
    setSelectedCrewMembers(newSelected);
  };

  const handleSelectAllCrewMembers = (checked) => {
    if (checked) {
      const allVisibleIds = new Set(filteredCrewData.map(crew => crew.id));
      setSelectedCrewMembers(allVisibleIds);
    } else {
      setSelectedCrewMembers(new Set());
    }
  };

  // Crew Certificates selection functions
  const handleSelectCrewCertificate = (certId) => {
    const newSelected = new Set(selectedCrewCertificates);
    if (newSelected.has(certId)) {
      newSelected.delete(certId);
    } else {
      newSelected.add(certId);
    }
    setSelectedCrewCertificates(newSelected);
  };

  const handleSelectAllCrewCertificates = (checked, filteredCerts) => {
    if (checked) {
      const allVisibleIds = new Set(filteredCerts.map(cert => cert.id));
      setSelectedCrewCertificates(allVisibleIds);
    } else {
      setSelectedCrewCertificates(new Set());
    }
  };

  // Crew context menu function
  const handleCrewRightClick = (e, crew) => {
    e.preventDefault();
    
    // Check if user has proper role for crew management
    const allowedRoles = ['company_officer', 'manager', 'admin', 'super_admin'];
    if (!allowedRoles.includes(user?.role)) {
      return; // Don't show context menu for unauthorized users
    }
    
    // If crew is not selected, add it to current selection
    if (!selectedCrewMembers.has(crew.id)) {
      const newSelected = new Set(selectedCrewMembers);
      newSelected.add(crew.id);
      setSelectedCrewMembers(newSelected);
    }
    
    // Calculate context menu position with viewport boundary checking
    const contextMenuWidth = 200;
    const contextMenuHeight = 100;
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    
    let x = e.clientX;
    let y = e.clientY;
    
    // Adjust position if menu would overflow viewport
    if (x + contextMenuWidth > viewportWidth) {
      x = viewportWidth - contextMenuWidth - 10;
    }
    if (y + contextMenuHeight > viewportHeight) {
      y = y - contextMenuHeight;
      if (y < 0) {
        y = viewportHeight - contextMenuHeight - 10;
      }
    }
    if (x < 0) x = 10;
    if (y < 0) y = 10;
    
    setCrewContextMenu({
      show: true,
      x: x,
      y: y,
      crew: crew
    });
  };

  // Delete selected crew members
  const handleDeleteSelectedCrewMembers = async () => {
    try {
      if (selectedCrewMembers.size === 0) return;
      
      // Show confirmation
      const confirmed = window.confirm(
        language === 'vi' 
          ? `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ${selectedCrewMembers.size} thuy·ªÅn vi√™n ƒë√£ ch·ªçn?`
          : `Are you sure you want to delete ${selectedCrewMembers.size} selected crew member(s)?`
      );
      
      if (!confirmed) return;
      
      const selectedCrewData = crewList.filter(crew => selectedCrewMembers.has(crew.id));
      let deletedCount = 0;
      let errorCount = 0;
      let hasCertificatesErrors = [];
      
      // Delete each crew member
      for (const crew of selectedCrewData) {
        try {
          const response = await axios.delete(`${API}/crew/${crew.id}`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          
          if (response.status === 200) {
            console.log(`‚úÖ Deleted crew member: ${crew.full_name}`);
            deletedCount++;
          }
        } catch (error) {
          console.error(`‚ùå Failed to delete crew member: ${crew.full_name}`, error);
          
          // Check if error is due to existing certificates
          if (error.response?.status === 400 && error.response?.data?.detail?.error === 'CREW_HAS_CERTIFICATES') {
            const errorData = error.response.data.detail;
            hasCertificatesErrors.push({
              crewName: errorData.crew_name,
              certificateCount: errorData.certificate_count
            });
            console.log(`‚ö†Ô∏è ${errorData.crew_name} has ${errorData.certificate_count} certificate(s)`);
          } else {
            errorCount++;
          }
        }
      }
      
      // Always refresh crew list after deletion attempts
      console.log('üîÑ Refreshing crew list after deletion...');
      if (selectedShip?.name) {
        await fetchCrewMembers(selectedShip.name);
        console.log('‚úÖ Crew list refreshed successfully');
      }
      
      // Clear selection
      setSelectedCrewMembers(new Set());
      
      // Show appropriate success message
      if (deletedCount > 0) {
        toast.success(language === 'vi' 
          ? `ƒê√£ x√≥a th√†nh c√¥ng ${deletedCount} thuy·ªÅn vi√™n` 
          : `Successfully deleted ${deletedCount} crew member(s)`);
      }
      
      // Show certificates warning
      if (hasCertificatesErrors.length > 0) {
        const crewNames = hasCertificatesErrors.map(e => `"${e.crewName}" (${e.certificateCount} ch·ª©ng ch·ªâ)`).join(', ');
        const message = language === 'vi'
          ? `Kh√¥ng th·ªÉ x√≥a thuy·ªÅn vi√™n: ${crewNames}. H√£y x√≥a to√†n b·ªô c√°c ch·ª©ng ch·ªâ tr∆∞·ªõc khi x√≥a d·ªØ li·ªáu thuy·ªÅn vi√™n.`
          : `Cannot delete crew: ${crewNames}. Please delete all certificates before deleting crew member.`;
        
        alert(message);
      }
      
      if (errorCount > 0) {
        toast.warning(language === 'vi' 
          ? `${errorCount} thuy·ªÅn vi√™n kh√¥ng th·ªÉ x√≥a ƒë∆∞·ª£c` 
          : `${errorCount} crew member(s) could not be deleted`);
      }
        
    } catch (error) {
      console.error('Delete crew error:', error);
      toast.error(language === 'vi' ? 'L·ªói khi x√≥a thuy·ªÅn vi√™n' : 'Error deleting crew members');
      
      // Still refresh the list even if there was an error
      if (selectedShip?.name) {
        console.log('üîÑ Refreshing crew list after error...');
        await fetchCrewMembers(selectedShip.name);
      }
      setSelectedCrewMembers(new Set());
    }
    
    // Close context menu
    setCrewContextMenu({ show: false, x: 0, y: 0, crew: null });
  };

  // Passport context menu function
  const handlePassportRightClick = (e, crew) => {
    e.preventDefault();
    e.stopPropagation(); // Prevent row context menu from showing
    
    // Only show context menu if crew has passport
    if (!crew.passport) {
      return;
    }
    
    // Calculate context menu position
    const contextMenuWidth = 200;
    const contextMenuHeight = 150;
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    
    let x = e.clientX;
    let y = e.clientY;
    
    // Adjust position if menu would overflow viewport
    if (x + contextMenuWidth > viewportWidth) {
      x = viewportWidth - contextMenuWidth - 10;
    }
    if (y + contextMenuHeight > viewportHeight) {
      y = y - contextMenuHeight;
      if (y < 0) {
        y = viewportHeight - contextMenuHeight - 10;
      }
    }
    if (x < 0) x = 10;
    if (y < 0) y = 10;
    
    setPassportContextMenu({
      show: true,
      x: x,
      y: y,
      crew: crew
    });
  };

  // Handle passport actions
  const handleViewPassport = async (crew) => {
    setPassportContextMenu({ show: false, x: 0, y: 0, crew: null });
    
    try {
      // Check if multiple crew members are selected
      if (selectedCrewMembers.size > 0) {
        const selectedCrewIds = Array.from(selectedCrewMembers);
        const selectedCrewData = crewList.filter(c => selectedCrewIds.includes(c.id));
        const crewWithFiles = selectedCrewData.filter(c => c.passport_file_id);
        
        if (crewWithFiles.length === 0) {
          toast.warning(language === 'vi' 
            ? 'Kh√¥ng c√≥ thuy·ªÅn vi√™n n√†o c√≥ file h·ªô chi·∫øu'
            : 'No crew members have passport files');
          return;
        }
        
        toast.info(language === 'vi' 
          ? `ƒêang m·ªü ${crewWithFiles.length} file h·ªô chi·∫øu...`
          : `Opening ${crewWithFiles.length} passport files...`);
        
        // Open all passport files in new tabs
        crewWithFiles.forEach((c, index) => {
          setTimeout(() => {
            const googleDriveViewUrl = `https://drive.google.com/file/d/${c.passport_file_id}/view`;
            window.open(googleDriveViewUrl, '_blank');
            console.log(`üìÑ Opening passport ${index + 1}/${crewWithFiles.length} for ${c.full_name}`);
          }, index * 300); // Delay to prevent browser popup blocking
        });
        
        return;
      }
      
      // Single crew view
      if (crew.passport_file_id) {
        const googleDriveViewUrl = `https://drive.google.com/file/d/${crew.passport_file_id}/view`;
        window.open(googleDriveViewUrl, '_blank');
        console.log(`üìÑ Opening original passport file for ${crew.full_name}: ${googleDriveViewUrl}`);
        
        toast.info(language === 'vi' 
          ? 'ƒêang m·ªü file h·ªô chi·∫øu g·ªëc...' 
          : 'Opening original passport file...');
      } else {
        const passportInfo = `Passport Information (No original file available)\n\nName: ${crew.full_name}\nPassport No: ${crew.passport || 'Not specified'}\nDate of Birth: ${crew.date_of_birth || 'Not specified'}\nPlace of Birth: ${crew.place_of_birth || 'Not specified'}\nNationality: ${crew.nationality || 'Not specified'}\nPassport Expiry: ${crew.passport_expiry_date ? formatDateDisplay(crew.passport_expiry_date) : 'Not specified'}`;
        
        alert(passportInfo);
        
        toast.warning(language === 'vi' 
          ? 'Kh√¥ng c√≥ file h·ªô chi·∫øu g·ªëc, hi·ªÉn th·ªã th√¥ng tin c√≥ s·∫µn' 
          : 'No original passport file available, showing available information');
      }
      
    } catch (error) {
      console.error('View passport error:', error);
      toast.error(language === 'vi' ? 'L·ªói khi xem h·ªô chi·∫øu' : 'Error viewing passport');
    }
  };

  const handleCopyPassportLink = async (crew) => {
    setPassportContextMenu({ show: false, x: 0, y: 0, crew: null });
    
    try {
      // Check if multiple crew members are selected
      if (selectedCrewMembers.size > 0) {
        const selectedCrewIds = Array.from(selectedCrewMembers);
        const selectedCrewData = crewList.filter(c => selectedCrewIds.includes(c.id));
        const crewWithFiles = selectedCrewData.filter(c => c.passport_file_id);
        
        if (crewWithFiles.length === 0) {
          toast.warning(language === 'vi' 
            ? 'Kh√¥ng c√≥ thuy·ªÅn vi√™n n√†o c√≥ file h·ªô chi·∫øu'
            : 'No crew members have passport files');
          return;
        }
        
        // Create list of all links with crew names
        const links = crewWithFiles.map(c => 
          `${c.full_name}: https://drive.google.com/file/d/${c.passport_file_id}/view`
        ).join('\n');
        
        await navigator.clipboard.writeText(links);
        
        console.log(`üîó Copied ${crewWithFiles.length} passport file links`);
        
        toast.success(language === 'vi' 
          ? `ƒê√£ sao ch√©p ${crewWithFiles.length} link file h·ªô chi·∫øu` 
          : `Copied ${crewWithFiles.length} passport file links`);
        
        return;
      }
      
      // Single crew copy
      if (crew.passport_file_id) {
        const googleDriveLink = `https://drive.google.com/file/d/${crew.passport_file_id}/view`;
        
        await navigator.clipboard.writeText(googleDriveLink);
        
        console.log(`üîó Copied original passport file link for ${crew.full_name}: ${googleDriveLink}`);
        
        toast.success(language === 'vi' 
          ? 'ƒê√£ sao ch√©p link file h·ªô chi·∫øu g·ªëc' 
          : 'Original passport file link copied to clipboard');
      } else {
        const fallbackLink = `${window.location.origin}/crew/${crew.id}/passport`;
        
        await navigator.clipboard.writeText(fallbackLink);
        
        toast.warning(language === 'vi' 
          ? 'Kh√¥ng c√≥ file g·ªëc, ƒë√£ sao ch√©p link th√¥ng tin h·ªô chi·∫øu' 
          : 'No original file available, copied passport info link');
      }
      
    } catch (error) {
      console.error('Copy passport link error:', error);
      toast.error(language === 'vi' ? 'L·ªói khi sao ch√©p link' : 'Error copying link');
    }
  };

  const handleDownloadPassport = async (crew) => {
    setPassportContextMenu({ show: false, x: 0, y: 0, crew: null });
    
    try {
      // Check if multiple crew members are selected
      if (selectedCrewMembers.size > 0) {
        const selectedCrewIds = Array.from(selectedCrewMembers);
        const selectedCrewData = crewList.filter(c => selectedCrewIds.includes(c.id));
        const crewWithFiles = selectedCrewData.filter(c => c.passport_file_id);
        
        if (crewWithFiles.length === 0) {
          toast.warning(language === 'vi' 
            ? 'Kh√¥ng c√≥ thuy·ªÅn vi√™n n√†o c√≥ file h·ªô chi·∫øu'
            : 'No crew members have passport files');
          return;
        }
        
        toast.info(language === 'vi' 
          ? `ƒêang t·∫£i xu·ªëng ${crewWithFiles.length} file h·ªô chi·∫øu...`
          : `Downloading ${crewWithFiles.length} passport files...`);
        
        // Download all passport files
        crewWithFiles.forEach((c, index) => {
          setTimeout(() => {
            const googleDriveDownloadUrl = `https://drive.google.com/uc?export=download&id=${c.passport_file_id}`;
            window.open(googleDriveDownloadUrl, '_blank');
            console.log(`üì• Downloading passport ${index + 1}/${crewWithFiles.length} for ${c.full_name}`);
          }, index * 300); // Delay to prevent browser popup blocking
        });
        
        toast.success(language === 'vi' 
          ? `ƒê√£ b·∫Øt ƒë·∫ßu t·∫£i xu·ªëng ${crewWithFiles.length} file t·ª´ Google Drive` 
          : `Started downloading ${crewWithFiles.length} files from Google Drive`);
        
        return;
      }
      
      // Single crew download
      if (crew.passport_file_id) {
        toast.info(language === 'vi' ? 'ƒêang t·∫£i xu·ªëng file h·ªô chi·∫øu g·ªëc...' : 'Downloading original passport file...');
        
        const googleDriveDownloadUrl = `https://drive.google.com/uc?export=download&id=${crew.passport_file_id}`;
        window.open(googleDriveDownloadUrl, '_blank');
        
        console.log(`üì• Downloading original passport file for ${crew.full_name}: ${googleDriveDownloadUrl}`);
        
        toast.success(language === 'vi' 
          ? 'ƒêang t·∫£i xu·ªëng file h·ªô chi·∫øu g·ªëc t·ª´ Google Drive' 
          : 'Downloading original passport file from Google Drive');
        
      } else {
        console.log(`‚ö†Ô∏è No passport_file_id for ${crew.full_name}, creating fallback download`);
        
        const passportInfo = `Passport Information (No original file available)\n\nName: ${crew.full_name}\nPassport No: ${crew.passport || 'Not specified'}\nDate of Birth: ${crew.date_of_birth || 'Not specified'}\nPlace of Birth: ${crew.place_of_birth || 'Not specified'}\nNationality: ${crew.nationality || 'Not specified'}\nPassport Expiry: ${crew.passport_expiry_date ? formatDateDisplay(crew.passport_expiry_date) : 'Not specified'}\nSex: ${crew.sex || 'Not specified'}\nStatus: ${crew.status || 'Not specified'}\nRank: ${crew.rank || 'Not specified'}`;
        
        const blob = new Blob([passportInfo], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${crew.full_name}_Passport_Info.txt`;
        document.body.appendChild(link);
        link.click();
        link.remove();
        window.URL.revokeObjectURL(url);
        
        toast.warning(language === 'vi' 
          ? 'Kh√¥ng c√≥ file g·ªëc, ƒë√£ t·∫£i xu·ªëng th√¥ng tin h·ªô chi·∫øu' 
          : 'No original file available, downloaded passport information');
      }
      
    } catch (error) {
      console.error('Download passport error:', error);
      toast.error(language === 'vi' ? 'L·ªói khi t·∫£i xu·ªëng h·ªô chi·∫øu' : 'Error downloading passport');
    }
  };
  const handleCopyPassportText = async (crew) => {
    try {
      const passportInfo = `Passport Information\n\nName: ${crew.full_name}\nPassport No: ${crew.passport}\nDate of Birth: ${crew.date_of_birth}\nPlace of Birth: ${crew.place_of_birth}\nSex: ${crew.sex}\nStatus: ${crew.status}`;
      
      const blob = new Blob([passportInfo], { type: 'text/plain' });
      
      // Check if Clipboard API is available
      if (navigator.clipboard && navigator.clipboard.write) {
        const item = new ClipboardItem({ 'text/plain': blob });
        await navigator.clipboard.write([item]);
      } else {
        // Fallback for older browsers
        await navigator.clipboard.writeText(passportInfo);
      }
      
      toast.success(language === 'vi' ? 'Th√¥ng tin h·ªô chi·∫øu ƒë√£ ƒë∆∞·ª£c sao ch√©p!' : 'Passport information copied to clipboard!');
    } catch (error) {
      console.error('Failed to copy passport info:', error);
      toast.error(language === 'vi' ? 'Kh√¥ng th·ªÉ sao ch√©p th√¥ng tin!' : 'Failed to copy information!');
    }
    
    setPassportContextMenu({ show: false, x: 0, y: 0, crew: null });
  };

  // Handle automatic rename passport files
  const handleAutomaticRenamePassportFiles = async (crew) => {
    setPassportContextMenu({ show: false, x: 0, y: 0, crew: null });
    
    // Check if multiple crew members are selected
    if (selectedCrewMembers.size > 0) {
      // Bulk rename with confirmation
      const selectedCrewIds = Array.from(selectedCrewMembers);
      const selectedCrewData = crewList.filter(c => selectedCrewIds.includes(c.id));
      
      // Count how many have files
      const crewWithFiles = selectedCrewData.filter(c => c.passport_file_id || c.summary_file_id);
      
      if (crewWithFiles.length === 0) {
        toast.warning(language === 'vi' 
          ? 'Kh√¥ng c√≥ thuy·ªÅn vi√™n n√†o c√≥ file ƒë·ªÉ ƒë·ªïi t√™n'
          : 'No crew members have files to rename');
        return;
      }

      // Show confirmation dialog with preview
      const confirmMessage = language === 'vi' 
        ? `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën t·ª± ƒë·ªông ƒë·ªïi t√™n file cho ${crewWithFiles.length} thuy·ªÅn vi√™n ƒë∆∞·ª£c ch·ªçn?\n\n` +
          `ƒê·ªãnh d·∫°ng: Ch·ª©c v·ª•_T√™n (Ti·∫øng Anh)_Passport\n\n` +
          `V√≠ d·ª•:\n${crewWithFiles.slice(0, 3).map(c => {
            const rank = c.rank || 'Unknown';
            const nameEn = c.full_name_en || c.full_name || 'Unknown';
            return `‚Ä¢ ${c.full_name} ‚Üí ${rank}_${nameEn}_Passport.pdf`;
          }).join('\n')}${crewWithFiles.length > 3 ? `\n... v√† ${crewWithFiles.length - 3} thuy·ªÅn vi√™n kh√°c` : ''}\n\n` +
          `‚ö†Ô∏è H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`
        : `Are you sure you want to automatically rename files for ${crewWithFiles.length} selected crew members?\n\n` +
          `Format: Rank_Name (English)_Passport\n\n` +
          `Examples:\n${crewWithFiles.slice(0, 3).map(c => {
            const rank = c.rank || 'Unknown';
            const nameEn = c.full_name_en || c.full_name || 'Unknown';
            return `‚Ä¢ ${c.full_name} ‚Üí ${rank}_${nameEn}_Passport.pdf`;
          }).join('\n')}${crewWithFiles.length > 3 ? `\n... and ${crewWithFiles.length - 3} more crew members` : ''}\n\n` +
          `‚ö†Ô∏è This action cannot be undone!`;

      if (confirm(confirmMessage)) {
        performBulkAutomaticRename(crewWithFiles);
      }
      return;
    }
    
    // Single crew rename with confirmation
    if (!crew.passport_file_id && !crew.summary_file_id) {
      toast.warning(language === 'vi' 
        ? 'Kh√¥ng c√≥ file n√†o ƒë·ªÉ ƒë·ªïi t√™n cho thuy·ªÅn vi√™n n√†y'
        : 'No files available to rename for this crew member');
      return;
    }
    
    // Generate automatic filename format for preview
    const rank = crew.rank || 'Unknown';
    const fullNameEn = crew.full_name_en || crew.full_name || 'Unknown';
    const passportSuffix = 'Passport';
    const autoFilename = `${rank}_${fullNameEn}_${passportSuffix}`;
    
    // Show confirmation dialog for single crew
    const confirmMessage = language === 'vi'
      ? `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën t·ª± ƒë·ªông ƒë·ªïi t√™n file cho thuy·ªÅn vi√™n n√†y?\n\n` +
        `ƒê·ªãnh d·∫°ng: Ch·ª©c v·ª•_T√™n (Ti·∫øng Anh)_Passport\n\n` +
        `V√≠ d·ª•:\n‚Ä¢ ${crew.full_name} ‚Üí ${autoFilename}.pdf\n\n` +
        `‚ö†Ô∏è H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`
      : `Are you sure you want to automatically rename files for this crew member?\n\n` +
        `Format: Rank_Name (English)_Passport\n\n` +
        `Example:\n‚Ä¢ ${crew.full_name} ‚Üí ${autoFilename}.pdf\n\n` +
        `‚ö†Ô∏è This action cannot be undone!`;
    
    if (!confirm(confirmMessage)) {
      return;
    }
    
    console.log(`üîÑ Auto-generating filename for ${crew.full_name}:`);
    console.log(`   Rank: "${rank}" (kept as-is)`);
    console.log(`   Name (English): "${fullNameEn}" (kept as-is)`);
    console.log(`   Passport Suffix: "${passportSuffix}"`);
    console.log(`   Final: "${autoFilename}"`);
    
    try {
      toast.info(language === 'vi' 
        ? 'ƒêang t·ª± ƒë·ªông ƒë·ªïi t√™n files...' 
        : 'Auto-renaming files...');
      
      const formData = new FormData();
      formData.append('new_filename', autoFilename);
      
      const response = await axios.post(`${API}/crew/${crew.id}/rename-files`, formData, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'multipart/form-data'
        }
      });
      
      if (response.data.success) {
        toast.success(language === 'vi' 
          ? `ƒê√£ t·ª± ƒë·ªông ƒë·ªïi t√™n files th√†nh c√¥ng: ${response.data.renamed_files.join(', ')}`
          : `Files automatically renamed successfully: ${response.data.renamed_files.join(', ')}`
        );
        
        console.log(`‚úÖ Files automatically renamed:`, {
          original_format: autoFilename,
          passport_file: `${autoFilename}.pdf (or original extension)`,
          summary_file: `${autoFilename}_Summary.txt`,
          renamed_files: response.data.renamed_files
        });
        
        // Refresh crew list to show any updated information
        if (selectedShip?.name) {
          await fetchCrewMembers(selectedShip.name);
        }
      } else {
        toast.error(language === 'vi' ? 'Kh√¥ng th·ªÉ t·ª± ƒë·ªông ƒë·ªïi t√™n files' : 'Failed to auto-rename files');
      }
      
    } catch (error) {
      console.error('Auto rename files error:', error);
      toast.error(language === 'vi' 
        ? `L·ªói t·ª± ƒë·ªông ƒë·ªïi t√™n files: ${error.response?.data?.detail || error.message}`
        : `Auto rename files error: ${error.response?.data?.detail || error.message}`
      );
    }
  };

  // Function removed - logic integrated into handleAutomaticRenamePassportFiles

  // Perform bulk automatic rename for selected crew
  const performBulkAutomaticRename = async (crewList) => {
    try {
      let successCount = 0;
      let errorCount = 0;
      const results = [];

      toast.info(language === 'vi' 
        ? `B·∫Øt ƒë·∫ßu t·ª± ƒë·ªông ƒë·ªïi t√™n file cho ${crewList.length} thuy·ªÅn vi√™n...`
        : `Starting automatic rename for ${crewList.length} crew members...`);

      console.log(`üîÑ Starting bulk automatic rename for ${crewList.length} crew members`);

      for (let i = 0; i < crewList.length; i++) {
        const crew = crewList[i];
        
        try {
          console.log(`üìã Processing ${i + 1}/${crewList.length}: ${crew.full_name}`);
          
          // Generate filename same as single crew logic
          const rank = crew.rank || 'Unknown';
          const fullNameEn = crew.full_name_en || crew.full_name || 'Unknown';
          const passportSuffix = 'Passport';
          
          // Keep both rank and name as-is (no character replacement)
          const autoFilename = `${rank}_${fullNameEn}_${passportSuffix}`;

          console.log(`   Generated filename: ${autoFilename}`);

          // Call rename API
          const formData = new FormData();
          formData.append('new_filename', autoFilename);
          
          const response = await axios.post(`${API}/crew/${crew.id}/rename-files`, formData, {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'multipart/form-data'
            }
          });
          
          if (response.data.success) {
            successCount++;
            results.push({
              crew_name: crew.full_name,
              success: true,
              filename: autoFilename,
              renamed_files: response.data.renamed_files
            });
            console.log(`   ‚úÖ Success: ${crew.full_name}`);
          } else {
            errorCount++;
            results.push({
              crew_name: crew.full_name,
              success: false,
              error: response.data.message || 'Unknown error'
            });
            console.log(`   ‚ùå Failed: ${crew.full_name}`);
          }
          
        } catch (error) {
          errorCount++;
          results.push({
            crew_name: crew.full_name,
            success: false,
            error: error.response?.data?.detail || error.message
          });
          console.error(`   ‚ùå Error for ${crew.full_name}:`, error);
        }

        // Small delay between requests
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      // Show final results
      console.log(`üìä Bulk rename completed: ${successCount} success, ${errorCount} errors`);

      if (successCount > 0 && errorCount === 0) {
        toast.success(language === 'vi' 
          ? `ƒê√£ t·ª± ƒë·ªông ƒë·ªïi t√™n file th√†nh c√¥ng cho ${successCount} thuy·ªÅn vi√™n`
          : `Successfully renamed files for ${successCount} crew members`);
      } else if (successCount > 0 && errorCount > 0) {
        toast.warning(language === 'vi' 
          ? `Ho√†n th√†nh: ${successCount} th√†nh c√¥ng, ${errorCount} l·ªói`
          : `Completed: ${successCount} successful, ${errorCount} failed`);
      } else {
        toast.error(language === 'vi' 
          ? 'Kh√¥ng th·ªÉ ƒë·ªïi t√™n file n√†o'
          : 'Failed to rename any files');
      }

      // Refresh crew list and clear selection
      if (successCount > 0) {
        if (selectedShip?.name) {
          await fetchCrewMembers(selectedShip.name);
        }
      }

      setSelectedCrewMembers(new Set()); // Clear selection

    } catch (error) {
      console.error('Bulk automatic rename error:', error);
      toast.error(language === 'vi' 
        ? 'L·ªói x·ª≠ l√Ω h√†ng lo·∫°t'
        : 'Bulk processing error');
    }
  };

  // Seamen Book context menu function
  const handleSeamenBookRightClick = (e, crew) => {
    e.preventDefault();
    e.stopPropagation(); // Prevent row context menu from showing
    
    // Only show context menu if crew has seamen book
    if (!crew.seamen_book || crew.seamen_book === '-') {
      return;
    }
    
    // Calculate context menu position
    const contextMenuWidth = 200;
    const contextMenuHeight = 150;
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    
    let x = e.clientX;
    let y = e.clientY;
    
    // Adjust position if menu would overflow viewport
    if (x + contextMenuWidth > viewportWidth) {
      x = viewportWidth - contextMenuWidth - 10;
    }
    if (y + contextMenuHeight > viewportHeight) {
      y = y - contextMenuHeight;
      if (y < 0) {
        y = viewportHeight - contextMenuHeight - 10;
      }
    }
    if (x < 0) x = 10;
    if (y < 0) y = 10;
    
    setSeamenBookContextMenu({
      show: true,
      x: x,
      y: y,
      crew: crew
    });
  };

  // Place Sign On right-click functionality is now integrated into crew context menu

  // Handle seamen book actions
  const handleViewSeamenBook = async (crew) => {
    try {
      // This would typically open seamen book file or show seamen book details
      alert(`Seamen Book Information:\nName: ${crew.full_name}\nSeamen Book No: ${crew.seamen_book}\nRank: ${crew.rank || 'Not specified'}\nStatus: ${crew.status}\nShip: ${crew.ship_sign_on}`);
      
    } catch (error) {
      console.error('View seamen book error:', error);
      toast.error(language === 'vi' ? 'L·ªói khi xem s·ªï thuy·ªÅn vi√™n' : 'Error viewing seamen book');
    }
    setSeamenBookContextMenu({ show: false, x: 0, y: 0, crew: null });
  };

  const handleCopySeamenBookLink = async (crew) => {
    try {
      // Generate a shareable link for the crew member's seamen book
      const seamenBookLink = `${window.location.origin}/crew/${crew.id}/seamen-book`;
      
      // Copy to clipboard
      await navigator.clipboard.writeText(seamenBookLink);
      
      toast.success(language === 'vi' ? 'ƒê√£ sao ch√©p link s·ªï thuy·ªÅn vi√™n' : 'Seamen book link copied to clipboard');
      
    } catch (error) {
      console.error('Copy seamen book link error:', error);
      toast.error(language === 'vi' ? 'L·ªói khi sao ch√©p link' : 'Error copying link');
    }
    setSeamenBookContextMenu({ show: false, x: 0, y: 0, crew: null });
  };

  const handleDownloadSeamenBook = async (crew) => {
    try {
      // This would typically download the seamen book file from server
      toast.info(language === 'vi' ? 'ƒêang t·∫£i xu·ªëng s·ªï thuy·ªÅn vi√™n...' : 'Downloading seamen book...');
      
      // Simulate API call to download seamen book
      const response = await axios.get(`${API}/crew/${crew.id}/seamen-book/download`, {
        headers: { Authorization: `Bearer ${token}` },
        responseType: 'blob'
      });
      
      // Create download link
      const blob = new Blob([response.data], { type: 'application/pdf' });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${crew.full_name}_SeamenBook_${crew.seamen_book}.pdf`;
      document.body.appendChild(link);
      link.click();
      link.remove();
      window.URL.revokeObjectURL(url);
      
      toast.success(language === 'vi' ? 'ƒê√£ t·∫£i xu·ªëng s·ªï thuy·ªÅn vi√™n' : 'Seamen book downloaded successfully');
      
    } catch (error) {
      console.error('Download seamen book error:', error);
      
      // For demo purposes, create a text file with seamen book info
      const seamenBookInfo = `Seamen Book Information\n\nName: ${crew.full_name}\nSeamen Book No: ${crew.seamen_book}\nRank: ${crew.rank || 'Not specified'}\nSex: ${crew.sex}\nDate of Birth: ${crew.date_of_birth}\nPlace of Birth: ${crew.place_of_birth}\nStatus: ${crew.status}\nShip: ${crew.ship_sign_on}\nDate Sign On: ${crew.date_sign_on || 'Not specified'}\nDate Sign Off: ${crew.date_sign_off || 'Still on board'}`;
      
      const blob = new Blob([seamenBookInfo], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${crew.full_name}_SeamenBook_Info.txt`;
      document.body.appendChild(link);
      link.click();
      link.remove();
      window.URL.revokeObjectURL(url);
      
      toast.info(language === 'vi' ? 'ƒê√£ t·∫£i xu·ªëng th√¥ng tin s·ªï thuy·ªÅn vi√™n' : 'Seamen book information downloaded');
    }
    setSeamenBookContextMenu({ show: false, x: 0, y: 0, crew: null });
  };
  // Handle bulk edit Place Sign On
  const handleBulkEditPlaceSignOn = () => {
    setCrewContextMenu({ show: false, x: 0, y: 0, crew: null }); // Close existing crew context menu
    setBulkPlaceSignOn('');
    setShowBulkEditPlaceSignOn(true);
  };

  // Handle bulk edit Ship Sign On
  const handleBulkEditShipSignOn = () => {
    setCrewContextMenu({ show: false, x: 0, y: 0, crew: null }); // Close existing crew context menu
    setBulkShipSignOn('');
    setShowBulkEditShipSignOn(true);
  };

  // Handle bulk edit Date Sign On
  const handleBulkEditDateSignOn = () => {
    setCrewContextMenu({ show: false, x: 0, y: 0, crew: null }); // Close existing crew context menu
    setBulkDateSignOn('');
    setShowBulkEditDateSignOn(true);
  };

  // Handle bulk edit Date Sign Off
  const handleBulkEditDateSignOff = () => {
    setCrewContextMenu({ show: false, x: 0, y: 0, crew: null }); // Close existing crew context menu
    setBulkDateSignOff('');
    setShowBulkEditDateSignOff(true);
  };

  // Handle bulk Place Sign On update
  const handleBulkUpdatePlaceSignOn = async () => {
    if (selectedCrewMembers.size === 0) {
      toast.error(language === 'vi' 
        ? 'Kh√¥ng c√≥ thuy·ªÅn vi√™n n√†o ƒë∆∞·ª£c ch·ªçn'
        : 'No crew members selected');
      return;
    }

    try {
      const selectedCrewIds = Array.from(selectedCrewMembers);
      let successCount = 0;
      let errorCount = 0;

      // Check if user wants to clear Place Sign On (empty input)
      const isClearingPlace = !bulkPlaceSignOn || bulkPlaceSignOn.trim() === '';
      
      if (isClearingPlace) {
        console.log(`üóëÔ∏è Clearing Place Sign On for ${selectedCrewIds.length} crew members...`);
      } else {
        console.log(`üö¢ Bulk updating Place Sign On to "${bulkPlaceSignOn}" for ${selectedCrewIds.length} crew members...`);
      }

      for (const crewId of selectedCrewIds) {
        try {
          const updateData = { 
            place_sign_on: isClearingPlace ? null : bulkPlaceSignOn.trim()
          };
          
          console.log(`üìã ${isClearingPlace ? 'Clearing' : 'Updating'} Place Sign On for crew ${crewId}`);
          
          const response = await axios.put(`${API}/crew/${crewId}`, updateData, {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.data) {
            successCount++;
            console.log(`‚úÖ ${isClearingPlace ? 'Cleared' : 'Updated'} Place Sign On for crew ${crewId}`);
          }
        } catch (error) {
          errorCount++;
          console.error(`‚ùå Failed to update crew ${crewId}:`, error);
        }
      }

      // Show results
      if (successCount > 0 && errorCount === 0) {
        if (isClearingPlace) {
          toast.success(language === 'vi' 
            ? `ƒê√£ x√≥a n∆°i xu·ªëng t√†u cho ${successCount} thuy·ªÅn vi√™n`
            : `Cleared place sign on for ${successCount} crew members`);
        } else {
          toast.success(language === 'vi' 
            ? `ƒê√£ c·∫≠p nh·∫≠t n∆°i xu·ªëng t√†u cho ${successCount} thuy·ªÅn vi√™n`
            : `Updated place sign on for ${successCount} crew members`);
        }
      } else if (successCount > 0 && errorCount > 0) {
        toast.warning(language === 'vi' 
          ? `ƒê√£ c·∫≠p nh·∫≠t ${successCount} thuy·ªÅn vi√™n, ${errorCount} l·ªói`
          : `Updated ${successCount} crew members, ${errorCount} failed`);
      } else {
        toast.error(language === 'vi' 
          ? 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t thuy·ªÅn vi√™n n√†o'
          : 'Failed to update any crew members');
      }

      // Refresh crew list and close modal
      if (successCount > 0) {
        if (selectedShip?.name) {
          await fetchCrewMembers(selectedShip.name);
        }
      }

      setShowBulkEditPlaceSignOn(false);
      setBulkPlaceSignOn('');
      setSelectedCrewMembers(new Set()); // Clear selection after bulk update
      
    } catch (error) {
      console.error('Bulk Place Sign On update error:', error);
      toast.error(language === 'vi' 
        ? 'L·ªói c·∫≠p nh·∫≠t h√†ng lo·∫°t'
        : 'Bulk update error');
    }
  };

  // Handle bulk Ship Sign On update
  const handleBulkUpdateShipSignOn = async () => {
    if (selectedCrewMembers.size === 0) {
      toast.error(language === 'vi' 
        ? 'Kh√¥ng c√≥ thuy·ªÅn vi√™n n√†o ƒë∆∞·ª£c ch·ªçn'
        : 'No crew members selected');
      return;
    }

    try {
      const selectedCrewIds = Array.from(selectedCrewMembers);
      let successCount = 0;
      let errorCount = 0;

      console.log(`üö¢ Bulk updating Ship Sign On to "${bulkShipSignOn}" for ${selectedCrewIds.length} crew members...`);
      console.log(`   ‚Üí Also updating Status to "Sign on" and clearing Date Sign Off`);

      for (const crewId of selectedCrewIds) {
        try {
          const updateData = {
            ship_sign_on: bulkShipSignOn,
            status: 'Sign on',        // Auto-update status to Sign on
            date_sign_off: null       // Clear date sign off
          };
          
          console.log(`üìã Updating crew ${crewId}:`, updateData);
          
          const response = await axios.put(`${API}/crew/${crewId}`, updateData, {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.data) {
            successCount++;
            console.log(`‚úÖ Updated Ship Sign On, Status, and cleared Date Sign Off for crew ${crewId}`);
          }
        } catch (error) {
          errorCount++;
          console.error(`‚ùå Failed to update crew ${crewId}:`, error);
        }
      }

      // Show results
      if (successCount > 0 && errorCount === 0) {
        toast.success(language === 'vi' 
          ? `ƒê√£ c·∫≠p nh·∫≠t t√†u ƒëƒÉng k√Ω, tr·∫°ng th√°i "L√™n t√†u" v√† x√≥a ng√†y r·ªùi t√†u cho ${successCount} thuy·ªÅn vi√™n`
          : `Updated ship sign on, status "Sign on", and cleared date sign off for ${successCount} crew members`);
        
        // ‚úÖ AUTO-MOVE FILES TO SHIP/Crew Records after bulk ship sign on update
        console.log(`üéØ Bulk Ship Sign On updated to "${bulkShipSignOn}" ‚Üí Triggering auto-move for crew files...`);
        console.log(`   Crew IDs to move: ${selectedCrewIds.length} crews`);
        
        // Call moveCrewFilesToShip for all successfully updated crews
        moveCrewFilesToShip(selectedCrewIds, bulkShipSignOn, null);
      } else if (successCount > 0 && errorCount > 0) {
        toast.warning(language === 'vi' 
          ? `ƒê√£ c·∫≠p nh·∫≠t ${successCount} thuy·ªÅn vi√™n, ${errorCount} l·ªói`
          : `Updated ${successCount} crew members, ${errorCount} failed`);
        
        // ‚úÖ AUTO-MOVE FILES even if some failed
        console.log(`üéØ Partial success bulk update ‚Üí Triggering auto-move for successfully updated crews...`);
        moveCrewFilesToShip(selectedCrewIds, bulkShipSignOn, null);
      } else {
        toast.error(language === 'vi' 
          ? 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t thuy·ªÅn vi√™n n√†o'
          : 'Failed to update any crew members');
      }

      // Refresh crew list and close modal
      if (successCount > 0) {
        if (selectedShip?.name) {
          await fetchCrewMembers(selectedShip.name);
        }
      }

      setShowBulkEditShipSignOn(false);
      setBulkShipSignOn('');
      setSelectedCrewMembers(new Set()); // Clear selection after bulk update
      
    } catch (error) {
      console.error('Bulk Ship Sign On update error:', error);
      toast.error(language === 'vi' 
        ? 'L·ªói c·∫≠p nh·∫≠t h√†ng lo·∫°t'
        : 'Bulk update error');
    }
  };

  // Handle bulk Date Sign On update
  const handleBulkUpdateDateSignOn = async () => {
    if (selectedCrewMembers.size === 0) {
      toast.error(language === 'vi' 
        ? 'Kh√¥ng c√≥ thuy·ªÅn vi√™n n√†o ƒë∆∞·ª£c ch·ªçn'
        : 'No crew members selected');
      return;
    }

    try {
      const selectedCrewIds = Array.from(selectedCrewMembers);
      let successCount = 0;
      let errorCount = 0;

      // Check if user wants to clear Date Sign On (empty input)
      const isClearingDate = !bulkDateSignOn || bulkDateSignOn.trim() === '';
      
      if (isClearingDate) {
        console.log(`üóëÔ∏è Clearing Date Sign On for ${selectedCrewIds.length} crew members...`);
      } else {
        console.log(`üìÖ Bulk updating Date Sign On to "${bulkDateSignOn}" for ${selectedCrewIds.length} crew members...`);
      }

      // Process date if not clearing
      const processedDate = isClearingDate ? null : convertDateInputToUTC(bulkDateSignOn);
      if (processedDate) {
        console.log(`üìÖ Converted date: ${bulkDateSignOn} ‚Üí ${processedDate}`);
      }

      for (const crewId of selectedCrewIds) {
        try {
          const updateData = { date_sign_on: processedDate };
          
          console.log(`üìã ${isClearingDate ? 'Clearing' : 'Updating'} Date Sign On for crew ${crewId}`);
          
          const response = await axios.put(`${API}/crew/${crewId}`, updateData, {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.data) {
            successCount++;
            console.log(`‚úÖ ${isClearingDate ? 'Cleared' : 'Updated'} Date Sign On for crew ${crewId}`);
          }
        } catch (error) {
          errorCount++;
          console.error(`‚ùå Failed to update crew ${crewId}:`, error);
        }
      }

      // Show results
      if (successCount > 0 && errorCount === 0) {
        if (isClearingDate) {
          toast.success(language === 'vi' 
            ? `ƒê√£ x√≥a ng√†y l√™n t√†u cho ${successCount} thuy·ªÅn vi√™n`
            : `Cleared date sign on for ${successCount} crew members`);
        } else {
          toast.success(language === 'vi' 
            ? `ƒê√£ c·∫≠p nh·∫≠t ng√†y l√™n t√†u cho ${successCount} thuy·ªÅn vi√™n`
            : `Updated date sign on for ${successCount} crew members`);
        }
      } else if (successCount > 0 && errorCount > 0) {
        toast.warning(language === 'vi' 
          ? `ƒê√£ c·∫≠p nh·∫≠t ${successCount} thuy·ªÅn vi√™n, ${errorCount} l·ªói`
          : `Updated ${successCount} crew members, ${errorCount} failed`);
      } else {
        toast.error(language === 'vi' 
          ? 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t thuy·ªÅn vi√™n n√†o'
          : 'Failed to update any crew members');
      }

      // Refresh crew list and close modal
      if (successCount > 0) {
        if (selectedShip?.name) {
          await fetchCrewMembers(selectedShip.name);
        }
      }

      setShowBulkEditDateSignOn(false);
      setBulkDateSignOn('');
      setSelectedCrewMembers(new Set()); // Clear selection after bulk update
      
    } catch (error) {
      console.error('Bulk Date Sign On update error:', error);
      toast.error(language === 'vi' 
        ? 'L·ªói c·∫≠p nh·∫≠t h√†ng lo·∫°t'
        : 'Bulk update error');
    }
  };

  // Handle bulk Date Sign Off update
  const handleBulkUpdateDateSignOff = async () => {
    if (selectedCrewMembers.size === 0) {
      toast.error(language === 'vi' 
        ? 'Kh√¥ng c√≥ thuy·ªÅn vi√™n n√†o ƒë∆∞·ª£c ch·ªçn'
        : 'No crew members selected');
      return;
    }

    try {
      const selectedCrewIds = Array.from(selectedCrewMembers);
      let successCount = 0;
      let errorCount = 0;

      // Check if user wants to clear Date Sign Off (empty input)
      const isClearingDate = !bulkDateSignOff || bulkDateSignOff.trim() === '';
      
      if (isClearingDate) {
        console.log(`üóëÔ∏è Clearing Date Sign Off for ${selectedCrewIds.length} crew members...`);
      } else {
        console.log(`üìÖ Bulk updating Date Sign Off to "${bulkDateSignOff}" for ${selectedCrewIds.length} crew members...`);
      }

      // Process date if not clearing
      const processedDate = isClearingDate ? null : convertDateInputToUTC(bulkDateSignOff);
      if (processedDate) {
        console.log(`üìÖ Converted date: ${bulkDateSignOff} ‚Üí ${processedDate}`);
      }

      for (const crewId of selectedCrewIds) {
        try {
          let updateData;
          
          if (isClearingDate) {
            // Clear Date Sign Off only (don't change status or ship)
            updateData = {
              date_sign_off: null
            };
            console.log(`üìã Clearing Date Sign Off for crew ${crewId}`);
          } else {
            // Auto-update Status and Ship Sign On when Date Sign Off is filled
            updateData = {
              date_sign_off: processedDate,
              status: 'Standby', // Auto-set to Standby when crew signs off
              ship_sign_on: '-' // Clear ship assignment when crew signs off
            };
            console.log(`üìã Auto-updating for crew ${crewId}:`, {
              date_sign_off: processedDate,
              status: 'Standby',
              ship_sign_on: '-'
            });
          }
          
          const response = await axios.put(`${API}/crew/${crewId}`, updateData, {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.data) {
            successCount++;
            if (isClearingDate) {
              console.log(`‚úÖ Cleared Date Sign Off for crew ${crewId}`);
            } else {
              console.log(`‚úÖ Updated Date Sign Off, Status, and Ship Sign On for crew ${crewId}`);
            }
          }
        } catch (error) {
          errorCount++;
          console.error(`‚ùå Failed to update crew ${crewId}:`, error);
        }
      }

      // Show results
      if (successCount > 0 && errorCount === 0) {
        if (isClearingDate) {
          toast.success(language === 'vi' 
            ? `ƒê√£ x√≥a ng√†y r·ªùi t√†u cho ${successCount} thuy·ªÅn vi√™n`
            : `Cleared date sign off for ${successCount} crew members`);
        } else {
          toast.success(language === 'vi' 
            ? `ƒê√£ c·∫≠p nh·∫≠t ng√†y r·ªùi t√†u, tr·∫°ng th√°i v√† t√†u cho ${successCount} thuy·ªÅn vi√™n`
            : `Updated date sign off, status and ship assignment for ${successCount} crew members`);
          
          // ‚úÖ AUTO-MOVE FILES TO STANDBY FOLDER after bulk date sign off update
          // When date sign off is filled (not cleared), status is auto-set to Standby
          console.log('üéØ Bulk Date Sign Off filled ‚Üí Triggering auto-move for Standby crew files...');
          console.log(`   Crew IDs to move: ${selectedCrewIds.length} crews`);
          
          // Call moveStandbyCrewFiles for all successfully updated crews
          moveStandbyCrewFiles(selectedCrewIds, null);
        }
      } else if (successCount > 0 && errorCount > 0) {
        toast.warning(language === 'vi' 
          ? `ƒê√£ c·∫≠p nh·∫≠t ${successCount} thuy·ªÅn vi√™n, ${errorCount} l·ªói`
          : `Updated ${successCount} crew members, ${errorCount} failed`);
        
        // ‚úÖ AUTO-MOVE FILES even if some failed
        if (!isClearingDate) {
          console.log('üéØ Partial success bulk update ‚Üí Triggering auto-move for successfully updated crews...');
          // Note: We're moving all selected IDs - backend will filter for Standby status
          moveStandbyCrewFiles(selectedCrewIds, null);
        }
      } else {
        toast.error(language === 'vi' 
          ? 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t thuy·ªÅn vi√™n n√†o'
          : 'Failed to update any crew members');
      }

      // Refresh crew list and close modal
      if (successCount > 0) {
        if (selectedShip?.name) {
          await fetchCrewMembers(selectedShip.name);
        }
      }

      setShowBulkEditDateSignOff(false);
      setBulkDateSignOff('');
      setSelectedCrewMembers(new Set()); // Clear selection after bulk update
      
    } catch (error) {
      console.error('Bulk Date Sign Off update error:', error);
      toast.error(language === 'vi' 
        ? 'L·ªói c·∫≠p nh·∫≠t h√†ng lo·∫°t'
        : 'Bulk update error');
    }
  };

  // Helper function to get folder location for files from database
  const getFileLocation = (cert) => {
    // Return actual folder path from database if available
    if (cert.cert_folder_path) {
      return cert.cert_folder_path;
    }
    
    // Fallback to logic if not in database yet
    const crew = crewList.find(c => c.id === cert.crew_id);
    
    if (!crew) {
      return language === 'vi' ? 'Kh√¥ng x√°c ƒë·ªãnh' : 'Unknown';
    }
    
    const crewStatus = crew.status ? crew.status.toLowerCase() : '';
    const shipSignOn = crew.ship_sign_on || '';
    
    if (crewStatus === 'standby') {
      return 'COMPANY DOCUMENT/Standby Crew';
    } else if (shipSignOn && shipSignOn !== '-') {
      return `${shipSignOn}/Crew Records`;
    } else {
      return shipSignOn || (language === 'vi' ? 'Kh√¥ng x√°c ƒë·ªãnh' : 'Unknown');
    }
  };

  // Helper function to get passport file location from database
  const getPassportFileLocation = (crew) => {
    if (!crew) {
      return language === 'vi' ? 'Kh√¥ng x√°c ƒë·ªãnh' : 'Unknown';
    }
    
    // Return actual folder path from database if available
    if (crew.passport_folder_path) {
      return crew.passport_folder_path;
    }
    
    // Fallback to logic if not in database yet
    const crewStatus = crew.status ? crew.status.toLowerCase() : '';
    const shipSignOn = crew.ship_sign_on || '';
    
    if (crewStatus === 'standby') {
      return 'COMPANY DOCUMENT/Standby Crew';
    } else if (shipSignOn && shipSignOn !== '-') {
      return `${shipSignOn}/Crew Records`;
    } else {
      return shipSignOn || (language === 'vi' ? 'Kh√¥ng x√°c ƒë·ªãnh' : 'Unknown');
    }
  };

  // Helper function to close edit crew modal and deselect crew
  const closeEditCrewModal = () => {
    setShowEditCrewModal(false);
    setEditingCrew(null);
    setSelectedCrewMembers(new Set()); // Deselect all crew members
    setEditCrewData({
      full_name: '',
      full_name_en: '',
      sex: 'M',
      date_of_birth: '',
      place_of_birth: '',
      place_of_birth_en: '',
      passport: '',
      nationality: '',
      passport_expiry_date: '',
      rank: '',
      seamen_book: '',
      status: 'Sign on',
      ship_sign_on: '-',
      place_sign_on: '',
      date_sign_on: '',
      date_sign_off: ''
    });
  };

  // Handle edit crew
  const handleEditCrew = (crew) => {
    setEditingCrew(crew);
    
    // Auto-fill English fields if they are empty
    const autoFilledFullNameEn = crew.full_name_en || autoFillEnglishField(crew.full_name || '');
    const autoFilledPlaceOfBirthEn = crew.place_of_birth_en || autoFillEnglishField(crew.place_of_birth || '');
    
    setEditCrewData({
      full_name: crew.full_name || '',
      full_name_en: autoFilledFullNameEn,
      sex: crew.sex || 'M',
      date_of_birth: crew.date_of_birth ? crew.date_of_birth.split('T')[0] : '',
      place_of_birth: crew.place_of_birth || '',
      place_of_birth_en: autoFilledPlaceOfBirthEn,
      passport: crew.passport || '',
      nationality: crew.nationality || '',
      passport_expiry_date: crew.passport_expiry_date ? crew.passport_expiry_date.split('T')[0] : '',
      rank: crew.rank || '',
      seamen_book: crew.seamen_book || '',
      status: crew.status || 'Sign on',
      ship_sign_on: crew.ship_sign_on || selectedShip?.name || '-',
      place_sign_on: crew.place_sign_on || '',
      date_sign_on: crew.date_sign_on ? crew.date_sign_on.split('T')[0] : '',
      date_sign_off: crew.date_sign_off ? crew.date_sign_off.split('T')[0] : ''
    });
    setShowEditCrewModal(true);
    setCrewContextMenu({ show: false, x: 0, y: 0, crew: null });
  };

  // Handle rank right-click
  const handleRankRightClick = (e, crew) => {
    e.preventDefault();
    e.stopPropagation();
    
    setRankContextMenu({
      show: true,
      x: e.clientX,
      y: e.clientY,
      crew: crew
    });
  };

  // Handle rank quick update
  const handleRankUpdate = async (newRank) => {
    if (!rankContextMenu.crew) return;
    
    try {
      const crewId = rankContextMenu.crew.id;
      const updateData = {
        ...rankContextMenu.crew,
        rank: newRank,
        // Use Certificate approach to avoid timezone shift
        date_of_birth: rankContextMenu.crew.date_of_birth ? convertDateInputToUTC(rankContextMenu.crew.date_of_birth.split('T')[0]) : null,
        date_sign_on: rankContextMenu.crew.date_sign_on ? convertDateInputToUTC(rankContextMenu.crew.date_sign_on.split('T')[0]) : null,
        date_sign_off: rankContextMenu.crew.date_sign_off ? convertDateInputToUTC(rankContextMenu.crew.date_sign_off.split('T')[0]) : null,
        passport_expiry_date: rankContextMenu.crew.passport_expiry_date ? convertDateInputToUTC(rankContextMenu.crew.passport_expiry_date.split('T')[0]) : null
      };
      
      const response = await axios.put(`${API}/crew/${crewId}`, updateData, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      if (response.status === 200) {
        toast.success(language === 'vi' 
          ? `ƒê√£ c·∫≠p nh·∫≠t rank th√†nh: ${newRank}` 
          : `Rank updated to: ${newRank}`);
        
        // Refresh crew list
        console.log('üîÑ Refreshing crew list after rank update...');
        try {
          if (selectedShip?.name) {
            await fetchCrewMembers(selectedShip.name);
          } else {
            await fetchCrewMembers();
          }
          console.log('‚úÖ Crew list refreshed successfully after rank update');
        } catch (refreshError) {
          console.error('Failed to refresh crew list after rank update:', refreshError);
        }
      }
      
    } catch (error) {
      console.error('Error updating rank:', error);
      toast.error(language === 'vi' 
        ? 'L·ªói khi c·∫≠p nh·∫≠t rank' 
        : 'Error updating rank');
    } finally {
      setRankContextMenu({ show: false, x: 0, y: 0, crew: null });
    }
  };

  // Helper function to add custom certificate name to localStorage
  const addCustomCertificateName = (certName) => {
    if (!certName || certName.trim() === '') return;
    
    const trimmedName = certName.trim();
    
    // Check if name already exists (case-insensitive)
    const existsInCommon = COMMON_CERTIFICATE_NAMES.some(
      name => name.toLowerCase() === trimmedName.toLowerCase()
    );
    const existsInCustom = customCertificateNames.some(
      name => name.toLowerCase() === trimmedName.toLowerCase()
    );
    
    if (existsInCommon || existsInCustom) {
      console.log('üìù Certificate name already exists in list, skipping:', trimmedName);
      return;
    }
    
    // Add to custom names
    const updatedCustomNames = [...customCertificateNames, trimmedName].sort();
    setCustomCertificateNames(updatedCustomNames);
    
    // Save to localStorage
    try {
      localStorage.setItem('customCertificateNames', JSON.stringify(updatedCustomNames));
      console.log('‚úÖ Saved custom certificate name:', trimmedName);
      toast.success(language === 'vi' 
        ? `‚úÖ ƒê√£ l∆∞u t√™n ch·ª©ng ch·ªâ m·ªõi: "${trimmedName}"` 
        : `‚úÖ Saved new certificate name: "${trimmedName}"`
      );
    } catch (error) {
      console.error('Error saving custom certificate name:', error);
    }
  };

  // Helper function to automatically move files to Ship/Crew Records folder
  const moveCrewFilesToShip = async (crewIds, shipName, crewName = null) => {
    if (!crewIds || crewIds.length === 0) return;
    if (!shipName || shipName === '-') {
      console.log('‚ÑπÔ∏è Ship name is empty or "-", skipping file move');
      return;
    }
    
    try {
      console.log(`üì¶ Auto-moving files for ${crewIds.length} crew to ${shipName}/Crew Records folder...`);
      console.log('   Crew IDs:', crewIds);
      console.log('   Ship Name:', shipName);
      console.log('   API URL:', `${API}/crew/move-files-to-ship`);
      
      const response = await axios.post(
        `${API}/crew/move-files-to-ship`,
        {
          crew_ids: crewIds,
          ship_name: shipName
        },
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }
      );
      
      console.log('üì° Move files API response:', response);
      console.log('üì¶ Response data:', response.data);
      
      if (response.data && response.data.success) {
        console.log('‚úÖ Files moved successfully to Ship/Crew Records folder:', response.data);
        
        if (response.data.moved_count > 0) {
          toast.success(language === 'vi' 
            ? `‚úÖ ƒê√£ t·ª± ƒë·ªông di chuy·ªÉn ${response.data.moved_count} files${crewName ? ` c·ªßa ${crewName}` : ''} v√†o ${shipName}/Crew Records` 
            : `‚úÖ Automatically moved ${response.data.moved_count} files${crewName ? ` for ${crewName}` : ''} to ${shipName}/Crew Records`
          );
        } else {
          console.log('‚ÑπÔ∏è No files to move (crew may not have passport/certificate files yet)');
          toast.info(language === 'vi'
            ? `‚ÑπÔ∏è ${crewName || 'Thuy·ªÅn vi√™n'} ch∆∞a c√≥ files ƒë·ªÉ di chuy·ªÉn (ch∆∞a upload passport/certificates)`
            : `‚ÑπÔ∏è ${crewName || 'Crew member'} has no files to move yet (no passport/certificates uploaded)`
          );
        }
      } else {
        console.warn('‚ö†Ô∏è API returned success=false:', response.data);
        toast.warning(language === 'vi'
          ? `‚ö†Ô∏è Kh√¥ng th·ªÉ di chuy·ªÉn files: ${response.data?.message || 'Unknown error'}`
          : `‚ö†Ô∏è Could not move files: ${response.data?.message || 'Unknown error'}`
        );
      }
    } catch (error) {
      console.error('‚ùå Error auto-moving crew files to ship:', error);
      console.error('   Error response:', error.response);
      console.error('   Error data:', error.response?.data);
      // Don't show error toast - this is a background operation, don't disrupt user flow
      console.warn('‚ö†Ô∏è Background file move failed, but crew update was successful');
    }
  };

  // Helper function to automatically move files to Standby Crew folder
  const moveStandbyCrewFiles = async (crewIds, crewName = null) => {
    if (!crewIds || crewIds.length === 0) return;
    
    try {
      console.log(`üì¶ Auto-moving files for ${crewIds.length} Standby crew to Standby Crew folder...`);
      console.log('   Crew IDs:', crewIds);
      console.log('   Crew Name:', crewName);
      console.log('   API URL:', `${API}/crew/move-standby-files`);
      
      const response = await axios.post(
        `${API}/crew/move-standby-files`,
        {
          crew_ids: crewIds
        },
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }
      );
      
      console.log('üì° Move files API response:', response);
      console.log('üì¶ Response data:', response.data);
      
      if (response.data && response.data.success) {
        console.log('‚úÖ Files moved successfully to Standby Crew folder:', response.data);
        
        if (response.data.moved_count > 0) {
          toast.success(language === 'vi' 
            ? `‚úÖ ƒê√£ t·ª± ƒë·ªông di chuy·ªÉn ${response.data.moved_count} files${crewName ? ` c·ªßa ${crewName}` : ''} v√†o folder Standby Crew` 
            : `‚úÖ Automatically moved ${response.data.moved_count} files${crewName ? ` for ${crewName}` : ''} to Standby Crew folder`
          );
        } else {
          console.log('‚ÑπÔ∏è No files to move (crew may not have passport/certificate files yet)');
          toast.info(language === 'vi'
            ? `‚ÑπÔ∏è ${crewName || 'Thuy·ªÅn vi√™n'} ch∆∞a c√≥ files ƒë·ªÉ di chuy·ªÉn (ch∆∞a upload passport/certificates)`
            : `‚ÑπÔ∏è ${crewName || 'Crew member'} has no files to move yet (no passport/certificates uploaded)`
          );
        }
      } else {
        console.warn('‚ö†Ô∏è API returned success=false:', response.data);
        toast.warning(language === 'vi'
          ? '‚ö†Ô∏è Kh√¥ng th·ªÉ di chuy·ªÉn files. Vui l√≤ng ki·ªÉm tra logs.'
          : '‚ö†Ô∏è Could not move files. Please check logs.'
        );
      }
    } catch (error) {
      console.error('‚ùå Error auto-moving Standby crew files:', error);
      console.error('   Error response:', error.response);
      console.error('   Error data:', error.response?.data);
      // Don't show error toast - this is a background operation, don't disrupt user flow
      console.warn('‚ö†Ô∏è Background file move failed, but crew status update was successful');
    }
  };

  // Handle update crew
  const handleUpdateCrew = async (e) => {
    e.preventDefault();
    
    try {
      if (!editingCrew) return;
      
      // Validate required fields
      if (!editCrewData.full_name || !editCrewData.date_of_birth || !editCrewData.place_of_birth || !editCrewData.passport) {
        toast.error(language === 'vi' 
          ? 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc' 
          : 'Please fill in all required fields');
        return;
      }
      
      // Prepare data for API
      const updateData = {
        ...editCrewData,
        // Convert date fields to UTC-safe format to avoid timezone shift (using Certificate approach)
        date_of_birth: editCrewData.date_of_birth ? convertDateInputToUTC(editCrewData.date_of_birth.split('T')[0]) : null,
        date_sign_on: editCrewData.date_sign_on ? convertDateInputToUTC(editCrewData.date_sign_on.split('T')[0]) : null,
        date_sign_off: editCrewData.date_sign_off ? convertDateInputToUTC(editCrewData.date_sign_off.split('T')[0]) : null,
        passport_expiry_date: editCrewData.passport_expiry_date ? convertDateInputToUTC(editCrewData.passport_expiry_date.split('T')[0]) : null,
        ship_id: selectedShip?.id
      };
      
      // Call API to update crew member
      const response = await axios.put(`${API}/crew/${editingCrew.id}`, updateData, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      if (response.status === 200) {
        toast.success(language === 'vi' 
          ? 'ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin thuy·ªÅn vi√™n th√†nh c√¥ng' 
          : 'Crew member updated successfully');
        
        // ‚úÖ AUTO-MOVE FILES TO STANDBY FOLDER in two cases:
        // Case 1: Status changed to "Standby" directly
        // Case 2: date_sign_off was filled (which auto-sets status to Standby)
        
        const oldStatus = editingCrew.status ? editingCrew.status.toLowerCase().trim() : '';
        const newStatus = editCrewData.status ? editCrewData.status.toLowerCase().trim() : '';
        const oldDateSignOff = editingCrew.date_sign_off;
        const newDateSignOff = editCrewData.date_sign_off;
        
        // Debug: Log raw values with types
        console.log('üîç RAW VALUES:', {
          'oldDateSignOff (value)': oldDateSignOff,
          'oldDateSignOff (type)': typeof oldDateSignOff,
          'oldDateSignOff (is null)': oldDateSignOff === null,
          'oldDateSignOff (is undefined)': oldDateSignOff === undefined,
          'oldDateSignOff (is empty string)': oldDateSignOff === '',
          'oldDateSignOff (falsy)': !oldDateSignOff,
          'newDateSignOff (value)': newDateSignOff,
          'newDateSignOff (type)': typeof newDateSignOff,
          'newDateSignOff (is null)': newDateSignOff === null,
          'newDateSignOff (is undefined)': newDateSignOff === undefined,
          'newDateSignOff (is empty string)': newDateSignOff === '',
          'newDateSignOff (truthy)': !!newDateSignOff
        });
        
        // Check if date_sign_off was newly filled (wasn't there before, now it is)
        const dateSignOffAdded = !oldDateSignOff && newDateSignOff;
        
        console.log('üîç Status & Date Sign Off check:', {
          oldStatus,
          newStatus,
          oldDateSignOff,
          newDateSignOff,
          dateSignOffAdded,
          statusChangedToStandby: newStatus === 'standby' && oldStatus !== 'standby',
          shouldTriggerMove: (newStatus === 'standby' && oldStatus !== 'standby') || dateSignOffAdded
        });
        
        // Trigger auto-move if:
        // 1. Status changed to Standby, OR
        // 2. Date Sign Off was newly added (which means status is now Standby)
        if ((newStatus === 'standby' && oldStatus !== 'standby') || dateSignOffAdded) {
          console.log(`üéØ Triggering auto-move for ${editCrewData.full_name}`);
          if (dateSignOffAdded) {
            console.log('   Reason: Date Sign Off was newly filled ‚Üí Status auto-changed to Standby');
          } else {
            console.log('   Reason: Status directly changed to Standby');
          }
          // Call moveStandbyCrewFiles in background (don't await - let it run async)
          moveStandbyCrewFiles([editingCrew.id], editCrewData.full_name);
        } else {
          console.log('‚ùå Auto-move NOT triggered. Analysis:');
          console.log('   - newStatus === "standby"?', newStatus === 'standby');
          console.log('   - oldStatus !== "standby"?', oldStatus !== 'standby');
          console.log('   - statusChangedToStandby?', newStatus === 'standby' && oldStatus !== 'standby');
          console.log('   - !oldDateSignOff?', !oldDateSignOff);
          console.log('   - newDateSignOff (truthy)?', !!newDateSignOff);
          console.log('   - dateSignOffAdded?', dateSignOffAdded);
          console.log('   Reason:', 
            newStatus !== 'standby' 
              ? 'new status is not standby' 
              : oldStatus === 'standby' && !dateSignOffAdded
                ? 'status was already standby and no new date sign off'
                : 'unknown - check raw values above'
          );
        }
        
        // ‚úÖ AUTO-MOVE FILES TO SHIP/Crew Records when ship_sign_on changes
        const oldShipSignOn = editingCrew.ship_sign_on;
        const newShipSignOn = editCrewData.ship_sign_on;
        
        console.log('üîç Ship Sign On check:', {
          oldShipSignOn,
          newShipSignOn,
          shipChanged: oldShipSignOn !== newShipSignOn,
          newShipValid: newShipSignOn && newShipSignOn !== '-'
        });
        
        if (oldShipSignOn !== newShipSignOn && newShipSignOn && newShipSignOn !== '-') {
          console.log(`üéØ Ship Sign On changed from "${oldShipSignOn}" to "${newShipSignOn}", auto-moving files...`);
          // Call moveCrewFilesToShip in background (don't await - let it run async)
          moveCrewFilesToShip([editingCrew.id], newShipSignOn, editCrewData.full_name);
        } else {
          console.log('‚ÑπÔ∏è Ship Sign On auto-move not triggered:', {
            reason: oldShipSignOn === newShipSignOn 
              ? 'ship did not change' 
              : !newShipSignOn || newShipSignOn === '-'
                ? 'new ship is empty or "-"'
                : 'unknown'
          });
        }
        
        // Refresh crew list
        console.log('üîÑ Refreshing crew list after updating crew...');
        try {
          if (selectedShip?.name) {
            await fetchCrewMembers(selectedShip.name);
          } else {
            await fetchCrewMembers();
          }
          console.log('‚úÖ Crew list refreshed successfully after updating crew');
        } catch (refreshError) {
          console.error('Failed to refresh crew list after update:', refreshError);
          toast.warning(language === 'vi' 
            ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng nh∆∞ng kh√¥ng th·ªÉ t·∫£i l·∫°i danh s√°ch' 
            : 'Updated successfully but failed to refresh list');
        }
        
        // Close modal and reset state
        closeEditCrewModal();
      }
      
    } catch (error) {
      console.error('Update crew error:', error);
      const errorMessage = error.response?.data?.message || 
        (language === 'vi' ? 'L·ªói khi c·∫≠p nh·∫≠t thuy·ªÅn vi√™n' : 'Error updating crew member');
      toast.error(errorMessage);
    }
  };

  const fetchAiConfig = async () => {
    try {
      const response = await axios.get(`${API}/ai-config`);
      setAiConfig(response.data);
    } catch (error) {
      console.error('Failed to fetch AI config:', error);
      // Set default if can't fetch
      setAiConfig({ provider: 'Unknown', model: 'Unknown', api_key: '' });
    }
  };

  const fetchShips = async () => {
    if (!token) {
      console.log('No token available, skipping ships fetch');
      return;
    }
    
    try {
      const response = await axios.get(`${API}/ships`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      setShips(response.data);
      console.log('Ships fetched successfully:', response.data.length, 'ships');
    } catch (error) {
      console.error('Failed to fetch ships:', error);
      if (error.response?.status === 401) {
        console.log('Unauthorized - token may be invalid');
      }
    }
  };

  const fetchSettings = async () => {
    try {
      const response = await axios.get(`${API}/settings`);
      if (response.data.logo_url) {
        setCompanyLogo(response.data.logo_url);
      }
    } catch (error) {
      console.error('Failed to fetch settings:', error);
    }
  };

  // Fetch company logo based on user's company
  const fetchUserCompanyLogo = async () => {
    if (!user || !user.company) {
      console.log('No user or company info available');
      return;
    }

    try {
      // Fetch all companies to find the user's company
      const response = await axios.get(`${API}/companies`);
      const companies = response.data;
      
      // Find company by name (user.company is the company name)
      const userCompany = companies.find(c => 
        c.name_vn === user.company || c.name_en === user.company || c.name === user.company
      );
      
      if (userCompany && userCompany.logo_url) {
        setCompanyLogo(userCompany.logo_url);
        console.log(`‚úÖ Company logo loaded: ${userCompany.logo_url}`);
      } else {
        console.log('No logo found for user company');
        setCompanyLogo(null);
      }
    } catch (error) {
      console.error('Failed to fetch user company logo:', error);
    }
  };

  const fetchAvailableCompanies = async () => {
    try {
      const response = await axios.get(`${API}/companies`);
      setAvailableCompanies(response.data);
    } catch (error) {
      console.error('Failed to fetch companies:', error);
      setAvailableCompanies([]);
    }
  };

  // Filter ships by user's company
  const getUserCompanyShips = () => {
    console.log('getUserCompanyShips called');
    console.log('User:', user);
    console.log('User company:', user?.company);
    console.log('Ships:', ships);
    console.log('Ships length:', ships.length);
    
    // IMPORTANT: Backend /ships endpoint already filters by user's company
    // Ship.company stores UUID, but backend ensures only user's company ships are returned
    // So we can safely return all ships without additional filtering
    console.log('Returning all ships (backend already filters by company)');
    return ships;
  };

  const handleEditShip = async (updatedShipData) => {
    try {
      // Prepare ship payload similar to create ship
      const shipPayload = {
        name: updatedShipData.name?.trim() || '',
        imo: updatedShipData.imo?.trim() || null,
        flag: updatedShipData.flag?.trim() || '',
        ship_type: updatedShipData.ship_type?.trim() || '',
        class_society: updatedShipData.class_society?.trim() || '',
        gross_tonnage: updatedShipData.gross_tonnage ? parseFloat(updatedShipData.gross_tonnage) : null,
        deadweight: updatedShipData.deadweight ? parseFloat(updatedShipData.deadweight) : null,
        built_year: updatedShipData.built_year ? parseInt(updatedShipData.built_year) : null,
        delivery_date: convertDateInputToUTC(updatedShipData.delivery_date),
        keel_laid: convertDateInputToUTC(updatedShipData.keel_laid),
        ship_owner: updatedShipData.ship_owner?.trim() || '',
        // Detailed Ship Information fields
        last_docking: convertDateInputToUTC(updatedShipData.last_docking),
        last_docking_2: convertDateInputToUTC(updatedShipData.last_docking_2),
        next_docking: convertDateInputToUTC(updatedShipData.next_docking),
        last_special_survey: convertDateInputToUTC(updatedShipData.last_special_survey),
        last_intermediate_survey: convertDateInputToUTC(updatedShipData.last_intermediate_survey),
        anniversary_date: updatedShipData.anniversary_date || null,
        special_survey_cycle: updatedShipData.special_survey_cycle || null,
        dry_dock_cycle: updatedShipData.dry_dock_cycle || null,
        company: user?.company || '' // Always use user's company
      };
      
      // Remove null/empty values
      Object.keys(shipPayload).forEach(key => {
        if (shipPayload[key] === null || shipPayload[key] === '') {
          if (key === 'imo') {
            delete shipPayload[key];
          } else if (['gross_tonnage', 'built_year'].includes(key)) {
            delete shipPayload[key];
          }
        }
      });
      
      await axios.put(`${API}/ships/${updatedShipData.id}`, shipPayload);
      
      // Update local state
      setShips(ships.map(ship => 
        ship.id === updatedShipData.id 
          ? { ...ship, ...shipPayload, id: updatedShipData.id } 
          : ship
      ));
      
      // Update selected ship
      setSelectedShip({ ...selectedShip, ...shipPayload });
      
      toast.success(language === 'vi' ? 'C·∫≠p nh·∫≠t t√†u th√†nh c√¥ng!' : 'Ship updated successfully!');
      setShowEditShipModal(false);
      setEditingShipData(null);
    } catch (error) {
      console.error('Ship update error:', error);
      const errorMessage = error.response?.data?.detail || error.message;
      toast.error(language === 'vi' ? `Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t t√†u: ${errorMessage}` : `Failed to update ship: ${errorMessage}`);
    }
  };

  const handleDeleteShip = async (shipId, deleteOption) => {
    try {
      setIsDeletingShip(true);
      
      // Show initial loading message
      toast.info(language === 'vi' 
        ? `ƒêang x√≥a t√†u ${deleteShipData?.name}...`
        : `Deleting ship ${deleteShipData?.name}...`
      );

      // Delete ship from database (with optional Google Drive deletion)
      const deleteGoogleDriveFolder = deleteShipOption === 'with_gdrive';
      const deleteUrl = `${API}/ships/${shipId}${deleteGoogleDriveFolder ? '?delete_google_drive_folder=true' : ''}`;
      
      const deleteResponse = await fetch(deleteUrl, {
        method: 'DELETE',
        headers: { 
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      if (!deleteResponse.ok) {
        const errorData = await deleteResponse.json();
        throw new Error(errorData.detail || 'Failed to delete ship from database');
      }

      // If user chose to delete Google Drive folder as well
      if (deleteOption === 'with_gdrive') {
        try {
          // Get user's company ID for Google Drive operations
          const userCompanyId = user?.company_id || user?.company;
          
          if (userCompanyId && deleteShipData?.name) {
            toast.info(language === 'vi' 
              ? 'ƒêang x√≥a folder Google Drive...'
              : 'Deleting Google Drive folder...'
            );

            const gdriveDeleteResponse = await fetch(`${API}/companies/${userCompanyId}/gdrive/delete-ship-folder`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                ship_name: deleteShipData.name
              })
            });

            if (!gdriveDeleteResponse.ok) {
              console.warn('Failed to delete Google Drive folder, but ship data was deleted from database');
              toast.warning(language === 'vi' 
                ? 'ƒê√£ x√≥a d·ªØ li·ªáu t√†u nh∆∞ng kh√¥ng th·ªÉ x√≥a folder Google Drive'
                : 'Ship data deleted but failed to delete Google Drive folder'
              );
            } else {
              toast.success(language === 'vi' 
                ? 'ƒê√£ x√≥a folder Google Drive th√†nh c√¥ng'
                : 'Google Drive folder deleted successfully'
              );
            }
          }
        } catch (gdriveError) {
          console.error('Google Drive deletion error:', gdriveError);
          toast.warning(language === 'vi' 
            ? 'ƒê√£ x√≥a d·ªØ li·ªáu t√†u nh∆∞ng c√≥ l·ªói khi x√≥a folder Google Drive'
            : 'Ship data deleted but Google Drive folder deletion failed'
          );
        }
      }

      // Success message
      toast.success(language === 'vi' 
        ? `ƒê√£ x√≥a t√†u "${deleteShipData?.name}" th√†nh c√¥ng`
        : `Ship "${deleteShipData?.name}" deleted successfully`
      );

      // Refresh ships list
      await fetchShips();

      // Close modals and reset states
      setShowDeleteShipModal(false);
      setShowEditShipModal(false);
      setDeleteShipData(null);
      setEditingShipData(null);
      setDeleteShipOption('database_only');
      
      // Navigate back to ship list if current ship was deleted
      if (selectedShip && selectedShip.id === shipId) {
        setSelectedShip(null);
        setCertificates([]);
      }

    } catch (error) {
      console.error('Ship deletion error:', error);
      
      let errorMessage = 'Unknown error occurred';
      if (error.response?.data) {
        const errorData = error.response.data;
        if (typeof errorData.detail === 'string') {
          errorMessage = errorData.detail;
        } else if (Array.isArray(errorData.detail)) {
          errorMessage = errorData.detail.map(err => err.msg || err).join(', ');
        }
      } else if (error.message) {
        errorMessage = error.message;
      }
      
      toast.error(language === 'vi' 
        ? `Kh√¥ng th·ªÉ x√≥a t√†u: ${errorMessage}`
        : `Failed to delete ship: ${errorMessage}`
      );
    } finally {
      setIsDeletingShip(false);
    }
  };

  // Handle updating Next Survey and Next Survey Type for all certificates of current ship
  const handleUpdateSurveyTypes = async () => {
    if (!selectedShip) {
      toast.warning(language === 'vi' ? 'Vui l√≤ng ch·ªçn t√†u tr∆∞·ªõc' : 'Please select a ship first');
      return;
    }
    
    try {
      setIsUpdatingSurveyTypes(true);
      
      toast.info(language === 'vi' 
        ? 'ƒêang c·∫≠p nh·∫≠t Next Survey d·ª±a tr√™n quy ƒë·ªãnh IMO v√† chu k·ª≥ 5 nƒÉm...'
        : 'Updating Next Survey based on IMO regulations and 5-year cycle...'
      );

      // Call the new API endpoint to update next survey for the ship
      const response = await fetch(`${API}/ships/${selectedShip.id}/update-next-survey`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        const result = await response.json();
        
        if (result.success) {
          // Show detailed success message
          toast.success(language === 'vi' 
            ? `ƒê√£ c·∫≠p nh·∫≠t Next Survey cho ${result.updated_count}/${result.total_certificates} ch·ª©ng ch·ªâ c·ªßa t√†u ${result.ship_name}`
            : `Updated Next Survey for ${result.updated_count}/${result.total_certificates} certificates of ship ${result.ship_name}`
          );
          
          // Show detailed results if available
          if (result.results && result.results.length > 0) {
            console.log('Next Survey Update Results:', result.results);
            
            // Show first few updated certificates in console for debugging
            result.results.slice(0, 3).forEach((cert, index) => {
              console.log(`Certificate ${index + 1}: ${cert.cert_name}`);
              console.log(`  Next Survey: ${cert.old_next_survey} ‚Üí ${cert.new_next_survey}`);
              console.log(`  Next Survey Type: ${cert.old_next_survey_type} ‚Üí ${cert.new_next_survey_type}`);
              console.log(`  Reasoning: ${cert.reasoning}`);
            });
            
            // Show summary toast with first few changes
            const sampleChanges = result.results.slice(0, 2);
            const changesSummary = sampleChanges.map(cert => 
              `${cert.cert_name}: ${cert.new_next_survey_type}`
            ).join('; ');
            
            if (changesSummary) {
              setTimeout(() => {
                toast.info(language === 'vi' 
                  ? `V√≠ d·ª• c·∫≠p nh·∫≠t: ${changesSummary}`
                  : `Sample updates: ${changesSummary}`, 
                  { autoClose: 8000 }
                );
              }, 2000);
            }
          }
          
          // Refresh certificates list to show updated next survey info
          await fetchCertificates(selectedShip.id);
          
        } else {
          toast.warning(result.message || (language === 'vi' 
            ? 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t Next Survey'
            : 'Could not update Next Survey'
          ));
        }
      } else {
        const errorData = await response.json().catch(() => ({}));
        toast.error(language === 'vi' 
          ? `L·ªói khi c·∫≠p nh·∫≠t Next Survey: ${errorData.detail || response.statusText}`
          : `Error updating Next Survey: ${errorData.detail || response.statusText}`
        );
      }

    } catch (error) {
      console.error('Next Survey update error:', error);
      toast.error(language === 'vi' 
        ? 'L·ªói khi c·∫≠p nh·∫≠t Next Survey'
        : 'Error updating Next Survey'
      );
    } finally {
      setIsUpdatingSurveyTypes(false);
    }
  };

  // Handle manual review actions for files not auto-classified as marine certificates
  const handleManualReviewAction = async (action, reviewData) => {
    try {
      const actionData = {
        action: action, // "view", "skip", "confirm_marine"
        temp_file_id: reviewData.temp_file_id,
        filename: reviewData.filename,
        file_content_b64: reviewData.file_content_b64,
        ship_id: selectedShip?.id,
        analysis_result: reviewData.analysis,
        original_category: reviewData.detected_category
      };

      if (action === 'view') {
        // Show file viewer modal with complete analysis data
        setFileViewerData({
          filename: reviewData.filename,
          content_b64: reviewData.file_content_b64,
          content_type: reviewData.content_type,
          detected_category: reviewData.detected_category,
          confidence: reviewData.confidence,
          analysis: reviewData.analysis || {} // Include full analysis data
        });
        setShowFileViewer(true);
        return;
      }

      // For skip and confirm_marine actions, call backend
      const response = await fetch(`${API}/certificates/manual-review-action`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(actionData)
      });

      if (response.ok) {
        const result = await response.json();
        
        if (action === 'skip') {
          toast.info(language === 'vi' 
            ? `‚è≠Ô∏è ƒê√£ b·ªè qua file: ${reviewData.filename}`
            : `‚è≠Ô∏è Skipped file: ${reviewData.filename}`
          );
          
          // Remove from pending manual reviews
          setPendingManualReviews(prev => 
            prev.filter(item => item.temp_file_id !== reviewData.temp_file_id)
          );
          
          // Update multiCertUploads status
          setMultiCertUploads(prev => prev.map(upload => 
            upload.filename === reviewData.filename
              ? {
                  ...upload,
                  status: 'skipped',
                  progress: 100,
                  stage: language === 'vi' ? 'ƒê√£ b·ªè qua' : 'Skipped'
                }
              : upload
          ));
          
        } else if (action === 'confirm_marine') {
          toast.success(language === 'vi' 
            ? `‚úÖ ƒê√£ x√°c nh·∫≠n v√† th√™m ch·ª©ng ch·ªâ: ${reviewData.filename}`
            : `‚úÖ Confirmed and added certificate: ${reviewData.filename}`
          );
          
          // Remove from pending manual reviews
          setPendingManualReviews(prev => 
            prev.filter(item => item.temp_file_id !== reviewData.temp_file_id)
          );
          
          // Update multiCertUploads status
          setMultiCertUploads(prev => prev.map(upload => 
            upload.filename === reviewData.filename
              ? {
                  ...upload,
                  status: 'completed',
                  progress: 100,
                  stage: language === 'vi' ? 'Ho√†n th√†nh (ƒê√£ x√°c nh·∫≠n)' : 'Completed (User Confirmed)',
                  certificate: { id: result.certificate_id },
                  survey_type: result.survey_type,
                  user_confirmed: true
                }
              : upload
          ));
          
          // Refresh certificates list
          await fetchCertificates(selectedShip.id);
        }
        
      } else {
        throw new Error(`Action failed: ${response.statusText}`);
      }

    } catch (error) {
      console.error('Manual review action error:', error);
      toast.error(language === 'vi' 
        ? `L·ªói khi th·ª±c hi·ªán h√†nh ƒë·ªông: ${error.message}`
        : `Error performing action: ${error.message}`
      );
    }
  };

  // Load cache from sessionStorage on component mount
  useEffect(() => {
    try {
      const savedCache = sessionStorage.getItem('certificateLinksCache');
      if (savedCache) {
        setCertificateLinksCache(JSON.parse(savedCache));
        console.log('‚úÖ Loaded certificate links cache from sessionStorage');
      }
    } catch (error) {
      console.warn('Failed to load cache from sessionStorage:', error);
    }
  }, []);

  // Save cache to sessionStorage whenever it changes
  useEffect(() => {
    try {
      if (Object.keys(certificateLinksCache).length > 0) {
        sessionStorage.setItem('certificateLinksCache', JSON.stringify(certificateLinksCache));
      }
    } catch (error) {
      console.warn('Failed to save cache to sessionStorage:', error);
    }
  }, [certificateLinksCache]);

  // Handle click outside for ship selector dropdown
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (shipSelectorRef.current && !shipSelectorRef.current.contains(event.target)) {
        setShowShipSelector(false);
      }
    };

    if (showShipSelector) {
      document.addEventListener('mousedown', handleClickOutside);
    }

    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [showShipSelector]);

  // Get cached links for current ship
  const getCurrentShipLinks = () => {
    return selectedShip?.id ? (certificateLinksCache[selectedShip.id] || {}) : {};
  };

  // Pre-fetch certificate links for faster multi-copy functionality
  const preFetchCertificateLinks = async (certificateList, shipId) => {
    if (!certificateList || certificateList.length === 0 || !shipId) return;
    
    // Check if we already have cached links for this ship
    const existingCache = certificateLinksCache[shipId] || {};
    const uncachedCertificates = certificateList.filter(cert => !existingCache[cert.id]);
    
    if (uncachedCertificates.length === 0) {
      console.log(`‚úÖ All links already cached for ship ${shipId} (${certificateList.length} certificates)`);
      return;
    }
    
    console.log(`üîÑ Pre-fetching ${uncachedCertificates.length}/${certificateList.length} links for ship ${shipId}`);
    setLinksFetching(true);
    const linkCache = { ...existingCache }; // Start with existing cache
    
    try {
      // Fetch links in parallel with rate limiting (5 concurrent requests)
      const batchSize = 5;
      const batches = [];
      
      for (let i = 0; i < uncachedCertificates.length; i += batchSize) {
        const batch = uncachedCertificates.slice(i, i + batchSize);
        batches.push(batch);
      }
      
      for (const batch of batches) {
        const promises = batch.map(async (cert) => {
          if (!cert.google_drive_file_id) return null;
          
          try {
            const response = await fetch(`${API}/gdrive/file/${cert.google_drive_file_id}/view`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            
            if (data.view_url) {
              const certName = cert.cert_name || 'Certificate';
              const certAbbr = cert.cert_abbreviation || cert.cert_name?.substring(0, 4) || 'N/A';
              const formattedLink = `${certName} (${certAbbr}): ${data.view_url}`;
              
              return {
                id: cert.id,
                link: formattedLink,
                url: data.view_url
              };
            }
            return null;
          } catch (error) {
            console.warn(`Failed to pre-fetch link for certificate ${cert.id}:`, error);
            return null;
          }
        });
        
        const batchResults = await Promise.all(promises);
        batchResults.forEach(result => {
          if (result) {
            linkCache[result.id] = result;
          }
        });
        
        // Small delay between batches to avoid overwhelming the server
        if (batches.indexOf(batch) < batches.length - 1) {
          await new Promise(resolve => setTimeout(resolve, 100));
        }
      }
      
      // Update the cache for this specific ship
      setCertificateLinksCache(prev => ({
        ...prev,
        [shipId]: linkCache
      }));
      
      const newCachedCount = Object.keys(linkCache).length - Object.keys(existingCache).length;
      console.log(`‚úÖ Pre-fetched ${newCachedCount} new links for ship ${shipId}. Total cached: ${Object.keys(linkCache).length}/${certificateList.length}`);
      
    } catch (error) {
      console.error('Error pre-fetching certificate links:', error);
    } finally {
      setLinksFetching(false);
    }
  };

  const fetchCertificates = async (shipId) => {
    console.log('fetchCertificates called with shipId:', shipId);
    try {
      setIsRefreshing(true);
      
      // Add cache-busting parameter and force fresh data
      const timestamp = new Date().getTime();
      const response = await axios.get(`${API}/ships/${shipId}/certificates?_t=${timestamp}`, {
        headers: {
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        }
      });
      
      console.log('Certificates fetched successfully:', response.data.length, 'certificates');
      console.log('Sample certificate data:', response.data[0]); // Log first certificate for debugging
      
      // Force state update by clearing first then setting
      setCertificates([]);
      await new Promise(resolve => setTimeout(resolve, 50)); // Small delay to ensure state clears
      setCertificates(response.data);
      
      // Pre-fetch certificate links for faster multi-copy functionality
      if (response.data && response.data.length > 0 && shipId) {
        // Don't await this to avoid blocking UI
        preFetchCertificateLinks(response.data, shipId).catch(error => {
          console.warn('Pre-fetch links failed:', error);
        });
      }
    } catch (error) {
      console.error('Failed to fetch certificates:', error);
      setCertificates([]);
    } finally {
      setIsRefreshing(false);
    }
  };

  const handleRefreshCertificates = async () => {
    if (selectedShip) {
      await fetchCertificates(selectedShip.id);
      toast.success(language === 'vi' ? 'ƒê√£ c·∫≠p nh·∫≠t danh s√°ch ch·ª©ng ch·ªâ!' : 'Certificate list refreshed!');
    }
  };

  // Survey Report Functions
  const fetchSurveyReports = async (shipId) => {
    try {
      const response = await axios.get(`${API}/survey-reports?ship_id=${shipId}`);
      setSurveyReports(response.data);
    } catch (error) {
      console.error('Failed to fetch survey reports:', error);
      setSurveyReports([]);
    }
  };

  const handleSurveyReportSort = (column) => {
    setSurveyReportSort(prev => ({
      column,
      direction: prev.column === column && prev.direction === 'asc' ? 'desc' : 'asc'
    }));
  };

  const getFilteredSurveyReports = () => {
    let filtered = [...surveyReports];

    // Apply status filter
    if (surveyReportFilters.status !== 'all') {
      filtered = filtered.filter(report => 
        report.status && report.status.toLowerCase() === surveyReportFilters.status.toLowerCase()
      );
    }

    // Apply search filter
    if (surveyReportFilters.search) {
      const searchLower = surveyReportFilters.search.toLowerCase();
      filtered = filtered.filter(report =>
        (report.survey_report_name && report.survey_report_name.toLowerCase().includes(searchLower)) ||
        (report.survey_report_no && report.survey_report_no.toLowerCase().includes(searchLower)) ||
        (report.issued_by && report.issued_by.toLowerCase().includes(searchLower)) ||
        (report.note && report.note.toLowerCase().includes(searchLower))
      );
    }

    // Apply sorting
    if (surveyReportSort.column) {
      filtered.sort((a, b) => {
        let aValue = a[surveyReportSort.column] || '';
        let bValue = b[surveyReportSort.column] || '';

        // Handle date sorting
        if (surveyReportSort.column === 'issued_date') {
          aValue = a.issued_date ? new Date(a.issued_date).getTime() : 0;
          bValue = b.issued_date ? new Date(b.issued_date).getTime() : 0;
        } else {
          // String comparison
          aValue = String(aValue).toLowerCase();
          bValue = String(bValue).toLowerCase();
        }

        if (aValue < bValue) return surveyReportSort.direction === 'asc' ? -1 : 1;
        if (aValue > bValue) return surveyReportSort.direction === 'asc' ? 1 : -1;
        return 0;
      });
    }

    return filtered;
  };

  const handleAddSurveyReport = async () => {
    try {
      if (!selectedShip) {
        toast.error(language === 'vi' ? 'Vui l√≤ng ch·ªçn t√†u' : 'Please select a ship');
        return;
      }

      if (!newSurveyReport.survey_report_name) {
        toast.error(language === 'vi' ? 'Vui l√≤ng nh·∫≠p t√™n b√°o c√°o survey' : 'Please enter survey report name');
        return;
      }

      const reportData = {
        ship_id: selectedShip.id,  // REQUIRED: ship_id must be in request body, not just query params
        survey_report_name: newSurveyReport.survey_report_name,
        survey_report_no: newSurveyReport.survey_report_no || null,
        issued_date: newSurveyReport.issued_date ? convertDateInputToUTC(newSurveyReport.issued_date) : null,
        issued_by: newSurveyReport.issued_by || null,
        status: newSurveyReport.status || 'Valid',
        note: newSurveyReport.note || null,
        surveyor_name: newSurveyReport.surveyor_name || null  // Include surveyor_name from AI analysis
      };

      const createResponse = await axios.post(`${API}/survey-reports?ship_id=${selectedShip.id}`, reportData);
      
      const reportId = createResponse.data.id;
      
      // If file was analyzed, upload files to Google Drive
      if (analyzedSurveyReportData && analyzedSurveyReportData._file_content) {
        try {
          const uploadData = {
            file_content: analyzedSurveyReportData._file_content,
            filename: analyzedSurveyReportData._filename,
            content_type: analyzedSurveyReportData._content_type,
            summary_text: analyzedSurveyReportData._summary_text || ''
          };
          
          await axios.post(`${API}/survey-reports/${reportId}/upload-files`, uploadData);
          toast.success(language === 'vi' ? 'ƒê√£ th√™m b√°o c√°o survey v√† upload file' : 'Survey report added and files uploaded');
        } catch (uploadError) {
          console.error('File upload failed:', uploadError);
          toast.warning(language === 'vi' ? 'B√°o c√°o ƒë√£ l∆∞u nh∆∞ng upload file th·∫•t b·∫°i' : 'Report saved but file upload failed');
        }
      } else {
        toast.success(language === 'vi' ? 'ƒê√£ th√™m b√°o c√°o survey' : 'Survey report added successfully');
      }
      
      // Reset form and close modal
      setNewSurveyReport({
        survey_report_name: '',
        survey_report_no: '',
        issued_date: '',
        issued_by: '',
        status: 'Valid',
        note: '',
        surveyor_name: ''
      });
      setAnalyzedSurveyReportData(null);
      setSurveyReportFiles([]);
      setSurveyReportFileError('');
      setShowAddSurveyModal(false);
      
      // Refresh survey reports list
      await fetchSurveyReports(selectedShip.id);
    } catch (error) {
      console.error('Failed to add survey report:', error);
      // Handle Pydantic validation errors (array of objects) vs string errors
      let errorMsg = language === 'vi' ? 'Kh√¥ng th·ªÉ th√™m b√°o c√°o survey' : 'Failed to add survey report';
      if (error.response?.data?.detail) {
        const detail = error.response.data.detail;
        if (Array.isArray(detail)) {
          // Pydantic validation error format: [{type, loc, msg, input, url}]
          errorMsg = detail.map(err => err.msg).join(', ');
        } else if (typeof detail === 'string') {
          errorMsg = detail;
        }
      }
      toast.error(errorMsg);
    }
  };

  const handleUpdateSurveyReport = async () => {
    try {
      if (!editingSurveyReport) return;

      const updateData = {
        survey_report_name: editingSurveyReport.survey_report_name,
        survey_report_no: editingSurveyReport.survey_report_no || null,
        issued_date: editingSurveyReport.issued_date ? convertDateInputToUTC(editingSurveyReport.issued_date.split('T')[0]) : null,
        issued_by: editingSurveyReport.issued_by || null,
        status: editingSurveyReport.status || 'Valid',
        note: editingSurveyReport.note || null
      };

      await axios.put(`${API}/survey-reports/${editingSurveyReport.id}`, updateData);
      toast.success(language === 'vi' ? 'ƒê√£ c·∫≠p nh·∫≠t b√°o c√°o survey' : 'Survey report updated successfully');
      
      // Close modal and reset
      setShowEditSurveyModal(false);
      setEditingSurveyReport(null);
      
      // Refresh survey reports list
      if (selectedShip) {
        await fetchSurveyReports(selectedShip.id);
      }
    } catch (error) {
      console.error('Failed to update survey report:', error);
      // Handle Pydantic validation errors (array of objects) vs string errors
      let errorMsg = language === 'vi' ? 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t b√°o c√°o survey' : 'Failed to update survey report';
      if (error.response?.data?.detail) {
        const detail = error.response.data.detail;
        if (Array.isArray(detail)) {
          // Pydantic validation error format: [{type, loc, msg, input, url}]
          errorMsg = detail.map(err => err.msg).join(', ');
        } else if (typeof detail === 'string') {
          errorMsg = detail;
        }
      }
      toast.error(errorMsg);
    }
  };

  const handleDeleteSurveyReport = async (reportId) => {
    if (!window.confirm(language === 'vi' ? 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√°o c√°o survey n√†y?' : 'Are you sure you want to delete this survey report?')) {
      return;
    }

    try {
      await axios.delete(`${API}/survey-reports/${reportId}`);
      toast.success(language === 'vi' ? 'ƒê√£ x√≥a b√°o c√°o survey' : 'Survey report deleted successfully');
      
      // Refresh survey reports list
      if (selectedShip) {
        await fetchSurveyReports(selectedShip.id);
      }
    } catch (error) {
      console.error('Failed to delete survey report:', error);
      toast.error(language === 'vi' ? 'Kh√¥ng th·ªÉ x√≥a b√°o c√°o survey' : 'Failed to delete survey report');
    }
  };


  // Survey Report Context Menu Handlers
  const handleSurveyReportContextMenu = (e, report) => {
    e.preventDefault();
    
    // Calculate menu position ensuring it stays within viewport
    const menuWidth = 180; // minWidth from CSS
    const menuHeight = 200; // approximate height
    
    let x = e.clientX;
    let y = e.clientY;
    
    // Adjust if menu would go off right edge
    if (x + menuWidth > window.innerWidth) {
      x = window.innerWidth - menuWidth - 10;
    }
    
    // Adjust if menu would go off bottom edge
    if (y + menuHeight > window.innerHeight) {
      y = window.innerHeight - menuHeight - 10;
    }
    
    setSurveyReportContextMenu({
      show: true,
      x: x,
      y: y,
      report: report
    });
  };

  const handleOpenSurveyReport = (report) => {
    if (report.original_file_id) {
      window.open(`${API}/gdrive/file/${report.original_file_id}/view`, '_blank');
    } else {
      toast.warning(language === 'vi' ? 'File kh√¥ng kh·∫£ d·ª•ng' : 'File not available');
    }
    setSurveyReportContextMenu({ show: false, x: 0, y: 0, report: null });
  };

  const handleCopySurveyReportLink = (report) => {
    if (report.original_file_id) {
      const link = `${API}/gdrive/file/${report.original_file_id}/view`;
      navigator.clipboard.writeText(link);
      toast.success(language === 'vi' ? 'ƒê√£ copy link' : 'Link copied to clipboard');
    } else {
      toast.warning(language === 'vi' ? 'File kh√¥ng kh·∫£ d·ª•ng' : 'File not available');
    }
    setSurveyReportContextMenu({ show: false, x: 0, y: 0, report: null });
  };

  const handleEditSurveyReportFromMenu = (report) => {
    setEditingSurveyReport({
      ...report,
      issued_date: report.issued_date ? report.issued_date.split('T')[0] : ''
    });
    setShowEditSurveyModal(true);
    setSurveyReportContextMenu({ show: false, x: 0, y: 0, report: null });
  };

  const handleDeleteSurveyReportFromMenu = async (report) => {
    setSurveyReportContextMenu({ show: false, x: 0, y: 0, report: null });
    await handleDeleteSurveyReport(report.id);
  };


  // Survey Report Note Tooltip Handlers
  const handleNoteMouseEnter = (e, note) => {
    if (note) {
      const rect = e.currentTarget.getBoundingClientRect();
      
      // Get table width for tooltip max width
      const tableElement = e.currentTarget.closest('table');
      const tableWidth = tableElement ? tableElement.offsetWidth : 800;
      
      const tooltipWidth = Math.min(tableWidth / 2, window.innerWidth - 40); // Max 1/2 table width or viewport - 40px
      const tooltipHeight = 200; // Approximate height for 10 lines
      
      // Calculate position - prefer showing above, but adjust if needed
      let x = rect.left + rect.width / 2;
      let y = rect.top - 10;
      
      // Check if tooltip would go off left edge
      if (x - tooltipWidth / 2 < 20) {
        x = tooltipWidth / 2 + 20;
      }
      
      // Check if tooltip would go off right edge
      if (x + tooltipWidth / 2 > window.innerWidth - 20) {
        x = window.innerWidth - tooltipWidth / 2 - 20;
      }
      
      // Check if tooltip would go off top edge
      if (y - tooltipHeight < 10) {
        // Show below instead
        y = rect.bottom + 10;
      }
      
      setSurveyReportNoteTooltip({
        show: true,
        x: x,
        y: y,
        content: note,
        showBelow: y === rect.bottom + 10,
        width: tooltipWidth
      });
    }
  };

  const handleNoteMouseLeave = () => {
    setSurveyReportNoteTooltip({
      show: false,
      x: 0,
      y: 0,
      content: '',
      showBelow: false,
      width: 300
    });
  };

  // Survey Report File Upload Handlers
  const handleSurveyReportFileSelect = async (e) => {
    const files = Array.from(e.target.files || []);
    if (files.length === 0) return;
    
    await handleMultipleSurveyReportUpload(files);
  };

  const handleMultipleSurveyReportUpload = async (files) => {
    try {
      // Validate files
      const validFiles = [];
      const invalidFiles = [];
      const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20MB
      const ALLOWED_TYPES = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
      
      files.forEach(file => {
        if (!ALLOWED_TYPES.includes(file.type)) {
          invalidFiles.push({ file, reason: 'Invalid file type. Only PDF, JPG, PNG allowed.' });
        } else if (file.size > MAX_FILE_SIZE) {
          invalidFiles.push({ file, reason: 'File too large. Max 20MB.' });
        } else {
          validFiles.push(file);
        }
      });
      
      if (invalidFiles.length > 0) {
        const errorMsg = invalidFiles.map(({ file, reason }) => `${file.name}: ${reason}`).join('\n');
        toast.error(errorMsg);
      }
      
      if (validFiles.length === 0) {
        return;
      }
      
      // Check if ship is selected
      if (!selectedShip) {
        toast.error(language === 'vi' ? 'Vui l√≤ng ch·ªçn t√†u tr∆∞·ªõc' : 'Please select a ship first');
        return;
      }
      
      // Single file: Review mode
      if (validFiles.length === 1) {
        await handleSingleSurveyReportAnalysis(validFiles[0]);
      } 
      // Multiple files: Batch auto-process
      else {
        await startSurveyReportBatchProcessing(validFiles);
      }
      
    } catch (error) {
      console.error('Error handling survey report upload:', error);
      toast.error(language === 'vi' ? 'L·ªói x·ª≠ l√Ω file' : 'Error processing files');
    }
  };

  const handleSingleSurveyReportAnalysis = async (file) => {
    try {
      setIsAnalyzingSurveyReport(true);
      setSurveyReportFileError('');
      
      const formData = new FormData();
      formData.append('survey_report_file', file);
      formData.append('ship_id', selectedShip.id);
      formData.append('bypass_validation', 'false');
      
      const response = await axios.post(`${API}/survey-reports/analyze-file`, formData, {
        headers: { 'Content-Type': 'multipart/form-data' }
      });
      
      // Check for validation error (ship mismatch)
      if (response.data.validation_error) {
        // Ship info mismatch - ask user
        const shouldContinue = window.confirm(
          `${language === 'vi' ? 'C·∫£nh b√°o: Th√¥ng tin t√†u kh√¥ng kh·ªõp!' : 'Warning: Ship information mismatch!'}\n\n` +
          `${language === 'vi' ? 'Tr√≠ch xu·∫•t t·ª´ file:' : 'Extracted from file:'}\n` +
          `  - ${language === 'vi' ? 'T√™n t√†u:' : 'Ship Name:'} ${response.data.extracted_ship_name || 'N/A'}\n` +
          `  - ${language === 'vi' ? 'IMO:' : 'IMO:'} ${response.data.extracted_ship_imo || 'N/A'}\n\n` +
          `${language === 'vi' ? 'T√†u ƒë√£ ch·ªçn:' : 'Selected ship:'}\n` +
          `  - ${language === 'vi' ? 'T√™n t√†u:' : 'Ship Name:'} ${response.data.selected_ship_name}\n` +
          `  - ${language === 'vi' ? 'IMO:' : 'IMO:'} ${response.data.selected_ship_imo}\n\n` +
          `${language === 'vi' ? 'B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c?' : 'Do you want to continue anyway?'}`
        );
        
        if (!shouldContinue) {
          setIsAnalyzingSurveyReport(false);
          return;
        }
        
        // Retry with bypass validation
        formData.set('bypass_validation', 'true');
        const retryResponse = await axios.post(`${API}/survey-reports/analyze-file`, formData, {
          headers: { 'Content-Type': 'multipart/form-data' }
        });
        
        if (!retryResponse.data.success) {
          throw new Error('Analysis failed after bypass');
        }
        
        // Use retry response analysis
        const analysis = retryResponse.data.analysis;
        
        // Populate form with extracted data
        setNewSurveyReport({
          survey_report_name: analysis.survey_report_name || '',
          report_form: analysis.report_form || '',  // Include report form from AI
          survey_report_no: analysis.survey_report_no || '',
          issued_date: analysis.issued_date || '',
          issued_by: analysis.issued_by || '',
          status: analysis.status || 'Valid',
          note: analysis.note || '',
          surveyor_name: analysis.surveyor_name || ''  // Include surveyor name from AI
        });
        
        // Store analysis data for later upload
        setAnalyzedSurveyReportData(analysis);
        setSurveyReportFiles([file]);
        
        toast.success(language === 'vi' ? 'ƒê√£ ph√¢n t√≠ch file th√†nh c√¥ng! Vui l√≤ng ki·ªÉm tra v√† x√°c nh·∫≠n.' : 'File analyzed successfully! Please review and confirm.');
        
      } else if (response.data.success) {
        // Success without validation error
        const analysis = response.data.analysis;
        
        // Populate form with extracted data
        setNewSurveyReport({
          survey_report_name: analysis.survey_report_name || '',
          report_form: analysis.report_form || '',  // Include report form from AI
          survey_report_no: analysis.survey_report_no || '',
          issued_date: analysis.issued_date || '',
          issued_by: analysis.issued_by || '',
          status: analysis.status || 'Valid',
          note: analysis.note || '',
          surveyor_name: analysis.surveyor_name || ''  // Include surveyor name from AI
        });
        
        // Store analysis data for later upload
        setAnalyzedSurveyReportData(analysis);
        setSurveyReportFiles([file]);
        
        toast.success(language === 'vi' ? 'ƒê√£ ph√¢n t√≠ch file th√†nh c√¥ng! Vui l√≤ng ki·ªÉm tra v√† x√°c nh·∫≠n.' : 'File analyzed successfully! Please review and confirm.');
        
      } else {
        throw new Error(response.data.message || 'Analysis failed');
      }
      
    } catch (error) {
      console.error('Error analyzing survey report:', error);
      // Handle Pydantic validation errors (array of objects) vs string errors
      let errorMsg = 'Failed to analyze file';
      if (error.response?.data?.detail) {
        const detail = error.response.data.detail;
        if (Array.isArray(detail)) {
          // Pydantic validation error format: [{type, loc, msg, input, url}]
          errorMsg = detail.map(err => err.msg).join(', ');
        } else if (typeof detail === 'string') {
          errorMsg = detail;
        }
      } else if (error.message) {
        errorMsg = error.message;
      }
      setSurveyReportFileError(errorMsg);
      toast.error(language === 'vi' ? `L·ªói ph√¢n t√≠ch file: ${errorMsg}` : `Error analyzing file: ${errorMsg}`);
    } finally {
      setIsAnalyzingSurveyReport(false);
    }
  };

  const startSurveyReportBatchProcessing = async (files) => {
    try {
      setIsBatchProcessingSurveyReports(true);
      setSurveyReportBatchProgress({ current: 0, total: files.length });
      setSurveyReportBatchResults([]);
      
      const MAX_PARALLEL = 10; // Max 10 files at once
      const STAGGER_DELAY = 2000; // 2 seconds between file starts
      
      const results = [];
      
      // Process files with staggered start
      const promises = files.map((file, index) => {
        return new Promise((resolve) => {
          setTimeout(async () => {
            try {
              const result = await processSingleSurveyReportInBatch(file, index + 1, files.length);
              results.push(result);
              setSurveyReportBatchProgress({ current: results.length, total: files.length });
              resolve(result);
            } catch (error) {
              const errorResult = {
                filename: file.name,
                success: false,
                error: error.message || 'Processing failed',
                surveyReportCreated: false,
                fileUploaded: false
              };
              results.push(errorResult);
              setSurveyReportBatchProgress({ current: results.length, total: files.length });
              resolve(errorResult);
            }
          }, index * STAGGER_DELAY);
        });
      });
      
      // Wait for all files to complete
      await Promise.all(promises);
      
      // Close batch processing modal
      setIsBatchProcessingSurveyReports(false);
      
      // Close Add Survey Report modal
      setShowAddSurveyModal(false);
      
      // Show results modal
      setSurveyReportBatchResults(results);
      setShowSurveyReportProcessingResultsModal(true);
      
      // Refresh survey reports list
      if (selectedShip) {
        await fetchSurveyReports(selectedShip.id);
      }
      
      // Show summary toast
      const successCount = results.filter(r => r.success).length;
      const failCount = results.length - successCount;
      toast.success(
        `${language === 'vi' ? 'ƒê√£ x·ª≠ l√Ω' : 'Processed'} ${results.length} ${language === 'vi' ? 'file' : 'files'}: ` +
        `${successCount} ${language === 'vi' ? 'th√†nh c√¥ng' : 'success'}, ${failCount} ${language === 'vi' ? 'th·∫•t b·∫°i' : 'failed'}`
      );
      
    } catch (error) {
      console.error('Error in batch processing:', error);
      toast.error(language === 'vi' ? 'L·ªói x·ª≠ l√Ω batch' : 'Batch processing error');
      setIsBatchProcessingSurveyReports(false);
    }
  };

  const processSingleSurveyReportInBatch = async (file, current, total) => {
    const result = {
      filename: file.name,
      success: false,
      surveyReportCreated: false,
      fileUploaded: false,
      surveyReportName: '',
      surveyReportNo: '',
      error: null
    };
    
    try {
      console.log(`üìã Processing survey report ${current}/${total}: ${file.name}`);
      
      // Step 1: Analyze file
      const formData = new FormData();
      formData.append('survey_report_file', file);
      formData.append('ship_id', selectedShip.id);
      formData.append('bypass_validation', 'true'); // Auto-bypass in batch mode
      
      const analyzeResponse = await axios.post(`${API}/survey-reports/analyze-file`, formData, {
        headers: { 'Content-Type': 'multipart/form-data' }
      });
      
      if (!analyzeResponse.data.success) {
        throw new Error('Analysis failed');
      }
      
      const analysis = analyzeResponse.data.analysis;
      result.surveyReportName = analysis.survey_report_name || 'Unknown';
      result.surveyReportNo = analysis.survey_report_no || '';
      
      // Step 2: Check duplicate (optional)
      if (analysis.survey_report_no) {
        const duplicateResponse = await axios.post(`${API}/survey-reports/check-duplicate`, {
          ship_id: selectedShip.id,
          survey_report_no: analysis.survey_report_no
        });
        
        if (duplicateResponse.data.is_duplicate) {
          result.error = 'DUPLICATE';
          result.duplicateInfo = duplicateResponse.data.existing_report;
          console.log(`‚ö†Ô∏è Duplicate survey report: ${file.name}`);
          return result;
        }
      }
      
      // Step 3: Create survey report record
      const reportData = {
        survey_report_name: analysis.survey_report_name || file.name,
        survey_report_no: analysis.survey_report_no || null,
        issued_date: analysis.issued_date ? convertDateInputToUTC(analysis.issued_date) : null,
        issued_by: analysis.issued_by || null,
        status: analysis.status || 'Valid',
        note: analysis.note || null
      };
      
      const createResponse = await axios.post(`${API}/survey-reports?ship_id=${selectedShip.id}`, reportData);
      
      if (!createResponse.data || !createResponse.data.id) {
        throw new Error('Failed to create survey report record');
      }
      
      const reportId = createResponse.data.id;
      result.surveyReportCreated = true;
      result.reportId = reportId;
      console.log(`‚úÖ Survey report created: ${reportId}`);
      
      // Step 4: Upload files to Google Drive
      if (analysis._file_content && analysis._filename) {
        const uploadData = {
          file_content: analysis._file_content,
          filename: analysis._filename,
          content_type: analysis._content_type || 'application/octet-stream',
          summary_text: analysis._summary_text || ''
        };
        
        const uploadResponse = await axios.post(`${API}/survey-reports/${reportId}/upload-files`, uploadData);
        
        if (uploadResponse.data.success) {
          result.fileUploaded = true;
          console.log(`‚úÖ Files uploaded for report: ${reportId}`);
        } else {
          console.warn(`‚ö†Ô∏è File upload failed for report: ${reportId}`);
        }
      }
      
      result.success = true;
      return result;
      
    } catch (error) {
      console.error(`‚ùå Error processing ${file.name}:`, error);
      result.error = error.response?.data?.detail || error.message || 'Processing failed';
      return result;
    }
  };

  // Context Menu Functions
  const handleCertificateRightClick = (e, certificate) => {
    e.preventDefault();
    
    // Check if user has Company Officer role or higher
    const allowedRoles = ['company_officer', 'manager', 'admin', 'super_admin'];
    if (!allowedRoles.includes(user?.role)) {
      return; // Don't show context menu for unauthorized users
    }
    
    // If certificate is not selected, add it to current selection (don't clear others)
    if (!selectedCertificates.has(certificate.id)) {
      const newSelected = new Set(selectedCertificates);
      newSelected.add(certificate.id);
      setSelectedCertificates(newSelected);
    }
    
    // Calculate context menu position with viewport boundary checking
    const contextMenuWidth = 200; // Estimated width of context menu
    const contextMenuHeight = 180; // Estimated height of context menu
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    
    let x = e.clientX;
    let y = e.clientY;
    
    // Adjust X position if menu would overflow right edge
    if (x + contextMenuWidth > viewportWidth) {
      x = viewportWidth - contextMenuWidth - 10; // 10px margin from edge
    }
    
    // Adjust Y position if menu would overflow bottom edge
    if (y + contextMenuHeight > viewportHeight) {
      y = y - contextMenuHeight; // Show above cursor instead of below
      // If still overflows (near top of screen), position at bottom of viewport
      if (y < 0) {
        y = viewportHeight - contextMenuHeight - 10; // 10px margin from bottom
      }
    }
    
    // Ensure menu doesn't go off left or top edges
    if (x < 0) x = 10;
    if (y < 0) y = 10;
    
    setContextMenu({
      show: true,
      x: x,
      y: y,
      certificate: certificate
    });
  };

  const handleDownloadSelectedCertificates = async () => {
    try {
      if (selectedCertificates.size === 0) return;
      
      // Show loading toast for multiple files
      if (selectedCertificates.size > 1) {
        toast.info(language === 'vi' 
          ? `ƒêang t·∫£i xu·ªëng ${selectedCertificates.size} ch·ª©ng ch·ªâ...` 
          : `Downloading ${selectedCertificates.size} certificates...`);
      }
      
      // Get selected certificate data
      const selectedCertificatesData = getFilteredCertificates().filter(cert => 
        selectedCertificates.has(cert.id)
      );
      
      // Download each certificate
      for (const certificate of selectedCertificatesData) {
        try {
          await downloadSingleCertificate(certificate);
          // Small delay between downloads to avoid overwhelming the browser
          if (selectedCertificates.size > 1) {
            await new Promise(resolve => setTimeout(resolve, 500));
          }
        } catch (error) {
          console.error(`Failed to download certificate: ${certificate.certificate_name}`, error);
          toast.error(language === 'vi' 
            ? `Kh√¥ng th·ªÉ t·∫£i: ${certificate.certificate_name}` 
            : `Failed to download: ${certificate.certificate_name}`);
        }
      }
      
      // Success message
      if (selectedCertificates.size > 1) {
        toast.success(language === 'vi' 
          ? `ƒê√£ t·∫£i xu·ªëng ${selectedCertificates.size} ch·ª©ng ch·ªâ` 
          : `Downloaded ${selectedCertificates.size} certificates`);
      }
      
    } catch (error) {
      console.error('Download error:', error);
      toast.error(language === 'vi' ? 'L·ªói khi t·∫£i xu·ªëng' : 'Download error');
    }
    setContextMenu({ show: false, x: 0, y: 0, certificate: null });
  };

  const downloadSingleCertificate = async (certificate) => {
    try {
      // Get download URL from backend
      const response = await fetch(`${API}/gdrive/file/${certificate.google_drive_file_id}/download`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (!response.ok) {
        throw new Error('Failed to get download URL');
      }
      
      const data = await response.json();
      
      if (data.download_url) {
        // Create temporary link and trigger download
        const link = document.createElement('a');
        link.href = data.download_url;
        
        // Generate filename: Certificate Name + Extension
        const filename = certificate.certificate_name 
          ? `${certificate.certificate_name}.pdf`
          : `Certificate_${certificate.id}.pdf`;
        
        link.download = filename;
        link.target = '_blank';
        
        // Append to document, click, and remove
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log(`Downloaded: ${filename}`);
      } else {
        throw new Error('No download URL provided');
      }
    } catch (error) {
      console.error('Single certificate download error:', error);
      throw error;
    }
  };

  const handleDownloadCertificate = async (certificate) => {
    try {
      await downloadSingleCertificate(certificate);
      toast.success(language === 'vi' 
        ? `ƒê√£ t·∫£i xu·ªëng: ${certificate.certificate_name}` 
        : `Downloaded: ${certificate.certificate_name}`);
    } catch (error) {
      toast.error(language === 'vi' ? 'Kh√¥ng th·ªÉ t·∫£i xu·ªëng file' : 'Cannot download file');
    }
    setContextMenu({ show: false, x: 0, y: 0, certificate: null });
  };

  const handleOpenCertificate = async (certificate) => {
    try {
      const response = await fetch(`${API}/gdrive/file/${certificate.google_drive_file_id}/view`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();
      if (data.view_url) {
        window.open(data.view_url, '_blank');
      } else {
        toast.error(language === 'vi' ? 'Kh√¥ng th·ªÉ m·ªü file' : 'Cannot open file');
      }
    } catch (error) {
      toast.error(language === 'vi' ? 'L·ªói khi m·ªü file' : 'Error opening file');
    }
    setContextMenu({ show: false, x: 0, y: 0, certificate: null });
  };

  const handleOpenSelectedCertificates = async () => {
    try {
      if (selectedCertificates.size === 0) return;
      
      // Warn if opening too many files
      if (selectedCertificates.size > 10) {
        const confirmed = window.confirm(
          language === 'vi' 
            ? `B·∫°n ƒëang m·ªü ${selectedCertificates.size} files. ƒêi·ªÅu n√†y c√≥ th·ªÉ l√†m ch·∫≠m tr√¨nh duy·ªát. B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c?`
            : `You are opening ${selectedCertificates.size} files. This may slow down your browser. Do you want to continue?`
        );
        if (!confirmed) return;
      }

      const allCertificates = getFilteredCertificates();
      const certificatesToOpen = allCertificates.filter(cert => selectedCertificates.has(cert.id));
      
      // Show initial info toast
      toast.info(
        language === 'vi' 
          ? `ƒêang t·∫£i ${certificatesToOpen.length} files, s·∫Ω m·ªü t·ª´ng file v·ªõi ƒë·ªô tr·ªÖ 1 gi√¢y...`
          : `Loading ${certificatesToOpen.length} files, will open each file with 1 second delay...`
      );
      
      let openedCount = 0;
      let errorCount = 0;
      
      // First, fetch all URLs in parallel for faster loading
      const urlPromises = certificatesToOpen.map(async (cert) => {
        try {
          const response = await fetch(`${API}/gdrive/file/${cert.google_drive_file_id}/view`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await response.json();
          return { cert, url: data.view_url, success: !!data.view_url };
        } catch (error) {
          console.error(`Error fetching URL for ${cert.cert_name}:`, error);
          return { cert, url: null, success: false };
        }
      });
      
      const urlResults = await Promise.all(urlPromises);
      
      // Then open tabs with delays, using direct window.open for better browser support
      urlResults.forEach((result, index) => {
        setTimeout(() => {
          if (result.success && result.url) {
            try {
              // Use direct window.open with minimal features for better compatibility
              const newTab = window.open(result.url, '_blank');
              if (newTab) {
                openedCount++;
                console.log(`‚úÖ Opened tab ${index + 1}/${urlResults.length}: ${result.cert.cert_name}`);
              } else {
                errorCount++;
                console.warn(`‚ùå Failed to open tab for: ${result.cert.cert_name} (popup blocked)`);
              }
            } catch (error) {
              errorCount++;
              console.error(`‚ùå Error opening tab for ${result.cert.cert_name}:`, error);
            }
          } else {
            errorCount++;
            console.warn(`‚ùå No URL available for: ${result.cert.cert_name}`);
          }
          
          // Show final toast on last iteration
          if (index === urlResults.length - 1) {
            setTimeout(() => {
              if (openedCount > 0) {
                toast.success(
                  language === 'vi' 
                    ? `‚úÖ ƒê√£ m·ªü ${openedCount}/${urlResults.length} files${errorCount > 0 ? ` (${errorCount} l·ªói)` : ''}`
                    : `‚úÖ Opened ${openedCount}/${urlResults.length} files${errorCount > 0 ? ` (${errorCount} errors)` : ''}`
                );
              } else {
                toast.error(
                  language === 'vi' 
                    ? '‚ùå Kh√¥ng th·ªÉ m·ªü files (c√≥ th·ªÉ b·ªã ch·∫∑n popup)' 
                    : '‚ùå Cannot open files (may be blocked by popup blocker)'
                );
              }
            }, 100);
          }
        }, index * 1000); // 1 second delay between each open
      });
      
      handleCloseContextMenu();
    } catch (error) {
      console.error('Error in handleOpenSelectedCertificates:', error);
      toast.error(language === 'vi' ? 'L·ªói khi m·ªü files' : 'Error opening files');
    }
  };

  const handleCopySelectedLinks = async () => {
    try {
      if (selectedCertificates.size === 0) return;

      const allCertificates = getFilteredCertificates();
      const certificatesToCopy = allCertificates.filter(cert => selectedCertificates.has(cert.id));
      
      let copiedLinks = [];
      let errorCount = 0;
      let cachedCount = 0;
      let fetchedCount = 0;
      
      // Get current ship's cached links
      const currentShipLinks = getCurrentShipLinks();
      
      // First, try to use cached links
      for (const cert of certificatesToCopy) {
        const cachedLink = currentShipLinks[cert.id];
        if (cachedLink && cachedLink.link) {
          copiedLinks.push(cachedLink.link);
          cachedCount++;
        } else {
          // Fallback: fetch link if not cached
          try {
            const response = await fetch(`${API}/gdrive/file/${cert.google_drive_file_id}/view`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            
            if (data.view_url) {
              // Format: "Certificate Name (Certificate Abbreviation): URL"
              const certName = cert.cert_name || 'Certificate';
              const certAbbr = cert.cert_abbreviation || cert.cert_name?.substring(0, 4) || 'N/A';
              const formattedLink = `${certName} (${certAbbr}): ${data.view_url}`;
              copiedLinks.push(formattedLink);
              fetchedCount++;
              
              // Cache this link for future use
              if (selectedShip?.id) {
                setCertificateLinksCache(prev => ({
                  ...prev,
                  [selectedShip.id]: {
                    ...getCurrentShipLinks(),
                    [cert.id]: {
                      link: formattedLink,
                      url: data.view_url
                    }
                  }
                }));
              }
            } else {
              errorCount++;
            }
          } catch (error) {
            errorCount++;
          }
        }
      }
      
      if (copiedLinks.length > 0) {
        // Copy all links to clipboard, separated by newlines
        const linksText = copiedLinks.join('\n');
        await navigator.clipboard.writeText(linksText);
        
        // Enhanced success message showing cache performance
        const performanceInfo = cachedCount > 0 ? 
          (language === 'vi' 
            ? ` (${cachedCount} t·ª´ cache, ${fetchedCount} t·∫£i m·ªõi)` 
            : ` (${cachedCount} cached, ${fetchedCount} fetched)`) : '';
        
        toast.success(
          language === 'vi' 
            ? `‚úÖ ƒê√£ copy ${copiedLinks.length} link${errorCount > 0 ? `, ${errorCount} link l·ªói` : ''}${performanceInfo}`
            : `‚úÖ Copied ${copiedLinks.length} link${copiedLinks.length > 1 ? 's' : ''}${errorCount > 0 ? `, ${errorCount} error${errorCount > 1 ? 's' : ''}` : ''}${performanceInfo}`
        );
      } else {
        toast.error(language === 'vi' ? 'Kh√¥ng th·ªÉ l·∫•y links' : 'Cannot get links');
      }
      
      handleCloseContextMenu();
    } catch (error) {
      console.error('Error in handleCopySelectedLinks:', error);
      toast.error(language === 'vi' ? 'L·ªói khi copy links' : 'Error copying links');
    }
  };

  const handleCopyLink = async (certificate) => {
    try {
      const response = await fetch(`${API}/gdrive/file/${certificate.google_drive_file_id}/view`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();
      
      if (data.view_url) {
        await navigator.clipboard.writeText(data.view_url);
        toast.success(language === 'vi' ? 'ƒê√£ copy link' : 'Link copied');
      } else {
        toast.error(language === 'vi' ? 'Kh√¥ng th·ªÉ l·∫•y link' : 'Cannot get link');
      }
    } catch (error) {
      toast.error(language === 'vi' ? 'L·ªói khi copy link' : 'Error copying link');
    }
    setContextMenu({ show: false, x: 0, y: 0, certificate: null });
  };

  const handleDeleteCertificateFromContext = () => {
    setShowDeleteConfirmation(true);
    setContextMenu({ show: false, x: 0, y: 0, certificate: null });
  };

  const handleCloseContextMenu = () => {
    setContextMenu({ show: false, x: 0, y: 0, certificate: null });
  };

  // Show the auto rename dialog
  const handleShowAutoRenameDialog = () => {
    setShowAutoRenameDialog(true);
    handleCloseContextMenu();
  };

  // Execute the actual batch auto rename logic
  const handleExecuteBatchAutoRename = async () => {
    try {
      // Get certificates to rename
      let certificatesToRename = [];
      
      if (selectedCertificates.size > 0) {
        // Use selected certificates if any are checked
        certificatesToRename = Array.from(selectedCertificates);
      } else if (contextMenu.certificate?.id) {
        // Use the right-clicked certificate if no checkboxes are selected
        certificatesToRename = [contextMenu.certificate.id];
      }
      
      console.log('üîç Certificates to rename:', certificatesToRename);
      console.log('üîç Selected certificates size:', selectedCertificates.size);
      console.log('üîç Context menu certificate:', contextMenu.certificate?.id);
      
      if (certificatesToRename.length === 0) {
        toast.error(language === 'vi' ? 'Kh√¥ng c√≥ ch·ª©ng ch·ªâ n√†o ƒë∆∞·ª£c ch·ªçn!' : 'No certificates selected!');
        return;
      }

      // Filter certificates that have Google Drive file IDs
      const allCertificates = getFilteredCertificates();
      const validCertificates = certificatesToRename.map(certId => {
        const cert = allCertificates.find(c => c.id === certId);
        return cert;
      }).filter(cert => cert && cert.google_drive_file_id);

      if (validCertificates.length === 0) {
        toast.error(language === 'vi' 
          ? 'Kh√¥ng c√≥ ch·ª©ng ch·ªâ n√†o c√≥ file tr√™n Google Drive!' 
          : 'No certificates have Google Drive files!');
        return;
      }

      // Initialize progress
      setBatchRenameProgress({
        isRunning: true,
        completed: 0,
        total: validCertificates.length,
        current: '',
        errors: []
      });

      const errors = [];
      let completed = 0;

      // Process each certificate sequentially to avoid overwhelming the server
      for (const certificate of validCertificates) {
        try {
          // Update progress
          setBatchRenameProgress(prev => ({
            ...prev,
            current: `${certificate.cert_name || certificate.cert_abbreviation || 'Unknown'} (${certificate.cert_no || 'No Number'})`
          }));

          // Make the auto-rename API call
          const response = await axios.post(`${API}/certificates/${certificate.id}/auto-rename-file`, {}, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (response.data.success) {
            completed++;
            setBatchRenameProgress(prev => ({
              ...prev,
              completed: completed
            }));
            
            console.log(`‚úÖ Successfully renamed: ${certificate.cert_name} ‚Üí ${response.data.new_name}`);
          } else {
            throw new Error(response.data.message || 'Unknown error');
          }
          
          // Small delay between requests to avoid overwhelming the server
          await new Promise(resolve => setTimeout(resolve, 500));
          
        } catch (error) {
          console.error(`‚ùå Failed to rename ${certificate.cert_name}:`, error);
          
          let errorMessage = certificate.cert_name || certificate.cert_abbreviation || 'Unknown Certificate';
          if (error.response && error.response.status === 501) {
            // Handle the "not supported" error gracefully
            const detail = error.response.data.detail || '';
            const suggestedMatch = detail.match(/Suggested filename: (.+)/);
            if (suggestedMatch) {
              errorMessage += ` (${language === 'vi' ? 'G·ª£i √Ω' : 'Suggested'}: ${suggestedMatch[1]})`;
            }
          } else {
            errorMessage += ` (${error.message || 'Unknown error'})`;
          }
          
          errors.push(errorMessage);
          setBatchRenameProgress(prev => ({
            ...prev,
            errors: [...prev.errors, errorMessage]
          }));
        }
      }

      // Show completion message
      const successCount = completed;
      const errorCount = errors.length;

      if (successCount > 0) {
        toast.success(language === 'vi' 
          ? `ƒê√£ ƒë·ªïi t√™n ${successCount}/${validCertificates.length} files th√†nh c√¥ng!` 
          : `Successfully renamed ${successCount}/${validCertificates.length} files!`);
      }
      
      if (errorCount > 0) {
        toast.error(language === 'vi' 
          ? `${errorCount} files kh√¥ng th·ªÉ ƒë·ªïi t√™n. Xem chi ti·∫øt trong console.` 
          : `${errorCount} files could not be renamed. Check console for details.`);
        console.log('‚ùå Rename errors:', errors);
      }

      // Refresh certificate list - Add safety check
      if (successCount > 0 && selectedShip?.id) {
        await fetchCertificates(selectedShip.id);
      }

      // Close dialog after completion
      setTimeout(() => {
        setShowAutoRenameDialog(false);
        setBatchRenameProgress({ isRunning: false, completed: 0, total: 0, current: '', errors: [] });
        setSelectedCertificates(new Set()); // Clear selection
      }, 2000);

    } catch (error) {
      console.error('‚ùå Batch auto rename error:', error);
      toast.error(language === 'vi' 
        ? 'L·ªói khi th·ª±c hi·ªán batch auto rename!' 
        : 'Error during batch auto rename!');
      
      // Reset progress on error
      setBatchRenameProgress({ isRunning: false, completed: 0, total: 0, current: '', errors: [] });
    }
  };

  // Legacy function for backward compatibility
  const handleBatchAutoRename = handleShowAutoRenameDialog;

  const handleEditCertificate = () => {
    setEditingCertificate(contextMenu.certificate);
    setShowEditCertModal(true);
    handleCloseContextMenu();
  };

  const handleDeleteCertificate = async () => {
    if (!contextMenu.certificate) return;
    
    const confirmMessage = language === 'vi' 
      ? `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch·ª©ng ch·ªâ "${contextMenu.certificate.cert_name}"?`
      : `Are you sure you want to delete certificate "${contextMenu.certificate.cert_name}"?`;
    
    if (window.confirm(confirmMessage)) {
      try {
        await axios.delete(`${API}/certificates/${contextMenu.certificate.id}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        toast.success(language === 'vi' ? 'ƒê√£ x√≥a ch·ª©ng ch·ªâ!' : 'Certificate deleted!');
        await fetchCertificates(selectedShip.id); // Refresh list
      } catch (error) {
        console.error('Error deleting certificate:', error);
        toast.error(language === 'vi' ? 'L·ªói khi x√≥a ch·ª©ng ch·ªâ!' : 'Error deleting certificate!');
      }
    }
    
    setContextMenu({ show: false, x: 0, y: 0, certificate: null });
  };

  // Close context menu when clicking outside
  useEffect(() => {
    const handleClickOutside = () => {
      if (contextMenu.show) {
        handleCloseContextMenu();
      }
      if (crewContextMenu.show) {
        setCrewContextMenu({ show: false, x: 0, y: 0, crew: null });
      }
      if (passportContextMenu.show) {
        setPassportContextMenu({ show: false, x: 0, y: 0, crew: null });
      }
      if (seamenBookContextMenu.show) {
        setSeamenBookContextMenu({ show: false, x: 0, y: 0, crew: null });
      }
      if (rankContextMenu.show) {
        setRankContextMenu({ show: false, x: 0, y: 0, crew: null });
      }
      if (certContextMenu.show) {
        setCertContextMenu({ show: false, x: 0, y: 0, cert: null });
      }
    };
    
    document.addEventListener('click', handleClickOutside);
    return () => document.removeEventListener('click', handleClickOutside);
  }, [contextMenu.show, crewContextMenu.show, passportContextMenu.show, seamenBookContextMenu.show, rankContextMenu.show, certContextMenu.show]);

  // Handle duplicate resolution
  const handleDuplicateResolution = async (action, resetAnalyzingState) => {
    const { fileData, analysisResult, duplicateInfo, shipId, fileIndex, fileName } = duplicateResolutionModal;
    
    try {
      // Call resolve duplicate API
      const response = await fetch(`${API}/certificates/resolve-duplicate`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          action: action, // "skip" or "continue"
          file_data: fileData,
          analysis_result: analysisResult,
          ship_id: shipId,
          duplicate_info: duplicateInfo
        })
      });
      
      if (response.ok) {
        const result = await response.json();
        
        if (action === 'skip') {
          // Update upload status to skipped
          setMultiCertUploads(prev => prev.map((upload, idx) => 
            idx === fileIndex 
              ? {
                  ...upload,
                  status: 'skipped',
                  progress: 100,
                  stage: language === 'vi' ? 'ƒê√£ b·ªè qua' : 'Skipped'
                }
              : upload
          ));
          
          toast.info(language === 'vi' 
            ? `‚è© ƒê√£ b·ªè qua: ${fileName} (tr√πng l·∫∑p)`
            : `‚è© Skipped: ${fileName} (duplicate)`
          );
          
        } else if (action === 'continue') {
          // Update upload status to completed
          setMultiCertUploads(prev => prev.map((upload, idx) => 
            idx === fileIndex 
              ? {
                  ...upload,
                  status: 'completed',
                  progress: 100,
                  stage: language === 'vi' ? 'Ho√†n th√†nh' : 'Completed',
                  certificate: result.certificate
                }
              : upload
          ));
          
          toast.success(language === 'vi' 
            ? `‚úÖ ƒê√£ t·∫°o: ${fileName} (b·∫•t ch·∫•p tr√πng l·∫∑p)`
            : `‚úÖ Created: ${fileName} (despite duplicate)`
          );
        }
        
        // Process next duplicate in queue (will close modal if no more duplicates)
        processNextDuplicate();
        
        // Refresh certificates list
        if (selectedShip) {
          await fetchCertificates(selectedShip.id);
        }
        
        // Reset multi cert processing state to unlock the Add Certificate button
        if (typeof resetAnalyzingState === 'function') {
          resetAnalyzingState(false);
        }
        
      } else {
        const errorData = await response.json().catch(() => ({}));
        toast.error(language === 'vi' 
          ? `L·ªói x·ª≠ l√Ω tr√πng l·∫∑p: ${errorData.detail || response.statusText}`
          : `Error resolving duplicate: ${errorData.detail || response.statusText}`
        );
        
        // Process next duplicate even on error
        processNextDuplicate();
        
        // Reset multi cert processing state on error
        if (typeof resetAnalyzingState === 'function') {
          resetAnalyzingState(false);
        }
      }
      
    } catch (error) {
      console.error('Duplicate resolution error:', error);
      toast.error(language === 'vi' 
        ? 'L·ªói khi x·ª≠ l√Ω tr√πng l·∫∑p'
        : 'Error resolving duplicate'
      );
      
      // Process next duplicate even on error
      processNextDuplicate();
      
      // Reset multi cert processing state on error
      if (typeof resetAnalyzingState === 'function') {
        resetAnalyzingState(false);
      }
    }
  };

  // Update resolution for a specific file
  const updateFileResolution = (filename, resolution) => {
    setDuplicateResolutionModal(prev => ({
      ...prev,
      files: prev.files.map(file => 
        file.filename === filename 
          ? { ...file, resolution }
          : file
      )
    }));
  };

  // Process duplicate resolutions
  const processDuplicateResolutions = async () => {
    try {
      const { files, shipId } = duplicateResolutionModal;
      let processedCount = 0;
      let cancelledCount = 0;
      
      for (const file of files) {
        if (file.resolution === 'cancel') {
          cancelledCount++;
          continue;
        }
        
        const resolutionData = {
          analysis_result: file.analysis,
          ship_id: shipId,
          duplicate_resolution: file.resolution,
          duplicate_target_id: file.duplicate_certificate?.id
        };
        
        const response = await axios.post(`${API}/certificates/process-with-resolution`, resolutionData, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (response.data.status === 'success') {
          processedCount++;
        }
      }
      
      // Close modal
      setDuplicateResolutionModal({
        show: false,
        files: [],
        shipId: null
      });
      
      // Show results
      if (processedCount > 0) {
        toast.success(
          language === 'vi' 
            ? `‚úÖ ƒê√£ x·ª≠ l√Ω th√†nh c√¥ng ${processedCount} certificates`
            : `‚úÖ Successfully processed ${processedCount} certificates`
        );
        
        // Refresh certificate list
        if (selectedShip) {
          await fetchCertificates(selectedShip.id);
        }
      }
      
      if (cancelledCount > 0) {
        toast.info(
          language === 'vi'
            ? `‚ÑπÔ∏è ƒê√£ h·ªßy ${cancelledCount} certificates`
            : `‚ÑπÔ∏è Cancelled ${cancelledCount} certificates`
        );
      }
      
    } catch (error) {
      console.error('Error processing duplicate resolutions:', error);
      toast.error(
        language === 'vi'
          ? `‚ùå L·ªói x·ª≠ l√Ω: ${error.response?.data?.detail || error.message}`
          : `‚ùå Processing error: ${error.response?.data?.detail || error.message}`
      );
    }
  };

  const handleMismatchResolution = (action) => {
    toast.info(language === 'vi' ? 'Ch·ª©c nƒÉng ƒëang ƒë∆∞·ª£c x√¢y d·ª±ng l·∫°i' : 'Feature is being rebuilt');
  };

  // Multi Cert Upload Functions
  const handleMultiCertUpload = async (files, autoFillCallback = null) => {
    if (!files || files.length === 0) return;
    
    if (!selectedShip) {
      toast.error(language === 'vi' 
        ? 'Vui l√≤ng ch·ªçn t√†u tr∆∞·ªõc khi upload certificates'
        : 'Please select a ship before uploading certificates'
      );
      return;
    }
    
    // Initialize upload states
    setIsMultiCertProcessing(true);
    setUploadSummary(null);
    
    const fileArray = Array.from(files);
    const initialUploads = fileArray.map((file, index) => ({
      index,
      filename: file.name,
      name: file.name, // Add name field for display
      size: file.size,
      status: 'pending', // pending, uploading, analyzing, processing, completed, error
      progress: 0,
      stage: language === 'vi' ? 'ƒêang ch·ªù x·ª≠ l√Ω...' : 'Waiting to process...', // Add stage field
      analysis: null,
      upload: null,
      certificate: null,
      error: null,
      isMarine: null
    }));
    
    setMultiCertUploads(initialUploads);
    
    try {
      let successCount = 0;
      let errorCount = 0;
      let totalFiles = fileArray.length;
      
      // Show initial info about batch processing with delay
      toast.info(language === 'vi' 
        ? `B·∫Øt ƒë·∫ßu upload ${totalFiles} files v·ªõi delay 0.5s gi·ªØa c√°c file...`
        : `Starting upload of ${totalFiles} files with 0.5s delay between files...`
      );
      
      // Start all uploads concurrently with 0.5s delay between each
      const uploadPromises = [];
      
      for (let i = 0; i < fileArray.length; i++) {
        const file = fileArray[i];
        
        // Create promise for each file upload with delay
        const uploadPromise = new Promise(async (resolve) => {
          try {
            // Wait for staggered start (0.5s * index)
            await new Promise(delayResolve => setTimeout(delayResolve, i * 500));
            
            // Update status to uploading for current file
            setMultiCertUploads(prev => prev.map((upload, idx) => 
              idx === i 
                ? {
                    ...upload,
                    status: 'uploading',
                    stage: language === 'vi' 
                      ? `ƒêang upload ${file.name}... (${i + 1}/${totalFiles})`
                      : `Uploading ${file.name}... (${i + 1}/${totalFiles})`
                  }
                : upload
            ));
            
            // Create FormData for single file
            const formData = new FormData();
            formData.append('files', file);
            
            // Upload single file
            const response = await axios.post(`${API}/certificates/multi-upload?ship_id=${selectedShip.id}`, formData, {
              headers: {
                'Content-Type': 'multipart/form-data',
                'Authorization': `Bearer ${token}`
              },
              onUploadProgress: (progressEvent) => {
                const progress = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                setMultiCertUploads(prev => prev.map((upload, idx) => 
                  idx === i 
                    ? {
                        ...upload,
                        progress: progress,
                        stage: language === 'vi' 
                          ? `ƒêang upload ${file.name}... ${progress}% (${i + 1}/${totalFiles})`
                          : `Uploading ${file.name}... ${progress}% (${i + 1}/${totalFiles})`
                      }
                    : upload
                ));
              }
            });
            
            // Process the response for this file
            const results = response.data.results || [];
            const result = results[0]; // Should be only one result
            
            if (result && (result.status === 'completed' || result.status === 'success' || result.status === 'success_with_reference_note' || result.status === 'duplicate')) {
              const progressMessage = result?.progress_message;
              const defaultStage = language === 'vi' ? 'Ho√†n th√†nh' : 'Completed';
              
              // Determine the final status for display
              let finalStatus = 'completed';
              if (result.status === 'success_with_reference_note') {
                finalStatus = 'success_with_reference_note';
              }
              
              setMultiCertUploads(prev => prev.map((upload, idx) => 
                idx === i 
                  ? {
                      ...upload,
                      status: finalStatus,
                      progress: 100,
                      stage: progressMessage || defaultStage, // Use progress_message if available
                      analysis: result.analysis,
                      upload: result.upload,
                      certificate: result.certificate,
                      isMarine: result.is_marine,
                      progress_message: progressMessage, // Store progress message
                      validation_note: result.validation_note // Store validation note
                    }
                  : upload
              ));
              
              // Show success toast only if no progress_message (normal success case)
              if (!progressMessage) {
                const statusMessage = result.status === 'duplicate' 
                  ? (language === 'vi' ? ' (ƒê√£ t·ªìn t·∫°i)' : ' (Already exists)')
                  : '';
                
                toast.success(language === 'vi' 
                  ? `‚úÖ Upload th√†nh c√¥ng: ${file.name}${statusMessage} (${i + 1}/${totalFiles})`
                  : `‚úÖ Upload successful: ${file.name}${statusMessage} (${i + 1}/${totalFiles})`
                );
              }
              
              resolve({ status: 'success', file: file.name });
              
            } else if (result && result.status === 'pending_duplicate_resolution') {
              // File requires duplicate resolution - pause and add to queue
              setMultiCertUploads(prev => prev.map((upload, idx) => 
                idx === i 
                  ? {
                      ...upload,
                      status: 'pending_duplicate',
                      progress: 90,
                      stage: language === 'vi' ? 'Ch·ªù quy·∫øt ƒë·ªãnh tr√πng l·∫∑p' : 'Awaiting duplicate resolution',
                      duplicateInfo: result.duplicate_info
                    }
                  : upload
              ));
              
              // Add to duplicate queue (will show modal if none is currently shown)
              addToduplicateQueue({
                fileData: file,
                analysisResult: result.analysis,
                duplicateInfo: result.duplicate_info,
                shipId: selectedShip?.id,
                fileIndex: i,
                fileName: file.name
              });
              
              // Pause the upload process - don't resolve the promise yet
              return; // Don't resolve, wait for user decision
              
            } else if (result && result.status === 'requires_manual_input') {
              // AI extraction failed - pause upload for manual input
              const progressMessage = result?.progress_message || (language === 'vi' ? 'AI kh√¥ng th·ªÉ tr√≠ch xu·∫•t ƒë·ªß th√¥ng tin - C·∫ßn nh·∫≠p th·ªß c√¥ng' : 'AI extraction insufficient - Manual input required');
              
              setMultiCertUploads(prev => prev.map((upload, idx) => 
                idx === i 
                  ? {
                      ...upload,
                      status: 'requires_manual_input',
                      progress: 100,
                      stage: progressMessage,
                      analysis: result.analysis,
                      extraction_quality: result.extraction_quality,
                      manual_input_reason: result.manual_input_reason,
                      manual_input_data: result.manual_input_data,
                      requires_manual_input: true,
                      progress_message: progressMessage
                    }
                  : upload
              ));
              
              // Don't show toast - let progress bar display the message
              resolve({ status: 'requires_manual_input', file: file.name, reason: result.manual_input_reason });
              
            } else if (result && result.status === 'requires_manual_review') {
              // File requires manual review - add to pending reviews
              const reviewData = {
                temp_file_id: result.temp_file_id,
                filename: result.filename,
                file_content_b64: result.file_content_b64,
                content_type: result.content_type,
                detected_category: result.detected_category,
                confidence: result.confidence,
                analysis: result.analysis,
                file_size: result.file_size,
                manual_override_options: result.manual_override_options,
                upload_index: i
              };
              
              setPendingManualReviews(prev => [...prev, reviewData]);
              
              setMultiCertUploads(prev => prev.map((upload, idx) => 
                idx === i 
                  ? {
                      ...upload,
                      status: 'requires_manual_review',
                      progress: 100,
                      stage: language === 'vi' ? 'C·∫ßn xem x√©t th·ªß c√¥ng' : 'Requires Manual Review',
                      analysis: result.analysis,
                      detected_category: result.detected_category,
                      confidence: result.confidence,
                      requires_user_action: true,
                      manual_override_options: result.manual_override_options
                    }
                  : upload
              ));
              
              // Show manual review notification
              toast.warning(language === 'vi' 
                ? `‚ö†Ô∏è C·∫ßn xem x√©t: ${file.name} - H·ªá th·ªëng ph√¢n lo·∫°i: ${result.detected_category}`
                : `‚ö†Ô∏è Manual review needed: ${file.name} - System classified as: ${result.detected_category}`
              );
              
              resolve({ status: 'manual_review', file: file.name });
              
            } else {
              const errorMsg = result?.error || result?.message || 'Unknown error';
              const progressMessage = result?.progress_message || errorMsg;
              
              setMultiCertUploads(prev => prev.map((upload, idx) => 
                idx === i 
                  ? {
                      ...upload,
                      status: 'error',
                      progress: 100,
                      stage: progressMessage, // Use progress_message from backend for display
                      error: errorMsg,
                      progress_message: progressMessage // Store progress message
                    }
                  : upload
              ));
              
              // Don't show toast for progress messages, let progress bar display it
              // Only show toast for unexpected errors without progress_message
              if (!result?.progress_message) {
                toast.error(language === 'vi' 
                  ? `‚ùå L·ªói upload: ${file.name} - ${errorMsg}`
                  : `‚ùå Upload error: ${file.name} - ${errorMsg}`
                );
              }
              
              resolve({ status: 'error', file: file.name, error: errorMsg });
            }
            
          } catch (fileError) {
            console.error(`Error uploading file ${file.name}:`, fileError);
            
            setMultiCertUploads(prev => prev.map((upload, idx) => 
              idx === i 
                ? {
                    ...upload,
                    status: 'error',
                    progress: 100,
                    stage: language === 'vi' ? 'L·ªói upload' : 'Upload error',
                    error: fileError.response?.data?.detail || fileError.message
                  }
                : upload
            ));
            
            toast.error(language === 'vi' 
              ? `‚ùå L·ªói upload: ${file.name}`
              : `‚ùå Upload error: ${file.name}`
            );
            
            resolve({ status: 'error', file: file.name, error: fileError.message });
          }
        });
        
        uploadPromises.push(uploadPromise);
      }
      
      // Wait for all uploads to complete
      const results = await Promise.all(uploadPromises);
      
      // Count results
      successCount = results.filter(r => r.status === 'success').length;
      errorCount = results.filter(r => r.status === 'error').length;
      const manualReviewCount = results.filter(r => r.status === 'manual_review').length;
      
      // Show final summary
      const finalSummary = {
        total_files: totalFiles,
        successful_uploads: successCount,
        failed_uploads: errorCount,
        manual_review_count: manualReviewCount,
        processing_time: `${totalFiles} files uploaded concurrently with 0.5s staggered start`
      };
      
      setUploadSummary(finalSummary);
      
      // Final success/error toast
      if (successCount > 0 && errorCount === 0 && manualReviewCount === 0) {
        toast.success(language === 'vi' 
          ? `üéâ T·∫•t c·∫£ ${successCount} files ƒë√£ ƒë∆∞·ª£c upload th√†nh c√¥ng!`
          : `üéâ All ${successCount} files uploaded successfully!`
        );
      } else if (successCount > 0 && (errorCount > 0 || manualReviewCount > 0)) {
        const reviewText = manualReviewCount > 0 ? 
          (language === 'vi' ? `, ${manualReviewCount} c·∫ßn xem x√©t` : `, ${manualReviewCount} need review`) : '';
        toast.warning(language === 'vi' 
          ? `‚ö†Ô∏è Upload ho√†n th√†nh: ${successCount} th√†nh c√¥ng, ${errorCount} l·ªói${reviewText}`
          : `‚ö†Ô∏è Upload completed: ${successCount} successful, ${errorCount} errors${reviewText}`
        );
      } else {
        toast.error(language === 'vi' 
          ? `‚ùå Upload th·∫•t b·∫°i: ${errorCount} files l·ªói`
          : `‚ùå Upload failed: ${errorCount} files with errors`
        );
      }
      
      // Refresh certificates if any were successfully uploaded
      if (successCount > 0) {
        await fetchCertificates(selectedShip.id);
      }
      
    } catch (error) {
      console.error('Multi cert upload error:', error);
      toast.error(
        language === 'vi'
          ? `‚ùå L·ªói x·ª≠ l√Ω: ${error.response?.data?.detail || error.message}`
          : `‚ùå Processing error: ${error.response?.data?.detail || error.message}`
      );
      
      // Update all pending/uploading files to error status
      setMultiCertUploads(prev => prev.map(upload => 
        upload.status === 'pending' || upload.status === 'uploading'
          ? {
              ...upload,
              status: 'error',
              progress: 100,
              stage: language === 'vi' ? 'L·ªói x·ª≠ l√Ω batch' : 'Batch processing error',
              error: error.response?.data?.detail || error.message
            }
          : upload
      ));
    } finally {
      setIsMultiCertProcessing(false);
    }
  };

  // Handle upload file to specific folder (for non-certificate files)
  const handleUploadToFolder = async (filename, folderCategory) => {
    if (!selectedShip?.id) {
      toast.error('No ship selected');
      return;
    }
    
    try {
      // Find the original file from multiCertUploads
      const fileUpload = multiCertUploads.find(upload => upload.filename === filename);
      if (!fileUpload) {
        toast.error('File not found');
        return;
      }
      
      // Find the original file from the files array (we need to store this)
      toast.info(
        language === 'vi' 
          ? `ƒêang upload ${filename} v√†o folder ${folderCategory}...`
          : `Uploading ${filename} to ${folderCategory} folder...`
      );
      
      // For now, just mark as completed since we don't have the original file reference
      // This would need to be implemented with proper file storage
      setMultiCertUploads(prev => prev.map(upload => 
        upload.filename === filename 
          ? { ...upload, status: 'completed', message: `Uploaded to ${folderCategory}` }
          : upload
      ));
      
      toast.success(
        language === 'vi'
          ? `‚úÖ ƒê√£ upload ${filename} v√†o folder ${folderCategory}`
          : `‚úÖ Successfully uploaded ${filename} to ${folderCategory} folder`
      );
    } catch (error) {
      console.error('Upload to folder error:', error);
      toast.error('Upload failed');
    }
  };
  
  // Handle skip file (for non-certificate files)
  const handleSkipFile = (filename) => {
    setMultiCertUploads(prev => prev.map(upload => 
      upload.filename === filename 
        ? { ...upload, status: 'skipped', message: 'Skipped by user' }
        : upload
    ));
    
    toast.info(
      language === 'vi'
        ? `File ${filename} ƒë√£ ƒë∆∞·ª£c b·ªè qua`
        : `File ${filename} has been skipped`
    );
  };

  const getFilteredCertificates = () => {
    // First filter by category/submenu
    const categoryMap = {
      'certificates': 'certificates',
      'class_survey_reports': 'class_survey_reports',
      'survey_reports': 'survey_reports', 
      'test_reports': 'test_reports',
      'drawings_manuals': 'drawings_manuals',
      'other_documents': 'other_documents'
    };
    
    const targetCategory = categoryMap[selectedSubMenu] || 'certificates';
    
    const categoryFiltered = certificates.filter(cert => {
      const certCategory = cert.category || 'certificates'; // Default to certificates if no category
      return certCategory === targetCategory;
    });
    
    // Then apply existing filters (type, status, and search)
    const filtered = categoryFiltered.filter(cert => {
      const typeMatch = certificateFilters.certificateType === 'all' || 
                       cert.cert_type === certificateFilters.certificateType;
      
      // Use new status logic for filtering
      const certStatus = getCertificateStatus(cert);
      const statusMatch = certificateFilters.status === 'all' || 
                         certStatus === certificateFilters.status;
      
      // Search filter for cert_name and cert_abbreviation
      const searchTerm = certificateFilters.search.toLowerCase().trim();
      const searchMatch = !searchTerm || 
                         (cert.cert_name && cert.cert_name.toLowerCase().includes(searchTerm)) ||
                         (cert.cert_abbreviation && cert.cert_abbreviation.toLowerCase().includes(searchTerm));
      
      return typeMatch && statusMatch && searchMatch;
    });
    
    console.log(`Certificate filtering: ${certificates.length} total ‚Üí ${categoryFiltered.length} in category '${targetCategory}' ‚Üí ${filtered.length} after filters`);
    
    // Apply sorting
    return sortCertificates(filtered);
  };

  const getUniqueValues = (field) => {
    const values = certificates.map(cert => cert[field]).filter(Boolean);
    return [...new Set(values)];
  };

  const handleCategoryMouseEnter = (categoryKey) => {
    if (hoverTimeout) {
      clearTimeout(hoverTimeout);
      setHoverTimeout(null);
    }
    setHoveredCategory(categoryKey);
  };

  const handleCategoryMouseLeave = () => {
    const timeout = setTimeout(() => {
      setHoveredCategory(null);
    }, 1000); // 1 second delay
    setHoverTimeout(timeout);
  };

  const handleShipClick = (ship, categoryKey = 'documents') => {
    // Clear any hover timeout
    if (hoverTimeout) {
      clearTimeout(hoverTimeout);
      setHoverTimeout(null);
    }
    
    // Set ship details persistently
    setSelectedShip(ship);
    setSelectedCategory(categoryKey);
    setHoveredCategory(null); // Hide dropdown after selection
    
    // Set default submenu based on category
    if (categoryKey === 'documents') {
      setSelectedSubMenu('certificates');
    } else {
      const categorySubMenus = subMenuItems[categoryKey];
      if (categorySubMenus && categorySubMenus.length > 0) {
        setSelectedSubMenu(categorySubMenus[0].key);
      }
    }
  };

  // Handle category click - change category while preserving selected ship
  const handleCategoryClick = (categoryKey) => {
    console.log(`üè∑Ô∏è Category clicked: ${categoryKey}, Current ship: ${selectedShip?.name || 'None'}`);
    
    // Update category
    setSelectedCategory(categoryKey);
    setHoveredCategory(null); // Hide any open dropdown
    
    // Set default submenu based on category
    if (categoryKey === 'documents') {
      setSelectedSubMenu('certificates');
    } else {
      const categorySubMenus = subMenuItems[categoryKey];
      if (categorySubMenus && categorySubMenus.length > 0) {
        setSelectedSubMenu(categorySubMenus[0].key);
      }
    }
    
    // Special handling for Crew Records category
    if (categoryKey === 'crew') {
      // Close Certificates View if open
      setShowCertificatesView(false);
      
      // Reset all crew filters to "All"
      setCrewFilters({
        ship_sign_on: 'All',
        status: 'All',
        search: ''
      });
      
      // Reset certificate filters to "All"
      setCertFilters({
        shipSignOn: 'all',
        crewName: 'all',
        status: 'all'
      });
      
      // Auto-select first ship if no ship is currently selected
      if (!selectedShip && ships.length > 0) {
        setSelectedShip(ships[0]);
        console.log(`üö¢ Auto-selected first ship: ${ships[0].name}`);
      }
      
      console.log(`‚úÖ Crew Records category selected - Filters reset to All, Certificates View closed`);
    }
    
    // Keep selectedShip intact - this is the key improvement
    // The selected ship will be preserved and the new category will show data for this ship
    console.log(`‚úÖ Category changed to ${categoryKey}, Ship still selected: ${selectedShip?.name || 'None'}`);
  };

  const categories = [
    { key: 'documents', name: language === 'vi' ? 'H·ªì s∆° t√†i li·ªáu' : 'Class & Flag Cert', icon: 'üìÅ' },
    { key: 'crew', name: language === 'vi' ? 'Thuy·ªÅn vi√™n' : 'Crew Records', icon: 'üë•' },
    { key: 'ism', name: language === 'vi' ? 'H·ªì s∆° ISM' : 'ISM Records', icon: 'üìã' },
    { key: 'isps', name: language === 'vi' ? 'H·ªì s∆° ISPS' : 'ISPS Records', icon: 'üõ°Ô∏è' },
    { key: 'mlc', name: language === 'vi' ? 'H·ªì s∆° MLC' : 'MLC Records', icon: '‚öñÔ∏è' },
    { key: 'supplies', name: language === 'vi' ? 'V·∫≠t t∆∞' : 'Supplies', icon: 'üì¶' },
  ];

  // Function to get dynamic page title based on selected category
  const getDynamicPageTitle = () => {
    const currentCategory = categories.find(cat => cat.key === selectedCategory);
    
    // Special case for 'crew' category - display as "CREW RECORD" (singular)
    if (selectedCategory === 'crew') {
      return language === 'vi' ? 'THUY·ªÄN VI√äN' : 'CREW RECORD';
    }
    
    // For other categories, transform to uppercase
    if (currentCategory) {
      return currentCategory.name.toUpperCase();
    }
    
    // Fallback to default
    return language === 'vi' ? 'H·ªí S∆† T√ÄI LI·ªÜU' : 'CLASS & FLAG CERT';
  };

  // Handle multiple passport file upload
  const handleMultiplePassportUpload = (files) => {
    console.log(`üìÅ Selected ${files.length} file(s) for passport analysis`);
    
    // Validate files
    const validFiles = files.filter(file => {
      const isValidType = file.type === 'application/pdf' || file.type.startsWith('image/');
      const isValidSize = file.size <= 10 * 1024 * 1024; // 10MB
      
      if (!isValidType) {
        toast.error(language === 'vi' 
          ? `File ${file.name} kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng` 
          : `File ${file.name} has invalid format`);
        return false;
      }
      
      if (!isValidSize) {
        toast.error(language === 'vi' 
          ? `File ${file.name} qu√° l·ªõn (>10MB)` 
          : `File ${file.name} is too large (>10MB)`);
        return false;
      }
      
      return true;
    });
    
    if (validFiles.length === 0) {
      return;
    }
    
    setSelectedFiles(validFiles);
    
    if (validFiles.length === 1) {
      // Single file: use existing behavior (review before adding)
      console.log('üìÑ Single file selected - using review mode');
      handlePassportUpload(validFiles[0]);
    } else {
      // Multiple files: batch process (auto-add after each analysis)
      console.log(`üìÑüìÑ Multiple files selected (${validFiles.length}) - starting batch processing`);
      startBatchProcessing(validFiles);
    }
  };

  // Start batch processing for multiple files (Parallel with Staggered Start)
  const startBatchProcessing = async (files) => {
    setIsBatchProcessing(true);
    setCurrentFileIndex(0);
    setBatchResults([]);
    setBatchProgress({ current: 0, total: files.length });
    
    toast.info(language === 'vi' 
      ? `B·∫Øt ƒë·∫ßu x·ª≠ l√Ω ${files.length} file h·ªô chi·∫øu (song song)...` 
      : `Starting parallel processing of ${files.length} passport files...`);
    
    console.log(`üöÄ Starting PARALLEL processing with 1s staggered delays`);
    
    // Create promises for all files with staggered start (1s delay between starts)
    const processingPromises = files.map((file, index) => {
      return new Promise(async (resolve) => {
        // Wait before starting this file (0s for first, 1s for second, 2s for third, etc.)
        const delayMs = index * 1000;
        if (delayMs > 0) {
          console.log(`‚è∞ File ${index + 1} will start in ${delayMs / 1000}s`);
          await new Promise(r => setTimeout(r, delayMs));
        }
        
        // Start processing this file
        console.log(`üîÑ Starting passport ${index + 1}/${files.length}: ${file.name}`);
        setCurrentFileIndex(index);
        
        try {
          const result = await processSinglePassportInBatch(file, index + 1, files.length);
          
          // Update progress
          setBatchResults(prev => {
            const updated = [...prev, result];
            setBatchProgress({ current: updated.length, total: files.length });
            return updated;
          });
          
          resolve(result);
        } catch (error) {
          console.error(`‚ùå Error processing file ${file.name}:`, error);
          const errorResult = {
            filename: file.name,
            success: false,
            error: error.message,
            index: index + 1
          };
          
          // Update progress
          setBatchResults(prev => {
            const updated = [...prev, errorResult];
            setBatchProgress({ current: updated.length, total: files.length });
            return updated;
          });
          
          resolve(errorResult);
        }
      });
    });
    
    // Wait for ALL files to complete
    console.log(`‚è≥ Waiting for all ${files.length} files to complete...`);
    const collectedResults = await Promise.all(processingPromises);
    
    // Batch processing complete
    setIsBatchProcessing(false);
    setCurrentFileIndex(0);
    
    console.log(`‚úÖ Batch passport processing complete. Results: ${collectedResults.length}`);
    console.log(`   Success: ${collectedResults.filter(r => r.success).length}`);
    console.log(`   Failed: ${collectedResults.filter(r => !r.success).length}`);
    
    // Close Add Crew Modal
    setShowAddCrewModal(false);
    
    // Show Processing Results Modal with collected results
    setProcessingResults(collectedResults);
    setShowProcessingResultsModal(true);
    
    // Refresh crew list
    if (selectedShip?.name) {
      await fetchCrewMembers(selectedShip.name);
    }
    
    // Reset states
    setSelectedFiles([]);
    setBatchResults([]);
    setBatchProgress({ current: 0, total: 0 });
  };

  // Validate if file is a passport (not seaman book or other document)
  const validatePassportDocument = (analysis) => {
    const summary = (analysis.raw_summary || '').toLowerCase();
    const fullName = (analysis.full_name || '').toLowerCase();
    const hasPassportNumber = !!analysis.passport_number;
    const hasDateOfBirth = !!analysis.date_of_birth;
    const hasNationality = !!analysis.nationality;
    
    console.log('üîç Validating document type...');
    console.log('   Summary snippet:', summary.substring(0, 200));
    console.log('   Has passport_number:', hasPassportNumber);
    console.log('   Has date_of_birth:', hasDateOfBirth);
    console.log('   Has nationality:', hasNationality);
    
    // Enhanced seaman book detection keywords
    const seamanBookKeywords = [
      'seaman book', 'seamanbook', 'seaman\'s book', 'seamans book',
      'libreta de embarque', // Spanish for Seaman's Book
      'cdc', 'continuous discharge certificate',
      'certificate of competency', 'coc',
      'endorsement', 'refrendo',
      'panama maritime authority', 'maritime authority',
      'seafarer', 'seafarers id', 'marino',
      'management level', 'master ii', // Ranks
      'capacity:', 'nivel:', 'cargo:' // Field labels in seaman books
    ];
    
    const hasSeamanBookKeyword = seamanBookKeywords.some(keyword => 
      summary.includes(keyword) || fullName.includes(keyword)
    );
    
    if (hasSeamanBookKeyword) {
      console.warn('‚ö†Ô∏è Detected Seaman Book keywords in document');
      return {
        isValid: false,
        reason: language === 'vi' 
          ? 'File n√†y l√† Seaman Book ho·∫∑c Certificate of Competency, kh√¥ng ph·∫£i Passport' 
          : 'This is a Seaman Book or Certificate of Competency, not a Passport'
      };
    }
    
    // Passport should have passport_number field
    // Note: Some seaman books might have passport-like numbers, so this isn't foolproof
    if (!hasPassportNumber) {
      console.warn('‚ö†Ô∏è Missing passport_number field');
      return {
        isValid: false,
        reason: language === 'vi'
          ? 'Kh√¥ng t√¨m th·∫•y s·ªë h·ªô chi·∫øu (Passport Number)'
          : 'Passport number not found'
      };
    }
    
    // Additional check: Passport should have basic personal info
    if (!hasDateOfBirth && !hasNationality) {
      console.warn('‚ö†Ô∏è Missing both date_of_birth and nationality');
      return {
        isValid: false,
        reason: language === 'vi'
          ? 'Thi·∫øu th√¥ng tin c∆° b·∫£n: ng√†y sinh v√† qu·ªëc t·ªãch'
          : 'Missing basic information: date of birth and nationality'
      };
    }
    
    console.log('‚úÖ Document validated as passport');
    return { isValid: true };
  };

  // Process single passport file in batch mode (auto-add crew)
  const processSinglePassportInBatch = async (file, current, total) => {
    try {
      // Set current file for UI display
      setPassportFile(file);
      
      console.log(`üîÑ Batch processing ${current}/${total}: ${file.name}`);
      
      // Analyze passport
      const formData = new FormData();
      formData.append('passport_file', file);
      formData.append('ship_name', selectedShip?.name || 'Unknown Ship');
      
      const response = await axios.post(`${API}/crew/analyze-passport`, formData, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'multipart/form-data'
        }
      });
      
      if (response.data.success && response.data.analysis) {
        const analysis = response.data.analysis;
        
        // ‚úÖ Validate if document is a passport
        const validation = validatePassportDocument(analysis);
        if (!validation.isValid) {
          console.warn(`‚ö†Ô∏è File ${file.name} is not a valid passport: ${validation.reason}`);
          return {
            filename: file.name,
            success: false,
            crewCreated: false,
            fileUploaded: false,
            summaryCreated: false,
            error: 'NOT_PASSPORT',
            validationReason: validation.reason,
            index: current
          };
        }
        
        console.log(`‚úÖ ${file.name} validated as passport document`);
        
        // Prepare crew data from analysis
        const vietnameseFullName = analysis.full_name || '';
        const vietnamesePlaceOfBirth = analysis.place_of_birth || '';
        
        // Check if we're in Standby mode from the form state
        const isStandbyMode = newCrewData.status === 'Standby';
        
        const crewData = {
          full_name: vietnameseFullName,
          full_name_en: analysis.full_name_en || autoFillEnglishField(vietnameseFullName),
          sex: analysis.sex || 'M',
          date_of_birth: analysis.date_of_birth ? convertPassportDateToInputFormat(analysis.date_of_birth) : '',
          place_of_birth: vietnamesePlaceOfBirth,
          place_of_birth_en: analysis.place_of_birth_en || autoFillEnglishField(vietnamesePlaceOfBirth),
          passport: analysis.passport_number || '',
          nationality: analysis.nationality || '',
          passport_expiry_date: analysis.passport_expiry_date ? convertPassportDateToInputFormat(analysis.passport_expiry_date) : '',
          rank: '',
          seamen_book: '',
          status: isStandbyMode ? 'Standby' : 'Sign on',
          ship_sign_on: isStandbyMode ? '-' : (selectedShip?.name || '-'),
          place_sign_on: '',
          date_sign_on: '',
          date_sign_off: ''
        };
        
        console.log(`üìã Batch processing mode: ${isStandbyMode ? 'STANDBY' : 'NORMAL'}`);
        console.log(`   Status: ${crewData.status}, Ship: ${crewData.ship_sign_on}`);
        
        console.log(`üî§ Auto-filled English fields for batch processing:`);
        console.log(`   Vietnamese Full Name: "${vietnameseFullName}" ‚Üí English: "${crewData.full_name_en}"`);
        console.log(`   Vietnamese Place of Birth: "${vietnamesePlaceOfBirth}" ‚Üí English: "${crewData.place_of_birth_en}"`);
        
        // Auto-create crew member (without file IDs yet)
        const processedData = {
          ...crewData,
          date_of_birth: crewData.date_of_birth ? convertDateInputToUTC(crewData.date_of_birth.split('T')[0]) : null,
          date_sign_on: crewData.date_sign_on ? convertDateInputToUTC(crewData.date_sign_on.split('T')[0]) : null,
          date_sign_off: crewData.date_sign_off ? convertDateInputToUTC(crewData.date_sign_off.split('T')[0]) : null,
          passport_expiry_date: crewData.passport_expiry_date ? convertDateInputToUTC(crewData.passport_expiry_date.split('T')[0]) : null
        };
        
        const createResponse = await axios.post(`${API}/crew`, processedData, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (createResponse.data && createResponse.data.id) {
          const crewId = createResponse.data.id;
          console.log(`‚úÖ Crew member created successfully: ${crewId}`);
          
          // ‚úÖ NOW upload passport files to Drive AFTER successful crew creation
          console.log(`üì§ Uploading passport files to Drive for crew ${crewId}...`);
          
          // Determine ship name based on mode
          const targetShipName = isStandbyMode ? '-' : (selectedShip?.name || '-');
          console.log(`üìÅ Target folder: ${isStandbyMode ? 'COMPANY DOCUMENT > Standby Crew' : `${targetShipName} > Crew Records`}`);
          
          let uploadedPassportId = null;
          let uploadedSummaryId = null;
          
          try {
            const uploadResponse = await axios.post(
              `${API}/crew/${crewId}/upload-passport-files`,
              {
                file_content: analysis._file_content,
                filename: analysis._filename,
                content_type: analysis._content_type,
                summary_text: analysis._summary_text,
                ship_name: targetShipName
              },
              {
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
                }
              }
            );
            
            if (uploadResponse.data && uploadResponse.data.success) {
              uploadedPassportId = uploadResponse.data.passport_file_id;
              uploadedSummaryId = uploadResponse.data.summary_file_id;
              console.log(`‚úÖ Passport files uploaded successfully to Drive`);
              console.log(`   üìé Passport File ID: ${uploadedPassportId}`);
              console.log(`   üìã Summary File ID: ${uploadedSummaryId}`);
            } else {
              console.warn(`‚ö†Ô∏è Passport file upload failed but crew was saved: ${uploadResponse.data?.message}`);
            }
          } catch (uploadError) {
            console.error(`‚ùå Passport file upload failed (crew still saved):`, uploadError);
            // Don't throw - crew is already saved, upload failure is not critical
          }
          
          return {
            filename: file.name,
            success: true,
            recordCreated: true,
            fileUploaded: !!uploadedPassportId,
            filePath: uploadedPassportId 
              ? (isStandbyMode ? `COMPANY DOCUMENT/Standby Crew/${file.name}` : `${selectedShip?.name}/Crew Records/${file.name}`) 
              : 'N/A',
            summaryCreated: !!uploadedSummaryId,
            isDuplicate: false,
            crewName: analysis.full_name || 'Unknown',
            passport: analysis.passport_number || 'No passport',
            ship: targetShipName,
            index: current
          };
        } else {
          throw new Error('Failed to create crew member');
        }
        
      } else if (response.data.duplicate || response.data.error === 'DUPLICATE_PASSPORT') {
        // Handle duplicate passport
        console.log('üîç Duplicate detected, response data:', response.data);
        const existingCrew = response.data.existing_crew || {};
        console.log('üîç Existing crew info:', existingCrew);
        
        const result = {
          filename: file.name,
          success: false,
          recordCreated: false,
          fileUploaded: false,
          filePath: 'Not uploaded (duplicate)',
          summaryCreated: false,
          isDuplicate: true,
          duplicateWith: existingCrew.full_name || 'Unknown',
          duplicateShip: existingCrew.ship_sign_on || 'Unknown',
          passport: existingCrew.passport || 'Unknown',
          error: response.data.message || 'Duplicate passport',
          index: current
        };
        
        console.log('üîç Returning duplicate result:', result);
        return result;
      } else {
        throw new Error(response.data.message || 'Analysis failed');
      }
      
    } catch (error) {
      console.error(`‚ùå Batch processing error for ${file.name}:`, error);
      
      // Check if it's a duplicate error from backend
      const isDuplicate = error.response?.status === 400 && 
                         error.response?.data?.detail?.includes('Duplicate passport');
      
      return {
        filename: file.name,
        success: false,
        recordCreated: false,
        fileUploaded: false,
        filePath: 'N/A',
        summaryCreated: false,
        isDuplicate: isDuplicate,
        duplicateWith: isDuplicate ? 'Unknown' : '',
        duplicateShip: isDuplicate ? 'Unknown' : '',
        error: error.response?.data?.detail || error.message || 'Unknown error',
        index: current
      };
    }
  };
  // Handle passport file upload and analysis (single file mode)
  const handlePassportUpload = async (file) => {
    if (!file) return;
    
    // Reset previous analysis state
    setPassportAnalysis(null);
    setPassportFile(null);
    setIsAnalyzingPassport(true);
    setPassportError('');
    
    console.log('üîÑ Starting fresh passport analysis for:', file.name);
    
    try {
      // Create FormData for file upload
      const formData = new FormData();
      formData.append('passport_file', file);
      
      const shipName = selectedShip?.name || 'UNKNOWN';
      console.log('Selected ship for passport upload:', selectedShip, 'Ship name:', shipName);
      formData.append('ship_name', shipName);
      
      // Call backend API to analyze passport with Google Document AI
      const response = await axios.post(`${API}/crew/analyze-passport`, formData, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'multipart/form-data'
        }
      });
      
      if (response.data.success) {
        const analysis = response.data.analysis;
        console.log('üîç DEBUGGING AUTO-FILL:');
        console.log('   Full response:', response.data);
        console.log('   Analysis object:', analysis);
        console.log('   Analysis keys:', Object.keys(analysis || {}));
        
        if (!analysis || Object.keys(analysis).length === 0) {
          console.error('‚ùå Analysis object is empty or null!');
          toast.error(language === 'vi' 
            ? 'Ph√¢n t√≠ch th√†nh c√¥ng nh∆∞ng kh√¥ng tr√≠ch xu·∫•t ƒë∆∞·ª£c th√¥ng tin t·ª´ h·ªô chi·∫øu'
            : 'Analysis successful but no information extracted from passport'
          );
          return;
        }
        
        // ‚úÖ Validate if document is a passport
        const validation = validatePassportDocument(analysis);
        if (!validation.isValid) {
          console.warn(`‚ö†Ô∏è File ${file.name} is not a valid passport: ${validation.reason}`);
          setPassportError(validation.reason);
          toast.error(validation.reason);
          setIsAnalyzingPassport(false);
          return; // Stop processing
        }
        
        console.log(`‚úÖ ${file.name} validated as passport document`);
        
        // Log individual field extractions
        console.log('   üìÑ Extracting fields:');
        console.log('     full_name:', analysis.full_name);
        console.log('     sex:', analysis.sex); 
        console.log('     date_of_birth:', analysis.date_of_birth);
        console.log('     place_of_birth:', analysis.place_of_birth);
        console.log('     passport_number:', analysis.passport_number);
        
        // Convert date if needed
        let convertedDate = '';
        if (analysis.date_of_birth) {
          convertedDate = convertPassportDateToInputFormat(analysis.date_of_birth);
          console.log('     date converted:', analysis.date_of_birth, '‚Üí', convertedDate);
        }
        
        // Reset and populate crew data with NEW passport analysis
        const newData = {
          // Keep non-passport fields but reset all passport-related fields
          rank: newCrewData.rank,
          seamen_book: newCrewData.seamen_book,
          status: newCrewData.status,
          ship_sign_on: newCrewData.ship_sign_on,
          date_sign_on: newCrewData.date_sign_on,
          date_sign_off: newCrewData.date_sign_off,
          // Fill with NEW analysis data
          full_name: analysis.full_name || '',
          full_name_en: autoFillEnglishField(analysis.full_name || ''),
          sex: analysis.sex || 'M',
          date_of_birth: convertedDate,
          place_of_birth: analysis.place_of_birth || '',
          place_of_birth_en: autoFillEnglishField(analysis.place_of_birth || ''),
          passport: analysis.passport_number || '',
          nationality: analysis.nationality || '',
          passport_expiry_date: analysis.passport_expiry_date ? convertPassportDateToInputFormat(analysis.passport_expiry_date) : ''
        };
        
        console.log('   üìã Setting new crew data:', newData);
        setNewCrewData(newData);
        
        // ‚úÖ Store analysis with file content for later upload (after crew creation)
        const analysisWithFiles = {
          ...analysis,
          _file_content: analysis._file_content,  // base64 file content
          _filename: analysis._filename,
          _content_type: analysis._content_type,
          _summary_text: analysis._summary_text,
          _ship_name: analysis._ship_name
        };
        
        setPassportAnalysis(analysisWithFiles);
        setPassportFile(file);
        
        toast.success(language === 'vi' 
          ? 'Ph√¢n t√≠ch h·ªô chi·∫øu th√†nh c√¥ng! Th√¥ng tin ƒë√£ ƒë∆∞·ª£c ƒëi·ªÅn t·ª± ƒë·ªông.'
          : 'Passport analysis successful! Information has been auto-filled.'
        );
      } else {
        throw new Error(response.data.message || 'Passport analysis failed');
      }
    } catch (error) {
      console.error('Passport analysis error:', error);
      console.error('Error response:', error.response);
      console.error('Error status:', error.response?.status);
      console.error('Error data:', error.response?.data);
      
      setPassportError(error.response?.data?.detail || error.response?.data?.message || error.message || 'Passport analysis failed');
      toast.error(language === 'vi' 
        ? `L·ªói ph√¢n t√≠ch h·ªô chi·∫øu: ${error.response?.data?.detail || error.message}`
        : `Passport analysis error: ${error.response?.data?.detail || error.message}`
      );
    } finally {
      setIsAnalyzingPassport(false);
    }
  };

  // ===========================================
  // CREW MANAGEMENT FUNCTIONS
  // ===========================================

  // Handle crew data submission
  const handleAddCrewSubmit = async () => {
    setIsSubmittingCrew(true);
    
    try {
      // Validate required fields
      if (!newCrewData.full_name || !newCrewData.date_of_birth || !newCrewData.place_of_birth || !newCrewData.passport) {
        toast.error(language === 'vi' ? 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc!' : 'Please fill in all required fields!');
        return;
      }
      
      // Process dates using Certificate approach to avoid timezone shift
      const processedData = {
        ...newCrewData,
        date_of_birth: newCrewData.date_of_birth ? convertDateInputToUTC(newCrewData.date_of_birth.split('T')[0]) : null,
        date_sign_on: newCrewData.date_sign_on ? convertDateInputToUTC(newCrewData.date_sign_on.split('T')[0]) : null,
        date_sign_off: newCrewData.date_sign_off ? convertDateInputToUTC(newCrewData.date_sign_off.split('T')[0]) : null,
        passport_expiry_date: newCrewData.passport_expiry_date ? convertDateInputToUTC(newCrewData.passport_expiry_date.split('T')[0]) : null
      };
      
      // ‚úÖ Do NOT include file IDs - files will be uploaded AFTER crew creation
      
      // Call backend API to create crew member
      const response = await axios.post(`${API}/crew`, processedData, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      if (response.data) {
        const crewId = response.data.id;
        console.log(`‚úÖ Crew member created successfully: ${crewId}`);
        
        // ‚úÖ Upload passport files to Drive AFTER successful crew creation
        if (passportAnalysis?._file_content) {
          console.log(`üì§ Uploading passport files to Drive for crew ${crewId}...`);
          
          try {
            const uploadResponse = await axios.post(
              `${API}/crew/${crewId}/upload-passport-files`,
              {
                file_content: passportAnalysis._file_content,
                filename: passportAnalysis._filename,
                content_type: passportAnalysis._content_type,
                summary_text: passportAnalysis._summary_text,
                ship_name: passportAnalysis._ship_name || selectedShip?.name || '-'
              },
              {
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
                }
              }
            );
            
            if (uploadResponse.data && uploadResponse.data.success) {
              console.log(`‚úÖ Passport files uploaded successfully to Drive`);
              console.log(`   üìé Passport File ID: ${uploadResponse.data.passport_file_id}`);
              console.log(`   üìã Summary File ID: ${uploadResponse.data.summary_file_id}`);
            } else {
              console.warn(`‚ö†Ô∏è Passport file upload failed but crew was saved`);
              toast.warning(language === 'vi' 
                ? 'Th√™m thuy·ªÅn vi√™n th√†nh c√¥ng nh∆∞ng kh√¥ng th·ªÉ upload file l√™n Drive'
                : 'Crew added successfully but file upload to Drive failed');
            }
          } catch (uploadError) {
            console.error(`‚ùå Passport file upload failed (crew still saved):`, uploadError);
            toast.warning(language === 'vi' 
              ? 'Th√™m thuy·ªÅn vi√™n th√†nh c√¥ng nh∆∞ng kh√¥ng th·ªÉ upload file l√™n Drive'
              : 'Crew added successfully but file upload to Drive failed');
            // Don't throw - crew is already saved, upload failure is not critical
          }
        }
        
        toast.success(language === 'vi' ? 'Thuy·ªÅn vi√™n ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng!' : 'Crew member added successfully!');
        
        // ‚úÖ AUTO-MOVE FILES TO STANDBY FOLDER if new crew has status "Standby"
        const crewStatus = newCrewData.status ? newCrewData.status.toLowerCase() : '';
        if (crewStatus === 'standby') {
          console.log(`üéØ New crew ${newCrewData.full_name} has Standby status, auto-moving files...`);
          // Call moveStandbyCrewFiles in background (don't await - let it run async)
          moveStandbyCrewFiles([crewId], newCrewData.full_name);
        }
        
        // Refresh crew list FIRST
        console.log('üîÑ Refreshing crew list after adding new crew...');
        try {
          if (selectedShip?.name) {
            await fetchCrewMembers(selectedShip.name);
          } else {
            await fetchCrewMembers();
          }
          console.log('‚úÖ Crew list refreshed successfully after adding crew');
        } catch (refreshError) {
          console.error('Failed to refresh crew list after adding:', refreshError);
          toast.warning(language === 'vi' 
            ? 'Th√™m th√†nh c√¥ng nh∆∞ng kh√¥ng th·ªÉ t·∫£i l·∫°i danh s√°ch' 
            : 'Added successfully but failed to refresh list');
        }
        
        // Then reset form and close modal
        resetAddCrewForm();
        setShowAddCrewModal(false);
      }
      
    } catch (error) {
      console.error('Error adding crew member:', error);
      
      if (error.response?.status === 400 && error.response?.data?.detail?.includes('already exists')) {
        toast.error(language === 'vi' 
          ? 'S·ªë h·ªô chi·∫øu n√†y ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng!'
          : 'This passport number already exists in the system!'
        );
      } else {
        toast.error(language === 'vi' 
          ? `L·ªói khi th√™m thuy·ªÅn vi√™n: ${error.response?.data?.detail || error.message}`
          : `Error adding crew member: ${error.response?.data?.detail || error.message}`
        );
      }
    } finally {
      setIsSubmittingCrew(false);
    }
  };

  // Fetch crew members from backend
  const fetchCrewMembers = async (shipFilter = null, statusFilter = null) => {
    console.log('üîÑ fetchCrewMembers called:', { shipFilter, statusFilter });
    
    try {
      let url = `${API}/crew`;
      const params = new URLSearchParams();
      
      if (shipFilter && shipFilter !== 'All') {
        params.append('ship_name', shipFilter);
      }
      
      if (statusFilter && statusFilter !== 'All') {
        params.append('status', statusFilter);
      }
      
      if (params.toString()) {
        url += `?${params.toString()}`;
      }
      
      console.log('üì° Fetching crew from:', url);
      
      const response = await axios.get(url, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      console.log('‚úÖ Crew members fetched:', response.data?.length || 0, 'crew');
      
      if (response.data) {
        setCrewList(response.data);
      }
      
    } catch (error) {
      console.error('‚ùå Error fetching crew members:', error);
      toast.error(language === 'vi' 
        ? 'L·ªói khi t·∫£i danh s√°ch thuy·ªÅn vi√™n'
        : 'Error loading crew members'
      );
    }
  };

  // ============================================
  // CREW CERTIFICATES FUNCTIONS (Steps 6-7)
  // ============================================
  
  // Fetch crew certificates for current ship
  // Get ship/status for certificate (based on crew's ship_sign_on)
  const getCertificateShipStatus = (cert) => {
    // Try to find crew member from cert.crew_id
    if (cert.crew_id && crewList) {
      const crew = crewList.find(c => c.id === cert.crew_id);
      if (crew) {
        const shipSignOn = crew.ship_sign_on || '-';
        if (shipSignOn === '-') {
          return { ship: 'Standby Crew', isStandby: true };
        } else {
          return { ship: shipSignOn, isStandby: false };
        }
      }
    }
    
    // Fallback: check cert.ship_id
    if (!cert.ship_id || cert.ship_id === 'null') {
      return { ship: 'Standby Crew', isStandby: true };
    }
    
    // Try to find ship by ship_id
    if (ships) {
      const ship = ships.find(s => s.id === cert.ship_id);
      if (ship) {
        return { ship: ship.name, isStandby: false };
      }
    }
    
    return { ship: 'Unknown', isStandby: false };
  };

  const fetchCrewCertificates = async (crewId = null) => {
    try {
      // Use new endpoint that gets ALL certificates (no ship filter)
      let url = `${API}/crew-certificates/all`;
      
      // Add crew_id filter if specified
      if (crewId) {
        url += `?crew_id=${crewId}`;
      }
      
      console.log(`üìã Fetching all crew certificates (company-wide)...`);
      
      const response = await axios.get(url, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (response.data) {
        setCrewCertificates(response.data);
        console.log(`‚úÖ Loaded ${response.data.length} crew certificates (including Standby)`);
      }
      
    } catch (error) {
      console.error('Error fetching crew certificates:', error);
      toast.error(language === 'vi' 
        ? 'L·ªói khi t·∫£i danh s√°ch ch·ª©ng ch·ªâ'
        : 'Error loading certificates'
      );
    }
  };

  // Handle double-click on crew name to show certificates
  const handleCrewNameDoubleClick = (crew) => {
    console.log(`üîÄ Switching to certificates view for crew: ${crew.full_name}`);
    console.log(`üö¢ Crew's ship sign on: ${crew.ship_sign_on}`);
    
    // No longer need to set selectedShip - we fetch all certificates now
    setSelectedCrewForCertificates(crew);
    setShowCertificatesView(true);
    
    // Fetch ALL certificates (not filtered by ship)
    fetchCrewCertificates(null);  // null = fetch all certificates
    
    // Set filter to show this crew's certificates by default
    setCertFilters({ shipSignOn: 'all', status: 'all', crewName: crew.full_name });
  };

  // Handle back button to return to crew list
  const handleBackToCrewList = () => {
    console.log('üîô Returning to crew list view');
    setShowCertificatesView(false);
    setSelectedCrewForCertificates(null);
    setCrewCertificates([]);
    setCertificatesSearch('');
    setCertFilters({ shipSignOn: 'all', status: 'all', crewName: 'all' });
    setCertificateSort({ column: null, direction: 'asc' });
  };


  // ============================================
  // ADD CREW CERTIFICATE HANDLERS (Step 10)
  // ============================================
  
  const handleOpenAddCrewCertModal = () => {
    console.log('üîµ handleOpenAddCrewCertModal called');
    console.log('üîç certFilters.crewName:', certFilters.crewName);
    console.log('üë• crewList:', crewList);
    
    // Priority 1: Pre-fill from filtered crew (when crew filter is not 'all')
    if (certFilters.crewName && certFilters.crewName !== 'all' && crewList && crewList.length > 0) {
      const filteredCrew = crewList.find(crew => crew.full_name === certFilters.crewName);
      
      if (filteredCrew) {
        console.log('‚úÖ Priority 1: Found filtered crew:', filteredCrew);
        setSelectedCrewForCert(filteredCrew);
        setNewCrewCertificate({
          crew_id: filteredCrew.id,
          crew_name: filteredCrew.full_name,
          crew_name_en: filteredCrew.full_name_en || '',
          passport: filteredCrew.passport,
          rank: filteredCrew.rank || '',
          date_of_birth: filteredCrew.date_of_birth ? filteredCrew.date_of_birth.split('T')[0] : '',
          cert_name: '',
          cert_no: '',
          issued_by: '',
          issued_date: '',
          cert_expiry: '',
          note: '',
          crew_cert_file_id: '',
          crew_cert_summary_file_id: ''
        });
      } else {
        console.log('‚ö†Ô∏è Filtered crew not found in crewList');
        setSelectedCrewForCert(null);
        resetAddCrewCertForm();
      }
    }
    // Priority 2: Show dropdown for crew selection (no specific crew selected)
    else {
      console.log('‚úÖ Priority 2: No crew pre-selected, show dropdown');
      setSelectedCrewForCert(null);
      resetAddCrewCertForm();
    }
    
    console.log('‚úÖ Setting showAddCrewCertModal to true');
    setShowAddCrewCertModal(true);
    
    // Force check after state update
    setTimeout(() => {
      console.log('‚è∞ State after 100ms:', showAddCrewCertModal);
    }, 100);
  };

  // Handle crew selection from dropdown in Add Crew Certificate modal
  const handleCrewSelectionInCertModal = (crewId) => {
    console.log('üîç Crew selected in modal:', crewId);
    
    if (!crewId) {
      // Reset if empty selection
      setSelectedCrewForCert(null);
      resetAddCrewCertForm();
      return;
    }
    
    // Find crew in crewList
    const selectedCrew = crewList.find(crew => crew.id === crewId);
    
    if (selectedCrew) {
      console.log('‚úÖ Found crew:', selectedCrew);
      console.log('   - date_of_birth from crew:', selectedCrew.date_of_birth);
      setSelectedCrewForCert(selectedCrew);
      
      // Auto-fill crew information
      const dateOfBirth = selectedCrew.date_of_birth ? selectedCrew.date_of_birth.split('T')[0] : '';
      console.log('   - date_of_birth after split:', dateOfBirth);
      
      setNewCrewCertificate(prev => ({
        ...prev,
        crew_id: selectedCrew.id,
        crew_name: selectedCrew.full_name,
        crew_name_en: selectedCrew.full_name_en || '',
        passport: selectedCrew.passport,
        rank: selectedCrew.rank || '',
        date_of_birth: dateOfBirth
      }));
      
      console.log('   - newCrewCertificate updated with date_of_birth:', dateOfBirth);
      
      // Debug: log state after a short delay to see if it's actually set
      setTimeout(() => {
        console.log('   - Checking state after 100ms...');
        // This will be captured in closure, so we need to check in render or use a different approach
      }, 100);
    } else {
      console.log('‚ö†Ô∏è Crew not found');
    }
  };

  const resetAddCrewCertForm = () => {
    setNewCrewCertificate({
      crew_id: '',
      crew_name: '',
      crew_name_en: '',  // Reset English name
      passport: '',
      rank: '',  // Reset rank
      date_of_birth: '',  // Reset date of birth
      cert_name: '',
      cert_no: '',
      issued_by: '',
      issued_date: '',
      cert_expiry: '',
      note: '',
      crew_cert_file_id: '',
      crew_cert_summary_file_id: ''  // Reset summary file ID
    });
  };

  const handleCloseAddCrewCertModal = () => {
    setShowAddCrewCertModal(false);
    setIsAddCrewCertModalMinimized(false);  // Reset minimize state
    setSelectedCrewForCert(null);  // Reset selected crew
    resetAddCrewCertForm();
    handleResetCertFile();  // Clear uploaded file from previous session
  };

  // Confirm add certificate despite duplicate
  const handleConfirmAddDuplicateCert = async () => {
    setShowDuplicateCertWarning(false);
    setIsSubmittingCert(true);

    try {
      console.log('‚úÖ User confirmed: Adding duplicate certificate');
      
      // API call WITHOUT ship_id parameter - backend determines folder from crew's ship_sign_on
      const response = await axios.post(
        `${API}/crew-certificates/manual`,
        newCrewCertificate,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }
      );

      if (response.data) {
        console.log('‚úÖ Duplicate certificate added successfully:', response.data);
        
        toast.success(language === 'vi' 
          ? '‚úÖ ƒê√£ th√™m ch·ª©ng ch·ªâ thuy·ªÅn vi√™n th√†nh c√¥ng!' 
          : '‚úÖ Crew certificate added successfully!'
        );

        handleCloseAddCrewCertModal();
        
        if (selectedCrewForCert) {
          await fetchCrewCertificates(selectedCrewForCert.id);
        } else {
          await fetchCrewCertificates(null);
        }
      }
    } catch (error) {
      console.error('‚ùå Error adding duplicate certificate:', error);
      toast.error(language === 'vi' 
        ? `L·ªói: ${error.response?.data?.detail || error.message}` 
        : `Error: ${error.response?.data?.detail || error.message}`
      );
    } finally {
      setIsSubmittingCert(false);
      setDuplicateCertInfo(null);
    }
  };

  const handleAddCrewCertificateSubmit = async (e) => {
    e.preventDefault();
    
    // Validation: crew_id is now REQUIRED (replaces ship_id validation)
    if (!newCrewCertificate.crew_id) {
      toast.error(language === 'vi' 
        ? 'Vui l√≤ng ch·ªçn thuy·ªÅn vi√™n tr∆∞·ªõc khi th√™m ch·ª©ng ch·ªâ.' 
        : 'Please select a crew member before adding certificate.'
      );
      return;
    }

    // Validation: Required fields
    if (!newCrewCertificate.crew_name || !newCrewCertificate.passport || !newCrewCertificate.date_of_birth || !newCrewCertificate.cert_name || !newCrewCertificate.cert_no) {
      toast.error(language === 'vi' 
        ? 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc' 
        : 'Please fill in all required fields'
      );
      return;
    }

    setIsSubmittingCert(true);

    try {
      console.log('üì§ Submitting new crew certificate:', newCrewCertificate);
      console.log('üë§ Crew ID:', newCrewCertificate.crew_id);
      console.log('üìç Ship/Folder will be determined by backend based on crew\'s ship_sign_on');

      // Check for duplicate before submitting
      console.log('üîç Checking for duplicate certificate...');
      const duplicateCheck = await axios.post(
        `${API}/crew-certificates/check-duplicate`,
        {
          crew_id: newCrewCertificate.crew_id,
          cert_no: newCrewCertificate.cert_no
        },
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }
      );

      if (duplicateCheck.data.is_duplicate) {
        console.warn('‚ö†Ô∏è Duplicate certificate found:', duplicateCheck.data.existing_certificate);
        setDuplicateCertInfo(duplicateCheck.data);
        setShowDuplicateCertWarning(true);
        setIsSubmittingCert(false);
        return; // Stop here, wait for user confirmation
      }

      // API call WITHOUT ship_id parameter - backend determines folder from crew's ship_sign_on
      const response = await axios.post(
        `${API}/crew-certificates/manual`,
        newCrewCertificate,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }
      );

      if (response.data) {
        const certId = response.data.id;
        console.log('‚úÖ Crew certificate created successfully:', certId);
        
        // Show success toast immediately for record creation
        toast.success(language === 'vi' 
          ? '‚úÖ ƒê√£ l∆∞u ch·ª©ng ch·ªâ th√†nh c√¥ng!' 
          : '‚úÖ Certificate saved successfully!'
        );

        // Close modal and reset form immediately
        handleCloseAddCrewCertModal();

        // Refresh certificates list immediately
        const refreshPromise = selectedCrewForCert 
          ? fetchCrewCertificates(selectedCrewForCert.id)
          : fetchCrewCertificates(null);
        
        await refreshPromise;
        
        console.log('üîç Checking certAnalysis for file upload:');
        console.log('   - certAnalysis exists:', !!certAnalysis);
        console.log('   - certAnalysis.analysis exists:', !!certAnalysis?.analysis);
        console.log('   - _file_content exists:', !!certAnalysis?.analysis?._file_content);
        console.log('   - _filename:', certAnalysis?.analysis?._filename);
        
        // ‚úÖ Upload files to Drive in BACKGROUND (non-blocking)
        if (certAnalysis?.analysis?._file_content) {
          console.log(`üì§ Starting background upload for certificate ${certId}...`);
          
          // Run upload in background without blocking
          (async () => {
            try {
              const uploadResponse = await axios.post(
                `${API}/crew-certificates/${certId}/upload-files`,
                {
                  file_content: certAnalysis.analysis._file_content,
                  filename: certAnalysis.analysis._filename,
                  content_type: certAnalysis.analysis._content_type,
                  summary_text: certAnalysis.analysis._summary_text
                },
                {
                  headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                  }
                }
              );
              
              if (uploadResponse.data && uploadResponse.data.success) {
                console.log(`‚úÖ Files uploaded successfully to Drive`);
                console.log(`   üìé Certificate File ID: ${uploadResponse.data.crew_cert_file_id}`);
                console.log(`   üìã Summary File ID: ${uploadResponse.data.crew_cert_summary_file_id}`);
                
                // Show upload success notification
                toast.success(language === 'vi' 
                  ? 'üìé File ƒë√£ upload l√™n Drive th√†nh c√¥ng!' 
                  : 'üìé File uploaded to Drive successfully!',
                  { duration: 3000 }
                );
              } else {
                console.warn(`‚ö†Ô∏è File upload failed but certificate was saved`);
                toast.warning(language === 'vi' 
                  ? '‚ö†Ô∏è File kh√¥ng th·ªÉ upload l√™n Drive (ch·ª©ng ch·ªâ ƒë√£ ƒë∆∞·ª£c l∆∞u)' 
                  : '‚ö†Ô∏è File upload to Drive failed (certificate saved)',
                  { duration: 4000 }
                );
              }
            } catch (uploadError) {
              console.error(`‚ùå File upload failed (certificate still saved):`, uploadError);
              toast.warning(language === 'vi' 
                ? '‚ö†Ô∏è File kh√¥ng th·ªÉ upload l√™n Drive (ch·ª©ng ch·ªâ ƒë√£ ƒë∆∞·ª£c l∆∞u)' 
                : '‚ö†Ô∏è File upload to Drive failed (certificate saved)',
                { duration: 4000 }
              );
            }
          })();
        }
      }

    } catch (error) {
      console.error('‚ùå Error adding crew certificate:', error);
      
      const errorMsg = error.response?.data?.detail || error.message;
      toast.error(language === 'vi' 
        ? `L·ªói khi th√™m ch·ª©ng ch·ªâ thuy·ªÅn vi√™n: ${errorMsg}` 
        : `Error adding crew certificate: ${errorMsg}`
      );
    } finally {
      setIsSubmittingCert(false);
    }
  };

  // ============================================
  // CERTIFICATE FILE UPLOAD HANDLERS (Step 11)
  // ============================================
  
  const handleCertFileUpload = async (file) => {
    console.log('üìÑ Certificate file selected:', file.name);
    
    // Reset previous states
    setCertFile(null);
    setCertAnalysis(null);
    setCertError('');

    // Validate file size (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
      setCertError(language === 'vi' 
        ? 'File qu√° l·ªõn! Vui l√≤ng ch·ªçn file nh·ªè h∆°n 10MB.' 
        : 'File too large! Please select a file smaller than 10MB.'
      );
      return;
    }

    // Validate file type
    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
    if (!allowedTypes.includes(file.type)) {
      setCertError(language === 'vi' 
        ? 'ƒê·ªãnh d·∫°ng file kh√¥ng h·ªó tr·ª£! Vui l√≤ng ch·ªçn PDF, JPG ho·∫∑c PNG.' 
        : 'Unsupported file format! Please select PDF, JPG or PNG.'
      );
      return;
    }

    setCertFile(file);
    setIsAnalyzingCert(true);

    try {
      console.log('ü§ñ Starting AI analysis for certificate...');
      console.log('üìä Context data:', {
        selectedShip,
        selectedCrewForCertificates,
        hasShipId: !!selectedShip?.id,
        hasCrewId: !!selectedCrewForCertificates?.id
      });

      // Try to get ship_id from multiple sources
      let shipId = null;
      
      // Priority 1: selectedShip
      if (selectedShip?.id) {
        shipId = selectedShip.id;
        console.log('‚úÖ Got ship ID from selectedShip:', shipId);
      }
      // Priority 2: crew's ship_id
      else if (selectedCrewForCertificates?.ship_id) {
        shipId = selectedCrewForCertificates.ship_id;
        console.log('‚úÖ Got ship ID from crew data:', shipId);
      }
      // Priority 3: crew's company_id + first ship
      else if (selectedCrewForCertificates?.company_id) {
        // Try to get from companyShips
        const firstShip = companyShips?.[0];
        if (firstShip?.id) {
          shipId = firstShip.id;
          console.log('‚úÖ Got ship ID from first company ship:', shipId);
        }
      }

      // Validate ship_id
      if (!shipId) {
        throw new Error(language === 'vi' 
          ? 'Kh√¥ng t√¨m th·∫•y th√¥ng tin t√†u. Vui l√≤ng quay l·∫°i v√† ch·ªçn t√†u.' 
          : 'Ship information not found. Please go back and select a ship.'
        );
      }

      const formData = new FormData();
      formData.append('cert_file', file);
      formData.append('ship_id', shipId);
      
      console.log('‚úÖ Using ship ID:', shipId);
      
      // Add crew_id if available (from selectedCrewForCert, not selectedCrewForCertificates)
      if (selectedCrewForCert) {
        formData.append('crew_id', selectedCrewForCert.id);
        console.log('‚úÖ Crew ID:', selectedCrewForCert.id);
      } else if (newCrewCertificate.crew_id) {
        // Fallback: use crew_id from form if selectedCrewForCert not set
        formData.append('crew_id', newCrewCertificate.crew_id);
        console.log('‚úÖ Crew ID (from form):', newCrewCertificate.crew_id);
      }

      const response = await axios.post(
        `${API}/crew-certificates/analyze-file`,
        formData,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'multipart/form-data'
          },
          timeout: 120000 // 2 minutes timeout
        }
      );

      if (response.data && response.data.success) {
        console.log('‚úÖ Certificate analysis completed:', response.data);
        
        const analysis = response.data.analysis || {};
        
        // ‚úÖ Store analysis with FILE CONTENT for later upload
        const analysisWithFiles = {
          ...response.data,
          analysis: {
            ...analysis,
            _file_content: analysis._file_content,
            _filename: analysis._filename,
            _content_type: analysis._content_type,
            _summary_text: analysis._summary_text,
            _ship_name: analysis._ship_name
          }
        };
        
        // Pre-fill form with AI extracted data
        setNewCrewCertificate(prev => ({
          ...prev,
          crew_name: response.data.crew_name || prev.crew_name,
          crew_name_en: response.data.crew_name_en || prev.crew_name_en || '',  // Include English name
          passport: response.data.passport || prev.passport,
          rank: response.data.rank || prev.rank || '',  // Include rank
          date_of_birth: response.data.date_of_birth || prev.date_of_birth || '',  // Include date of birth
          cert_name: analysis.cert_name || '',
          cert_no: analysis.cert_no || '',
          issued_by: analysis.issued_by || '',
          issued_date: analysis.issued_date || '',
          cert_expiry: analysis.expiry_date || analysis.cert_expiry || '',
          note: analysis.note || '',
          crew_cert_file_id: '',  // Will be set after upload
          crew_cert_summary_file_id: ''  // Will be set after upload
        }));

        setCertAnalysis(analysisWithFiles);
        
        toast.success(language === 'vi' 
          ? '‚úÖ Ph√¢n t√≠ch file th√†nh c√¥ng! Vui l√≤ng ki·ªÉm tra v√† x√°c nh·∫≠n th√¥ng tin.' 
          : '‚úÖ File analyzed successfully! Please review and confirm the information.'
        );
      } else {
        throw new Error('Invalid response from server');
      }

    } catch (error) {
      console.error('‚ùå Error analyzing certificate:', error);
      
      // Check if error is certificate holder mismatch
      if (error.response?.status === 400 && error.response?.data?.detail?.error === 'CERTIFICATE_HOLDER_MISMATCH') {
        const errorData = error.response.data.detail;
        const holderName = errorData.holder_name || 'Unknown';
        const crewName = errorData.crew_name || 'Unknown';
        const crewNameEn = errorData.crew_name_en || '';
        
        console.warn(`‚ö†Ô∏è Certificate holder mismatch: ${holderName} vs ${crewName}`);
        
        // Show confirmation modal instead of alert
        setCertHolderMismatchModal({
          show: true,
          holderName: holderName,
          crewName: crewName,
          crewNameEn: crewNameEn,
          file: file
        });
        
        return;
      }
      
      // Check if error is Date of Birth mismatch
      if (error.response?.status === 400 && error.response?.data?.detail?.error === 'DATE_OF_BIRTH_MISMATCH') {
        const errorData = error.response.data.detail;
        const aiExtractedDob = errorData.ai_extracted_dob || 'Unknown';
        const crewDob = errorData.crew_dob || 'Unknown';
        const crewName = errorData.crew_name || 'Unknown';
        
        console.warn(`‚ö†Ô∏è Date of Birth mismatch: AI extracted ${aiExtractedDob} vs Crew ${crewDob}`);
        
        // Show DOB mismatch modal
        setCertDobMismatchModal({
          show: true,
          aiExtractedDob: aiExtractedDob,
          crewDob: crewDob,
          crewName: crewName,
          file: file,
          analysisWithFiles: null  // Will be populated later if needed
        });
        
        return;
      }
      
      // Handle other errors
      const errorMsg = error.response?.data?.detail?.message || error.response?.data?.detail || error.message;
      setCertError(language === 'vi' 
        ? `L·ªói ph√¢n t√≠ch file: ${errorMsg}` 
        : `Error analyzing file: ${errorMsg}`
      );
      
      toast.error(language === 'vi' 
        ? `Kh√¥ng th·ªÉ ph√¢n t√≠ch file: ${errorMsg}` 
        : `Cannot analyze file: ${errorMsg}`
      );
    } finally {
      setIsAnalyzingCert(false);
    }
  };

  const handleResetCertFile = () => {
    setCertFile(null);
    setCertAnalysis(null);
    setCertError('');
    
    // Reset file input
    const fileInput = document.getElementById('cert-file-upload');
    if (fileInput) {
      fileInput.value = '';
    }
  };
  
  // Handle certificate holder mismatch modal - Skip button
  const handleCertMismatchSkip = () => {
    console.log('üö´ User chose to skip certificate upload due to name mismatch');
    
    // Close modal
    setCertHolderMismatchModal({
      show: false,
      holderName: '',
      crewName: '',
      crewNameEn: '',
      file: null
    });
    
    // Reset file input
    handleResetCertFile();
    
    toast.info(language === 'vi' 
      ? 'ƒê√£ h·ªßy upload ch·ª©ng ch·ªâ' 
      : 'Certificate upload cancelled'
    );
  };
  
  // Handle certificate holder mismatch modal - Continue button (bypass validation)
  const handleCertMismatchContinue = async () => {
    const { file } = certHolderMismatchModal;
    
    console.log('‚ö†Ô∏è User chose to continue despite name mismatch - bypassing validation');
    
    // Close modal first
    setCertHolderMismatchModal({
      show: false,
      holderName: '',
      crewName: '',
      crewNameEn: '',
      file: null
    });
    
    if (!file) {
      toast.error(language === 'vi' ? 'Kh√¥ng t√¨m th·∫•y file' : 'File not found');
      return;
    }
    
    try {
      setIsAnalyzingCert(true);
      setCertError('');
      
      if (!token) {
        throw new Error(language === 'vi' ? 'Kh√¥ng t√¨m th·∫•y token x√°c th·ª±c' : 'Authentication token not found');
      }

      // Get ship ID with validation
      const shipId = selectedShip?.id || currentShipInfo?.id;
      if (!shipId) {
        throw new Error(language === 'vi' 
          ? 'Kh√¥ng t√¨m th·∫•y th√¥ng tin t√†u. Vui l√≤ng quay l·∫°i v√† ch·ªçn t√†u.' 
          : 'Ship information not found. Please go back and select a ship.'
        );
      }

      const formData = new FormData();
      formData.append('cert_file', file);
      formData.append('ship_id', shipId);
      formData.append('bypass_validation', 'true'); // ‚úÖ KEY CHANGE: Bypass validation
      
      console.log('‚úÖ Retrying with bypass_validation=true');
      
      // Add crew_id if available
      if (selectedCrewForCert) {
        formData.append('crew_id', selectedCrewForCert.id);
        console.log('‚úÖ Crew ID:', selectedCrewForCert.id);
      } else if (newCrewCertificate.crew_id) {
        formData.append('crew_id', newCrewCertificate.crew_id);
        console.log('‚úÖ Crew ID (from form):', newCrewCertificate.crew_id);
      }

      const response = await axios.post(
        `${API}/crew-certificates/analyze-file`,
        formData,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'multipart/form-data'
          },
          timeout: 120000 // 2 minutes timeout
        }
      );

      if (response.data && response.data.success) {
        console.log('‚úÖ Certificate analysis completed (validation bypassed):', response.data);
        
        const analysis = response.data.analysis || {};
        
        console.log('üîç Debug file content in analysis:');
        console.log('   - _file_content exists:', !!analysis._file_content);
        console.log('   - _filename:', analysis._filename);
        console.log('   - _content_type:', analysis._content_type);
        
        // Store analysis with FILE CONTENT for later upload
        const analysisWithFiles = {
          ...response.data,
          analysis: {
            ...analysis,
            _file_content: analysis._file_content,
            _filename: analysis._filename,
            _content_type: analysis._content_type,
            _summary_text: analysis._summary_text,
            _ship_name: analysis._ship_name
          }
        };
        
        console.log('üîç certAnalysis being set with file content:', !!analysisWithFiles.analysis._file_content);
        
        // Pre-fill form with AI extracted data
        setNewCrewCertificate(prev => ({
          ...prev,
          crew_name: response.data.crew_name || prev.crew_name,
          crew_name_en: response.data.crew_name_en || prev.crew_name_en || '',
          passport: response.data.passport || prev.passport,
          rank: response.data.rank || prev.rank || '',
          date_of_birth: response.data.date_of_birth || prev.date_of_birth || '',  // Include date of birth
          cert_name: analysis.cert_name || '',
          cert_no: analysis.cert_no || '',
          issued_by: analysis.issued_by || '',
          issued_date: analysis.issued_date || '',
          cert_expiry: analysis.expiry_date || analysis.cert_expiry || '',
          note: analysis.note || '',
          crew_cert_file_id: '',
          crew_cert_summary_file_id: ''
        }));

        setCertAnalysis(analysisWithFiles);
        
        toast.success(language === 'vi' 
          ? '‚úÖ Ph√¢n t√≠ch file th√†nh c√¥ng (ƒë√£ b·ªè qua ki·ªÉm tra t√™n)! Vui l√≤ng ki·ªÉm tra v√† x√°c nh·∫≠n th√¥ng tin.' 
          : '‚úÖ File analyzed successfully (name validation bypassed)! Please review and confirm the information.'
        );
      } else {
        throw new Error('Invalid response from server');
      }

    } catch (error) {
      console.error('‚ùå Error analyzing certificate with bypass:', error);
      
      const errorMsg = error.response?.data?.detail?.message || error.response?.data?.detail || error.message;
      setCertError(language === 'vi' 
        ? `L·ªói ph√¢n t√≠ch file: ${errorMsg}` 
        : `Error analyzing file: ${errorMsg}`
      );
      
      toast.error(language === 'vi' 
        ? `Kh√¥ng th·ªÉ ph√¢n t√≠ch file: ${errorMsg}` 
        : `Cannot analyze file: ${errorMsg}`
      );
    } finally {
      setIsAnalyzingCert(false);
    }
  };

  // Handle Date of Birth mismatch modal - Skip button
  const handleDobMismatchSkip = () => {
    console.log('üö´ User chose to skip certificate upload due to DOB mismatch');
    
    // Close modal
    setCertDobMismatchModal({
      show: false,
      aiExtractedDob: '',
      crewDob: '',
      crewName: '',
      file: null,
      analysisWithFiles: null
    });
    
    // Reset file input
    handleResetCertFile();
    
    toast.info(language === 'vi' 
      ? 'ƒê√£ h·ªßy upload ch·ª©ng ch·ªâ' 
      : 'Certificate upload cancelled'
    );
  };
  
  // Handle Date of Birth mismatch modal - Continue button (bypass DOB validation)
  const handleDobMismatchContinue = async () => {
    const { file } = certDobMismatchModal;
    
    console.log('‚ö†Ô∏è User chose to continue despite DOB mismatch - bypassing DOB validation');
    
    // Close modal first
    setCertDobMismatchModal({
      show: false,
      aiExtractedDob: '',
      crewDob: '',
      crewName: '',
      file: null,
      analysisWithFiles: null
    });
    
    if (!file) {
      toast.error(language === 'vi' ? 'Kh√¥ng t√¨m th·∫•y file' : 'File not found');
      return;
    }
    
    try {
      setIsAnalyzingCert(true);
      setCertError('');
      
      if (!token) {
        throw new Error(language === 'vi' ? 'Kh√¥ng t√¨m th·∫•y token x√°c th·ª±c' : 'Authentication token not found');
      }

      // Get ship ID with validation
      const shipId = selectedShip?.id || currentShipInfo?.id;
      if (!shipId) {
        throw new Error(language === 'vi' 
          ? 'Kh√¥ng t√¨m th·∫•y th√¥ng tin t√†u. Vui l√≤ng quay l·∫°i v√† ch·ªçn t√†u.' 
          : 'Ship information not found. Please go back and select a ship.'
        );
      }

      const formData = new FormData();
      formData.append('cert_file', file);
      formData.append('ship_id', shipId);
      formData.append('bypass_validation', 'true'); // Bypass holder name validation (already passed)
      formData.append('bypass_dob_validation', 'true'); // ‚úÖ KEY: Bypass DOB validation
      
      console.log('‚úÖ Retrying with bypass_dob_validation=true');
      
      // Add crew_id if available
      if (selectedCrewForCert) {
        formData.append('crew_id', selectedCrewForCert.id);
        console.log('‚úÖ Crew ID:', selectedCrewForCert.id);
      } else if (newCrewCertificate.crew_id) {
        formData.append('crew_id', newCrewCertificate.crew_id);
        console.log('‚úÖ Crew ID (from form):', newCrewCertificate.crew_id);
      }

      const response = await axios.post(
        `${API}/crew-certificates/analyze-file`,
        formData,
        {
          headers: {
            'Content-Type': 'multipart/form-data',
            'Authorization': `Bearer ${token}`
          }
        }
      );

      if (response.data && response.data.success) {
        console.log('‚úÖ Certificate analysis completed (DOB validation bypassed):', response.data);
        
        const analysis = response.data.analysis || {};
        
        // Store analysis with FILE CONTENT for later upload
        const analysisWithFiles = {
          ...response.data,
          analysis: {
            ...analysis,
            _file_content: analysis._file_content,
            _filename: analysis._filename,
            _content_type: analysis._content_type,
            _summary_text: analysis._summary_text,
            _ship_name: analysis._ship_name
          }
        };
        
        // Pre-fill form with AI extracted data
        setNewCrewCertificate(prev => ({
          ...prev,
          crew_name: response.data.crew_name || prev.crew_name,
          crew_name_en: response.data.crew_name_en || prev.crew_name_en || '',
          passport: response.data.passport || prev.passport,
          rank: response.data.rank || prev.rank || '',
          date_of_birth: response.data.date_of_birth || prev.date_of_birth || '',
          cert_name: analysis.cert_name || '',
          cert_no: analysis.cert_no || '',
          issued_by: analysis.issued_by || '',
          issued_date: analysis.issued_date || '',
          expiry_date: analysis.expiry_date || '',
          note: analysis.note || ''
        }));
        
        // Set certificate analysis for later upload
        setCertAnalysis(analysisWithFiles);
        
        // Open the Add Crew Certificate modal
        setShowAddCrewCertModal(true);
        
        toast.success(language === 'vi' 
          ? 'File ƒë√£ ƒë∆∞·ª£c ph√¢n t√≠ch (ƒë√£ b·ªè qua ki·ªÉm tra ng√†y sinh)' 
          : 'File analyzed successfully (DOB validation bypassed)'
        );
      } else {
        throw new Error('Invalid response from server');
      }

    } catch (error) {
      console.error('‚ùå Error analyzing certificate after DOB bypass:', error);
      
      const errorMsg = error.response?.data?.detail?.message || error.response?.data?.detail || error.message;
      setCertError(language === 'vi' 
        ? `L·ªói ph√¢n t√≠ch file: ${errorMsg}` 
        : `Error analyzing file: ${errorMsg}`
      );
      
      toast.error(language === 'vi' 
        ? `Kh√¥ng th·ªÉ ph√¢n t√≠ch file: ${errorMsg}` 
        : `Cannot analyze file: ${errorMsg}`
      );
    } finally {
      setIsAnalyzingCert(false);
    }
  };

  // Handle file upload area click with crew selection validation
  const handleCertFileAreaClick = () => {
    // Check if crew is selected (use updated validation logic)
    if (!selectedCrewForCert && certFilters.crewName === 'all') {
      toast.warning(language === 'vi' 
        ? '‚ö†Ô∏è Vui l√≤ng ch·ªçn thuy·ªÅn vi√™n tr∆∞·ªõc khi upload file!' 
        : '‚ö†Ô∏è Please select a crew member before uploading file!'
      );
      return;
    }
    
    // If crew is selected, trigger file input using ref
    certFileInputRef.current?.click();
  };

  // Handle file drop with crew selection validation (support multiple files)
  const handleCertFileDrop = (e) => {
    e.preventDefault();
    e.currentTarget.classList.remove('border-blue-400', 'bg-blue-100');
    
    // Check if crew is selected (use updated validation logic)
    if (!selectedCrewForCert && certFilters.crewName === 'all') {
      toast.warning(language === 'vi' 
        ? '‚ö†Ô∏è Vui l√≤ng ch·ªçn thuy·ªÅn vi√™n tr∆∞·ªõc khi upload file!' 
        : '‚ö†Ô∏è Please select a crew member before uploading file!'
      );
      return;
    }
    
    // If crew is selected, process dropped files (support multiple)
    const files = Array.from(e.dataTransfer.files);
    if (files.length > 0) {
      handleMultipleCertificateUpload(files);
    }
  };

  // ============================================
  // CERTIFICATE CONTEXT MENU HANDLERS
  // ============================================
  
  const handleCertRightClick = (e, cert) => {
    e.preventDefault();
    
    // Check if user has proper role
    const allowedRoles = ['company_officer', 'manager', 'admin', 'super_admin'];
    if (!allowedRoles.includes(user?.role)) {
      return;
    }
    
    // If certificate is not selected, add it to current selection
    if (!selectedCrewCertificates.has(cert.id)) {
      const newSelected = new Set(selectedCrewCertificates);
      newSelected.add(cert.id);
      setSelectedCrewCertificates(newSelected);
    }
    
    // Calculate context menu position with viewport boundary checking
    const contextMenuWidth = 200;
    const contextMenuHeight = 250;
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    
    let x = e.clientX;
    let y = e.clientY;
    
    // Adjust position if menu would overflow viewport
    if (x + contextMenuWidth > viewportWidth) {
      x = viewportWidth - contextMenuWidth - 10;
    }
    if (y + contextMenuHeight > viewportHeight) {
      y = y - contextMenuHeight;
      if (y < 0) {
        y = viewportHeight - contextMenuHeight - 10;
      }
    }
    if (x < 0) x = 10;
    if (y < 0) y = 10;
    
    setCertContextMenu({
      show: true,
      x: x,
      y: y,
      cert: cert
    });
  };

  const handleEditCrewCertificate = async (cert) => {
    console.log('‚úèÔ∏è Editing crew certificate:', cert);
    
    // Close context menu
    setCertContextMenu({ show: false, x: 0, y: 0, cert: null });
    
    // Set editing cert
    setEditingCrewCert(cert);
    
    // If date_of_birth is missing from certificate, try to fetch from crew member
    let dateOfBirth = cert.date_of_birth ? cert.date_of_birth.split('T')[0] : '';
    
    if (!dateOfBirth && cert.crew_id) {
      console.log('‚ö†Ô∏è date_of_birth missing in certificate, fetching from crew member...');
      try {
        // Find crew member in crewList to get date_of_birth
        const crewMember = crewList.find(c => c.id === cert.crew_id);
        if (crewMember && crewMember.date_of_birth) {
          dateOfBirth = crewMember.date_of_birth.split('T')[0];
          console.log('‚úÖ Found date_of_birth from crew member:', dateOfBirth);
        }
      } catch (error) {
        console.warn('Could not fetch date_of_birth from crew member:', error);
      }
    }
    
    // Pre-fill form with certificate data
    setEditCrewCertData({
      crew_id: cert.crew_id || '',
      crew_name: cert.crew_name || '',
      crew_name_en: cert.crew_name_en || '',
      passport: cert.passport || '',
      rank: cert.rank || '',
      date_of_birth: dateOfBirth,
      cert_name: cert.cert_name || '',
      cert_no: cert.cert_no || '',
      issued_by: cert.issued_by || '',
      issued_date: cert.issued_date ? cert.issued_date.split('T')[0] : '',
      cert_expiry: cert.cert_expiry ? cert.cert_expiry.split('T')[0] : '',
      note: cert.note || ''
    });
    
    // Open edit modal
    setShowEditCrewCertModal(true);
  };

  const handleUpdateCrewCertificate = async (e) => {
    e.preventDefault();
    
    if (!editingCrewCert) return;
    
    try {
      console.log('üì§ Updating crew certificate:', editCrewCertData);
      
      const response = await axios.put(
        `${API}/crew-certificates/${editingCrewCert.id}`,
        editCrewCertData,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }
      );

      if (response.data) {
        console.log('‚úÖ Crew certificate updated successfully:', response.data);
        
        // Save custom certificate name if it's new
        addCustomCertificateName(editCrewCertData.cert_name);
        
        toast.success(language === 'vi' 
          ? '‚úÖ ƒê√£ c·∫≠p nh·∫≠t ch·ª©ng ch·ªâ thuy·ªÅn vi√™n th√†nh c√¥ng!' 
          : '‚úÖ Crew certificate updated successfully!'
        );

        // Close modal
        closeEditCrewCertModal();

        // Refresh certificates list
        await fetchCrewCertificates(null);
      }

    } catch (error) {
      console.error('‚ùå Error updating crew certificate:', error);
      
      const errorMsg = error.response?.data?.detail || error.message;
      toast.error(language === 'vi' 
        ? `L·ªói khi c·∫≠p nh·∫≠t ch·ª©ng ch·ªâ thuy·ªÅn vi√™n: ${errorMsg}` 
        : `Error updating crew certificate: ${errorMsg}`
      );
    }
  };

  const closeEditCrewCertModal = () => {
    setShowEditCrewCertModal(false);
    setEditingCrewCert(null);
    setEditCrewCertData({
      crew_id: '',
      crew_name: '',
      crew_name_en: '',
      passport: '',
      rank: '',
      date_of_birth: '',
      cert_name: '',
      cert_no: '',
      issued_by: '',
      issued_date: '',
      cert_expiry: '',
      note: ''
    });
  };

  const handleDeleteCrewCertificate = async (cert) => {
    // Close context menu
    setCertContextMenu({ show: false, x: 0, y: 0, cert: null });
    
    // Show confirmation
    const confirmed = window.confirm(
      language === 'vi' 
        ? `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch·ª©ng ch·ªâ "${cert.cert_name}" c·ªßa ${cert.crew_name}?` 
        : `Are you sure you want to delete certificate "${cert.cert_name}" for ${cert.crew_name}?`
    );
    
    if (!confirmed) return;
    
    // Show immediate processing toast
    const toastId = toast.loading(language === 'vi' 
      ? 'üóëÔ∏è ƒêang x√≥a ch·ª©ng ch·ªâ v√† files...' 
      : 'üóëÔ∏è Deleting certificate and files...'
    );
    
    // Refresh list immediately for better UX (optimistic update)
    const refreshPromise = fetchCrewCertificates(null);
    
    try {
      console.log('üóëÔ∏è Deleting crew certificate:', cert.id);
      
      // Delete in background
      const deletePromise = axios.delete(
        `${API}/crew-certificates/${cert.id}`,
        {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        }
      );
      
      // Wait for both refresh and delete
      await Promise.all([refreshPromise, deletePromise]);
      
      // Dismiss loading toast
      toast.dismiss(toastId);
      
      // Refresh again after successful delete to ensure data consistency
      console.log('üîÑ Refreshing crew certificates list after delete...');
      await fetchCrewCertificates(null);
      
      // Show success
      toast.success(language === 'vi' 
        ? '‚úÖ ƒê√£ x√≥a ch·ª©ng ch·ªâ v√† files th√†nh c√¥ng!' 
        : '‚úÖ Certificate and files deleted successfully!'
      );

    } catch (error) {
      console.error('‚ùå Error deleting crew certificate:', error);
      
      // Dismiss loading toast
      toast.dismiss(toastId);
      
      const errorMsg = error.response?.data?.detail || error.message;
      toast.error(language === 'vi' 
        ? `L·ªói khi x√≥a ch·ª©ng ch·ªâ: ${errorMsg}` 
        : `Error deleting certificate: ${errorMsg}`
      );
      
      // Refresh again to show correct state
      await fetchCrewCertificates(null);
    }
  };

  const handleViewCertFile = (cert) => {
    // Close context menu
    setCertContextMenu({ show: false, x: 0, y: 0, cert: null });
    
    if (cert.crew_cert_file_id) {
      const fileUrl = `https://drive.google.com/file/d/${cert.crew_cert_file_id}/view`;
      console.log('üìÑ Opening certificate file:', fileUrl);
      
      toast.info(language === 'vi' 
        ? 'ƒêang m·ªü file ch·ª©ng ch·ªâ...' 
        : 'Opening certificate file...'
      );
      
      window.open(fileUrl, '_blank');
    } else {
      toast.warning(language === 'vi' 
        ? 'Ch·ª©ng ch·ªâ n√†y ch∆∞a c√≥ file ƒë√≠nh k√®m' 
        : 'This certificate has no attached file'
      );
    }
  };

  const handleDownloadCertFile = async (cert) => {
    // Close context menu
    setCertContextMenu({ show: false, x: 0, y: 0, cert: null });
    
    if (cert.crew_cert_file_id) {
      const downloadUrl = `https://drive.google.com/uc?export=download&id=${cert.crew_cert_file_id}`;
      console.log('‚¨áÔ∏è Downloading certificate file:', downloadUrl);
      
      toast.info(language === 'vi' 
        ? 'ƒêang t·∫£i xu·ªëng file ch·ª©ng ch·ªâ...' 
        : 'Downloading certificate file...'
      );
      
      // Create temporary link to trigger download
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.download = `${cert.cert_name}_${cert.crew_name}.pdf`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } else {
      toast.warning(language === 'vi' 
        ? 'Ch·ª©ng ch·ªâ n√†y ch∆∞a c√≥ file ƒë√≠nh k√®m' 
        : 'This certificate has no attached file'
      );
    }
  };

  const handleCopyCertLink = (cert) => {
    // Close context menu
    setCertContextMenu({ show: false, x: 0, y: 0, cert: null });
    
    if (cert.crew_cert_file_id) {
      const fileUrl = `https://drive.google.com/file/d/${cert.crew_cert_file_id}/view`;
      navigator.clipboard.writeText(fileUrl)
        .then(() => {
          toast.success(language === 'vi' 
            ? '‚úÖ ƒê√£ sao ch√©p li√™n k·∫øt ch·ª©ng ch·ªâ!' 
            : '‚úÖ Certificate link copied to clipboard!'
          );
        })
        .catch(err => {
          console.error('Failed to copy link:', err);
          toast.error(language === 'vi' 
            ? 'L·ªói khi sao ch√©p li√™n k·∫øt' 
            : 'Error copying link'
          );
        });
    } else {
      toast.warning(language === 'vi' 
        ? 'Ch·ª©ng ch·ªâ n√†y ch∆∞a c√≥ file ƒë√≠nh k√®m' 
        : 'This certificate has no attached file'
      );
    }
  };

  // Bulk Operations for Crew Certificates
  const handleBulkDeleteCertificates = async () => {
    // Close context menu
    setCertContextMenu({ show: false, x: 0, y: 0, cert: null });
    
    if (selectedCrewCertificates.size === 0) return;
    
    // Show confirmation
    const confirmed = window.confirm(
      language === 'vi' 
        ? `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ${selectedCrewCertificates.size} ch·ª©ng ch·ªâ ƒë√£ ch·ªçn?`
        : `Are you sure you want to delete ${selectedCrewCertificates.size} selected certificate(s)?`
    );
    
    if (!confirmed) return;
    
    const certCount = selectedCrewCertificates.size;
    
    // Show immediate processing toast
    const toastId = toast.loading(language === 'vi' 
      ? `üóëÔ∏è ƒêang x√≥a ${certCount} ch·ª©ng ch·ªâ v√† files...` 
      : `üóëÔ∏è Deleting ${certCount} certificate(s) and files...`
    );
    
    // Clear selection immediately
    setSelectedCrewCertificates(new Set());
    
    // Refresh list immediately for better UX (optimistic update)
    const refreshPromise = fetchCrewCertificates(null);
    
    try {
      const certIds = Array.from(selectedCrewCertificates);
      console.log(`üóëÔ∏è Bulk deleting ${certCount} certificates`);
      console.log(`üìã Certificate IDs to delete:`, certIds);
      
      // Delete in background
      const deletePromise = axios.delete(
        `${API}/crew-certificates/bulk-delete`,
        {
          data: {
            certificate_ids: certIds
          },
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        }
      );
      
      // Wait for both refresh and delete
      const [, response] = await Promise.all([refreshPromise, deletePromise]);
      
      // Dismiss loading toast
      toast.dismiss(toastId);
      
      // Refresh again after successful delete to ensure data consistency
      console.log('üîÑ Refreshing crew certificates list after bulk delete...');
      await fetchCrewCertificates(null);

      // Check if partial success (some deleted, some failed)
      if (response.data.partial_success) {
        toast.warning(language === 'vi' 
          ? `‚ö†Ô∏è ƒê√£ x√≥a ${response.data.deleted_count} ch·ª©ng ch·ªâ, ${response.data.errors.length} l·ªói` 
          : `‚ö†Ô∏è Deleted ${response.data.deleted_count} certificate(s), ${response.data.errors.length} error(s)`
        );
      } else {
        toast.success(language === 'vi' 
          ? `‚úÖ ƒê√£ x√≥a ${response.data.deleted_count} ch·ª©ng ch·ªâ v√† files th√†nh c√¥ng!` 
          : `‚úÖ Successfully deleted ${response.data.deleted_count} certificate(s) and files!`
        );
      }

    } catch (error) {
      console.error('‚ùå Error bulk deleting certificates:', error);
      
      // Dismiss loading toast
      toast.dismiss(toastId);
      
      const errorMsg = error.response?.data?.detail || error.message;
      toast.error(language === 'vi' 
        ? `L·ªói khi x√≥a ch·ª©ng ch·ªâ: ${errorMsg}` 
        : `Error deleting certificates: ${errorMsg}`
      );
      
      // Refresh again to show correct state
      await fetchCrewCertificates(null);
    }
  };

  const handleBulkOpenInDrive = () => {
    // Close context menu
    setCertContextMenu({ show: false, x: 0, y: 0, cert: null });
    
    if (selectedCrewCertificates.size === 0) return;
    
    // Get selected certificates with file IDs (check both old and new field names)
    const certsWithFiles = crewCertificates.filter(
      cert => selectedCrewCertificates.has(cert.id) && (cert.crew_cert_file_id || cert.cert_file_id)
    );
    
    if (certsWithFiles.length === 0) {
      toast.warning(language === 'vi' 
        ? 'Kh√¥ng c√≥ ch·ª©ng ch·ªâ n√†o c√≥ file ƒë√≠nh k√®m' 
        : 'No certificates have attached files'
      );
      return;
    }
    
    // Open each file in a new tab
    certsWithFiles.forEach(cert => {
      const fileId = cert.crew_cert_file_id || cert.cert_file_id; // Backward compatible
      const fileUrl = `https://drive.google.com/file/d/${fileId}/view`;
      window.open(fileUrl, '_blank');
    });
    
    toast.success(language === 'vi' 
      ? `‚úÖ ƒê√£ m·ªü ${certsWithFiles.length} file ch·ª©ng ch·ªâ` 
      : `‚úÖ Opened ${certsWithFiles.length} certificate file(s)`
    );
  };

  const handleBulkDownloadCertificates = () => {
    // Close context menu
    setCertContextMenu({ show: false, x: 0, y: 0, cert: null });
    
    if (selectedCrewCertificates.size === 0) return;
    
    // Get selected certificates with file IDs (check both old and new field names)
    const certsWithFiles = crewCertificates.filter(
      cert => selectedCrewCertificates.has(cert.id) && (cert.crew_cert_file_id || cert.cert_file_id)
    );
    
    if (certsWithFiles.length === 0) {
      toast.warning(language === 'vi' 
        ? 'Kh√¥ng c√≥ ch·ª©ng ch·ªâ n√†o c√≥ file ƒë√≠nh k√®m' 
        : 'No certificates have attached files'
      );
      return;
    }
    
    // Download each file
    certsWithFiles.forEach((cert, index) => {
      setTimeout(() => {
        const fileId = cert.crew_cert_file_id || cert.cert_file_id; // Backward compatible
        const downloadUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = `${cert.cert_name}_${cert.crew_name}.pdf`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }, index * 500); // Stagger downloads by 500ms to avoid browser blocking
    });
    
    toast.success(language === 'vi' 
      ? `‚úÖ ƒêang t·∫£i xu·ªëng ${certsWithFiles.length} file ch·ª©ng ch·ªâ` 
      : `‚úÖ Downloading ${certsWithFiles.length} certificate file(s)`
    );
  };

  const handleBulkCopyCertLinks = () => {
    // Close context menu
    setCertContextMenu({ show: false, x: 0, y: 0, cert: null });
    
    if (selectedCrewCertificates.size === 0) return;
    
    // Get selected certificates with file IDs
    const certsWithFiles = crewCertificates.filter(
      cert => selectedCrewCertificates.has(cert.id) && cert.crew_cert_file_id
    );
    
    if (certsWithFiles.length === 0) {
      toast.warning(language === 'vi' 
        ? 'Kh√¥ng c√≥ ch·ª©ng ch·ªâ n√†o c√≥ file ƒë√≠nh k√®m' 
        : 'No certificates have attached files'
      );
      return;
    }
    
    // Create list of links with certificate names
    const links = certsWithFiles.map(cert => 
      `${cert.crew_name} - ${cert.cert_name}: https://drive.google.com/file/d/${cert.crew_cert_file_id}/view`
    ).join('\n');
    
    navigator.clipboard.writeText(links)
      .then(() => {
        toast.success(language === 'vi' 
          ? `‚úÖ ƒê√£ sao ch√©p ${certsWithFiles.length} li√™n k·∫øt ch·ª©ng ch·ªâ!` 
          : `‚úÖ Copied ${certsWithFiles.length} certificate link(s)!`
        );
      })
      .catch(err => {
        console.error('Failed to copy links:', err);
        toast.error(language === 'vi' 
          ? 'L·ªói khi sao ch√©p li√™n k·∫øt' 
          : 'Error copying links'
        );
      });
  };

  // Handle multiple certificate file upload
  const handleMultipleCertificateUpload = (files) => {
    console.log(`üìÅ Selected ${files.length} certificate file(s) for analysis`);
    console.log(`üîç Current modal state: showAddCrewCertModal =`, showAddCrewCertModal);
    
    // Validate crew selection first
    if (!selectedCrewForCert && certFilters.crewName === 'all') {
      toast.warning(language === 'vi'
        ? 'Vui l√≤ng ch·ªçn thuy·ªÅn vi√™n tr∆∞·ªõc khi upload ch·ª©ng ch·ªâ'
        : 'Please select a crew member before uploading certificates');
      return;
    }
    
    // Validate files
    const validFiles = files.filter(file => {
      const isValidType = file.type === 'application/pdf' || file.type.startsWith('image/');
      const isValidSize = file.size <= 10 * 1024 * 1024; // 10MB
      
      if (!isValidType) {
        toast.error(language === 'vi' 
          ? `File ${file.name} kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng` 
          : `File ${file.name} has invalid format`);
        return false;
      }
      
      if (!isValidSize) {
        toast.error(language === 'vi' 
          ? `File ${file.name} qu√° l·ªõn (>10MB)` 
          : `File ${file.name} is too large (>10MB)`);
        return false;
      }
      
      return true;
    });
    
    if (validFiles.length === 0) {
      return;
    }
    
    if (validFiles.length === 1) {
      // Single file: use existing behavior (review before adding)
      console.log('üìÑ Single file selected - using review mode');
      console.log('‚ö†Ô∏è Modal should stay OPEN for review');
      handleCertFileUpload(validFiles[0]);
      console.log('‚úÖ handleCertFileUpload called, modal should still be open');
    } else {
      // Multiple files: batch process (auto-add after each analysis)
      console.log(`üìÑüìÑ Multiple files selected (${validFiles.length}) - starting batch processing`);
      console.log('‚ö†Ô∏è Modal will CLOSE after batch processing');
      startCertBatchProcessing(validFiles);
    }
  };

  // Start batch processing for multiple certificate files
  const startCertBatchProcessing = async (files) => {
    setIsBatchProcessingCerts(true);
    setCurrentCertFileIndex(0);
    setCertBatchResults([]);
    setCertBatchProgress({ current: 0, total: files.length });
    
    toast.info(language === 'vi' 
      ? `B·∫Øt ƒë·∫ßu x·ª≠ l√Ω ${files.length} file ch·ª©ng ch·ªâ (song song)...` 
      : `Starting parallel processing of ${files.length} certificate files...`);
    
    // Capture current crew data for batch processing (avoid state access issues in async)
    const currentCrewData = filteredCrewData || [];
    
    console.log(`üöÄ Starting PARALLEL processing with 2s staggered delays`);
    
    // Create promises for all files with staggered start (2s delay between starts)
    const processingPromises = files.map((file, index) => {
      return new Promise(async (resolve) => {
        // Wait before starting this file (0s for first, 2s for second, 4s for third, etc.)
        const delayMs = index * 2000;
        if (delayMs > 0) {
          console.log(`‚è∞ File ${index + 1} will start in ${delayMs / 1000}s`);
          await new Promise(r => setTimeout(r, delayMs));
        }
        
        // Start processing this file
        console.log(`üîÑ Starting certificate ${index + 1}/${files.length}: ${file.name}`);
        setCurrentCertFileIndex(index);
        
        try {
          const result = await processSingleCertInBatch(file, index + 1, files.length, currentCrewData);
          
          // Update progress
          setCertBatchResults(prev => {
            const updated = [...prev, result];
            setCertBatchProgress({ current: updated.length, total: files.length });
            return updated;
          });
          
          resolve(result);
        } catch (error) {
          console.error(`‚ùå Error processing file ${file.name}:`, error);
          const errorResult = {
            filename: file.name,
            success: false,
            error: error.message,
            index: index + 1
          };
          
          // Update progress
          setCertBatchResults(prev => {
            const updated = [...prev, errorResult];
            setCertBatchProgress({ current: updated.length, total: files.length });
            return updated;
          });
          
          resolve(errorResult);
        }
      });
    });
    
    // Wait for ALL files to complete
    console.log(`‚è≥ Waiting for all ${files.length} files to complete...`);
    const collectedResults = await Promise.all(processingPromises);
    
    // Batch processing complete
    setIsBatchProcessingCerts(false);
    setCurrentCertFileIndex(0);
    
    console.log(`‚úÖ Batch certificate processing complete. Results: ${collectedResults.length}`);
    console.log(`   Success: ${collectedResults.filter(r => r.success).length}`);
    console.log(`   Failed: ${collectedResults.filter(r => !r.success).length}`);
    
    // Close Add Crew Cert Modal
    setShowAddCrewCertModal(false);
    
    // Show Processing Results Modal
    setCertProcessingResults(collectedResults);
    setShowCertProcessingResultsModal(true);
    
    // Refresh certificates list
    await fetchCrewCertificates(null);
    
    // Reset states
    setCertBatchResults([]);
    setCertBatchProgress({ current: 0, total: 0 });
  };

  // Process single certificate file in batch mode (auto-add certificate)
  const processSingleCertInBatch = async (file, current, total, crewDataList) => {
    try {
      console.log(`üîÑ Batch processing cert ${current}/${total}: ${file.name}`);
      
      // Get crew info
      // selectedCrewForCert is an object, so extract the ID
      const crewId = selectedCrewForCert?.id || (certFilters.crewName !== 'all' ? certFilters.crewName : null);
      let crewName = '';
      let crewNameEn = '';
      let rank = '';
      
      // If we have selectedCrewForCert object, use it directly
      if (selectedCrewForCert) {
        crewName = selectedCrewForCert.full_name || '';
        crewNameEn = selectedCrewForCert.full_name_en || '';
        rank = selectedCrewForCert.rank || '';
      } else if (crewId && crewDataList) {
        // Otherwise find in crewDataList
        const crew = crewDataList.find(c => c.id === crewId);
        if (crew) {
          crewName = crew.full_name;
          crewNameEn = crew.full_name_en || '';
          rank = crew.rank || '';
        }
      }
      
      // Analyze certificate
      const formData = new FormData();
      formData.append('cert_file', file);
      formData.append('ship_id', selectedShip?.id || '');
      if (crewId) {
        formData.append('crew_id', crewId);
      }
      
      const response = await axios.post(
        `${API}/crew-certificates/analyze-file`,
        formData,
        {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'multipart/form-data'
          }
        }
      );
      
      // Follow the same pattern as passport processing
      if (response.data.success && response.data.analysis) {
        const analysis = response.data.analysis;
        const fileIds = analysis.file_ids || {};
        
        console.log(`‚úÖ Certificate analysis completed for ${file.name}`);
        console.log(`   üìã Cert Name: ${analysis.cert_name}`);
        console.log(`   üî¢ Cert No: ${analysis.cert_no}`);
        console.log(`   üë§ Crew: ${response.data.crew_name || crewName}`);
        console.log(`   üìï Passport: ${response.data.passport}`);
        
        // Prepare certificate data from analysis (NO ship_id in body - it's a query param)
        const certData = {
          crew_id: crewId || '',
          crew_name: response.data.crew_name || crewName || 'Unknown',
          crew_name_en: response.data.crew_name_en || crewNameEn || '',
          passport: response.data.passport || 'Unknown',  // Required field - use 'Unknown' if not available
          rank: analysis.rank || rank || '',
          cert_name: analysis.cert_name || '',
          cert_no: analysis.cert_no || '',
          issued_by: analysis.issued_by || '',
          issued_date: analysis.issued_date || '',
          cert_expiry: analysis.expiry_date || '',
          note: analysis.note || '',
          crew_cert_file_id: analysis.crew_cert_file_id || fileIds.crew_cert_file_id || '',
          crew_cert_summary_file_id: analysis.crew_cert_summary_file_id || fileIds.crew_cert_summary_file_id || ''
        };
        
        // Validate required fields
        if (!certData.crew_name || !certData.passport || !certData.cert_name || !certData.cert_no) {
          throw new Error(`Missing required fields: crew_name=${certData.crew_name}, passport=${certData.passport}, cert_name=${certData.cert_name}, cert_no=${certData.cert_no}`);
        }
        
        // Check for duplicate in batch mode
        console.log(`üîç Checking for duplicate: crew_id=${certData.crew_id}, cert_no=${certData.cert_no}`);
        const duplicateCheck = await axios.post(
          `${API}/crew-certificates/check-duplicate`,
          {
            crew_id: certData.crew_id,
            cert_no: certData.cert_no
          },
          {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          }
        );

        if (duplicateCheck.data.is_duplicate) {
          console.warn(`‚ö†Ô∏è Duplicate detected for ${file.name}, skipping...`);
          const existingCert = duplicateCheck.data.existing_certificate;
          return {
            filename: file.name,
            success: false,
            certCreated: false,
            fileUploaded: false,
            summaryCreated: false,
            certName: certData.cert_name,
            certNo: certData.cert_no,
            crewName: certData.crew_name,
            error: 'DUPLICATE',
            duplicateInfo: {
              cert_name: existingCert.cert_name,
              cert_no: existingCert.cert_no,
              issued_date: existingCert.issued_date,
              cert_expiry: existingCert.cert_expiry,
              issued_by: existingCert.issued_by
            },
            index: current
          };
        }
        
        console.log('‚úÖ No duplicate found, proceeding to create...');
        
        // Auto-create certificate (ship_id as query parameter)
        const shipId = selectedShip?.id || '';
        if (!shipId) {
          throw new Error('Ship ID is required');
        }
        
        const createResponse = await axios.post(
          `${API}/crew-certificates/manual?ship_id=${shipId}`,
          certData,
          {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          }
        );
        
        if (createResponse.data && createResponse.data.id) {
          const certId = createResponse.data.id;
          console.log(`‚úÖ Certificate created successfully: ${certId}`);
          
          // ‚úÖ NOW upload files to Drive AFTER successful database save
          console.log(`üì§ Uploading files to Drive for certificate ${certId}...`);
          
          let uploadedFileId = null;
          let uploadedSummaryId = null;
          
          try {
            const uploadResponse = await axios.post(
              `${API}/crew-certificates/${certId}/upload-files`,
              {
                file_content: analysis._file_content,
                filename: analysis._filename,
                content_type: analysis._content_type,
                summary_text: analysis._summary_text
              },
              {
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
                }
              }
            );
            
            if (uploadResponse.data && uploadResponse.data.success) {
              uploadedFileId = uploadResponse.data.crew_cert_file_id;
              uploadedSummaryId = uploadResponse.data.crew_cert_summary_file_id;
              console.log(`‚úÖ Files uploaded successfully to Drive`);
              console.log(`   üìé Certificate File ID: ${uploadedFileId}`);
              console.log(`   üìã Summary File ID: ${uploadedSummaryId}`);
            } else {
              console.warn(`‚ö†Ô∏è File upload failed but certificate was saved: ${uploadResponse.data?.message}`);
            }
          } catch (uploadError) {
            console.error(`‚ùå File upload failed (certificate still saved):`, uploadError);
            // Don't throw - certificate is already saved, upload failure is not critical
          }
          
          return {
            filename: file.name,
            success: true,
            certCreated: true,
            fileUploaded: !!uploadedFileId,
            summaryCreated: !!uploadedSummaryId,
            certName: analysis.cert_name || 'Unknown',
            certNo: analysis.cert_no || 'N/A',
            crewName: certData.crew_name,
            index: current
          };
        } else {
          throw new Error('Failed to create certificate');
        }
        
      } else {
        throw new Error(response.data.message || 'Analysis failed');
      }
      
    } catch (error) {
      console.error(`‚ùå Batch processing error for ${file.name}:`, error);
      
      // Check if error is certificate holder mismatch
      if (error.response?.status === 400 && error.response?.data?.detail?.error === 'CERTIFICATE_HOLDER_MISMATCH') {
        const errorData = error.response.data.detail;
        const holderName = errorData.holder_name || 'Unknown';
        const crewName = errorData.crew_name || 'Unknown';
        
        console.warn(`‚ö†Ô∏è Certificate holder mismatch: ${holderName} vs ${crewName}`);
        
        return {
          filename: file.name,
          success: false,
          certCreated: false,
          fileUploaded: false,
          summaryCreated: false,
          error: 'HOLDER_MISMATCH',
          errorMessage: language === 'vi'
            ? `Ch·ª©ng ch·ªâ kh√¥ng thu·ªôc v·ªÅ "${crewName}"`
            : `Certificate does not belong to "${crewName}"`,
          holderName: holderName,
          crewName: crewName,
          index: current
        };
      }
      
      return {
        filename: file.name,
        success: false,
        certCreated: false,
        fileUploaded: false,
        summaryCreated: false,
        error: error.response?.data?.detail?.message || error.response?.data?.detail || error.message || 'Unknown error',
        index: current
      };
    }
  };

  // Auto rename crew certificate files
  const handleAutoRenameCrewCertFiles = async (cert) => {
    // Close context menu
    setCertContextMenu({ show: false, x: 0, y: 0, cert: null });
    
    // Check if multiple certificates are selected
    if (selectedCrewCertificates.size > 1) {
      // Bulk rename with confirmation
      const selectedCertIds = Array.from(selectedCrewCertificates);
      const selectedCerts = crewCertificates.filter(c => selectedCertIds.includes(c.id));
      
      // Count how many have files (check both old and new field names for backward compatibility)
      const certsWithFiles = selectedCerts.filter(c => c.crew_cert_file_id || c.cert_file_id);
      
      if (certsWithFiles.length === 0) {
        toast.warning(language === 'vi' 
          ? 'Kh√¥ng c√≥ ch·ª©ng ch·ªâ n√†o c√≥ file ƒë·ªÉ ƒë·ªïi t√™n'
          : 'No certificates have files to rename');
        return;
      }

      // Show confirmation dialog with preview
      const confirmMessage = language === 'vi' 
        ? `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën t·ª± ƒë·ªông ƒë·ªïi t√™n file cho ${certsWithFiles.length} ch·ª©ng ch·ªâ ƒë√£ ch·ªçn?\n\n` +
          `ƒê·ªãnh d·∫°ng: Ch·ª©c v·ª•_T√™n ng∆∞·ªùi_T√™n ch·ª©ng ch·ªâ\n` +
          `(Ch·ªâ d√πng _ ƒë·ªÉ ngƒÉn c√°ch 3 ph·∫ßn, gi·ªØ nguy√™n d·∫•u c√°ch trong t√™n)\n\n` +
          `V√≠ d·ª•:\n${certsWithFiles.slice(0, 3).map(c => {
            const rank = (c.rank || 'Unknown').replace(/\s+/g, '').replace(/[^a-zA-Z0-9]/g, '');
            const nameEn = (c.crew_name_en || c.crew_name || 'Unknown').replace(/[^\w\s-]/g, '');
            const certName = (c.cert_name || 'Certificate').replace(/[^\w\s-]/g, '');
            return `‚Ä¢ ${c.crew_name} - ${c.cert_name}\n  ‚Üí ${rank}_${nameEn}_${certName}.pdf`;
          }).join('\n')}${certsWithFiles.length > 3 ? `\n... v√† ${certsWithFiles.length - 3} ch·ª©ng ch·ªâ kh√°c` : ''}\n\n` +
          `‚ö†Ô∏è H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`
        : `Are you sure you want to automatically rename files for ${certsWithFiles.length} selected certificates?\n\n` +
          `Format: Rank_PersonName_CertificateName\n` +
          `(Use _ only between main parts, keep spaces within names)\n\n` +
          `Examples:\n${certsWithFiles.slice(0, 3).map(c => {
            const rank = (c.rank || 'Unknown').replace(/\s+/g, '').replace(/[^a-zA-Z0-9]/g, '');
            const nameEn = (c.crew_name_en || c.crew_name || 'Unknown').replace(/[^\w\s-]/g, '');
            const certName = (c.cert_name || 'Certificate').replace(/[^\w\s-]/g, '');
            return `‚Ä¢ ${c.crew_name} - ${c.cert_name}\n  ‚Üí ${rank}_${nameEn}_${certName}.pdf`;
          }).join('\n')}${certsWithFiles.length > 3 ? `\n... and ${certsWithFiles.length - 3} more` : ''}\n\n` +
          `‚ö†Ô∏è This action cannot be undone!`;
      
      if (!window.confirm(confirmMessage)) {
        return;
      }

      // Perform bulk rename
      await performBulkAutoRenameCrewCerts(certsWithFiles);
      
    } else {
      // Single certificate rename
      if (!cert?.crew_cert_file_id && !cert?.cert_file_id) {
        toast.warning(language === 'vi' 
          ? 'Ch·ª©ng ch·ªâ n√†y kh√¥ng c√≥ file ƒë√≠nh k√®m'
          : 'This certificate has no attached file');
        return;
      }

      // Generate preview filename (matching backend format)
      const rank = (cert.rank || 'Unknown').replace(/\s+/g, '').replace(/[^a-zA-Z0-9]/g, ''); // Remove all spaces and special chars
      const nameEn = (cert.crew_name_en || cert.crew_name || 'Unknown').replace(/[^\w\s-]/g, ''); // Keep spaces
      const certName = (cert.cert_name || 'Certificate').replace(/[^\w\s-]/g, ''); // Keep spaces
      const previewFilename = `${rank}_${nameEn}_${certName}.pdf`;

      const confirmMessage = language === 'vi'
        ? `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën t·ª± ƒë·ªông ƒë·ªïi t√™n file n√†y?\n\nT√™n m·ªõi: ${previewFilename}\n\n‚ö†Ô∏è H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`
        : `Are you sure you want to automatically rename this file?\n\nNew name: ${previewFilename}\n\n‚ö†Ô∏è This action cannot be undone!`;

      if (!window.confirm(confirmMessage)) {
        return;
      }

      try {
        console.log(`üîÑ Auto-renaming crew certificate file for: ${cert.crew_name} - ${cert.cert_name}`);

        const response = await axios.post(
          `${API}/crew-certificates/${cert.id}/auto-rename-file`,
          {},
          {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          }
        );

        if (response.data.success) {
          const renamedFiles = response.data.renamed_files || ['certificate'];
          const filesCount = renamedFiles.length;
          const filesText = renamedFiles.join(' + ');
          
          toast.success(language === 'vi' 
            ? `‚úÖ ƒê√£ t·ª± ƒë·ªông ƒë·ªïi t√™n ${filesCount} file: ${filesText}\nT√™n m·ªõi: ${response.data.new_filename}`
            : `‚úÖ Automatically renamed ${filesCount} file(s): ${filesText}\nNew name: ${response.data.new_filename}`
          );

          console.log(`‚úÖ File(s) renamed successfully:`, {
            cert_id: cert.id,
            new_filename: response.data.new_filename,
            renamed_files: renamedFiles
          });

          // Refresh certificates list
          await fetchCrewCertificates(null);
        } else {
          toast.error(language === 'vi' ? 'Kh√¥ng th·ªÉ t·ª± ƒë·ªông ƒë·ªïi t√™n file' : 'Failed to auto-rename file');
        }

      } catch (error) {
        console.error('Auto rename file error:', error);
        toast.error(language === 'vi' 
          ? `L·ªói t·ª± ƒë·ªông ƒë·ªïi t√™n file: ${error.response?.data?.detail || error.message}`
          : `Auto rename file error: ${error.response?.data?.detail || error.message}`
        );
      }
    }
  };

  // Perform bulk automatic rename for selected crew certificates
  const performBulkAutoRenameCrewCerts = async (certsList) => {
    try {
      let successCount = 0;
      let errorCount = 0;

      toast.info(language === 'vi' 
        ? `B·∫Øt ƒë·∫ßu t·ª± ƒë·ªông ƒë·ªïi t√™n file cho ${certsList.length} ch·ª©ng ch·ªâ...`
        : `Starting automatic rename for ${certsList.length} certificates...`);

      console.log(`üîÑ Starting bulk automatic rename for ${certsList.length} certificates`);

      for (let i = 0; i < certsList.length; i++) {
        const cert = certsList[i];
        
        try {
          console.log(`üìã Processing ${i + 1}/${certsList.length}: ${cert.crew_name} - ${cert.cert_name}`);

          const response = await axios.post(
            `${API}/crew-certificates/${cert.id}/auto-rename-file`,
            {},
            {
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              }
            }
          );

          if (response.data.success) {
            successCount++;
            console.log(`   ‚úÖ Success: ${response.data.new_filename}`);
          } else {
            errorCount++;
            console.log(`   ‚ùå Failed: ${cert.crew_name} - ${cert.cert_name}`);
          }

        } catch (error) {
          errorCount++;
          console.error(`   ‚ùå Error processing ${cert.crew_name} - ${cert.cert_name}:`, error.message);
        }

        // Add small delay between requests
        await new Promise(resolve => setTimeout(resolve, 300));
      }

      console.log(`üèÅ Bulk rename completed: ${successCount} success, ${errorCount} errors`);

      // Show final result
      if (successCount > 0 && errorCount === 0) {
        toast.success(language === 'vi' 
          ? `‚úÖ ƒê√£ t·ª± ƒë·ªông ƒë·ªïi t√™n th√†nh c√¥ng ${successCount} file!`
          : `‚úÖ Successfully renamed ${successCount} file(s)!`
        );
      } else if (successCount > 0 && errorCount > 0) {
        toast.warning(language === 'vi' 
          ? `‚ö†Ô∏è ƒê·ªïi t√™n th√†nh c√¥ng ${successCount} file, ${errorCount} l·ªói`
          : `‚ö†Ô∏è Renamed ${successCount} file(s), ${errorCount} error(s)`
        );
      } else {
        toast.error(language === 'vi' 
          ? `‚ùå Kh√¥ng th·ªÉ ƒë·ªïi t√™n file n√†o`
          : `‚ùå Failed to rename any files`
        );
      }

      // Clear selection and refresh
      setSelectedCrewCertificates(new Set());
      await fetchCrewCertificates(null);

    } catch (error) {
      console.error('Bulk rename error:', error);
      toast.error(language === 'vi' 
        ? `L·ªói khi ƒë·ªïi t√™n h√†ng lo·∫°t: ${error.message}`
        : `Bulk rename error: ${error.message}`
      );
    }
  };


  // Reset add crew form
  const resetAddCrewForm = () => {
    setNewCrewData({
      full_name: '',
      full_name_en: '',
      sex: 'M',
      date_of_birth: '',
      place_of_birth: '',
      place_of_birth_en: '',
      passport: '',
      nationality: '',
      passport_expiry_date: '',
      rank: '',
      seamen_book: '',
      status: 'Sign on',
      ship_sign_on: '-',
      place_sign_on: '',
      date_sign_on: '',
      date_sign_off: ''
    });
    setPassportFile(null);
    setPassportAnalysis(null);
    setPassportError('');
    
    // Reset batch processing states
    setSelectedFiles([]);
    setIsBatchProcessing(false);
    setCurrentFileIndex(0);
    setBatchResults([]);
    setBatchProgress({ current: 0, total: 0 });
    
    // Reset bulk edit states
    setShowBulkEditDateSignOn(false);
    setBulkDateSignOn('');
    setShowBulkEditDateSignOff(false);
    setBulkDateSignOff('');
    setShowBulkEditPlaceSignOn(false);
    setBulkPlaceSignOn('');
    setShowBulkEditShipSignOn(false);
    setBulkShipSignOn('');
  };

  // Load crew members when component mounts or filters change
  React.useEffect(() => {
    console.log('üìä Crew useEffect triggered:', {
      token: !!token,
      selectedCategory,
      ship_sign_on: crewFilters?.ship_sign_on,
      status: crewFilters?.status
    });
    
    if (token && selectedCategory === 'crew') {
      console.log('‚úÖ Fetching crew members...');
      fetchCrewMembers(crewFilters?.ship_sign_on, crewFilters?.status);
    }
  }, [token, selectedCategory, crewFilters?.ship_sign_on, crewFilters?.status]);

  const subMenuItems = {
    documents: [
      { key: 'certificates', name: language === 'vi' ? 'Gi·∫•y ch·ª©ng nh·∫≠n' : 'Certificates' },
      { key: 'class_survey_reports', name: language === 'vi' ? 'H·ªì s∆° ƒêƒÉng ki·ªÉm' : 'Class Survey Report' },
      { key: 'survey_reports', name: language === 'vi' ? 'B√°o c√°o ki·ªÉm tra' : 'Test Report' },
      { key: 'drawings_manuals', name: language === 'vi' ? 'B·∫£n v·∫Ω - S·ªï tay' : 'Drawings & Manuals' },
      { key: 'other_documents', name: language === 'vi' ? 'H·ªì s∆° kh√°c' : 'Other Documents' },
    ],
    crew: [
    ],
    ism: [
      { key: 'ism_certificate', name: language === 'vi' ? 'Ch·ª©ng ch·ªâ ISM' : 'ISM Certificate' },
      { key: 'safety_procedures', name: language === 'vi' ? 'Quy tr√¨nh an to√†n' : 'Safety Procedures' },
      { key: 'audit_reports', name: language === 'vi' ? 'B√°o c√°o ki·ªÉm to√°n' : 'Audit Reports' },
    ],
    isps: [
      { key: 'isps_certificate', name: language === 'vi' ? 'Ch·ª©ng ch·ªâ ISPS' : 'ISPS Certificate' },
      { key: 'security_plan', name: language === 'vi' ? 'K·∫ø ho·∫°ch b·∫£o m·∫≠t' : 'Security Plan' },
      { key: 'security_assessments', name: language === 'vi' ? 'ƒê√°nh gi√° b·∫£o m·∫≠t' : 'Security Assessments' },
    ],
    mlc: [
      { key: 'mlc_certificate', name: language === 'vi' ? 'Ch·ª©ng ch·ªâ MLC' : 'MLC Certificate' },
      { key: 'labor_conditions', name: language === 'vi' ? 'ƒêi·ªÅu ki·ªán lao ƒë·ªông' : 'Labor Conditions' },
      { key: 'accommodation_reports', name: language === 'vi' ? 'B√°o c√°o n∆°i ·ªü' : 'Accommodation Reports' },
    ],
    supplies: [
      { key: 'inventory', name: language === 'vi' ? 'T·ªìn kho' : 'Inventory' },
      { key: 'purchase_orders', name: language === 'vi' ? 'ƒê∆°n ƒë·∫∑t h√†ng' : 'Purchase Orders' },
      { key: 'spare_parts', name: language === 'vi' ? 'Ph·ª• t√πng thay th·∫ø' : 'Spare Parts' },
    ],
  };

  const handleCertificateDoubleClick = async (cert) => {
    try {
      if (!cert.google_drive_file_id) {
        toast.error(language === 'vi' 
          ? 'Ch·ª©ng ch·ªâ n√†y ch∆∞a c√≥ file ƒë√≠nh k√®m' 
          : 'No file attached to this certificate'
        );
        return;
      }

      // Get Google Drive file view URL
      const response = await axios.get(`${API}/gdrive/file/${cert.google_drive_file_id}/view`);
      
      if (response.data.success && response.data.view_url) {
        // Open file in new window
        window.open(response.data.view_url, '_blank', 'noopener,noreferrer');
        toast.success(language === 'vi' 
          ? 'ƒêang m·ªü file ch·ª©ng ch·ªâ...' 
          : 'Opening certificate file...'
        );
      } else {
        toast.error(language === 'vi' 
          ? 'Kh√¥ng th·ªÉ m·ªü file ch·ª©ng ch·ªâ' 
          : 'Cannot open certificate file'
        );
      }
    } catch (error) {
      console.error('Error opening certificate file:', error);
      toast.error(language === 'vi' 
        ? 'L·ªói khi m·ªü file ch·ª©ng ch·ªâ' 
        : 'Error opening certificate file'
      );
    }
  };

  const formatDate = (dateString) => {
    if (!dateString) return '-';
    try {
      // Handle YYYY-MM-DD format (no time component)
      if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
        const [year, month, day] = dateString.split('-');
        return `${day}/${month}/${year}`;
      }
      
      // Handle ISO datetime strings - check if it has timezone indicator
      if (typeof dateString === 'string' && dateString.includes('T')) {
        // If no timezone indicator (Z or +/-), treat as UTC by adding 'Z'
        const dateToUse = dateString.endsWith('Z') || /[+-]\d{2}:\d{2}$/.test(dateString) 
          ? dateString 
          : dateString + 'Z';
        
        const date = new Date(dateToUse);
        const day = String(date.getUTCDate()).padStart(2, '0');
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const year = date.getUTCFullYear();
        return `${day}/${month}/${year}`;
      }
      
      // Fallback to original logic
      const date = new Date(dateString);
      const day = String(date.getUTCDate()).padStart(2, '0');
      const month = String(date.getUTCMonth() + 1).padStart(2, '0');
      const year = date.getUTCFullYear();
      return `${day}/${month}/${year}`;
    } catch (error) {
      return '-';
    }
  };

  // Helper function to convert passport date format (DD/MM/YYYY) to HTML date input format (YYYY-MM-DD)
  const convertPassportDateToInputFormat = (dateString) => {
    if (!dateString || typeof dateString !== 'string') return '';
    
    try {
      const trimmedDate = dateString.trim();
      
      // Handle DD/MM/YYYY format from Document AI passport analysis
      const ddmmyyyyPattern = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;
      const ddmmMatch = ddmmyyyyPattern.exec(trimmedDate);
      if (ddmmMatch) {
        const day = ddmmMatch[1].padStart(2, '0');
        const month = ddmmMatch[2].padStart(2, '0');
        const year = ddmmMatch[3];
        return `${year}-${month}-${day}`;  // Return YYYY-MM-DD for HTML date input
      }
      
      // Handle YYYY-MM-DD format (already correct)
      const yyyymmddPattern = /^(\d{4})-(\d{1,2})-(\d{1,2})$/;
      const yyyymmMatch = yyyymmddPattern.exec(trimmedDate);
      if (yyyymmMatch) {
        const year = yyyymmMatch[1];
        const month = yyyymmMatch[2].padStart(2, '0');
        const day = yyyymmMatch[3].padStart(2, '0');
        return `${year}-${month}-${day}`;
      }
      
      console.warn('Unsupported passport date format:', dateString);
      return '';
    } catch (error) {
      console.error('Error converting passport date to input format:', error);
      return '';
    }
  };

  // Helper function to convert date input (YYYY-MM-DD) to UTC ISO datetime
  const convertDateInputToUTC = (dateString) => {
    if (!dateString || typeof dateString !== 'string') return null;
    
    try {
      const trimmedDate = dateString.trim();
      
      // Handle YYYY-MM-DD format from HTML date inputs
      const isoPattern = /^\d{4}-\d{2}-\d{2}$/;
      if (isoPattern.test(trimmedDate)) {
        return `${trimmedDate}T00:00:00Z`;
      }
      
      // Handle DD/MM/YYYY format from Document AI passport analysis
      const ddmmyyyyPattern = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;
      const ddmmMatch = ddmmyyyyPattern.exec(trimmedDate);
      if (ddmmMatch) {
        const day = ddmmMatch[1].padStart(2, '0');
        const month = ddmmMatch[2].padStart(2, '0');
        const year = ddmmMatch[3];
        return `${year}-${month}-${day}T00:00:00Z`;
      }
      
      // Handle YYYY-MM-DD format from backend responses
      const yyyymmddPattern = /^(\d{4})-(\d{1,2})-(\d{1,2})$/;
      const yyyymmMatch = yyyymmddPattern.exec(trimmedDate);
      if (yyyymmMatch) {
        const year = yyyymmMatch[1];
        const month = yyyymmMatch[2].padStart(2, '0');
        const day = yyyymmMatch[3].padStart(2, '0');
        return `${year}-${month}-${day}T00:00:00Z`;
      }
      
      console.warn('Unsupported date format:', dateString);
      return null;
    } catch (error) {
      console.error('Error converting date input to UTC:', error);
      return null;
    }
  };

  // Helper function to format date string to YYYY-MM-DD for HTML date inputs (UTC-safe)
  // Handles: DD/MM/YYYY, YYYY-MM-DD, ISO datetime formats
  const formatDateForInput = (dateString) => {
    if (!dateString || typeof dateString !== 'string') return '';
    
    try {
      // Handle DD/MM/YYYY format (from AI extraction)
      if (dateString.includes('/')) {
        const parts = dateString.split('/');
        if (parts.length === 3) {
          const [day, month, year] = parts;
          if (day && month && year && year.length === 4) {
            const paddedDay = day.padStart(2, '0');
            const paddedMonth = month.padStart(2, '0');
            return `${year}-${paddedMonth}-${paddedDay}`;
          }
        }
      }
      
      // Handle YYYY-MM-DD format directly (perfect for HTML input)
      const isoPattern = /^\d{4}-\d{2}-\d{2}$/;
      if (isoPattern.test(dateString.trim())) {
        return dateString.trim();
      }
      
      // Handle ISO datetime format (YYYY-MM-DDTHH:mm:ss or with Z/timezone)
      if (dateString.includes('T') || dateString.includes('Z')) {
        const date = new Date(dateString);
        if (!isNaN(date.getTime())) {
          const year = date.getUTCFullYear();
          const month = String(date.getUTCMonth() + 1).padStart(2, '0');
          const day = String(date.getUTCDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
        }
      }
      
      return '';
    } catch (e) {
      return '';
    }
  };

  // Enhanced formatting functions for Anniversary Date and Dry Dock Cycle
  const formatAnniversaryDate = (anniversaryDate) => {
    if (!anniversaryDate) return '-';
    
    // Handle enhanced anniversary date format
    if (anniversaryDate.day && anniversaryDate.month) {
      const monthNames = [
        '', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
        'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
      ];
      return `${anniversaryDate.day} ${monthNames[anniversaryDate.month]}`;
    }
    
    // Handle legacy datetime format
    if (typeof anniversaryDate === 'string') {
      try {
        const date = new Date(anniversaryDate);
        const monthNames = [
          '', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
          'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
        ];
        return `${date.getDate()} ${monthNames[date.getMonth() + 1]}`;
      } catch {
        return '-';
      }
    }
    
    return '-';
  };
  
  const formatDryDockCycle = (dryDockCycle) => {
    if (!dryDockCycle) return '-';
    
    // Handle enhanced dry dock cycle format with dd/MM/yyyy format
    if (dryDockCycle.from_date && dryDockCycle.to_date) {
      try {
        const fromDate = new Date(dryDockCycle.from_date);
        const toDate = new Date(dryDockCycle.to_date);
        
        // Format as dd/MM/yyyy
        const formatDate = (date) => {
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const year = date.getFullYear();
          return `${day}/${month}/${year}`;
        };
        
        const fromStr = formatDate(fromDate);
        const toStr = formatDate(toDate);
        
        return `${fromStr} - ${toStr}`;
      } catch {
        return '-';
      }
    }
    
    // Handle legacy months format
    if (typeof dryDockCycle === 'number') {
      return `${dryDockCycle} ${language === 'vi' ? 'th√°ng' : 'months'}`;
    }
    
    return '-';
  };
  
  
  const formatSpecialSurveyCycle = (specialSurveyCycle) => {
    if (!specialSurveyCycle) return '-';
    
    // Handle enhanced special survey cycle format with dd/MM/yyyy format
    if (specialSurveyCycle.from_date && specialSurveyCycle.to_date) {
      try {
        const fromDate = new Date(specialSurveyCycle.from_date);
        const toDate = new Date(specialSurveyCycle.to_date);
        
        // Format as dd/MM/yyyy
        const formatDate = (date) => {
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const year = date.getFullYear();
          return `${day}/${month}/${year}`;
        };
        
        const fromStr = formatDate(fromDate);
        const toStr = formatDate(toDate);
        
        return `${fromStr} - ${toStr}`;
      } catch {
        return '-';
      }
    }
    
    // Handle legacy months format  
    if (typeof specialSurveyCycle === 'number') {
      return `${specialSurveyCycle} ${language === 'vi' ? 'th√°ng' : 'months'}`;
    }
    
    return '-';
  };
  
  // Format survey type to remove "Survey" suffix for display
  const formatSurveyTypeForDisplay = (surveyType) => {
    if (!surveyType) return '-';
    
    // Remove "Survey" suffix from common survey types for consistent display
    const formattedType = surveyType
      .replace(/\s+Survey$/i, '') // Remove " Survey" at the end (case insensitive)
      .trim();
    
    return formattedType || surveyType; // Return original if formatting results in empty string
  };
  
  // Get CSS class for survey type badge
  const getSurveyTypeCssClass = (surveyType) => {
    if (!surveyType) return 'bg-gray-100 text-gray-800';
    
    const type = surveyType.toLowerCase();
    
    // Check for specific survey types (both with and without "Survey" suffix)
    if (type === 'annual' || type === 'annual survey' || type.includes('annual')) {
      return 'bg-blue-100 text-blue-800';
    }
    if (type === 'intermediate' || type === 'intermediate survey' || type.includes('intermediate')) {
      return 'bg-yellow-100 text-yellow-800';
    }
    if (type === 'renewal' || type === 'renewal survey') {
      return 'bg-green-100 text-green-800';
    }
    if (type === 'special' || type === 'special survey') {
      return 'bg-purple-100 text-purple-800';
    }
    if (type === 'docking' || type === 'docking survey') {
      return 'bg-orange-100 text-orange-800';
    }
    if (type === 'initial' || type === 'initial survey') {
      return 'bg-indigo-100 text-indigo-800';
    }
    if (type === 'condition certificate expiry') {
      return 'bg-red-100 text-red-800';
    }
    
    return 'bg-gray-100 text-gray-800';
  };
  
  // Anniversary date management functions
  const handleRecalculateAnniversaryDate = async (shipId) => {
    if (!shipId) return;
    
    try {
      const currentToken = localStorage.getItem('token') || sessionStorage.getItem('token');
      const response = await fetch(`${process.env.REACT_APP_BACKEND_URL}/api/ships/${shipId}/calculate-anniversary-date`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${currentToken}`,
          'Content-Type': 'application/json'
        }
      });
      
      const result = await response.json();
      
      if (result.success) {
        // Show success message with calculated date
        alert(`Anniversary date calculated: ${result.anniversary_date.display}\nSource: ${result.anniversary_date.source}`);
        
        // Refresh the ship data and update both ship list and detail view
        if (selectedShip?.id === shipId) {
          try {
            // Fetch updated ship data
            const shipResponse = await axios.get(`${API}/ships/${shipId}`, {
              headers: { 'Authorization': `Bearer ${currentToken}` }
            });
            
            const updatedShipData = shipResponse.data;
            
            // Update selectedShip for Ship Detail Panel
            setSelectedShip(updatedShipData);
            
            // Also refresh the ship list
            fetchShips();
            
            // If edit modal is open, update editing ship data with formatted dates
            if (showEditShipModal && editingShipData?.id === shipId) {
              setEditingShipData(prev => ({
                ...prev,
                ...updatedShipData,
                last_docking: formatDateForInput(updatedShipData.last_docking),
                last_docking_2: formatDateForInput(updatedShipData.last_docking_2),
                next_docking: formatDateForInput(updatedShipData.next_docking),
                last_special_survey: formatDateForInput(updatedShipData.last_special_survey),
                last_intermediate_survey: formatDateForInput(updatedShipData.last_intermediate_survey),
                keel_laid: formatDateForInput(updatedShipData.keel_laid),
                delivery_date: formatDateForInput(updatedShipData.delivery_date),
                special_survey_cycle: updatedShipData.special_survey_cycle && typeof updatedShipData.special_survey_cycle === 'object'
                  ? {
                      ...updatedShipData.special_survey_cycle,
                      from_date: formatDateForInput(updatedShipData.special_survey_cycle.from_date),
                      to_date: formatDateForInput(updatedShipData.special_survey_cycle.to_date)
                    }
                  : updatedShipData.special_survey_cycle
              }));
            }
          } catch (error) {
            console.error('Error refreshing ship data:', error);
          }
        }
      } else {
        alert(result.message || 'Unable to calculate anniversary date from certificates');
      }
    } catch (error) {
      console.error('Error recalculating anniversary date:', error);
      alert('Failed to recalculate anniversary date');
    }
  };

  // Special Survey Cycle management functions
  const handleRecalculateSpecialSurveyCycle = async (shipId) => {
    if (!shipId) return;
    
    try {
      const currentToken = localStorage.getItem('token') || sessionStorage.getItem('token');
      const response = await fetch(`${process.env.REACT_APP_BACKEND_URL}/api/ships/${shipId}/calculate-special-survey-cycle`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${currentToken}`,
          'Content-Type': 'application/json'
        }
      });
      
      const result = await response.json();
      
      if (result.success) {
        // Show success message with calculated cycle
        alert(`Special Survey cycle calculated: ${result.special_survey_cycle.display}\nCycle Type: ${result.special_survey_cycle.cycle_type}\nIntermediate Survey Required: ${result.special_survey_cycle.intermediate_required ? 'Yes' : 'No'}`);
        
        // Refresh the ship data and update both ship list and detail view
        if (selectedShip?.id === shipId) {
          try {
            // Fetch updated ship data
            const shipResponse = await axios.get(`${API}/ships/${shipId}`, {
              headers: { 'Authorization': `Bearer ${currentToken}` }
            });
            
            const updatedShipData = shipResponse.data;
            
            // Update selectedShip for Ship Detail Panel
            setSelectedShip(updatedShipData);
            
            // Also refresh the ship list
            fetchShips();
            
            // If edit modal is open, update editing ship data with formatted dates
            if (showEditShipModal && editingShipData?.id === shipId) {
              setEditingShipData(prev => ({
                ...prev,
                ...updatedShipData,
                last_docking: formatDateForInput(updatedShipData.last_docking),
                last_docking_2: formatDateForInput(updatedShipData.last_docking_2),
                next_docking: formatDateForInput(updatedShipData.next_docking),
                last_special_survey: formatDateForInput(updatedShipData.last_special_survey),
                last_intermediate_survey: formatDateForInput(updatedShipData.last_intermediate_survey),
                keel_laid: formatDateForInput(updatedShipData.keel_laid),
                delivery_date: formatDateForInput(updatedShipData.delivery_date),
                special_survey_cycle: updatedShipData.special_survey_cycle && typeof updatedShipData.special_survey_cycle === 'object'
                  ? {
                      ...updatedShipData.special_survey_cycle,
                      from_date: formatDateForInput(updatedShipData.special_survey_cycle.from_date),
                      to_date: formatDateForInput(updatedShipData.special_survey_cycle.to_date)
                    }
                  : updatedShipData.special_survey_cycle
              }));
            }
          } catch (error) {
            console.error('Error refreshing ship data:', error);
          }
        }
      } else {
        alert(result.message || 'Unable to calculate Special Survey cycle from certificates');
      }
    } catch (error) {
      console.error('Error recalculating special survey cycle:', error);
      alert('Failed to recalculate special survey cycle');
    }
  };

  // Last Docking dates management functions
  const handleRecalculateDockingDates = async (shipId) => {
    if (!shipId) return;
    
    try {
      const currentToken = localStorage.getItem('token') || sessionStorage.getItem('token');
      const response = await fetch(`${process.env.REACT_APP_BACKEND_URL}/api/ships/${shipId}/calculate-docking-dates`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${currentToken}`,
          'Content-Type': 'application/json'
        }
      });
      
      const result = await response.json();
      
      if (result.success) {
        // Show success message with calculated dates
        let message = 'Docking dates extracted from CSSC/DD certificates:\n';
        if (result.docking_dates.last_docking) {
          message += `Last Docking 1: ${result.docking_dates.last_docking}\n`;
        }
        if (result.docking_dates.last_docking_2) {
          message += `Last Docking 2: ${result.docking_dates.last_docking_2}`;
        }
        
        // Refresh ship data BEFORE showing alert to ensure UI updates
        try {
          console.log('üîÑ Refreshing ship data after docking calculation...');
          console.log('   Ship ID:', shipId);
          console.log('   Selected Ship ID:', selectedShip?.id);
          
          // Fetch updated ship data
          const shipResponse = await axios.get(`${API}/ships/${shipId}`, {
            headers: { 'Authorization': `Bearer ${currentToken}` }
          });
          
          const updatedShipData = shipResponse.data;
          console.log('‚úÖ Updated ship data received:', updatedShipData.last_docking);
          
          // ALWAYS update selectedShip (remove condition check)
          setSelectedShip(updatedShipData);
          console.log('‚úÖ setSelectedShip called');
          
          // Also refresh the ship list
          fetchShips();
          console.log('‚úÖ fetchShips called');
          
          // If edit modal is open, update editing ship data with formatted dates
          if (showEditShipModal && editingShipData?.id === shipId) {
            setEditingShipData(prev => ({
              ...prev,
              ...updatedShipData,
              last_docking: formatDateForInput(updatedShipData.last_docking),
              last_docking_2: formatDateForInput(updatedShipData.last_docking_2),
              next_docking: formatDateForInput(updatedShipData.next_docking),
              last_special_survey: formatDateForInput(updatedShipData.last_special_survey),
              last_intermediate_survey: formatDateForInput(updatedShipData.last_intermediate_survey),
              keel_laid: formatDateForInput(updatedShipData.keel_laid),
              delivery_date: formatDateForInput(updatedShipData.delivery_date),
              special_survey_cycle: updatedShipData.special_survey_cycle && typeof updatedShipData.special_survey_cycle === 'object'
                ? {
                    ...updatedShipData.special_survey_cycle,
                    from_date: formatDateForInput(updatedShipData.special_survey_cycle.from_date),
                    to_date: formatDateForInput(updatedShipData.special_survey_cycle.to_date)
                  }
                : updatedShipData.special_survey_cycle
            }));
            console.log('‚úÖ setEditingShipData called');
          }
          
          // Show alert AFTER refresh
          alert(message);
        } catch (error) {
          console.error('‚ùå Error refreshing ship data:', error);
          // Still show alert even if refresh fails
          alert(message);
        }
      } else {
        alert(result.message || 'Unable to extract docking dates from CSSC/DD certificates');
      }
    } catch (error) {
      console.error('Error recalculating docking dates:', error);
      alert('Failed to recalculate docking dates');
    }
  };

  // Next Docking calculation functions
  const handleRecalculateNextDocking = async (shipId) => {
    if (!shipId) return;
    
    try {
      const currentToken = localStorage.getItem('token') || sessionStorage.getItem('token');
      const response = await fetch(`${process.env.REACT_APP_BACKEND_URL}/api/ships/${shipId}/calculate-next-docking`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${currentToken}`,
          'Content-Type': 'application/json'
        }
      });
      
      const result = await response.json();
      
      if (result.success) {
        // Show success message with calculated date
        let message = `Next docking calculated: ${result.next_docking.date}\n`;
        message += `Interval: ${result.next_docking.interval_months} months (${result.next_docking.compliance})\n`;
        message += `Class Society: ${result.next_docking.class_society}\n`;
        if (result.next_docking.ship_age) {
          message += `Ship Age: ${result.next_docking.ship_age} years\n`;
        }
        message += `Notes: ${result.next_docking.notes}`;
        
        alert(message);
        
        // Refresh the ship data and update both ship list and detail view
        if (selectedShip?.id === shipId) {
          try {
            // Fetch updated ship data
            const shipResponse = await axios.get(`${API}/ships/${shipId}`, {
              headers: { 'Authorization': `Bearer ${currentToken}` }
            });
            
            const updatedShipData = shipResponse.data;
            
            // Update selectedShip for Ship Detail Panel
            setSelectedShip(updatedShipData);
            
            // Also refresh the ship list
            fetchShips();
            
            // If edit modal is open, update editing ship data with formatted dates
            if (showEditShipModal && editingShipData?.id === shipId) {
              setEditingShipData(prev => ({
                ...prev,
                ...updatedShipData,
                last_docking: formatDateForInput(updatedShipData.last_docking),
                last_docking_2: formatDateForInput(updatedShipData.last_docking_2),
                next_docking: formatDateForInput(updatedShipData.next_docking),
                last_special_survey: formatDateForInput(updatedShipData.last_special_survey),
                last_intermediate_survey: formatDateForInput(updatedShipData.last_intermediate_survey),
                keel_laid: formatDateForInput(updatedShipData.keel_laid),
                delivery_date: formatDateForInput(updatedShipData.delivery_date),
                special_survey_cycle: updatedShipData.special_survey_cycle && typeof updatedShipData.special_survey_cycle === 'object'
                  ? {
                      ...updatedShipData.special_survey_cycle,
                      from_date: formatDateForInput(updatedShipData.special_survey_cycle.from_date),
                      to_date: formatDateForInput(updatedShipData.special_survey_cycle.to_date)
                    }
                  : updatedShipData.special_survey_cycle
              }));
            }
          } catch (error) {
            console.error('Error refreshing ship data:', error);
          }
        }
      } else {
        alert(result.message || 'Unable to calculate next docking date. Last docking date required.');
      }
    } catch (error) {
      console.error('Error recalculating next docking date:', error);
      alert('Failed to recalculate next docking date');
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50">
      {/* Header */}
      <header className="bg-white shadow-lg border-b">
        <div className="w-full px-4 py-4">
          <div className="flex justify-between items-center">
            <div className="flex items-center space-x-4">
              <h1 className="text-2xl font-bold text-gray-800">{language === 'vi' ? 'H·ªá th·ªëng qu·∫£n l√≠ t√†u bi·ªÉn' : 'Ship Management System'}</h1>
              <span className="text-blue-600 text-sm">{language === 'vi' ? 'V·ªõi s·ª± h·ªó tr·ª£ AI' : 'With AI Support'}</span>
            </div>
            
            <div className="flex items-center space-x-4">
              <button
                onClick={toggleLanguage}
                className="px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-gray-50 transition-all"
              >
                {language === 'en' ? 'VI' : 'EN'}
              </button>
              
              <button
                onClick={() => navigate('/account-control')}
                className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-all shadow-sm"
              >
                {language === 'vi' ? 'C√†i ƒë·∫∑t h·ªá th·ªëng' : 'System Settings'}
              </button>
              
              <span className="text-sm text-gray-600">
                {user?.full_name} ({language === 'vi' && user?.role === 'super_admin' ? 'Si√™u qu·∫£n tr·ªã' : 
                  language === 'vi' && user?.role === 'admin' ? 'Qu·∫£n tr·ªã vi√™n' :
                  language === 'vi' && user?.role === 'manager' ? 'C√°n b·ªô c√¥ng ty' :
                  language === 'vi' && user?.role === 'editor' ? 'Sƒ© quan' :
                  language === 'vi' && user?.role === 'viewer' ? 'Thuy·ªÅn vi√™n' : user?.role})
              </span>
              
              <button
                onClick={logout}
                className="text-red-600 hover:text-red-700 px-3 py-1 rounded transition-all"
              >
                {language === 'vi' ? 'ƒêƒÉng xu·∫•t' : 'Logout'}
              </button>
            </div>
          </div>
        </div>
      </header>

      <div className="w-full px-4 py-8">
        <div className="grid lg:grid-cols-5 gap-4">
          {/* Left Sidebar - Categories and Ships (Reduced width: 1/5 instead of 1/4) */}
          <div className="bg-blue-600 rounded-xl shadow-lg p-4 text-white">
            <h3 className="text-lg font-semibold mb-6">{language === 'vi' ? 'Danh m·ª•c qu·∫£n l√Ω' : 'Management Categories'}</h3>
            <div className="space-y-2">
              {categories.map((category) => (
                <div
                  key={category.key}
                  className="relative"
                  onMouseEnter={() => handleCategoryMouseEnter(category.key)}
                  onMouseLeave={handleCategoryMouseLeave}
                >
                  <button 
                    onClick={() => handleCategoryClick(category.key)}
                    className={`w-full text-left p-3 rounded-lg transition-all border text-white font-medium ${
                      selectedCategory === category.key 
                        ? 'bg-blue-400 border-blue-300 ring-2 ring-blue-200' 
                        : 'bg-blue-500 hover:bg-blue-400 border-blue-400'
                    }`}
                    style={{
                      background: selectedCategory === category.key 
                        ? 'linear-gradient(135deg, #60a5fa, #3b82f6)' 
                        : 'linear-gradient(135deg, #4a90e2, #357abd)',
                      border: selectedCategory === category.key 
                        ? '2px solid #93c5fd' 
                        : '2px solid #2c5282'
                    }}
                  >
                    <span className="mr-3">{category.icon}</span>
                    {category.name}
                    {selectedCategory === category.key && (
                      <span className="ml-auto">‚úì</span>
                    )}
                  </button>
                  
                  {/* Ships dropdown - now uses hoveredCategory instead of selectedCategory */}
                  {hoveredCategory === category.key && (
                    <div className="absolute left-full top-0 ml-2 bg-white border border-gray-200 rounded-lg shadow-xl p-4 w-64 z-10 text-gray-800">
                      <div className="flex justify-between items-center mb-3">
                        <h4 className="font-medium text-gray-700">{language === 'vi' ? 'Danh s√°ch t√†u' : 'Ships List'}</h4>
                        <button
                          onClick={() => setShowShipListModal(true)}
                          className="px-2 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded transition-all"
                        >
                          {language === 'vi' ? 'Xem danh m·ª•c' : 'See All List'}
                        </button>
                      </div>
                      {(() => {
                        const userCompanyShips = getUserCompanyShips();
                        return userCompanyShips.length === 0 ? (
                          <p className="text-gray-500 text-sm">
                            {language === 'vi' ? 'Ch∆∞a c√≥ t√†u n√†o trong c√¥ng ty' : 'No ships in your company'}
                          </p>
                        ) : (
                          <>
                            <div className="space-y-2">
                              {userCompanyShips.slice(0, 5).map((ship) => (
                                <button
                                  key={ship.id}
                                  onClick={() => handleShipClick(ship, category.key)}
                                  className="block w-full text-left p-2 rounded hover:bg-blue-50 transition-all text-sm border border-gray-100 hover:border-blue-200"
                                >
                                  <div className="font-medium text-gray-800">{ship.name}</div>
                                  <div className="text-xs text-gray-500">{ship.flag} ‚Ä¢ {ship.class_society}</div>
                                </button>
                              ))}
                            </div>
                            {userCompanyShips.length > 5 && (
                              <div className="text-center pt-2 border-t border-gray-100 mt-2">
                                <span className="text-xs text-gray-500">
                                  {language === 'vi' ? `+${userCompanyShips.length - 5} t√†u kh√°c` : `+${userCompanyShips.length - 5} more ships`}
                                </span>
                              </div>
                            )}
                          </>
                        );
                      })()}
                    </div>
                  )}
                </div>
              ))}
            </div>
            
            {/* Additional Management Buttons */}
            <div className="mt-6 space-y-2">
              <button 
                onClick={() => {
                  setAddRecordDefaultTab(null); // No default tab when clicked from main button
                  setShowAddRecord(true);
                }}
                className="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg transition-all shadow-sm font-medium"
                style={{
                  background: 'linear-gradient(135deg, #48bb78, #38a169)',
                  border: '2px solid #2f855a'
                }}
              >
                {language === 'vi' ? 'TH√äM H·ªí S∆† M·ªöI' : 'ADD NEW RECORD'}
              </button>
              
              
              <button
                onClick={() => navigate('/account-control')}
                className="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg transition-all shadow-sm font-medium"
                style={{
                  background: 'linear-gradient(135deg, #4299e1, #3182ce)',
                  border: '2px solid #2b6cb0'
                }}
              >
                {language === 'vi' ? 'C√†i ƒë·∫∑t h·ªá th·ªëng' : 'System Settings'}
              </button>
              
              <button
                onClick={logout}
                className="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg transition-all shadow-sm font-medium"
                style={{
                  background: 'linear-gradient(135deg, #f56565, #e53e3e)',
                  border: '2px solid #c53030'
                }}
              >
                LOG OUT
              </button>
            </div>
          </div>

          {/* Main Content Area (Expanded width: 4/5 instead of 3/4) */}
          <div className="lg:col-span-4">
            <div className="bg-white rounded-xl shadow-lg p-8 min-h-96">
              {/* Ship Details - now persists after click */}
              {selectedShip ? (
                <div>
                  {/* Ship Header with Photo */}
                  <div className="grid md:grid-cols-3 gap-6 mb-6">
                    <div className="md:col-span-1">
                      <div className="bg-gray-200 rounded-lg p-4 h-48 flex items-center justify-center">
                        <div className="text-center">
                          <div className="text-4xl mb-2">üö¢</div>
                          <p className="font-semibold">SHIP PHOTO</p>
                        </div>
                      </div>
                    </div>
                    
                    <div className="md:col-span-2">
                      <div className="flex justify-between items-center mb-4">
                        <div className="flex items-center gap-4">
                          <h2 className="text-2xl font-bold text-gray-800">
                            {getDynamicPageTitle()}
                          </h2>
                          <div className="flex items-center gap-2">
                            {/* Ship Particular Button - Hidden in Crew Records */}
                            {selectedCategory !== 'crew' && (
                              <button
                                onClick={() => setShowFullShipInfo(!showFullShipInfo)}
                                className="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium transition-all flex items-center"
                              >
                                <span className="mr-1">üö¢</span>
                                {language === 'vi' ? 'Th√¥ng s·ªë k·ªπ thu·∫≠t' : 'Ship Particular'}
                                <span className="ml-1 text-xs">
                                  {showFullShipInfo ? '‚ñ≤' : '‚ñº'}
                                </span>
                              </button>
                            )}
                            {/* Ship Select Dropdown - Hidden in Crew Certificates View */}
                            {!showCertificatesView && (
                            <div className="relative" ref={shipSelectorRef}>
                              <button
                                onClick={() => setShowShipSelector(!showShipSelector)}
                                className="px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white rounded-md text-sm font-medium transition-all flex items-center"
                              >
                                <span className="mr-1">üö¢</span>
                                {language === 'vi' ? 'Ch·ªçn t√†u' : 'Ship Select'}
                                <span className="ml-1 text-xs">
                                  {showShipSelector ? '‚ñ≤' : '‚ñº'}
                                </span>
                              </button>
                              
                              {/* Ship Selector Dropdown */}
                              {showShipSelector && (
                                <div className="absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50 min-w-[250px] max-h-64 overflow-y-auto">
                                  {ships.length > 0 ? (
                                    <>
                                      <div className="px-4 py-2 text-xs font-medium text-gray-500 border-b bg-gray-50 rounded-t-lg">
                                        {language === 'vi' ? 'Ch·ªçn t√†u t·ª´ c√¥ng ty c·ªßa b·∫°n' : 'Select ship from your company'}
                                      </div>
                                      {ships.map((ship) => (
                                        <button
                                          key={ship.id}
                                          onClick={() => {
                                            console.log('üö¢ Ship selection clicked:', ship.name);
                                            
                                            setSelectedShip(ship);
                                            setCrewFilters({...crewFilters, ship_sign_on: ship.name});
                                            setShowShipSelector(false);
                                            toast.success(
                                              language === 'vi' 
                                                ? `ƒê√£ ch·ªçn t√†u: ${ship.name}`
                                                : `Selected ship: ${ship.name}`
                                            );
                                            
                                            // Auto-refresh crew certificates by clicking refresh button
                                            setTimeout(() => {
                                              const refreshBtn = document.getElementById('crew-cert-refresh-btn');
                                              if (refreshBtn) {
                                                console.log('‚úÖ Auto-clicking crew certificates refresh button...');
                                                refreshBtn.click();
                                              }
                                            }, 100);
                                          }}
                                          className={`w-full px-4 py-2 text-left hover:bg-blue-50 transition-colors border-b border-gray-100 last:border-b-0 ${
                                            selectedShip && selectedShip.id === ship.id 
                                              ? 'bg-blue-100 text-blue-700 font-medium' 
                                              : 'text-gray-700'
                                          }`}
                                        >
                                          <div className="flex items-center justify-between">
                                            <div>
                                              <div className="font-medium">{ship.name}</div>
                                              <div className="text-xs text-gray-500">
                                                {ship.imo ? `IMO: ${ship.imo}` : 'No IMO'} ‚Ä¢ {ship.flag || 'No Flag'}
                                              </div>
                                            </div>
                                            {selectedShip && selectedShip.id === ship.id && (
                                              <span className="text-blue-600 text-sm">‚úì</span>
                                            )}
                                          </div>
                                        </button>
                                      ))}
                                    </>
                                  ) : (
                                    <div className="px-4 py-3 text-sm text-gray-500 text-center">
                                      {language === 'vi' ? 'Kh√¥ng c√≥ t√†u n√†o' : 'No ships available'}
                                    </div>
                                  )}
                                </div>
                              )}
                            </div>
                            )}

                            {/* Edit Ship Button - Hidden in Crew Records */}
                            {selectedCategory !== 'crew' && (
                              <button
                                onClick={() => {
                                  // Fetch full ship details from server before editing
                                  const fetchAndEditShip = async () => {
                                    try {
                                      if (!selectedShip.id) {
                                        throw new Error('Selected ship has no ID!');
                                      }
                                      
                                      const response = await axios.get(`${API}/ships/${selectedShip.id}`, {
                                        headers: { 'Authorization': `Bearer ${token}` }
                                      });
                                      
                                      // Use full ship details from API instead of selectedShip
                                      const fullShipData = response.data;
                                      
                                      // Helper function to format ISO datetime to YYYY-MM-DD for date inputs (UTC-safe)
                                      const formatDateForEditModal = (isoDate) => {
                                        if (!isoDate) return '';
                                        try {
                                          const date = new Date(isoDate);
                                          // Use UTC methods to prevent timezone shifts
                                          const year = date.getUTCFullYear();
                                          const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                                          const day = String(date.getUTCDate()).padStart(2, '0');
                                          return `${year}-${month}-${day}`;
                                        } catch (e) {
                                          return '';
                                        }
                                      };
                                      
                                      const initData = {
                                        ...fullShipData,
                                        // Format date fields for HTML date inputs (UTC-safe)
                                        last_docking: formatDateForEditModal(fullShipData.last_docking),
                                        last_docking_2: formatDateForEditModal(fullShipData.last_docking_2),
                                        next_docking: formatDateForEditModal(fullShipData.next_docking),
                                        last_special_survey: formatDateForEditModal(fullShipData.last_special_survey),
                                        last_intermediate_survey: formatDateForEditModal(fullShipData.last_intermediate_survey),
                                        keel_laid: formatDateForEditModal(fullShipData.keel_laid),
                                        delivery_date: formatDateForEditModal(fullShipData.delivery_date),
                                        // Ensure enhanced anniversary date structure
                                        anniversary_date: fullShipData.anniversary_date && typeof fullShipData.anniversary_date === 'object' 
                                          ? fullShipData.anniversary_date 
                                          : fullShipData.anniversary_date 
                                            ? { day: null, month: null, auto_calculated: false, manual_override: true, source_certificate_type: "Legacy" }
                                            : { day: null, month: null, auto_calculated: false, manual_override: false, source_certificate_type: null },
                                        // Ensure enhanced dry dock cycle structure
                                        dry_dock_cycle: fullShipData.dry_dock_cycle && typeof fullShipData.dry_dock_cycle === 'object'
                                          ? fullShipData.dry_dock_cycle
                                          : fullShipData.dry_dock_cycle && typeof fullShipData.dry_dock_cycle === 'number'
                                            ? { from_date: null, to_date: null, intermediate_docking_required: true, last_intermediate_docking: null }
                                            : { from_date: null, to_date: null, intermediate_docking_required: true, last_intermediate_docking: null },
                                        // Ensure enhanced special survey cycle structure
                                        special_survey_cycle: fullShipData.special_survey_cycle && typeof fullShipData.special_survey_cycle === 'object'
                                          ? {
                                              ...fullShipData.special_survey_cycle,
                                              from_date: formatDateForEditModal(fullShipData.special_survey_cycle.from_date),
                                              to_date: formatDateForEditModal(fullShipData.special_survey_cycle.to_date)
                                            }
                                          : { from_date: null, to_date: null, intermediate_required: false, cycle_type: null },
                                        // Convert numeric fields to strings for HTML inputs (MUST be after ...fullShipData)
                                        built_year: fullShipData.built_year ? String(fullShipData.built_year) : '',
                                        gross_tonnage: fullShipData.gross_tonnage ? String(fullShipData.gross_tonnage) : '',
                                        deadweight: fullShipData.deadweight ? String(fullShipData.deadweight) : ''
                                      };
                                      
                                      console.log('üîç Edit Modal Data - Built Year:', initData.built_year, 'Type:', typeof initData.built_year);
                                      setEditingShipData(initData);
                                      setShowEditShipModal(true);
                                    } catch (error) {
                                      console.error('Failed to fetch full ship details:', error);
                                      toast.error(language === 'vi' 
                                        ? 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin chi ti·∫øt t√†u'
                                        : 'Failed to load ship details'
                                      );
                                    }
                                  };
                                  fetchAndEditShip();
                                }}
                                className="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm font-medium transition-all flex items-center"
                              >
                                <span className="mr-1">‚úèÔ∏è</span>
                                {language === 'vi' ? 'S·ª≠a t√†u' : 'Edit Ship'}
                              </button>
                            )}
                          </div>
                        </div>
                        <button
                          onClick={() => setSelectedShip(null)}
                          className="text-gray-400 hover:text-gray-600 text-xl px-2 py-1"
                          title={language === 'vi' ? 'ƒê√≥ng chi ti·∫øt t√†u' : 'Close ship details'}
                        >
                          ‚úï
                        </button>
                      </div>
                      
                      {/* Ship Information - Hidden in Crew Certificates View */}
                      {!showCertificatesView && (
                      <div className="mb-6">
                        {/* Basic Ship Info (Always visible) - Enhanced 3x3 Grid Layout */}
                        <div className="grid grid-cols-3 gap-4 text-sm mb-4">
                          <div className="text-base font-bold">
                            <span className="font-bold">{language === 'vi' ? 'T√™n t√†u:' : 'Ship Name:'}</span>
                            <span className="ml-2 font-bold">{selectedShip.name}</span>
                          </div>
                          <div>
                            <span className="font-semibold">{language === 'vi' ? 'T·ªï ch·ª©c Ph√¢n c·∫•p:' : 'Class Society:'}</span>
                            <span className="ml-2">{selectedShip.ship_type || selectedShip.class_society || '-'}</span>
                          </div>
                          <div>
                            <span className="font-semibold">{language === 'vi' ? 'C·ªù:' : 'Flag:'}</span>
                            <span className="ml-2">{selectedShip.flag}</span>
                          </div>
                          <div>
                            <span className="font-semibold">{language === 'vi' ? 'IMO:' : 'IMO:'}</span>
                            <span className="ml-2">{selectedShip.imo || '-'}</span>
                          </div>
                          <div>
                            <span className="font-semibold">{language === 'vi' ? 'NƒÉm ƒë√≥ng:' : 'Built Year:'}</span>
                            <span className="ml-2">{selectedShip.built_year || '-'}</span>
                          </div>
                          <div className={`${(selectedShip.ship_owner || '').length > 25 ? 'row-span-2' : ''}`}>
                            <span className="font-semibold">{language === 'vi' ? 'Ch·ªß t√†u:' : 'Ship Owner:'}</span>
                            <span className="ml-2 break-words">{selectedShip.ship_owner || '-'}</span>
                          </div>
                          <div>
                            <span className="font-semibold">{language === 'vi' ? 'T·ªïng Dung T√≠ch:' : 'Gross Tonnage:'}</span>
                            <span className="ml-2">{selectedShip.gross_tonnage?.toLocaleString() || '-'}</span>
                          </div>
                          <div>
                            <span className="font-semibold">{language === 'vi' ? 'Tr·ªçng T·∫£i:' : 'Deadweight:'}</span>
                            <span className="ml-2">{selectedShip.deadweight?.toLocaleString() || '-'}</span>
                          </div>
                          {/* Empty slot - will be occupied by Ship Owner if text is long */}
                          <div className={`${(selectedShip.ship_owner || '').length > 25 ? 'hidden' : ''}`}></div>
                        </div>

                        {/* Full Ship Info (Toggle visibility) - 3 columns layout */}
                        {showFullShipInfo && (
                          <div className="p-4 bg-gray-50 rounded-lg border">
                            <div className="mb-3">
                              <h4 className="font-semibold text-gray-700 border-b pb-2">
                                {language === 'vi' ? 'Th√¥ng tin chi ti·∫øt t√†u' : 'Detailed Ship Information'}
                              </h4>
                            </div>
                            
                            <div className="grid grid-cols-3 gap-6 text-sm">
                              {/* Column 1 - Docking Data (Vertical) */}
                              <div className="space-y-3">
                                <div>
                                  <span className="font-semibold text-gray-700">{language === 'vi' ? 'Last Docking 1:' : 'Last Docking 1:'}</span>
                                  <div className="mt-1 flex items-center space-x-2">
                                    <span>{formatDate(selectedShip.last_docking) || '-'}</span>
                                    <button
                                      onClick={() => handleRecalculateDockingDates(selectedShip.id)}
                                      className="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded transition-colors"
                                      title="Recalculate from CSSC/DD certificates"
                                    >
                                      ‚Üª
                                    </button>
                                  </div>
                                </div>
                                <div>
                                  <span className="font-semibold text-gray-700">{language === 'vi' ? 'Last Docking 2:' : 'Last Docking 2:'}</span>
                                  <div className="mt-1">{formatDate(selectedShip.last_docking_2) || '-'}</div>
                                </div>
                                <div>
                                  <span className="font-semibold text-gray-700">{language === 'vi' ? 'Next Docking:' : 'Next Docking:'}</span>
                                  <div className="mt-1 flex items-center space-x-2">
                                    <span>{formatDate(selectedShip.next_docking) || '-'}</span>
                                    <button
                                      onClick={() => handleRecalculateNextDocking(selectedShip.id)}
                                      className="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded transition-colors"
                                      title="Recalculate based on IMO requirements"
                                    >
                                      ‚Üª
                                    </button>
                                  </div>
                                </div>
                              </div>
                              
                              {/* Column 2 - Special Survey Management (Vertical) */}
                              <div className="space-y-3">
                                <div>
                                  <span className="font-semibold text-gray-700">{language === 'vi' ? 'Chu k·ª≥ Special Survey:' : 'Special Survey Cycle:'}</span>
                                  <div className="mt-1 flex items-center space-x-2">
                                    <span>{formatSpecialSurveyCycle(selectedShip.special_survey_cycle) || '-'}</span>
                                    <button
                                      onClick={() => handleRecalculateSpecialSurveyCycle(selectedShip.id)}
                                      className="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded transition-colors"
                                      title="Recalculate from Full Term certificates"
                                    >
                                      ‚Üª
                                    </button>
                                  </div>
                                </div>
                                <div>
                                  <span className="font-semibold text-gray-700">{language === 'vi' ? 'Last Special Survey:' : 'Last Special Survey:'}</span>
                                  <div className="mt-1">{formatDate(selectedShip.last_special_survey) || '-'}</div>
                                </div>
                                <div>
                                  <span className="font-semibold text-gray-700">
                                    {language === 'vi' ? 'Last Intermediate:' : 'Last Intermediate:'}
                                  </span>
                                  <div className="mt-1">{formatDate(selectedShip.last_intermediate_survey) || '-'}</div>
                                </div>
                              </div>
                              
                              {/* Column 3 - Anniversary & Compliance (Vertical) */}
                              <div className="space-y-3">
                                <div>
                                  <span className="font-semibold text-gray-700">{language === 'vi' ? 'Anniversary Date:' : 'Anniversary Date:'}</span>
                                  <div className="mt-1 flex items-center space-x-2">
                                    <span>{formatAnniversaryDate(selectedShip.anniversary_date) || '-'}</span>
                                    {selectedShip.anniversary_date?.manual_override && (
                                      <span className="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">Manual</span>
                                    )}
                                    {selectedShip.anniversary_date?.auto_calculated && (
                                      <span className="px-2 py-1 text-xs bg-green-100 text-green-800 rounded">Auto</span>
                                    )}
                                    <button
                                      onClick={() => handleRecalculateAnniversaryDate(selectedShip.id)}
                                      className="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded transition-colors"
                                      title="Recalculate from certificates"
                                    >
                                      ‚Üª
                                    </button>
                                  </div>
                                </div>
                                <div>
                                  <span className="font-semibold text-gray-700">{language === 'vi' ? 'Keel Laid:' : 'Keel Laid:'}</span>
                                  <div className="mt-1">{formatDate(selectedShip.keel_laid) || '-'}</div>
                                </div>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                      )}
                      {/* Crew Information - Shown in Crew Certificates View */}
                      {showCertificatesView && (() => {
                        // Get crew info from the selected crew filter
                        let displayCrewInfo = null;
                        
                        if (certFilters.crewName !== 'all') {
                          // Find crew from crewList based on filter selection
                          displayCrewInfo = crewList.find(crew => crew.full_name === certFilters.crewName);
                        }
                        
                        // If no crew selected in filter, don't display the section
                        if (!displayCrewInfo) return null;
                        
                        // Format date of birth to DD/MM/YYYY
                        const formatDobToDDMMYYYY = (dateStr) => {
                          if (!dateStr) return '-';
                          try {
                            const date = new Date(dateStr);
                            const day = String(date.getDate()).padStart(2, '0');
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const year = date.getFullYear();
                            return `${day}/${month}/${year}`;
                          } catch (e) {
                            return '-';
                          }
                        };
                        
                        return (
                          <div className="mb-6">
                            <h4 className="font-bold text-lg mb-4 text-gray-800">
                              {language === 'vi' ? 'Th√¥ng tin Thuy·ªÅn vi√™n' : 'Crew Member Information'}
                            </h4>
                            
                            {/* Crew Info Grid - 4 columns layout */}
                            <div className="grid grid-cols-4 gap-4 text-sm">
                              {/* Row 1 */}
                              <div>
                                <span className="font-semibold text-gray-700">{language === 'vi' ? 'H·ªç v√† t√™n (Vi·ªát):' : 'Full Name (VN):'}</span>
                                <div className="ml-2 text-gray-900 font-medium uppercase">
                                  {displayCrewInfo.full_name || '-'}
                                </div>
                              </div>
                              <div>
                                <span className="font-semibold text-gray-700">{language === 'vi' ? 'H·ªç v√† t√™n (Anh):' : 'Full Name (EN):'}</span>
                                <div className="ml-2 text-gray-900 font-medium uppercase">
                                  {displayCrewInfo.full_name_en || '-'}
                                </div>
                              </div>
                              <div>
                                <span className="font-semibold text-gray-700">{language === 'vi' ? 'Ch·ª©c danh:' : 'Rank:'}</span>
                                <span className="ml-2 text-gray-900">{displayCrewInfo.rank || '-'}</span>
                              </div>
                              <div>
                                <span className="font-semibold text-gray-700">{language === 'vi' ? 'Ng√†y sinh:' : 'Date of Birth:'}</span>
                                <span className="ml-2 text-gray-900">
                                  {formatDobToDDMMYYYY(displayCrewInfo.date_of_birth)}
                                </span>
                              </div>
                              
                              {/* Row 2 */}
                              <div>
                                <span className="font-semibold text-gray-700">{language === 'vi' ? 'N∆°i sinh:' : 'Place of Birth:'}</span>
                                <span className="ml-2 text-gray-900">{displayCrewInfo.place_of_birth || '-'}</span>
                              </div>
                              <div>
                                <span className="font-semibold text-gray-700">{language === 'vi' ? 'H·ªô chi·∫øu:' : 'Passport:'}</span>
                                <span className="ml-2 text-gray-900 font-mono">{displayCrewInfo.passport || '-'}</span>
                              </div>
                              <div>
                                <span className="font-semibold text-gray-700">{language === 'vi' ? 'Tr·∫°ng th√°i:' : 'Status:'}</span>
                                <span className={`ml-2 font-medium ${
                                  displayCrewInfo.status === 'Sign on' ? 'text-green-600' :
                                  displayCrewInfo.status === 'Sign off' ? 'text-orange-600' :
                                  displayCrewInfo.status === 'Standby' ? 'text-blue-600' :
                                  'text-gray-600'
                                }`}>
                                  {displayCrewInfo.status || '-'}
                                </span>
                              </div>
                              <div>
                                <span className="font-semibold text-gray-700">{language === 'vi' ? 'T√†u ƒëƒÉng k√Ω:' : 'Ship Sign On:'}</span>
                                <span className={`ml-2 font-medium ${
                                  displayCrewInfo.ship_sign_on === '-' ? 'text-orange-600' : 'text-blue-600'
                                }`}>
                                  {displayCrewInfo.ship_sign_on || '-'}
                                </span>
                              </div>
                            </div>
                          </div>
                        );
                      })()}

                      {/* Sub Menu */}
                      <div className="mb-6">
                        <div className="grid grid-cols-5 gap-1 w-full">
                          {subMenuItems[selectedCategory] && subMenuItems[selectedCategory].map((item) => (
                            <button
                              key={item.key}
                              onClick={() => setSelectedSubMenu(item.key)}
                              className={`px-2 py-3 rounded-lg text-sm font-medium transition-all text-center whitespace-nowrap flex-1 ${
                                selectedSubMenu === item.key 
                                  ? 'bg-blue-600 text-white shadow-lg transform scale-105' 
                                  : 'bg-gray-100 hover:bg-gray-200 text-gray-700 hover:shadow-md hover:transform hover:scale-102'
                              }`}
                              style={{ minHeight: '48px' }}
                            >
                              <span className="text-xs leading-tight">{item.name}</span>
                            </button>
                          ))}
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Content based on selected category and submenu */}
                  {selectedCategory === 'documents' && selectedSubMenu === 'certificates' && (
                    <div>
                      <div className="flex justify-between items-center mb-4">
                        <div className="flex items-center gap-3">
                          <h3 className="text-lg font-semibold text-gray-800">
                            {language === 'vi' ? 'Danh m·ª•c Gi·∫•y ch·ª©ng nh·∫≠n' : 'Certificate List'}
                          </h3>
                          
                          {/* Selection Indicator */}
                          {selectedCertificates.size > 0 && (
                            <div className="flex items-center gap-2 px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              {selectedCertificates.size} {language === 'vi' ? 'ƒë√£ ch·ªçn' : 'selected'}
                            </div>
                          )}
                        </div>
                        
                        <div className="flex gap-3">
                          {/* Update Next Survey Button */}
                          <button
                            onClick={handleUpdateSurveyTypes}
                            disabled={isUpdatingSurveyTypes || !selectedShip}
                            className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                              selectedShip && !isUpdatingSurveyTypes
                                ? 'bg-purple-600 hover:bg-purple-700 text-white cursor-pointer'
                                : 'bg-gray-400 cursor-not-allowed text-white'
                            }`}
                            title={selectedShip 
                              ? (language === 'vi' ? 'C·∫≠p nh·∫≠t lo·∫°i ki·ªÉm tra t·ªõi' : 'Update next survey types')
                              : (language === 'vi' ? 'Vui l√≤ng ch·ªçn t√†u tr∆∞·ªõc' : 'Please select a ship first')
                            }
                          >
                            {isUpdatingSurveyTypes ? (
                              <>
                                <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                {language === 'vi' ? 'ƒêang c·∫≠p nh·∫≠t...' : 'Updating...'}
                              </>
                            ) : (
                              <>
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                {language === 'vi' ? 'C·∫≠p nh·∫≠t Next Survey' : 'Update Next Survey'}
                              </>
                            )}
                          </button>

                          {/* Upcoming Survey Button */}
                          <button
                            onClick={() => checkUpcomingSurveys()}
                            className="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all bg-orange-600 hover:bg-orange-700 text-white cursor-pointer"
                            title={language === 'vi' ? 'Ki·ªÉm tra c√°c ch·ª©ng ch·ªâ s·∫Øp ƒë·∫øn h·∫°n survey' : 'Check upcoming survey certificates'}
                          >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            {language === 'vi' ? 'Upcoming Survey' : 'Upcoming Survey'}
                          </button>
                          
                          {/* Cert Upload Button */}
                          <button
                            className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                              selectedShip && !isMultiCertProcessing
                                ? 'bg-green-600 hover:bg-green-700 text-white cursor-pointer'
                                : 'bg-gray-400 cursor-not-allowed text-white'
                            }`}
                            title={selectedShip 
                              ? (language === 'vi' ? 'M·ªü form th√™m ch·ª©ng ch·ªâ' : 'Open add certificate form')
                              : (language === 'vi' ? 'Vui l√≤ng ch·ªçn t√†u tr∆∞·ªõc' : 'Please select a ship first')
                            }
                            onClick={() => {
                              if (selectedShip && !isMultiCertProcessing) {
                                setAddRecordDefaultTab('documents'); // Open Class & Flag Cert tab
                                setAddRecordDefaultDocumentType('certificate'); // Auto-select Certificate
                                setShowAddRecord(true);
                              }
                            }}
                            disabled={!selectedShip || isMultiCertProcessing}
                          >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            {isMultiCertProcessing 
                              ? (language === 'vi' ? '‚è≥ ƒêang x·ª≠ l√Ω...' : '‚è≥ Processing...')
                              : (language === 'vi' ? 'üìã Th√™m ch·ª©ng ch·ªâ' : 'üìã Add Certificate')
                            }
                          </button>

                          {/* Refresh Button */}
                          <button
                            onClick={handleRefreshCertificates}
                            disabled={isRefreshing}
                            className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white rounded-lg text-sm font-medium transition-all"
                          >
                            <span className={`${isRefreshing ? 'animate-spin' : ''}`}>üîÑ</span>
                            {isRefreshing 
                              ? (language === 'vi' ? 'ƒêang c·∫≠p nh·∫≠t...' : 'Refreshing...') 
                              : (language === 'vi' ? 'Refresh' : 'Refresh')
                            }
                          </button>
                        </div>
                      </div>

                      {/* Filter Controls */}
                      <div className="mb-4 p-4 bg-gray-50 rounded-lg border">
                        <div className="flex gap-4 items-center flex-wrap">
                          <div className="flex items-center gap-2">
                            <label className="text-sm font-medium text-gray-700">
                              {language === 'vi' ? 'Lo·∫°i ch·ª©ng ch·ªâ:' : 'Certificate Type:'}
                            </label>
                            <select
                              value={certificateFilters.certificateType}
                              onChange={(e) => setCertificateFilters(prev => ({...prev, certificateType: e.target.value}))}
                              className="border border-gray-300 rounded px-3 py-1 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                              <option value="all">{language === 'vi' ? 'T·∫•t c·∫£' : 'All'}</option>
                              {getUniqueValues('cert_type').map(type => (
                                <option key={type} value={type}>{type}</option>
                              ))}
                            </select>
                          </div>
                          
                          <div className="flex items-center gap-2">
                            <label className="text-sm font-medium text-gray-700">
                              {language === 'vi' ? 'Tr·∫°ng th√°i:' : 'Status:'}
                            </label>
                            <select
                              value={certificateFilters.status}
                              onChange={(e) => setCertificateFilters(prev => ({...prev, status: e.target.value}))}
                              className="border border-gray-300 rounded px-3 py-1 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                              <option value="all">{language === 'vi' ? 'T·∫•t c·∫£' : 'All'}</option>
                              <option value="Valid">{language === 'vi' ? 'C√≤n hi·ªáu l·ª±c' : 'Valid'}</option>
                              <option value="Expired">{language === 'vi' ? 'H·∫øt hi·ªáu l·ª±c' : 'Expired'}</option>
                              <option value="Over Due">{language === 'vi' ? 'Qu√° h·∫°n' : 'Over Due'}</option>
                            </select>
                          </div>
                          
                          {/* Search Filter */}
                          <div className="flex items-center gap-2">
                            <label className="text-sm font-medium text-gray-700">
                              {language === 'vi' ? 'T√¨m ki·∫øm:' : 'Search:'}
                            </label>
                            <div className="relative">
                              <input
                                type="text"
                                value={certificateFilters.search}
                                onChange={(e) => setCertificateFilters(prev => ({...prev, search: e.target.value}))}
                                placeholder={language === 'vi' ? 'T√¨m theo t√™n ch·ª©ng ch·ªâ...' : 'Search by certificate name...'}
                                className="border border-gray-300 rounded px-3 py-1 pl-8 text-sm w-64 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              />
                              <svg 
                                className="w-4 h-4 text-gray-400 absolute left-2 top-1/2 transform -translate-y-1/2" 
                                fill="none" 
                                stroke="currentColor" 
                                viewBox="0 0 24 24"
                              >
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                              </svg>
                              {certificateFilters.search && (
                                <button
                                  onClick={() => setCertificateFilters(prev => ({...prev, search: ''}))}
                                  className="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
                                >
                                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                  </svg>
                                </button>
                              )}
                            </div>
                          </div>
                          
                          {/* Results Count with Link Status */}
                          <div className="ml-auto flex items-center gap-3">
                            <div className="text-sm text-gray-600">
                              {language === 'vi' 
                                ? `Hi·ªÉn th·ªã ${getFilteredCertificates().length} / ${certificates.length} ch·ª©ng ch·ªâ`
                                : `Showing ${getFilteredCertificates().length} / ${certificates.length} certificates`
                              }
                            </div>
                            
                            {/* Pre-fetch Links Indicator */}
                            {linksFetching && (
                              <div className="flex items-center gap-1 px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-medium">
                                <svg className="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                {language === 'vi' ? 'ƒêang t·∫£i links...' : 'Loading links...'}
                              </div>
                            )}
                            
                            {!linksFetching && Object.keys(getCurrentShipLinks()).length > 0 && (
                              <div className="flex items-center gap-1 px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                                {Object.keys(getCurrentShipLinks()).length} {language === 'vi' ? 'links s·∫µn s√†ng' : 'links ready'}
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                      
                      <div className="overflow-x-auto">
                        <table className="w-full border-collapse border border-gray-300 text-sm resizable-table">
                          <thead>
                            <tr className="bg-gray-50">
                              <th className="border border-gray-300 px-4 py-2 text-left font-medium bg-gray-50 w-20">
                                <div className="flex items-center space-x-2">
                                  <input
                                    type="checkbox"
                                    checked={isAllSelected()}
                                    ref={headerCheckboxRef => {
                                      if (headerCheckboxRef) {
                                        headerCheckboxRef.indeterminate = isIndeterminate();
                                      }
                                    }}
                                    onChange={(e) => handleSelectAllCertificates(e.target.checked)}
                                    className="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
                                  />
                                  <span>{language === 'vi' ? 'STT' : 'No.'}</span>
                                </div>
                              </th>
                              <th 
                                className="border border-gray-300 px-4 py-2 text-left cursor-pointer hover:bg-gray-100 min-w-[120px] resize-handle"
                                onClick={() => handleCertificateSort('cert_abbreviation')}
                                style={{overflow: 'hidden'}}
                              >
                                <div className="flex items-center justify-between">
                                  <span>{language === 'vi' ? 'T√™n vi·∫øt t·∫Øt' : 'Cert. Name'}</span>
                                  {getSortIcon('cert_abbreviation')}
                                </div>
                              </th>
                              <th 
                                className="border border-gray-300 px-4 py-2 text-left cursor-pointer hover:bg-gray-100 min-w-[100px] resize-handle"
                                onClick={() => handleCertificateSort('cert_type')}
                                style={{overflow: 'hidden'}}
                              >
                                <div className="flex items-center justify-between">
                                  <span>{language === 'vi' ? 'Lo·∫°i' : 'Type'}</span>
                                  {getSortIcon('cert_type')}
                                </div>
                              </th>
                              <th 
                                className="border border-gray-300 px-4 py-2 text-left cursor-pointer hover:bg-gray-100 min-w-[120px] resize-handle"
                                onClick={() => handleCertificateSort('cert_no')}
                                style={{overflow: 'hidden'}}
                              >
                                <div className="flex items-center justify-between">
                                  <span>{language === 'vi' ? 'S·ªë ch·ª©ng ch·ªâ' : 'Certificate No'}</span>
                                  {getSortIcon('cert_no')}
                                </div>
                              </th>
                              <th 
                                className="border border-gray-300 px-4 py-2 text-left cursor-pointer hover:bg-gray-100 min-w-[100px] resize-handle"
                                onClick={() => handleCertificateSort('issue_date')}
                                style={{overflow: 'hidden'}}
                              >
                                <div className="flex items-center justify-between">
                                  <span>{language === 'vi' ? 'Ng√†y c·∫•p' : 'Issue Date'}</span>
                                  {getSortIcon('issue_date')}
                                </div>
                              </th>
                              <th 
                                className="border border-gray-300 px-4 py-2 text-left cursor-pointer hover:bg-gray-100 min-w-[100px] resize-handle"
                                onClick={() => handleCertificateSort('valid_date')}
                                style={{overflow: 'hidden'}}
                              >
                                <div className="flex items-center justify-between">
                                  <span>{language === 'vi' ? 'Ng√†y h·∫øt h·∫°n' : 'Valid Date'}</span>
                                  {getSortIcon('valid_date')}
                                </div>
                              </th>
                              <th 
                                className="border border-gray-300 px-4 py-2 text-left cursor-pointer hover:bg-gray-100 min-w-[100px] resize-handle"
                                onClick={() => handleCertificateSort('last_endorse')}
                                style={{overflow: 'hidden'}}
                              >
                                <div className="flex items-center justify-between">
                                  <span>{language === 'vi' ? 'X√°c nh·∫≠n cu·ªëi' : 'Last Endorse'}</span>
                                  {getSortIcon('last_endorse')}
                                </div>
                              </th>
                              <th 
                                className="border border-gray-300 px-4 py-2 text-left cursor-pointer hover:bg-gray-100 min-w-[120px] resize-handle"
                                onClick={() => handleCertificateSort('next_survey')}
                                style={{overflow: 'hidden'}}
                              >
                                <div className="flex items-center justify-between">
                                  <span>{language === 'vi' ? 'Ki·ªÉm tra t·ªõi' : 'Next Survey'}</span>
                                  {getSortIcon('next_survey')}
                                </div>
                              </th>
                              
                              {/* Next Survey Type Column */}
                              <th 
                                className="border border-gray-300 px-4 py-2 text-left cursor-pointer hover:bg-gray-100 min-w-[120px] resize-handle"
                                onClick={() => handleCertificateSort('next_survey_type')}
                                style={{overflow: 'hidden'}}
                              >
                                <div className="flex items-center justify-between">
                                  <span>{language === 'vi' ? 'Lo·∫°i ki·ªÉm tra t·ªõi' : 'Next Survey Type'}</span>
                                  {getSortIcon('next_survey_type')}
                                </div>
                              </th>
                              <th 
                                className="border border-gray-300 px-4 py-2 text-left cursor-pointer hover:bg-gray-100 min-w-[120px] resize-handle"
                                onClick={() => handleCertificateSort('issued_by')}
                                style={{overflow: 'hidden'}}
                              >
                                <div className="flex items-center justify-between">
                                  <span>{language === 'vi' ? 'C·∫•p b·ªüi' : 'Issued By'}</span>
                                  {getSortIcon('issued_by')}
                                </div>
                              </th>
                              <th 
                                className="border border-gray-300 px-4 py-2 text-left cursor-pointer hover:bg-gray-100 min-w-[80px] resize-handle"
                                onClick={() => handleCertificateSort('status')}
                                style={{overflow: 'hidden'}}
                              >
                                <div className="flex items-center justify-between">
                                  <span>{language === 'vi' ? 'Tr·∫°ng th√°i' : 'Status'}</span>
                                  {getSortIcon('status')}
                                </div>
                              </th>
                              <th 
                                className="border border-gray-300 px-4 py-2 text-left cursor-pointer hover:bg-gray-100 min-w-[100px] resize-handle"
                                onClick={() => handleCertificateSort('notes')}
                                style={{overflow: 'hidden'}}
                              >
                                <div className="flex items-center justify-between">
                                  <span>{language === 'vi' ? 'Ghi ch√∫' : 'Notes'}</span>
                                  {getSortIcon('notes')}
                                </div>
                              </th>
                            </tr>
                          </thead>
                          <tbody>
                            {getFilteredCertificates().length === 0 ? (
                              <tr>
                                <td colSpan="12" className="border border-gray-300 px-4 py-8 text-center text-gray-500">
                                  {certificates.length === 0 
                                    ? (language === 'vi' ? 'Ch∆∞a c√≥ ch·ª©ng ch·ªâ n√†o' : 'No certificates available')
                                    : (language === 'vi' ? 'Kh√¥ng c√≥ ch·ª©ng ch·ªâ n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc' : 'No certificates match the current filters')
                                  }
                                </td>
                              </tr>
                            ) : (
                              getFilteredCertificates().map((cert, index) => (
                                <tr 
                                  key={cert.id} 
                                  className={`hover:bg-gray-50 cursor-pointer transition-colors ${cert.google_drive_file_id ? 'hover:bg-blue-50' : ''}`}
                                  onDoubleClick={() => handleCertificateDoubleClick(cert)}
                                  onContextMenu={(e) => handleCertificateRightClick(e, cert)}
                                  title={cert.google_drive_file_id 
                                    ? (language === 'vi' ? 'Nh·∫•n ƒë√∫p ƒë·ªÉ m·ªü file | Chu·ªôt ph·∫£i ƒë·ªÉ Edit/Delete' : 'Double-click to open file | Right-click for Edit/Delete')
                                    : (language === 'vi' ? 'Ch∆∞a c√≥ file ƒë√≠nh k√®m | Chu·ªôt ph·∫£i ƒë·ªÉ Edit/Delete' : 'No file attached | Right-click for Edit/Delete')
                                  }
                                >
                                  <td 
                                    className="border border-gray-300 px-4 py-2 text-center w-20 relative group cursor-help"
                                    title={cert.file_name ? `File: ${cert.file_name}` : 'No file name available'}
                                  >
                                    <div className="flex items-center space-x-2">
                                      <input
                                        type="checkbox"
                                        checked={selectedCertificates.has(cert.id)}
                                        onChange={() => handleSelectCertificate(cert.id)}
                                        className="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                      <span className="font-bold">{index + 1}</span>
                                    </div>
                                    {/* File Name Tooltip */}
                                    {cert.file_name && (
                                      <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-sm rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-50">
                                        <div className="font-medium">Original File Name:</div>
                                        <div className="text-blue-200">{cert.file_name}</div>
                                        {/* Arrow */}
                                        <div className="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                                      </div>
                                    )}
                                  </td>
                                  <td 
                                    className="border border-gray-300 px-4 py-2 font-mono font-bold text-blue-600"
                                    title={cert.cert_name}
                                    style={{ cursor: 'help' }}
                                  >
                                    {cert.cert_abbreviation || cert.cert_name?.substring(0, 4) || 'N/A'}
                                  </td>
                                  <td className="border border-gray-300 px-4 py-2">
                                    <span className={`px-2 py-1 rounded text-xs font-medium ${
                                      cert.cert_type === 'Full Term' ? 'bg-green-100 text-green-800' :
                                      cert.cert_type === 'Interim' ? 'bg-yellow-100 text-yellow-800' :
                                      cert.cert_type === 'Provisional' ? 'bg-orange-100 text-orange-800' :
                                      cert.cert_type === 'Short term' ? 'bg-red-100 text-red-800' :
                                      cert.cert_type === 'Conditional' ? 'bg-blue-100 text-blue-800' :
                                      cert.cert_type === 'Other' ? 'bg-purple-100 text-purple-800' :
                                      'bg-gray-100 text-gray-800'
                                    }`}>
                                      {cert.cert_type || 'Unknown'}
                                    </span>
                                  </td>
                                  <td 
                                    className="border border-gray-300 px-4 py-2 font-mono relative group cursor-help"
                                    title={cert.extracted_ship_name ? `Ship Name: ${cert.extracted_ship_name}` : 'No ship name extracted'}
                                  >
                                    {cert.cert_no}
                                    {/* Tooltip */}
                                    {cert.extracted_ship_name && (
                                      <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-sm rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-50">
                                        <div className="font-medium">Ship Name from Certificate:</div>
                                        <div className="text-blue-200">{cert.extracted_ship_name}</div>
                                        {/* Arrow */}
                                        <div className="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                                      </div>
                                    )}
                                  </td>
                                  <td className="border border-gray-300 px-4 py-2">{formatDate(cert.issue_date)}</td>
                                  <td className="border border-gray-300 px-4 py-2">{formatDate(cert.valid_date)}</td>
                                  <td className="border border-gray-300 px-4 py-2">
                                    {cert.cert_type === 'Full Term' 
                                      ? formatDate(cert.last_endorse) 
                                      : (
                                        <span className="text-gray-400 text-sm italic">
                                          {language === 'vi' ? 'Kh√¥ng √°p d·ª•ng' : 'N/A'}
                                        </span>
                                      )
                                    }
                                  </td>
                                  <td className="border border-gray-300 px-4 py-2" key={`next_survey_${cert.id}_${cert.next_survey}`}>
                                    {cert.next_survey_display || formatDate(cert.next_survey)}
                                  </td>
                                  <td 
                                    className="border border-gray-300 px-4 py-2 text-center cursor-context-menu hover:bg-gray-50"
                                    onContextMenu={(e) => {
                                      e.stopPropagation(); // Prevent row context menu
                                      handleSurveyTypeRightClick(e, cert.id, cert.next_survey_type);
                                    }}
                                    title={language === 'vi' ? 'Right-click ƒë·ªÉ thay ƒë·ªïi nhanh lo·∫°i ki·ªÉm tra' : 'Right-click to quick edit survey type'}
                                  >
                                    <span className={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${getSurveyTypeCssClass(cert.next_survey_type)}`}>
                                      {formatSurveyTypeForDisplay(cert.next_survey_type)}
                                    </span>
                                  </td>
                                  <td className="border border-gray-300 px-4 py-2 text-sm font-semibold text-blue-700" title={cert.issued_by}>
                                    {cert.issued_by_abbreviation || (cert.issued_by ? 
                                      (cert.issued_by.length > 8 ? `${cert.issued_by.substring(0, 8)}...` : cert.issued_by)
                                      : '-'
                                    )}
                                  </td>
                                  <td className="border border-gray-300 px-4 py-2">
                                    <span className={`px-2 py-1 rounded text-xs font-medium ${
                                      getCertificateStatus(cert) === 'Valid' ? 'bg-green-100 text-green-800' :
                                      getCertificateStatus(cert) === 'Expired' ? 'bg-red-100 text-red-800' :
                                      getCertificateStatus(cert) === 'Over Due' ? 'bg-orange-100 text-orange-800' :
                                      'bg-gray-100 text-gray-800'
                                    }`}>
                                      {getCertificateStatus(cert) === 'Valid' 
                                        ? (language === 'vi' ? 'C√≤n hi·ªáu l·ª±c' : 'Valid')
                                        : getCertificateStatus(cert) === 'Expired' 
                                        ? (language === 'vi' ? 'H·∫øt hi·ªáu l·ª±c' : 'Expired')
                                        : getCertificateStatus(cert) === 'Over Due'
                                        ? (language === 'vi' ? 'Qu√° h·∫°n' : 'Over Due')
                                        : (language === 'vi' ? 'Kh√¥ng r√µ' : 'Unknown')
                                      }
                                    </span>
                                  </td>
                                  <td className="border border-gray-300 px-4 py-2 text-center" title={cert.notes}>
                                    {cert.has_notes ? (
                                      <span className="text-orange-600 font-bold cursor-help text-lg">*</span>
                                    ) : (
                                      <span className="text-gray-400">-</span>
                                    )}
                                  </td>
                                </tr>
                              ))
                            )}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}

                  {/* Survey Report List (Class Survey Report) */}
                  {selectedCategory === 'documents' && selectedSubMenu === 'class_survey_reports' && (
                    <div>
                      <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-semibold text-gray-800">
                          {language === 'vi' ? 'Danh s√°ch B√°o c√°o Survey' : 'Survey Report List'}
                        </h3>
                        
                        <button
                          className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                            selectedShip
                              ? 'bg-green-600 hover:bg-green-700 text-white cursor-pointer'
                              : 'bg-gray-400 cursor-not-allowed text-white'
                          }`}
                          onClick={() => selectedShip && setShowAddSurveyModal(true)}
                          disabled={!selectedShip}
                          title={selectedShip 
                            ? (language === 'vi' ? 'Th√™m b√°o c√°o survey m·ªõi' : 'Add new survey report')
                            : (language === 'vi' ? 'Vui l√≤ng ch·ªçn t√†u tr∆∞·ªõc' : 'Please select a ship first')
                          }
                        >
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                          </svg>
                          {language === 'vi' ? 'Th√™m b√°o c√°o Survey' : 'Add Survey Report'}
                        </button>
                      </div>

                      {/* Filters */}
                      <div className="mb-4 flex gap-4">
                        {/* Status Filter */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            {language === 'vi' ? 'T√¨nh tr·∫°ng' : 'Status'}
                          </label>
                          <select
                            value={surveyReportFilters.status}
                            onChange={(e) => setSurveyReportFilters(prev => ({ ...prev, status: e.target.value }))}
                            className="border border-gray-300 rounded-lg px-3 py-2 text-sm"
                          >
                            <option value="all">{language === 'vi' ? 'T·∫•t c·∫£' : 'All'}</option>
                            <option value="valid">{language === 'vi' ? 'H·ª£p l·ªá' : 'Valid'}</option>
                            <option value="expired">{language === 'vi' ? 'H·∫øt h·∫°n' : 'Expired'}</option>
                            <option value="pending">{language === 'vi' ? 'ƒêang ch·ªù' : 'Pending'}</option>
                          </select>
                        </div>

                        {/* Search */}
                        <div className="flex-1">
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            {language === 'vi' ? 'T√¨m ki·∫øm' : 'Search'}
                          </label>
                          <input
                            type="text"
                            value={surveyReportFilters.search}
                            onChange={(e) => setSurveyReportFilters(prev => ({ ...prev, search: e.target.value }))}
                            placeholder={language === 'vi' ? 'T√¨m theo t√™n, s·ªë, ƒë∆°n v·ªã c·∫•p...' : 'Search by name, number, issued by...'}
                            className="border border-gray-300 rounded-lg px-3 py-2 text-sm w-full"
                          />
                        </div>
                      </div>

                      {/* Survey Reports Table */}
                      <div className="overflow-x-auto">
                        <table className="min-w-full bg-white border border-gray-200 rounded-lg">
                          <thead className="bg-gray-50">
                            <tr>
                              <th 
                                className="border border-gray-300 px-4 py-2 text-center"
                              >
                                <div className="flex items-center justify-center">
                                  <input
                                    type="checkbox"
                                    checked={isSurveyReportsAllSelected()}
                                    ref={(el) => {
                                      if (el) el.indeterminate = isSurveyReportsIndeterminate();
                                    }}
                                    onChange={(e) => handleSelectAllSurveyReports(e.target.checked)}
                                    className="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer"
                                  />
                                </div>
                              </th>
                              <th 
                                className="border border-gray-300 px-4 py-2 text-left cursor-pointer hover:bg-gray-100"
                                onClick={() => handleSurveyReportSort('survey_report_name')}
                              >
                                <div className="flex items-center justify-between">
                                  <span>{language === 'vi' ? 'T√™n B√°o c√°o Survey' : 'Survey Report Name'}</span>
                                  {surveyReportSort.column === 'survey_report_name' && (
                                    <span className="ml-1 text-blue-600 text-sm font-bold">
                                      {surveyReportSort.direction === 'asc' ? '‚ñ≤' : '‚ñº'}
                                    </span>
                                  )}
                                </div>
                              </th>
                              <th 
                                className="border border-gray-300 px-4 py-2 text-left cursor-pointer hover:bg-gray-100"
                                onClick={() => handleSurveyReportSort('survey_report_no')}
                              >
                                <div className="flex items-center justify-between">
                                  <span>{language === 'vi' ? 'S·ªë B√°o c√°o Survey' : 'Survey Report No.'}</span>
                                  {surveyReportSort.column === 'survey_report_no' && (
                                    <span className="ml-1 text-blue-600 text-sm font-bold">
                                      {surveyReportSort.direction === 'asc' ? '‚ñ≤' : '‚ñº'}
                                    </span>
                                  )}
                                </div>
                              </th>
                              <th 
                                className="border border-gray-300 px-4 py-2 text-left cursor-pointer hover:bg-gray-100"
                                onClick={() => handleSurveyReportSort('issued_date')}
                              >
                                <div className="flex items-center justify-between">
                                  <span>{language === 'vi' ? 'Ng√†y c·∫•p' : 'Issued Date'}</span>
                                  {surveyReportSort.column === 'issued_date' && (
                                    <span className="ml-1 text-blue-600 text-sm font-bold">
                                      {surveyReportSort.direction === 'asc' ? '‚ñ≤' : '‚ñº'}
                                    </span>
                                  )}
                                </div>
                              </th>
                              <th 
                                className="border border-gray-300 px-4 py-2 text-left cursor-pointer hover:bg-gray-100"
                                onClick={() => handleSurveyReportSort('issued_by')}
                              >
                                <div className="flex items-center justify-between">
                                  <span>{language === 'vi' ? 'C·∫•p b·ªüi' : 'Issued By'}</span>
                                  {surveyReportSort.column === 'issued_by' && (
                                    <span className="ml-1 text-blue-600 text-sm font-bold">
                                      {surveyReportSort.direction === 'asc' ? '‚ñ≤' : '‚ñº'}
                                    </span>
                                  )}
                                </div>
                              </th>
                              <th 
                                className="border border-gray-300 px-4 py-2 text-left cursor-pointer hover:bg-gray-100"
                                onClick={() => handleSurveyReportSort('status')}
                              >
                                <div className="flex items-center justify-between">
                                  <span>{language === 'vi' ? 'T√¨nh tr·∫°ng' : 'Status'}</span>
                                  {surveyReportSort.column === 'status' && (
                                    <span className="ml-1 text-blue-600 text-sm font-bold">
                                      {surveyReportSort.direction === 'asc' ? '‚ñ≤' : '‚ñº'}
                                    </span>
                                  )}
                                </div>
                              </th>
                              <th 
                                className="border border-gray-300 px-4 py-2 text-center cursor-pointer hover:bg-gray-100"
                                onClick={() => handleSurveyReportSort('note')}
                              >
                                <div className="flex items-center justify-center">
                                  <span>{language === 'vi' ? 'Ghi ch√∫' : 'Note'}</span>
                                  {surveyReportSort.column === 'note' && (
                                    <span className="ml-1 text-blue-600 text-sm font-bold">
                                      {surveyReportSort.direction === 'asc' ? '‚ñ≤' : '‚ñº'}
                                    </span>
                                  )}
                                </div>
                              </th>
                            </tr>
                          </thead>
                          <tbody>
                            {getFilteredSurveyReports().length === 0 ? (
                              <tr>
                                <td colSpan="8" className="border border-gray-300 px-4 py-8 text-center text-gray-500">
                                  {surveyReports.length === 0 
                                    ? (language === 'vi' ? 'Ch∆∞a c√≥ b√°o c√°o survey n√†o' : 'No survey reports available')
                                    : (language === 'vi' ? 'Kh√¥ng c√≥ b√°o c√°o survey n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc' : 'No survey reports match the current filters')
                                  }
                                </td>
                              </tr>
                            ) : (
                              getFilteredSurveyReports().map((report, index) => (
                                <tr 
                                  key={report.id} 
                                  className="hover:bg-gray-50 cursor-context-menu"
                                  onContextMenu={(e) => handleSurveyReportContextMenu(e, report)}
                                >
                                  <td className="border border-gray-300 px-4 py-2 text-center">
                                    <div className="flex items-center justify-center space-x-2">
                                      <input
                                        type="checkbox"
                                        checked={selectedSurveyReports.has(report.id)}
                                        onChange={() => handleSurveyReportSelect(report.id)}
                                        className="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                      <span className="font-bold">{index + 1}</span>
                                    </div>
                                  </td>
                                  <td className="border border-gray-300 px-4 py-2">{report.survey_report_name}</td>
                                  <td className="border border-gray-300 px-4 py-2 font-mono">{report.survey_report_no || '-'}</td>
                                  <td className="border border-gray-300 px-4 py-2">{report.issued_date ? formatDate(report.issued_date) : '-'}</td>
                                  <td className="border border-gray-300 px-4 py-2">{report.issued_by || '-'}</td>
                                  <td className="border border-gray-300 px-4 py-2">
                                    <span className={`px-2 py-1 rounded text-xs font-medium ${
                                      report.status?.toLowerCase() === 'valid' ? 'bg-green-100 text-green-800' :
                                      report.status?.toLowerCase() === 'expired' ? 'bg-red-100 text-red-800' :
                                      report.status?.toLowerCase() === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                      'bg-gray-100 text-gray-800'
                                    }`}>
                                      {report.status || 'Unknown'}
                                    </span>
                                  </td>
                                  <td className="border border-gray-300 px-4 py-2 text-center">
                                    {report.note ? (
                                      <span 
                                        className="text-red-600 text-lg font-bold cursor-help relative"
                                        onMouseEnter={(e) => handleNoteMouseEnter(e, report.note)}
                                        onMouseLeave={handleNoteMouseLeave}
                                      >
                                        *
                                      </span>
                                    ) : (
                                      <span className="text-gray-400">-</span>
                                    )}
                                  </td>
                                </tr>
                              ))
                            )}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}


                  {/* Survey Report Context Menu */}
                  {surveyReportContextMenu.show && (
                    <div 
                      className="fixed bg-white border border-gray-200 rounded-lg shadow-lg z-[100]"
                      style={{
                        position: 'fixed',
                        top: `${surveyReportContextMenu.y}px`,
                        left: `${surveyReportContextMenu.x}px`,
                        minWidth: '180px'
                      }}
                      onClick={(e) => e.stopPropagation()}
                    >
                      <div className="py-1">
                        <button
                          onClick={() => handleOpenSurveyReport(surveyReportContextMenu.report)}
                          className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center"
                        >
                          <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                          </svg>
                          {language === 'vi' ? 'M·ªü File' : 'View File'}
                        </button>
                        
                        <button
                          onClick={() => handleCopySurveyReportLink(surveyReportContextMenu.report)}
                          className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center"
                        >
                          <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                          </svg>
                          {language === 'vi' ? 'Copy Link' : 'Copy Link'}
                        </button>
                        
                        <div className="border-t border-gray-200 my-1"></div>
                        
                        <button
                          onClick={() => handleEditSurveyReportFromMenu(surveyReportContextMenu.report)}
                          className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center"
                        >
                          <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                          </svg>
                          {language === 'vi' ? 'Ch·ªânh s·ª≠a' : 'Edit'}
                        </button>
                        
                        <button
                          onClick={() => handleDeleteSurveyReportFromMenu(surveyReportContextMenu.report)}
                          className="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center"
                        >
                          <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                          </svg>
                          {language === 'vi' ? 'X√≥a' : 'Delete'}
                        </button>
                      </div>
                    </div>
                  )}

                  {/* Survey Report Note Tooltip */}
                  {surveyReportNoteTooltip.show && (
                    <div 
                      className="fixed bg-gray-100 text-gray-800 px-4 py-2 rounded-md shadow-xl z-[100] pointer-events-none"
                      style={{
                        position: 'fixed',
                        top: `${surveyReportNoteTooltip.y}px`,
                        left: `${surveyReportNoteTooltip.x}px`,
                        transform: surveyReportNoteTooltip.showBelow ? 'translate(-50%, 0%)' : 'translate(-50%, -100%)',
                        width: `${surveyReportNoteTooltip.width}px`,
                        maxHeight: '14rem', // 10 lines * 1.4rem line-height
                        fontSize: '0.9rem',
                        lineHeight: '1.4rem',
                        whiteSpace: 'pre-wrap',
                        wordBreak: 'break-word',
                        overflowY: 'auto', // Scrollbar if content exceeds 10 lines
                        overflowX: 'hidden',
                        border: '2px solid #9CA3AF' // Gray-400 - darker border
                      }}
                    >
                      {surveyReportNoteTooltip.content}
                      {/* Tooltip Arrow */}
                      <div 
                        className="absolute bg-gray-100"
                        style={{
                          [surveyReportNoteTooltip.showBelow ? 'top' : 'bottom']: '-5px',
                          left: '50%',
                          transform: 'translateX(-50%) rotate(45deg)',
                          width: '10px',
                          height: '10px',
                          border: '2px solid #9CA3AF',
                          borderTop: surveyReportNoteTooltip.showBelow ? '2px solid #9CA3AF' : 'none',
                          borderLeft: surveyReportNoteTooltip.showBelow ? '2px solid #9CA3AF' : 'none',
                          borderBottom: !surveyReportNoteTooltip.showBelow ? '2px solid #9CA3AF' : 'none',
                          borderRight: !surveyReportNoteTooltip.showBelow ? '2px solid #9CA3AF' : 'none'
                        }}
                      />
                    </div>
                  )}


                  {/* Certificate Context Menu */}
                  {contextMenu.show && (
                    <div 
                      className="fixed bg-white border border-gray-200 rounded-lg shadow-lg z-[100]"
                      style={{
                        position: 'fixed',
                        top: `${contextMenu.y}px`,
                        left: `${contextMenu.x}px`,
                        minWidth: '180px'
                      }}
                    >
                      <div className="py-1">
                        {selectedCertificates.size > 1 && (
                          <div className="px-4 py-2 text-xs font-semibold text-gray-500 border-b border-gray-200">
                            {selectedCertificates.size} {language === 'vi' ? 'ch·ª©ng ch·ªâ ƒë√£ ch·ªçn' : 'certificates selected'}
                          </div>
                        )}
                        
                        <button
                          onClick={() => {
                            if (selectedCertificates.size > 1) {
                              handleOpenSelectedCertificates();
                            } else {
                              handleOpenCertificate(contextMenu.certificate);
                            }
                          }}
                          className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center"
                        >
                          <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                          </svg>
                          {selectedCertificates.size > 1 
                            ? (language === 'vi' ? `M·ªü ${selectedCertificates.size} files` : `Open ${selectedCertificates.size} files`)
                            : (language === 'vi' ? 'M·ªü' : 'Open')
                          }
                        </button>
                        
                        <button
                          onClick={() => {
                            if (selectedCertificates.size > 1) {
                              handleCopySelectedLinks();
                            } else {
                              handleCopyLink(contextMenu.certificate);
                            }
                          }}
                          className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center"
                        >
                          <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                          </svg>
                          {selectedCertificates.size > 1 
                            ? (language === 'vi' ? `Copy ${selectedCertificates.size} links` : `Copy ${selectedCertificates.size} links`)
                            : (language === 'vi' ? 'Copy Link' : 'Copy Link')
                          }
                        </button>
                        
                        <button
                          onClick={() => {
                            if (selectedCertificates.size > 1) {
                              handleDownloadSelectedCertificates();
                            } else {
                              handleDownloadCertificate(contextMenu.certificate);
                            }
                          }}
                          className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center"
                        >
                          <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                          </svg>
                          {selectedCertificates.size > 1 
                            ? (language === 'vi' ? `T·∫£i xu·ªëng ${selectedCertificates.size} files` : `Download ${selectedCertificates.size} files`)
                            : (language === 'vi' ? 'T·∫£i xu·ªëng' : 'Download')
                          }
                        </button>
                        
                        {/* Auto Rename File Button */}
                        <button
                          onClick={handleShowAutoRenameDialog}
                          className="w-full text-left px-4 py-2 text-sm text-orange-600 hover:bg-orange-50 flex items-center"
                        >
                          <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                          </svg>
                          Auto Rename File
                        </button>
                        
                        <div className="border-t border-gray-200 my-1"></div>
                        
                        <button
                          onClick={handleEditCertificate}
                          className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center"
                        >
                          <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                          </svg>
                          {language === 'vi' ? 'Ch·ªânh s·ª≠a' : 'Edit'}
                        </button>
                        
                        <button
                          onClick={handleDeleteCertificateFromContext}
                          className="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center"
                        >
                          <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                          </svg>
                          {language === 'vi' ? 'X√≥a' : 'Delete'}
                        </button>
                      </div>
                    </div>
                  )}

                  {/* Delete Confirmation Modal */}
                  {showDeleteConfirmation && (
                    <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                      <div className="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                        <div className="mt-3 text-center">
                          <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                            <svg className="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                            </svg>
                          </div>
                          <h3 className="text-lg leading-6 font-medium text-gray-900 mt-2">
                            {language === 'vi' ? 'X√°c nh·∫≠n x√≥a' : 'Confirm Delete'}
                          </h3>
                          <div className="mt-2 px-7 py-3">
                            <p className="text-sm text-gray-500">
                              {selectedCertificates.size > 1 
                                ? (language === 'vi' 
                                    ? `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ${selectedCertificates.size} ch·ª©ng ch·ªâ ƒë√£ ch·ªçn?`
                                    : `Are you sure you want to delete ${selectedCertificates.size} selected certificates?`)
                                : (language === 'vi' 
                                    ? 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch·ª©ng ch·ªâ n√†y?'
                                    : 'Are you sure you want to delete this certificate?')
                              }
                            </p>
                            <p className="text-xs text-gray-400 mt-2">
                              {language === 'vi' ? 'H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.' : 'This action cannot be undone.'}
                            </p>
                          </div>
                          <div className="flex justify-center space-x-4 mt-4">
                            <button
                              onClick={() => setShowDeleteConfirmation(false)}
                              className="px-4 py-2 bg-gray-300 text-gray-700 text-base font-medium rounded-md shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300"
                            >
                              {language === 'vi' ? 'H·ªßy' : 'Cancel'}
                            </button>
                            <button
                              onClick={async () => {
                                try {
                                  if (selectedCertificates.size > 1) {
                                    // Delete multiple certificates
                                    for (const certId of selectedCertificates) {
                                      await fetch(`${API}/certificates/${certId}`, {
                                        method: 'DELETE',
                                        headers: { 'Authorization': `Bearer ${token}` }
                                      });
                                    }
                                    toast.success(language === 'vi' 
                                      ? `ƒê√£ x√≥a ${selectedCertificates.size} ch·ª©ng ch·ªâ`
                                      : `Deleted ${selectedCertificates.size} certificates`);
                                  } else {
                                    // Delete single certificate
                                    const certId = contextMenu.certificate?.id || Array.from(selectedCertificates)[0];
                                    await fetch(`${API}/certificates/${certId}`, {
                                      method: 'DELETE',
                                      headers: { 'Authorization': `Bearer ${token}` }
                                    });
                                    toast.success(language === 'vi' ? 'ƒê√£ x√≥a ch·ª©ng ch·ªâ' : 'Certificate deleted');
                                  }
                                  
                                  setSelectedCertificates(new Set());
                                  setShowDeleteConfirmation(false);
                                  fetchCertificates(selectedShip.id); // Fix: add selectedShip.id
                                } catch (error) {
                                  toast.error(language === 'vi' ? 'L·ªói khi x√≥a' : 'Error deleting');
                                }
                              }}
                              className="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500"
                            >
                              {language === 'vi' ? 'X√≥a' : 'Delete'}
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Edit Certificate Modal */}
                  {showEditCertModal && editingCertificate && (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70]">
                      <div 
                        ref={editCertDrag.modalRef}
                        className="bg-white rounded-xl shadow-2xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto"
                        style={{
                          transform: `translate(${editCertDrag.position.x}px, ${editCertDrag.position.y}px)`,
                          cursor: editCertDrag.isDragging ? 'grabbing' : 'default',
                          transition: editCertDrag.isDragging ? 'none' : 'transform 0.2s ease-out'
                        }}
                      >
                        <div 
                          className="mb-6"
                          onMouseDown={editCertDrag.handleMouseDown}
                          style={{ cursor: 'grab' }}
                        >
                          <h3 className="text-xl font-bold text-gray-800 mb-2">
                            {editingCertificate?.manual_input_mode
                              ? (language === 'vi' ? 'Nh·∫≠p th·ªß c√¥ng ch·ª©ng ch·ªâ' : 'Manual Certificate Input')
                              : (language === 'vi' ? 'Ch·ªânh s·ª≠a ch·ª©ng ch·ªâ' : 'Edit Certificate')
                            }
                          </h3>
                          <p className="text-gray-600 text-sm">
                            {editingCertificate?.manual_input_mode
                              ? (language === 'vi' ? 'AI kh√¥ng th·ªÉ tr√≠ch xu·∫•t ƒë·ªß th√¥ng tin, vui l√≤ng nh·∫≠p th·ªß c√¥ng' : 'AI could not extract sufficient information, please input manually')
                              : (language === 'vi' ? 'C·∫≠p nh·∫≠t th√¥ng tin ch·ª©ng ch·ªâ' : 'Update certificate information')
                            }
                          </p>
                        </div>

                        <form className="space-y-4">
                          {/* Row 1: Certificate Name (span 3) + Abbreviation + Number + Type */}
                          <div className="grid grid-cols-6 gap-4">
                            <div className="col-span-3">
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                {language === 'vi' ? 'T√™n ch·ª©ng ch·ªâ' : 'Certificate Name'} *
                              </label>
                              <input
                                type="text"
                                required
                                value={editingCertificate.cert_name || ''}
                                onChange={(e) => setEditingCertificate(prev => ({ ...prev, cert_name: e.target.value }))}
                                className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder={language === 'vi' ? 'VD: Safety Management Certificate' : 'e.g. Safety Management Certificate'}
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                {language === 'vi' ? 'T√™n vi·∫øt t·∫Øt' : 'Abbreviation'}
                              </label>
                              <input
                                type="text"
                                value={editingCertificate.cert_abbreviation || ''}
                                onChange={(e) => setEditingCertificate(prev => ({ ...prev, cert_abbreviation: e.target.value }))}
                                className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder={language === 'vi' ? 'SMC' : 'SMC'}
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                {language === 'vi' ? 'S·ªë ch·ª©ng ch·ªâ' : 'Certificate No'} *
                              </label>
                              <input
                                type="text"
                                required
                                value={editingCertificate.cert_no || ''}
                                onChange={(e) => setEditingCertificate(prev => ({ ...prev, cert_no: e.target.value }))}
                                className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder={language === 'vi' ? 'Nh·∫≠p s·ªë ch·ª©ng ch·ªâ' : 'Enter cert number'}
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                {language === 'vi' ? 'Lo·∫°i ch·ª©ng ch·ªâ' : 'Type'} *
                              </label>
                              <select
                                required
                                value={editingCertificate.cert_type || 'Full Term'}
                                onChange={(e) => setEditingCertificate(prev => ({ ...prev, cert_type: e.target.value }))}
                                className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              >
                                <option value="Full Term">Full Term</option>
                                <option value="Interim">Interim</option>
                                <option value="Provisional">Provisional</option>
                                <option value="Short term">Short term</option>
                                <option value="Conditional">Conditional</option>
                                <option value="Other">Other</option>
                              </select>
                            </div>
                          </div>

                          {/* Row 2: Issue Date + Valid Date + Status + Issued By */}
                          <div className="grid grid-cols-4 gap-4">
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                {language === 'vi' ? 'Ng√†y c·∫•p' : 'Issue Date'} *
                              </label>
                              <input
                                type="date"
                                required
                                value={editingCertificate.issue_date?.split('T')[0] || ''}
                                onChange={(e) => setEditingCertificate(prev => ({ ...prev, issue_date: e.target.value }))}
                                className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                {language === 'vi' ? 'Ng√†y h·∫øt h·∫°n' : 'Valid Date'}
                              </label>
                              <select
                                value={editingCertificate.valid_date_type || (editingCertificate.valid_date ? 'custom-date' : '')}
                                onChange={(e) => {
                                  setEditingCertificate(prev => ({ 
                                    ...prev, 
                                    valid_date_type: e.target.value,
                                    valid_date: e.target.value !== 'custom-date' ? '' : prev.valid_date
                                  }));
                                }}
                                className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              >
                                <option value="">{language === 'vi' ? 'Ch·ªçn ng√†y h·∫øt h·∫°n' : 'Select valid date'}</option>
                                <option value="permanent">{language === 'vi' ? 'Vƒ©nh vi·ªÖn' : 'Permanent'}</option>
                                <option value="1-year">{language === 'vi' ? '1 nƒÉm t·ª´ ng√†y c·∫•p' : '1 year from issue'}</option>
                                <option value="2-years">{language === 'vi' ? '2 nƒÉm t·ª´ ng√†y c·∫•p' : '2 years from issue'}</option>
                                <option value="3-years">{language === 'vi' ? '3 nƒÉm t·ª´ ng√†y c·∫•p' : '3 years from issue'}</option>
                                <option value="5-years">{language === 'vi' ? '5 nƒÉm t·ª´ ng√†y c·∫•p' : '5 years from issue'}</option>
                                <option value="custom-date">{language === 'vi' ? 'Ng√†y t·ª± ch·ªçn' : 'Custom date'}</option>
                              </select>
                              
                              {/* Custom date input for edit mode */}
                              {(editingCertificate.valid_date_type === 'custom-date' || (!editingCertificate.valid_date_type && editingCertificate.valid_date)) && (
                                <input
                                  type="date"
                                  value={editingCertificate.valid_date?.split('T')[0] || ''}
                                  onChange={(e) => setEditingCertificate(prev => ({ ...prev, valid_date: e.target.value }))}
                                  className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mt-2"
                                  placeholder={language === 'vi' ? 'Ch·ªçn ng√†y h·∫øt h·∫°n' : 'Select expiry date'}
                                />
                              )}
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                {language === 'vi' ? 'Tr·∫°ng th√°i' : 'Status'} *
                              </label>
                              <select
                                required
                                value={editingCertificate.status || 'valid'}
                                onChange={(e) => setEditingCertificate(prev => ({ ...prev, status: e.target.value }))}
                                className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              >
                                <option value="valid">{language === 'vi' ? 'C√≥ hi·ªáu l·ª±c' : 'Valid'}</option>
                                <option value="expired">{language === 'vi' ? 'H·∫øt h·∫°n' : 'Expired'}</option>
                                <option value="over_due">{language === 'vi' ? 'Qu√° h·∫°n' : 'Over Due'}</option>
                                <option value="suspended">{language === 'vi' ? 'T·∫°m ng·ª´ng' : 'Suspended'}</option>
                                <option value="withdrawn">{language === 'vi' ? 'Thu h·ªìi' : 'Withdrawn'}</option>
                                <option value="pending">{language === 'vi' ? 'ƒêang ch·ªù' : 'Pending'}</option>
                              </select>
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                {language === 'vi' ? 'C·∫•p b·ªüi' : 'Issued By'} *
                              </label>
                              <input
                                type="text"
                                required
                                value={editingCertificate.issued_by || ''}
                                onChange={(e) => setEditingCertificate(prev => ({ ...prev, issued_by: e.target.value }))}
                                className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder={language === 'vi' ? 'DNV GL, Lloyd\'s Register, Bureau Veritas...' : 'DNV GL, Lloyd\'s Register, Bureau Veritas...'}
                              />
                            </div>
                          </div>

                          {/* Row 3: Last Endorse + Next Survey + Survey Type + Category */}
                          <div className="grid grid-cols-4 gap-4">
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                {language === 'vi' ? 'X√°c nh·∫≠n cu·ªëi' : 'Last Endorse'}
                                {editingCertificate.cert_type !== 'Full Term' && (
                                  <span className="text-xs text-gray-400 ml-1">(Full Term only)</span>
                                )}
                              </label>
                              <input
                                type="date"
                                value={editingCertificate.last_endorse?.split('T')[0] || ''}
                                onChange={(e) => setEditingCertificate(prev => ({ ...prev, last_endorse: e.target.value }))}
                                disabled={editingCertificate.cert_type !== 'Full Term'}
                                className={`w-full px-3 py-2 text-sm border rounded-lg focus:ring-2 focus:ring-blue-500 ${
                                  editingCertificate.cert_type !== 'Full Term' 
                                    ? 'border-gray-200 bg-gray-50 text-gray-400 cursor-not-allowed'
                                    : 'border-gray-300 focus:border-transparent'
                                }`}
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                {language === 'vi' ? 'Ki·ªÉm tra ti·∫øp theo' : 'Next Survey'}
                              </label>
                              <input
                                type="date"
                                value={editingCertificate.next_survey?.split('T')[0] || ''}
                                onChange={(e) => setEditingCertificate(prev => ({ ...prev, next_survey: e.target.value }))}
                                className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                {language === 'vi' ? 'Lo·∫°i ki·ªÉm tra' : 'Survey Type'}
                              </label>
                              <select
                                value={editingCertificate.next_survey_type || ''}
                                onChange={(e) => setEditingCertificate(prev => ({ ...prev, next_survey_type: e.target.value }))}
                                className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              >
                                <option value="">{language === 'vi' ? 'Ch·ªçn lo·∫°i ki·ªÉm tra' : 'Select survey type'}</option>
                                <option value="Initial">{language === 'vi' ? 'Ki·ªÉm tra l·∫ßn ƒë·∫ßu' : 'Initial'}</option>
                                <option value="Annual">{language === 'vi' ? 'Ki·ªÉm tra h√†ng nƒÉm' : 'Annual'}</option>
                                <option value="Intermediate">{language === 'vi' ? 'Ki·ªÉm tra trung gian' : 'Intermediate'}</option>
                                <option value="Special">{language === 'vi' ? 'Ki·ªÉm tra ƒë·ªãnh k·ª≥' : 'Special'}</option>
                                <option value="Renewal">{language === 'vi' ? 'Ki·ªÉm tra c·∫•p m·ªõi' : 'Renewal'}</option>
                                <option value="Docking">{language === 'vi' ? 'Ki·ªÉm tra tr√™n ƒë√†' : 'Docking'}</option>
                                <option value="Other">{language === 'vi' ? 'Kh√°c' : 'Other'}</option>
                              </select>
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                {language === 'vi' ? 'Danh m·ª•c' : 'Category'} *
                              </label>
                              <input
                                type="text"
                                value={language === 'vi' ? 'Gi·∫•y ch·ª©ng nh·∫≠n' : 'Certificates'}
                                readOnly
                                className="w-full px-3 py-2 text-sm border border-gray-200 bg-gray-50 rounded-lg text-gray-600 cursor-not-allowed"
                              />
                            </div>
                          </div>

                          {/* Row 4: Sensitivity Level + Notes (span 3) */}
                          <div className="grid grid-cols-4 gap-4">
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                {language === 'vi' ? 'M·ª©c b·∫£o m·∫≠t' : 'Sensitivity Level'} *
                              </label>
                              <select
                                required
                                value={editingCertificate.sensitivity_level || 'internal'}
                                onChange={(e) => setEditingCertificate(prev => ({ ...prev, sensitivity_level: e.target.value }))}
                                className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              >
                                <option value="public">{language === 'vi' ? 'C√¥ng khai' : 'Public'}</option>
                                <option value="internal">{language === 'vi' ? 'N·ªôi b·ªô' : 'Internal'}</option>
                                <option value="confidential">{language === 'vi' ? 'B√≠ m·∫≠t' : 'Confidential'}</option>
                                <option value="restricted">{language === 'vi' ? 'H·∫°n ch·∫ø' : 'Restricted'}</option>
                              </select>
                            </div>
                            <div className="col-span-3">
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                {language === 'vi' ? 'Ghi ch√∫ b·ªï sung' : 'Additional Notes'}
                              </label>
                              <textarea
                                value={editingCertificate.notes || ''}
                                onChange={(e) => setEditingCertificate(prev => ({ ...prev, notes: e.target.value }))}
                                rows="3"
                                className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                placeholder={language === 'vi' 
                                  ? 'Nh·∫≠p ghi ch√∫ b·ªï sung v·ªÅ ch·ª©ng ch·ªâ (t√πy ch·ªçn)...' 
                                  : 'Enter additional notes about the certificate (optional)...'}
                              />
                            </div>
                          </div>
                        </form>

                        <div className="flex justify-between items-center mt-6">
                          {/* Auto Rename File Button - Left side */}
                          {editingCertificate?.google_drive_file_id && (
                            <button
                              onClick={async () => {
                                try {
                                  setIsRenaming(true);
                                  
                                  const response = await axios.post(`${API}/certificates/${editingCertificate.id}/auto-rename-file`, {}, {
                                    headers: { 'Authorization': `Bearer ${token}` }
                                  });
                                  
                                  if (response.data.success) {
                                    toast.success(
                                      language === 'vi' 
                                        ? `ƒê√£ ƒë·ªïi t√™n file th√†nh: ${response.data.new_name}` 
                                        : `File renamed to: ${response.data.new_name}`
                                    );
                                    
                                    // Update the certificate with new filename
                                    setEditingCertificate(prev => ({
                                      ...prev,
                                      file_name: response.data.new_name
                                    }));
                                    
                                    // Refresh certificate list
                                    await fetchCertificates(selectedShip.id);
                                  }
                                } catch (error) {
                                  console.error('Error renaming file:', error);
                                  
                                  // Check if it's the "not supported" error with suggested filename
                                  if (error.response && error.response.status === 501) {
                                    const errorMessage = error.response.data.detail;
                                    
                                    // Extract suggested filename from error message
                                    const suggestedMatch = errorMessage.match(/Suggested filename: (.+)/);
                                    const suggestedFilename = suggestedMatch ? suggestedMatch[1] : '';
                                    
                                    toast.error(
                                      language === 'vi' 
                                        ? `T√≠nh nƒÉng ƒë·ªïi t√™n t·ª± ƒë·ªông ch∆∞a ƒë∆∞·ª£c h·ªó tr·ª£. T√™n file g·ª£i √Ω: ${suggestedFilename}`
                                        : `Auto-rename feature not yet supported. Suggested filename: ${suggestedFilename}`,
                                      { duration: 8000 }
                                    );
                                  } else {
                                    toast.error(
                                      language === 'vi' 
                                        ? 'L·ªói khi ƒë·ªïi t√™n file!' 
                                        : 'Error renaming file!'
                                    );
                                  }
                                } finally {
                                  setIsRenaming(false);
                                }
                              }}
                              disabled={isRenaming}
                              className="px-4 py-2 bg-orange-600 hover:bg-orange-700 disabled:bg-orange-300 text-white rounded-lg transition-all flex items-center"
                            >
                              {isRenaming ? (
                                <>
                                  <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                                  {language === 'vi' ? 'ƒêang ƒë·ªïi t√™n...' : 'Renaming...'}
                                </>
                              ) : (
                                <>
                                  <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                  </svg>
                                  {language === 'vi' ? 'ƒê·ªïi t√™n file' : 'Auto Rename file'}
                                </>
                              )}
                            </button>
                          )}
                          
                          {/* Cancel and Save Buttons - Right side */}
                          <div className="flex space-x-3">
                            <button
                              onClick={() => {
                                setShowEditCertModal(false);
                                setEditingCertificate(null);
                                editCertDrag.resetPosition();
                              }}
                              className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all"
                            >
                              {language === 'vi' ? 'H·ªßy' : 'Cancel'}
                            </button>
                            <button
                              onClick={async () => {
                                try {
                                  // Prepare update payload with UTC-safe date conversion
                                  const updatePayload = {
                                    ...editingCertificate,
                                    issue_date: editingCertificate.issue_date ? convertDateInputToUTC(editingCertificate.issue_date.split('T')[0]) : null,
                                    valid_date: editingCertificate.valid_date ? convertDateInputToUTC(editingCertificate.valid_date.split('T')[0]) : null,
                                    last_endorse: editingCertificate.last_endorse ? convertDateInputToUTC(editingCertificate.last_endorse.split('T')[0]) : null,
                                    next_survey: editingCertificate.next_survey ? convertDateInputToUTC(editingCertificate.next_survey.split('T')[0]) : null
                                  };
                                  
                                  const response = await axios.put(`${API}/certificates/${editingCertificate.id}`, updatePayload, {
                                    headers: { 'Authorization': `Bearer ${token}` }
                                  });
                                  
                                  console.log('Certificate update response:', response.data);
                                  
                                  // Close modal first
                                  setShowEditCertModal(false);
                                  setEditingCertificate(null);
                                  editCertDrag.resetPosition();
                                  
                                  // Add small delay to ensure backend has processed the update
                                  await new Promise(resolve => setTimeout(resolve, 500));
                                  
                                  // Force refresh certificate list
                                  console.log('Refreshing certificate list after update...');
                                  await fetchCertificates(selectedShip.id);
                                  
                                  toast.success(language === 'vi' ? 'C·∫≠p nh·∫≠t ch·ª©ng ch·ªâ th√†nh c√¥ng!' : 'Certificate updated successfully!');
                                } catch (error) {
                                  console.error('Error updating certificate:', error);
                                  toast.error(language === 'vi' ? 'L·ªói khi c·∫≠p nh·∫≠t ch·ª©ng ch·ªâ!' : 'Error updating certificate!');
                                }
                              }}
                              className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all"
                            >
                              {language === 'vi' ? 'L∆∞u' : 'Save'}
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {/* Add Survey Report Modal */}
                  {showAddSurveyModal && (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70]">
                      <div className="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div className="mb-6">
                          <h3 className="text-xl font-bold text-gray-800 mb-2">
                            {language === 'vi' ? 'Th√™m B√°o c√°o Survey m·ªõi' : 'Add New Survey Report'}
                          </h3>
                          <p className="text-gray-600 text-sm">
                            {language === 'vi' ? 'Nh·∫≠p th√¥ng tin b√°o c√°o survey' : 'Enter survey report information'}
                          </p>
                        </div>

                        {/* Section 1: From Survey Report File (AI Analysis) */}
                        <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                          <h4 className="font-semibold text-blue-900 mb-2 flex items-center gap-2">
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                            </svg>
                            {language === 'vi' ? 'üìÑ T·ª´ file b√°o c√°o survey (AI ph√¢n t√≠ch)' : 'üìÑ From Survey Report File (AI Analysis)'}
                          </h4>
                          <p className="text-sm text-blue-700 mb-3">
                            {language === 'vi' 
                              ? 'T·∫£i l√™n file b√°o c√°o survey ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin ho·∫∑c nh·∫≠p th·ªß c√¥ng b√™n d∆∞·ªõi'
                              : 'Upload survey report file to automatically fill information or enter manually below'}
                          </p>
                          
                          {!analyzedSurveyReportData ? (
                            <div className="mt-3">
                              <label 
                                className="flex flex-col items-center justify-center w-full h-32 border-2 border-blue-300 border-dashed rounded-lg cursor-pointer bg-white hover:bg-blue-50 transition-all"
                              >
                                <div className="flex flex-col items-center justify-center pt-5 pb-6">
                                  <svg className="w-10 h-10 mb-3 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                  </svg>
                                  <p className="mb-2 text-sm text-blue-600">
                                    <span className="font-semibold">{language === 'vi' ? 'Nh·∫•n ƒë·ªÉ ch·ªçn' : 'Click to select'}</span> {language === 'vi' ? 'ho·∫∑c k√©o th·∫£ file' : 'or drag and drop'}
                                  </p>
                                  <p className="text-xs text-blue-500">
                                    PDF, JPG, PNG {language === 'vi' ? '(t·ªëi ƒëa 20MB, nhi·ªÅu file ƒë∆∞·ª£c h·ªó tr·ª£)' : '(max 20MB, multiple files supported)'}
                                  </p>
                                </div>
                                <input 
                                  type="file" 
                                  className="hidden" 
                                  accept=".pdf,.jpg,.jpeg,.png"
                                  multiple
                                  onChange={handleSurveyReportFileSelect}
                                  disabled={isAnalyzingSurveyReport}
                                />
                              </label>
                              
                              {isAnalyzingSurveyReport && (
                                <div className="mt-3 flex items-center justify-center gap-2 text-blue-600">
                                  <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
                                  <span className="text-sm font-medium">
                                    {language === 'vi' ? 'ƒêang ph√¢n t√≠ch file...' : 'Analyzing file...'}
                                  </span>
                                </div>
                              )}
                              
                              {surveyReportFileError && (
                                <div className="mt-3 p-3 bg-red-50 border border-red-200 rounded-lg">
                                  <p className="text-sm text-red-700">{surveyReportFileError}</p>
                                </div>
                              )}
                            </div>
                          ) : (
                            <div className="mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                              <div className="flex items-start justify-between">
                                <div className="flex items-start gap-3 flex-1">
                                  <svg className="w-5 h-5 text-green-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                  </svg>
                                  <div className="flex-1">
                                    <p className="text-sm font-semibold text-green-800">
                                      {language === 'vi' ? '‚úÖ File ƒë√£ ƒë∆∞·ª£c ph√¢n t√≠ch th√†nh c√¥ng!' : '‚úÖ File analyzed successfully!'}
                                    </p>
                                    <p className="text-xs text-green-700 mt-1">
                                      {analyzedSurveyReportData._filename}
                                    </p>
                                    <p className="text-xs text-green-600 mt-1">
                                      {language === 'vi' ? 'Th√¥ng tin ƒë√£ ƒë∆∞·ª£c t·ª± ƒë·ªông ƒëi·ªÅn. Vui l√≤ng ki·ªÉm tra v√† ch·ªânh s·ª≠a n·∫øu c·∫ßn.' : 'Information has been auto-filled. Please review and edit if needed.'}
                                    </p>
                                  </div>
                                </div>
                                <button
                                  type="button"
                                  onClick={() => {
                                    setAnalyzedSurveyReportData(null);
                                    setSurveyReportFiles([]);
                                    setSurveyReportFileError('');
                                  }}
                                  className="text-green-600 hover:text-green-800 transition-colors"
                                  title={language === 'vi' ? 'X√≥a v√† ch·ªçn file kh√°c' : 'Remove and select another file'}
                                >
                                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                  </svg>
                                </button>
                              </div>
                            </div>
                          )}
                        </div>

                        {/* Section 2: Manual Entry Form */}
                        <div className="mb-4">
                          <h4 className="font-semibold text-gray-700 mb-3 flex items-center gap-2">
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                            {language === 'vi' ? 'Ho·∫∑c nh·∫≠p th·ªß c√¥ng' : 'Or Enter Manually'}
                          </h4>
                        </div>

                        <form className="space-y-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              {language === 'vi' ? 'T√™n B√°o c√°o Survey' : 'Survey Report Name'} *
                            </label>
                            <input
                              type="text"
                              required
                              value={newSurveyReport.survey_report_name}
                              onChange={(e) => setNewSurveyReport(prev => ({ ...prev, survey_report_name: e.target.value }))}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              placeholder={language === 'vi' ? 'VD: Annual Survey Report' : 'e.g. Annual Survey Report'}
                            />
                          </div>

                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              {language === 'vi' ? 'S·ªë B√°o c√°o Survey' : 'Survey Report No.'}
                            </label>
                            <input
                              type="text"
                              value={newSurveyReport.survey_report_no}
                              onChange={(e) => setNewSurveyReport(prev => ({ ...prev, survey_report_no: e.target.value }))}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              placeholder={language === 'vi' ? 'VD: SR-2025-001' : 'e.g. SR-2025-001'}
                            />
                          </div>

                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                {language === 'vi' ? 'Ng√†y c·∫•p' : 'Issued Date'}
                              </label>
                              <input
                                type="date"
                                value={newSurveyReport.issued_date}
                                onChange={(e) => setNewSurveyReport(prev => ({ ...prev, issued_date: e.target.value }))}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>

                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                {language === 'vi' ? 'T√¨nh tr·∫°ng' : 'Status'}
                              </label>
                              <select
                                value={newSurveyReport.status}
                                onChange={(e) => setNewSurveyReport(prev => ({ ...prev, status: e.target.value }))}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              >
                                <option value="Valid">{language === 'vi' ? 'H·ª£p l·ªá' : 'Valid'}</option>
                                <option value="Expired">{language === 'vi' ? 'H·∫øt h·∫°n' : 'Expired'}</option>
                                <option value="Pending">{language === 'vi' ? 'ƒêang ch·ªù' : 'Pending'}</option>
                              </select>
                            </div>
                          </div>

                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              {language === 'vi' ? 'C·∫•p b·ªüi' : 'Issued By'}
                            </label>
                            <input
                              type="text"
                              value={newSurveyReport.issued_by}
                              onChange={(e) => setNewSurveyReport(prev => ({ ...prev, issued_by: e.target.value }))}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              placeholder={language === 'vi' ? 'VD: Lloyd\'s Register' : 'e.g. Lloyd\'s Register'}
                            />
                          </div>

                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              {language === 'vi' ? 'Ghi ch√∫' : 'Note'}
                            </label>
                            <textarea
                              value={newSurveyReport.note}
                              onChange={(e) => setNewSurveyReport(prev => ({ ...prev, note: e.target.value }))}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              rows="3"
                              placeholder={language === 'vi' ? 'Nh·∫≠p ghi ch√∫ (kh√¥ng b·∫Øt bu·ªôc)' : 'Enter note (optional)'}
                            />
                          </div>

                          <div className="flex justify-end gap-3 pt-4 border-t">
                            <button
                              type="button"
                              onClick={() => {
                                setShowAddSurveyModal(false);
                                setNewSurveyReport({
                                  survey_report_name: '',
                                  survey_report_no: '',
                                  issued_date: '',
                                  issued_by: '',
                                  status: 'Valid',
                                  note: ''
                                });
                              }}
                              className="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-all"
                            >
                              {language === 'vi' ? 'H·ªßy' : 'Cancel'}
                            </button>
                            <button
                              type="button"
                              onClick={handleAddSurveyReport}
                              className="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-all"
                            >
                              {language === 'vi' ? 'Th√™m' : 'Add'}
                            </button>
                          </div>
                        </form>
                      </div>
                    </div>
                  )}

                  {/* Edit Survey Report Modal */}
                  {showEditSurveyModal && editingSurveyReport && (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70]">
                      <div className="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div className="mb-6">
                          <h3 className="text-xl font-bold text-gray-800 mb-2">
                            {language === 'vi' ? 'Ch·ªânh s·ª≠a B√°o c√°o Survey' : 'Edit Survey Report'}
                          </h3>
                          <p className="text-gray-600 text-sm">
                            {language === 'vi' ? 'C·∫≠p nh·∫≠t th√¥ng tin b√°o c√°o survey' : 'Update survey report information'}
                          </p>
                        </div>

                        <form className="space-y-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              {language === 'vi' ? 'T√™n B√°o c√°o Survey' : 'Survey Report Name'} *
                            </label>
                            <input
                              type="text"
                              required
                              value={editingSurveyReport.survey_report_name}
                              onChange={(e) => setEditingSurveyReport(prev => ({ ...prev, survey_report_name: e.target.value }))}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              placeholder={language === 'vi' ? 'VD: Annual Survey Report' : 'e.g. Annual Survey Report'}
                            />
                          </div>

                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              {language === 'vi' ? 'S·ªë B√°o c√°o Survey' : 'Survey Report No.'}
                            </label>
                            <input
                              type="text"
                              value={editingSurveyReport.survey_report_no || ''}
                              onChange={(e) => setEditingSurveyReport(prev => ({ ...prev, survey_report_no: e.target.value }))}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              placeholder={language === 'vi' ? 'VD: SR-2025-001' : 'e.g. SR-2025-001'}
                            />
                          </div>

                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                {language === 'vi' ? 'Ng√†y c·∫•p' : 'Issued Date'}
                              </label>
                              <input
                                type="date"
                                value={editingSurveyReport.issued_date?.split('T')[0] || ''}
                                onChange={(e) => setEditingSurveyReport(prev => ({ ...prev, issued_date: e.target.value }))}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>

                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                {language === 'vi' ? 'T√¨nh tr·∫°ng' : 'Status'}
                              </label>
                              <select
                                value={editingSurveyReport.status || 'Valid'}
                                onChange={(e) => setEditingSurveyReport(prev => ({ ...prev, status: e.target.value }))}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              >
                                <option value="Valid">{language === 'vi' ? 'H·ª£p l·ªá' : 'Valid'}</option>
                                <option value="Expired">{language === 'vi' ? 'H·∫øt h·∫°n' : 'Expired'}</option>
                                <option value="Pending">{language === 'vi' ? 'ƒêang ch·ªù' : 'Pending'}</option>
                              </select>
                            </div>
                          </div>

                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              {language === 'vi' ? 'C·∫•p b·ªüi' : 'Issued By'}
                            </label>
                            <input
                              type="text"
                              value={editingSurveyReport.issued_by || ''}
                              onChange={(e) => setEditingSurveyReport(prev => ({ ...prev, issued_by: e.target.value }))}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              placeholder={language === 'vi' ? 'VD: Lloyd\'s Register' : 'e.g. Lloyd\'s Register'}
                            />
                          </div>

                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              {language === 'vi' ? 'Ghi ch√∫' : 'Note'}
                            </label>
                            <textarea
                              value={editingSurveyReport.note || ''}
                              onChange={(e) => setEditingSurveyReport(prev => ({ ...prev, note: e.target.value }))}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              rows="3"
                              placeholder={language === 'vi' ? 'Nh·∫≠p ghi ch√∫ (kh√¥ng b·∫Øt bu·ªôc)' : 'Enter note (optional)'}
                            />
                          </div>

                          <div className="flex justify-end gap-3 pt-4 border-t">
                            <button
                              type="button"
                              onClick={() => {
                                setShowEditSurveyModal(false);
                                setEditingSurveyReport(null);
                              }}
                              className="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-all"
                            >
                              {language === 'vi' ? 'H·ªßy' : 'Cancel'}
                            </button>
                            <button
                              type="button"
                              onClick={handleUpdateSurveyReport}
                              className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all"
                            >
                              {language === 'vi' ? 'C·∫≠p nh·∫≠t' : 'Update'}
                            </button>
                          </div>
                        </form>
                      </div>
                    </div>
                  )}
                  
                  {/* Batch Processing Progress Modal */}
                  {isBatchProcessingSurveyReports && (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[80]">
                      <div className="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
                        <div className="text-center">
                          <div className="mb-4">
                            <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto"></div>
                          </div>
                          <h3 className="text-xl font-bold text-gray-800 mb-2">
                            {language === 'vi' ? 'ƒêang x·ª≠ l√Ω Survey Reports...' : 'Processing Survey Reports...'}
                          </h3>
                          <p className="text-gray-600 mb-4">
                            {language === 'vi' 
                              ? `ƒêang x·ª≠ l√Ω file ${surveyReportBatchProgress.current}/${surveyReportBatchProgress.total}`
                              : `Processing file ${surveyReportBatchProgress.current}/${surveyReportBatchProgress.total}`}
                          </p>
                          
                          {/* Progress Bar */}
                          <div className="w-full bg-gray-200 rounded-full h-4 mb-2">
                            <div 
                              className="bg-blue-600 h-4 rounded-full transition-all duration-300"
                              style={{ 
                                width: `${surveyReportBatchProgress.total > 0 ? (surveyReportBatchProgress.current / surveyReportBatchProgress.total) * 100 : 0}%` 
                              }}
                            ></div>
                          </div>
                          <p className="text-sm text-gray-500">
                            {surveyReportBatchProgress.total > 0 
                              ? `${Math.round((surveyReportBatchProgress.current / surveyReportBatchProgress.total) * 100)}%`
                              : '0%'}
                          </p>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Processing Results Modal */}
                  {showSurveyReportProcessingResultsModal && (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[80]">
                      <div className="bg-white rounded-xl shadow-2xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div className="mb-6">
                          <h3 className="text-2xl font-bold text-gray-800 mb-2">
                            {language === 'vi' ? 'üìä K·∫øt qu·∫£ x·ª≠ l√Ω Survey Reports' : 'üìä Survey Report Processing Results'}
                          </h3>
                          <p className="text-gray-600">
                            {language === 'vi' 
                              ? `ƒê√£ x·ª≠ l√Ω ${surveyReportBatchResults.length} file`
                              : `Processed ${surveyReportBatchResults.length} files`}
                          </p>
                        </div>

                        {/* Results Table */}
                        <div className="overflow-x-auto mb-6">
                          <table className="min-w-full bg-white border border-gray-200 rounded-lg">
                            <thead className="bg-gray-50">
                              <tr>
                                <th className="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">
                                  {language === 'vi' ? 'T√™n file' : 'Filename'}
                                </th>
                                <th className="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">
                                  {language === 'vi' ? 'T√™n b√°o c√°o' : 'Report Name'}
                                </th>
                                <th className="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">
                                  {language === 'vi' ? 'S·ªë b√°o c√°o' : 'Report No.'}
                                </th>
                                <th className="border border-gray-300 px-4 py-2 text-center text-sm font-semibold">
                                  {language === 'vi' ? 'Tr·∫°ng th√°i' : 'Status'}
                                </th>
                              </tr>
                            </thead>
                            <tbody>
                              {surveyReportBatchResults.map((result, index) => (
                                <tr key={index} className={result.success ? 'bg-green-50' : 'bg-red-50'}>
                                  <td className="border border-gray-300 px-4 py-2 text-sm">
                                    {result.filename}
                                  </td>
                                  <td className="border border-gray-300 px-4 py-2 text-sm">
                                    {result.surveyReportName || '-'}
                                  </td>
                                  <td className="border border-gray-300 px-4 py-2 text-sm font-mono">
                                    {result.surveyReportNo || '-'}
                                  </td>
                                  <td className="border border-gray-300 px-4 py-2 text-center">
                                    {result.success ? (
                                      <div className="flex flex-col items-center gap-1">
                                        <span className="text-green-600 font-semibold">
                                          ‚úÖ {language === 'vi' ? 'Th√†nh c√¥ng' : 'Success'}
                                        </span>
                                        {result.surveyReportCreated && (
                                          <span className="text-xs text-green-600">
                                            {language === 'vi' ? 'üìã ƒê√£ t·∫°o record' : 'üìã Record created'}
                                          </span>
                                        )}
                                        {result.fileUploaded && (
                                          <span className="text-xs text-green-600">
                                            {language === 'vi' ? '‚òÅÔ∏è ƒê√£ upload file' : '‚òÅÔ∏è Files uploaded'}
                                          </span>
                                        )}
                                      </div>
                                    ) : (
                                      <div className="flex flex-col items-center gap-1">
                                        <span className="text-red-600 font-semibold">
                                          ‚ùå {language === 'vi' ? 'Th·∫•t b·∫°i' : 'Failed'}
                                        </span>
                                        <span className="text-xs text-red-600">
                                          {result.error === 'DUPLICATE' 
                                            ? (language === 'vi' ? '‚ö†Ô∏è ƒê√£ t·ªìn t·∫°i' : '‚ö†Ô∏è Duplicate')
                                            : result.error}
                                        </span>
                                      </div>
                                    )}
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>

                        {/* Summary */}
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                          <div className="grid grid-cols-3 gap-4 text-center">
                            <div>
                              <p className="text-2xl font-bold text-gray-800">
                                {surveyReportBatchResults.length}
                              </p>
                              <p className="text-sm text-gray-600">
                                {language === 'vi' ? 'T·ªïng s·ªë' : 'Total'}
                              </p>
                            </div>
                            <div>
                              <p className="text-2xl font-bold text-green-600">
                                {surveyReportBatchResults.filter(r => r.success).length}
                              </p>
                              <p className="text-sm text-gray-600">
                                {language === 'vi' ? 'Th√†nh c√¥ng' : 'Success'}
                              </p>
                            </div>
                            <div>
                              <p className="text-2xl font-bold text-red-600">
                                {surveyReportBatchResults.filter(r => !r.success).length}
                              </p>
                              <p className="text-sm text-gray-600">
                                {language === 'vi' ? 'Th·∫•t b·∫°i' : 'Failed'}
                              </p>
                            </div>
                          </div>
                        </div>

                        {/* Close Button */}
                        <div className="flex justify-end">
                          <button
                            onClick={() => {
                              setShowSurveyReportProcessingResultsModal(false);
                              setSurveyReportBatchResults([]);
                            }}
                            className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all font-medium"
                          >
                            {language === 'vi' ? 'ƒê√≥ng' : 'Close'}
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {/* Crew Records Section */}
                  {selectedCategory === 'crew' ? (
                    <div className="space-y-6">
                      {!showCertificatesView ? (
                        /* Crew List View */
                        <>
                          {/* Header with Add Crew Button */}
                          <div className="flex justify-between items-center">
                            <div>
                              <h3 className="text-lg font-semibold text-gray-800 mb-1">
                                {language === 'vi' ? 'Danh s√°ch thuy·ªÅn vi√™n c√¥ng ty' : 'Company Crew List'}
                              </h3>
                              <p className="text-sm text-gray-600">
                                {language === 'vi' 
                                  ? 'Qu·∫£n l√Ω t·∫•t c·∫£ thuy·ªÅn vi√™n c·ªßa c√¥ng ty' 
                                  : 'Manage all crew members of the company'}
                              </p>
                            </div>
                        {/* Action Buttons */}
                        <div className="flex items-center space-x-3">
                          {/* Only show Add Crew button for manager, admin and super_admin roles */}
                          {user && (user.role === 'manager' || user.role === 'admin' || user.role === 'super_admin') && (
                            <button 
                              onClick={() => setShowAddCrewModal(true)}
                              className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all flex items-center"
                            >
                              <span className="mr-2">üë§</span>
                              {language === 'vi' ? 'Th√™m thuy·ªÅn vi√™n' : 'Add Crew'}
                            </button>
                          )}
                          
                          {/* Refresh Button */}
                          <button 
                            onClick={async () => {
                              // Fetch crew list
                              await fetchCrewMembers(crewFilters?.ship_sign_on, crewFilters?.status);
                              
                              toast.success(language === 'vi' ? 'ƒê√£ l√†m m·ªõi danh s√°ch thuy·ªÅn vi√™n' : 'Crew list refreshed');
                            }}
                            className="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-all flex items-center"
                            title={language === 'vi' ? 'L√†m m·ªõi' : 'Refresh'}
                          >
                            <span className="mr-2">üîÑ</span>
                            {language === 'vi' ? 'L√†m m·ªõi' : 'Refresh'}
                          </button>
                        </div>
                      </div>

                      {/* Filters and Search */}
                      <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                        <div className="flex flex-wrap items-end gap-4">
                          {/* Ship Sign On Filter */}
                          <div className="flex items-center space-x-2 min-w-[200px]">
                            <label className="text-sm font-medium text-gray-700 whitespace-nowrap">
                              {language === 'vi' ? 'T√†u ƒëƒÉng k√Ω:' : 'Ship Sign On:'}
                            </label>
                            <select 
                              value={crewFilters?.ship_sign_on || 'All'}
                              onChange={(e) => {
                                const newFilters = {...crewFilters, ship_sign_on: e.target.value};
                                setCrewFilters(newFilters);
                                // Backend filtering will be handled by useEffect
                              }}
                              className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                            >
                              <option value="All">{language === 'vi' ? 'T·∫•t c·∫£' : 'All'}</option>
                              {ships.map(ship => (
                                <option key={ship.id} value={ship.name}>{ship.name}</option>
                              ))}
                              <option value="-">-</option>
                            </select>
                          </div>

                          {/* Status Filter */}
                          <div className="flex items-center space-x-2 min-w-[160px]">
                            <label className="text-sm font-medium text-gray-700 whitespace-nowrap">
                              {language === 'vi' ? 'Tr·∫°ng th√°i:' : 'Status:'}
                            </label>
                            <select 
                              value={crewFilters?.status || 'All'}
                              onChange={(e) => {
                                const newFilters = {...crewFilters, status: e.target.value};
                                setCrewFilters(newFilters);
                                // Backend filtering will be handled by useEffect
                              }}
                              className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                            >
                              <option value="All">{language === 'vi' ? 'T·∫•t c·∫£' : 'All'}</option>
                              <option value="Sign on">{language === 'vi' ? 'ƒêang l√†m vi·ªác' : 'Sign on'}</option>
                              <option value="Standby">{language === 'vi' ? 'Ch·ªù' : 'Standby'}</option>
                              <option value="Leave">{language === 'vi' ? 'Ngh·ªâ ph√©p' : 'Leave'}</option>
                            </select>
                          </div>

                          {/* Search Field */}
                          <div className="flex items-center space-x-2 min-w-[200px] max-w-[280px]">
                            <label className="text-sm font-medium text-gray-700 whitespace-nowrap">
                              {language === 'vi' ? 'T√¨m ki·∫øm:' : 'Search:'}
                            </label>
                            <div className="relative flex-1">
                              <input
                                type="text"
                                placeholder={language === 'vi' ? 'T√¨m theo t√™n thuy·ªÅn vi√™n...' : 'Search by crew name...'}
                                value={crewFilters?.search || ''}
                                onChange={(e) => setCrewFilters({...crewFilters, search: e.target.value})}
                                className="w-full px-3 py-2 pl-10 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                              />
                              <span className="absolute left-3 top-2.5 text-gray-400">üîç</span>
                            </div>
                          </div>

                          {/* Results Count */}
                          <div className="flex items-center ml-auto">
                            <p className="text-sm text-gray-600 whitespace-nowrap">
                              {language === 'vi' ? 'Hi·ªÉn th·ªã' : 'Showing'} <span className="font-semibold">{filteredCrewData.length}/{crewList.length}</span> {language === 'vi' ? 'thuy·ªÅn vi√™n' : 'crew members'}
                              <span className="ml-2 text-green-600">‚úì <span className="font-semibold">{filteredCrewData.filter(crew => crew.status === 'Sign on').length}</span> {language === 'vi' ? 'ƒëang l√†m vi·ªác' : 'working'}</span>
                            </p>
                          </div>
                        </div>
                      </div>

                      {/* Crew List Table */}
                      <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <div className="overflow-x-auto">
                          <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                              <tr>
                                <th className="px-3 py-3 text-left text-sm font-bold text-gray-700 tracking-wider border-r border-gray-200">
                                  <div className="flex items-center space-x-2">
                                    <input
                                      type="checkbox"
                                      checked={filteredCrewData.length > 0 && filteredCrewData.every(crew => selectedCrewMembers.has(crew.id))}
                                      onChange={(e) => handleSelectAllCrewMembers(e.target.checked)}
                                      className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                    />
                                    <span>{language === 'vi' ? 'STT' : 'No.'}</span>
                                  </div>
                                </th>
                                <th 
                                  onClick={() => handleCrewSort('full_name')}
                                  className="px-4 py-3 text-left text-sm font-bold text-gray-700 tracking-wider border-r border-gray-200 cursor-pointer hover:bg-gray-100"
                                >
                                  {language === 'vi' ? 'H·ªç t√™n' : 'Full Name'}
                                  {getCrewSortIcon('full_name')}
                                </th>
                                <th 
                                  onClick={() => handleCrewSort('sex')}
                                  className="px-3 py-3 text-left text-sm font-bold text-gray-700 tracking-wider border-r border-gray-200 cursor-pointer hover:bg-gray-100"
                                >
                                  {language === 'vi' ? 'Gi·ªõi t√≠nh' : 'Sex'}
                                  {getCrewSortIcon('sex')}
                                </th>
                                <th 
                                  onClick={() => handleCrewSort('rank')}
                                  className="px-4 py-3 text-left text-sm font-bold text-gray-700 tracking-wider border-r border-gray-200 cursor-pointer hover:bg-gray-100"
                                >
                                  {language === 'vi' ? 'Ch·ª©c v·ª•' : 'Rank'}
                                  {getCrewSortIcon('rank')}
                                </th>
                                <th 
                                  onClick={() => handleCrewSort('date_of_birth')}
                                  className="px-4 py-3 text-left text-sm font-bold text-gray-700 tracking-wider border-r border-gray-200 cursor-pointer hover:bg-gray-100"
                                >
                                  {language === 'vi' ? 'Ng√†y sinh' : 'Date of Birth'}
                                  {getCrewSortIcon('date_of_birth')}
                                </th>
                                <th 
                                  onClick={() => handleCrewSort('place_of_birth')}
                                  className="px-4 py-3 text-left text-sm font-bold text-gray-700 tracking-wider border-r border-gray-200 cursor-pointer hover:bg-gray-100"
                                >
                                  {language === 'vi' ? 'N∆°i sinh' : 'Place of Birth'}
                                  {getCrewSortIcon('place_of_birth')}
                                </th>
                                <th 
                                  onClick={() => handleCrewSort('passport')}
                                  className="px-4 py-3 text-left text-sm font-bold text-gray-700 tracking-wider border-r border-gray-200 cursor-pointer hover:bg-gray-100"
                                >
                                  {language === 'vi' ? 'H·ªô chi·∫øu' : 'Passport'}
                                  {getCrewSortIcon('passport')}
                                </th>
                                {/* Seamen Book column - Hidden as requested
                                <th className="px-4 py-3 text-left text-sm font-bold text-gray-700 tracking-wider border-r border-gray-200">
                                  {language === 'vi' ? 'S·ªï thuy·ªÅn vi√™n' : 'Seaman Book'}
                                </th>
                                */}
                                <th 
                                  onClick={() => handleCrewSort('status')}
                                  className="px-3 py-3 text-left text-sm font-bold text-gray-700 tracking-wider border-r border-gray-200 cursor-pointer hover:bg-gray-100"
                                >
                                  {language === 'vi' ? 'Tr·∫°ng th√°i' : 'Status'}
                                  {getCrewSortIcon('status')}
                                </th>
                                <th 
                                  onClick={() => handleCrewSort('ship_sign_on')}
                                  className="px-4 py-3 text-left text-sm font-bold text-gray-700 tracking-wider border-r border-gray-200 cursor-pointer hover:bg-gray-100"
                                >
                                  {language === 'vi' ? 'T√†u ƒëƒÉng k√Ω' : 'Ship Sign On'}
                                  {getCrewSortIcon('ship_sign_on')}
                                </th>
                                <th 
                                  onClick={() => handleCrewSort('place_sign_on')}
                                  className="px-4 py-3 text-left text-sm font-bold text-gray-700 tracking-wider border-r border-gray-200 cursor-pointer hover:bg-gray-100"
                                >
                                  {language === 'vi' ? 'N∆°i xu·ªëng t√†u' : 'Place Sign On'}
                                  {getCrewSortIcon('place_sign_on')}
                                </th>
                                <th 
                                  onClick={() => handleCrewSort('date_sign_on')}
                                  className="px-4 py-3 text-left text-sm font-bold text-gray-700 tracking-wider border-r border-gray-200 cursor-pointer hover:bg-gray-100"
                                >
                                  {language === 'vi' ? 'Ng√†y xu·ªëng t√†u' : 'Date Sign On'}
                                  {getCrewSortIcon('date_sign_on')}
                                </th>
                                <th 
                                  onClick={() => handleCrewSort('date_sign_off')}
                                  className="px-4 py-3 text-left text-sm font-bold text-gray-700 tracking-wider cursor-pointer hover:bg-gray-100"
                                >
                                  {language === 'vi' ? 'Ng√†y r·ªùi t√†u' : 'Date Sign Off'}
                                  {getCrewSortIcon('date_sign_off')}
                                </th>
                              </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                              {sortedCrewData.length > 0 ? (
                                sortedCrewData.map((crew, index) => (
                                  <tr 
                                    key={crew.id} 
                                    className="hover:bg-gray-50 cursor-pointer"
                                    onContextMenu={(e) => handleCrewRightClick(e, crew)}
                                    onDoubleClick={() => handleCrewNameDoubleClick(crew)}
                                    title={language === 'vi' ? 'Nh·∫•p ƒë√∫p ƒë·ªÉ xem ch·ª©ng ch·ªâ | Chu·ªôt ph·∫£i ƒë·ªÉ x√≥a thuy·ªÅn vi√™n' : 'Double-click to view certificates | Right-click to delete crew member'}
                                  >
                                    <td className="px-3 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200">
                                      <div className="flex items-center space-x-2">
                                        <input
                                          type="checkbox"
                                          checked={selectedCrewMembers.has(crew.id)}
                                          onChange={() => handleSelectCrewMember(crew.id)}
                                          className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                          onClick={(e) => e.stopPropagation()}
                                        />
                                        <span>{index + 1}</span>
                                      </div>
                                    </td>
                                    <td 
                                      className="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900 border-r border-gray-200 uppercase"
                                      title={crew.full_name ? 
                                        (language === 'vi' 
                                          ? `T√™n ti·∫øng Vi·ªát: ${crew.full_name}${crew.full_name_en ? ` | T√™n ti·∫øng Anh: ${crew.full_name_en}` : ''}`
                                          : `Vietnamese Name: ${crew.full_name}${crew.full_name_en ? ` | English Name: ${crew.full_name_en}` : ''}`
                                        ) : ''
                                      }
                                    >
                                      {language === 'vi' ? crew.full_name : (crew.full_name_en || crew.full_name)}
                                    </td>
                                    <td className="px-3 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200">
                                      {crew.sex}
                                    </td>
                                    <td 
                                      className="px-4 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200 cursor-pointer hover:bg-gray-50"
                                      onContextMenu={(e) => handleRankRightClick(e, crew)}
                                      title={language === 'vi' ? 'Chu·ªôt ph·∫£i ƒë·ªÉ thay ƒë·ªïi rank' : 'Right-click to change rank'}
                                    >
                                      {crew.rank || '-'}
                                    </td>
                                    <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200">
                                      {formatDateDisplay(crew.date_of_birth) || '-'}
                                    </td>
                                    <td 
                                      className="px-4 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200 uppercase hover:bg-yellow-50"
                                      title={crew.nationality ? 
                                        (language === 'vi' ? `Qu·ªëc t·ªãch: ${crew.nationality}` : `Nationality: ${crew.nationality}`) : 
                                        (language === 'vi' ? 'Ch∆∞a c√≥ th√¥ng tin qu·ªëc t·ªãch' : 'No nationality information')
                                      }
                                    >
                                      {language === 'vi' ? crew.place_of_birth : (crew.place_of_birth_en || crew.place_of_birth)}
                                    </td>
                                    <td 
                                      className="px-4 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200 cursor-context-menu hover:bg-blue-50"
                                      onContextMenu={(e) => handlePassportRightClick(e, crew)}
                                      title={crew.passport ? 
                                        (crew.passport_expiry_date ? 
                                          (language === 'vi' ? `H·∫°n h·ªô chi·∫øu: ${formatDateDisplay(crew.passport_expiry_date)} | Chu·ªôt ph·∫£i ƒë·ªÉ xem h·ªô chi·∫øu` : `Passport Expiry: ${formatDateDisplay(crew.passport_expiry_date)} | Right-click for options`) :
                                          (language === 'vi' ? 'Ch∆∞a c√≥ th√¥ng tin h·∫°n h·ªô chi·∫øu | Chu·ªôt ph·∫£i ƒë·ªÉ xem h·ªô chi·∫øu' : 'No expiry information | Right-click for options')
                                        ) : ''
                                      }
                                    >
                                      <div className="flex items-center space-x-2">
                                        <span>{crew.passport || '-'}</span>
                                        {/* File status indicators */}
                                        {crew.passport_file_id && (
                                          <span 
                                            className="text-green-500 text-xs cursor-pointer hover:text-green-600" 
                                            title={`${language === 'vi' ? 'File g·ªëc' : 'Original file'}\nüìÅ ${getPassportFileLocation(crew)}`}
                                            onClick={(e) => {
                                              e.stopPropagation(); // Prevent row context menu
                                              if (crew.passport_file_id) {
                                                window.open(`https://drive.google.com/file/d/${crew.passport_file_id}/view`, '_blank');
                                              }
                                            }}
                                          >
                                            üìÑ
                                          </span>
                                        )}
                                        {crew.summary_file_id && (
                                          <span 
                                            className="text-blue-500 text-xs cursor-pointer hover:text-blue-600" 
                                            title={`${language === 'vi' ? 'File t√≥m t·∫Øt' : 'Summary file'}\nüìÅ ${crew.ship_sign_on || selectedShip?.name || 'Unknown'}/Passport`}
                                            onClick={(e) => {
                                              e.stopPropagation(); // Prevent row context menu
                                              if (crew.summary_file_id) {
                                                window.open(`https://drive.google.com/file/d/${crew.summary_file_id}/view`, '_blank');
                                              }
                                            }}
                                          >
                                            üìã
                                          </span>
                                        )}
                                      </div>
                                    </td>
                                    {/* Seamen Book column - Hidden as requested
                                    <td 
                                      className="px-4 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200 cursor-context-menu hover:bg-green-50"
                                      onContextMenu={(e) => handleSeamenBookRightClick(e, crew)}
                                      title={crew.seamen_book && crew.seamen_book !== '-' ? (language === 'vi' ? 'Chu·ªôt ph·∫£i ƒë·ªÉ xem s·ªï thuy·ªÅn vi√™n' : 'Right-click for seamen book options') : ''}
                                    >
                                      {crew.seamen_book || '-'}
                                    </td>
                                    */}
                                    <td className="px-3 py-4 whitespace-nowrap border-r border-gray-200">
                                      <span className={`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                        crew.status === 'Sign on' ? 'bg-green-100 text-green-800' :
                                        crew.status === 'Standby' ? 'bg-yellow-100 text-yellow-800' :
                                        crew.status === 'Leave' ? 'bg-red-100 text-red-800' :
                                        'bg-gray-100 text-gray-800'
                                      }`}>
                                        {crew.status}
                                      </span>
                                    </td>
                                    <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200">
                                      {crew.ship_sign_on}
                                    </td>
                                    <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200">
                                      {crew.place_sign_on || '-'}
                                    </td>
                                    <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200">
                                      {formatDateDisplay(crew.date_sign_on) || '-'}
                                    </td>
                                    <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                                      {formatDateDisplay(crew.date_sign_off) || '-'}
                                    </td>
                                  </tr>
                                ))
                              ) : (
                                // Empty State
                                <tr>
                                  <td colSpan="13" className="px-6 py-12 text-center">
                                    <div className="text-gray-400 text-lg mb-2">üë•</div>
                                    <p className="text-gray-500">
                                      {language === 'vi' ? 'Kh√¥ng t√¨m th·∫•y thuy·ªÅn vi√™n ph√π h·ª£p' : 'No crew members found'}
                                    </p>
                                    <p className="text-sm text-gray-400 mt-1">
                                      {language === 'vi' ? 'Th·ª≠ thay ƒë·ªïi b·ªô l·ªçc ho·∫∑c th√™m thuy·ªÅn vi√™n m·ªõi' : 'Try changing filters or add new crew members'}
                                    </p>
                                  </td>
                                </tr>
                              )}
                            </tbody>
                          </table>
                        </div>
                      </div>

                      {/* Summary Statistics */}
                      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                          <div className="text-2xl font-bold text-blue-600">4</div>
                          <div className="text-sm text-blue-700">
                            {language === 'vi' ? 'T·ªïng thuy·ªÅn vi√™n' : 'Total Crew'}
                          </div>
                        </div>
                        <div className="bg-green-50 rounded-lg p-4 border border-green-200">
                          <div className="text-2xl font-bold text-green-600">3</div>
                          <div className="text-sm text-green-700">
                            {language === 'vi' ? 'ƒêang ho·∫°t ƒë·ªông' : 'Active'}
                          </div>
                        </div>
                        <div className="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
                          <div className="text-2xl font-bold text-yellow-600">1</div>
                          <div className="text-sm text-yellow-700">
                            {language === 'vi' ? 'Ngh·ªâ ph√©p' : 'On Leave'}
                          </div>
                        </div>
                        <div className="bg-gray-50 rounded-lg p-4 border border-gray-200">
                          <div className="text-2xl font-bold text-gray-600">0</div>
                          <div className="text-sm text-gray-700">
                            {language === 'vi' ? 'Ch∆∞a ph√¢n c√¥ng' : 'Unassigned'}
                          </div>
                        </div>
                      </div>

                      {/* Crew Context Menu */}
                      {crewContextMenu.show && (
                        <div 
                          className="fixed bg-white border border-gray-200 rounded-lg shadow-lg z-[100]"
                          style={{
                            position: 'fixed',
                            top: `${crewContextMenu.y}px`,
                            left: `${crewContextMenu.x}px`,
                            minWidth: '180px'
                          }}
                        >
                          <div className="py-1">
                            {selectedCrewMembers.size > 1 && (
                              <div className="px-4 py-2 text-xs font-semibold text-gray-500 border-b border-gray-200">
                                {selectedCrewMembers.size} {language === 'vi' ? 'thuy·ªÅn vi√™n ƒë√£ ch·ªçn' : 'crew members selected'}
                              </div>
                            )}
                            
                            {selectedCrewMembers.size === 1 && (
                              <button
                                onClick={() => handleEditCrew(crewContextMenu.crew)}
                                className="w-full text-left px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 flex items-center"
                              >
                                <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                                {language === 'vi' ? 'Ch·ªânh s·ª≠a thuy·ªÅn vi√™n' : 'Edit Crew'}
                              </button>
                            )}
                            
                            {/* Edit Place Sign On option - available for multiple crew selection */}
                            {selectedCrewMembers.size > 0 && (
                              <button
                                onClick={handleBulkEditPlaceSignOn}
                                className="w-full text-left px-4 py-2 text-sm text-blue-700 hover:bg-blue-50 flex items-center"
                              >
                                <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                {language === 'vi' ? 'Ch·ªânh s·ª≠a n∆°i xu·ªëng t√†u' : 'Edit Place Sign On'}
                              </button>
                            )}
                            
                            {/* Edit Ship Sign On option - available for multiple crew selection */}
                            {selectedCrewMembers.size > 0 && (
                              <button
                                onClick={handleBulkEditShipSignOn}
                                className="w-full text-left px-4 py-2 text-sm text-purple-700 hover:bg-purple-50 flex items-center"
                              >
                                {/* Ship Icon */}
                                <svg className="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 24 24">
                                  <path d="M20 21c-1.39 0-2.78-.47-4-1.32-2.44 1.71-5.56 1.71-8 0C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 2.52 1.29 5.48 1.29 8 0 1.26.65 2.62.99 4 .99h2v-2h-2zM3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.32-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19zM6 6h12v3.97L12 8 6 9.97V6z"/>
                                </svg>
                                {language === 'vi' ? 'Ch·ªânh s·ª≠a t√†u ƒëƒÉng k√Ω' : 'Edit Ship Sign On'}
                              </button>
                            )}
                            
                            {/* Edit Date Sign On option - available for multiple crew selection */}
                            {selectedCrewMembers.size > 0 && (
                              <button
                                onClick={handleBulkEditDateSignOn}
                                className="w-full text-left px-4 py-2 text-sm text-green-700 hover:bg-green-50 flex items-center"
                              >
                                {/* Ship with Arrow IN (Sign On) */}
                                <svg className="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 24 24">
                                  <g>
                                    {/* Ship body */}
                                    <path d="M20 21c-1.39 0-2.78-.47-4-1.32-2.44 1.71-5.56 1.71-8 0C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 2.52 1.29 5.48 1.29 8 0 1.26.65 2.62.99 4 .99h2v-2h-2zM3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.32-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19zM6 6h12v3.97L12 8 6 9.97V6z"/>
                                    {/* Arrow pointing IN/RIGHT */}
                                    <path d="M19 8l-4 4h3c0 2.2-1.8 4-4 4v2c3.3 0 6-2.7 6-6h3l-4-4z" opacity="0.9"/>
                                  </g>
                                </svg>
                                {language === 'vi' ? 'Ch·ªânh s·ª≠a ng√†y l√™n t√†u' : 'Edit Date Sign On'}
                              </button>
                            )}
                            
                            {/* Edit Date Sign Off option - available for multiple crew selection */}
                            {selectedCrewMembers.size > 0 && (
                              <button
                                onClick={handleBulkEditDateSignOff}
                                className="w-full text-left px-4 py-2 text-sm text-orange-700 hover:bg-orange-50 flex items-center"
                              >
                                {/* Ship with Arrow OUT (Sign Off) */}
                                <svg className="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 24 24">
                                  <g>
                                    {/* Ship body */}
                                    <path d="M20 21c-1.39 0-2.78-.47-4-1.32-2.44 1.71-5.56 1.71-8 0C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 2.52 1.29 5.48 1.29 8 0 1.26.65 2.62.99 4 .99h2v-2h-2zM3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.32-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19zM6 6h12v3.97L12 8 6 9.97V6z"/>
                                    {/* Arrow pointing OUT/LEFT */}
                                    <path d="M5 8l4 4H6c0 2.2 1.8 4 4 4v2c-3.3 0-6-2.7-6-6H1l4-4z" opacity="0.9"/>
                                  </g>
                                </svg>
                                {language === 'vi' ? 'Ch·ªânh s·ª≠a ng√†y r·ªùi t√†u' : 'Edit Date Sign Off'}
                              </button>
                            )}
                            
                            <button
                              onClick={handleDeleteSelectedCrewMembers}
                              className="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center"
                            >
                              <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                              </svg>
                              {selectedCrewMembers.size > 1 
                                ? (language === 'vi' ? `X√≥a ${selectedCrewMembers.size} thuy·ªÅn vi√™n` : `Delete ${selectedCrewMembers.size} crew members`)
                                : (language === 'vi' ? 'X√≥a thuy·ªÅn vi√™n' : 'Delete Crew')
                              }
                            </button>
                          </div>
                        </div>
                      )}

                      {/* Passport Context Menu */}
                      {passportContextMenu.show && (
                        <div 
                          className="fixed bg-white border border-gray-200 rounded-lg shadow-lg z-[100]"
                          style={{
                            position: 'fixed',
                            top: `${passportContextMenu.y}px`,
                            left: `${passportContextMenu.x}px`,
                            minWidth: '180px'
                          }}
                        >
                          <div className="py-1">
                            <div className="px-4 py-2 text-xs font-semibold text-gray-500 border-b border-gray-200">
                              {passportContextMenu.crew?.full_name} - {passportContextMenu.crew?.passport}
                            </div>
                            
                            <button
                              onClick={() => handleViewPassport(passportContextMenu.crew)}
                              className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center"
                            >
                              <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                              </svg>
                              {selectedCrewMembers.size > 0 
                                ? (language === 'vi' 
                                  ? `Xem file h·ªô chi·∫øu g·ªëc (${selectedCrewMembers.size} thuy·ªÅn vi√™n)` 
                                  : `View Original Passport (${selectedCrewMembers.size} crew)`)
                                : (language === 'vi' ? 'Xem file h·ªô chi·∫øu g·ªëc' : 'View Original Passport')
                              }
                              {passportContextMenu.crew?.passport_file_id && selectedCrewMembers.size === 0 && (
                                <span className="ml-auto text-xs bg-green-100 text-green-600 px-1 rounded">üìÑ</span>
                              )}
                            </button>
                            
                            <button
                              onClick={() => handleCopyPassportLink(passportContextMenu.crew)}
                              className="w-full text-left px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 flex items-center"
                            >
                              <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                              </svg>
                              {selectedCrewMembers.size > 0 
                                ? (language === 'vi' 
                                  ? `Sao ch√©p link file g·ªëc (${selectedCrewMembers.size} thuy·ªÅn vi√™n)` 
                                  : `Copy Original File Link (${selectedCrewMembers.size} crew)`)
                                : (language === 'vi' ? 'Sao ch√©p link file g·ªëc' : 'Copy Original File Link')
                              }
                              {passportContextMenu.crew?.passport_file_id && selectedCrewMembers.size === 0 && (
                                <span className="ml-auto text-xs bg-blue-100 text-blue-600 px-1 rounded">üîó</span>
                              )}
                            </button>
                            
                            <button
                              onClick={() => handleDownloadPassport(passportContextMenu.crew)}
                              className="w-full text-left px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 flex items-center"
                            >
                              <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                              </svg>
                              {selectedCrewMembers.size > 0 
                                ? (language === 'vi' 
                                  ? `T·∫£i xu·ªëng file g·ªëc (${selectedCrewMembers.size} thuy·ªÅn vi√™n)` 
                                  : `Download Original (${selectedCrewMembers.size} crew)`)
                                : (language === 'vi' ? 'T·∫£i xu·ªëng file g·ªëc' : 'Download Original')
                              }
                              {passportContextMenu.crew?.passport_file_id && selectedCrewMembers.size === 0 && (
                                <span className="ml-auto text-xs bg-blue-100 text-blue-600 px-1 rounded">üì•</span>
                              )}
                            </button>
                            
                            {/* Automatic Rename option - works for single or multiple selected crew */}
                            {(passportContextMenu.crew?.passport_file_id || passportContextMenu.crew?.summary_file_id || selectedCrewMembers.size > 0) && (
                              <button
                                onClick={() => handleAutomaticRenamePassportFiles(passportContextMenu.crew)}
                                className="w-full text-left px-4 py-2 text-sm text-purple-600 hover:bg-purple-50 flex items-center"
                              >
                                <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                {selectedCrewMembers.size > 0 
                                  ? (language === 'vi' 
                                    ? `T·ª± ƒë·ªông ƒë·ªïi t√™n file (${selectedCrewMembers.size} thuy·ªÅn vi√™n)` 
                                    : `Automatic Rename Files (${selectedCrewMembers.size} crew)`)
                                  : (language === 'vi' ? 'T·ª± ƒë·ªông ƒë·ªïi t√™n file' : 'Automatic Rename Files')
                                }
                                <span className="ml-auto text-xs bg-purple-100 text-purple-600 px-1 rounded">‚ö°</span>
                              </button>
                            )}
                          </div>
                        </div>
                      )}

                      {/* Seamen Book Context Menu - Hidden as Seamen Book column is hidden
                      {seamenBookContextMenu.show && (
                        <div 
                          className="fixed bg-white border border-gray-200 rounded-lg shadow-lg z-[100]"
                          style={{
                            position: 'fixed',
                            top: `${seamenBookContextMenu.y}px`,
                            left: `${seamenBookContextMenu.x}px`,
                            minWidth: '180px'
                          }}
                        >
                          <div className="py-1">
                            <div className="px-4 py-2 text-xs font-semibold text-gray-500 border-b border-gray-200">
                              {seamenBookContextMenu.crew?.full_name} - {seamenBookContextMenu.crew?.seamen_book}
                            </div>
                            
                            <button
                              onClick={() => handleViewSeamenBook(seamenBookContextMenu.crew)}
                              className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center"
                            >
                              <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                              </svg>
                              {language === 'vi' ? 'Xem s·ªï thuy·ªÅn vi√™n' : 'View Seamen Book'}
                            </button>
                            
                            <button
                              onClick={() => handleCopySeamenBookLink(seamenBookContextMenu.crew)}
                              className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center"
                            >
                              <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                              </svg>
                              {language === 'vi' ? 'Sao ch√©p link' : 'Copy Link'}
                            </button>
                            
                            <button
                              onClick={() => handleDownloadSeamenBook(seamenBookContextMenu.crew)}
                              className="w-full text-left px-4 py-2 text-sm text-green-600 hover:bg-green-50 flex items-center"
                            >
                              <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                              </svg>
                              {language === 'vi' ? 'T·∫£i xu·ªëng' : 'Download'}
                            </button>
                          </div>
                        </div>
                      )}
                      */}

                      {/* Rank Context Menu */}
                      {rankContextMenu.show && (
                        <div 
                          className="fixed bg-white border border-gray-200 rounded-lg shadow-lg z-[100]"
                          style={{
                            position: 'fixed',
                            top: `${rankContextMenu.y}px`,
                            left: `${rankContextMenu.x}px`,
                            minWidth: '200px',
                            maxHeight: '300px',
                            overflowY: 'auto'
                          }}
                        >
                          <div className="py-1">
                            <div className="px-4 py-2 text-xs font-semibold text-gray-500 border-b border-gray-200">
                              {rankContextMenu.crew?.full_name} - {language === 'vi' ? 'Ch·ªçn Rank' : 'Select Rank'}
                            </div>
                            
                            {RANK_OPTIONS.map((rank) => (
                              <button
                                key={rank.value}
                                onClick={() => handleRankUpdate(rank.value)}
                                className={`w-full text-left px-4 py-2 text-sm hover:bg-blue-50 flex items-center justify-between ${
                                  rankContextMenu.crew?.rank === rank.value 
                                    ? 'bg-blue-100 text-blue-700 font-medium' 
                                    : 'text-gray-700'
                                }`}
                              >
                                <span className="flex items-center">
                                  <span className="w-2 h-2 rounded-full mr-3 bg-blue-500"></span>
                                  <span className="font-mono text-sm mr-2">{rank.value}</span>
                                  <span className="text-xs text-gray-500">
                                    {language === 'vi' ? rank.label_vi : rank.label_en}
                                  </span>
                                </span>
                                {rankContextMenu.crew?.rank === rank.value && (
                                  <svg className="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                  </svg>
                                )}
                              </button>
                            ))}
                          </div>
                        </div>
                      )}
                        </>
                      ) : (
                        /* Crew Certificates View */
                        <>
                          {/* Header with Back Button */}
                          <div className="flex justify-between items-center">
                            <div className="flex items-center space-x-4">
                              <button
                                onClick={handleBackToCrewList}
                                className="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-all flex items-center"
                                title={language === 'vi' ? 'Quay l·∫°i danh s√°ch thuy·ªÅn vi√™n' : 'Back to crew list'}
                              >
                                <span className="mr-2">‚Üê</span>
                                {language === 'vi' ? 'Quay l·∫°i danh s√°ch thuy·ªÅn vi√™n' : 'Back to Crew List'}
                              </button>
                              <div>
                                <h3 className="text-lg font-semibold text-gray-800 mb-1">
                                  {language === 'vi' ? 'Ch·ª©ng ch·ªâ thuy·ªÅn vi√™n' : 'Crew Certificates'}
                                </h3>
                                <p className="text-sm text-gray-600">
                                  {(() => {
                                    // If crew filter is active, show filtered crew name
                                    if (certFilters.crewName !== 'all') {
                                      const filteredCrew = crewList.find(c => c.full_name === certFilters.crewName);
                                      const displayName = language === 'en' && filteredCrew?.full_name_en 
                                        ? filteredCrew.full_name_en 
                                        : certFilters.crewName;
                                      
                                      return language === 'vi' 
                                        ? `Qu·∫£n l√Ω ch·ª©ng ch·ªâ thuy·ªÅn vi√™n: ${displayName}` 
                                        : `Manage Crew Cert for: ${displayName}`;
                                    }
                                    
                                    // When filter is "All", show ship name
                                    if (selectedShip) {
                                      return language === 'vi' 
                                        ? `Qu·∫£n l√Ω ch·ª©ng ch·ªâ thuy·ªÅn vi√™n c·ªßa t√†u: ${selectedShip.name}` 
                                        : `Manage Crew Cert for: ${selectedShip.name}`;
                                    }
                                    
                                    return language === 'vi' ? 'T·∫•t c·∫£ ch·ª©ng ch·ªâ thuy·ªÅn vi√™n' : 'All Crew certificates';
                                  })()}
                                </p>
                              </div>
                            </div>
                            {/* Action Buttons */}
                            <div className="flex items-center space-x-3">
                              {console.log('üë§ User role check:', { user, role: user?.role, canAdd: user && (user.role === 'manager' || user.role === 'admin' || user.role === 'super_admin') })}
                              {user && (user.role === 'manager' || user.role === 'admin' || user.role === 'super_admin') && (
                                <button 
                                  onClick={handleOpenAddCrewCertModal}
                                  className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all flex items-center"
                                >
                                  <span className="mr-2">üìú</span>
                                  {language === 'vi' ? 'Th√™m ch·ª©ng ch·ªâ thuy·ªÅn vi√™n' : 'Add Crew Cert'}
                                </button>
                              )}
                              {/* Refresh button - fetches all certificates for ship */}
                              <button 
                                id="crew-cert-refresh-btn"
                                onClick={() => fetchCrewCertificates(null)}
                                className="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-all flex items-center"
                                title={language === 'vi' ? 'L√†m m·ªõi' : 'Refresh'}
                              >
                                <span className="mr-2">üîÑ</span>
                                {language === 'vi' ? 'L√†m m·ªõi' : 'Refresh'}
                              </button>
                            </div>
                          </div>

                          {/* Search Bar and Filters - All in One Row */}
                          <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                            <div className="flex items-center space-x-4 flex-wrap">
                              {/* Search */}
                              <div className="flex items-center space-x-2">
                                <label className="text-sm text-gray-600 whitespace-nowrap">
                                  {language === 'vi' ? 'üîç T√¨m ki·∫øm:' : 'üîç Search:'}
                                </label>
                                <div className="relative w-64">
                                  <input
                                    type="text"
                                    placeholder={language === 'vi' ? 'T√™n ch·ª©ng ch·ªâ, s·ªë...' : 'Cert name, no...'}
                                    value={certificatesSearch}
                                    onChange={(e) => setCertificatesSearch(e.target.value)}
                                    className="w-full px-3 py-1.5 pl-10 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                  />
                                  <span className="absolute left-3 top-2 text-gray-400">üîç</span>
                                </div>
                              </div>
                              
                              {/* Divider */}
                              <div className="h-8 w-px bg-gray-300"></div>
                              
                              {/* Ship Sign On Filter */}
                              <div className="flex items-center space-x-2">
                                  <label className="text-sm text-gray-600 whitespace-nowrap">
                                    {language === 'vi' ? 'T√†u:' : 'Ship:'}
                                  </label>
                                  <select
                                    value={certFilters.shipSignOn}
                                    onChange={(e) => setCertFilters({...certFilters, shipSignOn: e.target.value})}
                                    className="px-3 py-1.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm bg-white"
                                  >
                                    <option value="all">{language === 'vi' ? 'T·∫•t c·∫£' : 'All'}</option>
                                    {(() => {
                                      // Get unique ship sign on values from certificates via crew lookup
                                      const shipSignOnSet = new Set();
                                      crewCertificates.forEach(cert => {
                                        const shipStatus = getCertificateShipStatus(cert);
                                        if (shipStatus.isStandby) {
                                          shipSignOnSet.add('-');
                                        } else {
                                          shipSignOnSet.add(shipStatus.ship);
                                        }
                                      });
                                      
                                      // Convert to array and sort: "-" first, then ships alphabetically
                                      const shipSignOnArray = Array.from(shipSignOnSet).sort((a, b) => {
                                        if (a === '-') return -1;
                                        if (b === '-') return 1;
                                        return a.localeCompare(b);
                                      });
                                      
                                      return shipSignOnArray.map(shipSignOn => (
                                        <option key={shipSignOn} value={shipSignOn}>
                                          {shipSignOn === '-' ? (language === 'vi' ? 'Standby' : 'Standby') : shipSignOn}
                                        </option>
                                      ));
                                    })()}
                                  </select>
                                </div>
                              
                              {/* Crew Name Filter */}
                              <div className="flex items-center space-x-2">
                                  <label className="text-sm text-gray-600 whitespace-nowrap">
                                    {language === 'vi' ? 'Thuy·ªÅn vi√™n:' : 'Crew:'}
                                  </label>
                                  <select
                                    value={certFilters.crewName}
                                    onChange={(e) => setCertFilters({...certFilters, crewName: e.target.value})}
                                    className="px-3 py-1.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm bg-white max-w-xs"
                                  >
                                    <option value="all">{language === 'vi' ? 'T·∫•t c·∫£' : 'All'}</option>
                                    {(() => {
                                      // In Certificates View: Filter crew based on Ship Sign On filter selection
                                      if (showCertificatesView && crewList.length > 0) {
                                        let filteredCrew = crewList;
                                        
                                        // Apply Ship Sign On filter to crew list
                                        if (certFilters.shipSignOn !== 'all') {
                                          filteredCrew = crewList.filter(crew => {
                                            const crewShipSignOn = crew.ship_sign_on || '-';
                                            return crewShipSignOn === certFilters.shipSignOn;
                                          });
                                        }
                                        
                                        // Generate dropdown options from filtered crew
                                        return filteredCrew
                                          .map(crew => ({
                                            value: crew.full_name,
                                            displayName: language === 'en' && crew.full_name_en 
                                              ? crew.full_name_en 
                                              : crew.full_name
                                          }))
                                          .sort((a, b) => a.displayName.localeCompare(b.displayName))
                                          .map(item => (
                                            <option key={item.value} value={item.value}>
                                              {item.displayName}
                                            </option>
                                          ));
                                      }
                                      
                                      // In Crew List View: Filter by selected ship (original logic)
                                      if (selectedShip && crewList.length > 0) {
                                        return crewList
                                          .filter(crew => crew.ship_sign_on === selectedShip.name)
                                          .map(crew => ({
                                            value: crew.full_name,
                                            displayName: language === 'en' && crew.full_name_en ? crew.full_name_en : crew.full_name
                                          }))
                                          .sort((a, b) => a.displayName.localeCompare(b.displayName))
                                          .map(item => (
                                            <option key={item.value} value={item.value}>
                                              {item.displayName}
                                            </option>
                                          ));
                                      }
                                      
                                      // Fallback: get from certificates if no crew list available
                                      return [...new Set(crewCertificates.map(cert => cert.crew_name))]
                                        .sort()
                                        .map(crewName => {
                                          // Find corresponding crew_name_en from certificates
                                          const cert = crewCertificates.find(c => c.crew_name === crewName);
                                          const displayName = language === 'en' && cert?.crew_name_en ? cert.crew_name_en : crewName;
                                          return (
                                            <option key={crewName} value={crewName}>
                                              {displayName}
                                            </option>
                                          );
                                        });
                                    })()}
                                  </select>
                                </div>
                              
                              {/* Status Filter */}
                              <div className="flex items-center space-x-2">
                                  <label className="text-sm text-gray-600 whitespace-nowrap">
                                    {language === 'vi' ? 'Tr·∫°ng th√°i:' : 'Status:'}
                                  </label>
                                  <select
                                    value={certFilters.status}
                                    onChange={(e) => setCertFilters({...certFilters, status: e.target.value})}
                                    className="px-3 py-1.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm bg-white"
                                  >
                                    <option value="all">{language === 'vi' ? 'T·∫•t c·∫£' : 'All'}</option>
                                    <option value="Valid">‚úÖ {language === 'vi' ? 'C√≤n hi·ªáu l·ª±c' : 'Valid'}</option>
                                    <option value="Critical">üü† {language === 'vi' ? 'Kh·∫©n c·∫•p' : 'Critical'}</option>
                                    <option value="Expiring Soon">‚ö†Ô∏è {language === 'vi' ? 'S·∫Øp h·∫øt h·∫°n' : 'Expiring Soon'}</option>
                                    <option value="Expired">‚ùå {language === 'vi' ? 'H·∫øt hi·ªáu l·ª±c' : 'Expired'}</option>
                                    <option value="Unknown">‚ùì {language === 'vi' ? 'Kh√¥ng x√°c ƒë·ªãnh' : 'Unknown'}</option>
                                  </select>
                                </div>
                              
                              {/* Reset Filters Button */}
                              {(certFilters.shipSignOn !== 'all' || certFilters.status !== 'all' || certFilters.crewName !== 'all' || certificatesSearch) && (
                                <button
                                    onClick={() => {
                                      setCertFilters({ shipSignOn: 'all', status: 'all', crewName: 'all' });
                                      setCertificatesSearch('');
                                    }}
                                    className="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-md text-sm flex items-center transition-colors"
                                    title={language === 'vi' ? 'X√≥a b·ªô l·ªçc' : 'Clear filters'}
                                  >
                                    <span className="mr-1">üîÑ</span>
                                    {language === 'vi' ? 'X√≥a b·ªô l·ªçc' : 'Clear'}
                                  </button>
                              )}
                              
                              {/* Results Count */}
                              <div className="flex items-center ml-auto">
                                  <p className="text-sm text-gray-600 whitespace-nowrap">
                                    {language === 'vi' ? 'Hi·ªÉn th·ªã' : 'Showing'} <span className="font-semibold">
                                      {crewCertificates.filter(cert => {
                                        // Apply search filter
                                        if (certificatesSearch) {
                                          const search = certificatesSearch.toLowerCase();
                                          if (!(
                                            cert.crew_name?.toLowerCase().includes(search) ||
                                            cert.cert_name?.toLowerCase().includes(search) ||
                                            cert.cert_no?.toLowerCase().includes(search) ||
                                            cert.issued_by?.toLowerCase().includes(search)
                                          )) return false;
                                        }
                                        
                                        // Apply status filter
                                        if (certFilters.status !== 'all' && cert.status !== certFilters.status) {
                                          return false;
                                        }
                                        
                                        // Apply crew name filter
                                        if (certFilters.crewName !== 'all' && cert.crew_name !== certFilters.crewName) {
                                          // Debug: log filter mismatch
                                          if (certFilters.crewName !== 'all') {
                                            console.log('üîç Crew filter check:', {
                                              filterValue: certFilters.crewName,
                                              certCrewName: cert.crew_name,
                                              match: cert.crew_name === certFilters.crewName
                                            });
                                          }
                                          return false;
                                        }
                                        
                                        return true;
                                      }).length}
                                    </span> / <span className="font-semibold">{crewCertificates.length}</span> {language === 'vi' ? 'ch·ª©ng ch·ªâ' : 'certificates'}
                                  </p>
                              </div>
                            </div>
                          </div>

                          {/* Certificates Table */}
                          <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                            <div className="overflow-x-auto">
                              <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                  <tr>
                                    {/* Checkbox Column for Select All */}
                                    <th className="px-3 py-3 text-center border-r border-gray-200">
                                      <input
                                        type="checkbox"
                                        checked={
                                          crewCertificates.filter(cert => {
                                            // Apply same filters as the table
                                            if (certificatesSearch) {
                                              const search = certificatesSearch.toLowerCase();
                                              if (!(
                                                cert.crew_name?.toLowerCase().includes(search) ||
                                                cert.cert_name?.toLowerCase().includes(search) ||
                                                cert.cert_no?.toLowerCase().includes(search) ||
                                                cert.issued_by?.toLowerCase().includes(search)
                                              )) return false;
                                            }
                                            if (certFilters.status !== 'all' && cert.status !== certFilters.status) return false;
                                            if (certFilters.crewName !== 'all' && cert.crew_name !== certFilters.crewName) return false;
                                            return true;
                                          }).length > 0 && 
                                          crewCertificates.filter(cert => {
                                            // Apply same filters
                                            if (certificatesSearch) {
                                              const search = certificatesSearch.toLowerCase();
                                              if (!(
                                                cert.crew_name?.toLowerCase().includes(search) ||
                                                cert.cert_name?.toLowerCase().includes(search) ||
                                                cert.cert_no?.toLowerCase().includes(search) ||
                                                cert.issued_by?.toLowerCase().includes(search)
                                              )) return false;
                                            }
                                            if (certFilters.status !== 'all' && cert.status !== certFilters.status) return false;
                                            if (certFilters.crewName !== 'all' && cert.crew_name !== certFilters.crewName) return false;
                                            return true;
                                          }).every(cert => selectedCrewCertificates.has(cert.id))
                                        }
                                        onChange={(e) => {
                                          const filteredCerts = crewCertificates.filter(cert => {
                                            // Apply same filters
                                            if (certificatesSearch) {
                                              const search = certificatesSearch.toLowerCase();
                                              if (!(
                                                cert.crew_name?.toLowerCase().includes(search) ||
                                                cert.cert_name?.toLowerCase().includes(search) ||
                                                cert.cert_no?.toLowerCase().includes(search) ||
                                                cert.issued_by?.toLowerCase().includes(search)
                                              )) return false;
                                            }
                                            if (certFilters.status !== 'all' && cert.status !== certFilters.status) return false;
                                            if (certFilters.crewName !== 'all' && cert.crew_name !== certFilters.crewName) return false;
                                            return true;
                                          });
                                          handleSelectAllCrewCertificates(e.target.checked, filteredCerts);
                                        }}
                                        className="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer"
                                      />
                                    </th>
                                    <th className="px-3 py-3 text-left text-sm font-bold text-gray-700 tracking-wider border-r border-gray-200">
                                      {language === 'vi' ? 'STT' : 'No.'}
                                    </th>
                                    <th 
                                      onClick={() => handleCertificateSort('crew_name')}
                                      className="px-4 py-3 text-left text-sm font-bold text-gray-700 tracking-wider border-r border-gray-200 cursor-pointer hover:bg-gray-100"
                                    >
                                      {language === 'vi' ? 'T√™n thuy·ªÅn vi√™n' : 'Crew Name'}
                                      {getCertificateSortIcon('crew_name')}
                                    </th>
                                    <th 
                                      onClick={() => handleCertificateSort('ship_status')}
                                      className="px-4 py-3 text-left text-sm font-bold text-gray-700 tracking-wider border-r border-gray-200 cursor-pointer hover:bg-gray-100"
                                    >
                                      {language === 'vi' ? 'T√†u / Tr·∫°ng th√°i' : 'Ship / Status'}
                                      {getCertificateSortIcon('ship_status')}
                                    </th>
                                    <th 
                                      onClick={() => handleCertificateSort('rank')}
                                      className="px-4 py-3 text-left text-sm font-bold text-gray-700 tracking-wider border-r border-gray-200 cursor-pointer hover:bg-gray-100"
                                    >
                                      {language === 'vi' ? 'Ch·ª©c danh' : 'Rank'}
                                      {getCertificateSortIcon('rank')}
                                    </th>
                                    <th 
                                      onClick={() => handleCertificateSort('cert_name')}
                                      className="px-4 py-3 text-left text-sm font-bold text-gray-700 tracking-wider border-r border-gray-200 cursor-pointer hover:bg-gray-100"
                                    >
                                      {language === 'vi' ? 'T√™n ch·ª©ng ch·ªâ' : 'Crew Cert Name'}
                                      {getCertificateSortIcon('cert_name')}
                                    </th>
                                    <th 
                                      onClick={() => handleCertificateSort('cert_no')}
                                      className="px-4 py-3 text-left text-sm font-bold text-gray-700 tracking-wider border-r border-gray-200 cursor-pointer hover:bg-gray-100"
                                    >
                                      {language === 'vi' ? 'S·ªë ch·ª©ng ch·ªâ' : 'Crew Cert No.'}
                                      {getCertificateSortIcon('cert_no')}
                                    </th>
                                    <th 
                                      onClick={() => handleCertificateSort('issued_by')}
                                      className="px-4 py-3 text-left text-sm font-bold text-gray-700 tracking-wider border-r border-gray-200 cursor-pointer hover:bg-gray-100"
                                    >
                                      {language === 'vi' ? 'C∆° quan c·∫•p' : 'Issued By'}
                                      {getCertificateSortIcon('issued_by')}
                                    </th>
                                    <th 
                                      onClick={() => handleCertificateSort('issued_date')}
                                      className="px-4 py-3 text-left text-sm font-bold text-gray-700 tracking-wider border-r border-gray-200 cursor-pointer hover:bg-gray-100"
                                    >
                                      {language === 'vi' ? 'Ng√†y c·∫•p' : 'Issued Date'}
                                      {getCertificateSortIcon('issued_date')}
                                    </th>
                                    <th 
                                      onClick={() => handleCertificateSort('cert_expiry')}
                                      className="px-4 py-3 text-left text-sm font-bold text-gray-700 tracking-wider border-r border-gray-200 cursor-pointer hover:bg-gray-100"
                                    >
                                      {language === 'vi' ? 'Ng√†y h·∫øt h·∫°n' : 'Crew Cert Expiry'}
                                      {getCertificateSortIcon('cert_expiry')}
                                    </th>
                                    <th 
                                      onClick={() => handleCertificateSort('status')}
                                      className="px-3 py-3 text-left text-sm font-bold text-gray-700 tracking-wider border-r border-gray-200 cursor-pointer hover:bg-gray-100"
                                    >
                                      {language === 'vi' ? 'Tr·∫°ng th√°i' : 'Status'}
                                      {getCertificateSortIcon('status')}
                                    </th>
                                    <th className="px-4 py-3 text-left text-sm font-bold text-gray-700 tracking-wider border-r border-gray-200">
                                      {language === 'vi' ? 'Ghi ch√∫' : 'Note'}
                                    </th>
                                  </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                  {crewCertificates.length > 0 ? (
                                    crewCertificates
                                      .filter(cert => {
                                        // Apply search filter
                                        if (certificatesSearch) {
                                          const search = certificatesSearch.toLowerCase();
                                          if (!(
                                            cert.crew_name?.toLowerCase().includes(search) ||
                                            cert.cert_name?.toLowerCase().includes(search) ||
                                            cert.cert_no?.toLowerCase().includes(search) ||
                                            cert.issued_by?.toLowerCase().includes(search)
                                          )) return false;
                                        }
                                        
                                        // Apply ship sign on filter
                                        if (certFilters.shipSignOn !== 'all') {
                                          const shipStatus = getCertificateShipStatus(cert);
                                          const certShipSignOn = shipStatus.isStandby ? '-' : shipStatus.ship;
                                          if (certShipSignOn !== certFilters.shipSignOn) {
                                            return false;
                                          }
                                        }
                                        
                                        // Apply status filter
                                        if (certFilters.status !== 'all' && cert.status !== certFilters.status) {
                                          return false;
                                        }
                                        
                                        // Apply crew name filter
                                        if (certFilters.crewName !== 'all' && cert.crew_name !== certFilters.crewName) {
                                          // Debug: log filter mismatch
                                          if (certFilters.crewName !== 'all') {
                                            console.log('üîç Crew filter check:', {
                                              filterValue: certFilters.crewName,
                                              certCrewName: cert.crew_name,
                                              match: cert.crew_name === certFilters.crewName
                                            });
                                          }
                                          return false;
                                        }
                                        
                                        return true;
                                      })
                                      .sort((a, b) => {
                                        if (!certificateSort.column) return 0;
                                        
                                        // Special handling for ship_status column (computed value)
                                        if (certificateSort.column === 'ship_status') {
                                          const aShipStatus = getCertificateShipStatus(a);
                                          const bShipStatus = getCertificateShipStatus(b);
                                          
                                          // Sort: Standby first, then ship names alphabetically
                                          // Or reverse if descending
                                          let comparison = 0;
                                          
                                          if (aShipStatus.isStandby && !bShipStatus.isStandby) {
                                            comparison = -1; // Standby comes first
                                          } else if (!aShipStatus.isStandby && bShipStatus.isStandby) {
                                            comparison = 1;
                                          } else {
                                            // Both same type, compare ship names
                                            comparison = aShipStatus.ship.localeCompare(bShipStatus.ship);
                                          }
                                          
                                          return certificateSort.direction === 'asc' ? comparison : -comparison;
                                        }
                                        
                                        // Standard sorting for other columns
                                        const aVal = a[certificateSort.column] || '';
                                        const bVal = b[certificateSort.column] || '';
                                        const comparison = aVal.toString().localeCompare(bVal.toString());
                                        return certificateSort.direction === 'asc' ? comparison : -comparison;
                                      })
                                      .map((cert, index) => (
                                        <tr 
                                          key={cert.id} 
                                          className={`hover:bg-gray-50 ${selectedCrewCertificates.has(cert.id) ? 'bg-blue-50' : ''}`}
                                          onContextMenu={(e) => handleCertRightClick(e, cert)}
                                        >
                                          {/* Checkbox Cell */}
                                          <td className="px-3 py-4 whitespace-nowrap text-center border-r border-gray-200">
                                            <input
                                              type="checkbox"
                                              checked={selectedCrewCertificates.has(cert.id)}
                                              onChange={(e) => {
                                                e.stopPropagation();
                                                handleSelectCrewCertificate(cert.id);
                                              }}
                                              onClick={(e) => e.stopPropagation()}
                                              className="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer"
                                            />
                                          </td>
                                          <td className="px-3 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200">
                                            {index + 1}
                                          </td>
                                          <td className="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900 border-r border-gray-200 uppercase">
                                            {language === 'en' && cert.crew_name_en ? cert.crew_name_en : cert.crew_name}
                                          </td>
                                          <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200">
                                            {(() => {
                                              const shipStatus = getCertificateShipStatus(cert);
                                              return (
                                                <span className={shipStatus.isStandby ? 'text-orange-600 font-medium' : 'text-blue-600'}>
                                                  {shipStatus.ship}
                                                </span>
                                              );
                                            })()}
                                          </td>
                                          <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200">
                                            {cert.rank || '-'}
                                          </td>
                                          <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200">
                                            <div className="flex items-center space-x-2">
                                              <span>{cert.cert_name}</span>
                                              {/* File status indicators */}
                                              {cert.crew_cert_file_id && (
                                                <span 
                                                  className="text-green-500 text-xs cursor-pointer hover:text-green-600" 
                                                  title={`${language === 'vi' ? 'File g·ªëc' : 'Original file'}\nüìÅ ${getFileLocation(cert)}`}
                                                  onClick={() => {
                                                    if (cert.crew_cert_file_id) {
                                                      window.open(`https://drive.google.com/file/d/${cert.crew_cert_file_id}/view`, '_blank');
                                                    }
                                                  }}
                                                >
                                                  üìÑ
                                                </span>
                                              )}
                                              {cert.crew_cert_summary_file_id && (
                                                <span 
                                                  className="text-blue-500 text-xs cursor-pointer hover:text-blue-600" 
                                                  title={`${language === 'vi' ? 'File t√≥m t·∫Øt' : 'Summary file'}\nüìÅ ${cert.ship_name || selectedShip?.name || 'Unknown'}/Certificates`}
                                                  onClick={() => {
                                                    if (cert.crew_cert_summary_file_id) {
                                                      window.open(`https://drive.google.com/file/d/${cert.crew_cert_summary_file_id}/view`, '_blank');
                                                    }
                                                  }}
                                                >
                                                  üìã
                                                </span>
                                              )}
                                            </div>
                                          </td>
                                          <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200">
                                            {cert.cert_no}
                                          </td>
                                          <td 
                                            className="px-4 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200 cursor-help"
                                            title={cert.issued_by || ''}
                                          >
                                            <span className="font-medium">
                                              {getAbbreviation(cert.issued_by)}
                                            </span>
                                          </td>
                                          <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200">
                                            {formatDateDisplay(cert.issued_date) || '-'}
                                          </td>
                                          <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200">
                                            {formatDateDisplay(cert.cert_expiry) || '-'}
                                          </td>
                                          <td className="px-3 py-4 whitespace-nowrap border-r border-gray-200">
                                            <span className={`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                              cert.status === 'Valid' ? 'bg-green-100 text-green-800' :
                                              cert.status === 'Critical' ? 'bg-orange-200 text-orange-900' :
                                              cert.status === 'Expiring Soon' ? 'bg-yellow-100 text-yellow-800' :
                                              cert.status === 'Expired' ? 'bg-red-100 text-red-800' :
                                              'bg-gray-100 text-gray-800'
                                            }`} style={cert.status === 'Critical' ? {backgroundColor: '#fed7aa', color: '#7c2d12'} : {}}>
                                              {cert.status === 'Valid' ? (language === 'vi' ? 'C√≤n h·∫°n' : 'Valid') :
                                               cert.status === 'Critical' ? (language === 'vi' ? 'Kh·∫©n c·∫•p' : 'Critical') :
                                               cert.status === 'Expiring Soon' ? (language === 'vi' ? 'S·∫Øp h·∫øt h·∫°n' : 'Expiring Soon') :
                                               cert.status === 'Expired' ? (language === 'vi' ? 'H·∫øt h·∫°n' : 'Expired') :
                                               cert.status || '-'}
                                            </span>
                                          </td>
                                          <td className="px-4 py-4 text-sm text-gray-900 border-r border-gray-200">
                                            <div className="max-w-xs truncate" title={cert.note}>
                                              {cert.note || '-'}
                                            </div>
                                          </td>
                                        </tr>
                                      ))
                                  ) : (
                                    <tr>
                                      <td colSpan="10" className="px-6 py-12 text-center">
                                        <div className="text-gray-400 text-lg mb-2">üìú</div>
                                        <p className="text-gray-500">
                                          {language === 'vi' ? 'Ch∆∞a c√≥ ch·ª©ng ch·ªâ n√†o' : 'No certificates found'}
                                        </p>
                                        <p className="text-sm text-gray-400 mt-1">
                                          {language === 'vi' ? 'Th√™m ch·ª©ng ch·ªâ m·ªõi cho thuy·ªÅn vi√™n n√†y' : 'Add new certificates for this crew member'}
                                        </p>
                                      </td>
                                    </tr>
                                  )}
                                </tbody>
                              </table>
                            </div>
                          </div>

                          {/* Add Crew Certificate Modal */}
                          {console.log('üîç Modal render check - showAddCrewCertModal:', showAddCrewCertModal)}
                          {showAddCrewCertModal && !isAddCrewCertModalMinimized && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] p-4">
                              <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
                                {/* Modal Header */}
                                <div className="p-6 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50">
                                  <div className="flex justify-between items-center">
                                    <div>
                                      <h3 className="text-xl font-bold text-gray-800 flex items-center">
                                        <span className="mr-2">üìú</span>
                                        {language === 'vi' ? 'Th√™m ch·ª©ng ch·ªâ thuy·ªÅn vi√™n' : 'Add Crew Certificate'}
                                      </h3>
                                      {selectedCrewForCert && (
                                        <p className="text-sm text-gray-600 mt-1">
                                          {language === 'vi' ? 'Thuy·ªÅn vi√™n: ' : 'Crew: '}
                                          <span className="font-semibold uppercase">
                                            {selectedCrewForCert.full_name} ({selectedCrewForCert.passport})
                                          </span>
                                        </p>
                                      )}
                                    </div>
                                    <div className="flex items-center space-x-2">
                                      {/* Minimize Button */}
                                      <button
                                        onClick={() => {
                                          console.log('üì¶ Minimizing Add Crew Certificate modal...');
                                          setIsAddCrewCertModalMinimized(true);
                                          toast.info(language === 'vi' 
                                            ? 'Modal ƒë√£ ƒë∆∞·ª£c thu nh·ªè. Click v√†o bi·ªÉu t∆∞·ª£ng b√™n d∆∞·ªõi ƒë·ªÉ m·ªü l·∫°i.' 
                                            : 'Modal minimized. Click icon below to restore.');
                                        }}
                                        className="text-gray-400 hover:text-blue-600 transition-colors p-2 hover:bg-blue-50 rounded"
                                        title={language === 'vi' ? 'Thu nh·ªè' : 'Minimize'}
                                        disabled={isSubmittingCert}
                                      >
                                        <span className="text-xl">‚îÄ</span>
                                      </button>
                                      {/* Close Button */}
                                      <button
                                        onClick={handleCloseAddCrewCertModal}
                                        className="text-gray-400 hover:text-red-600 transition-colors p-2 hover:bg-red-50 rounded"
                                        title={language === 'vi' ? 'ƒê√≥ng' : 'Close'}
                                        disabled={isSubmittingCert}
                                      >
                                        <span className="text-2xl">√ó</span>
                                      </button>
                                    </div>
                                  </div>
                                </div>

                                {/* Modal Body */}
                                <div className="p-6 overflow-y-auto max-h-[calc(90vh-180px)]">
                                  
                                  {/* Section 1: From Certificate File (AI Analysis) */}
                                  <div className="mb-6">
                                    <div className="flex items-center justify-between mb-3">
                                      <h4 className="font-semibold text-gray-800 flex items-center">
                                        <span className="mr-2">üìÑ</span>
                                        {language === 'vi' ? 'T·ª´ file ch·ª©ng ch·ªâ (AI ph√¢n t√≠ch)' : 'From Certificate File (AI Analysis)'}
                                      </h4>
                                      {certFile && (
                                        <button
                                          type="button"
                                          onClick={handleResetCertFile}
                                          className="text-sm text-red-600 hover:text-red-700 font-medium"
                                        >
                                          {language === 'vi' ? 'X√≥a file' : 'Remove file'}
                                        </button>
                                      )}
                                    </div>
                                    
                                    <p className="text-sm text-gray-600 mb-3">
                                      {language === 'vi' 
                                        ? 'T·∫£i l√™n file ch·ª©ng ch·ªâ ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin ho·∫∑c nh·∫≠p th·ªß c√¥ng b√™n d∆∞·ªõi'
                                        : 'Upload certificate file to automatically fill information or enter manually below'}
                                    </p>
                                    
                                    {!certFile ? (
                                      <div className="space-y-3">
                                        {/* Drag & Drop Area */}
                                        <div 
                                          className="border-2 border-dashed border-blue-300 rounded-lg p-6 hover:border-blue-400 cursor-pointer transition-colors"
                                          onClick={handleCertFileAreaClick}
                                          onDragOver={(e) => {
                                            e.preventDefault();
                                            e.currentTarget.classList.add('border-blue-400', 'bg-blue-100');
                                          }}
                                          onDragLeave={(e) => {
                                            e.currentTarget.classList.remove('border-blue-400', 'bg-blue-100');
                                          }}
                                          onDrop={handleCertFileDrop}
                                        >
                                          {/* Flex container with text on left and icon on right */}
                                          <div className="flex items-center justify-between">
                                            {/* Text content on left */}
                                            <div className="flex-1">
                                              <p className="text-blue-700 font-medium text-left">
                                                {language === 'vi' ? 'K√©o th·∫£ file ho·∫∑c click ƒë·ªÉ ch·ªçn' : 'Drag & drop file or click to select'}
                                              </p>
                                              <p className="text-blue-600 text-sm text-left mt-1">
                                                {language === 'vi' ? 'H·ªó tr·ª£: PDF, JPG, PNG (t·ªëi ƒëa 10MB)' : 'Supports: PDF, JPG, PNG (max 10MB)'}
                                              </p>
                                            </div>
                                            
                                            {/* Icon on right */}
                                            <div className="flex-shrink-0 ml-4">
                                              <div className="text-blue-500 text-4xl">üìÅ</div>
                                            </div>
                                          </div>
                                        </div>
                                        
                                        <input
                                          ref={certFileInputRef}
                                          type="file"
                                          accept=".pdf,.jpg,.jpeg,.png"
                                          multiple
                                          onChange={(e) => {
                                            // Check if crew is selected
                                            if (!selectedCrewForCert && certFilters.crewName === 'all') {
                                              toast.warning(language === 'vi' 
                                                ? '‚ö†Ô∏è Vui l√≤ng ch·ªçn thuy·ªÅn vi√™n tr∆∞·ªõc khi upload file!' 
                                                : '‚ö†Ô∏è Please select a crew member before uploading file!'
                                              );
                                              e.target.value = ''; // Reset file input
                                              return;
                                            }
                                            
                                            const files = Array.from(e.target.files);
                                            if (files.length > 0) {
                                              handleMultipleCertificateUpload(files);
                                            }
                                            e.target.value = ''; // Reset for next selection
                                          }}
                                          className="hidden"
                                          disabled={isAnalyzingCert || isBatchProcessingCerts}
                                        />
                                        
                                        {isAnalyzingCert && (
                                          <div className="flex items-center justify-center space-x-2 text-blue-600 py-4">
                                            <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
                                            <span className="text-sm">
                                              {language === 'vi' ? 'ƒêang ph√¢n t√≠ch file v·ªõi AI...' : 'Analyzing file with AI...'}
                                            </span>
                                          </div>
                                        )}
                                        
                                        {certError && (
                                          <div className="p-3 bg-red-50 border border-red-200 rounded-lg">
                                            <p className="text-red-600 text-sm flex items-center">
                                              <span className="mr-2">‚ùå</span>
                                              {certError}
                                            </p>
                                          </div>
                                        )}
                                      </div>
                                    ) : (
                                      <div className="p-4 bg-green-50 border border-green-200 rounded-lg">
                                        <div className="flex items-start justify-between">
                                          <div className="flex-1">
                                            <p className="text-green-800 font-medium mb-1 flex items-center">
                                              <span className="mr-2">‚úÖ</span>
                                              {language === 'vi' ? 'File ƒë√£ ƒë∆∞·ª£c ph√¢n t√≠ch' : 'File analyzed'}
                                            </p>
                                            <p className="text-green-700 text-sm">
                                              <strong>{language === 'vi' ? 'File:' : 'File:'}</strong> {certFile.name}
                                            </p>
                                            <p className="text-green-700 text-sm">
                                              <strong>{language === 'vi' ? 'K√≠ch th∆∞·ªõc:' : 'Size:'}</strong> {(certFile.size / 1024 / 1024).toFixed(2)} MB
                                            </p>
                                          </div>
                                        </div>
                                      </div>
                                    )}
                                  </div>

                                  {/* Section 2: Certificate Information (Manual Entry) */}
                                  <form onSubmit={handleAddCrewCertificateSubmit} className="space-y-6">
                                    <div className="border-t border-gray-200 pt-6">
                                      <h4 className="font-semibold text-gray-800 mb-3 flex items-center">
                                        <span className="mr-2">‚úèÔ∏è</span>
                                        {language === 'vi' ? 'Th√¥ng tin ch·ª©ng ch·ªâ (Nh·∫≠p th·ªß c√¥ng)' : 'Certificate Information (Manual Entry)'}
                                      </h4>
                                      <p className="text-sm text-gray-600 mb-4">
                                        {language === 'vi' 
                                          ? 'ƒêi·ªÅn ho·∫∑c ch·ªânh s·ª≠a th√¥ng tin ch·ª©ng ch·ªâ ƒë∆∞·ª£c tr√≠ch xu·∫•t t·ª´ file' 
                                          : 'Fill in or edit the certificate information extracted from file'}
                                      </p>
                                    {/* Crew Information */}
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                      <h4 className="font-semibold text-gray-800 mb-3 flex items-center">
                                        <span className="mr-2">üë§</span>
                                        {language === 'vi' ? 'Th√¥ng tin thuy·ªÅn vi√™n' : 'Crew Information'}
                                      </h4>
                                      
                                      {/* Crew Selection Dropdown - Only show when no crew pre-selected */}
                                      {!selectedCrewForCert && crewList && crewList.length > 0 && (
                                        <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                          <label className="block text-sm font-medium text-gray-700 mb-2">
                                            <span className="mr-1">üë§</span>
                                            {language === 'vi' ? 'Ch·ªçn thuy·ªÅn vi√™n' : 'Select Crew Member'} <span className="text-red-500">*</span>
                                          </label>
                                          <select
                                            value={newCrewCertificate.crew_id}
                                            onChange={(e) => handleCrewSelectionInCertModal(e.target.value)}
                                            className="w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white"
                                            required
                                          >
                                            <option value="">
                                              {language === 'vi' ? '-- Ch·ªçn thuy·ªÅn vi√™n --' : '-- Select crew member --'}
                                            </option>
                                            {crewList.map(crew => (
                                              <option key={crew.id} value={crew.id}>
                                                {crew.full_name} ({crew.passport}) - {crew.ship_sign_on || '-'} - {crew.rank || 'N/A'}
                                              </option>
                                            ))}
                                          </select>
                                          <p className="text-xs text-gray-600 mt-1">
                                            {language === 'vi' 
                                              ? 'üí° Ch·ªçn thuy·ªÅn vi√™n ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin. Folder upload s·∫Ω ƒë∆∞·ª£c x√°c ƒë·ªãnh d·ª±a tr√™n Ship Sign On c·ªßa thuy·ªÅn vi√™n.' 
                                              : 'üí° Select crew to auto-fill information. Upload folder will be determined based on crew\'s Ship Sign On.'}
                                          </p>
                                          <p className="text-xs text-blue-600 mt-1">
                                            {language === 'vi' 
                                              ? 'üìÇ Standby crew (Ship Sign On = "-") ‚Üí COMPANY DOCUMENT/Standby Crew | Ship-assigned crew ‚Üí {Ship Name}/Crew Records' 
                                              : 'üìÇ Standby crew (Ship Sign On = "-") ‚Üí COMPANY DOCUMENT/Standby Crew | Ship-assigned crew ‚Üí {Ship Name}/Crew Records'}
                                          </p>
                                        </div>
                                      )}

                                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {/* Row 1: Crew Name (Vietnamese) and Crew Name (English) */}
                                        <div>
                                          <label className="block text-sm font-medium text-gray-700 mb-1">
                                            {language === 'vi' ? 'T√™n thuy·ªÅn vi√™n (Ti·∫øng Vi·ªát)' : 'Crew Name (Vietnamese)'} <span className="text-red-500">*</span>
                                          </label>
                                          <input
                                            type="text"
                                            value={newCrewCertificate.crew_name}
                                            onChange={(e) => setNewCrewCertificate({...newCrewCertificate, crew_name: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent uppercase"
                                            placeholder={language === 'vi' ? 'Nh·∫≠p t√™n thuy·ªÅn vi√™n' : 'Enter crew name'}
                                            required
                                            disabled={!!selectedCrewForCert}
                                          />
                                        </div>
                                        <div>
                                          <label className="block text-sm font-medium text-gray-700 mb-1">
                                            {language === 'vi' ? 'T√™n thuy·ªÅn vi√™n (Ti·∫øng Anh)' : 'Crew Name (English)'}
                                          </label>
                                          <input
                                            type="text"
                                            value={newCrewCertificate.crew_name_en}
                                            onChange={(e) => setNewCrewCertificate({...newCrewCertificate, crew_name_en: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent uppercase"
                                            placeholder={language === 'vi' ? 'Nh·∫≠p t√™n ti·∫øng Anh' : 'Enter English name'}
                                            disabled={!!selectedCrewForCert}
                                          />
                                        </div>

                                        {/* Row 2: Passport and Rank */}
                                        <div>
                                          <label className="block text-sm font-medium text-gray-700 mb-1">
                                            {language === 'vi' ? 'S·ªë h·ªô chi·∫øu' : 'Passport'} <span className="text-red-500">*</span>
                                          </label>
                                          <input
                                            type="text"
                                            value={newCrewCertificate.passport}
                                            onChange={(e) => setNewCrewCertificate({...newCrewCertificate, passport: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder={language === 'vi' ? 'Nh·∫≠p s·ªë h·ªô chi·∫øu' : 'Enter passport'}
                                            required
                                            disabled={!!selectedCrewForCert}
                                          />
                                        </div>
                                        <div>
                                          <label className="block text-sm font-medium text-gray-700 mb-1">
                                            {language === 'vi' ? 'Ch·ª©c danh' : 'Rank'}
                                          </label>
                                          <input
                                            type="text"
                                            value={newCrewCertificate.rank || ''}
                                            onChange={(e) => setNewCrewCertificate({...newCrewCertificate, rank: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder={language === 'vi' ? 'Nh·∫≠p ch·ª©c danh' : 'Enter rank'}
                                            disabled={!!selectedCrewForCert}
                                          />
                                        </div>

                                        {/* Row 2.5: Date of Birth */}
                                        <div>
                                          <label className="block text-sm font-medium text-gray-700 mb-1">
                                            {language === 'vi' ? 'Ng√†y sinh' : 'Date of Birth'} <span className="text-red-500">*</span>
                                          </label>
                                          {console.log('üîç Rendering Date of Birth field, value:', newCrewCertificate.date_of_birth)}
                                          <input
                                            type="date"
                                            value={newCrewCertificate.date_of_birth || ''}
                                            onChange={(e) => setNewCrewCertificate({...newCrewCertificate, date_of_birth: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            required
                                            disabled={!!selectedCrewForCert}
                                          />
                                        </div>
                                        <div>
                                          {/* Empty space for grid alignment */}
                                        </div>

                                        {/* Row 3: Crew ID (full width) */}
                                        <div className="md:col-span-2">
                                          <label className="block text-sm font-medium text-gray-700 mb-1">
                                            {language === 'vi' ? 'ID Thuy·ªÅn vi√™n' : 'Crew ID'}
                                          </label>
                                          <input
                                            type="text"
                                            value={newCrewCertificate.crew_id}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50"
                                            placeholder="Auto"
                                            disabled
                                          />
                                        </div>
                                      </div>
                                    </div>

                                    {/* Certificate Details */}
                                    <div>
                                      <h4 className="font-semibold text-gray-800 mb-3 flex items-center">
                                        <span className="mr-2">üìã</span>
                                        {language === 'vi' ? 'Chi ti·∫øt ch·ª©ng ch·ªâ' : 'Certificate Details'}
                                      </h4>
                                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                          <label className="block text-sm font-medium text-gray-700 mb-1">
                                            {language === 'vi' ? 'T√™n ch·ª©ng ch·ªâ' : 'Certificate Name'} <span className="text-red-500">*</span>
                                          </label>
                                          <select
                                            value={newCrewCertificate.cert_name}
                                            onChange={(e) => setNewCrewCertificate({...newCrewCertificate, cert_name: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white"
                                            required
                                          >
                                            <option value="">
                                              {language === 'vi' ? '-- Ch·ªçn lo·∫°i ch·ª©ng ch·ªâ --' : '-- Select certificate type --'}
                                            </option>
                                            <option value="Certificate of Competency (COC)">
                                              {language === 'vi' ? 'Ch·ª©ng ch·ªâ Chuy√™n m√¥n (COC)' : 'Certificate of Competency (COC)'}
                                            </option>
                                            <option value="Certificate of Endorsement (COE)">
                                              {language === 'vi' ? 'Ch·ª©ng ch·ªâ Ph√™ chu·∫©n (COE)' : 'Certificate of Endorsement (COE)'}
                                            </option>
                                            <option value="Seaman Book for COC">
                                              {language === 'vi' ? 'Seaman Book cho COC' : 'Seaman Book for COC'}
                                            </option>
                                            <option value="Seaman book for GMDSS">
                                              {language === 'vi' ? 'Seaman Book cho GMDSS' : 'Seaman book for GMDSS'}
                                            </option>
                                            <option value="GMDSS Certificate">
                                              {language === 'vi' ? 'Ch·ª©ng ch·ªâ GMDSS' : 'GMDSS Certificate'}
                                            </option>
                                            <option value="Medical Certificate">
                                              {language === 'vi' ? 'Ch·ª©ng nh·∫≠n S·ª©c kh·ªèe' : 'Medical Certificate'}
                                            </option>
                                            <option value="Basic Safety Training">
                                              {language === 'vi' ? 'Hu·∫•n luy·ªán An to√†n C∆° b·∫£n' : 'Basic Safety Training'}
                                            </option>
                                            <option value="Advanced Fire Fighting">
                                              {language === 'vi' ? 'Ch·ªØa ch√°y N√¢ng cao' : 'Advanced Fire Fighting'}
                                            </option>
                                            <option value="Ship Security Officer">
                                              {language === 'vi' ? 'Sƒ© quan An ninh T√†u' : 'Ship Security Officer'}
                                            </option>
                                            <option value="Survival Craft and Rescue Boats">
                                              {language === 'vi' ? 'Xu·ªìng c·ª©u sinh v√† C·ª©u n·∫°n' : 'Survival Craft and Rescue Boats'}
                                            </option>
                                            <option value="Medical First Aid">
                                              {language === 'vi' ? 'S∆° c·∫•p c·ª©u Y t·∫ø' : 'Medical First Aid'}
                                            </option>
                                            <option value="Medical Care">
                                              {language === 'vi' ? 'ChƒÉm s√≥c Y t·∫ø' : 'Medical Care'}
                                            </option>
                                            <option value="Crowd Management">
                                              {language === 'vi' ? 'Qu·∫£n l√Ω ƒê√°m ƒë√¥ng' : 'Crowd Management'}
                                            </option>
                                            <option value="Crisis Management and Human Behaviour">
                                              {language === 'vi' ? 'Qu·∫£n l√Ω Kh·ªßng ho·∫£ng' : 'Crisis Management and Human Behaviour'}
                                            </option>
                                            <option value="Designated Security Duties">
                                              {language === 'vi' ? 'Nhi·ªám v·ª• An ninh ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh' : 'Designated Security Duties'}
                                            </option>
                                          </select>
                                        </div>
                                        <div>
                                          <label className="block text-sm font-medium text-gray-700 mb-1">
                                            {language === 'vi' ? 'S·ªë ch·ª©ng ch·ªâ' : 'Certificate No.'} <span className="text-red-500">*</span>
                                          </label>
                                          <input
                                            type="text"
                                            value={newCrewCertificate.cert_no}
                                            onChange={(e) => setNewCrewCertificate({...newCrewCertificate, cert_no: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder={language === 'vi' ? 'Nh·∫≠p s·ªë ch·ª©ng ch·ªâ' : 'Enter certificate number'}
                                            required
                                          />
                                        </div>
                                        <div>
                                          <label className="block text-sm font-medium text-gray-700 mb-1">
                                            {language === 'vi' ? 'C∆° quan c·∫•p' : 'Issued By'}
                                          </label>
                                          <input
                                            type="text"
                                            value={newCrewCertificate.issued_by}
                                            onChange={(e) => setNewCrewCertificate({...newCrewCertificate, issued_by: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder={language === 'vi' ? 'Nh·∫≠p c∆° quan c·∫•p' : 'Enter issuing authority'}
                                          />
                                        </div>
                                        <div>
                                          <label className="block text-sm font-medium text-gray-700 mb-1">
                                            {language === 'vi' ? 'Ng√†y c·∫•p' : 'Issued Date'}
                                          </label>
                                          <input
                                            type="date"
                                            value={newCrewCertificate.issued_date}
                                            onChange={(e) => setNewCrewCertificate({...newCrewCertificate, issued_date: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                          />
                                        </div>
                                        <div className="md:col-span-2">
                                          <label className="block text-sm font-medium text-gray-700 mb-1">
                                            {language === 'vi' ? 'Ng√†y h·∫øt h·∫°n' : 'Expiry Date'}
                                          </label>
                                          <input
                                            type="date"
                                            value={newCrewCertificate.cert_expiry}
                                            onChange={(e) => setNewCrewCertificate({...newCrewCertificate, cert_expiry: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                          />
                                          <p className="text-xs text-gray-500 mt-1">
                                            {language === 'vi' 
                                              ? 'üí° Tr·∫°ng th√°i s·∫Ω t·ª± ƒë·ªông t√≠nh d·ª±a tr√™n ng√†y h·∫øt h·∫°n' 
                                              : 'üí° Status will be auto-calculated based on expiry date'}
                                          </p>
                                        </div>
                                      </div>
                                    </div>

                                    {/* Notes */}
                                    <div>
                                      <label className="block text-sm font-medium text-gray-700 mb-1">
                                        {language === 'vi' ? 'Ghi ch√∫' : 'Note'}
                                      </label>
                                      <textarea
                                        value={newCrewCertificate.note}
                                        onChange={(e) => setNewCrewCertificate({...newCrewCertificate, note: e.target.value})}
                                        rows={3}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                        placeholder={language === 'vi' ? 'Nh·∫≠p ghi ch√∫ (t√πy ch·ªçn)' : 'Enter note (optional)'}
                                      />
                                    </div>

                                    {/* Form Actions */}
                                    <div className="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                                      <button
                                        type="button"
                                        onClick={handleCloseAddCrewCertModal}
                                        className="px-6 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all"
                                        disabled={isSubmittingCert}
                                      >
                                        {language === 'vi' ? 'H·ªßy' : 'Cancel'}
                                      </button>
                                      <button
                                        type="submit"
                                        className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all font-medium flex items-center disabled:opacity-50 disabled:cursor-not-allowed"
                                        disabled={isSubmittingCert}
                                      >
                                        {isSubmittingCert ? (
                                          <>
                                            <svg className="animate-spin h-4 w-4 mr-2" viewBox="0 0 24 24">
                                              <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
                                              <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                                            </svg>
                                            {language === 'vi' ? 'ƒêang l∆∞u...' : 'Saving...'}
                                          </>
                                        ) : (
                                          <>
                                            <span className="mr-2">üíæ</span>
                                            {language === 'vi' ? 'L∆∞u ch·ª©ng ch·ªâ' : 'Save Certificate'}
                                          </>
                                        )}
                                      </button>
                                      </div>
                                    </div>
                                  </form>
                                </div>
                              </div>
                            </div>
                          )}

                          {/* Crew Certificate Context Menu */}
                          {certContextMenu.show && (
                            <div 
                              className="fixed bg-white border border-gray-200 rounded-lg shadow-lg z-[100]"
                              style={{
                                position: 'fixed',
                                top: `${certContextMenu.y}px`,
                                left: `${certContextMenu.x}px`,
                                minWidth: '200px'
                              }}
                            >
                              <div className="py-1">
                                {selectedCrewCertificates.size > 1 ? (
                                  <div className="px-4 py-2 text-xs font-semibold text-gray-500 border-b border-gray-200">
                                    {selectedCrewCertificates.size} {language === 'vi' ? 'ch·ª©ng ch·ªâ ƒë√£ ch·ªçn' : 'certificates selected'}
                                  </div>
                                ) : (
                                  <div className="px-4 py-2 text-xs font-semibold text-gray-500 border-b border-gray-200">
                                    {certContextMenu.cert?.crew_name} - {certContextMenu.cert?.cert_name}
                                  </div>
                                )}
                                
                                {/* Edit - only show for single selection */}
                                {selectedCrewCertificates.size === 1 && (
                                  <button
                                    onClick={() => handleEditCrewCertificate(certContextMenu.cert)}
                                    className="w-full text-left px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 flex items-center"
                                  >
                                    <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                    {language === 'vi' ? 'Ch·ªânh s·ª≠a ch·ª©ng ch·ªâ' : 'Edit Crew Certificate'}
                                  </button>
                                )}
                                
                                {/* Delete - works for single and multiple */}
                                <button
                                  onClick={selectedCrewCertificates.size > 1 ? handleBulkDeleteCertificates : () => handleDeleteCrewCertificate(certContextMenu.cert)}
                                  className="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center"
                                >
                                  <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                  </svg>
                                  {selectedCrewCertificates.size > 1 
                                    ? (language === 'vi' ? `X√≥a ${selectedCrewCertificates.size} ch·ª©ng ch·ªâ` : `Delete ${selectedCrewCertificates.size} certificates`)
                                    : (language === 'vi' ? 'X√≥a ch·ª©ng ch·ªâ' : 'Delete Certificate')
                                  }
                                </button>
                                
                                <div className="border-t border-gray-200 my-1"></div>
                                
                                {/* View File - works for single and multiple */}
                                <button
                                  onClick={selectedCrewCertificates.size > 1 ? handleBulkOpenInDrive : () => handleViewCertFile(certContextMenu.cert)}
                                  className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center"
                                >
                                  <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                  </svg>
                                  {selectedCrewCertificates.size > 1 
                                    ? (language === 'vi' ? `Xem file (${selectedCrewCertificates.size} ch·ª©ng ch·ªâ)` : `View Files (${selectedCrewCertificates.size} certificates)`)
                                    : (language === 'vi' ? 'Xem file' : 'View File')
                                  }
                                  {certContextMenu.cert?.cert_file_id && selectedCrewCertificates.size === 1 && (
                                    <span className="ml-auto text-xs bg-green-100 text-green-600 px-1 rounded">üìÑ</span>
                                  )}
                                </button>
                                
                                {/* Download - works for single and multiple */}
                                <button
                                  onClick={selectedCrewCertificates.size > 1 ? handleBulkDownloadCertificates : () => handleDownloadCertFile(certContextMenu.cert)}
                                  className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center"
                                >
                                  <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                  </svg>
                                  {selectedCrewCertificates.size > 1 
                                    ? (language === 'vi' ? `T·∫£i xu·ªëng (${selectedCrewCertificates.size} file)` : `Download (${selectedCrewCertificates.size} files)`)
                                    : (language === 'vi' ? 'T·∫£i xu·ªëng file' : 'Download File')
                                  }
                                  {certContextMenu.cert?.cert_file_id && selectedCrewCertificates.size === 1 && (
                                    <span className="ml-auto text-xs bg-blue-100 text-blue-600 px-1 rounded">üì•</span>
                                  )}
                                </button>
                                
                                {/* Copy Link - works for single and multiple */}
                                <button
                                  onClick={selectedCrewCertificates.size > 1 ? handleBulkCopyCertLinks : () => handleCopyCertLink(certContextMenu.cert)}
                                  className="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center"
                                >
                                  <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                                  </svg>
                                  {selectedCrewCertificates.size > 1 
                                    ? (language === 'vi' ? `Sao ch√©p link (${selectedCrewCertificates.size} file)` : `Copy Links (${selectedCrewCertificates.size} files)`)
                                    : (language === 'vi' ? 'Sao ch√©p link' : 'Copy Link')
                                  }
                                  {certContextMenu.cert?.cert_file_id && selectedCrewCertificates.size === 1 && (
                                    <span className="ml-auto text-xs bg-gray-100 text-gray-600 px-1 rounded">üîó</span>
                                  )}
                                </button>
                                
                                {/* Auto Rename - works for single and multiple */}
                                <div className="border-t border-gray-200 my-1"></div>
                                <button
                                  onClick={() => handleAutoRenameCrewCertFiles(certContextMenu.cert)}
                                  className="w-full text-left px-4 py-2 text-sm text-purple-600 hover:bg-purple-50 flex items-center"
                                >
                                  <svg className="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                  </svg>
                                  {selectedCrewCertificates.size > 1 
                                    ? (language === 'vi' ? `T·ª± ƒë·ªông ƒë·ªïi t√™n file (${selectedCrewCertificates.size} ch·ª©ng ch·ªâ)` : `Auto Rename Files (${selectedCrewCertificates.size} certificates)`)
                                    : (language === 'vi' ? 'T·ª± ƒë·ªông ƒë·ªïi t√™n file' : 'Auto Rename File')
                                  }
                                  <span className="ml-auto text-xs bg-purple-100 text-purple-600 px-1 rounded">‚ö°</span>
                                </button>
                              </div>
                            </div>
                          )}

                          {/* Edit Crew Certificate Modal */}
                          {showEditCrewCertModal && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] p-4">
                              <div className="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
                                {/* Modal Header */}
                                <div className="p-6 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50">
                                  <div className="flex justify-between items-center">
                                    <div>
                                      <h3 className="text-xl font-bold text-gray-800 flex items-center">
                                        <span className="mr-2">‚úèÔ∏è</span>
                                        {language === 'vi' ? 'Ch·ªânh s·ª≠a ch·ª©ng ch·ªâ thuy·ªÅn vi√™n' : 'Edit Crew Certificate'}
                                      </h3>
                                      {editingCrewCert && (
                                        <p className="text-sm text-gray-600 mt-1">
                                          {editingCrewCert.crew_name} - {editingCrewCert.cert_name}
                                        </p>
                                      )}
                                    </div>
                                    <button 
                                      onClick={closeEditCrewCertModal}
                                      className="text-gray-500 hover:text-gray-700 transition-colors"
                                    >
                                      <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                      </svg>
                                    </button>
                                  </div>
                                </div>

                                {/* Modal Body */}
                                <div className="p-6 overflow-y-auto max-h-[calc(90vh-200px)]">
                                  <form onSubmit={handleUpdateCrewCertificate} className="space-y-6">
                                    <div className="grid grid-cols-2 gap-4">
                                      {/* Crew Name */}
                                      <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                          {language === 'vi' ? 'T√™n thuy·ªÅn vi√™n' : 'Crew Name'} <span className="text-red-500">*</span>
                                        </label>
                                        <input
                                          type="text"
                                          value={editCrewCertData.crew_name}
                                          onChange={(e) => setEditCrewCertData({...editCrewCertData, crew_name: e.target.value})}
                                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                          required
                                        />
                                      </div>

                                      {/* Passport */}
                                      <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                          {language === 'vi' ? 'H·ªô chi·∫øu' : 'Passport'} <span className="text-red-500">*</span>
                                        </label>
                                        <input
                                          type="text"
                                          value={editCrewCertData.passport}
                                          onChange={(e) => setEditCrewCertData({...editCrewCertData, passport: e.target.value})}
                                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                          required
                                        />
                                      </div>

                                      {/* Date of Birth */}
                                      <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                          {language === 'vi' ? 'Ng√†y sinh' : 'Date of Birth'} <span className="text-red-500">*</span>
                                        </label>
                                        <input
                                          type="date"
                                          value={editCrewCertData.date_of_birth || ''}
                                          onChange={(e) => setEditCrewCertData({...editCrewCertData, date_of_birth: e.target.value})}
                                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                          required
                                        />
                                      </div>

                                      {/* Certificate Name - Searchable Dropdown with Custom Input */}
                                      <div ref={certNameDropdownRef}>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                          {language === 'vi' ? 'T√™n ch·ª©ng ch·ªâ' : 'Certificate Name'} <span className="text-red-500">*</span>
                                        </label>
                                        <div className="relative">
                                          <input
                                            type="text"
                                            value={editCrewCertData.cert_name}
                                            onChange={(e) => {
                                              setEditCrewCertData({...editCrewCertData, cert_name: e.target.value});
                                              setCertNameSearchTerm(e.target.value);
                                              setShowCertNameDropdown(true);
                                            }}
                                            onFocus={() => setShowCertNameDropdown(true)}
                                            className="w-full px-3 py-2 pr-8 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder={language === 'vi' ? 'Ch·ªçn ho·∫∑c nh·∫≠p t√™n ch·ª©ng ch·ªâ...' : 'Select or type certificate name...'}
                                            required
                                          />
                                          <button
                                            type="button"
                                            onClick={() => setShowCertNameDropdown(!showCertNameDropdown)}
                                            className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                                          >
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                            </svg>
                                          </button>
                                          
                                          {/* Dropdown Menu */}
                                          {showCertNameDropdown && (
                                            <div className="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto">
                                              {/* Merge common + custom names, then filter based on search term */}
                                              {(() => {
                                                // Merge and sort all certificate names
                                                const allCertNames = [...COMMON_CERTIFICATE_NAMES, ...customCertificateNames].sort();
                                                const searchTerm = (editCrewCertData.cert_name || '').toLowerCase();
                                                const filteredNames = allCertNames.filter(name => 
                                                  name.toLowerCase().includes(searchTerm)
                                                );
                                                
                                                return (
                                                  <>
                                                    {/* Common Certificate Names Section */}
                                                    {COMMON_CERTIFICATE_NAMES
                                                      .filter(name => name.toLowerCase().includes(searchTerm))
                                                      .map((name, index) => (
                                                        <button
                                                          key={`common-${index}`}
                                                          type="button"
                                                          onClick={() => {
                                                            setEditCrewCertData({...editCrewCertData, cert_name: name});
                                                            setShowCertNameDropdown(false);
                                                          }}
                                                          className="w-full px-4 py-2 text-left hover:bg-blue-50 focus:bg-blue-50 focus:outline-none text-sm transition-colors"
                                                        >
                                                          {name}
                                                        </button>
                                                      ))
                                                    }
                                                    
                                                    {/* Divider if both common and custom names exist */}
                                                    {customCertificateNames.filter(name => name.toLowerCase().includes(searchTerm)).length > 0 &&
                                                     COMMON_CERTIFICATE_NAMES.filter(name => name.toLowerCase().includes(searchTerm)).length > 0 && (
                                                      <div className="border-t border-gray-200 my-1">
                                                        <div className="px-4 py-1 text-xs text-gray-500 font-medium bg-gray-50">
                                                          {language === 'vi' ? 'T√™n t√πy ch·ªânh ƒë√£ l∆∞u' : 'Saved Custom Names'}
                                                        </div>
                                                      </div>
                                                    )}
                                                    
                                                    {/* Custom Certificate Names Section */}
                                                    {customCertificateNames
                                                      .filter(name => name.toLowerCase().includes(searchTerm))
                                                      .map((name, index) => (
                                                        <button
                                                          key={`custom-${index}`}
                                                          type="button"
                                                          onClick={() => {
                                                            setEditCrewCertData({...editCrewCertData, cert_name: name});
                                                            setShowCertNameDropdown(false);
                                                          }}
                                                          className="w-full px-4 py-2 text-left hover:bg-green-50 focus:bg-green-50 focus:outline-none text-sm transition-colors flex items-center justify-between group"
                                                        >
                                                          <span>{name}</span>
                                                          <span className="text-xs text-green-600 opacity-0 group-hover:opacity-100">‚ú® Custom</span>
                                                        </button>
                                                      ))
                                                    }
                                                    
                                                    {/* Show "No results" if no matches */}
                                                    {filteredNames.length === 0 && (
                                                      <div className="px-4 py-3 text-sm text-gray-500 text-center">
                                                        {language === 'vi' 
                                                          ? `Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£. Nh·∫≠p t√™n m·ªõi: "${editCrewCertData.cert_name}"` 
                                                          : `No results found. Type to add new: "${editCrewCertData.cert_name}"`
                                                        }
                                                      </div>
                                                    )}
                                                  </>
                                                );
                                              })()}
                                            </div>
                                          )}
                                        </div>
                                        <p className="text-xs text-gray-500 mt-1">
                                          {language === 'vi' 
                                            ? 'üí° Ch·ªçn t·ª´ danh s√°ch ho·∫∑c nh·∫≠p t√™n m·ªõi. T√™n m·ªõi s·∫Ω ƒë∆∞·ª£c l∆∞u t·ª± ƒë·ªông!' 
                                            : 'üí° Select from list or type a new name. New names will be saved automatically!'
                                          }
                                        </p>
                                      </div>

                                      {/* Certificate Number */}
                                      <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                          {language === 'vi' ? 'S·ªë ch·ª©ng ch·ªâ' : 'Certificate No.'} <span className="text-red-500">*</span>
                                        </label>
                                        <input
                                          type="text"
                                          value={editCrewCertData.cert_no}
                                          onChange={(e) => setEditCrewCertData({...editCrewCertData, cert_no: e.target.value})}
                                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                          required
                                        />
                                      </div>

                                      {/* Issued By */}
                                      <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                          {language === 'vi' ? 'N∆°i c·∫•p' : 'Issued By'}
                                        </label>
                                        <input
                                          type="text"
                                          value={editCrewCertData.issued_by}
                                          onChange={(e) => setEditCrewCertData({...editCrewCertData, issued_by: e.target.value})}
                                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        />
                                      </div>

                                      {/* Issued Date */}
                                      <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                          {language === 'vi' ? 'Ng√†y c·∫•p' : 'Issued Date'}
                                        </label>
                                        <input
                                          type="date"
                                          value={editCrewCertData.issued_date}
                                          onChange={(e) => setEditCrewCertData({...editCrewCertData, issued_date: e.target.value})}
                                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        />
                                      </div>

                                      {/* Expiry Date */}
                                      <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                          {language === 'vi' ? 'Ng√†y h·∫øt h·∫°n' : 'Expiry Date'}
                                        </label>
                                        <input
                                          type="date"
                                          value={editCrewCertData.cert_expiry}
                                          onChange={(e) => setEditCrewCertData({...editCrewCertData, cert_expiry: e.target.value})}
                                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        />
                                      </div>

                                      {/* Note */}
                                      <div className="col-span-2">
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                          {language === 'vi' ? 'Ghi ch√∫' : 'Note'}
                                        </label>
                                        <textarea
                                          value={editCrewCertData.note}
                                          onChange={(e) => setEditCrewCertData({...editCrewCertData, note: e.target.value})}
                                          rows="3"
                                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                          placeholder={language === 'vi' ? 'Nh·∫≠p ghi ch√∫ (t√πy ch·ªçn)' : 'Enter note (optional)'}
                                        />
                                      </div>
                                    </div>

                                    {/* Modal Footer */}
                                    <div className="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                                      <button
                                        type="button"
                                        onClick={closeEditCrewCertModal}
                                        className="px-6 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all"
                                      >
                                        {language === 'vi' ? 'H·ªßy' : 'Cancel'}
                                      </button>
                                      <button
                                        type="submit"
                                        className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all font-medium flex items-center"
                                      >
                                        <span className="mr-2">üíæ</span>
                                        {language === 'vi' ? 'C·∫≠p nh·∫≠t' : 'Update'}
                                      </button>
                                    </div>
                                  </form>
                                </div>
                              </div>
                            </div>
                          )}

                          {/* Certificate Holder Mismatch Confirmation Modal */}
                          {certHolderMismatchModal.show && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[10000] p-4">
                              <div className="bg-white rounded-xl shadow-2xl w-full max-w-md">
                                {/* Modal Header */}
                                <div className="p-6 border-b border-gray-200 bg-gradient-to-r from-yellow-50 to-orange-50">
                                  <div className="flex items-start">
                                    <div className="flex-shrink-0">
                                      <span className="text-3xl">‚ö†Ô∏è</span>
                                    </div>
                                    <div className="ml-3 flex-1">
                                      <h3 className="text-lg font-bold text-gray-800">
                                        {language === 'vi' ? 'C·∫£nh b√°o t√™n kh√¥ng kh·ªõp' : 'Name Mismatch Warning'}
                                      </h3>
                                    </div>
                                  </div>
                                </div>

                                {/* Modal Body */}
                                <div className="p-6">
                                  <p className="text-gray-700 mb-4">
                                    {language === 'vi' 
                                      ? 'T√™n tr√™n ch·ª©ng ch·ªâ kh√¥ng kh·ªõp v·ªõi t√™n thuy·ªÅn vi√™n ƒëang ch·ªçn.'
                                      : 'The name on the certificate does not match the selected crew member.'}
                                  </p>
                                  
                                  <div className="bg-gray-50 p-4 rounded-lg space-y-2 mb-4">
                                    <div>
                                      <span className="text-sm font-medium text-gray-600">
                                        {language === 'vi' ? 'T√™n tr√™n ch·ª©ng ch·ªâ:' : 'Name on certificate:'}
                                      </span>
                                      <p className="text-sm font-semibold text-gray-800 mt-1">
                                        {certHolderMismatchModal.holderName}
                                      </p>
                                    </div>
                                    
                                    <div className="border-t border-gray-200 pt-2">
                                      <span className="text-sm font-medium text-gray-600">
                                        {language === 'vi' ? 'Thuy·ªÅn vi√™n ƒëang ch·ªçn:' : 'Selected crew member:'}
                                      </span>
                                      <p className="text-sm font-semibold text-gray-800 mt-1">
                                        {certHolderMismatchModal.crewName}
                                        {certHolderMismatchModal.crewNameEn && (
                                          <span className="text-gray-600 ml-2">({certHolderMismatchModal.crewNameEn})</span>
                                        )}
                                      </p>
                                    </div>
                                  </div>
                                  
                                  <p className="text-sm text-gray-600">
                                    {language === 'vi' 
                                      ? 'B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c th√™m ch·ª©ng ch·ªâ n√†y kh√¥ng?'
                                      : 'Do you want to continue adding this certificate?'}
                                  </p>
                                </div>

                                {/* Modal Footer */}
                                <div className="p-6 border-t border-gray-200 bg-gray-50 flex justify-end space-x-3">
                                  <button
                                    type="button"
                                    onClick={handleCertMismatchSkip}
                                    className="px-6 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-all font-medium"
                                  >
                                    {language === 'vi' ? 'B·ªè qua' : 'Skip'}
                                  </button>
                                  <button
                                    type="button"
                                    onClick={handleCertMismatchContinue}
                                    className="px-6 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-all font-medium flex items-center"
                                    disabled={isAnalyzingCert}
                                  >
                                    {isAnalyzingCert ? (
                                      <>
                                        <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                          <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                          <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        {language === 'vi' ? 'ƒêang x·ª≠ l√Ω...' : 'Processing...'}
                                      </>
                                    ) : (
                                      <>
                                        <span className="mr-2">‚úì</span>
                                        {language === 'vi' ? 'Ti·∫øp t·ª•c' : 'Continue'}
                                      </>
                                    )}
                                  </button>
                                </div>
                              </div>
                            </div>
                          )}

                          {/* Date of Birth Mismatch Confirmation Modal */}
                          {certDobMismatchModal.show && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[10000] p-4">
                              <div className="bg-white rounded-xl shadow-2xl w-full max-w-md">
                                {/* Modal Header */}
                                <div className="p-6 border-b border-gray-200 bg-gradient-to-r from-yellow-50 to-orange-50">
                                  <div className="flex items-start">
                                    <div className="flex-shrink-0">
                                      <span className="text-3xl">‚ö†Ô∏è</span>
                                    </div>
                                    <div className="ml-3 flex-1">
                                      <h3 className="text-lg font-bold text-gray-800">
                                        {language === 'vi' ? 'C·∫£nh b√°o ng√†y sinh kh√¥ng kh·ªõp' : 'Date of Birth Mismatch Warning'}
                                      </h3>
                                    </div>
                                  </div>
                                </div>

                                {/* Modal Body */}
                                <div className="p-6">
                                  <p className="text-gray-700 mb-4">
                                    {language === 'vi' 
                                      ? 'Ng√†y sinh tr√™n ch·ª©ng ch·ªâ kh√¥ng kh·ªõp v·ªõi d·ªØ li·ªáu thuy·ªÅn vi√™n.'
                                      : 'The date of birth on the certificate does not match the crew member data.'}
                                  </p>
                                  
                                  <div className="bg-gray-50 p-4 rounded-lg space-y-2 mb-4">
                                    <div>
                                      <span className="text-sm font-medium text-gray-600">
                                        {language === 'vi' ? 'Ng√†y sinh tr√™n ch·ª©ng ch·ªâ (AI):' : 'Date of Birth on certificate (AI):'}
                                      </span>
                                      <p className="text-sm font-semibold text-gray-800 mt-1">
                                        {certDobMismatchModal.aiExtractedDob}
                                      </p>
                                    </div>
                                    
                                    <div className="border-t border-gray-200 pt-2">
                                      <span className="text-sm font-medium text-gray-600">
                                        {language === 'vi' ? 'Ng√†y sinh trong h·ªá th·ªëng:' : 'Date of Birth in system:'}
                                      </span>
                                      <p className="text-sm font-semibold text-gray-800 mt-1">
                                        {certDobMismatchModal.crewDob}
                                      </p>
                                    </div>
                                    
                                    <div className="border-t border-gray-200 pt-2">
                                      <span className="text-sm font-medium text-gray-600">
                                        {language === 'vi' ? 'Thuy·ªÅn vi√™n:' : 'Crew member:'}
                                      </span>
                                      <p className="text-sm font-semibold text-gray-800 mt-1">
                                        {certDobMismatchModal.crewName}
                                      </p>
                                    </div>
                                  </div>
                                  
                                  <p className="text-sm text-gray-600">
                                    {language === 'vi' 
                                      ? 'B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c th√™m ch·ª©ng ch·ªâ n√†y kh√¥ng?'
                                      : 'Do you want to continue adding this certificate?'}
                                  </p>
                                </div>

                                {/* Modal Footer */}
                                <div className="p-6 border-t border-gray-200 bg-gray-50 flex justify-end space-x-3">
                                  <button
                                    type="button"
                                    onClick={handleDobMismatchSkip}
                                    className="px-6 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-all font-medium"
                                  >
                                    {language === 'vi' ? 'B·ªè qua' : 'Skip'}
                                  </button>
                                  <button
                                    type="button"
                                    onClick={handleDobMismatchContinue}
                                    className="px-6 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-all font-medium flex items-center"
                                    disabled={isAnalyzingCert}
                                  >
                                    {isAnalyzingCert ? (
                                      <>
                                        <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                          <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                          <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        {language === 'vi' ? 'ƒêang x·ª≠ l√Ω...' : 'Processing...'}
                                      </>
                                    ) : (
                                      <>
                                        <span className="mr-2">‚úì</span>
                                        {language === 'vi' ? 'Ti·∫øp t·ª•c' : 'Continue'}
                                      </>
                                    )}
                                  </button>
                                </div>
                              </div>
                            </div>
                          )}

                          {/* Minimized Add Crew Certificate Modal Indicator */}
                          {showAddCrewCertModal && isAddCrewCertModalMinimized && (
                            <div 
                              onClick={() => {
                                console.log('üìÇ Restoring Add Crew Certificate modal...');
                                setIsAddCrewCertModalMinimized(false);
                              }}
                              className="fixed bottom-6 right-6 z-[9999] cursor-pointer group"
                            >
                              <div className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-2xl shadow-2xl hover:shadow-3xl transition-all hover:scale-105 p-4 min-w-[280px]">
                                <div className="flex items-center justify-between">
                                  <div className="flex items-center space-x-3">
                                    <div className="bg-white bg-opacity-20 rounded-full p-2">
                                      <span className="text-2xl">üìú</span>
                                    </div>
                                    <div>
                                      <div className="font-bold text-sm">
                                        {language === 'vi' ? 'Th√™m ch·ª©ng ch·ªâ' : 'Add Certificate'}
                                      </div>
                                      <div className="text-xs text-blue-100">
                                        {selectedCrewForCert 
                                          ? selectedCrewForCert.full_name 
                                          : (language === 'vi' ? 'ƒêang so·∫°n...' : 'In progress...')}
                                      </div>
                                    </div>
                                  </div>
                                  <div className="flex items-center space-x-2">
                                    <div className="bg-white bg-opacity-20 rounded-full p-1.5 group-hover:bg-opacity-30 transition-all">
                                      <span className="text-sm">‚Üë</span>
                                    </div>
                                  </div>
                                </div>
                                <div className="mt-2 text-xs text-blue-100">
                                  {language === 'vi' ? 'Click ƒë·ªÉ m·ªü l·∫°i' : 'Click to restore'}
                                </div>
                              </div>
                            </div>
                          )}

                        </>
                      )}
                    </div>
                  ) : (
                    /* Other categories content */
                    selectedCategory !== 'documents' || selectedSubMenu !== 'certificates' ? (
                      <div className="text-center py-12">
                        <div className="text-6xl mb-4">
                          {selectedCategory === 'ism' ? 'üìã' :
                           selectedCategory === 'isps' ? 'üõ°Ô∏è' :
                           selectedCategory === 'mlc' ? '‚öñÔ∏è' :
                           selectedCategory === 'supplies' ? 'üì¶' : 'üìã'}
                        </div>
                        <h3 className="text-xl font-semibold mb-2">
                          {subMenuItems[selectedCategory]?.find(item => item.key === selectedSubMenu)?.name || 
                           categories.find(cat => cat.key === selectedCategory)?.name}
                        </h3>
                        <p className="text-gray-600">
                          {language === 'vi' ? 'Danh m·ª•c n√†y ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn' : 'This section is under development'}
                        </p>
                      </div>
                    ) : null
                  )}
                </div>
              ) : (
                // Default view when no ship is selected
                <div>
                  {companyLogo ? (
                    <div className="w-full h-96 bg-gray-50 rounded-lg flex items-center justify-center overflow-hidden relative">
                      <img 
                        src={companyLogo.startsWith('http') ? companyLogo : `${BACKEND_URL}${companyLogo}`}
                        alt="Company Logo"
                        className="max-w-full max-h-full object-contain"
                        onError={(e) => {
                          console.error('Failed to load company logo:', e);
                          // Hide image and show fallback
                          e.target.style.display = 'none';
                        }}
                      />
                      <div className="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center">
                        <div className="bg-black bg-opacity-50 text-white p-6 rounded-lg text-center">
                          <h2 className="text-2xl font-bold mb-2">{language === 'vi' ? 'Ch√†o m·ª´ng ƒë·∫øn v·ªõi' : 'Welcome to'}</h2>
                          <p className="text-lg">{language === 'vi' ? 'H·ªá th·ªëng qu·∫£n l√≠ t√†u bi·ªÉn' : 'Ship Management System'}</p>
                        </div>
                      </div>
                    </div>
                  ) : (
                    <div className="w-full h-96 bg-gray-100 rounded-lg flex items-center justify-center">
                      <div className="text-center text-gray-500">
                        <div className="text-6xl mb-4">üö¢</div>
                        <h2 className="text-2xl font-bold mb-2">{language === 'vi' ? 'H·ªá th·ªëng qu·∫£n l√≠ t√†u bi·ªÉn' : 'Ship Management System'}</h2>
                        <p className="mb-4">{language === 'vi' ? 'Ch·ªçn t√†u t·ª´ danh m·ª•c b√™n tr√°i ƒë·ªÉ xem th√¥ng tin' : 'Select a ship from the left categories to view details'}</p>
                        <p className="text-sm">
                          {language === 'vi' ? 'Logo c√¥ng ty s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y khi ƒë∆∞·ª£c t·∫£i l√™n' : 'Company logo will be displayed here when uploaded'}
                        </p>
                      </div>
                    </div>
                  )}

                  {/* AI Features Section */}
                  <div className="mt-8 grid md:grid-cols-3 gap-4">
                    <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                      <h4 className="font-semibold text-blue-800 mb-2">{language === 'vi' ? 'Ph√¢n t√≠ch AI' : 'AI Analysis'}</h4>
                      <p className="text-sm text-blue-600">{language === 'vi' ? 'Ph√¢n t√≠ch t√†i li·ªáu t·ª± ƒë·ªông' : 'Automated document analysis'}</p>
                    </div>
                    
                    <div className="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-lg border border-green-200">
                      <h4 className="font-semibold text-green-800 mb-2">{language === 'vi' ? 'T√¨m ki·∫øm th√¥ng minh' : 'Smart Search'}</h4>
                      <p className="text-sm text-green-600">{language === 'vi' ? 'T√¨m ki·∫øm th√¥ng minh' : 'AI-powered search'}</p>
                    </div>
                    
                    <div className="bg-gradient-to-r from-purple-50 to-violet-50 p-4 rounded-lg border border-purple-200">
                      <h4 className="font-semibold text-purple-800 mb-2">{language === 'vi' ? 'Ki·ªÉm tra tu√¢n th·ªß' : 'Compliance Check'}</h4>
                      <p className="text-sm text-purple-600">{language === 'vi' ? 'Ki·ªÉm tra tu√¢n th·ªß' : 'Compliance monitoring'}</p>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>

      {/* Add Record Modal */}
      {showAddRecord && (
        <AddRecordModal
          onClose={() => {
            setShowAddRecord(false);
            setAddRecordDefaultTab(null); // Reset default tab
            setAddRecordDefaultDocumentType(null); // Reset default document type
            setDuplicateQueue([]); // Clear duplicate queue
          }}
          onSuccess={(type) => {
            setShowAddRecord(false);
            setAddRecordDefaultTab(null); // Reset default tab
            setAddRecordDefaultDocumentType(null); // Reset default document type
            if (type === 'ship') {
              fetchShips();
            } else if (type === 'certificate' && selectedShip) {
              fetchCertificates(selectedShip.id);
            }
            toast.success(language === 'vi' ? 'Th√™m h·ªì s∆° th√†nh c√¥ng!' : 'Record added successfully!');
          }}
          language={language}
          selectedShip={selectedShip}
          setSelectedShip={setSelectedShip}
          availableCompanies={availableCompanies}
          ships={ships}
          setShips={setShips}
          fetchCertificates={fetchCertificates}
          parentAiConfig={aiConfig}
          isMultiCertProcessing={isMultiCertProcessing}
          multiCertUploads={multiCertUploads}
          handleMultiCertUpload={handleMultiCertUpload}
          uploadSummary={uploadSummary}
          setMultiCertUploads={setMultiCertUploads}
          setUploadSummary={setUploadSummary}
          handleUploadToFolder={handleUploadToFolder}
          handleSkipFile={handleSkipFile}
          defaultTab={addRecordDefaultTab}
          defaultDocumentType={addRecordDefaultDocumentType}
          duplicateQueue={duplicateQueue}
          // File Viewer Modal props
          showFileViewer={showFileViewer}
          setShowFileViewer={setShowFileViewer}
          fileViewerData={fileViewerData}
          setFileViewerData={setFileViewerData}
          pendingManualReviews={pendingManualReviews}
          handleManualReviewAction={handleManualReviewAction}
          duplicateResolutionModal={duplicateResolutionModal}
          handleDuplicateResolution={handleDuplicateResolution}
          setIsMultiCertProcessing={setIsMultiCertProcessing}
        />
      )}

      {/* Ship List Modal */}
      {showShipListModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div 
            ref={shipListDrag.modalRef}
            className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[80vh] overflow-hidden"
            style={{
              transform: `translate(${shipListDrag.position.x}px, ${shipListDrag.position.y}px)`,
              cursor: shipListDrag.isDragging ? 'grabbing' : 'default',
              transition: shipListDrag.isDragging ? 'none' : 'transform 0.2s ease-out'
            }}
          >
            <div 
              className="flex justify-between items-center p-6 border-b border-gray-200"
              onMouseDown={shipListDrag.handleMouseDown}
              style={{ cursor: 'grab' }}
            >
              <h3 className="text-xl font-bold text-gray-800">
                {language === 'vi' ? 'Danh m·ª•c t√†u c√¥ng ty' : 'Company Ship List'}
              </h3>
              <button
                onClick={() => {
                  setShowShipListModal(false);
                  shipListDrag.resetPosition();
                }}
                className="text-gray-400 hover:text-gray-600 text-2xl font-bold leading-none"
              >
                √ó
              </button>
            </div>
            
            <div className="p-6 overflow-y-auto max-h-[calc(80vh-120px)]">
              {(() => {
                const userCompanyShips = getUserCompanyShips();
                return (
                  <>
                    <div className="mb-4 flex justify-between items-center">
                      <p className="text-sm text-gray-600">
                        {language === 'vi' 
                          ? `Hi·ªÉn th·ªã ${userCompanyShips.length} t√†u thu·ªôc c√¥ng ty: ${user?.company || 'N/A'}`
                          : `Showing ${userCompanyShips.length} ships from company: ${user?.company || 'N/A'}`
                        }
                      </p>
                    </div>
                    
                    {userCompanyShips.length === 0 ? (
                      <div className="text-center py-12">
                        <div className="text-6xl mb-4">üö¢</div>
                        <h4 className="text-lg font-semibold text-gray-700 mb-2">
                          {language === 'vi' ? 'Ch∆∞a c√≥ t√†u n√†o' : 'No ships available'}
                        </h4>
                        <p className="text-gray-500">
                          {language === 'vi' ? 'Ch∆∞a c√≥ t√†u n√†o thu·ªôc c√¥ng ty c·ªßa b·∫°n' : 'No ships belong to your company yet'}
                        </p>
                      </div>
                    ) : (
                      <div className="overflow-x-auto">
                        <table className="w-full border-collapse border border-gray-300 rounded-lg">
                          <thead>
                            <tr className="bg-gray-50">
                              <th className="border border-gray-300 px-4 py-3 text-left font-semibold">
                                {language === 'vi' ? 'T√™n t√†u' : 'Ship Name'}
                              </th>
                              <th className="border border-gray-300 px-4 py-3 text-left font-semibold">
                                {language === 'vi' ? 'IMO' : 'IMO'}
                              </th>
                              <th className="border border-gray-300 px-4 py-3 text-left font-semibold">
                                {language === 'vi' ? 'C·ªù' : 'Flag'}
                              </th>
                              <th className="border border-gray-300 px-4 py-3 text-left font-semibold">
                                {language === 'vi' ? 'H·∫°ng' : 'Class'}
                              </th>
                              <th className="border border-gray-300 px-4 py-3 text-left font-semibold">
                                {language === 'vi' ? 'T·ªïng Dung T√≠ch' : 'Gross Tonnage'}
                              </th>
                              <th className="border border-gray-300 px-4 py-3 text-left font-semibold">
                                {language === 'vi' ? 'Ch·ªß t√†u' : 'Ship Owner'}
                              </th>
                              <th className="border border-gray-300 px-4 py-3 text-center font-semibold">
                                {language === 'vi' ? 'Thao t√°c' : 'Actions'}
                              </th>
                            </tr>
                          </thead>
                          <tbody>
                            {userCompanyShips.map((ship) => (
                              <tr key={ship.id} className="hover:bg-gray-50">
                                <td className="border border-gray-300 px-4 py-3 font-medium text-gray-800">
                                  {ship.name}
                                </td>
                                <td className="border border-gray-300 px-4 py-3 text-gray-600">
                                  {ship.imo_number || '-'}
                                </td>
                                <td className="border border-gray-300 px-4 py-3">
                                  {ship.flag || '-'}
                                </td>
                                <td className="border border-gray-300 px-4 py-3">
                                  {ship.class_society || '-'}
                                </td>
                                <td className="border border-gray-300 px-4 py-3">
                                  {ship.gross_tonnage?.toLocaleString() || '-'}
                                </td>
                                <td className="border border-gray-300 px-4 py-3">
                                  {ship.ship_owner || '-'}
                                </td>
                                <td className="border border-gray-300 px-4 py-3 text-center">
                                  <button
                                    onClick={() => {
                                      setSelectedShip(ship);
                                      setCrewFilters({...crewFilters, ship_sign_on: ship.name});
                                      setSelectedCategory('documents');
                                      setShowShipListModal(false);
                                    }}
                                    className="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm transition-all"
                                  >
                                    {language === 'vi' ? 'Xem chi ti·∫øt' : 'View Details'}
                                  </button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </>
                );
              })()}
            </div>
          </div>
        </div>
      )}

      {/* Edit Ship Modal */}
      {showEditShipModal && editingShipData && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div 
            ref={editShipDrag.modalRef}
            className="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[95vh] overflow-hidden"
            style={{
              transform: `translate(${editShipDrag.position.x}px, ${editShipDrag.position.y}px)`,
              cursor: editShipDrag.isDragging ? 'grabbing' : 'default',
              transition: editShipDrag.isDragging ? 'none' : 'transform 0.2s ease-out'
            }}
          >
            <div 
              className="flex justify-between items-center px-6 py-4 border-b border-gray-200"
              onMouseDown={editShipDrag.handleMouseDown}
              style={{ cursor: 'grab' }}
            >
              <h3 className="text-xl font-bold text-gray-800">
                {language === 'vi' ? 'Ch·ªânh s·ª≠a th√¥ng tin t√†u' : 'Edit Ship Information'}
              </h3>
              <button
                onClick={() => {
                  setShowEditShipModal(false);
                  setEditingShipData(null);
                  editShipDrag.resetPosition();
                }}
                className="text-gray-400 hover:text-gray-600 text-2xl font-bold leading-none"
              >
                √ó
              </button>
            </div>
            
            <div className="p-6">
              <form onSubmit={(e) => {
                e.preventDefault();
                handleEditShip(editingShipData);
              }}>
                <div className="grid grid-cols-12 gap-4">
                  
                  {/* Basic Ship Information Section */}
                  <div className="col-span-12">
                    <h4 className="text-lg font-semibold text-gray-700 mb-3 pb-2 border-b">
                      {language === 'vi' ? 'Th√¥ng tin c∆° b·∫£n' : 'Basic Information'}
                    </h4>
                  </div>
                  
                  {/* Ship Name - Full width */}
                  <div className="col-span-6">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'T√™n t√†u' : 'Ship Name'} *
                    </label>
                    <input
                      type="text"
                      required
                      value={editingShipData.name || ''}
                      onChange={(e) => setEditingShipData(prev => ({ ...prev, name: e.target.value }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                    />
                  </div>

                  {/* IMO - Short width */}
                  <div className="col-span-3">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'S·ªë IMO' : 'IMO Number'}
                    </label>
                    <input
                      type="text"
                      value={editingShipData.imo || ''}
                      onChange={(e) => setEditingShipData(prev => ({ ...prev, imo: e.target.value }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                      placeholder="1234567"
                    />
                  </div>

                  {/* Flag - Medium width */}
                  <div className="col-span-3">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'C·ªù' : 'Flag'} *
                    </label>
                    <input
                      type="text"
                      required
                      value={editingShipData.flag || ''}
                      onChange={(e) => setEditingShipData(prev => ({ ...prev, flag: e.target.value }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                    />
                  </div>

                  {/* Class Society - Medium width */}
                  <div className="col-span-4">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'T·ªï ch·ª©c Ph√¢n c·∫•p' : 'Class Society'} *
                    </label>
                    <input
                      type="text"
                      required
                      value={editingShipData.class_society || ''}
                      onChange={(e) => setEditingShipData(prev => ({ ...prev, class_society: e.target.value }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                    />
                  </div>

                  {/* Ship Owner - Medium width */}
                  <div className="col-span-4">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'Ch·ªß t√†u' : 'Ship Owner'} *
                    </label>
                    <input
                      type="text"
                      required
                      value={editingShipData.ship_owner || ''}
                      onChange={(e) => setEditingShipData(prev => ({ ...prev, ship_owner: e.target.value }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                    />
                  </div>

                  {/* Gross Tonnage - Short width */}
                  <div className="col-span-2">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'GT' : 'GT'}
                    </label>
                    <input
                      type="number"
                      value={editingShipData.gross_tonnage || ''}
                      onChange={(e) => setEditingShipData(prev => ({ ...prev, gross_tonnage: e.target.value }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                      placeholder="0"
                    />
                  </div>

                  {/* Deadweight - Short width */}
                  <div className="col-span-2">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'DWT' : 'DWT'}
                    </label>
                    <input
                      type="number"
                      value={editingShipData.deadweight || ''}
                      onChange={(e) => setEditingShipData(prev => ({ ...prev, deadweight: e.target.value }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                      placeholder="0"
                    />
                  </div>

                  {/* Built Year - Short width */}
                  <div className="col-span-2">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'NƒÉm ƒë√≥ng' : 'Built Year'}
                    </label>
                    <input
                      type="number"
                      value={editingShipData.built_year || ''}
                      onChange={(e) => setEditingShipData(prev => ({ ...prev, built_year: e.target.value }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                      placeholder="2020"
                    />
                  </div>

                  {/* Delivery Date - Short width */}
                  <div className="col-span-2">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'Ng√†y giao' : 'Delivery Date'}
                    </label>
                    <input
                      type="date"
                      value={editingShipData.delivery_date || ''}
                      onChange={(e) => setEditingShipData(prev => ({ ...prev, delivery_date: e.target.value ? e.target.value : null }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                    />
                  </div>

                  {/* Keel Laid - Short width */}
                  <div className="col-span-2">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'Keel Laid' : 'Keel Laid'}
                    </label>
                    <input
                      type="date"
                      value={editingShipData.keel_laid || ''}
                      onChange={(e) => setEditingShipData(prev => ({ ...prev, keel_laid: e.target.value ? e.target.value : null }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                    />
                  </div>

                  {/* Survey & Maintenance Section */}
                  <div className="col-span-12 mt-4">
                    <h4 className="text-lg font-semibold text-gray-700 mb-3 pb-2 border-b">
                      {language === 'vi' ? 'Th√¥ng tin Chi ti·∫øt T√†u' : 'Detailed Ship Information'}
                    </h4>
                  </div>

                  {/* Docking Dates Row */}
                  <div className="col-span-3">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'Last Docking 1' : 'Last Docking 1'}
                    </label>
                    <input
                      type="date"
                      value={editingShipData.last_docking || ''}
                      onChange={(e) => setEditingShipData(prev => ({ ...prev, last_docking: e.target.value }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                    />
                  </div>

                  <div className="col-span-3">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'Last Docking 2' : 'Last Docking 2'}
                    </label>
                    <input
                      type="date"
                      value={editingShipData.last_docking_2 || ''}
                      onChange={(e) => setEditingShipData(prev => ({ ...prev, last_docking_2: e.target.value }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                    />
                  </div>

                  <div className="col-span-3">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'Next Docking' : 'Next Docking'}
                    </label>
                    <div className="flex space-x-1">
                      <input
                        type="date"
                        value={editingShipData.next_docking || ''}
                        onChange={(e) => setEditingShipData(prev => ({ ...prev, next_docking: e.target.value }))}
                        className="flex-1 px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                      />
                      <button
                        type="button"
                        onClick={() => handleRecalculateNextDocking(editingShipData.id)}
                        className="px-2 py-2 bg-orange-100 hover:bg-orange-200 text-orange-800 text-xs rounded-lg transition-colors"
                        title="Auto-calculate"
                      >
                        IMO
                      </button>
                    </div>
                  </div>

                  <div className="col-span-3">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'Last Special Survey' : 'Last Special Survey'}
                    </label>
                    <input
                      type="date"
                      value={editingShipData.last_special_survey || ''}
                      onChange={(e) => setEditingShipData(prev => ({ ...prev, last_special_survey: e.target.value }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                    />
                  </div>

                  <div className="col-span-3">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      <span className="flex items-center">
                        {language === 'vi' ? 'Last Intermediate Survey' : 'Last Intermediate Survey'}
                        <div className="group relative ml-1">
                          <svg className="w-3 h-3 text-gray-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                          <div className="absolute bottom-full left-0 mb-2 w-64 p-2 text-xs text-white bg-gray-800 rounded opacity-0 group-hover:opacity-100 transition-opacity z-10">
                            {language === 'vi' 
                              ? 'Ki·ªÉm tra trung gian th·ª±c hi·ªán gi·ªØa 2 Special Survey (th∆∞·ªùng 2.5-3 nƒÉm). Theo quy ƒë·ªãnh IMO, Class Society nh∆∞ DNV GL, Lloyd\'s Register, ABS, Bureau Veritas.'
                              : 'Intermediate inspection between Special Surveys (typically 2.5-3 years). Required by IMO, Class Societies like DNV GL, Lloyd\'s Register, ABS, Bureau Veritas.'}
                          </div>
                        </div>
                      </span>
                    </label>
                    <input
                      type="date"
                      value={editingShipData.last_intermediate_survey || ''}
                      onChange={(e) => setEditingShipData(prev => ({ ...prev, last_intermediate_survey: e.target.value }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                    />
                  </div>

                  {/* Anniversary Date Section */}
                  <div className="col-span-6 mt-2">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'Anniversary Date' : 'Anniversary Date'}
                    </label>
                    <div className="grid grid-cols-3 gap-2">
                      <div>
                        <input
                          type="number"
                          min="1"
                          max="31"
                          value={editingShipData.anniversary_date?.day || ''}
                          onChange={(e) => setEditingShipData(prev => ({ 
                            ...prev, 
                            anniversary_date: {
                              ...prev.anniversary_date,
                              day: parseInt(e.target.value) || null,
                              manual_override: true,
                              auto_calculated: false,
                              source_certificate_type: "Manual Entry"
                            }
                          }))}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                          placeholder="Day"
                        />
                      </div>
                      <div>
                        <select
                          value={editingShipData.anniversary_date?.month || ''}
                          onChange={(e) => setEditingShipData(prev => ({ 
                            ...prev, 
                            anniversary_date: {
                              ...prev.anniversary_date,
                              month: parseInt(e.target.value) || null,
                              manual_override: true,
                              auto_calculated: false,
                              source_certificate_type: "Manual Entry"
                            }
                          }))}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                        >
                          <option value="">Month</option>
                          <option value="1">Jan</option>
                          <option value="2">Feb</option>
                          <option value="3">Mar</option>
                          <option value="4">Apr</option>
                          <option value="5">May</option>
                          <option value="6">Jun</option>
                          <option value="7">Jul</option>
                          <option value="8">Aug</option>
                          <option value="9">Sep</option>
                          <option value="10">Oct</option>
                          <option value="11">Nov</option>
                          <option value="12">Dec</option>
                        </select>
                      </div>
                      <div>
                        <button
                          type="button"
                          onClick={() => handleRecalculateAnniversaryDate(editingShipData.id)}
                          className="w-full px-3 py-2 bg-blue-100 hover:bg-blue-200 text-blue-800 text-sm rounded-lg transition-colors"
                        >
                          Auto
                        </button>
                      </div>
                    </div>
                  </div>

                  {/* Special Survey Cycle Section */}
                  <div className="col-span-6 mt-2">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'Special Survey Cycle (IMO 5-year)' : 'Special Survey Cycle (IMO 5-year)'}
                    </label>
                    <div className="grid grid-cols-3 gap-2">
                      <div>
                        <input
                          type="date"
                          value={editingShipData.special_survey_cycle?.from_date || ''}
                          onChange={(e) => setEditingShipData(prev => ({ 
                            ...prev, 
                            special_survey_cycle: {
                              ...prev.special_survey_cycle,
                              from_date: e.target.value,
                              cycle_type: "IMO 5-year Standard",
                              manual_override: true,
                              auto_calculated: false
                            }
                          }))}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                          placeholder="From Date"
                        />
                      </div>
                      <div>
                        <input
                          type="date"
                          value={editingShipData.special_survey_cycle?.to_date || ''}
                          onChange={(e) => setEditingShipData(prev => ({ 
                            ...prev, 
                            special_survey_cycle: {
                              ...prev.special_survey_cycle,
                              to_date: e.target.value,
                              cycle_type: "IMO 5-year Standard",
                              manual_override: true,
                              auto_calculated: false
                            }
                          }))}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                          placeholder="To Date"
                        />
                      </div>
                      <div>
                        <button
                          type="button"
                          onClick={() => handleRecalculateSpecialSurveyCycle(editingShipData.id)}
                          className="w-full px-3 py-2 bg-purple-100 hover:bg-purple-200 text-purple-800 text-sm rounded-lg transition-colors"
                        >
                          Auto
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Action Buttons */}
                <div className="flex justify-between mt-6 pt-4 border-t border-gray-200">
                  {/* Delete Button - Left side */}
                  <button
                    type="button"
                    onClick={() => {
                      setDeleteShipData(editingShipData);
                      setShowDeleteShipModal(true);
                    }}
                    className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-all font-medium flex items-center"
                  >
                    <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    {language === 'vi' ? 'X√≥a t√†u' : 'Delete Ship'}
                  </button>

                  {/* Cancel and Save Buttons - Right side */}
                  <div className="flex space-x-3">
                    <button
                      type="button"
                      onClick={() => {
                        setShowEditShipModal(false);
                        setEditingShipData(null);
                      }}
                      className="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all"
                    >
                      {language === 'vi' ? 'H·ªßy' : 'Cancel'}
                    </button>
                    <button
                      type="submit"
                      className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all font-medium"
                    >
                      {editingCertificate?.manual_input_mode
                        ? (language === 'vi' ? 'T·∫°o Certificate' : 'Create Certificate')
                        : (language === 'vi' ? 'L∆∞u thay ƒë·ªïi' : 'Save Changes')
                      }
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}

      {/* Delete Ship Confirmation Modal */}
      {showDeleteShipModal && deleteShipData && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div 
            ref={deleteShipDrag.modalRef}
            className="bg-white rounded-xl shadow-2xl w-full max-w-2xl"
            style={{
              transform: `translate(${deleteShipDrag.position.x}px, ${deleteShipDrag.position.y}px)`,
              cursor: deleteShipDrag.isDragging ? 'grabbing' : 'default',
              transition: deleteShipDrag.isDragging ? 'none' : 'transform 0.2s ease-out'
            }}
          >
            <div 
              className="flex justify-between items-center px-6 py-4 border-b border-gray-200"
              onMouseDown={deleteShipDrag.handleMouseDown}
              style={{ cursor: 'grab' }}
            >
              <h3 className="text-xl font-bold text-red-600 flex items-center">
                <svg className="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
                {language === 'vi' ? 'X√°c nh·∫≠n x√≥a t√†u' : 'Confirm Ship Deletion'}
              </h3>
              <button
                onClick={() => {
                  setShowDeleteShipModal(false);
                  setDeleteShipData(null);
                  setDeleteShipOption('database_only');
                  deleteShipDrag.resetPosition();
                }}
                className="text-gray-400 hover:text-gray-600 text-2xl font-bold leading-none"
              >
                √ó
              </button>
            </div>
            
            <div className="p-6">
              <div className="mb-6">
                <div className="flex items-center justify-center w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full">
                  <svg className="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </div>
                
                <h4 className="text-lg font-semibold text-gray-900 text-center mb-2">
                  {language === 'vi' 
                    ? `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†u "${deleteShipData.name}"?`
                    : `Are you sure you want to delete ship "${deleteShipData.name}"?`
                  }
                </h4>
                
                <p className="text-sm text-gray-600 text-center mb-6">
                  {language === 'vi' 
                    ? 'H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c. Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c x√≥a:'
                    : 'This action cannot be undone. Please choose the deletion method:'
                  }
                </p>

                {/* Deletion Options */}
                <div className="space-y-4">
                  {/* Option 1: Database Only */}
                  <div 
                    onClick={() => setDeleteShipOption('database_only')}
                    className={`border rounded-lg p-4 cursor-pointer transition-all ${
                      deleteShipOption === 'database_only' 
                        ? 'border-blue-500 bg-blue-50' 
                        : 'border-gray-200 hover:border-gray-300'
                    }`}
                  >
                    <div className="flex items-start">
                      <input
                        type="radio"
                        name="deleteOption"
                        value="database_only"
                        checked={deleteShipOption === 'database_only'}
                        onChange={(e) => setDeleteShipOption(e.target.value)}
                        className="mt-1 mr-3"
                      />
                      <div>
                        <h5 className="font-medium text-gray-900">
                          {language === 'vi' ? 'Ch·ªâ x√≥a d·ªØ li·ªáu tr√™n Database' : 'Delete Database Data Only'}
                        </h5>
                        <p className="text-sm text-gray-600 mt-1">
                          {language === 'vi' 
                            ? 'X√≥a th√¥ng tin t√†u v√† t·∫•t c·∫£ ch·ª©ng ch·ªâ kh·ªèi h·ªá th·ªëng. Gi·ªØ nguy√™n folder tr√™n Google Drive.'
                            : 'Remove ship information and all certificates from the system. Keep Google Drive folder intact.'
                          }
                        </p>
                      </div>
                    </div>
                  </div>

                  {/* Option 2: Database + Google Drive */}
                  <div 
                    onClick={() => setDeleteShipOption('with_gdrive')}
                    className={`border rounded-lg p-4 cursor-pointer transition-all ${
                      deleteShipOption === 'with_gdrive' 
                        ? 'border-red-500 bg-red-50' 
                        : 'border-gray-200 hover:border-gray-300'
                    }`}
                  >
                    <div className="flex items-start">
                      <input
                        type="radio"
                        name="deleteOption"
                        value="with_gdrive"
                        checked={deleteShipOption === 'with_gdrive'}
                        onChange={(e) => setDeleteShipOption(e.target.value)}
                        className="mt-1 mr-3"
                      />
                      <div>
                        <h5 className="font-medium text-gray-900">
                          {language === 'vi' ? 'X√≥a c·∫£ Folder tr√™n Google Drive' : 'Delete Including Google Drive Folder'}
                        </h5>
                        <p className="text-sm text-gray-600 mt-1">
                          {language === 'vi' 
                            ? 'X√≥a ho√†n to√†n th√¥ng tin t√†u v√† to√†n b·ªô folder structure tr√™n Google Drive. KH√îNG TH·ªÇ KH√îI PH·ª§C!'
                            : 'Completely remove ship information and entire Google Drive folder structure. CANNOT BE RECOVERED!'
                          }
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Action Buttons */}
              <div className="flex justify-end space-x-3">
                <button
                  onClick={() => {
                    setShowDeleteShipModal(false);
                    setDeleteShipData(null);
                    setDeleteShipOption('database_only');
                  }}
                  disabled={isDeletingShip}
                  className="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all disabled:opacity-50"
                >
                  {language === 'vi' ? 'H·ªßy' : 'Cancel'}
                </button>
                <button
                  onClick={() => handleDeleteShip(deleteShipData.id, deleteShipOption)}
                  disabled={isDeletingShip}
                  className={`px-6 py-2 text-white rounded-lg transition-all font-medium flex items-center disabled:opacity-50 ${
                    deleteShipOption === 'with_gdrive' 
                      ? 'bg-red-600 hover:bg-red-700' 
                      : 'bg-orange-600 hover:bg-orange-700'
                  }`}
                >
                  {isDeletingShip ? (
                    <>
                      <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      {language === 'vi' ? 'ƒêang x√≥a...' : 'Deleting...'}
                    </>
                  ) : (
                    <>
                      <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                      {language === 'vi' ? 'X√≥a t√†u' : 'Delete Ship'}
                    </>
                  )}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Quick Edit Survey Type Context Menu - Moved to HomePage level */}
      {quickEditMenu.show && (
        <>
          {console.log('üéØ Rendering context menu at HomePage level:', quickEditMenu)}
          {/* Background overlay to close menu when clicking outside */}
          <div 
            className="fixed inset-0 z-[9998]"
            onClick={closeQuickEditMenu}
          />
          
          {/* Context Menu */}
          <div
            className="fixed z-[9999] bg-white border border-gray-200 rounded-lg shadow-xl py-2 min-w-48"
            style={{
              left: `${quickEditMenu.position.x}px`,
              top: `${quickEditMenu.position.y}px`,
              transform: quickEditMenu.position.x > (typeof window !== 'undefined' ? window.innerWidth : 1920) - 200 
                ? 'translateX(-100%)' 
                : 'translateX(0)',
            }}
          >
            <div className="px-3 py-2 text-xs font-medium text-gray-500 border-b border-gray-100">
              {language === 'vi' ? 'Ch·ªçn lo·∫°i ki·ªÉm tra' : 'Select Survey Type'}
            </div>
            
            {/* Survey Type Options */}
            {[
              { value: '', label: language === 'vi' ? 'Kh√¥ng c√≥' : 'None', color: 'text-gray-600' },
              { value: 'Initial', label: language === 'vi' ? 'Ki·ªÉm tra l·∫ßn ƒë·∫ßu' : 'Initial', color: 'text-indigo-600' },
              { value: 'Annual', label: language === 'vi' ? 'Ki·ªÉm tra h√†ng nƒÉm' : 'Annual', color: 'text-blue-600' },
              { value: 'Intermediate', label: language === 'vi' ? 'Ki·ªÉm tra trung gian' : 'Intermediate', color: 'text-yellow-600' },
              { value: 'Special', label: language === 'vi' ? 'Ki·ªÉm tra ƒë·ªãnh k·ª≥' : 'Special', color: 'text-purple-600' },
              { value: 'Renewal', label: language === 'vi' ? 'Ki·ªÉm tra c·∫•p m·ªõi' : 'Renewal', color: 'text-green-600' },
              { value: 'Docking', label: language === 'vi' ? 'Ki·ªÉm tra tr√™n ƒë√†' : 'Docking', color: 'text-orange-600' },
              { value: 'Other', label: language === 'vi' ? 'Kh√°c' : 'Other', color: 'text-gray-600' }
            ].map((option) => (
              <button
                key={option.value}
                onClick={() => handleQuickUpdateSurveyType(option.value)}
                className={`w-full text-left px-3 py-2 text-sm hover:bg-gray-50 transition-colors ${
                  quickEditMenu.currentValue === option.value ? 'bg-blue-50 text-blue-700 font-medium' : option.color
                }`}
              >
                <div className="flex items-center justify-between">
                  <span>{option.label}</span>
                  {quickEditMenu.currentValue === option.value && (
                    <svg className="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                      <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                    </svg>
                  )}
                </div>
              </button>
            ))}
          </div>
        </>
      )}

      {/* Auto Rename Confirmation Dialog */}
      {showAutoRenameDialog && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div className="flex items-center mb-4">
              <div className="flex-shrink-0 w-10 h-10 mx-auto bg-orange-100 rounded-full flex items-center justify-center">
                <svg className="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                </svg>
              </div>
            </div>
            
            <h3 className="text-lg leading-6 font-medium text-gray-900 text-center mb-4">
              {language === 'vi' ? 'Auto Rename Files' : 'Auto Rename Files'}
            </h3>
            
            <div className="text-sm text-gray-500 mb-6">
              <p className="mb-3">
                {language === 'vi' 
                  ? 'Ch·ª©c nƒÉng n√†y s·∫Ω t·ª± ƒë·ªông ƒë·ªïi t√™n c√°c files tr√™n Google Drive theo ƒë·ªãnh d·∫°ng:' 
                  : 'This feature will automatically rename files on Google Drive using the format:'}
              </p>
              <div className="bg-gray-100 p-3 rounded-md mb-3">
                <code className="text-xs text-gray-800">
                  {language === 'vi' 
                    ? 'T√™n_T√†u + Lo·∫°i_Ch·ª©ng_Ch·ªâ + T√™n_Vi·∫øt_T·∫Øt + Ng√†y_C·∫•p' 
                    : 'Ship_Name + Cert_Type + Certificate_Abbreviation + Issue_Date'}
                </code>
              </div>
              <p className="mb-3">
                {(selectedCertificates && selectedCertificates.size > 1)
                  ? (language === 'vi' 
                      ? `S·∫Ω x·ª≠ l√Ω ${selectedCertificates.size} ch·ª©ng ch·ªâ ƒë∆∞·ª£c ch·ªçn.` 
                      : `Will process ${selectedCertificates.size} selected certificates.`)
                  : (language === 'vi' 
                      ? 'S·∫Ω x·ª≠ l√Ω 1 ch·ª©ng ch·ªâ.' 
                      : 'Will process 1 certificate.')
                }
              </p>
              <p className="text-orange-600 font-medium">
                {language === 'vi' 
                  ? '‚ö†Ô∏è Qu√° tr√¨nh s·∫Ω ch·∫°y trong background v√† kh√¥ng th·ªÉ ho√†n t√°c.' 
                  : '‚ö†Ô∏è Process will run in background and cannot be undone.'}
              </p>
            </div>
            
            {/* Progress Display */}
            {batchRenameProgress.isRunning && (
              <div className="mb-4">
                <div className="flex justify-between text-sm text-gray-600 mb-2">
                  <span>
                    {language === 'vi' ? 'ƒêang x·ª≠ l√Ω...' : 'Processing...'}
                  </span>
                  <span>
                    {batchRenameProgress.completed}/{batchRenameProgress.total}
                  </span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-2">
                  <div 
                    className="bg-orange-500 h-2 rounded-full transition-all duration-300"
                    style={{ width: `${(batchRenameProgress.completed / batchRenameProgress.total) * 100}%` }}
                  ></div>
                </div>
                {batchRenameProgress.current && (
                  <p className="text-xs text-gray-500 mt-2">
                    {language === 'vi' ? 'Hi·ªán t·∫°i: ' : 'Current: '}{batchRenameProgress.current}
                  </p>
                )}
              </div>
            )}
            
            <div className="flex space-x-3">
              <button
                onClick={() => {
                  setShowAutoRenameDialog(false);
                  setBatchRenameProgress({ isRunning: false, completed: 0, total: 0, current: '', errors: [] });
                }}
                disabled={batchRenameProgress.isRunning}
                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {language === 'vi' ? 'Kh√¥ng' : 'No'}
              </button>
              <button
                onClick={handleExecuteBatchAutoRename}
                disabled={batchRenameProgress.isRunning}
                className="flex-1 px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
              >
                {batchRenameProgress.isRunning ? (
                  <>
                    <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                    {language === 'vi' ? 'ƒêang x·ª≠ l√Ω...' : 'Processing...'}
                  </>
                ) : (
                  <>
                    {language === 'vi' ? 'C√≥, ti·∫øp t·ª•c' : 'Yes, Continue'}
                  </>
                )}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Upcoming Surveys Notification Modal */}
      {upcomingSurveysModal.show && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[90]">
          <div className="bg-white rounded-xl shadow-2xl p-6 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div className="mb-6">
              <h3 className="text-xl font-bold text-orange-600 mb-2 flex items-center">
                ‚ö†Ô∏è {language === 'vi' ? 'Th√¥ng b√°o Survey s·∫Øp ƒë·∫øn h·∫°n' : 'Upcoming Survey Notification'}
              </h3>
              <p className="text-gray-700 mb-4">
                {language === 'vi' 
                  ? 'C√°c Gi·∫•y ch·ª©ng nh·∫≠n sau s·∫Øp ƒë·∫øn h·∫°n ki·ªÉm tra, h√£y b·ªë tr√≠ ki·ªÉm tra trong th·ªùi gian s·ªõm nh·∫•t:'
                  : 'The following certificates are approaching their survey dates. Please arrange inspections as soon as possible:'}
              </p>
              <div className="text-sm text-gray-600 mb-4">
                {language === 'vi' 
                  ? `T·ªïng c·ªông: ${upcomingSurveysModal.totalCount} ch·ª©ng ch·ªâ | C√¥ng ty: ${upcomingSurveysModal.company}`
                  : `Total: ${upcomingSurveysModal.totalCount} certificates | Company: ${upcomingSurveysModal.company}`}
              </div>
            </div>

            {/* Certificates Table */}
            <div className="overflow-x-auto">
              <table className="min-w-full bg-white border border-gray-200 rounded-lg">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                      {language === 'vi' ? 'T√™n T√†u' : 'Ship Name'}
                    </th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                      {language === 'vi' ? 'T√™n Ch·ª©ng ch·ªâ' : 'Cert. Name (Abbreviation)'}
                    </th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                      {language === 'vi' ? 'Next Survey' : 'Next Survey'}
                    </th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                      {language === 'vi' ? 'Lo·∫°i Survey' : 'Next Survey Type'}
                    </th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                      {language === 'vi' ? 'Last Endorse' : 'Last Endorse'}
                    </th>
                    <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                      {language === 'vi' ? 'T√¨nh tr·∫°ng' : 'Status'}
                    </th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {upcomingSurveysModal.surveys.map((survey, index) => (
                    <tr key={index} className={`hover:bg-gray-50 ${survey.is_overdue ? 'bg-red-50' : survey.is_due_soon ? 'bg-yellow-50' : ''}`}>
                      <td className="px-4 py-3 text-sm text-gray-900 border-b">
                        <div className="font-medium">{survey.ship_name}</div>
                      </td>
                      <td className="px-4 py-3 text-sm text-gray-900 border-b">
                        <div className="font-medium">{survey.cert_name_display}</div>
                      </td>
                      <td className="px-4 py-3 text-sm text-gray-900 border-b">
                        <div className="font-medium">{formatDateDisplay(survey.next_survey)}</div>
                        <div className="text-xs text-gray-500">
                          {survey.days_until_survey >= 0 
                            ? (language === 'vi' ? `C√≤n ${survey.days_until_survey} ng√†y` : `${survey.days_until_survey} days left`)
                            : (language === 'vi' ? `Qu√° h·∫°n ${Math.abs(survey.days_until_survey)} ng√†y` : `${Math.abs(survey.days_until_survey)} days overdue`)
                          }
                        </div>
                        {survey.window_type && (
                          <div className="text-xs text-blue-600 font-medium">
                            {survey.window_type}
                          </div>
                        )}
                      </td>
                      <td className="px-4 py-3 text-sm text-gray-900 border-b">
                        {survey.next_survey_type || '-'}
                      </td>
                      <td className="px-4 py-3 text-sm text-gray-900 border-b">
                        {formatDateDisplay(survey.last_endorse)}
                      </td>
                      <td className="px-4 py-3 text-sm border-b">
                        {survey.is_critical ? (
                          <span className="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                            {survey.is_overdue 
                              ? (language === 'vi' ? 'Qu√° h·∫°n' : 'Overdue')
                              : (language === 'vi' ? 'Kh·∫©n c·∫•p' : 'Critical')
                            }
                          </span>
                        ) : survey.is_due_soon ? (
                          <span className="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">
                            {language === 'vi' ? 'S·∫Øp ƒë·∫øn h·∫°n' : 'Due Soon'}
                          </span>
                        ) : (
                          <span className="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                            {language === 'vi' ? 'Trong Window' : 'In Window'}
                          </span>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            {/* Action Buttons */}
            <div className="mt-6 flex justify-end space-x-3">
              <button
                onClick={() => setUpcomingSurveysModal({ show: false, surveys: [], totalCount: 0, company: '', checkDate: '' })}
                className="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition duration-200"
              >
                {language === 'vi' ? 'ƒê√£ hi·ªÉu' : 'Got it'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Add Crew Modal */}
      {showAddCrewModal && !isAddCrewModalMinimized && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div 
            ref={addCrewDrag.modalRef}
            className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden"
            style={{
              transform: `translate(${addCrewDrag.position.x}px, ${addCrewDrag.position.y}px)`,
              cursor: addCrewDrag.isDragging ? 'grabbing' : 'default',
              transition: addCrewDrag.isDragging ? 'none' : 'transform 0.2s ease-out'
            }}
          >
            <div 
              className="p-6 border-b border-gray-200"
              onMouseDown={addCrewDrag.handleMouseDown}
              style={{ cursor: 'grab' }}
            >
              <div className="flex justify-between items-center">
                <div className="flex items-center space-x-3">
                  <h3 className="text-xl font-bold text-gray-800">
                    {language === 'vi' ? 'Th√™m thuy·ªÅn vi√™n m·ªõi' : 'Add New Crew Member'}
                  </h3>
                  {newCrewData.status === 'Standby' ? (
                    <span className="text-xl font-medium text-orange-600">
                      {language === 'vi' ? 'cho' : 'for'}: <span className="font-bold">{language === 'vi' ? 'Standby Crew' : 'Standby Crew'}</span>
                    </span>
                  ) : selectedShip ? (
                    <span className="text-xl font-medium text-gray-800">
                      {language === 'vi' ? 'cho' : 'for'}: <span className="font-bold text-blue-600">{selectedShip.name}</span>
                    </span>
                  ) : null}
                </div>
                <div className="flex items-center space-x-3">
                  {/* Ship Select Dropdown - Only show when NOT in Standby mode */}
                  {newCrewData.status !== 'Standby' && (
                    <div className="relative">
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          setShowShipDropdown(!showShipDropdown);
                        }}
                        className="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white rounded-lg font-medium text-sm transition-all flex items-center space-x-2 shadow-md"
                      >
                        <span>üö¢</span>
                        <span>{language === 'vi' ? 'Ch·ªçn t√†u' : 'Ship Select'}</span>
                        <span className="text-xs">‚ñæ</span>
                      </button>
                      
                      {/* Ship Dropdown Menu */}
                      {showShipDropdown && (
                        <div className="absolute left-0 top-full mt-2 bg-white rounded-lg shadow-2xl border border-gray-200 py-2 min-w-[250px] z-[60] max-h-[400px] overflow-y-auto">
                          <div className="px-3 py-2 text-xs font-semibold text-gray-500 uppercase border-b border-gray-100">
                            {language === 'vi' ? 'Ch·ªçn t√†u t·ª´ c√¥ng ty c·ªßa b·∫°n' : 'Select ship from your company'}
                          </div>
                          {ships.map(ship => (
                            <button
                              key={ship.id}
                              onClick={() => {
                                setSelectedShip(ship);
                                setNewCrewData({
                                  ...newCrewData,
                                  ship_sign_on: ship.name,
                                  status: 'Sign on'
                                });
                                setShowShipDropdown(false);
                                console.log(`üö¢ Ship changed to: ${ship.name} in Add Crew Modal`);
                              }}
                              className={`w-full text-left px-4 py-3 hover:bg-blue-50 transition-colors flex items-center justify-between ${
                                selectedShip?.id === ship.id ? 'bg-blue-50 border-l-4 border-blue-500' : ''
                              }`}
                            >
                              <div className="flex items-center space-x-3">
                                <span className="text-xl">üö¢</span>
                                <div>
                                  <div className="font-semibold text-gray-800">{ship.name}</div>
                                  <div className="text-xs text-gray-500">
                                    {ship.imo ? `IMO: ${ship.imo}` : ''} {ship.flag ? `‚Ä¢ ${ship.flag}` : ''}
                                  </div>
                                </div>
                              </div>
                              {selectedShip?.id === ship.id && (
                                <span className="text-blue-600 font-bold">‚úì</span>
                              )}
                            </button>
                          ))}
                        </div>
                      )}
                    </div>
                  )}
                  
                  {/* Standby Mode Quick Toggle Button */}
                  <button
                    onClick={() => {
                      if (newCrewData.status === 'Standby') {
                        // Switch back to Sign on mode
                        setNewCrewData({
                          ...newCrewData,
                          status: 'Sign on',
                          ship_sign_on: selectedShip?.name || '-'
                        });
                      } else {
                        // Switch to Standby mode
                        setNewCrewData({
                          ...newCrewData,
                          status: 'Standby',
                          ship_sign_on: '-'
                        });
                      }
                    }}
                    className={`px-4 py-2 rounded-lg font-medium text-sm transition-all flex items-center space-x-2 border-2 ${
                      newCrewData.status === 'Standby'
                        ? 'bg-blue-100 text-blue-800 border-blue-300 hover:bg-blue-200'
                        : 'bg-blue-50 text-blue-700 border-blue-200 hover:bg-blue-100'
                    }`}
                    title={newCrewData.status === 'Standby' 
                      ? (language === 'vi' ? 'Chuy·ªÉn sang ch·∫ø ƒë·ªô th∆∞·ªùng' : 'Switch to normal mode')
                      : (language === 'vi' ? 'Chuy·ªÉn sang Standby Mode' : 'Switch to Standby Mode')
                    }
                  >
                    <span>{newCrewData.status === 'Standby' ? 'üü†' : '‚ö™'}</span>
                    <span>{language === 'vi' ? 'Standby Crew' : 'Standby Crew'}</span>
                  </button>
                  
                  {/* Minimize Button */}
                  <button
                    onClick={() => setIsAddCrewModalMinimized(!isAddCrewModalMinimized)}
                    className="text-gray-400 hover:text-gray-600 text-2xl font-bold leading-none"
                    title={isAddCrewModalMinimized 
                      ? (language === 'vi' ? 'M·ªü r·ªông' : 'Maximize') 
                      : (language === 'vi' ? 'Thu nh·ªè' : 'Minimize')
                    }
                  >
                    {isAddCrewModalMinimized ? '‚ñ°' : '‚àí'}
                  </button>
                  
                  {/* Close Button */}
                  <button
                    onClick={() => {
                      setShowAddCrewModal(false);
                      addCrewDrag.resetPosition();
                      // Reset all states
                      setPassportFile(null);
                      setPassportAnalysis(null);
                      setPassportError('');
                      setNewCrewData({
                        full_name: '',
                        full_name_en: '',
                        sex: 'M',
                        date_of_birth: '',
                        place_of_birth: '',
                        place_of_birth_en: '',
                        passport: '',
                        nationality: '',
                        passport_expiry_date: '',
                        rank: '',
                        seamen_book: '',
                        status: 'Sign on',
                        ship_sign_on: selectedShip?.name || '-',
                        place_sign_on: '',
                        date_sign_on: '',
                        date_sign_off: ''
                      });
                    }}
                    className="text-gray-400 hover:text-gray-600 text-2xl font-bold leading-none"
                  >
                    √ó
                  </button>
                </div>
              </div>
            </div>
            
            {/* Modal Body */}
            <div className="p-6 overflow-y-auto max-h-[calc(90vh-180px)] space-y-6">
              
              {/* Section 1: From Passport (AI Analysis) - TOP */}
              <div className="bg-blue-50 rounded-lg border border-blue-200 p-4">
                {/* Header with title on left and description on right */}
                <div className="flex items-center justify-between mb-3">
                  <h4 className="text-lg font-semibold text-blue-800 flex items-center">
                    <span className="mr-2">üìÑ</span>
                    {language === 'vi' ? 'Ph√¢n t√≠ch t·ª´ h·ªô chi·∫øu (AI)' : 'From Passport (AI Analysis)'}
                  </h4>
                  <p className="text-sm text-blue-700 ml-4">
                    {language === 'vi' 
                      ? 'T·∫£i l√™n file h·ªô chi·∫øu ƒë·ªÉ t·ª± ƒë·ªông ph√¢n t√≠ch v√† ƒëi·ªÅn th√¥ng tin thuy·ªÅn vi√™n'
                      : 'Upload passport file to automatically analyze and fill crew information'
                    }
                  </p>
                </div>
                
                {!passportFile ? (
                  <div className="space-y-3">
                    
                    {/* Drag & Drop Area */}
                    <div 
                      className="border-2 border-dashed border-blue-300 rounded-lg p-6 hover:border-blue-400 cursor-pointer transition-colors"
                      onClick={() => document.getElementById('passport-upload').click()}
                      onDragOver={(e) => {
                        e.preventDefault();
                        e.currentTarget.classList.add('border-blue-400', 'bg-blue-100');
                      }}
                      onDragLeave={(e) => {
                        e.currentTarget.classList.remove('border-blue-400', 'bg-blue-100');
                      }}
                      onDrop={(e) => {
                        e.preventDefault();
                        e.currentTarget.classList.remove('border-blue-400', 'bg-blue-100');
                        const files = Array.from(e.dataTransfer.files);
                        if (files.length > 0) {
                          handleMultiplePassportUpload(files);
                        }
                      }}
                    >
                      {/* Flex container with text on left and icon on right */}
                      <div className="flex items-center justify-between">
                        {/* Text content on left */}
                        <div className="flex-1">
                          <p className="text-blue-700 font-medium text-left">
                            {language === 'vi' ? 'K√©o th·∫£ file(s) ho·∫∑c click ƒë·ªÉ ch·ªçn' : 'Drag & drop file(s) or click to select'}
                          </p>
                          <p className="text-blue-600 text-sm text-left mt-1">
                            {language === 'vi' ? 'H·ªó tr·ª£: PDF, JPG, PNG (t·ªëi ƒëa 10MB m·ªói file)' : 'Supports: PDF, JPG, PNG (max 10MB each)'}
                          </p>
                          <p className="text-blue-500 text-xs text-left mt-1">
                            {language === 'vi' ? '1 file: Review tr∆∞·ªõc khi th√™m | Nhi·ªÅu file: T·ª± ƒë·ªông th√™m' : '1 file: Review before adding | Multiple files: Auto-add'}
                          </p>
                        </div>
                        
                        {/* Icon on right */}
                        <div className="flex-shrink-0 ml-4">
                          <div className="text-blue-500 text-4xl">üìÅ</div>
                        </div>
                      </div>
                    </div>
                    
                    <input
                      id="passport-upload"
                      type="file"
                      accept=".pdf,.jpg,.jpeg,.png"
                      multiple
                      onChange={(e) => {
                        const files = Array.from(e.target.files);
                        if (files.length > 0) {
                          handleMultiplePassportUpload(files);
                        }
                      }}
                      className="hidden"
                      disabled={isAnalyzingPassport || isBatchProcessing}
                    />
                    
                    {isAnalyzingPassport && (
                      <div className="flex items-center justify-center space-x-2 text-blue-600 py-4">
                        <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
                        <span className="font-medium">
                          {language === 'vi' ? 'ƒêang ph√¢n t√≠ch h·ªô chi·∫øu...' : 'Analyzing passport...'}
                        </span>
                      </div>
                    )}
                    
                    {isBatchProcessing && (
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-3">
                        <div className="flex items-center justify-between">
                          <div className="flex items-center space-x-2">
                            <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
                            <span className="font-medium text-blue-800">
                              {language === 'vi' ? 'X·ª≠ l√Ω batch' : 'Batch Processing'}
                            </span>
                          </div>
                          <span className="text-sm text-blue-600 font-medium">
                            {batchProgress.current}/{batchProgress.total}
                          </span>
                        </div>
                        
                        {/* Progress bar */}
                        <div className="w-full bg-blue-200 rounded-full h-2">
                          <div 
                            className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                            style={{ width: `${(batchProgress.current / batchProgress.total) * 100}%` }}
                          ></div>
                        </div>
                        
                        {/* Current file being processed */}
                        {selectedFiles[currentFileIndex] && (
                          <div className="text-sm text-blue-700">
                            {language === 'vi' ? 'ƒêang x·ª≠ l√Ω:' : 'Processing:'} {selectedFiles[currentFileIndex].name}
                          </div>
                        )}
                        
                        {/* Results summary */}
                        {batchResults.length > 0 && (
                          <div className="text-xs space-y-1">
                            <div className="text-green-600">
                              ‚úÖ {language === 'vi' ? 'Th√†nh c√¥ng:' : 'Success:'} {batchResults.filter(r => r.success).length}
                            </div>
                            {batchResults.filter(r => !r.success).length > 0 && (
                              <div className="text-red-600">
                                ‚ùå {language === 'vi' ? 'L·ªói:' : 'Failed:'} {batchResults.filter(r => !r.success).length}
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    )}
                    
                    {passportError && (
                      <div className="text-red-600 text-sm bg-red-50 p-3 rounded border border-red-200">
                        <div className="flex items-center space-x-2">
                          <span>‚ö†Ô∏è</span>
                          <span>{passportError}</span>
                        </div>
                      </div>
                    )}
                  </div>
                ) : (
                  <div className="space-y-3">
                    <div className="flex items-center space-x-2 text-green-700">
                      <span>‚úÖ</span>
                      <span className="font-medium">
                        {language === 'vi' ? 'H·ªô chi·∫øu ƒë√£ ƒë∆∞·ª£c ph√¢n t√≠ch th√†nh c√¥ng' : 'Passport analyzed successfully'}
                      </span>
                    </div>
                    <div className="bg-white p-4 rounded-lg border border-green-200">
                      <div className="grid grid-cols-2 gap-2 text-sm">
                        <p><strong>{language === 'vi' ? 'File:' : 'File:'}</strong> {passportFile.name}</p>
                        <p><strong>{language === 'vi' ? 'K√≠ch th∆∞·ªõc:' : 'Size:'}</strong> {(passportFile.size / 1024 / 1024).toFixed(2)} MB</p>
                        {passportAnalysis && (
                          <>
                            <p><strong>{language === 'vi' ? 'T√™n:' : 'Name:'}</strong> {passportAnalysis.full_name || 'N/A'}</p>
                            <p><strong>{language === 'vi' ? 'H·ªô chi·∫øu:' : 'Passport:'}</strong> {passportAnalysis.passport_number || 'N/A'}</p>
                          </>
                        )}
                      </div>
                    </div>
                    <button
                      type="button"
                      onClick={() => {
                        setPassportFile(null);
                        setPassportAnalysis(null);
                        setPassportError('');
                        // Reset form data
                        setNewCrewData({
                          full_name: '',
                          full_name_en: '',
                          sex: 'M',
                          date_of_birth: '',
                          place_of_birth: '',
                          place_of_birth_en: '',
                          passport: '',
                          nationality: '',
                          passport_expiry_date: '',
                          rank: '',
                          seamen_book: '',
                          status: 'Sign on',
                          ship_sign_on: selectedShip?.name || '-',
                          place_sign_on: '',
                          date_sign_on: '',
                          date_sign_off: ''
                        });
                      }}
                      className="text-sm text-red-600 hover:text-red-800 flex items-center space-x-1"
                    >
                      <span>üóëÔ∏è</span>
                      <span>{language === 'vi' ? 'X√≥a v√† t·∫£i l·∫°i' : 'Remove and re-upload'}</span>
                    </button>
                  </div>
                )}
              </div>

              {/* Section 2: Manual Entry - BOTTOM */}
              <div className="bg-gray-50 rounded-lg border border-gray-200 p-4">
                <h4 className="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                  <span className="mr-2">‚úèÔ∏è</span>
                  {language === 'vi' ? 'Th√¥ng tin thuy·ªÅn vi√™n (Nh·∫≠p th·ªß c√¥ng)' : 'Crew Information (Manual Entry)'}
                </h4>
                
                <p className="text-sm text-gray-600 mb-4">
                  {language === 'vi' 
                    ? 'ƒêi·ªÅn th√¥ng tin thuy·ªÅn vi√™n ho·∫∑c ch·ªânh s·ª≠a th√¥ng tin ƒë√£ ƒë∆∞·ª£c ph√¢n t√≠ch t·ª´ h·ªô chi·∫øu ·ªü tr√™n'
                    : 'Fill in crew information or edit the information analyzed from passport above'
                  }
                </p>

                <form onSubmit={(e) => {
                e.preventDefault();
                
                // Validate required fields
                if (!newCrewData.full_name || !newCrewData.date_of_birth || !newCrewData.place_of_birth || !newCrewData.passport) {
                  toast.error(language === 'vi' ? 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc!' : 'Please fill in all required fields!');
                  return;
                }
                
                // Submit crew data to backend
                handleAddCrewSubmit();
                
                // Reset form to default values
                setNewCrewData({
                  full_name: '',
                  full_name_en: '',
                  sex: 'M',
                  date_of_birth: '',
                  place_of_birth: '',
                  place_of_birth_en: '',
                  passport: '',
                  rank: '',
                  seamen_book: '',
                  status: 'Sign on',
                  ship_sign_on: selectedShip?.name || '-',
                  date_sign_on: '',
                  date_sign_off: ''
                });
                
                // Reset passport upload states
                setPassportFile(null);
                setPassportAnalysis(null);
                setPassportError('');
              }}>
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                  
                  {/* ===== GROUP 1: PERSONAL INFORMATION ===== */}
                  
                  {/* Row 1: Full Name VN (span-2) + Full Name EN (span-2) */}
                  {/* Full Name Vietnamese - Required */}
                  <div className="md:col-span-2">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      <span className="text-red-500">*</span> {language === 'vi' ? 'H·ªç t√™n (Ti·∫øng Vi·ªát)' : 'Full Name (Vietnamese)'}
                    </label>
                    <input
                      type="text"
                      required
                      value={newCrewData.full_name}
                      onChange={(e) => {
                        const vietnameseName = e.target.value;
                        const englishName = autoFillEnglishField(vietnameseName);
                        setNewCrewData({
                          ...newCrewData, 
                          full_name: vietnameseName,
                          // Auto-fill English name only if it's currently empty or was auto-generated
                          full_name_en: newCrewData.full_name_en === autoFillEnglishField(newCrewData.full_name) || newCrewData.full_name_en === '' 
                            ? englishName 
                            : newCrewData.full_name_en
                        });
                      }}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder={language === 'vi' ? 'Nh·∫≠p h·ªç t√™n b·∫±ng ti·∫øng Vi·ªát' : 'Enter Vietnamese name'}
                    />
                  </div>

                  {/* Full Name English - Optional */}
                  <div className="md:col-span-2">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'H·ªç t√™n (Ti·∫øng Anh)' : 'Full Name (English)'}
                      <span className="text-xs text-blue-500 ml-1">
                        {language === 'vi' ? '(T·ª± ƒë·ªông ƒëi·ªÅn)' : '(Auto-filled)'}
                      </span>
                    </label>
                    <input
                      type="text"
                      value={newCrewData.full_name_en}
                      onChange={(e) => setNewCrewData({...newCrewData, full_name_en: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder={language === 'vi' ? 'Nh·∫≠p h·ªç t√™n b·∫±ng ti·∫øng Anh' : 'Enter English name'}
                    />
                  </div>

                  {/* Row 2: Sex (span-1) + Date of Birth (span-1) + Place of Birth VN (span-1) + Place of Birth EN (span-1) */}
                  {/* Sex - Required */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      <span className="text-red-500">*</span> {language === 'vi' ? 'Gi·ªõi t√≠nh' : 'Sex'}
                    </label>
                    <select
                      required
                      value={newCrewData.sex}
                      onChange={(e) => setNewCrewData({...newCrewData, sex: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="M">{language === 'vi' ? 'Nam' : 'Male'}</option>
                      <option value="F">{language === 'vi' ? 'N·ªØ' : 'Female'}</option>
                    </select>
                  </div>

                  {/* Date of Birth - Required */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      <span className="text-red-500">*</span> {language === 'vi' ? 'Ng√†y sinh' : 'Date of Birth'}
                    </label>
                    <input
                      type="date"
                      required
                      value={newCrewData.date_of_birth}
                      onChange={(e) => setNewCrewData({...newCrewData, date_of_birth: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>

                  {/* Place of Birth Vietnamese - Required */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      <span className="text-red-500">*</span> {language === 'vi' ? 'N∆°i sinh (Ti·∫øng Vi·ªát)' : 'Place of Birth (Vietnamese)'}
                    </label>
                    <input
                      type="text"
                      required
                      value={newCrewData.place_of_birth}
                      onChange={(e) => {
                        const vietnamesePlaceName = e.target.value;
                        const englishPlaceName = autoFillEnglishField(vietnamesePlaceName);
                        setNewCrewData({
                          ...newCrewData, 
                          place_of_birth: vietnamesePlaceName,
                          // Auto-fill English place name only if it's currently empty or was auto-generated
                          place_of_birth_en: newCrewData.place_of_birth_en === autoFillEnglishField(newCrewData.place_of_birth) || newCrewData.place_of_birth_en === '' 
                            ? englishPlaceName 
                            : newCrewData.place_of_birth_en
                        });
                      }}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder={language === 'vi' ? 'Nh·∫≠p n∆°i sinh b·∫±ng ti·∫øng Vi·ªát' : 'Enter Vietnamese birthplace'}
                    />
                  </div>

                  {/* Place of Birth English - Optional */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'N∆°i sinh (Ti·∫øng Anh)' : 'Place of Birth (English)'}
                      <span className="text-xs text-blue-500 ml-1">
                        {language === 'vi' ? '(T·ª± ƒë·ªông ƒëi·ªÅn)' : '(Auto-filled)'}
                      </span>
                    </label>
                    <input
                      type="text"
                      value={newCrewData.place_of_birth_en}
                      onChange={(e) => setNewCrewData({...newCrewData, place_of_birth_en: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder={language === 'vi' ? 'Nh·∫≠p n∆°i sinh b·∫±ng ti·∫øng Anh' : 'Enter English birthplace'}
                    />
                  </div>

                  {/* ===== GROUP 2: PASSPORT INFORMATION ===== */}
                  
                  {/* Row 3: Passport No. (span-1) + Nationality (span-1) + Passport Expiry (span-1) + Rank (span-1) */}
                  {/* Passport No. - Required */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      <span className="text-red-500">*</span> {language === 'vi' ? 'S·ªë h·ªô chi·∫øu' : 'Passport No.'}
                    </label>
                    <input
                      type="text"
                      required
                      value={newCrewData.passport}
                      onChange={(e) => setNewCrewData({...newCrewData, passport: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder={language === 'vi' ? 'Nh·∫≠p s·ªë h·ªô chi·∫øu' : 'Enter passport number'}
                    />
                  </div>

                  {/* Nationality - Optional */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'Qu·ªëc t·ªãch' : 'Nationality'}
                    </label>
                    <input
                      type="text"
                      value={newCrewData.nationality}
                      onChange={(e) => setNewCrewData({...newCrewData, nationality: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder={language === 'vi' ? 'Nh·∫≠p qu·ªëc t·ªãch' : 'Enter nationality'}
                    />
                  </div>

                  {/* Passport Expiry Date - Optional */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'H·∫°n h·ªô chi·∫øu' : 'Passport Expiry'}
                    </label>
                    <input
                      type="date"
                      value={newCrewData.passport_expiry_date}
                      onChange={(e) => setNewCrewData({...newCrewData, passport_expiry_date: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>

                  {/* Rank - Optional */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'Ch·ª©c v·ª•' : 'Rank'}
                    </label>
                    <select
                      value={newCrewData.rank}
                      onChange={(e) => setNewCrewData({...newCrewData, rank: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="">{language === 'vi' ? 'Ch·ªçn ch·ª©c v·ª• (t√πy ch·ªçn)' : 'Select rank (optional)'}</option>
                      <option value="CAPT">{language === 'vi' ? 'Thuy·ªÅn tr∆∞·ªüng' : 'CAPT'}</option>
                      <option value="C/O">{language === 'vi' ? 'ƒê·∫°i ph√≥' : 'C/O'}</option>
                      <option value="2/O">{language === 'vi' ? 'Ph√≥ hai' : '2/O'}</option>
                      <option value="3/O">{language === 'vi' ? 'Ph√≥ ba' : '3/O'}</option>
                      <option value="CE">{language === 'vi' ? 'M√°y tr∆∞·ªüng' : 'CE'}</option>
                      <option value="2/E">{language === 'vi' ? 'M√°y hai' : '2/E'}</option>
                      <option value="3/E">{language === 'vi' ? 'M√°y ba' : '3/E'}</option>
                      <option value="4/E">{language === 'vi' ? 'M√°y t∆∞' : '4/E'}</option>
                      <option value="BOSUN">{language === 'vi' ? 'Th·ªßy th·ªß tr∆∞·ªüng' : 'BOSUN'}</option>
                      <option value="ABD">{language === 'vi' ? 'Thuy·ªÅn vi√™n' : 'ABD'}</option>
                      <option value="ELEC">{language === 'vi' ? 'Th·ª£ ƒëi·ªán' : 'ELEC'}</option>
                      <option value="FITTER">{language === 'vi' ? 'Th·ª£ m√°y' : 'FITTER'}</option>
                      <option value="ABE">{language === 'vi' ? 'Th·ª£ m√°y ph·ªï th√¥ng' : 'ABE'}</option>
                      <option value="OSE">{language === 'vi' ? 'Th·ª£ m√°y t·∫≠p s·ª±' : 'OSE'}</option>
                      <option value="C/COOK">{language === 'vi' ? 'B·∫øp tr∆∞·ªüng' : 'C/COOK'}</option>
                      <option value="MESS">{language === 'vi' ? 'Ph·ª•c v·ª•' : 'MESS'}</option>
                    </select>
                  </div>

                  {/* ===== GROUP 3: EMPLOYMENT INFORMATION ===== */}
                  
                  {/* Row 4: Status (span-1) + Ship Sign On (span-1) + Seaman Book (span-1) + [Empty] (span-1) */}
                  {/* Status - Optional */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'Tr·∫°ng th√°i' : 'Status'}
                      {newCrewData.status === 'Standby' && (
                        <span className="ml-2 text-xs px-2 py-0.5 bg-orange-100 text-orange-700 rounded-full font-medium">
                          {language === 'vi' ? 'üü† Ch·∫ø ƒë·ªô Standby' : 'üü† Standby Mode'}
                        </span>
                      )}
                    </label>
                    <select
                      value={newCrewData.status}
                      onChange={(e) => {
                        const selectedStatus = e.target.value;
                        setNewCrewData({
                          ...newCrewData, 
                          status: selectedStatus,
                          // Auto-update Ship Sign On when Status is Standby
                          ship_sign_on: selectedStatus === 'Standby' ? '-' : newCrewData.ship_sign_on
                        });
                      }}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="Sign on">{language === 'vi' ? 'ƒêang tr√™n t√†u' : 'Sign on'}</option>
                      <option value="Standby">{language === 'vi' ? 'Ch·ªù (Standby)' : 'Standby'}</option>
                      <option value="Leave">{language === 'vi' ? 'Ngh·ªâ ph√©p' : 'Leave'}</option>
                    </select>
                  </div>

                  {/* Ship Sign On - Optional */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'T√†u ƒëƒÉng k√Ω' : 'Ship Sign On'}
                      {newCrewData.status === 'Standby' && (
                        <span className="ml-2 text-xs text-orange-600">
                          ({language === 'vi' ? 'T·ª± ƒë·ªông: -' : 'Auto: -'})
                        </span>
                      )}
                    </label>
                    <select
                      value={newCrewData.ship_sign_on}
                      onChange={(e) => {
                        const selectedShip = e.target.value;
                        setNewCrewData({
                          ...newCrewData, 
                          ship_sign_on: selectedShip,
                          // Auto-update Status based on Ship Sign On selection
                          status: selectedShip === '-' ? 'Standby' : 'Sign on'
                        });
                      }}
                      disabled={newCrewData.status === 'Standby'}
                      className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                        newCrewData.status === 'Standby' 
                          ? 'bg-gray-100 text-gray-500 cursor-not-allowed border-gray-300' 
                          : 'border-gray-300'
                      }`}
                    >
                      <option value="-">{language === 'vi' ? '- (Ch∆∞a ch·ªçn t√†u)' : '- (Not assigned)'}</option>
                      {ships.map(ship => (
                        <option key={ship.id} value={ship.name}>
                          {ship.name}
                        </option>
                      ))}
                    </select>
                  </div>

                  {/* Place Sign On - Optional - Hidden for Standby */}
                  {newCrewData.status !== 'Standby' && (
                    <div className="md:col-span-1">
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        {language === 'vi' ? 'N∆°i xu·ªëng t√†u' : 'Place Sign On'}
                      </label>
                      <input
                        type="text"
                        value={newCrewData.place_sign_on}
                        onChange={(e) => setNewCrewData({...newCrewData, place_sign_on: e.target.value})}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder={language === 'vi' ? 'Nh·∫≠p n∆°i xu·ªëng t√†u' : 'Enter place sign on'}
                      />
                    </div>
                  )}

                  {/* Empty field - placeholder when Standby */}
                  {newCrewData.status === 'Standby' && (
                    <div className="md:col-span-1"></div>
                  )}

                  {/* Row 5: Seaman Book (span-1) + Date Sign On (span-1) + Date Sign Off (span-1) + [Empty] (span-1) */}
                  {/* Seaman Book - Optional */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'S·ªï thuy·ªÅn vi√™n' : 'Seaman Book'}
                    </label>
                    <input
                      type="text"
                      value={newCrewData.seamen_book}
                      onChange={(e) => setNewCrewData({...newCrewData, seamen_book: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder={language === 'vi' ? 'S·ªë s·ªï thuy·ªÅn vi√™n' : 'Seaman book number'}
                    />
                  </div>

                  {/* Date Sign On - Optional - Hidden for Standby */}
                  {newCrewData.status !== 'Standby' && (
                    <div className="md:col-span-1">
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        {language === 'vi' ? 'Ng√†y xu·ªëng t√†u' : 'Date Sign On'}
                      </label>
                      <input
                        type="date"
                        value={newCrewData.date_sign_on}
                        onChange={(e) => setNewCrewData({...newCrewData, date_sign_on: e.target.value})}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                  )}

                  {/* Date Sign Off - Optional - Hidden for Standby (not applicable for new standby crew) */}
                  {newCrewData.status !== 'Standby' && (
                    <div className="md:col-span-1">
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        {language === 'vi' ? 'Ng√†y r·ªùi t√†u' : 'Date Sign Off'}
                      </label>
                      <input
                        type="date"
                        value={newCrewData.date_sign_off}
                        onChange={(e) => {
                          const signOffDate = e.target.value;
                          setNewCrewData({
                            ...newCrewData, 
                            date_sign_off: signOffDate,
                            // Auto-update Status and Ship Sign On when Date Sign Off is filled
                            status: signOffDate ? 'Standby' : newCrewData.status,
                            ship_sign_on: signOffDate ? '-' : newCrewData.ship_sign_on
                          });
                        }}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                  )}

                </div>

                  {/* Submit Buttons */}
                  <div className="flex justify-end space-x-4 mt-4 pt-4 border-t border-gray-200">
                    <button
                      type="button"
                      onClick={() => setShowAddCrewModal(false)}
                      className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all"
                    >
                      {language === 'vi' ? 'H·ªßy' : 'Cancel'}
                    </button>
                    <button
                      type="submit"
                      disabled={isSubmittingCrew}
                      className="px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg transition-all flex items-center"
                    >
                      {isSubmittingCrew && (
                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                      )}
                      {isSubmittingCrew 
                        ? (language === 'vi' ? 'ƒêang th√™m...' : 'Adding...')
                        : (language === 'vi' ? 'Th√™m thuy·ªÅn vi√™n' : 'Add Crew Member')
                      }
                    </button>
                  </div>
                </form>
              </div>
              
            </div>
          </div>
        </div>
      )}

      {/* Add Crew Modal - Minimized Floating Button */}
      {showAddCrewModal && isAddCrewModalMinimized && (
        <div 
          onClick={() => {
            console.log('üìÇ Restoring Add Crew modal...');
            setIsAddCrewModalMinimized(false);
          }}
          className="fixed bottom-6 right-6 z-[9999] cursor-pointer group"
        >
          <div className="bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-2xl shadow-2xl hover:shadow-3xl transition-all hover:scale-105 p-4 min-w-[280px]">
            <div className="flex items-center justify-between">
              <div className="flex items-center space-x-3">
                <div className="bg-white bg-opacity-20 rounded-full p-2">
                  <span className="text-2xl">üë§</span>
                </div>
                <div>
                  <div className="font-bold text-sm">
                    {language === 'vi' ? 'Th√™m thuy·ªÅn vi√™n m·ªõi' : 'Add New Crew'}
                  </div>
                  <div className="text-xs text-green-100">
                    {newCrewData.status === 'Standby' 
                      ? (language === 'vi' ? 'Standby Crew' : 'Standby Crew')
                      : selectedShip 
                        ? selectedShip.name 
                        : (language === 'vi' ? 'ƒêang so·∫°n...' : 'In progress...')}
                  </div>
                </div>
              </div>
              <div className="flex items-center space-x-2">
                <div className="bg-white bg-opacity-20 rounded-full p-1.5 group-hover:bg-opacity-30 transition-all">
                  <span className="text-sm">‚Üë</span>
                </div>
              </div>
            </div>
            <div className="mt-2 text-xs text-green-100">
              {language === 'vi' ? 'Click ƒë·ªÉ m·ªü l·∫°i' : 'Click to restore'}
            </div>
          </div>
        </div>
      )}

      {/* Processing Results Modal */}
      {showProcessingResultsModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div 
            ref={processingResultsDrag.modalRef}
            className="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col"
            style={{
              transform: `translate(${processingResultsDrag.position.x}px, ${processingResultsDrag.position.y}px)`,
              cursor: processingResultsDrag.isDragging ? 'grabbing' : 'default',
              transition: processingResultsDrag.isDragging ? 'none' : 'transform 0.2s ease-out'
            }}
          >
            <div 
              className="p-6 border-b border-gray-200"
              onMouseDown={processingResultsDrag.handleMouseDown}
              style={{ cursor: 'grab' }}
            >
              <div className="flex justify-between items-center">
                <h3 className="text-xl font-bold text-gray-800">
                  {language === 'vi' ? 'K·∫øt qu·∫£ x·ª≠ l√Ω Passport' : 'Passport Processing Results'}
                </h3>
                <button
                  onClick={() => {
                    setShowProcessingResultsModal(false);
                    setProcessingResults([]);
                    processingResultsDrag.resetPosition();
                  }}
                  className="text-gray-400 hover:text-gray-600 text-2xl font-bold leading-none"
                >
                  √ó
                </button>
              </div>
              <div className="mt-2 text-sm text-gray-600">
                {language === 'vi' 
                  ? `T·ªïng s·ªë: ${processingResults.length} file | Th√†nh c√¥ng: ${processingResults.filter(r => r.success).length} | Th·∫•t b·∫°i: ${processingResults.filter(r => !r.success).length}`
                  : `Total: ${processingResults.length} files | Success: ${processingResults.filter(r => r.success).length} | Failed: ${processingResults.filter(r => !r.success).length}`
                }
              </div>
            </div>
            
            <div className="flex-1 overflow-y-auto p-6">
              <div className="overflow-x-auto">
                <table className="w-full border-collapse">
                  <thead>
                    <tr className="bg-gray-100 border-b-2 border-gray-300">
                      <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">
                        {language === 'vi' ? 'STT' : 'No.'}
                      </th>
                      <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">
                        {language === 'vi' ? 'T√™n File' : 'Filename'}
                      </th>
                      <th className="px-4 py-3 text-center text-sm font-semibold text-gray-700">
                        {language === 'vi' ? 'T·∫°o Record' : 'Record Created'}
                      </th>
                      <th className="px-4 py-3 text-center text-sm font-semibold text-gray-700">
                        {language === 'vi' ? 'Upload File' : 'File Uploaded'}
                      </th>
                      <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">
                        {language === 'vi' ? 'V·ªã tr√≠ l∆∞u' : 'Saved Location'}
                      </th>
                      <th className="px-4 py-3 text-center text-sm font-semibold text-gray-700">
                        {language === 'vi' ? 'T·∫°o Summary' : 'Summary Created'}
                      </th>
                      <th className="px-4 py-3 text-center text-sm font-semibold text-gray-700">
                        {language === 'vi' ? 'Duplicate' : 'Duplicate'}
                      </th>
                      <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">
                        {language === 'vi' ? 'Th√¥ng tin' : 'Details'}
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    {processingResults.map((result, idx) => (
                      <tr key={idx} className={`border-b ${result.success ? 'bg-green-50' : 'bg-red-50'} hover:bg-opacity-75`}>
                        <td className="px-4 py-3 text-sm text-gray-700">{idx + 1}</td>
                        <td className="px-4 py-3 text-sm text-gray-700 font-medium">{result.filename}</td>
                        <td className="px-4 py-3 text-center">
                          {result.recordCreated ? (
                            <span className="text-green-600 font-bold">‚úì</span>
                          ) : (
                            <span className="text-red-600 font-bold">‚úó</span>
                          )}
                        </td>
                        <td className="px-4 py-3 text-center">
                          {result.fileUploaded ? (
                            <span className="text-green-600 font-bold">‚úì</span>
                          ) : (
                            <span className="text-red-600 font-bold">‚úó</span>
                          )}
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-600">
                          <div className="max-w-xs truncate" title={result.filePath}>
                            {result.filePath}
                          </div>
                        </td>
                        <td className="px-4 py-3 text-center">
                          {result.summaryCreated ? (
                            <span className="text-green-600 font-bold">‚úì</span>
                          ) : (
                            <span className="text-gray-400 font-bold">-</span>
                          )}
                        </td>
                        <td className="px-4 py-3 text-center">
                          {result.isDuplicate ? (
                            <span className="text-red-600 font-bold">‚ö†</span>
                          ) : (
                            <span className="text-green-600 font-bold">‚úì</span>
                          )}
                        </td>
                        <td className="px-4 py-3 text-sm">
                          {result.success ? (
                            <div className="text-green-700">
                              <div><strong>{language === 'vi' ? 'Thuy·ªÅn vi√™n:' : 'Crew:'}</strong> {result.crewName}</div>
                              <div><strong>{language === 'vi' ? 'T√†u:' : 'Ship:'}</strong> {result.ship}</div>
                            </div>
                          ) : result.isDuplicate ? (
                            <div className="text-red-700">
                              <div className="font-semibold">{language === 'vi' ? 'Tr√πng Passport!' : 'Duplicate Passport!'}</div>
                              <div><strong>{language === 'vi' ? 'Tr√πng v·ªõi:' : 'Duplicate with:'}</strong> {result.duplicateWith}</div>
                              <div><strong>{language === 'vi' ? 'T√†u:' : 'Ship:'}</strong> {result.duplicateShip}</div>
                            </div>
                          ) : result.error === 'NOT_PASSPORT' ? (
                            <div className="text-orange-700 bg-orange-50 p-2 rounded">
                              <div className="font-semibold flex items-center space-x-1">
                                <span>‚ö†Ô∏è</span>
                                <span>{language === 'vi' ? 'Kh√¥ng ph·∫£i Passport' : 'Not a Passport'}</span>
                              </div>
                              <div className="text-xs mt-1">{result.validationReason}</div>
                            </div>
                          ) : (
                            <div className="text-red-700">
                              <div className="font-semibold">{language === 'vi' ? 'L·ªói:' : 'Error:'}</div>
                              <div className="text-xs">{result.error}</div>
                            </div>
                          )}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
            
            <div className="p-6 border-t border-gray-200 bg-gray-50">
              <div className="flex justify-end">
                <button
                  onClick={() => {
                    setShowProcessingResultsModal(false);
                    setProcessingResults([]);
                    processingResultsDrag.resetPosition();
                  }}
                  className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all"
                >
                  {language === 'vi' ? 'ƒê√≥ng' : 'Close'}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Duplicate Certificate Warning Modal */}
      {showDuplicateCertWarning && duplicateCertInfo && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[10000] p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div className="p-6 border-b border-gray-200 bg-orange-50">
              <div className="flex items-center space-x-3">
                <span className="text-4xl">‚ö†Ô∏è</span>
                <div>
                  <h3 className="text-xl font-bold text-orange-800">
                    {language === 'vi' ? 'Ph√°t hi·ªán ch·ª©ng ch·ªâ tr√πng l·∫∑p' : 'Duplicate Certificate Detected'}
                  </h3>
                  <p className="text-sm text-orange-600 mt-1">
                    {language === 'vi' 
                      ? 'Ch·ª©ng ch·ªâ v·ªõi s·ªë n√†y ƒë√£ t·ªìn t·∫°i cho thuy·ªÅn vi√™n n√†y'
                      : 'A certificate with this number already exists for this crew member'}
                  </p>
                </div>
              </div>
            </div>
            
            <div className="flex-1 overflow-y-auto p-6">
              <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                <div className="flex">
                  <div className="flex-shrink-0">
                    <svg className="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                      <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                    </svg>
                  </div>
                  <div className="ml-3">
                    <p className="text-sm text-yellow-700">
                      <strong>{language === 'vi' ? 'Ch·ª©ng ch·ªâ hi·ªán c√≥:' : 'Existing Certificate:'}</strong>
                    </p>
                  </div>
                </div>
              </div>

              <div className="space-y-3">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="text-xs text-gray-500">{language === 'vi' ? 'T√™n ch·ª©ng ch·ªâ' : 'Certificate Name'}</label>
                    <p className="font-medium text-gray-900">{duplicateCertInfo.existing_certificate?.cert_name || '-'}</p>
                  </div>
                  <div>
                    <label className="text-xs text-gray-500">{language === 'vi' ? 'S·ªë ch·ª©ng ch·ªâ' : 'Certificate No.'}</label>
                    <p className="font-medium text-gray-900">{duplicateCertInfo.existing_certificate?.cert_no || '-'}</p>
                  </div>
                  <div>
                    <label className="text-xs text-gray-500">{language === 'vi' ? 'C∆° quan c·∫•p' : 'Issued By'}</label>
                    <p className="font-medium text-gray-900">{duplicateCertInfo.existing_certificate?.issued_by || '-'}</p>
                  </div>
                  <div>
                    <label className="text-xs text-gray-500">{language === 'vi' ? 'Ng√†y c·∫•p' : 'Issued Date'}</label>
                    <p className="font-medium text-gray-900">{formatDateDisplay(duplicateCertInfo.existing_certificate?.issued_date) || '-'}</p>
                  </div>
                  <div>
                    <label className="text-xs text-gray-500">{language === 'vi' ? 'Ng√†y h·∫øt h·∫°n' : 'Expiry Date'}</label>
                    <p className="font-medium text-gray-900">{formatDateDisplay(duplicateCertInfo.existing_certificate?.cert_expiry) || '-'}</p>
                  </div>
                </div>
              </div>

              <div className="mt-6 bg-gray-50 rounded-lg p-4">
                <p className="text-sm text-gray-700">
                  {language === 'vi' 
                    ? '‚ùì B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën th√™m ch·ª©ng ch·ªâ tr√πng l·∫∑p n√†y kh√¥ng?'
                    : '‚ùì Are you sure you want to add this duplicate certificate?'}
                </p>
              </div>
            </div>
            
            <div className="p-6 border-t border-gray-200 bg-gray-50">
              <div className="flex justify-end space-x-3">
                <button
                  onClick={() => {
                    setShowDuplicateCertWarning(false);
                    setDuplicateCertInfo(null);
                    setIsSubmittingCert(false);
                  }}
                  className="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-all"
                >
                  {language === 'vi' ? 'H·ªßy' : 'Cancel'}
                </button>
                <button
                  onClick={handleConfirmAddDuplicateCert}
                  disabled={isSubmittingCert}
                  className="px-6 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2"
                >
                  {isSubmittingCert ? (
                    <>
                      <svg className="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      <span>{language === 'vi' ? 'ƒêang x·ª≠ l√Ω...' : 'Processing...'}</span>
                    </>
                  ) : (
                    <span>{language === 'vi' ? '‚úì V·∫´n th√™m' : '‚úì Add Anyway'}</span>
                  )}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Crew Certificate Processing Results Modal */}
      {showCertProcessingResultsModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div 
            className="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col"
          >
            <div className="p-6 border-b border-gray-200">
              <div className="flex justify-between items-center">
                <h3 className="text-xl font-bold text-gray-800">
                  {language === 'vi' ? 'K·∫øt qu·∫£ x·ª≠ l√Ω Crew Certificate' : 'Crew Certificate Processing Results'}
                </h3>
                <button
                  onClick={() => {
                    setShowCertProcessingResultsModal(false);
                    setCertProcessingResults([]);
                  }}
                  className="text-gray-400 hover:text-gray-600 text-2xl font-bold leading-none"
                >
                  √ó
                </button>
              </div>
              <div className="mt-2 text-sm text-gray-600">
                {language === 'vi' 
                  ? `T·ªïng s·ªë: ${certProcessingResults.length} file | ‚úÖ Th√†nh c√¥ng: ${certProcessingResults.filter(r => r.success).length} | ‚ö†Ô∏è Tr√πng l·∫∑p: ${certProcessingResults.filter(r => r.error === 'DUPLICATE').length} | ‚ùå L·ªói: ${certProcessingResults.filter(r => !r.success && r.error !== 'DUPLICATE').length}`
                  : `Total: ${certProcessingResults.length} files | ‚úÖ Success: ${certProcessingResults.filter(r => r.success).length} | ‚ö†Ô∏è Duplicate: ${certProcessingResults.filter(r => r.error === 'DUPLICATE').length} | ‚ùå Failed: ${certProcessingResults.filter(r => !r.success && r.error !== 'DUPLICATE').length}`
                }
              </div>
            </div>
            
            <div className="flex-1 overflow-y-auto p-6">
              <div className="overflow-x-auto">
                <table className="w-full border-collapse">
                  <thead>
                    <tr className="bg-gray-100 border-b-2 border-gray-300">
                      <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">
                        {language === 'vi' ? 'STT' : 'No.'}
                      </th>
                      <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">
                        {language === 'vi' ? 'T√™n File' : 'Filename'}
                      </th>
                      <th className="px-4 py-3 text-center text-sm font-semibold text-gray-700">
                        {language === 'vi' ? 'T·∫°o Certificate' : 'Cert Created'}
                      </th>
                      <th className="px-4 py-3 text-center text-sm font-semibold text-gray-700">
                        {language === 'vi' ? 'Upload File' : 'File Uploaded'}
                      </th>
                      <th className="px-4 py-3 text-center text-sm font-semibold text-gray-700">
                        {language === 'vi' ? 'T·∫°o Summary' : 'Summary Created'}
                      </th>
                      <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">
                        {language === 'vi' ? 'Th√¥ng tin' : 'Details'}
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    {certProcessingResults.map((result, idx) => (
                      <tr key={idx} className={`border-b ${
                        result.success ? 'bg-green-50' : 
                        result.error === 'DUPLICATE' ? 'bg-orange-50' : 
                        'bg-red-50'
                      } hover:bg-opacity-75`}>
                        <td className="px-4 py-3 text-sm text-gray-700">{idx + 1}</td>
                        <td className="px-4 py-3 text-sm text-gray-700 font-medium">{result.filename}</td>
                        <td className="px-4 py-3 text-center">
                          {result.certCreated ? (
                            <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                              ‚úì {language === 'vi' ? 'ƒê√£ t·∫°o' : 'Created'}
                            </span>
                          ) : (
                            <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                              ‚úó {language === 'vi' ? 'Th·∫•t b·∫°i' : 'Failed'}
                            </span>
                          )}
                        </td>
                        <td className="px-4 py-3 text-center">
                          {result.fileUploaded ? (
                            <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                              ‚úì {language === 'vi' ? 'ƒê√£ upload' : 'Uploaded'}
                            </span>
                          ) : (
                            <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                              ‚úó {language === 'vi' ? 'Ch∆∞a upload' : 'Not uploaded'}
                            </span>
                          )}
                        </td>
                        <td className="px-4 py-3 text-center">
                          {result.summaryCreated ? (
                            <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                              ‚úì {language === 'vi' ? 'ƒê√£ t·∫°o' : 'Created'}
                            </span>
                          ) : (
                            <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                              ‚úó {language === 'vi' ? 'Ch∆∞a t·∫°o' : 'Not created'}
                            </span>
                          )}
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-700">
                          {result.success ? (
                            <div className="space-y-1">
                              <div className="font-medium text-green-700">
                                ‚úÖ {language === 'vi' ? 'Th√†nh c√¥ng' : 'Success'}
                              </div>
                              {result.certName && (
                                <div className="text-xs">
                                  <span className="font-semibold">{language === 'vi' ? 'Ch·ª©ng ch·ªâ:' : 'Certificate:'}</span> {result.certName}
                                </div>
                              )}
                              {result.certNo && (
                                <div className="text-xs">
                                  <span className="font-semibold">{language === 'vi' ? 'S·ªë:' : 'No:'}</span> {result.certNo}
                                </div>
                              )}
                              {result.crewName && (
                                <div className="text-xs">
                                  <span className="font-semibold">{language === 'vi' ? 'Thuy·ªÅn vi√™n:' : 'Crew:'}</span> {result.crewName}
                                </div>
                              )}
                            </div>
                          ) : (
                            <div className={`text-xs ${result.error === 'DUPLICATE' ? 'text-orange-600' : 'text-red-600'}`}>
                              <div className="font-medium">
                                {result.error === 'DUPLICATE' ? '‚ö†Ô∏è' : '‚ùå'} 
                                {' '}
                                {result.error === 'DUPLICATE' 
                                  ? (language === 'vi' ? 'Tr√πng l·∫∑p (ƒë√£ b·ªè qua)' : 'Duplicate (skipped)')
                                  : (language === 'vi' ? 'Th·∫•t b·∫°i' : 'Failed')
                                }
                              </div>
                              {result.error === 'DUPLICATE' && result.duplicateInfo && (
                                <div className="mt-2 space-y-1 bg-orange-50 p-2 rounded">
                                  <div className="text-xs text-orange-800">
                                    <strong>{language === 'vi' ? 'Ch·ª©ng ch·ªâ hi·ªán c√≥:' : 'Existing:'}</strong>
                                  </div>
                                  <div className="text-xs">
                                    {result.duplicateInfo.cert_name} - {result.duplicateInfo.cert_no}
                                  </div>
                                  <div className="text-xs text-gray-600">
                                    {language === 'vi' ? 'H·∫øt h·∫°n:' : 'Expiry:'} {formatDateDisplay(result.duplicateInfo.cert_expiry)}
                                  </div>
                                </div>
                              )}
                              {result.error !== 'DUPLICATE' && result.error && (
                                <div className="mt-1 text-xs">
                                  {language === 'vi' ? 'L·ªói:' : 'Error:'} {result.error}
                                </div>
                              )}
                            </div>
                          )}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
            
            <div className="p-6 border-t border-gray-200 bg-gray-50">
              <div className="flex justify-end">
                <button
                  onClick={() => {
                    setShowCertProcessingResultsModal(false);
                    setCertProcessingResults([]);
                  }}
                  className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all"
                >
                  {language === 'vi' ? 'ƒê√≥ng' : 'Close'}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Edit Crew Modal */}
      {showEditCrewModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div 
            ref={editCrewDrag.modalRef}
            className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden"
            style={{
              transform: `translate(${editCrewDrag.position.x}px, ${editCrewDrag.position.y}px)`,
              cursor: editCrewDrag.isDragging ? 'grabbing' : 'default',
              transition: editCrewDrag.isDragging ? 'none' : 'transform 0.2s ease-out'
            }}
          >
            <div 
              className="p-6 border-b border-gray-200"
              onMouseDown={editCrewDrag.handleMouseDown}
              style={{ cursor: 'grab' }}
            >
              <div className="flex items-center justify-between">
                <h3 className="text-xl font-bold text-gray-800">
                  {language === 'vi' ? 'Ch·ªânh s·ª≠a th√¥ng tin thuy·ªÅn vi√™n' : 'Edit Crew Member'}
                </h3>
                <button
                  onClick={() => {
                    closeEditCrewModal();
                    editCrewDrag.resetPosition();
                  }}
                  className="text-gray-400 hover:text-gray-600 text-2xl font-bold"
                >
                  √ó
                </button>
              </div>
            </div>
            
            <div className="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
              <form onSubmit={handleUpdateCrew}>
                <h4 className="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                  <span className="mr-2">‚úèÔ∏è</span>
                  {language === 'vi' ? 'Th√¥ng tin thuy·ªÅn vi√™n' : 'Crew Information'}
                </h4>
                
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                  
                  {/* ===== GROUP 1: PERSONAL INFORMATION ===== */}
                  
                  {/* Row 1: Full Name VN (span-2) + Full Name EN (span-2) */}
                  {/* Full Name Vietnamese - Required */}
                  <div className="md:col-span-2">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      <span className="text-red-500">*</span> {language === 'vi' ? 'H·ªç t√™n (Ti·∫øng Vi·ªát)' : 'Full Name (Vietnamese)'}
                    </label>
                    <input
                      type="text"
                      required
                      value={editCrewData.full_name}
                      onChange={(e) => {
                        const vietnameseName = e.target.value;
                        const englishName = autoFillEnglishField(vietnameseName);
                        setEditCrewData({
                          ...editCrewData, 
                          full_name: vietnameseName,
                          // Auto-fill English name only if it's currently empty or was auto-generated
                          full_name_en: editCrewData.full_name_en === autoFillEnglishField(editCrewData.full_name) || editCrewData.full_name_en === '' 
                            ? englishName 
                            : editCrewData.full_name_en
                        });
                      }}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder={language === 'vi' ? 'Nh·∫≠p h·ªç t√™n b·∫±ng ti·∫øng Vi·ªát' : 'Enter Vietnamese name'}
                    />
                  </div>

                  {/* Full Name English - Optional */}
                  <div className="md:col-span-2">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'H·ªç t√™n (Ti·∫øng Anh)' : 'Full Name (English)'}
                      <span className="text-xs text-blue-500 ml-1">
                        {language === 'vi' ? '(T·ª± ƒë·ªông ƒëi·ªÅn)' : '(Auto-filled)'}
                      </span>
                    </label>
                    <input
                      type="text"
                      value={editCrewData.full_name_en}
                      onChange={(e) => setEditCrewData({...editCrewData, full_name_en: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder={language === 'vi' ? 'Nh·∫≠p h·ªç t√™n b·∫±ng ti·∫øng Anh' : 'Enter English name'}
                    />
                  </div>

                  {/* Row 2: Sex (span-1) + Date of Birth (span-1) + Place of Birth VN (span-1) + Place of Birth EN (span-1) */}
                  {/* Sex - Required */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      <span className="text-red-500">*</span> {language === 'vi' ? 'Gi·ªõi t√≠nh' : 'Sex'}
                    </label>
                    <select
                      required
                      value={editCrewData.sex}
                      onChange={(e) => setEditCrewData({...editCrewData, sex: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="M">{language === 'vi' ? 'Nam' : 'Male'}</option>
                      <option value="F">{language === 'vi' ? 'N·ªØ' : 'Female'}</option>
                    </select>
                  </div>

                  {/* Date of Birth - Required */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      <span className="text-red-500">*</span> {language === 'vi' ? 'Ng√†y sinh' : 'Date of Birth'}
                    </label>
                    <input
                      type="date"
                      required
                      value={editCrewData.date_of_birth}
                      onChange={(e) => setEditCrewData({...editCrewData, date_of_birth: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>

                  {/* Place of Birth Vietnamese - Required */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      <span className="text-red-500">*</span> {language === 'vi' ? 'N∆°i sinh (Ti·∫øng Vi·ªát)' : 'Place of Birth (Vietnamese)'}
                    </label>
                    <input
                      type="text"
                      required
                      value={editCrewData.place_of_birth}
                      onChange={(e) => {
                        const vietnamesePlaceName = e.target.value;
                        const englishPlaceName = autoFillEnglishField(vietnamesePlaceName);
                        setEditCrewData({
                          ...editCrewData, 
                          place_of_birth: vietnamesePlaceName,
                          // Auto-fill English place name only if it's currently empty or was auto-generated
                          place_of_birth_en: editCrewData.place_of_birth_en === autoFillEnglishField(editCrewData.place_of_birth) || editCrewData.place_of_birth_en === '' 
                            ? englishPlaceName 
                            : editCrewData.place_of_birth_en
                        });
                      }}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder={language === 'vi' ? 'Nh·∫≠p n∆°i sinh b·∫±ng ti·∫øng Vi·ªát' : 'Enter Vietnamese birthplace'}
                    />
                  </div>

                  {/* Place of Birth English - Optional */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'N∆°i sinh (Ti·∫øng Anh)' : 'Place of Birth (English)'}
                      <span className="text-xs text-blue-500 ml-1">
                        {language === 'vi' ? '(T·ª± ƒë·ªông ƒëi·ªÅn)' : '(Auto-filled)'}
                      </span>
                    </label>
                    <input
                      type="text"
                      value={editCrewData.place_of_birth_en}
                      onChange={(e) => setEditCrewData({...editCrewData, place_of_birth_en: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder={language === 'vi' ? 'Nh·∫≠p n∆°i sinh b·∫±ng ti·∫øng Anh' : 'Enter English birthplace'}
                    />
                  </div>

                  {/* ===== GROUP 2: PASSPORT INFORMATION ===== */}
                  
                  {/* Row 3: Passport No. (span-1) + Nationality (span-1) + Passport Expiry (span-1) + Rank (span-1) */}
                  {/* Passport No. - Required */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      <span className="text-red-500">*</span> {language === 'vi' ? 'S·ªë h·ªô chi·∫øu' : 'Passport No.'}
                    </label>
                    <input
                      type="text"
                      required
                      value={editCrewData.passport}
                      onChange={(e) => setEditCrewData({...editCrewData, passport: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder={language === 'vi' ? 'Nh·∫≠p s·ªë h·ªô chi·∫øu' : 'Enter passport number'}
                    />
                  </div>

                  {/* Nationality - Optional */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'Qu·ªëc t·ªãch' : 'Nationality'}
                    </label>
                    <input
                      type="text"
                      value={editCrewData.nationality}
                      onChange={(e) => setEditCrewData({...editCrewData, nationality: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder={language === 'vi' ? 'Nh·∫≠p qu·ªëc t·ªãch' : 'Enter nationality'}
                    />
                  </div>

                  {/* Passport Expiry Date - Optional */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'H·∫°n h·ªô chi·∫øu' : 'Passport Expiry'}
                    </label>
                    <input
                      type="date"
                      value={editCrewData.passport_expiry_date}
                      onChange={(e) => setEditCrewData({...editCrewData, passport_expiry_date: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>

                  {/* Rank - Optional */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'Ch·ª©c v·ª•' : 'Rank'}
                    </label>
                    <select
                      value={editCrewData.rank}
                      onChange={(e) => setEditCrewData({...editCrewData, rank: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="">{language === 'vi' ? 'Ch·ªçn ch·ª©c v·ª• (t√πy ch·ªçn)' : 'Select rank (optional)'}</option>
                      <option value="CAPT">{language === 'vi' ? 'Thuy·ªÅn tr∆∞·ªüng' : 'CAPT'}</option>
                      <option value="C/O">{language === 'vi' ? 'ƒê·∫°i ph√≥' : 'C/O'}</option>
                      <option value="2/O">{language === 'vi' ? 'Ph√≥ hai' : '2/O'}</option>
                      <option value="3/O">{language === 'vi' ? 'Ph√≥ ba' : '3/O'}</option>
                      <option value="CE">{language === 'vi' ? 'M√°y tr∆∞·ªüng' : 'CE'}</option>
                      <option value="2/E">{language === 'vi' ? 'M√°y hai' : '2/E'}</option>
                      <option value="3/E">{language === 'vi' ? 'M√°y ba' : '3/E'}</option>
                      <option value="4/E">{language === 'vi' ? 'M√°y t∆∞' : '4/E'}</option>
                      <option value="BOSUN">{language === 'vi' ? 'Th·ªßy th·ªß tr∆∞·ªüng' : 'BOSUN'}</option>
                      <option value="ABD">{language === 'vi' ? 'Thuy·ªÅn vi√™n' : 'ABD'}</option>
                      <option value="ELEC">{language === 'vi' ? 'Th·ª£ ƒëi·ªán' : 'ELEC'}</option>
                      <option value="FITTER">{language === 'vi' ? 'Th·ª£ m√°y' : 'FITTER'}</option>
                      <option value="ABE">{language === 'vi' ? 'Th·ª£ m√°y ph·ªï th√¥ng' : 'ABE'}</option>
                      <option value="OSE">{language === 'vi' ? 'Th·ª£ m√°y t·∫≠p s·ª±' : 'OSE'}</option>
                      <option value="C/COOK">{language === 'vi' ? 'B·∫øp tr∆∞·ªüng' : 'C/COOK'}</option>
                      <option value="MESS">{language === 'vi' ? 'Ph·ª•c v·ª•' : 'MESS'}</option>
                    </select>
                  </div>

                  {/* ===== GROUP 3: EMPLOYMENT INFORMATION ===== */}
                  
                  {/* Row 4: Status (span-1) + Ship Sign On (span-1) + Place Sign On (span-1) + [Empty] (span-1) */}

                  {/* Status - Optional */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'Tr·∫°ng th√°i' : 'Status'}
                    </label>
                    <select
                      value={editCrewData.status}
                      onChange={(e) => setEditCrewData({...editCrewData, status: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="Sign on">{language === 'vi' ? 'ƒêang tr√™n t√†u' : 'Sign on'}</option>
                      <option value="Standby">{language === 'vi' ? 'Ch·ªù' : 'Standby'}</option>
                      <option value="Leave">{language === 'vi' ? 'Ngh·ªâ ph√©p' : 'Leave'}</option>
                    </select>
                  </div>

                  {/* Ship Sign On - Optional */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'T√†u ƒëƒÉng k√Ω' : 'Ship Sign On'}
                    </label>
                    <select
                      value={editCrewData.ship_sign_on}
                      onChange={(e) => {
                        const selectedShip = e.target.value;
                        setEditCrewData({
                          ...editCrewData, 
                          ship_sign_on: selectedShip,
                          // Auto-update Status based on Ship Sign On selection
                          status: selectedShip === '-' ? 'Standby' : 'Sign on'
                        });
                      }}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="-">{language === 'vi' ? '- (Ch∆∞a ch·ªçn t√†u)' : '- (Not assigned)'}</option>
                      {ships.map(ship => (
                        <option key={ship.id} value={ship.name}>
                          {ship.name}
                        </option>
                      ))}
                    </select>
                  </div>

                  {/* Place Sign On - Optional */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'N∆°i xu·ªëng t√†u' : 'Place Sign On'}
                    </label>
                    <input
                      type="text"
                      value={editCrewData.place_sign_on}
                      onChange={(e) => setEditCrewData({...editCrewData, place_sign_on: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder={language === 'vi' ? 'Nh·∫≠p n∆°i xu·ªëng t√†u' : 'Enter place sign on'}
                    />
                  </div>

                  {/* Empty field - placeholder */}
                  <div className="md:col-span-1"></div>

                  {/* Row 5: Seaman Book (span-1) + Date Sign On (span-1) + Date Sign Off (span-1) + [Empty] (span-1) */}
                  {/* Seaman Book - Optional */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'S·ªï thuy·ªÅn vi√™n' : 'Seaman Book'}
                    </label>
                    <input
                      type="text"
                      value={editCrewData.seamen_book}
                      onChange={(e) => setEditCrewData({...editCrewData, seamen_book: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder={language === 'vi' ? 'S·ªë s·ªï thuy·ªÅn vi√™n' : 'Seaman book number'}
                    />
                  </div>

                  {/* Date Sign On - Optional */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'Ng√†y xu·ªëng t√†u' : 'Date Sign On'}
                      <span className="text-xs text-gray-500 ml-2">
                        {language === 'vi' ? '(ƒê·ªÉ tr·ªëng ƒë·ªÉ x√≥a)' : '(Leave empty to clear)'}
                      </span>
                    </label>
                    <input
                      type="date"
                      value={editCrewData.date_sign_on}
                      onChange={(e) => setEditCrewData({...editCrewData, date_sign_on: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>

                  {/* Date Sign Off - Optional */}
                  <div className="md:col-span-1">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {language === 'vi' ? 'Ng√†y r·ªùi t√†u' : 'Date Sign Off'}
                      <span className="text-xs text-gray-500 ml-2">
                        {language === 'vi' ? '(ƒê·ªÉ tr·ªëng ƒë·ªÉ x√≥a)' : '(Leave empty to clear)'}
                      </span>
                    </label>
                    <input
                      type="date"
                      value={editCrewData.date_sign_off}
                      onChange={(e) => {
                        const signOffDate = e.target.value;
                        setEditCrewData({
                          ...editCrewData, 
                          date_sign_off: signOffDate,
                          // Auto-update Status and Ship Sign On ONLY when Date Sign Off is filled
                          // If empty (cleared), don't change status/ship
                          ...(signOffDate ? {
                            status: 'Standby',
                            ship_sign_on: '-'
                          } : {})
                        });
                      }}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>

                  {/* Empty field - placeholder */}
                  <div className="md:col-span-1"></div>

                  {/* Submit Buttons */}
                  <div className="flex justify-end space-x-4 mt-4 pt-4 border-t border-gray-200 md:col-span-4">
                    <button
                      type="button"
                      onClick={closeEditCrewModal}
                      className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all"
                    >
                      {language === 'vi' ? 'H·ªßy' : 'Cancel'}
                    </button>
                    <button
                      type="submit"
                      className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all flex items-center"
                    >
                      <span className="mr-2">üíæ</span>
                      {language === 'vi' ? 'L∆∞u thay ƒë·ªïi' : 'Save Changes'}
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}

      {/* Bulk Edit Place Sign On Modal */}
      {showBulkEditPlaceSignOn && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md">
            <div className="p-6 border-b border-gray-200">
              <div className="flex items-center justify-between">
                <h3 className="text-lg font-bold text-gray-800 flex items-center">
                  <svg className="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  {language === 'vi' ? 'Ch·ªânh s·ª≠a n∆°i xu·ªëng t√†u' : 'Edit Place Sign On'}
                </h3>
                <button
                  onClick={() => setShowBulkEditPlaceSignOn(false)}
                  className="text-gray-400 hover:text-gray-600 text-2xl font-bold"
                >
                  √ó
                </button>
              </div>
            </div>
            
            <div className="p-6">
              <div className="mb-4">
                <div className="text-sm text-gray-600 mb-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                  <div className="flex items-center space-x-2 mb-2">
                    <svg className="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>
                      {language === 'vi' 
                        ? `C·∫≠p nh·∫≠t n∆°i xu·ªëng t√†u cho ${selectedCrewMembers.size} thuy·ªÅn vi√™n ƒë∆∞·ª£c ch·ªçn`
                        : `Update place sign on for ${selectedCrewMembers.size} selected crew members`
                      }
                    </span>
                  </div>
                  <div className="text-xs text-blue-700 font-medium space-y-1">
                    <div>
                      {language === 'vi' 
                        ? '‚úÖ Nh·∫≠p ƒë·ªãa ƒëi·ªÉm: C·∫≠p nh·∫≠t n∆°i xu·ªëng t√†u'
                        : '‚úÖ Enter location: Update place sign on'
                      }
                    </div>
                    <div>
                      {language === 'vi' 
                        ? 'üóëÔ∏è ƒê·ªÉ tr·ªëng: X√≥a n∆°i xu·ªëng t√†u'
                        : 'üóëÔ∏è Leave empty: Clear place sign on'
                      }
                    </div>
                  </div>
                </div>
                
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  {language === 'vi' ? 'N∆°i xu·ªëng t√†u' : 'Place Sign On'}
                </label>
                <input
                  type="text"
                  value={bulkPlaceSignOn}
                  onChange={(e) => setBulkPlaceSignOn(e.target.value)}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      e.preventDefault();
                      handleBulkUpdatePlaceSignOn();
                    }
                  }}
                  placeholder={language === 'vi' ? 'Nh·∫≠p n∆°i xu·ªëng t√†u (v√≠ d·ª•: H·∫£i Ph√≤ng, Vietnam)' : 'Enter place sign on (e.g: Ho Chi Minh City, Vietnam)'}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  autoFocus
                />
              </div>

              <div className="flex justify-end space-x-3">
                <button
                  onClick={() => setShowBulkEditPlaceSignOn(false)}
                  className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all"
                >
                  {language === 'vi' ? 'H·ªßy' : 'Cancel'}
                </button>
                <button
                  onClick={handleBulkUpdatePlaceSignOn}
                  className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all flex items-center"
                >
                  <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                  </svg>
                  {language === 'vi' ? 'C·∫≠p nh·∫≠t' : 'Update'}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Bulk Edit Ship Sign On Modal */}
      {showBulkEditShipSignOn && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md">
            <div className="p-6 border-b border-gray-200">
              <div className="flex items-center justify-between">
                <h3 className="text-lg font-bold text-gray-800 flex items-center">
                  <svg className="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                  </svg>
                  {language === 'vi' ? 'Ch·ªânh s·ª≠a t√†u ƒëƒÉng k√Ω' : 'Edit Ship Sign On'}
                </h3>
                <button
                  onClick={() => setShowBulkEditShipSignOn(false)}
                  className="text-gray-400 hover:text-gray-600 text-2xl font-bold"
                >
                  √ó
                </button>
              </div>
            </div>
            
            <div className="p-6">
              <div className="mb-4">
                <p className="text-sm text-gray-600 mb-4">
                  {language === 'vi' 
                    ? `C·∫≠p nh·∫≠t t√†u ƒëƒÉng k√Ω cho ${selectedCrewMembers.size} thuy·ªÅn vi√™n ƒë√£ ch·ªçn`
                    : `Update ship sign on for ${selectedCrewMembers.size} selected crew members`
                  }
                </p>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  {language === 'vi' ? 'T√†u ƒëƒÉng k√Ω' : 'Ship Sign On'}
                </label>
                <select
                  value={bulkShipSignOn}
                  onChange={(e) => setBulkShipSignOn(e.target.value)}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' && bulkShipSignOn) {
                      e.preventDefault();
                      handleBulkUpdateShipSignOn();
                    }
                  }}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                  autoFocus
                >
                  <option value="">{language === 'vi' ? '-- Ch·ªçn t√†u --' : '-- Select Ship --'}</option>
                  {ships.map(ship => (
                    <option key={ship.id} value={ship.name}>{ship.name}</option>
                  ))}
                  <option value="-">-</option>
                </select>
                <div className="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                  <p className="text-xs text-blue-800 font-medium">
                    {language === 'vi' ? 'üìã C·∫≠p nh·∫≠t t·ª± ƒë·ªông:' : 'üìã Auto-updates:'}
                  </p>
                  <ul className="text-xs text-blue-700 mt-1 space-y-1">
                    <li>‚úÖ {language === 'vi' ? 'T√†u ƒëƒÉng k√Ω ‚Üí T√†u ƒë√£ ch·ªçn' : 'Ship Sign On ‚Üí Selected Ship'}</li>
                    <li>‚úÖ {language === 'vi' ? 'Tr·∫°ng th√°i ‚Üí "Sign on"' : 'Status ‚Üí "Sign on"'}</li>
                    <li>‚úÖ {language === 'vi' ? 'Ng√†y r·ªùi t√†u ‚Üí X√≥a (null)' : 'Date Sign Off ‚Üí Cleared (null)'}</li>
                  </ul>
                </div>
              </div>

              <div className="flex justify-end space-x-3">
                <button
                  onClick={() => setShowBulkEditShipSignOn(false)}
                  className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all"
                >
                  {language === 'vi' ? 'H·ªßy' : 'Cancel'}
                </button>
                <button
                  onClick={handleBulkUpdateShipSignOn}
                  disabled={!bulkShipSignOn}
                  className="px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded-lg transition-all flex items-center"
                >
                  <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                  </svg>
                  {language === 'vi' ? 'C·∫≠p nh·∫≠t' : 'Update'}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Bulk Edit Date Sign On Modal */}
      {showBulkEditDateSignOn && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md">
            <div className="p-6 border-b border-gray-200">
              <div className="flex items-center justify-between">
                <h3 className="text-lg font-bold text-gray-800 flex items-center">
                  <svg className="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  {language === 'vi' ? 'Ch·ªânh s·ª≠a ng√†y l√™n t√†u' : 'Edit Date Sign On'}
                </h3>
                <button
                  onClick={() => setShowBulkEditDateSignOn(false)}
                  className="text-gray-400 hover:text-gray-600 text-2xl font-bold"
                >
                  √ó
                </button>
              </div>
            </div>
            
            <div className="p-6">
              <div className="mb-4">
                <div className="text-sm text-gray-600 mb-3 p-3 bg-green-50 rounded-lg border border-green-200">
                  <div className="flex items-center space-x-2 mb-2">
                    <svg className="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>
                      {language === 'vi' 
                        ? `C·∫≠p nh·∫≠t ng√†y l√™n t√†u cho ${selectedCrewMembers.size} thuy·ªÅn vi√™n ƒë∆∞·ª£c ch·ªçn`
                        : `Update date sign on for ${selectedCrewMembers.size} selected crew members`
                      }
                    </span>
                  </div>
                  <div className="text-xs text-green-700 font-medium space-y-1">
                    <div>
                      {language === 'vi' 
                        ? '‚úÖ Nh·∫≠p ng√†y: C·∫≠p nh·∫≠t ng√†y l√™n t√†u'
                        : '‚úÖ Enter date: Update date sign on'
                      }
                    </div>
                    <div>
                      {language === 'vi' 
                        ? 'üóëÔ∏è ƒê·ªÉ tr·ªëng: X√≥a ng√†y l√™n t√†u'
                        : 'üóëÔ∏è Leave empty: Clear date sign on'
                      }
                    </div>
                  </div>
                </div>
                
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  {language === 'vi' ? 'Ng√†y l√™n t√†u' : 'Date Sign On'}
                </label>
                <input
                  type="date"
                  value={bulkDateSignOn}
                  onChange={(e) => setBulkDateSignOn(e.target.value)}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      e.preventDefault();
                      handleBulkUpdateDateSignOn();
                    }
                  }}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                  autoFocus
                />
                
                {/* Date format info */}
                <div className="mt-2 text-xs text-gray-500">
                  {language === 'vi' 
                    ? 'ƒê·ªãnh d·∫°ng: DD/MM/YYYY (hi·ªÉn th·ªã) - D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω ƒë·ªÉ tr√°nh l·ªói m√∫i gi·ªù'
                    : 'Format: DD/MM/YYYY (display) - Data processed to prevent timezone shifts'
                  }
                </div>
              </div>

              <div className="flex justify-end space-x-3">
                <button
                  onClick={() => setShowBulkEditDateSignOn(false)}
                  className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all"
                >
                  {language === 'vi' ? 'H·ªßy' : 'Cancel'}
                </button>
                <button
                  onClick={handleBulkUpdateDateSignOn}
                  className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-all flex items-center"
                >
                  <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                  </svg>
                  {language === 'vi' ? 'C·∫≠p nh·∫≠t' : 'Update'}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Bulk Edit Date Sign Off Modal */}
      {showBulkEditDateSignOff && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md">
            <div className="p-6 border-b border-gray-200">
              <div className="flex items-center justify-between">
                <h3 className="text-lg font-bold text-gray-800 flex items-center">
                  <svg className="w-5 h-5 mr-2 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                  </svg>
                  {language === 'vi' ? 'Ch·ªânh s·ª≠a ng√†y r·ªùi t√†u' : 'Edit Date Sign Off'}
                </h3>
                <button
                  onClick={() => setShowBulkEditDateSignOff(false)}
                  className="text-gray-400 hover:text-gray-600 text-2xl font-bold"
                >
                  √ó
                </button>
              </div>
            </div>
            
            <div className="p-6">
              <div className="mb-4">
                <div className="text-sm text-gray-600 mb-3 p-3 bg-orange-50 rounded-lg border border-orange-200">
                  <div className="flex items-center space-x-2 mb-2">
                    <svg className="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>
                      {language === 'vi' 
                        ? `C·∫≠p nh·∫≠t ng√†y r·ªùi t√†u cho ${selectedCrewMembers.size} thuy·ªÅn vi√™n ƒë∆∞·ª£c ch·ªçn`
                        : `Update date sign off for ${selectedCrewMembers.size} selected crew members`
                      }
                    </span>
                  </div>
                  <div className="text-xs text-orange-700 font-medium space-y-1">
                    <div>
                      {language === 'vi' 
                        ? '‚úÖ Nh·∫≠p ng√†y: Tr·∫°ng th√°i ‚Üí "Standby", T√†u ‚Üí "-"'
                        : '‚úÖ Enter date: Status ‚Üí "Standby", Ship ‚Üí "-"'
                      }
                    </div>
                    <div>
                      {language === 'vi' 
                        ? 'üóëÔ∏è ƒê·ªÉ tr·ªëng: X√≥a ng√†y r·ªùi t√†u (kh√¥ng ƒë·ªïi tr·∫°ng th√°i/t√†u)'
                        : 'üóëÔ∏è Leave empty: Clear date sign off (status/ship unchanged)'
                      }
                    </div>
                  </div>
                </div>
                
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  {language === 'vi' ? 'Ng√†y r·ªùi t√†u' : 'Date Sign Off'}
                </label>
                <input
                  type="date"
                  value={bulkDateSignOff}
                  onChange={(e) => setBulkDateSignOff(e.target.value)}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      e.preventDefault();
                      handleBulkUpdateDateSignOff();
                    }
                  }}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                  autoFocus
                />
                
                {/* Date format info */}
                <div className="mt-2 text-xs text-gray-500">
                  {language === 'vi' 
                    ? 'ƒê·ªãnh d·∫°ng: DD/MM/YYYY (hi·ªÉn th·ªã) - D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω ƒë·ªÉ tr√°nh l·ªói m√∫i gi·ªù'
                    : 'Format: DD/MM/YYYY (display) - Data processed to prevent timezone shifts'
                  }
                </div>
              </div>

              <div className="flex justify-end space-x-3">
                <button
                  onClick={() => setShowBulkEditDateSignOff(false)}
                  className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all"
                >
                  {language === 'vi' ? 'H·ªßy' : 'Cancel'}
                </button>
                <button
                  onClick={handleBulkUpdateDateSignOff}
                  className="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-all flex items-center"
                >
                  <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                  </svg>
                  {language === 'vi' ? 'C·∫≠p nh·∫≠t' : 'Update'}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// Account Control Page Component  
const AccountControlPage = () => {
  const { user, language, token } = useAuth();
  const [users, setUsers] = useState([]);
  const [showAddUser, setShowAddUser] = useState(false);
  const [showEditUser, setShowEditUser] = useState(false);
  const [showUserList, setShowUserList] = useState(false);
  const [editingUser, setEditingUser] = useState(null);
  const [newUserData, setNewUserData] = useState({
    username: '',
    email: '',
    password: '',
    full_name: '',
    role: 'viewer',
    department: 'technical',
    company: '',
    ship: '',
    zalo: '',
    gmail: ''
  });
  // User filtering and sorting state
  const [userFilters, setUserFilters] = useState({
    company: '',
    department: '',
    ship: ''
  });
  const [userSorting, setUserSorting] = useState({
    sortBy: 'full_name',
    sortOrder: 'asc'
  });
  const [filteredUsers, setFilteredUsers] = useState([]);
  const [showPermissions, setShowPermissions] = useState(false);
  const [showGoogleDrive, setShowGoogleDrive] = useState(false);
  const [showAIConfig, setShowAIConfig] = useState(false);
  
  // Admin Tools States
  const [backfillProcessing, setBackfillProcessing] = useState(false);
  const [backfillProgress, setBackfillProgress] = useState(null);
  const [backfillHistory, setBackfillHistory] = useState([]);
  
  const [showCompanyForm, setShowCompanyForm] = useState(false);
  const [showEditCompany, setShowEditCompany] = useState(false);
  const [editingCompany, setEditingCompany] = useState(null);
  // PDF Analysis state
  const [showPdfAnalysis, setShowPdfAnalysis] = useState(false);
  const [pdfFile, setPdfFile] = useState(null);
  const [pdfAnalyzing, setPdfAnalyzing] = useState(false);
  // Duplicate modal state for AccountControlPage
  const [duplicateModal, setDuplicateModal] = useState({
    show: false,
    duplicates: [],
    currentFile: null,
    analysisResult: null,
    uploadResult: null,
    status: 'all'
  });
  
  // Duplicate resolution modal for multi-cert upload - removed duplicate state
  
  // Ship mismatch modal state for AccountControlPage
  const [mismatchModal, setMismatchModal] = useState({
    show: false,
    mismatchInfo: null,
    analysisResult: null,
    uploadResult: null
  });
  const [availableCompanies, setAvailableCompanies] = useState([]);
  const [selectedUsers, setSelectedUsers] = useState([]);
  const [systemGdriveConfig, setSystemGdriveConfig] = useState({
    auth_method: 'apps_script', // 'apps_script', 'oauth', or 'service_account' 
    // Apps Script fields
    web_app_url: '',
    // OAuth fields
    client_id: '',
    client_secret: '',
    folder_id: '',
    // Service Account fields (legacy)
    service_account_json: ''
  });
  const [gdriveStatus, setGdriveStatus] = useState(null);
  const [gdriveCurrentConfig, setGdriveCurrentConfig] = useState(null);
  const [syncLoading, setSyncLoading] = useState(false);
  const [testLoading, setTestLoading] = useState(false);
  // Company Google Drive state
  const [showCompanyGoogleDrive, setShowCompanyGoogleDrive] = useState(false);
  const [companyGdriveConfig, setCompanyGdriveConfig] = useState({
    auth_method: 'apps_script',
    web_app_url: '',
    client_id: '',
    client_secret: '',
    folder_id: '',
    service_account_json: ''
  });
  const [companyGdriveStatus, setCompanyGdriveStatus] = useState(null);
  const [companyGdriveCurrentConfig, setCompanyGdriveCurrentConfig] = useState(null);
  const [companyGdriveTestLoading, setCompanyGdriveTestLoading] = useState(false);
  const [aiConfig, setAiConfig] = useState({
    provider: 'openai',
    model: 'gpt-4o',
    api_key: ''
  });
  const [companies, setCompanies] = useState([]);
  const [ships, setShips] = useState([]);
  const [companyData, setCompanyData] = useState({
    name_vn: '',
    name_en: '',
    address_vn: '',
    address_en: '',
    tax_id: '',
    gmail: '',
    zalo: '',
    system_expiry: '',
    gdrive_config: {
      service_account_email: '',
      project_id: '',
      private_key: '',
      client_email: '',
      client_id: '',
      folder_id: ''
    }
  });
  const [usageStats, setUsageStats] = useState(null);
  const [usageLoading, setUsageLoading] = useState(false);
  const navigate = useNavigate();
  
  const t = translations[language];

  // Helper function to format dates
  const formatDate = (dateString) => {
    if (!dateString) return '-';
    try {
      // Handle YYYY-MM-DD format (no time component)
      if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
        const [year, month, day] = dateString.split('-');
        return `${day}/${month}/${year}`;
      }
      
      // Handle ISO datetime strings - check if it has timezone indicator
      if (typeof dateString === 'string' && dateString.includes('T')) {
        // If no timezone indicator (Z or +/-), treat as UTC by adding 'Z'
        const dateToUse = dateString.endsWith('Z') || /[+-]\d{2}:\d{2}$/.test(dateString) 
          ? dateString 
          : dateString + 'Z';
        
        const date = new Date(dateToUse);
        const day = String(date.getUTCDate()).padStart(2, '0');
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const year = date.getUTCFullYear();
        return `${day}/${month}/${year}`;
      }
      
      // Fallback to original logic
      const date = new Date(dateString);
      const day = String(date.getUTCDate()).padStart(2, '0');
      const month = String(date.getUTCMonth() + 1).padStart(2, '0');
      const year = date.getUTCFullYear();
      return `${day}/${month}/${year}`;
    } catch (error) {
      return '-';
    }
  };

  // Multi-file upload duplicate resolution functions (AccountControlPage)
  const handleDuplicateResolution = (action) => {
    toast.info(language === 'vi' ? 'Ch·ª©c nƒÉng ƒëang ƒë∆∞·ª£c x√¢y d·ª±ng l·∫°i' : 'Feature is being rebuilt');
  };

  // These functions are not needed in AddRecordModal
  // Duplicate resolution is handled at the main component level

  const handleMismatchResolution = (action) => {
    toast.info(language === 'vi' ? 'Ch·ª©c nƒÉng ƒëang ƒë∆∞·ª£c x√¢y d·ª±ng l·∫°i' : 'Feature is being rebuilt');
  };

  // Role hierarchy helper functions
  const roleHierarchy = {
    'viewer': 1,
    'editor': 2,
    'manager': 3,
    'admin': 4,
    'super_admin': 5
  };

  const canEditUser = (targetUser) => {
    // Self-edit prevention
    if (targetUser.id === user.id) return false;
    
    const currentLevel = roleHierarchy[user.role] || 0;
    const targetLevel = roleHierarchy[targetUser.role] || 0;
    
    // Super Admin can edit anyone
    if (user.role === 'super_admin') return true;
    
    // Admin can edit anyone except Super Admin  
    if (user.role === 'admin') {
      return targetLevel < roleHierarchy['super_admin'];
    }
    
    // Manager can only edit users in same company with lower or equal role
    if (user.role === 'manager') {
      if (targetUser.company !== user.company) return false;
      return targetLevel <= currentLevel;
    }
    
    // Lower roles cannot edit anyone
    return false;
  };

  const canDeleteUser = (targetUser) => {
    // Self-delete prevention  
    if (targetUser.id === user.id) return false;
    
    // Super Admin protection - only Super Admin can delete Super Admin
    if (targetUser.role === 'super_admin' && user.role !== 'super_admin') return false;
    
    // Use same logic as edit for other cases
    return canEditUser(targetUser);
  };

  const canEditCompany = (company) => {
    // Super Admin can edit any company
    if (user.role === 'super_admin') return true;
    
    // Admin can only edit their own company
    if (user.role === 'admin') {
      return company.name_vn === user.company || company.name_en === user.company;
    }
    
    // Lower roles cannot edit companies
    return false;
  };

  const canDeleteCompany = (company) => {
    // Only Super Admin can delete companies
    return user.role === 'super_admin';
  };

  useEffect(() => {
    if (user?.role === 'manager' || user?.role === 'admin' || user?.role === 'super_admin') {
      fetchUsers();
    }
    if (user?.role === 'admin' || user?.role === 'super_admin') {
      fetchGoogleDriveStatus();
      fetchGoogleDriveConfig();
    }
    if (user?.role === 'super_admin' || user?.role === 'admin') {
      fetchAIConfig();
    }
    if (user?.role === 'admin' || user?.role === 'super_admin') {
      fetchCompanies();
    }
    if (user?.role === 'manager' || user?.role === 'admin' || user?.role === 'super_admin') {
      fetchShips();
    }
    if (user?.role === 'admin' || user?.role === 'super_admin') {
      fetchUsageStats();
    }
  }, [user]);

  const fetchUsers = async () => {
    try {
      const response = await axios.get(`${API}/users`);
      setUsers(response.data);
      setFilteredUsers(response.data);
    } catch (error) {
      toast.error('Failed to fetch users');
    }
  };

  const fetchFilteredUsers = async (filters = userFilters, sorting = userSorting) => {
    try {
      const params = new URLSearchParams();
      if (filters.company) params.append('company', filters.company);
      if (filters.department) params.append('department', filters.department);
      if (filters.ship) params.append('ship', filters.ship);
      params.append('sort_by', sorting.sortBy);
      params.append('sort_order', sorting.sortOrder);
      
      const response = await axios.get(`${API}/users/filtered?${params.toString()}`);
      setFilteredUsers(response.data);
    } catch (error) {
      console.error('Failed to fetch filtered users:', error);
      toast.error('Failed to fetch filtered users');
    }
  };

  const fetchGoogleDriveStatus = async () => {
    try {
      const response = await axios.get(`${API}/gdrive/status`);
      setGdriveStatus(response.data);
    } catch (error) {
      console.error('Failed to fetch Google Drive status:', error);
    }
  };

  const fetchGoogleDriveConfig = async () => {
    try {
      const response = await axios.get(`${API}/gdrive/config`);
      setGdriveCurrentConfig(response.data);
    } catch (error) {
      console.error('Failed to fetch Google Drive config:', error);
    }
  };

  const handleTestGoogleDriveConnection = async () => {
    if (!systemGdriveConfig.service_account_json || !systemGdriveConfig.folder_id) {
      toast.error(language === 'vi' ? 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!' : 'Please fill in all required information!');
      return;
    }

    // Clean and validate folder ID
    const cleanFolderId = systemGdriveConfig.folder_id.trim();
    if (cleanFolderId.length < 20 || cleanFolderId.length > 100 || cleanFolderId.includes(' ')) {
      toast.error(language === 'vi' ? 
        `Folder ID kh√¥ng h·ª£p l·ªá (ƒë·ªô d√†i: ${cleanFolderId.length}). Vui l√≤ng ki·ªÉm tra l·∫°i!` :
        `Invalid Folder ID (length: ${cleanFolderId.length}). Please check again!`
      );
      return;
    }

    setTestLoading(true);
    try {
      const testConfig = {
        ...systemGdriveConfig,
        folder_id: cleanFolderId
      };
      
      const response = await axios.post(`${API}/gdrive/test`, testConfig);
      if (response.data.success) {
        toast.success(language === 'vi' ? 
          `K·∫øt n·ªëi th√†nh c√¥ng! Folder: ${response.data.folder_name}` : 
          `Connection successful! Folder: ${response.data.folder_name}`
        );
      } else {
        toast.error(response.data.message);
      }
    } catch (error) {
      const errorMessage = error.response?.data?.message || error.message;
      toast.error(language === 'vi' ? 
        `Test k·∫øt n·ªëi th·∫•t b·∫°i: ${errorMessage}` : 
        `Connection test failed: ${errorMessage}`
      );
    } finally {
      setTestLoading(false);
    }
  };

  const fetchAIConfig = async () => {
    try {
      const response = await axios.get(`${API}/ai-config`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      console.log('Fetched AI config:', response.data);
      setAiConfig({
        provider: response.data.provider || 'google',
        model: response.data.model || 'gemini-2.0-flash',
        api_key: response.data.api_key || '',
        use_emergent_key: response.data.use_emergent_key || true,
        document_ai: response.data.document_ai || {
          enabled: false,
          project_id: '',
          location: 'us',
          processor_id: '',
          apps_script_url: ''
        }
      });
    } catch (error) {
      console.error('Failed to fetch AI config:', error);
      setAiConfig({ 
        provider: 'google', 
        model: 'gemini-2.0-flash', 
        api_key: '',
        use_emergent_key: true,
        document_ai: {
          enabled: false,
          project_id: '',
          location: 'us',
          processor_id: '',
          apps_script_url: ''
        }
      });
    }
  };

  const fetchCompanies = async () => {
    try {
      const response = await axios.get(`${API}/companies`);
      setCompanies(response.data);
    } catch (error) {
      console.error('Failed to fetch companies:', error);
    }
  };

  const fetchShips = async () => {
    try {
      const response = await axios.get(`${API}/ships`);
      setShips(response.data);
    } catch (error) {
      console.error('Failed to fetch ships:', error);
    }
  };

  // Make fetchCompanies available globally for logo upload
  useEffect(() => {
    window.fetchCompanies = fetchCompanies;
    return () => {
      delete window.fetchCompanies;
    };
  }, []);

  const fetchUsageStats = async () => {
    try {
      const response = await axios.get(`${API}/usage-stats?days=30`);
      setUsageStats(response.data);
    } catch (error) {
      console.error('Failed to fetch usage stats:', error);
    }
  };

  const handleGoogleDriveConfig = async () => {
    // Validate required fields based on auth method
    const authMethod = systemGdriveConfig.auth_method || 'apps_script';
    
    let missingFields = false;
    if (authMethod === 'apps_script') {
      if (!systemGdriveConfig.web_app_url || !systemGdriveConfig.folder_id) {
        missingFields = true;
      }
    } else if (authMethod === 'oauth') {
      if (!systemGdriveConfig.client_id || !systemGdriveConfig.client_secret || !systemGdriveConfig.folder_id) {
        missingFields = true;
      }
    } else if (authMethod === 'service_account') {
      if (!systemGdriveConfig.service_account_json || !systemGdriveConfig.folder_id) {
        missingFields = true;
      }
    }
    
    if (missingFields) {
      toast.error(language === 'vi' ? 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin' : 'Please fill all required fields');
      return;
    }

    try {
      let endpoint;
      let payload;
      
      if (authMethod === 'apps_script') {
        endpoint = '/gdrive/configure-proxy';
        payload = {
          web_app_url: systemGdriveConfig.web_app_url,
          folder_id: systemGdriveConfig.folder_id
        };
      } else if (authMethod === 'oauth') {
        endpoint = '/gdrive/oauth/authorize';
        payload = {
          client_id: systemGdriveConfig.client_id,
          client_secret: systemGdriveConfig.client_secret,
          redirect_uri: 'https://maritime-docai.preview.emergentagent.com/oauth2callback',
          folder_id: systemGdriveConfig.folder_id
        };
      } else {
        endpoint = '/gdrive/configure';
        payload = {
          service_account_json: systemGdriveConfig.service_account_json,
          folder_id: systemGdriveConfig.folder_id
        };
      }
      
      const response = await axios.post(`${API}${endpoint}`, payload);
      
      if (authMethod === 'oauth' && response.data.authorization_url) {
        // For OAuth, redirect to authorization URL
        sessionStorage.setItem('oauth_state', response.data.state);
        window.location.href = response.data.authorization_url;
      } else {
        // For Apps Script and Service Account, show success
        toast.success(language === 'vi' ? 'C·∫•u h√¨nh Google Drive th√†nh c√¥ng!' : 'Google Drive configured successfully!');
        setShowGoogleDrive(false);
        // Reset config based on auth method
        if (authMethod === 'apps_script') {
          setSystemGdriveConfig(prev => ({ ...prev, web_app_url: '', folder_id: '' }));
        } else if (authMethod === 'oauth') {
          setSystemGdriveConfig(prev => ({ ...prev, client_id: '', client_secret: '', folder_id: '' }));
        } else {
          setSystemGdriveConfig(prev => ({ ...prev, service_account_json: '', folder_id: '' }));
        }
        fetchGoogleDriveStatus();
        fetchGoogleDriveConfig();
      }
    } catch (error) {
      console.error('Google Drive configuration error:', error);
      toast.error(language === 'vi' ? 'C·∫•u h√¨nh Google Drive th·∫•t b·∫°i!' : 'Failed to configure Google Drive!');
    }
  };

  const handleSyncToGoogleDrive = async () => {
    setSyncLoading(true);
    try {
      // Check current auth method from config
      const currentConfig = await axios.get(`${API}/gdrive/config`);
      const authMethod = currentConfig.data?.auth_method || 'service_account';
      
      let endpoint;
      if (authMethod === 'apps_script') {
        endpoint = '/gdrive/sync-to-drive-proxy';
      } else {
        endpoint = '/gdrive/sync-to-drive';
      }
      
      await axios.post(`${API}${endpoint}`);
      toast.success(language === 'vi' ? 'ƒê·ªìng b·ªô l√™n Google Drive th√†nh c√¥ng!' : 'Synced to Google Drive successfully!');
      fetchGoogleDriveStatus();
    } catch (error) {
      console.error('Sync to Google Drive error:', error);
      toast.error(language === 'vi' ? 'ƒê·ªìng b·ªô th·∫•t b·∫°i!' : 'Sync failed!');
    } finally {
      setSyncLoading(false);
    }
  };

  const handleSyncFromGoogleDrive = async () => {
    setSyncLoading(true);
    try {
      await axios.post(`${API}/gdrive/sync-from-drive`);
      toast.success(language === 'vi' ? 'ƒê·ªìng b·ªô t·ª´ Google Drive th√†nh c√¥ng!' : 'Synced from Google Drive successfully!');
      fetchGoogleDriveStatus();
    } catch (error) {
      toast.error(language === 'vi' ? 'ƒê·ªìng b·ªô th·∫•t b·∫°i!' : 'Sync failed!');
    } finally {
      setSyncLoading(false);
    }
  };

  const toggleSystemGoogleDriveModal = () => {
    setShowGoogleDrive(!showGoogleDrive);
  };

  const handleAIConfigUpdate = async () => {
    try {
      console.log('Saving AI config:', aiConfig);
      
      const response = await axios.post(`${API}/ai-config`, aiConfig, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });
      
      console.log('AI config save response:', response.data);
      toast.success(language === 'vi' ? 'C·∫•u h√¨nh AI th√†nh c√¥ng!' : 'AI configuration updated successfully!');
      setShowAIConfig(false);
      fetchAIConfig();
    } catch (error) {
      console.error('AI config save error:', error);
      const errorMsg = error.response?.data?.detail || error.message;
      toast.error(language === 'vi' 
        ? `C·∫•u h√¨nh AI th·∫•t b·∫°i: ${errorMsg}` 
        : `Failed to update AI configuration: ${errorMsg}`
      );
    }
  };

  // Removed duplicate functions - will be defined earlier

  // Admin Tools Functions
  const handleBackfillProcessing = async () => {
    if (backfillProcessing) return;
    
    setBackfillProcessing(true);
    setBackfillProgress({
      status: 'starting',
      processed: 0,
      updated: 0,
      errors: 0,
      message: language === 'vi' ? 'B·∫Øt ƒë·∫ßu x·ª≠ l√Ω backfill...' : 'Starting backfill processing...'
    });
    
    try {
      const response = await axios.post(`${API}/certificates/backfill-ship-info`, 
        { limit: 20 }, // Process 20 certificates at a time
        {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token') || sessionStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          }
        }
      );
      
      if (response.data.success) {
        const result = response.data;
        setBackfillProgress({
          status: 'completed',
          processed: result.processed,
          updated: result.updated,
          errors: result.errors,
          remaining: result.remaining || 0,
          message: language === 'vi' 
            ? `Ho√†n th√†nh: ${result.updated}/${result.processed} certificates ƒë∆∞·ª£c c·∫≠p nh·∫≠t`
            : `Completed: ${result.updated}/${result.processed} certificates updated`
        });
        
        // Add to history
        const historyItem = {
          timestamp: new Date().toISOString(),
          processed: result.processed,
          updated: result.updated,
          errors: result.errors,
          remaining: result.remaining || 0
        };
        setBackfillHistory(prev => [historyItem, ...prev.slice(0, 4)]); // Keep last 5 records
        
        toast.success(language === 'vi' 
          ? `‚úÖ Backfill ho√†n th√†nh: ${result.updated} certificates ƒë∆∞·ª£c c·∫≠p nh·∫≠t`
          : `‚úÖ Backfill completed: ${result.updated} certificates updated`
        );
      } else {
        throw new Error(response.data.error || 'Backfill failed');
      }
    } catch (error) {
      console.error('Backfill processing error:', error);
      setBackfillProgress({
        status: 'error',
        processed: 0,
        updated: 0,
        errors: 1,
        message: language === 'vi' 
          ? `L·ªói: ${error.response?.data?.detail || error.message}`
          : `Error: ${error.response?.data?.detail || error.message}`
      });
      
      toast.error(language === 'vi' 
        ? `‚ùå Backfill th·∫•t b·∫°i: ${error.response?.data?.detail || error.message}`
        : `‚ùå Backfill failed: ${error.response?.data?.detail || error.message}`
      );
    } finally {
      setBackfillProcessing(false);
    }
  };

  const handlePdfAnalysis = async () => {
    if (!pdfFile) {
      toast.error(language === 'vi' ? 'Vui l√≤ng ch·ªçn file PDF!' : 'Please select a PDF file!');
      return;
    }

    setPdfAnalyzing(true);
    try {
      const formData = new FormData();
      formData.append('file', pdfFile);

      const response = await axios.post(`${API}/analyze-pdf`, formData, {
        headers: {
          'Content-Type': 'multipart/form-data',
        }
      });

      if (response.data.success) {
        toast.success(language === 'vi' ? 'Ph√¢n t√≠ch PDF th√†nh c√¥ng!' : 'PDF analysis completed!');
        // You can handle the analysis results here
        console.log('PDF Analysis Results:', response.data.analysis);
      } else {
        toast.error(language === 'vi' ? 'Ph√¢n t√≠ch PDF th·∫•t b·∫°i!' : 'PDF analysis failed!');
      }
    } catch (error) {
      console.error('PDF analysis error:', error);
      const errorMessage = error.response?.data?.message || error.message;
      toast.error(language === 'vi' ? `L·ªói ph√¢n t√≠ch PDF: ${errorMessage}` : `PDF analysis error: ${errorMessage}`);
    } finally {
      setPdfAnalyzing(false);
      setShowPdfAnalysis(false);
      setPdfFile(null);
    }
  };

  // Company Google Drive Configuration Functions
  const fetchCompanyGoogleDriveStatus = async (companyId) => {
    try {
      const response = await axios.get(`${API}/companies/${companyId}/gdrive/status`);
      setCompanyGdriveStatus(response.data);
    } catch (error) {
      console.error('Failed to fetch company Google Drive status:', error);
    }
  };

  const fetchCompanyGoogleDriveConfig = async (companyId) => {
    try {
      const response = await axios.get(`${API}/companies/${companyId}/gdrive/config`);
      setCompanyGdriveCurrentConfig(response.data);
    } catch (error) {
      console.error('Failed to fetch company Google Drive config:', error);
    }
  };

  const handleCompanyGoogleDriveConfig = async (companyId) => {
    // Validate required fields based on auth method
    const authMethod = companyGdriveConfig.auth_method || 'apps_script';
    
    let missingFields = false;
    if (authMethod === 'apps_script') {
      if (!companyGdriveConfig.web_app_url || !companyGdriveConfig.folder_id) {
        missingFields = true;
      }
    } else if (authMethod === 'oauth') {
      if (!companyGdriveConfig.client_id || !companyGdriveConfig.client_secret || !companyGdriveConfig.folder_id) {
        missingFields = true;
      }
    } else if (authMethod === 'service_account') {
      if (!companyGdriveConfig.service_account_json || !companyGdriveConfig.folder_id) {
        missingFields = true;
      }
    }
    
    if (missingFields) {
      toast.error(language === 'vi' ? 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin' : 'Please fill all required fields');
      return;
    }

    try {
      let endpoint;
      let payload;
      
      if (authMethod === 'apps_script') {
        endpoint = `/companies/${companyId}/gdrive/configure-proxy`;
        payload = {
          web_app_url: companyGdriveConfig.web_app_url,
          folder_id: companyGdriveConfig.folder_id
        };
      } else if (authMethod === 'oauth') {
        endpoint = `/companies/${companyId}/gdrive/oauth/authorize`;
        payload = {
          client_id: companyGdriveConfig.client_id,
          client_secret: companyGdriveConfig.client_secret,
          redirect_uri: 'https://maritime-docai.preview.emergentagent.com/oauth2callback',
          folder_id: companyGdriveConfig.folder_id
        };
      } else {
        endpoint = `/companies/${companyId}/gdrive/configure`;
        payload = {
          service_account_json: companyGdriveConfig.service_account_json,
          folder_id: companyGdriveConfig.folder_id
        };
      }
      
      const response = await axios.post(`${API}${endpoint}`, payload);
      
      if (authMethod === 'oauth' && response.data.authorization_url) {
        // For OAuth, redirect to authorization URL
        sessionStorage.setItem('oauth_state', response.data.state);
        window.location.href = response.data.authorization_url;
      } else {
        // For Apps Script and Service Account, show success
        toast.success(language === 'vi' ? 'C·∫•u h√¨nh Google Drive c√¥ng ty th√†nh c√¥ng!' : 'Company Google Drive configured successfully!');
        setShowCompanyGoogleDrive(false);
        // Reset config based on auth method
        if (authMethod === 'apps_script') {
          setCompanyGdriveConfig(prev => ({ ...prev, web_app_url: '', folder_id: '' }));
        } else if (authMethod === 'oauth') {
          setCompanyGdriveConfig(prev => ({ ...prev, client_id: '', client_secret: '', folder_id: '' }));
        } else {
          setCompanyGdriveConfig(prev => ({ ...prev, service_account_json: '', folder_id: '' }));
        }
        fetchCompanyGoogleDriveStatus(companyId);
        fetchCompanyGoogleDriveConfig(companyId);
      }
    } catch (error) {
      console.error('Company Google Drive configuration error:', error);
      toast.error(language === 'vi' ? 'C·∫•u h√¨nh Google Drive c√¥ng ty th·∫•t b·∫°i!' : 'Failed to configure company Google Drive!');
    }
  };

  const handleTestCompanyGoogleDriveConnection = async (companyId) => {
    if (!companyGdriveConfig.service_account_json || !companyGdriveConfig.folder_id) {
      toast.error(language === 'vi' ? 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!' : 'Please fill in all required information!');
      return;
    }

    setCompanyGdriveTestLoading(true);
    try {
      const testConfig = {
        service_account_json: companyGdriveConfig.service_account_json,
        folder_id: companyGdriveConfig.folder_id
      };
      
      const response = await axios.post(`${API}/companies/${companyId}/gdrive/test`, testConfig);
      if (response.data.success) {
        toast.success(language === 'vi' ? 
          `K·∫øt n·ªëi th√†nh c√¥ng! Folder: ${response.data.folder_name}` : 
          `Connection successful! Folder: ${response.data.folder_name}`
        );
      } else {
        toast.error(response.data.message);
      }
    } catch (error) {
      const errorMessage = error.response?.data?.message || error.message;
      toast.error(language === 'vi' ? 
        `Test k·∫øt n·ªëi th·∫•t b·∫°i: ${errorMessage}` : 
        `Connection test failed: ${errorMessage}`
      );
    } finally {
      setCompanyGdriveTestLoading(false);
    }
  };

  const handleCreateCompany = async () => {
    if (!companyData.name_vn || !companyData.name_en || !companyData.tax_id) {
      toast.error(language === 'vi' ? 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc' : 'Please fill all required fields');
      return;
    }

    try {
      const payload = {
        ...companyData,
        system_expiry: companyData.system_expiry ? new Date(companyData.system_expiry).toISOString() : null
      };
      
      const response = await axios.post(`${API}/companies`, payload);
      const newCompany = response.data;
      
      // Store the company ID for logo upload
      setCompanyData(prev => ({ ...prev, id: newCompany.id }));
      
      toast.success(language === 'vi' ? 'C√¥ng ty ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!' : 'Company created successfully!');
      setShowCompanyForm(false);
      
      // Reset form data
      setCompanyData({
        name_vn: '',
        name_en: '',
        address_vn: '',
        address_en: '',
        tax_id: '',
        gmail: '',
        zalo: '',
        system_expiry: '',
        gdrive_config: {
          service_account_email: '',
          project_id: '',
          private_key: '',
          client_email: '',
          client_id: '',
          folder_id: ''
        }
      });
      
      fetchCompanies();
      
      return newCompany;
    } catch (error) {
      toast.error(language === 'vi' ? 'Kh√¥ng th·ªÉ t·∫°o c√¥ng ty!' : 'Failed to create company!');
      throw error;
    }
  };

  const handleEditCompany = async () => {
    if (!editingCompany) return;
    
    try {
      const payload = {
        ...editingCompany,
        system_expiry: editingCompany.system_expiry ? new Date(editingCompany.system_expiry).toISOString() : null
      };
      
      await axios.put(`${API}/companies/${editingCompany.id}`, payload);
      toast.success(language === 'vi' ? 'C√¥ng ty ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!' : 'Company updated successfully!');
      setShowEditCompany(false);
      setEditingCompany(null);
      fetchCompanies();
      
      return editingCompany;
    } catch (error) {
      toast.error(language === 'vi' ? 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t c√¥ng ty!' : 'Failed to update company!');
      throw error;
    }
  };

  const handleDeleteCompany = async (company) => {
    if (!window.confirm(language === 'vi' ? 
      `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c√¥ng ty "${company.name_vn}"?` : 
      `Are you sure you want to delete company "${company.name_en}"?`)) {
      return;
    }

    try {
      await axios.delete(`${API}/companies/${company.id}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      toast.success(language === 'vi' ? 'C√¥ng ty ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng!' : 'Company deleted successfully!');
      fetchCompanies();
    } catch (error) {
      console.error('Delete company error:', error);
      const errorMessage = error.response?.data?.detail || 
        (language === 'vi' ? 'Kh√¥ng th·ªÉ x√≥a c√¥ng ty!' : 'Failed to delete company!');
      toast.error(errorMessage);
    }
  };

  const openEditUser = (user) => {
    setEditingUser({
      ...user,
      password: '' // Don't populate password for security
    });
    setShowEditUser(true);
  };

  const handleEditUser = async () => {
    if (!editingUser) return;
    
    try {
      await axios.put(`${API}/users/${editingUser.id}`, editingUser);
      toast.success(language === 'vi' ? 'Ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!' : 'User updated successfully!');
      setShowEditUser(false);
      setEditingUser(null);
      fetchUsers();
    } catch (error) {
      toast.error(language === 'vi' ? 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ng∆∞·ªùi d√πng!' : 'Failed to update user!');
      console.error('User update error:', error);
    }
  };

  const handleAddUser = async () => {
    if (!newUserData.username || !newUserData.password || !newUserData.full_name || !newUserData.zalo) {
      toast.error(language === 'vi' ? 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc (T√™n ƒëƒÉng nh·∫≠p, M·∫≠t kh·∫©u, H·ªç t√™n, Zalo)!' : 'Please fill in all required fields (Username, Password, Full Name, Zalo)!');
      return;
    }
    
    try {
      await axios.post(`${API}/auth/register`, newUserData);
      toast.success(language === 'vi' ? 'Ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!' : 'User created successfully!');
      setShowAddUser(false);
      setNewUserData({
        username: '',
        email: '',
        password: '',
        full_name: '',
        role: 'viewer',
        department: 'technical',
        company: '',
        ship: '',
        zalo: '',
        gmail: ''
      });
      fetchUsers();
    } catch (error) {
      toast.error(language === 'vi' ? 'Kh√¥ng th·ªÉ t·∫°o ng∆∞·ªùi d√πng!' : 'Failed to create user!');
      console.error('User creation error:', error);
    }
  };

  const handleDeleteUser = async (user) => {
    if (!window.confirm(language === 'vi' ? 
      `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi d√πng "${user.full_name}"?` : 
      `Are you sure you want to delete user "${user.full_name}"?`)) {
      return;
    }

    try {
      await axios.delete(`${API}/users/${user.id}`);
      toast.success(language === 'vi' ? 'Ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng!' : 'User deleted successfully!');
      fetchUsers();
    } catch (error) {
      toast.error(language === 'vi' ? 'Kh√¥ng th·ªÉ x√≥a ng∆∞·ªùi d√πng!' : 'Failed to delete user!');
      console.error('User delete error:', error);
    }
  };

  const openEditCompany = (company) => {
    setEditingCompany({
      ...company,
      system_expiry: company.system_expiry ? new Date(company.system_expiry).toISOString().split('T')[0] : '',
      gdrive_config: company.gdrive_config || {
        service_account_email: '',
        project_id: '',
        private_key: '',
        client_email: '',
        client_id: '',
        folder_id: ''
      }
    });
    
    // Fetch company Google Drive configuration
    if (company.id) {
      fetchCompanyGoogleDriveConfig(company.id);
      fetchCompanyGoogleDriveStatus(company.id);
    }
    
    setShowEditCompany(true);
  };

  const isAdmin = user?.role === 'admin' || user?.role === 'super_admin';

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50">
      {/* Header */}
      <header className="bg-white shadow-lg border-b">
        <div className="w-full px-4 py-4">
          <div className="flex justify-between items-center">
            <h1 className="text-2xl font-bold text-gray-800">{language === 'vi' ? 'C√†i ƒë·∫∑t h·ªá th·ªëng' : 'System Settings'}</h1>
            <button
              onClick={() => navigate('/home')}
              className="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-all"
            >
              {t.back}
            </button>
          </div>
        </div>
      </header>

      <div className="w-full px-4 py-8">
        <div className="grid lg:grid-cols-3 gap-8">
          {/* User Management */}
          {(user?.role === 'manager' || user?.role === 'admin' || user?.role === 'super_admin') && (
            <div className="bg-white rounded-xl shadow-lg p-6 lg:col-span-full">
              <h3 className="text-lg font-semibold mb-6 text-gray-800">
                {language === 'vi' ? 'Qu·∫£n l√Ω ng∆∞·ªùi d√πng' : 'User Management'}
              </h3>
              
              {/* Action Buttons */}
              <div className="mb-6 flex space-x-4">
                <button
                  onClick={() => setShowAddUser(true)}
                  className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-all"
                >
                  {t.addUser}
                </button>
                <button
                  onClick={() => setShowUserList(!showUserList)}
                  className={`px-6 py-2 rounded-lg transition-all ${
                    showUserList 
                      ? 'bg-red-600 hover:bg-red-700 text-white' 
                      : 'bg-blue-600 hover:bg-blue-700 text-white'
                  }`}
                >
                  {showUserList 
                    ? (language === 'vi' ? '·∫®n danh s√°ch' : 'Hide List')
                    : (language === 'vi' ? 'Danh s√°ch ng∆∞·ªùi d√πng' : 'User List')
                  }
                </button>
              </div>
              
              {/* Filtering and Sorting Controls */}
              {showUserList && (
                <div className="mb-6 p-4 bg-gray-50 rounded-lg border">
                  <h4 className="font-medium mb-3 text-gray-800">
                    {language === 'vi' ? 'B·ªô l·ªçc v√† s·∫Øp x·∫øp' : 'Filter and Sort'}
                  </h4>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                    {/* Company Filter */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        {language === 'vi' ? 'C√¥ng ty' : 'Company'}
                      </label>
                      <select
                        value={userFilters.company}
                        onChange={(e) => {
                          const newFilters = { ...userFilters, company: e.target.value };
                          setUserFilters(newFilters);
                          fetchFilteredUsers(newFilters, userSorting);
                        }}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                      >
                        <option value="">{language === 'vi' ? 'T·∫•t c·∫£ c√¥ng ty' : 'All Companies'}</option>
                        {[...new Set(users.map(u => u.company).filter(Boolean))].map(company => (
                          <option key={company} value={company}>{company}</option>
                        ))}
                      </select>
                    </div>
                    
                    {/* Department Filter */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        {language === 'vi' ? 'Ph√≤ng ban' : 'Department'}
                      </label>
                      <select
                        value={userFilters.department}
                        onChange={(e) => {
                          const newFilters = { ...userFilters, department: e.target.value };
                          setUserFilters(newFilters);
                          fetchFilteredUsers(newFilters, userSorting);
                        }}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                      >
                        <option value="">{language === 'vi' ? 'T·∫•t c·∫£ ph√≤ng ban' : 'All Departments'}</option>
                        <option value="technical">{language === 'vi' ? 'K·ªπ thu·∫≠t' : 'Technical'}</option>
                        <option value="operations">{language === 'vi' ? 'V·∫≠n h√†nh' : 'Operations'}</option>
                        <option value="safety">{language === 'vi' ? 'An to√†n' : 'Safety'}</option>
                        <option value="commercial">{language === 'vi' ? 'Th∆∞∆°ng m·∫°i' : 'Commercial'}</option>
                        <option value="crewing">{language === 'vi' ? 'Thuy·ªÅn vi√™n' : 'Crewing'}</option>
                        <option value="ship_crew">{language === 'vi' ? 'Thuy·ªÅn vi√™n t√†u' : 'Ship Crew'}</option>
                      </select>
                    </div>
                    
                    {/* Ship Filter */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        {language === 'vi' ? 'T√†u' : 'Ship'}
                      </label>
                      <select
                        value={userFilters.ship}
                        onChange={(e) => {
                          const newFilters = { ...userFilters, ship: e.target.value };
                          setUserFilters(newFilters);
                          fetchFilteredUsers(newFilters, userSorting);
                        }}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                      >
                        <option value="">{language === 'vi' ? 'T·∫•t c·∫£ t√†u' : 'All Ships'}</option>
                        {[...new Set(users.map(u => u.ship).filter(Boolean))].map(ship => (
                          <option key={ship} value={ship}>{ship}</option>
                        ))}
                      </select>
                    </div>
                    
                    {/* Sort By */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        {language === 'vi' ? 'S·∫Øp x·∫øp theo' : 'Sort By'}
                      </label>
                      <select
                        value={userSorting.sortBy}
                        onChange={(e) => {
                          const newSorting = { ...userSorting, sortBy: e.target.value };
                          setUserSorting(newSorting);
                          fetchFilteredUsers(userFilters, newSorting);
                        }}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                      >
                        <option value="full_name">{language === 'vi' ? 'T√™n' : 'Name'}</option>
                        <option value="company">{language === 'vi' ? 'C√¥ng ty' : 'Company'}</option>
                        <option value="department">{language === 'vi' ? 'Ph√≤ng ban' : 'Department'}</option>
                        <option value="role">{language === 'vi' ? 'Vai tr√≤' : 'Role'}</option>
                        <option value="ship">{language === 'vi' ? 'T√†u' : 'Ship'}</option>
                        <option value="created_at">{language === 'vi' ? 'Ng√†y t·∫°o' : 'Created Date'}</option>
                      </select>
                    </div>
                    
                    {/* Sort Order */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        {language === 'vi' ? 'Th·ª© t·ª±' : 'Order'}
                      </label>
                      <select
                        value={userSorting.sortOrder}
                        onChange={(e) => {
                          const newSorting = { ...userSorting, sortOrder: e.target.value };
                          setUserSorting(newSorting);
                          fetchFilteredUsers(userFilters, newSorting);
                        }}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                      >
                        <option value="asc">{language === 'vi' ? 'TƒÉng d·∫ßn' : 'Ascending'}</option>
                        <option value="desc">{language === 'vi' ? 'Gi·∫£m d·∫ßn' : 'Descending'}</option>
                      </select>
                    </div>
                  </div>
                  
                  {/* Clear Filters Button */}
                  <div className="mt-3 flex justify-end">
                    <button
                      onClick={() => {
                        setUserFilters({ company: '', department: '', ship: '' });
                        setUserSorting({ sortBy: 'full_name', sortOrder: 'asc' });
                        fetchUsers();
                      }}
                      className="px-4 py-2 text-sm bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-all"
                    >
                      {language === 'vi' ? 'X√≥a b·ªô l·ªçc' : 'Clear Filters'}
                    </button>
                  </div>
                </div>
              )}
              
              {/* Users Table */}
              {showUserList && users.length > 0 ? (
                <div className="overflow-x-auto">
                  <table className="w-full border-collapse border border-gray-300 text-sm">
                    <thead>
                      <tr className="bg-gray-50">
                        <th className="border border-gray-300 px-4 py-3 text-left">
                          {language === 'vi' ? 'T√™n ng∆∞·ªùi d√πng' : 'User Name'}
                        </th>
                        <th className="border border-gray-300 px-4 py-3 text-left">
                          {language === 'vi' ? 'C√¥ng ty' : 'Company'}
                        </th>
                        <th className="border border-gray-300 px-4 py-3 text-left">
                          {language === 'vi' ? 'Ph√≤ng ban' : 'Department'}
                        </th>
                        <th className="border border-gray-300 px-4 py-3 text-left">
                          {language === 'vi' ? 'Vai tr√≤' : 'Role'}
                        </th>
                        <th className="border border-gray-300 px-4 py-3 text-left">
                          {language === 'vi' ? 'T√†u' : 'Ship'}
                        </th>
                        <th className="border border-gray-300 px-4 py-3 text-left">Zalo</th>
                        <th className="border border-gray-300 px-4 py-3 text-left">Gmail</th>
                        <th className="border border-gray-300 px-4 py-3 text-center">
                          {language === 'vi' ? 'Thao t√°c' : 'Actions'}
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      {filteredUsers.map((userItem) => (
                        <tr key={userItem.id} className="hover:bg-gray-50">
                          <td className="border border-gray-300 px-4 py-3 font-medium">
                            {userItem.full_name}
                            <div className="text-xs text-gray-500">{userItem.username}</div>
                          </td>
                          <td className="border border-gray-300 px-4 py-3">
                            {userItem.company || '-'}
                          </td>
                          <td className="border border-gray-300 px-4 py-3">
                            {userItem.department || '-'}
                          </td>
                          <td className="border border-gray-300 px-4 py-3">
                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                              userItem.role === 'super_admin' ? 'bg-red-100 text-red-800' :
                              userItem.role === 'admin' ? 'bg-orange-100 text-orange-800' :
                              userItem.role === 'manager' ? 'bg-blue-100 text-blue-800' :
                              userItem.role === 'editor' ? 'bg-green-100 text-green-800' :
                              'bg-gray-100 text-gray-800'
                            }`}>
                              {userItem.role === 'super_admin' ? (language === 'vi' ? 'Si√™u qu·∫£n tr·ªã' : 'Super Admin') :
                               userItem.role === 'admin' ? (language === 'vi' ? 'Qu·∫£n tr·ªã' : 'Admin') :
                               userItem.role === 'manager' ? (language === 'vi' ? 'C√°n b·ªô c√¥ng ty' : 'Company Officer') :
                               userItem.role === 'editor' ? (language === 'vi' ? 'Sƒ© quan' : 'Ship Officer') :
                               (language === 'vi' ? 'Thuy·ªÅn vi√™n' : 'Crew')}
                            </span>
                          </td>
                          <td className="border border-gray-300 px-4 py-3">
                            {userItem.ship || '-'}
                          </td>
                          <td className="border border-gray-300 px-4 py-3">
                            {userItem.zalo || '-'}
                          </td>
                          <td className="border border-gray-300 px-4 py-3">
                            {userItem.gmail || '-'}
                          </td>
                          <td className="border border-gray-300 px-4 py-3 text-center">
                            <div className="flex justify-center space-x-2">
                              <button
                                onClick={() => openEditUser(userItem)}
                                disabled={!canEditUser(userItem)}
                                className="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-3 py-1 rounded text-xs transition-all"
                                title={
                                  !canEditUser(userItem) 
                                    ? (language === 'vi' 
                                        ? 'Kh√¥ng c√≥ quy·ªÅn ch·ªânh s·ª≠a ng∆∞·ªùi d√πng n√†y' 
                                        : 'No permission to edit this user')
                                    : (language === 'vi' ? 'S·ª≠a' : 'Edit')
                                }
                              >
                                {language === 'vi' ? 'S·ª≠a' : 'Edit'}
                              </button>
                              <button
                                onClick={() => handleDeleteUser(userItem)}
                                disabled={!canDeleteUser(userItem)}
                                className="bg-red-500 hover:bg-red-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-3 py-1 rounded text-xs transition-all"
                                title={
                                  !canDeleteUser(userItem) 
                                    ? (language === 'vi' 
                                        ? 'Kh√¥ng c√≥ quy·ªÅn x√≥a ng∆∞·ªùi d√πng n√†y' 
                                        : 'No permission to delete this user')
                                    : (language === 'vi' ? 'X√≥a' : 'Delete')
                                }
                              >
                                {language === 'vi' ? 'X√≥a' : 'Delete'}
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              ) : (
                <div className="text-center py-8 text-gray-500">
                  <div className="text-4xl mb-4">üë•</div>
                  <p>{language === 'vi' ? 'Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o' : 'No users yet'}</p>
                  <p className="text-sm mt-2">
                    {language === 'vi' ? 'Nh·∫•n "Th√™m ng∆∞·ªùi d√πng" ƒë·ªÉ b·∫Øt ƒë·∫ßu' : 'Click "Add User" to get started'}
                  </p>
                </div>
              )}
            </div>
          )}

          {/* System Google Drive Configuration - Super Admin Only */}
          {user?.role === 'super_admin' && (
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h3 className="text-lg font-semibold mb-4 text-gray-800">
                {language === 'vi' ? 'C·∫•u h√¨nh Google Drive h·ªá th·ªëng' : 'System Google Drive Configuration'}
              </h3>
              
              {/* Google Drive Status */}
              <div className="mb-4 space-y-3">
                {/* Configuration Status */}
                <div className="p-4 rounded-lg bg-gray-50 border">
                  <div className="flex items-center justify-between mb-2">
                    <h4 className="font-medium text-gray-800">
                      {language === 'vi' ? 'Tr·∫°ng th√°i c·∫•u h√¨nh' : 'Configuration Status'}
                    </h4>
                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                      (gdriveStatus?.status === 'connected' || gdriveCurrentConfig?.configured) ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                    }`}>
                      {(gdriveStatus?.status === 'connected' || gdriveCurrentConfig?.configured) ? 
                        (language === 'vi' ? 'ƒê√£ c·∫•u h√¨nh' : 'Configured') : 
                        (language === 'vi' ? 'Ch∆∞a c·∫•u h√¨nh' : 'Not configured')}
                    </span>
                  </div>
                  
                  {gdriveCurrentConfig?.configured ? (
                    <div className="text-sm text-gray-600 space-y-1">
                      <div className="flex justify-between">
                        <span>{language === 'vi' ? 'Method:' : 'Auth Method:'}</span>
                        <span className="font-mono text-xs">
                          {gdriveCurrentConfig.auth_method === 'apps_script' 
                            ? 'Apps Script' 
                            : gdriveCurrentConfig.auth_method === 'oauth' 
                              ? 'OAuth 2.0' 
                              : 'Service Account'}
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span>
                          {gdriveCurrentConfig.auth_method === 'apps_script' 
                            ? (language === 'vi' ? 'Email Account:' : 'Account Email:')
                            : (language === 'vi' ? 'Service Account:' : 'Service Account:')}
                        </span>
                        <span className="font-mono text-xs">{gdriveCurrentConfig.service_account_email}</span>
                      </div>
                      <div className="flex justify-between">
                        <span>{language === 'vi' ? 'Folder ID:' : 'Folder ID:'}</span>
                        <span className="font-mono text-xs">{gdriveCurrentConfig.folder_id}</span>
                      </div>
                      {gdriveCurrentConfig.last_sync && (
                        <div className="flex justify-between">
                          <span>{language === 'vi' ? 'ƒê·ªìng b·ªô cu·ªëi:' : 'Last Sync:'}</span>
                          <span className="text-xs">{gdriveCurrentConfig.last_sync ? new Date(gdriveCurrentConfig.last_sync).toLocaleString() : 'Never'}</span>
                        </div>
                      )}
                    </div>
                  ) : (
                    <p className="text-sm text-gray-500">
                      {language === 'vi' ? 
                        'Ch∆∞a c√≥ c·∫•u h√¨nh Google Drive. Nh·∫•n "C·∫•u h√¨nh Google Drive" ƒë·ªÉ b·∫Øt ƒë·∫ßu.' : 
                        'No Google Drive configuration yet. Click "Configure Google Drive" to get started.'}
                    </p>
                  )}
                </div>

                {/* Sync Status */}
                {(gdriveStatus?.status === 'connected' || gdriveCurrentConfig?.configured) && (
                  <div className="p-4 rounded-lg bg-blue-50 border border-blue-200">
                    <h4 className="font-medium text-blue-800 mb-2">
                      {language === 'vi' ? 'Tr·∫°ng th√°i ƒë·ªìng b·ªô' : 'Sync Status'}
                    </h4>
                    <div className="grid grid-cols-2 gap-4 text-sm">
                      <div className="text-center">
                        <div className="text-2xl font-bold text-blue-600">{gdriveStatus?.local_files || 0}</div>
                        <div className="text-gray-600">{language === 'vi' ? 'Files local' : 'Local files'}</div>
                      </div>
                      <div className="text-center">
                        <div className="text-2xl font-bold text-green-600">{gdriveStatus?.drive_files || 0}</div>
                        <div className="text-gray-600">{language === 'vi' ? 'Files Drive' : 'Drive files'}</div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
              
              <div className="space-y-3">
                <button
                  onClick={() => setShowGoogleDrive(true)}
                  className="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition-all"
                >
                  {language === 'vi' ? 'C·∫•u h√¨nh Google Drive h·ªá th·ªëng' : 'Configure System Google Drive'}
                </button>
                
                {(gdriveStatus?.status === 'connected' || gdriveCurrentConfig?.configured) && (
                  <>
                    <button
                      onClick={handleSyncToGoogleDrive}
                      disabled={syncLoading}
                      className="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white py-2 rounded-lg transition-all"
                    >
                      {syncLoading ? '‚è≥' : '‚òÅÔ∏è‚Üë'} {language === 'vi' ? 'ƒê·ªìng b·ªô l√™n Drive' : 'Sync to Drive'}
                    </button>
                    
                    <button
                      onClick={handleSyncFromGoogleDrive}
                      disabled={syncLoading}
                      className="w-full bg-orange-600 hover:bg-orange-700 disabled:bg-gray-400 text-white py-2 rounded-lg transition-all"
                    >
                      {syncLoading ? '‚è≥' : '‚òÅÔ∏è‚Üì'} {language === 'vi' ? 'ƒê·ªìng b·ªô t·ª´ Drive' : 'Sync from Drive'}
                    </button>
                  </>
                )}
              </div>
            </div>
          )}

          {/* AI Provider Configuration - Super Admin Only */}
          {(user?.role === 'super_admin' || user?.role === 'admin') && (
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h3 className="text-lg font-semibold mb-4 text-gray-800">
                {language === 'vi' ? 'C·∫•u h√¨nh AI' : 'AI Configuration'}
              </h3>
              
              {/* Current AI Config Status */}
              <div className="mb-4 p-3 rounded-lg bg-gray-50">
                <div className="text-sm space-y-1">
                  <div className="font-medium text-blue-600">
                    {language === 'vi' ? 'Nh√† cung c·∫•p hi·ªán t·∫°i:' : 'Current Provider:'} {aiConfig.provider.toUpperCase()}
                  </div>
                  <div className="text-gray-600">
                    {language === 'vi' ? 'M√¥ h√¨nh:' : 'Model:'} {aiConfig.model}
                  </div>
                </div>
              </div>
              
              <div className="space-y-3">
                <button
                  onClick={() => setShowAIConfig(true)}
                  className="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg transition-all"
                >
                  {language === 'vi' ? 'C·∫•u h√¨nh AI' : 'Configure AI'}
                </button>
              </div>
            </div>
          )}

          {/* Admin Tools - Admin & Super Admin Only */}
          {(user?.role === 'admin' || user?.role === 'super_admin') && (
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h3 className="text-lg font-semibold mb-4 text-gray-800">
                üõ†Ô∏è {language === 'vi' ? 'C√¥ng c·ª• Admin' : 'Admin Tools'}
              </h3>
              
              {/* Certificate Backfill Processing */}
              <div className="mb-6">
                <h4 className="font-medium mb-3 text-gray-700">
                  {language === 'vi' ? 'C·∫≠p nh·∫≠t th√¥ng tin Certificate c≈©' : 'Legacy Certificate Information Update'}
                </h4>
                
                {/* Current Progress */}
                {backfillProgress && (
                  <div className={`mb-4 p-3 rounded-lg ${
                    backfillProgress.status === 'completed' ? 'bg-green-50 border-green-200' :
                    backfillProgress.status === 'error' ? 'bg-red-50 border-red-200' :
                    'bg-blue-50 border-blue-200'
                  } border`}>
                    <div className="flex items-center justify-between mb-2">
                      <span className={`font-medium ${
                        backfillProgress.status === 'completed' ? 'text-green-700' :
                        backfillProgress.status === 'error' ? 'text-red-700' :
                        'text-blue-700'
                      }`}>
                        {backfillProgress.status === 'starting' ? '‚è≥' :
                         backfillProgress.status === 'completed' ? '‚úÖ' :
                         backfillProgress.status === 'error' ? '‚ùå' : 'üîÑ'}
                        {' '}
                        {backfillProgress.status === 'starting' ? (language === 'vi' ? 'ƒêang x·ª≠ l√Ω...' : 'Processing...') :
                         backfillProgress.status === 'completed' ? (language === 'vi' ? 'Ho√†n th√†nh' : 'Completed') :
                         backfillProgress.status === 'error' ? (language === 'vi' ? 'L·ªói' : 'Error') :
                         (language === 'vi' ? 'ƒêang x·ª≠ l√Ω' : 'Processing')}
                      </span>
                      <span className="text-sm text-gray-600">
                        {backfillProgress.processed || 0} {language === 'vi' ? 'ƒë√£ x·ª≠ l√Ω' : 'processed'}
                      </span>
                    </div>
                    
                    <div className="text-sm mb-2">
                      <div className="flex justify-between">
                        <span>{language === 'vi' ? 'C·∫≠p nh·∫≠t:' : 'Updated:'}</span>
                        <span className="font-medium text-green-600">{backfillProgress.updated || 0}</span>
                      </div>
                      {backfillProgress.errors > 0 && (
                        <div className="flex justify-between">
                          <span>{language === 'vi' ? 'L·ªói:' : 'Errors:'}</span>
                          <span className="font-medium text-red-600">{backfillProgress.errors}</span>
                        </div>
                      )}
                      {backfillProgress.remaining > 0 && (
                        <div className="flex justify-between">
                          <span>{language === 'vi' ? 'C√≤n l·∫°i:' : 'Remaining:'}</span>
                          <span className="font-medium text-orange-600">{backfillProgress.remaining}</span>
                        </div>
                      )}
                    </div>
                    
                    <p className="text-xs text-gray-600 mt-2">
                      {backfillProgress.message}
                    </p>
                  </div>
                )}
                
                {/* Backfill History */}
                {backfillHistory.length > 0 && (
                  <div className="mb-4 p-3 rounded-lg bg-gray-50 border">
                    <h5 className="font-medium text-gray-700 mb-2">
                      {language === 'vi' ? 'L·ªãch s·ª≠ x·ª≠ l√Ω g·∫ßn ƒë√¢y' : 'Recent Processing History'}
                    </h5>
                    <div className="space-y-2">
                      {backfillHistory.slice(0, 3).map((item, index) => (
                        <div key={index} className="flex justify-between text-xs">
                          <span className="text-gray-600">
                            {new Date(item.timestamp).toLocaleDateString()} {new Date(item.timestamp).toLocaleTimeString()}
                          </span>
                          <span className="font-medium">
                            {item.updated}/{item.processed} {language === 'vi' ? 'th√†nh c√¥ng' : 'success'}
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
                
                <div className="space-y-2">
                  <button
                    onClick={handleBackfillProcessing}
                    disabled={backfillProcessing}
                    className="w-full bg-orange-600 hover:bg-orange-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white py-2 rounded-lg transition-all font-medium"
                  >
                    {backfillProcessing ? '‚è≥' : 'üîÑ'} 
                    {' '}
                    {backfillProcessing 
                      ? (language === 'vi' ? 'ƒêang x·ª≠ l√Ω...' : 'Processing...')
                      : (language === 'vi' ? 'Ch·∫°y Backfill Processing' : 'Run Backfill Processing')
                    }
                  </button>
                  
                  <p className="text-xs text-gray-600">
                    {language === 'vi' 
                      ? 'C·∫≠p nh·∫≠t th√¥ng tin t√†u (extracted_ship_name, flag, class_society, v.v.) cho c√°c certificates c≈© thi·∫øu d·ªØ li·ªáu. X·ª≠ l√Ω 20 certificates m·ªói l·∫ßn.'
                      : 'Updates ship information (extracted_ship_name, flag, class_society, etc.) for legacy certificates missing data. Processes 20 certificates at a time.'
                    }
                  </p>
                </div>
              </div>
              
              {/* Future Admin Tools */}
              <div className="pt-4 border-t border-gray-200">
                <p className="text-sm text-gray-500 italic">
                  {language === 'vi' 
                    ? 'C√°c c√¥ng c·ª• admin kh√°c s·∫Ω ƒë∆∞·ª£c th√™m trong t∆∞∆°ng lai...'
                    : 'Additional admin tools will be added in the future...'
                  }
                </p>
              </div>
            </div>
          )}

          {/* Usage Tracking - Admin+ Only */}
          {(user?.role === 'admin' || user?.role === 'super_admin') && (
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h3 className="text-lg font-semibold mb-4 text-gray-800">
                {language === 'vi' ? 'Theo d√µi s·ª≠ d·ª•ng AI' : 'AI Usage Tracking'}
              </h3>
              
              {/* Usage Statistics */}
              {usageStats && (
                <div className="space-y-4">
                  {/* Summary Cards */}
                  <div className="grid grid-cols-2 gap-3">
                    <div className="bg-blue-50 p-3 rounded-lg">
                      <div className="text-sm text-blue-600 font-medium">
                        {language === 'vi' ? 'T·ªïng y√™u c·∫ßu' : 'Total Requests'}
                      </div>
                      <div className="text-lg font-bold text-blue-800">
                        {usageStats.total_requests ? usageStats.total_requests.toLocaleString() : '0'}
                      </div>
                    </div>
                    <div className="bg-green-50 p-3 rounded-lg">
                      <div className="text-sm text-green-600 font-medium">
                        {language === 'vi' ? 'Chi ph√≠ ∆∞·ªõc t√≠nh' : 'Estimated Cost'}
                      </div>
                      <div className="text-lg font-bold text-green-800">
                        ${usageStats.total_estimated_cost ? usageStats.total_estimated_cost.toFixed(4) : '0.0000'}
                      </div>
                    </div>
                  </div>

                  {/* Token Usage */}
                  <div className="bg-gray-50 p-3 rounded-lg">
                    <div className="text-sm text-gray-600 mb-2">
                      {language === 'vi' ? 'S·ª≠ d·ª•ng token (30 ng√†y):' : 'Token Usage (30 days):'}
                    </div>
                    <div className="text-xs space-y-1">
                      <div>
                        <span className="font-medium">Input:</span> {usageStats.total_input_tokens ? usageStats.total_input_tokens.toLocaleString() : '0'} tokens
                      </div>
                      <div>
                        <span className="font-medium">Output:</span> {usageStats.total_output_tokens ? usageStats.total_output_tokens.toLocaleString() : '0'} tokens
                      </div>
                    </div>
                  </div>

                  {/* Provider Distribution */}
                  {usageStats.requests_by_provider && Object.keys(usageStats.requests_by_provider).length > 0 && (
                    <div className="bg-gray-50 p-3 rounded-lg">
                      <div className="text-sm text-gray-600 mb-2">
                        {language === 'vi' ? 'Ph√¢n b·ªë nh√† cung c·∫•p:' : 'Provider Distribution:'}
                      </div>
                      <div className="space-y-1">
                        {Object.entries(usageStats.requests_by_provider || {}).map(([provider, count]) => (
                          <div key={provider} className="flex justify-between text-xs">
                            <span className="capitalize">{provider}</span>
                            <span className="font-medium">{count}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              )}
              
              <div className="mt-4 space-y-2">
                <button
                  onClick={() => {
                    setUsageLoading(true);
                    fetchUsageStats().finally(() => setUsageLoading(false));
                  }}
                  disabled={usageLoading}
                  className="w-full bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 text-white py-2 rounded-lg transition-all text-sm"
                >
                  {usageLoading ? '‚è≥' : 'üîÑ'} {language === 'vi' ? 'L√†m m·ªõi th·ªëng k√™' : 'Refresh Stats'}
                </button>
              </div>
            </div>
          )}

          {/* Company Management - Admin+ Only */}
          {(user?.role === 'admin' || user?.role === 'super_admin') && (
            <div className="bg-white rounded-xl shadow-lg p-6 lg:col-span-full">
              <h3 className="text-lg font-semibold mb-6 text-gray-800">
                {language === 'vi' ? 'Qu·∫£n l√Ω c√¥ng ty' : 'Company Management'}
              </h3>
              
              {/* Action Buttons - Only Super Admin can add new companies */}
              {user?.role === 'super_admin' && (
                <div className="mb-6">
                  <button
                    onClick={() => setShowCompanyForm(true)}
                    className="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-lg transition-all"
                  >
                    {language === 'vi' ? 'Th√™m c√¥ng ty m·ªõi' : 'Add New Company'}
                  </button>
                </div>
              )}
              
              {/* Companies Table */}
              {companies.length > 0 ? (
                <div className="overflow-x-auto">
                  <table className="w-full border-collapse border border-gray-300 text-sm">
                    <thead>
                      <tr className="bg-gray-50">
                        <th className="border border-gray-300 px-4 py-3 text-left">
                          {language === 'vi' ? 'Logo' : 'Logo'}
                        </th>
                        <th className="border border-gray-300 px-4 py-3 text-left">
                          {language === 'vi' ? 'T√™n c√¥ng ty (VN)' : 'Company Name (VN)'}
                        </th>
                        <th className="border border-gray-300 px-4 py-3 text-left">
                          {language === 'vi' ? 'T√™n c√¥ng ty (EN)' : 'Company Name (EN)'}
                        </th>
                        <th className="border border-gray-300 px-4 py-3 text-left">Zalo</th>
                        <th className="border border-gray-300 px-4 py-3 text-left">
                          {language === 'vi' ? 'H·∫øt h·∫°n' : 'Expiry'}
                        </th>
                        <th className="border border-gray-300 px-4 py-3 text-center">
                          {language === 'vi' ? 'Thao t√°c' : 'Actions'}
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      {companies.map((company) => (
                        <tr key={company.id} className="hover:bg-gray-50">
                          <td className="border border-gray-300 px-4 py-3 text-center">
                            {company.logo_url ? (
                              <img 
                                src={`${API}${company.logo_url}`} 
                                alt={company.name_en} 
                                className="w-12 h-12 object-contain mx-auto rounded"
                                onError={(e) => {
                                  e.target.style.display = 'none';
                                  e.target.nextSibling.style.display = 'flex';
                                }}
                              />
                            ) : null}
                            <div 
                              className={`w-12 h-12 bg-gray-200 rounded flex items-center justify-center mx-auto text-gray-500 text-xs ${company.logo_url ? 'hidden' : 'flex'}`}
                            >
                              {language === 'vi' ? 'Ch∆∞a c√≥' : 'No Logo'}
                            </div>
                          </td>
                          <td className="border border-gray-300 px-4 py-3 font-medium">
                            {company.name_vn}
                          </td>
                          <td className="border border-gray-300 px-4 py-3">
                            {company.name_en}
                          </td>
                          <td className="border border-gray-300 px-4 py-3">
                            {company.zalo || '-'}
                          </td>
                          <td className="border border-gray-300 px-4 py-3">
                            {company.system_expiry ? 
                              new Date(company.system_expiry).toLocaleDateString() : 
                              (language === 'vi' ? 'Kh√¥ng gi·ªõi h·∫°n' : 'Unlimited')
                            }
                          </td>
                          <td className="border border-gray-300 px-4 py-3 text-center">
                            <div className="flex justify-center space-x-2">
                              <button
                                onClick={() => openEditCompany(company)}
                                disabled={!canEditCompany(company)}
                                className="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-3 py-1 rounded text-xs transition-all"
                                title={
                                  !canEditCompany(company) 
                                    ? (language === 'vi' 
                                        ? 'Ch·ªâ c√≥ th·ªÉ s·ª≠a c√¥ng ty c·ªßa b·∫°n' 
                                        : 'You can only edit your own company')
                                    : (language === 'vi' ? 'S·ª≠a' : 'Edit')
                                }
                              >
                                {language === 'vi' ? 'S·ª≠a' : 'Edit'}
                              </button>
                              {user?.role === 'super_admin' && (
                                <button
                                  onClick={() => handleDeleteCompany(company)}
                                  disabled={!canDeleteCompany(company)}
                                  className="bg-red-500 hover:bg-red-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-3 py-1 rounded text-xs transition-all"
                                  title={
                                    !canDeleteCompany(company) 
                                      ? (language === 'vi' 
                                          ? 'Ch·ªâ Super Admin m·ªõi c√≥ th·ªÉ x√≥a c√¥ng ty' 
                                          : 'Only Super Admin can delete companies')
                                      : (language === 'vi' ? 'X√≥a' : 'Delete')
                                  }
                                >
                                  {language === 'vi' ? 'X√≥a' : 'Delete'}
                                </button>
                              )}
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              ) : (
                <div className="text-center py-8 text-gray-500">
                  <div className="text-4xl mb-4">üè¢</div>
                  <p>{language === 'vi' ? 'Ch∆∞a c√≥ c√¥ng ty n√†o' : 'No companies yet'}</p>
                  <p className="text-sm mt-2">
                    {language === 'vi' ? 'Nh·∫•n "Th√™m c√¥ng ty m·ªõi" ƒë·ªÉ b·∫Øt ƒë·∫ßu' : 'Click "Add New Company" to get started'}
                  </p>
                </div>
              )}
            </div>
          )}

        </div>

        {/* Google Drive Configuration Modal */}
        {showGoogleDrive && (
          <GoogleDriveModal
            config={systemGdriveConfig}
            setConfig={setSystemGdriveConfig}
            currentConfig={gdriveCurrentConfig}
            onClose={() => setShowGoogleDrive(false)}
            onSave={handleGoogleDriveConfig}
            onTest={handleTestGoogleDriveConnection}
            testLoading={testLoading}
            language={language}
          />
        )}

        {/* Company Google Drive Configuration Modal */}
        {showCompanyGoogleDrive && editingCompany && (
          <CompanyGoogleDriveModal
            companyId={editingCompany.id}
            config={companyGdriveConfig}
            setConfig={setCompanyGdriveConfig}
            currentConfig={companyGdriveCurrentConfig}
            onClose={() => {
              console.log('üîç Debug - Closing Company Google Drive modal');
              setShowCompanyGoogleDrive(false);
            }}
            onSave={() => {
              console.log('üîç Debug - Company Google Drive Save clicked');
              console.log('   editingCompany.id:', editingCompany.id);
              
              if (editingCompany.id) {
                handleCompanyGoogleDriveConfig(editingCompany.id);
              } else {
                toast.error(language === 'vi' ? 'L·ªói: Kh√¥ng c√≥ Company ID ƒë·ªÉ l∆∞u' : 'Error: No Company ID to save');
              }
            }}
            onTest={() => {
              console.log('üîç Debug - Company Google Drive Test clicked (onTest prop)');
              console.log('   editingCompany.id:', editingCompany.id);
              
              if (editingCompany.id) {
                handleTestCompanyGoogleDriveConnection(editingCompany.id);
              } else {
                toast.error(language === 'vi' ? 'L·ªói: Kh√¥ng c√≥ Company ID ƒë·ªÉ test' : 'Error: No Company ID to test');
              }
            }}
            testLoading={companyGdriveTestLoading}
            language={language}
          />
        )}

        {/* AI Configuration Modal */}
        {showAIConfig && (
          <AIConfigModal
            config={aiConfig}
            setConfig={setAiConfig}
            onClose={() => setShowAIConfig(false)}
            onSave={handleAIConfigUpdate}
            language={language}
            token={token}
          />
        )}

        {/* Company Form Modal */}
        {showCompanyForm && (
          <CompanyFormModal
            companyData={companyData}
            setCompanyData={setCompanyData}
            onClose={() => setShowCompanyForm(false)}
            onSubmit={handleCreateCompany}
            language={language}
            isEdit={false}
            companyGdriveCurrentConfig={companyGdriveCurrentConfig}
            fetchCompanyGoogleDriveConfig={fetchCompanyGoogleDriveConfig}
            fetchCompanyGoogleDriveStatus={fetchCompanyGoogleDriveStatus}
            setShowCompanyGoogleDrive={setShowCompanyGoogleDrive}
          />
        )}

        {/* Edit Company Modal */}
        {showEditCompany && editingCompany && (
          <CompanyFormModal
            companyData={editingCompany}
            setCompanyData={setEditingCompany}
            onClose={() => {
              setShowEditCompany(false);
              setEditingCompany(null);
            }}
            onSubmit={handleEditCompany}
            language={language}
            isEdit={true}
            companyGdriveCurrentConfig={companyGdriveCurrentConfig}
            fetchCompanyGoogleDriveConfig={fetchCompanyGoogleDriveConfig}
            fetchCompanyGoogleDriveStatus={fetchCompanyGoogleDriveStatus}
            setShowCompanyGoogleDrive={setShowCompanyGoogleDrive}
          />
        )}

        {/* Add User Modal */}
        {showAddUser && (
          <AddUserModal
            userData={newUserData}
            setUserData={setNewUserData}
            onClose={() => {
              setShowAddUser(false);
              setNewUserData({
                username: '',
                email: '',
                password: '',
                full_name: '',
                role: 'viewer',
                department: 'technical',
                company: '',
                ship: '',
                zalo: '',
                gmail: ''
              });
            }}
            onSubmit={handleAddUser}
            language={language}
            companies={companies}
            ships={ships}
          />
        )}

        {/* Edit User Modal */}
        {showEditUser && editingUser && (
          <EditUserModal
            userData={editingUser}
            setUserData={setEditingUser}
            onClose={() => {
              setShowEditUser(false);
              setEditingUser(null);
            }}
            onSubmit={handleEditUser}
            language={language}
            companies={companies}
            ships={ships}
          />
        )}
        
        {/* PDF Analysis Modal */}
        {showPdfAnalysis && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md">
              <div className="flex justify-between items-center p-6 border-b border-gray-200">
                <h3 className="text-xl font-bold text-gray-800">
                  {language === 'vi' ? 'Ph√¢n t√≠ch Gi·∫•y ch·ª©ng nh·∫≠n' : 'Certificate Analysis'}
                </h3>
                <button
                  onClick={() => {
                    setShowPdfAnalysis(false);
                    setPdfFile(null);
                  }}
                  className="text-gray-400 hover:text-gray-600 text-2xl font-bold leading-none"
                >
                  √ó
                </button>
              </div>
              
              <div className="p-6">
                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    {language === 'vi' ? 'Ch·ªçn file PDF (t·ªëi ƒëa 5MB)' : 'Select PDF file (max 5MB)'}
                  </label>
                  <input
                    type="file"
                    accept=".pdf"
                    onChange={(e) => {
                      const file = e.target.files[0];
                      if (file && file.size > 5 * 1024 * 1024) {
                        toast.error(language === 'vi' ? 'File qu√° l·ªõn! T·ªëi ƒëa 5MB' : 'File too large! Max 5MB');
                        return;
                      }
                      setPdfFile(file);
                    }}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
                
                {pdfFile && (
                  <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <p className="text-sm text-blue-800">
                      üìÑ {pdfFile.name} ({(pdfFile.size / 1024 / 1024).toFixed(2)}MB)
                    </p>
                  </div>
                )}
                
                <div className="flex gap-3">
                  <button
                    onClick={() => {
                      setShowPdfAnalysis(false);
                      setPdfFile(null);
                    }}
                    className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all"
                    disabled={pdfAnalyzing}
                  >
                    {language === 'vi' ? 'H·ªßy' : 'Cancel'}
                  </button>
                  <button
                    onClick={handlePdfAnalysis}
                    disabled={pdfAnalyzing || !pdfFile}
                    className="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg transition-all flex items-center justify-center"
                  >
                    {pdfAnalyzing ? (
                      <>
                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                        {language === 'vi' ? 'ƒêang ph√¢n t√≠ch...' : 'Analyzing...'}
                      </>
                    ) : (
                      language === 'vi' ? 'Ph√¢n t√≠ch PDF' : 'Analyze PDF'
                    )}
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

      {/* Duplicate Certificate Modal */}
      {duplicateModal.show && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-2xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div className="mb-6">
              <h3 className="text-xl font-bold text-red-600 mb-2">
                ‚ö†Ô∏è {language === 'vi' ? 'Ph√°t hi·ªán gi·∫•y ch·ª©ng nh·∫≠n tr√πng l·∫∑p' : 'Duplicate Certificate Detected'}
              </h3>
              <p className="text-gray-600">
                {language === 'vi' 
                  ? `File "${duplicateModal.currentFile}" c√≥ d·ªØ li·ªáu ho√†n to√†n tr√πng l·∫∑p v·ªõi gi·∫•y ch·ª©ng nh·∫≠n ƒë√£ c√≥:`
                  : `File "${duplicateModal.currentFile}" has identical data with existing certificate:`}
              </p>
            </div>

            {/* Show duplicate certificates */}
            <div className="mb-6 max-h-60 overflow-y-auto">
              {duplicateModal.duplicates.map((duplicate, index) => (
                <div key={index} className="border rounded-lg p-4 mb-3 bg-yellow-50">
                  <div className="flex justify-between items-start mb-2">
                    <h4 className="font-semibold text-gray-800">
                      {duplicate.certificate.cert_name}
                    </h4>
                    <span className="text-sm font-medium text-red-600">
                      {duplicate.similarity.toFixed(1)}% {language === 'vi' ? 'tr√πng l·∫∑p' : 'similar'}
                    </span>
                  </div>
                  <div className="grid grid-cols-2 gap-2 text-sm text-gray-600">
                    <div><strong>{language === 'vi' ? 'S·ªë' : 'No'}:</strong> {duplicate.certificate.cert_no}</div>
                    <div><strong>{language === 'vi' ? 'Lo·∫°i' : 'Type'}:</strong> {duplicate.certificate.cert_type}</div>
                    <div><strong>{language === 'vi' ? 'Ng√†y c·∫•p' : 'Issue'}:</strong> {formatDate(duplicate.certificate.issue_date)}</div>
                    <div><strong>{language === 'vi' ? 'H·∫øt h·∫°n' : 'Valid'}:</strong> {formatDate(duplicate.certificate.valid_date)}</div>
                  </div>
                </div>
              ))}
            </div>

            <div className="flex gap-4">
              <button
                onClick={() => handleLocalDuplicateResolution('overwrite')}
                className="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg transition-colors font-medium"
              >
                {language === 'vi' 
                  ? 'üîÑ Ghi ƒë√® l√™n d·ªØ li·ªáu ƒëang c√≥' 
                  : 'üîÑ Overwrite existing data'}
              </button>
              
              <button
                onClick={() => handleLocalDuplicateResolution('cancel')}
                className="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg transition-colors font-medium"
              >
                {language === 'vi' 
                  ? '‚ùå H·ªßy b·ªè vi·ªác th√™m gi·∫•y ch·ª©ng nh·∫≠n' 
                  : '‚ùå Cancel certificate upload'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Ship Name Mismatch Modal */}
      {mismatchModal.show && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-2xl p-6 max-w-2xl w-full mx-4">
            <div className="mb-6">
              <h3 className="text-xl font-bold text-orange-600 mb-2">
                ‚ö†Ô∏è {language === 'vi' ? 'T√™n t√†u kh√¥ng kh·ªõp' : 'Ship Name Mismatch'}
              </h3>
              <p className="text-gray-600">
                {language === 'vi' 
                  ? 'AI ph√°t hi·ªán t√™n t√†u trong gi·∫•y ch·ª©ng nh·∫≠n kh√°c v·ªõi t√†u ƒëang ƒë∆∞·ª£c ch·ªçn:'
                  : 'AI detected ship name in the certificate differs from currently selected ship:'}
              </p>
            </div>

            <div className="bg-blue-50 rounded-lg p-4 mb-6">
              <div className="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <strong className="text-blue-700">{language === 'vi' ? 'T√†u ƒëang ch·ªçn:' : 'Current Ship:'}</strong>
                  <p className="text-gray-700 font-medium mt-1">{mismatchModal.mismatchInfo?.current_ship_name}</p>
                </div>
                <div>
                  <strong className="text-orange-700">{language === 'vi' ? 'T√†u t·ª´ AI:' : 'AI Detected Ship:'}</strong>
                  <p className="text-gray-700 font-medium mt-1">{mismatchModal.mismatchInfo?.ai_ship_name}</p>
                </div>
              </div>
            </div>

            <div className="space-y-3">
              <button
                onClick={() => handleMismatchResolution('use_ai_ship')}
                className="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg transition-colors font-medium text-left"
                disabled={!mismatchModal.mismatchInfo?.ai_ship_exists}
              >
                <div className="flex items-center justify-between">
                  <span>
                    {language === 'vi' 
                      ? `üö¢ L∆∞u v√†o database c·ªßa t√†u "${mismatchModal.mismatchInfo?.ai_ship_name}"` 
                      : `üö¢ Save to "${mismatchModal.mismatchInfo?.ai_ship_name}" database`}
                  </span>
                  {!mismatchModal.mismatchInfo?.ai_ship_exists && (
                    <span className="text-xs bg-red-500 px-2 py-1 rounded">
                      {language === 'vi' ? 'T√†u kh√¥ng t·ªìn t·∫°i' : 'Ship not found'}
                    </span>
                  )}
                </div>
              </button>
              
              <button
                onClick={() => handleMismatchResolution('use_current_ship')}
                className="w-full bg-orange-600 hover:bg-orange-700 text-white px-4 py-3 rounded-lg transition-colors font-medium text-left"
              >
                {language === 'vi' 
                  ? `üìã L∆∞u v√†o t√†u "${mismatchModal.mismatchInfo?.current_ship_name}" k√®m ghi ch√∫ tham kh·∫£o` 
                  : `üìã Save to "${mismatchModal.mismatchInfo?.current_ship_name}" with reference note`}
              </button>
            </div>
            
            <div className="mt-4 text-center">
              <p className="text-xs text-gray-500">
                {language === 'vi' 
                  ? 'Ch·ªçn t√πy ch·ªçn th·ª© 2 s·∫Ω th√™m ghi ch√∫: "Gi·∫•y ch·ª©ng nh·∫≠n n√†y ƒë·ªÉ tham kh·∫£o, kh√¥ng ph·∫£i c·ªßa t√†u n√†y"'
                  : 'Option 2 will add note: "This certificate is for reference, not belonging to this ship"'}
              </p>
            </div>
          </div>
        </div>
      )}

      {/* Duplicate resolution is handled at main component level */}
      </div>
    </div>
  );
};

// Google Drive Configuration Modal Component
const GoogleDriveModal = ({ config, setConfig, currentConfig, onClose, onSave, onTest, testLoading, language }) => {
  const [authMethod, setAuthMethod] = useState('apps_script'); // Force apps_script as default
  const [oauthLoading, setOauthLoading] = useState(false);
  
  const handleOverlayClick = (e) => {
    if (e.target === e.currentTarget) {
      onClose();
    }
  };

  const handleAuthMethodChange = (method) => {
    setAuthMethod(method);
    setConfig(prev => ({ ...prev, auth_method: method }));
  };

  const handleAppsScriptTest = async () => {
    try {
      setOauthLoading(true);
      
      const response = await axios.post(`${API}/gdrive/configure-proxy`, {
        web_app_url: config.web_app_url,
        folder_id: config.folder_id
      });
      
      if (response.data.success) {
        toast.success(language === 'vi' ? 'Apps Script proxy ho·∫°t ƒë·ªông!' : 'Apps Script proxy working!');
      } else {
        toast.error(language === 'vi' ? 'Apps Script proxy l·ªói' : 'Apps Script proxy error');
      }
    } catch (error) {
      console.error('Apps Script test error:', error);
      toast.error(language === 'vi' ? 'L·ªói test Apps Script' : 'Apps Script test error');
    } finally {
      setOauthLoading(false);
    }
  };

  const handleOAuthAuthorize = async () => {
    try {
      setOauthLoading(true);
      
      const oauthConfig = {
        client_id: config.client_id,
        client_secret: config.client_secret,
        redirect_uri: 'https://maritime-docai.preview.emergentagent.com/oauth2callback',
        folder_id: config.folder_id
      };

      const response = await axios.post(`${API}/gdrive/oauth/authorize`, oauthConfig);
      
      if (response.data.success && response.data.authorization_url) {
        // Store state for later use
        sessionStorage.setItem('oauth_state', response.data.state);
        
        // Redirect to Google OAuth
        window.location.href = response.data.authorization_url;
      } else {
        toast.error(language === 'vi' ? 'Kh√¥ng th·ªÉ t·∫°o URL x√°c th·ª±c' : 'Failed to generate authorization URL');
      }
    } catch (error) {
      console.error('OAuth authorization error:', error);
      toast.error(language === 'vi' ? 'L·ªói x√°c th·ª±c OAuth' : 'OAuth authorization error');
    } finally {
      setOauthLoading(false);
    }
  };

  return (
    <div 
      className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[99999]" 
      onClick={handleOverlayClick}
    >
      <div className="bg-white rounded-xl shadow-2xl p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto mx-4">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-2xl font-bold text-gray-800">
            {language === 'vi' ? 'C·∫•u h√¨nh Google Drive h·ªá th·ªëng' : 'System Google Drive Configuration'}
          </h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600 text-2xl leading-none"
          >
            √ó
          </button>
        </div>

        {/* Current Configuration Display */}
        {currentConfig?.configured && (
          <div className="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
            <h4 className="font-medium text-green-800 mb-2">
              {language === 'vi' ? 'C·∫•u h√¨nh hi·ªán t·∫°i:' : 'Current Configuration:'}
            </h4>
            <div className="text-sm text-green-700 space-y-1">
              <div><strong>{language === 'vi' ? 'Method:' : 'Auth Method:'}</strong> {
                currentConfig.auth_method === 'apps_script' 
                  ? 'Apps Script' 
                  : currentConfig.auth_method === 'oauth' 
                    ? 'OAuth 2.0' 
                    : 'Service Account'
              }</div>
              <div><strong>{language === 'vi' ? 'Folder ID:' : 'Folder ID:'}</strong> {currentConfig.folder_id}</div>
              {currentConfig.last_sync && (
                <div><strong>{language === 'vi' ? 'ƒê·ªìng b·ªô cu·ªëi:' : 'Last Sync:'}</strong> {currentConfig.last_sync ? new Date(currentConfig.last_sync).toLocaleString() : 'Never'}</div>
              )}
            </div>
          </div>
        )}

        {/* Authentication Method Selector */}
        <div className="mb-6">
          <h4 className="font-medium text-gray-800 mb-3">
            {language === 'vi' ? 'Ph∆∞∆°ng th·ª©c x√°c th·ª±c' : 'Authentication Method'}
          </h4>
          <div className="flex space-x-2 mb-4 flex-wrap">
            <button
              type="button"
              onClick={() => handleAuthMethodChange('apps_script')}
              className={`px-3 py-2 rounded-lg transition-all text-sm ${
                authMethod === 'apps_script'
                  ? 'bg-green-600 text-white'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              Apps Script ({language === 'vi' ? 'ƒê∆°n gi·∫£n nh·∫•t' : 'Easiest'})
            </button>
            <button
              type="button"
              onClick={() => handleAuthMethodChange('oauth')}
              className={`px-3 py-2 rounded-lg transition-all text-sm ${
                authMethod === 'oauth'
                  ? 'bg-blue-600 text-white'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              OAuth 2.0 ({language === 'vi' ? 'Khuy√™n d√πng' : 'Recommended'})
            </button>
            <button
              type="button"
              onClick={() => handleAuthMethodChange('service_account')}
              className={`px-3 py-2 rounded-lg transition-all text-sm ${
                authMethod === 'service_account'
                  ? 'bg-yellow-600 text-white'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              Service Account ({language === 'vi' ? 'C≈©' : 'Legacy'})
            </button>
          </div>
        </div>
        
        <div className="space-y-6">
          {/* Apps Script Configuration */}
          {authMethod === 'apps_script' && (
            <>
              <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                <h5 className="font-medium text-green-800 mb-2">
                  ‚ú® {language === 'vi' ? 'Google Apps Script (ƒê∆°n gi·∫£n nh·∫•t)' : 'Google Apps Script (Easiest)'}
                </h5>
                <p className="text-sm text-green-700">
                  {language === 'vi' 
                    ? 'S·ª≠ d·ª•ng Google Apps Script l√†m proxy ƒë·ªÉ bypass v·∫•n ƒë·ªÅ OAuth consent screen. Kh√¥ng c·∫ßn verification t·ª´ Google!'
                    : 'Use Google Apps Script as a proxy to bypass OAuth consent screen issues. No Google verification needed!'
                  }
                </p>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  {language === 'vi' ? 'Google Apps Script Web App URL' : 'Google Apps Script Web App URL'}
                </label>
                <input
                  type="url"
                  value={config.web_app_url}
                  onChange={(e) => setConfig(prev => ({ ...prev, web_app_url: e.target.value }))}
                  placeholder="https://script.google.com/macros/s/AKfycby.../exec"
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                />
                <p className="text-xs text-gray-500 mt-1">
                  {language === 'vi' 
                    ? 'V√≠ d·ª•: https://script.google.com/macros/s/AKfycbzi8DdyZ85Oi9H6s-HH5CTp28HFquCWB-CquduS7MT1SBytLB_awx1UqASBVvL51SE/exec'
                    : 'Example: https://script.google.com/macros/s/AKfycbzi8DdyZ85Oi9H6s-HH5CTp28HFquCWB-CquduS7MT1SBytLB_awx1UqASBVvL51SE/exec'
                  }
                </p>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  {language === 'vi' ? 'Google Drive Folder ID' : 'Google Drive Folder ID'}
                </label>
                <input
                  type="text"
                  value={config.folder_id}
                  onChange={(e) => setConfig(prev => ({ ...prev, folder_id: e.target.value }))}
                  placeholder="1abcDEFghiJKLmnopQRStuv2wxYZ"
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                />
                <p className="text-xs text-gray-500 mt-1">
                  {language === 'vi' ? 'Folder ID t·ª´ URL Google Drive: drive.google.com/drive/folders/[FOLDER_ID]' : 'Folder ID from Google Drive URL: drive.google.com/drive/folders/[FOLDER_ID]'}
                </p>
              </div>

              {/* Apps Script Test Connection */}
              <div className="border-t pt-4">
                <div className="flex items-center justify-between mb-3">
                  <h4 className="font-medium text-gray-800">
                    {language === 'vi' ? 'Test k·∫øt n·ªëi Apps Script' : 'Test Apps Script Connection'}
                  </h4>
                  <button
                    onClick={handleAppsScriptTest}
                    disabled={oauthLoading || !config.web_app_url || !config.folder_id}
                    className="px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white rounded-lg transition-all flex items-center gap-2"
                  >
                    {oauthLoading && <div className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>}
                    {language === 'vi' ? 'Test k·∫øt n·ªëi' : 'Test Connection'}
                  </button>
                </div>
                <p className="text-xs text-gray-500">
                  {language === 'vi' ? 'Test k·∫øt n·ªëi Apps Script tr∆∞·ªõc khi l∆∞u' : 'Test Apps Script connection before saving'}
                </p>
              </div>

              <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                <h4 className="font-medium text-green-800 mb-2">
                  üìã {language === 'vi' ? 'H∆∞·ªõng d·∫´n setup Apps Script:' : 'Apps Script Setup Instructions:'}
                </h4>
                <ol className="text-sm text-green-700 space-y-1">
                  <li>1. {language === 'vi' ? 'Truy c·∫≠p' : 'Go to'} <a href="https://script.google.com" target="_blank" className="underline">script.google.com</a></li>
                  <li>2. {language === 'vi' ? 'T·∫°o New project: "Ship Management Drive Proxy"' : 'Create New project: "Ship Management Drive Proxy"'}</li>
                  <li>3. {language === 'vi' ? 'Copy code t·ª´ file GOOGLE_APPS_SCRIPT_PROXY.js' : 'Copy code from GOOGLE_APPS_SCRIPT_PROXY.js file'}</li>
                  <li>4. {language === 'vi' ? 'S·ª≠a FOLDER_ID v·ªõi folder ID th·ª±c t·∫ø' : 'Update FOLDER_ID with your actual folder ID'}</li>
                  <li>5. {language === 'vi' ? 'Deploy as Web app ‚Üí Execute as: Me ‚Üí Who has access: Anyone' : 'Deploy as Web app ‚Üí Execute as: Me ‚Üí Who has access: Anyone'}</li>
                  <li>6. {language === 'vi' ? 'Copy Web app URL v√† paste v√†o tr√™n' : 'Copy Web app URL and paste above'}</li>
                </ol>
              </div>
            </>
          )}

          {/* OAuth Configuration */}
          {authMethod === 'oauth' && (
            <>
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                <h5 className="font-medium text-blue-800 mb-2">
                  {language === 'vi' ? 'OAuth 2.0 Configuration' : 'OAuth 2.0 Configuration'}
                </h5>
                <p className="text-sm text-blue-700">
                  {language === 'vi' 
                    ? 'OAuth 2.0 cho ph√©p ·ª©ng d·ª•ng truy c·∫≠p Google Drive c·ªßa b·∫°n m·ªôt c√°ch an to√†n m√† kh√¥ng c·∫ßn chia s·∫ª m·∫≠t kh·∫©u.'
                    : 'OAuth 2.0 allows the application to securely access your Google Drive without sharing passwords.'
                  }
                </p>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  {language === 'vi' ? 'Client ID' : 'Client ID'}
                </label>
                <input
                  type="text"
                  value={config.client_id}
                  onChange={(e) => setConfig(prev => ({ ...prev, client_id: e.target.value }))}
                  placeholder="123456789012-abcdefghijklmnopqrstuvwxyz123456.apps.googleusercontent.com"
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  {language === 'vi' ? 'Client Secret' : 'Client Secret'}
                </label>
                <input
                  type="password"
                  value={config.client_secret}
                  onChange={(e) => setConfig(prev => ({ ...prev, client_secret: e.target.value }))}
                  placeholder="GOCSPX-abcdefghijklmnopqrstuvwxyz123456"
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  {language === 'vi' ? 'Google Drive Folder ID' : 'Google Drive Folder ID'}
                </label>
                <input
                  type="text"
                  value={config.folder_id}
                  onChange={(e) => setConfig(prev => ({ ...prev, folder_id: e.target.value }))}
                  placeholder="1abcDEFghiJKLmnopQRStuv2wxYZ"
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
                <p className="text-xs text-gray-500 mt-1">
                  {language === 'vi' ? 'Folder ID t·ª´ URL Google Drive: drive.google.com/drive/folders/[FOLDER_ID]' : 'Folder ID from Google Drive URL: drive.google.com/drive/folders/[FOLDER_ID]'}
                </p>
              </div>

              {/* OAuth Authorization Button */}
              <div className="border-t pt-4">
                <div className="flex items-center justify-between mb-3">
                  <h4 className="font-medium text-gray-800">
                    {language === 'vi' ? 'X√°c th·ª±c OAuth' : 'OAuth Authorization'}
                  </h4>
                  <button
                    onClick={handleOAuthAuthorize}
                    disabled={oauthLoading || !config.client_id || !config.client_secret || !config.folder_id}
                    className="px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg transition-all flex items-center gap-2"
                  >
                    {oauthLoading && <div className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>}
                    {language === 'vi' ? 'X√°c th·ª±c v·ªõi Google' : 'Authorize with Google'}
                  </button>
                </div>
                <p className="text-xs text-gray-500">
                  {language === 'vi' ? 'Nh·∫•n ƒë·ªÉ x√°c th·ª±c ·ª©ng d·ª•ng v·ªõi Google Drive' : 'Click to authorize the application with Google Drive'}
                </p>
              </div>

              <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                <h4 className="font-medium text-green-800 mb-2">
                  {language === 'vi' ? 'H∆∞·ªõng d·∫´n thi·∫øt l·∫≠p OAuth:' : 'OAuth Setup Instructions:'}
                </h4>
                <ol className="text-sm text-green-700 space-y-1">
                  <li>1. {language === 'vi' ? 'Truy c·∫≠p Google Cloud Console' : 'Go to Google Cloud Console'}</li>
                  <li>2. {language === 'vi' ? 'T·∫°o OAuth 2.0 Client IDs' : 'Create OAuth 2.0 Client IDs'}</li>
                  <li>3. {language === 'vi' ? 'Th√™m Authorized redirect URI:' : 'Add Authorized redirect URI:'} <code>https://maritime-docai.preview.emergentagent.com/oauth2callback</code></li>
                  <li>4. {language === 'vi' ? 'Copy Client ID v√† Client Secret' : 'Copy Client ID and Client Secret'}</li>
                  <li>5. {language === 'vi' ? 'T·∫°o folder trong Google Drive v√† copy Folder ID' : 'Create folder in Google Drive and copy Folder ID'}</li>
                  <li>6. {language === 'vi' ? 'Nh·∫•n "X√°c th·ª±c v·ªõi Google" ƒë·ªÉ k·∫øt n·ªëi' : 'Click "Authorize with Google" to connect'}</li>
                </ol>
              </div>
            </>
          )}

          {/* Service Account Configuration (Legacy) */}
          {authMethod === 'service_account' && (
            <>
              <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                <h5 className="font-medium text-yellow-800 mb-2">
                  {language === 'vi' ? 'Service Account (C≈©)' : 'Service Account (Legacy)'}
                </h5>
                <p className="text-sm text-yellow-700">
                  {language === 'vi' 
                    ? 'Service Account c√≥ gi·ªõi h·∫°n storage quota. Khuy√™n d√πng OAuth 2.0 thay th·∫ø.'
                    : 'Service Account has storage quota limitations. OAuth 2.0 is recommended instead.'
                  }
                </p>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  {language === 'vi' ? 'Service Account JSON' : 'Service Account JSON'}
                </label>
                <textarea
                  value={config.service_account_json}
                  onChange={(e) => setConfig(prev => ({ ...prev, service_account_json: e.target.value }))}
                  placeholder={language === 'vi' ? 'Paste service account JSON key t·∫°i ƒë√¢y...' : 'Paste service account JSON key here...'}
                  className="w-full h-40 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none font-mono text-sm"
                />
                <p className="text-xs text-gray-500 mt-1">
                  {language === 'vi' ? 'T·∫°o Service Account trong Google Cloud Console v√† download JSON key' : 'Create Service Account in Google Cloud Console and download JSON key'}
                </p>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  {language === 'vi' ? 'Google Drive Folder ID' : 'Google Drive Folder ID'}
                </label>
                <input
                  type="text"
                  value={config.folder_id}
                  onChange={(e) => setConfig(prev => ({ ...prev, folder_id: e.target.value }))}
                  placeholder="1abcDEFghiJKLmnopQRStuv2wxYZ"
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono"
                />
                <p className="text-xs text-gray-500 mt-1">
                  {language === 'vi' ? 'Folder ID t·ª´ URL Google Drive: drive.google.com/drive/folders/[FOLDER_ID]' : 'Folder ID from Google Drive URL: drive.google.com/drive/folders/[FOLDER_ID]'}
                </p>
              </div>

              {/* Test Connection Section for Service Account */}
              <div className="border-t pt-4">
                <div className="flex items-center justify-between mb-3">
                  <h4 className="font-medium text-gray-800">
                    {language === 'vi' ? 'Test k·∫øt n·ªëi' : 'Test Connection'}
                  </h4>
                  <button
                    onClick={onTest}
                    disabled={testLoading || !config.service_account_json || !config.folder_id}
                    className="px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white rounded-lg transition-all flex items-center gap-2"
                  >
                    {testLoading && <div className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>}
                    {language === 'vi' ? 'Test k·∫øt n·ªëi' : 'Test Connection'}
                  </button>
                </div>
                <p className="text-xs text-gray-500">
                  {language === 'vi' ? 'Ki·ªÉm tra k·∫øt n·ªëi tr∆∞·ªõc khi l∆∞u c·∫•u h√¨nh' : 'Test connection before saving configuration'}
                </p>
              </div>

              <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <h4 className="font-medium text-yellow-800 mb-2">
                  {language === 'vi' ? 'H∆∞·ªõng d·∫´n thi·∫øt l·∫≠p:' : 'Setup Instructions:'}
                </h4>
                <ol className="text-sm text-yellow-700 space-y-1">
                  <li>1. {language === 'vi' ? 'T·∫°o project trong Google Cloud Console' : 'Create project in Google Cloud Console'}</li>
                  <li>2. {language === 'vi' ? 'Enable Google Drive API' : 'Enable Google Drive API'}</li>
                  <li>3. {language === 'vi' ? 'T·∫°o Service Account v√† download JSON key' : 'Create Service Account and download JSON key'}</li>
                  <li>4. {language === 'vi' ? 'T·∫°o folder trong Google Drive v√† share v·ªõi service account email' : 'Create folder in Google Drive and share with service account email'}</li>
                  <li>5. {language === 'vi' ? 'Copy Folder ID t·ª´ URL' : 'Copy Folder ID from URL'}</li>
                  <li>6. {language === 'vi' ? 'Test k·∫øt n·ªëi tr∆∞·ªõc khi l∆∞u' : 'Test connection before saving'}</li>
                </ol>
              </div>
            </>
          )}
        </div>

        <div className="flex justify-end space-x-4 mt-8">
          <button
            onClick={onClose}
            className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all"
          >
            {language === 'vi' ? 'H·ªßy' : 'Cancel'}
          </button>
          <button
            onClick={onSave}
            disabled={
              authMethod === 'apps_script'
                ? (!config.web_app_url || !config.folder_id)
                : authMethod === 'oauth' 
                  ? (!config.client_id || !config.client_secret || !config.folder_id)
                  : (!config.service_account_json || !config.folder_id)
            }
            className="px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg transition-all"
          >
            {language === 'vi' ? 'L∆∞u c·∫•u h√¨nh' : 'Save Configuration'}
          </button>
        </div>
      </div>
    </div>
  );
};

// Company Google Drive Configuration Modal Component
const CompanyGoogleDriveModal = ({ companyId, config, setConfig, currentConfig, onClose, onSave, onTest, testLoading, language }) => {
  const [authMethod, setAuthMethod] = useState('apps_script'); // Force apps_script as default
  const [oauthLoading, setOauthLoading] = useState(false);
  
  // Debug logging on modal render
  console.log('üîç CompanyGoogleDriveModal rendered with:');
  console.log('   companyId:', companyId);
  console.log('   config:', config);
  console.log('   authMethod:', authMethod);
  
  const handleOverlayClick = (e) => {
    if (e.target === e.currentTarget) {
      onClose();
    }
  };

  const handleAuthMethodChange = (method) => {
    setAuthMethod(method);
    setConfig(prev => ({ ...prev, auth_method: method }));
  };

  const handleAppsScriptTest = async () => {
    console.log('üîç Debug - handleAppsScriptTest called');
    console.log('   CompanyId:', companyId);
    console.log('   Config:', config);
    
    if (!companyId) {
      console.error('‚ùå No Company ID available in handleAppsScriptTest');
      toast.error(language === 'vi' ? 'L·ªói: Kh√¥ng c√≥ Company ID' : 'Error: No Company ID');
      return;
    }
    
    try {
      setOauthLoading(true);
      
      // Use the test configuration endpoint instead of configure endpoint for testing
      const response = await axios.post(`${API}/companies/${companyId}/gdrive/configure-proxy`, {
        web_app_url: config.web_app_url,
        folder_id: config.folder_id
      });
      
      if (response.data.success) {
        toast.success(language === 'vi' ? 'Apps Script proxy ho·∫°t ƒë·ªông!' : 'Apps Script proxy working!');
      } else {
        toast.error(language === 'vi' ? 'Apps Script proxy l·ªói' : 'Apps Script proxy error');
      }
    } catch (error) {
      console.error('Apps Script test error:', error);
      const errorMessage = error.response?.data?.message || error.message;
      toast.error(language === 'vi' ? `L·ªói test Apps Script: ${errorMessage}` : `Apps Script test error: ${errorMessage}`);
    } finally {
      setOauthLoading(false);
    }
  };

  const handleOAuthAuthorize = async () => {
    try {
      setOauthLoading(true);
      
      const oauthConfig = {
        client_id: config.client_id,
        client_secret: config.client_secret,
        redirect_uri: 'https://maritime-docai.preview.emergentagent.com/oauth2callback',
        folder_id: config.folder_id
      };

      const response = await axios.post(`${API}/companies/${companyId}/gdrive/oauth/authorize`, oauthConfig);
      
      if (response.data.success && response.data.authorization_url) {
        // Store state for later use
        sessionStorage.setItem('oauth_state', response.data.state);
        
        // Redirect to Google OAuth
        window.location.href = response.data.authorization_url;
      } else {
        toast.error(language === 'vi' ? 'Kh√¥ng th·ªÉ t·∫°o URL x√°c th·ª±c' : 'Failed to generate authorization URL');
      }
    } catch (error) {
      console.error('OAuth authorization error:', error);
      toast.error(language === 'vi' ? 'L·ªói x√°c th·ª±c OAuth' : 'OAuth authorization error');
    } finally {
      setOauthLoading(false);
    }
  };

  return (
    <div 
      className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[99999]" 
      onClick={handleOverlayClick}
    >
      <div className="bg-white rounded-xl shadow-2xl p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto mx-4">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-2xl font-bold text-gray-800">
            {language === 'vi' ? 'C·∫•u h√¨nh Google Drive c√¥ng ty' : 'Company Google Drive Configuration'}
          </h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600 text-2xl leading-none"
          >
            √ó
          </button>
        </div>

        {/* Current Configuration Display */}
        {currentConfig?.configured && (
          <div className="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
            <h4 className="font-medium text-green-800 mb-2">
              {language === 'vi' ? 'C·∫•u h√¨nh hi·ªán t·∫°i:' : 'Current Configuration:'}
            </h4>
            <div className="text-sm text-green-700 space-y-1">
              <div><strong>{language === 'vi' ? 'Method:' : 'Auth Method:'}</strong> {
                currentConfig.auth_method === 'apps_script' 
                  ? 'Apps Script' 
                  : currentConfig.auth_method === 'oauth' 
                    ? 'OAuth 2.0' 
                    : 'Service Account'
              }</div>
              <div><strong>{language === 'vi' ? 'Folder ID:' : 'Folder ID:'}</strong> {currentConfig.folder_id}</div>
              {currentConfig.last_sync && (
                <div><strong>{language === 'vi' ? 'ƒê·ªìng b·ªô cu·ªëi:' : 'Last Sync:'}</strong> {currentConfig.last_sync ? new Date(currentConfig.last_sync).toLocaleString() : 'Never'}</div>
              )}
            </div>
          </div>
        )}

        {/* Authentication Method Selector */}
        <div className="mb-6">
          <h4 className="font-medium text-gray-800 mb-3">
            {language === 'vi' ? 'Ph∆∞∆°ng th·ª©c x√°c th·ª±c' : 'Authentication Method'}
          </h4>
          <div className="flex space-x-2 mb-4 flex-wrap">
            <button
              type="button"
              onClick={() => handleAuthMethodChange('apps_script')}
              className={`px-3 py-2 rounded-lg transition-all text-sm ${
                authMethod === 'apps_script'
                  ? 'bg-green-600 text-white'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              Apps Script ({language === 'vi' ? 'ƒê∆°n gi·∫£n nh·∫•t' : 'Easiest'})
            </button>
            <button
              type="button"
              onClick={() => handleAuthMethodChange('oauth')}
              className={`px-3 py-2 rounded-lg transition-all text-sm ${
                authMethod === 'oauth'
                  ? 'bg-blue-600 text-white'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              OAuth 2.0 ({language === 'vi' ? 'Khuy√™n d√πng' : 'Recommended'})
            </button>
            <button
              type="button"
              onClick={() => handleAuthMethodChange('service_account')}
              className={`px-3 py-2 rounded-lg transition-all text-sm ${
                authMethod === 'service_account'
                  ? 'bg-yellow-600 text-white'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              Service Account ({language === 'vi' ? 'C≈©' : 'Legacy'})
            </button>
          </div>
        </div>
        
        <div className="space-y-6">
          {/* Apps Script Configuration */}
          {authMethod === 'apps_script' && (
            <>
              <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                <h5 className="font-medium text-green-800 mb-2">
                  ‚ú® {language === 'vi' ? 'Google Apps Script (ƒê∆°n gi·∫£n nh·∫•t)' : 'Google Apps Script (Easiest)'}
                </h5>
                <p className="text-sm text-green-700">
                  {language === 'vi' 
                    ? 'S·ª≠ d·ª•ng Google Apps Script cho c√¥ng ty n√†y. Kh√¥ng c·∫ßn verification t·ª´ Google!'
                    : 'Use Google Apps Script for this company. No Google verification needed!'
                  }
                </p>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  {language === 'vi' ? 'Google Apps Script Web App URL' : 'Google Apps Script Web App URL'}
                </label>
                <input
                  type="url"
                  value={config.web_app_url}
                  onChange={(e) => setConfig(prev => ({ ...prev, web_app_url: e.target.value }))}
                  placeholder="https://script.google.com/macros/s/AKfycby.../exec"
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                />
                <p className="text-xs text-gray-500 mt-1">
                  {language === 'vi' 
                    ? 'V√≠ d·ª•: https://script.google.com/macros/s/AKfycbzi8DdyZ85Oi9H6s-HH5CTp28HFquCWB-CquduS7MT1SBytLB_awx1UqASBVvL51SE/exec'
                    : 'Example: https://script.google.com/macros/s/AKfycbzi8DdyZ85Oi9H6s-HH5CTp28HFquCWB-CquduS7MT1SBytLB_awx1UqASBVvL51SE/exec'
                  }
                </p>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  {language === 'vi' ? 'Google Drive Folder ID' : 'Google Drive Folder ID'}
                </label>
                <input
                  type="text"
                  value={config.folder_id}
                  onChange={(e) => setConfig(prev => ({ ...prev, folder_id: e.target.value }))}
                  placeholder="1abcDEFghiJKLmnopQRStuv2wxYZ"
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                />
                <p className="text-xs text-gray-500 mt-1">
                  {language === 'vi' ? 'Folder ID t·ª´ URL Google Drive: drive.google.com/drive/folders/[FOLDER_ID]' : 'Folder ID from Google Drive URL: drive.google.com/drive/folders/[FOLDER_ID]'}
                </p>
              </div>

              {/* Apps Script Test Connection */}
              <div className="border-t pt-4">
                <div className="flex items-center justify-between mb-3">
                  <h4 className="font-medium text-gray-800">
                    {language === 'vi' ? 'Test k·∫øt n·ªëi Apps Script' : 'Test Apps Script Connection'}
                  </h4>
                  <button
                    onClick={handleAppsScriptTest}
                    disabled={oauthLoading || !config.web_app_url || !config.folder_id}
                    className="px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white rounded-lg transition-all flex items-center gap-2"
                  >
                    {oauthLoading && <div className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>}
                    {language === 'vi' ? 'Test k·∫øt n·ªëi' : 'Test Connection'}
                  </button>
                </div>
                <p className="text-xs text-gray-500">
                  {language === 'vi' ? 'Test k·∫øt n·ªëi Apps Script tr∆∞·ªõc khi l∆∞u' : 'Test Apps Script connection before saving'}
                </p>
              </div>

              <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                <h4 className="font-medium text-green-800 mb-2">
                  üìã {language === 'vi' ? 'H∆∞·ªõng d·∫´n setup Apps Script:' : 'Apps Script Setup Instructions:'}
                </h4>
                <ol className="text-sm text-green-700 space-y-1">
                  <li>1. {language === 'vi' ? 'Truy c·∫≠p' : 'Go to'} <a href="https://script.google.com" target="_blank" className="underline">script.google.com</a></li>
                  <li>2. {language === 'vi' ? 'T·∫°o New project cho c√¥ng ty n√†y' : 'Create New project for this company'}</li>
                  <li>3. {language === 'vi' ? 'Copy code t·ª´ APPS_SCRIPT_FIXED_CODE.js' : 'Copy code from APPS_SCRIPT_FIXED_CODE.js'}</li>
                  <li>4. {language === 'vi' ? 'S·ª≠a FOLDER_ID v·ªõi folder ID ri√™ng c·ªßa c√¥ng ty' : 'Update FOLDER_ID with company-specific folder ID'}</li>
                  <li>5. {language === 'vi' ? 'Deploy as Web app ‚Üí Execute as: Me ‚Üí Who has access: Anyone' : 'Deploy as Web app ‚Üí Execute as: Me ‚Üí Who has access: Anyone'}</li>
                  <li>6. {language === 'vi' ? 'Copy Web app URL v√† paste v√†o tr√™n' : 'Copy Web app URL and paste above'}</li>
                </ol>
              </div>
            </>
          )}

          {/* OAuth Configuration */}
          {authMethod === 'oauth' && (
            <>
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                <h5 className="font-medium text-blue-800 mb-2">
                  {language === 'vi' ? 'OAuth 2.0 Configuration cho C√¥ng ty' : 'OAuth 2.0 Configuration for Company'}
                </h5>
                <p className="text-sm text-blue-700">
                  {language === 'vi' 
                    ? 'OAuth 2.0 cho ph√©p c√¥ng ty truy c·∫≠p Google Drive ri√™ng m·ªôt c√°ch an to√†n.'
                    : 'OAuth 2.0 allows the company to securely access its dedicated Google Drive.'
                  }
                </p>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  {language === 'vi' ? 'Client ID' : 'Client ID'}
                </label>
                <input
                  type="text"
                  value={config.client_id}
                  onChange={(e) => setConfig(prev => ({ ...prev, client_id: e.target.value }))}
                  placeholder="123456789012-abcdefghijklmnopqrstuvwxyz123456.apps.googleusercontent.com"
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  {language === 'vi' ? 'Client Secret' : 'Client Secret'}
                </label>
                <input
                  type="password"
                  value={config.client_secret}
                  onChange={(e) => setConfig(prev => ({ ...prev, client_secret: e.target.value }))}
                  placeholder="GOCSPX-abcdefghijklmnopqrstuvwxyz123456"
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  {language === 'vi' ? 'Google Drive Folder ID' : 'Google Drive Folder ID'}
                </label>
                <input
                  type="text"
                  value={config.folder_id}
                  onChange={(e) => setConfig(prev => ({ ...prev, folder_id: e.target.value }))}
                  placeholder="1abcDEFghiJKLmnopQRStuv2wxYZ"
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
                <p className="text-xs text-gray-500 mt-1">
                  {language === 'vi' ? 'Folder ID ri√™ng cho c√¥ng ty n√†y' : 'Dedicated folder ID for this company'}
                </p>
              </div>

              {/* OAuth Authorization Button */}
              <div className="border-t pt-4">
                <div className="flex items-center justify-between mb-3">
                  <h4 className="font-medium text-gray-800">
                    {language === 'vi' ? 'X√°c th·ª±c OAuth' : 'OAuth Authorization'}
                  </h4>
                  <button
                    onClick={handleOAuthAuthorize}
                    disabled={oauthLoading || !config.client_id || !config.client_secret || !config.folder_id}
                    className="px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg transition-all flex items-center gap-2"
                  >
                    {oauthLoading && <div className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>}
                    {language === 'vi' ? 'X√°c th·ª±c v·ªõi Google' : 'Authorize with Google'}
                  </button>
                </div>
                <p className="text-xs text-gray-500">
                  {language === 'vi' ? 'Nh·∫•n ƒë·ªÉ x√°c th·ª±c c√¥ng ty v·ªõi Google Drive' : 'Click to authorize company with Google Drive'}
                </p>
              </div>
            </>
          )}

          {/* Service Account Configuration (Legacy) */}
          {authMethod === 'service_account' && (
            <>
              <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                <h5 className="font-medium text-yellow-800 mb-2">
                  {language === 'vi' ? 'Service Account cho C√¥ng ty (C≈©)' : 'Service Account for Company (Legacy)'}
                </h5>
                <p className="text-sm text-yellow-700">
                  {language === 'vi' 
                    ? 'Service Account c√≥ gi·ªõi h·∫°n storage quota. Khuy√™n d√πng Apps Script thay th·∫ø.'
                    : 'Service Account has storage quota limitations. Apps Script is recommended instead.'
                  }
                </p>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  {language === 'vi' ? 'Service Account JSON' : 'Service Account JSON'}
                </label>
                <textarea
                  value={config.service_account_json}
                  onChange={(e) => setConfig(prev => ({ ...prev, service_account_json: e.target.value }))}
                  placeholder={language === 'vi' ? 'Paste service account JSON key cho c√¥ng ty n√†y...' : 'Paste service account JSON key for this company...'}
                  className="w-full h-40 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none font-mono text-sm"
                />
                <p className="text-xs text-gray-500 mt-1">
                  {language === 'vi' ? 'T·∫°o Service Account ri√™ng cho c√¥ng ty n√†y' : 'Create dedicated Service Account for this company'}
                </p>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  {language === 'vi' ? 'Google Drive Folder ID' : 'Google Drive Folder ID'}
                </label>
                <input
                  type="text"
                  value={config.folder_id}
                  onChange={(e) => setConfig(prev => ({ ...prev, folder_id: e.target.value }))}
                  placeholder="1abcDEFghiJKLmnopQRStuv2wxYZ"
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono"
                />
                <p className="text-xs text-gray-500 mt-1">
                  {language === 'vi' ? 'Folder ID ri√™ng cho c√¥ng ty n√†y' : 'Dedicated folder ID for this company'}
                </p>
              </div>

              {/* Test Connection Section for Service Account */}
              <div className="border-t pt-4">
                <div className="flex items-center justify-between mb-3">
                  <h4 className="font-medium text-gray-800">
                    {language === 'vi' ? 'Test k·∫øt n·ªëi' : 'Test Connection'}
                  </h4>
                  <button
                    onClick={onTest}
                    disabled={testLoading || !config.service_account_json || !config.folder_id}
                    className="px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white rounded-lg transition-all flex items-center gap-2"
                  >
                    {testLoading && <div className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>}
                    {language === 'vi' ? 'Test k·∫øt n·ªëi' : 'Test Connection'}
                  </button>
                </div>
                <p className="text-xs text-gray-500">
                  {language === 'vi' ? 'Ki·ªÉm tra k·∫øt n·ªëi tr∆∞·ªõc khi l∆∞u c·∫•u h√¨nh' : 'Test connection before saving configuration'}
                </p>
              </div>

              <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <h4 className="font-medium text-yellow-800 mb-2">
                  {language === 'vi' ? 'H∆∞·ªõng d·∫´n thi·∫øt l·∫≠p:' : 'Setup Instructions:'}
                </h4>
                <ol className="text-sm text-yellow-700 space-y-1">
                  <li>1. {language === 'vi' ? 'T·∫°o project ri√™ng cho c√¥ng ty trong Google Cloud Console' : 'Create dedicated project for company in Google Cloud Console'}</li>
                  <li>2. {language === 'vi' ? 'Enable Google Drive API' : 'Enable Google Drive API'}</li>
                  <li>3. {language === 'vi' ? 'T·∫°o Service Account v√† download JSON key' : 'Create Service Account and download JSON key'}</li>
                  <li>4. {language === 'vi' ? 'T·∫°o folder ri√™ng v√† share v·ªõi service account email' : 'Create dedicated folder and share with service account email'}</li>
                  <li>5. {language === 'vi' ? 'Copy Folder ID t·ª´ URL' : 'Copy Folder ID from URL'}</li>
                  <li>6. {language === 'vi' ? 'Test k·∫øt n·ªëi tr∆∞·ªõc khi l∆∞u' : 'Test connection before saving'}</li>
                </ol>
              </div>
            </>
          )}
        </div>

        <div className="flex justify-end space-x-4 mt-8">
          <button
            onClick={onClose}
            className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all"
          >
            {language === 'vi' ? 'H·ªßy' : 'Cancel'}
          </button>
          <button
            onClick={onSave}
            disabled={
              authMethod === 'apps_script'
                ? (!config.web_app_url || !config.folder_id)
                : authMethod === 'oauth' 
                  ? (!config.client_id || !config.client_secret || !config.folder_id)
                  : (!config.service_account_json || !config.folder_id)
            }
            className="px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg transition-all"
          >
            {language === 'vi' ? 'L∆∞u c·∫•u h√¨nh' : 'Save Configuration'}
          </button>
        </div>
      </div>
    </div>
  );
};

// Permission Modal Component
const PermissionModal = ({ selectedUsers, onClose, onSuccess }) => {
  const { language } = useAuth();
  const [permissions, setPermissions] = useState({
    categories: [],
    departments: [],
    sensitivity_levels: [],
    permissions: []
  });

  const t = translations[language];

  const categories = ['certificates', 'class_survey_reports', 'survey_reports', 'drawings_manuals', 'other_documents'];
  const departments = ['technical', 'operations', 'safety', 'commercial', 'crewing', 'ship_crew'];
  const sensitivityLevels = ['public', 'internal', 'confidential', 'restricted'];
  const permissionTypes = ['read', 'write', 'delete', 'manage_users', 'system_control'];

  const handleSubmit = async () => {
    try {
      await axios.post(`${API}/permissions/assign`, {
        user_ids: selectedUsers,
        ...permissions
      });
      toast.success(language === 'vi' ? 'Ph√¢n quy·ªÅn th√†nh c√¥ng!' : 'Permissions assigned successfully!');
      onSuccess();
    } catch (error) {
      toast.error(language === 'vi' ? 'Ph√¢n quy·ªÅn th·∫•t b·∫°i!' : 'Failed to assign permissions!');
    }
  };

  // Handle clicking outside the modal content
  const handleOverlayClick = (e) => {
    if (e.target === e.currentTarget) {
      onClose();
    }
  };

  return (
    <div 
      className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]" 
      onClick={handleOverlayClick}
    >
      <div className="bg-white rounded-xl shadow-2xl p-8 max-w-4xl w-full max-h-[80vh] overflow-y-auto mx-4">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-2xl font-bold text-gray-800">{t.permissions}</h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600 text-2xl leading-none"
          >
            √ó
          </button>
        </div>
        
        <div className="grid md:grid-cols-2 gap-8">
          {/* Categories */}
          <div>
            <h3 className="font-semibold mb-3">{language === 'vi' ? 'Lo·∫°i t√†i li·ªáu' : 'Document Categories'}</h3>
            <div className="space-y-2">
              {categories.map(cat => (
                <label key={cat} className="flex items-center">
                  <input
                    type="checkbox"
                    checked={permissions.categories.includes(cat)}
                    onChange={(e) => {
                      const newCats = e.target.checked
                        ? [...permissions.categories, cat]
                        : permissions.categories.filter(c => c !== cat);
                      setPermissions(prev => ({ ...prev, categories: newCats }));
                    }}
                    className="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                  />
                  <span className="capitalize">{cat.replace('_', ' ')}</span>
                </label>
              ))}
            </div>
          </div>

          {/* Departments */}
          <div>
            <h3 className="font-semibold mb-3">{language === 'vi' ? 'Ph√≤ng ban' : 'Departments'}</h3>
            <div className="space-y-2">
              {departments.map(dept => (
                <label key={dept} className="flex items-center">
                  <input
                    type="checkbox"
                    checked={permissions.departments.includes(dept)}
                    onChange={(e) => {
                      const newDepts = e.target.checked
                        ? [...permissions.departments, dept]
                        : permissions.departments.filter(d => d !== dept);
                      setPermissions(prev => ({ ...prev, departments: newDepts }));
                    }}
                    className="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                  />
                  <span className="capitalize">{dept}</span>
                </label>
              ))}
            </div>
          </div>

          {/* Sensitivity Levels */}
          <div>
            <h3 className="font-semibold mb-3">{language === 'vi' ? 'M·ª©c ƒë·ªô b·∫£o m·∫≠t' : 'Sensitivity Levels'}</h3>
            <div className="space-y-2">
              {sensitivityLevels.map(level => (
                <label key={level} className="flex items-center">
                  <input
                    type="checkbox"
                    checked={permissions.sensitivity_levels.includes(level)}
                    onChange={(e) => {
                      const newLevels = e.target.checked
                        ? [...permissions.sensitivity_levels, level]
                        : permissions.sensitivity_levels.filter(l => l !== level);
                      setPermissions(prev => ({ ...prev, sensitivity_levels: newLevels }));
                    }}
                    className="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                  />
                  <span className="capitalize">{level}</span>
                </label>
              ))}
            </div>
          </div>

          {/* Permission Types */}
          <div>
            <h3 className="font-semibold mb-3">{language === 'vi' ? 'Quy·ªÅn h·∫°n' : 'Permissions'}</h3>
            <div className="space-y-2">
              {permissionTypes.map(perm => (
                <label key={perm} className="flex items-center">
                  <input
                    type="checkbox"
                    checked={permissions.permissions.includes(perm)}
                    onChange={(e) => {
                      const newPerms = e.target.checked
                        ? [...permissions.permissions, perm]
                        : permissions.permissions.filter(p => p !== perm);
                      setPermissions(prev => ({ ...prev, permissions: newPerms }));
                    }}
                    className="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                  />
                  <span className="capitalize">{perm.replace('_', ' ')}</span>
                </label>
              ))}
            </div>
          </div>
        </div>

        <div className="flex justify-end space-x-4 mt-8">
          <button
            onClick={onClose}
            className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all"
          >
            {language === 'vi' ? 'H·ªßy' : 'Cancel'}
          </button>
          <button
            onClick={handleSubmit}
            className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all"
          >
            {language === 'vi' ? '√Åp d·ª•ng' : 'Apply'}
          </button>
        </div>
      </div>
    </div>
  );
};

// AI Configuration Modal Component
const AIConfigModal = ({ config, setConfig, onClose, onSave, language, token }) => {
  const handleOverlayClick = (e) => {
    if (e.target === e.currentTarget) {
      onClose();
    }
  };

  const providers = [
    { value: 'openai', label: 'OpenAI', models: ['gpt-4o', 'gpt-4', 'gpt-3.5-turbo'] },
    { value: 'anthropic', label: 'Anthropic', models: ['claude-3-sonnet', 'claude-3-haiku'] },
    { value: 'google', label: 'Google', models: ['gemini-pro', 'gemini-pro-vision'] },
    { value: 'emergent', label: 'Emergent LLM', models: ['gemini-2.0-flash', 'gpt-4o', 'claude-3-sonnet'] }
  ];

  const selectedProvider = providers.find(p => p.value === config.provider);

  return (
    <div 
      className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] p-4" 
      onClick={handleOverlayClick}
    >
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
        <div className="flex justify-between items-center p-6 border-b border-gray-200 flex-shrink-0">
          <h2 className="text-2xl font-bold text-gray-800">
            {language === 'vi' ? 'C·∫•u h√¨nh AI' : 'AI Configuration'}
          </h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600 text-2xl leading-none"
          >
            √ó
          </button>
        </div>
        
        <div className="flex-1 overflow-y-auto">
          <div className="p-6 space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              {language === 'vi' ? 'Nh√† cung c·∫•p AI' : 'AI Provider'}
            </label>
            <select
              value={config.provider}
              onChange={(e) => {
                const provider = providers.find(p => p.value === e.target.value);
                setConfig(prev => ({
                  ...prev,
                  provider: e.target.value,
                  model: provider?.models[0] || 'gpt-4o'
                }));
              }}
              className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              {providers.map(provider => (
                <option key={provider.value} value={provider.value}>
                  {provider.label}
                </option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              {language === 'vi' ? 'M√¥ h√¨nh AI' : 'AI Model'}
            </label>
            <select
              value={config.model}
              onChange={(e) => setConfig(prev => ({ ...prev, model: e.target.value }))}
              className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              {selectedProvider?.models.map(model => (
                <option key={model} value={model}>
                  {model}
                </option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              {language === 'vi' ? 'C·∫•u h√¨nh API Key' : 'API Key Configuration'}
            </label>
            
            <div className="space-y-3">
              {/* Option 1: Use Emergent LLM Key */}
              <div className="flex items-center p-3 border border-green-200 rounded-lg bg-green-50">
                <input
                  type="radio"
                  id="use-emergent-key"
                  name="api-key-option"
                  checked={config.use_emergent_key !== false}
                  onChange={() => setConfig(prev => ({ 
                    ...prev, 
                    use_emergent_key: true, 
                    api_key: 'EMERGENT_LLM_KEY' 
                  }))}
                  className="mr-3"
                />
                <div className="flex-1">
                  <label htmlFor="use-emergent-key" className="text-sm font-medium text-green-800 cursor-pointer">
                    ‚ú® {language === 'vi' ? 'S·ª≠ d·ª•ng Emergent LLM Key (Khuy·∫øn ngh·ªã)' : 'Use Emergent LLM Key (Recommended)'}
                  </label>
                  <p className="text-xs text-green-600 mt-1">
                    {language === 'vi' 
                      ? 'Mi·ªÖn ph√≠ s·ª≠ d·ª•ng v·ªõi t·∫•t c·∫£ models. Kh√¥ng c·∫ßn nh·∫≠p API key ri√™ng.'
                      : 'Free to use with all models. No need to enter your own API key.'
                    }
                  </p>
                </div>
              </div>

              {/* Option 2: Use Custom API Key */}
              <div className="flex items-start p-3 border border-gray-200 rounded-lg">
                <input
                  type="radio"
                  id="use-custom-key"
                  name="api-key-option"
                  checked={config.use_emergent_key === false}
                  onChange={() => setConfig(prev => ({ 
                    ...prev, 
                    use_emergent_key: false, 
                    api_key: '' 
                  }))}
                  className="mr-3 mt-1"
                />
                <div className="flex-1">
                  <label htmlFor="use-custom-key" className="text-sm font-medium text-gray-700 cursor-pointer">
                    üîë {language === 'vi' ? 'S·ª≠ d·ª•ng API Key ri√™ng' : 'Use Custom API Key'}
                  </label>
                  <p className="text-xs text-gray-500 mb-2">
                    {language === 'vi' 
                      ? 'Nh·∫≠p API key t·ª´ OpenAI, Anthropic, ho·∫∑c Google'
                      : 'Enter your API key from OpenAI, Anthropic, or Google'
                    }
                  </p>
                  
                  {config.use_emergent_key === false && (
                    <input
                      type="password"
                      value={config.api_key || ''}
                      onChange={(e) => setConfig(prev => ({ ...prev, api_key: e.target.value }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                      placeholder={language === 'vi' ? 'Nh·∫≠p API key c·ªßa b·∫°n' : 'Enter your API key'}
                      required
                    />
                  )}
                </div>
              </div>
            </div>
          </div>

          {/* Google Document AI Configuration */}
          <div className="border-t border-gray-200 pt-6">
            <div className="flex items-center mb-4">
              <h4 className="text-lg font-medium text-gray-800">
                üìÑ {language === 'vi' ? 'Google Document AI' : 'Google Document AI'}
              </h4>
            </div>
            
            <div className="space-y-4">
              {/* Enable/Disable Google Document AI */}
              <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                <div>
                  <label className="text-sm font-medium text-gray-700">
                    {language === 'vi' ? 'K√≠ch ho·∫°t Google Document AI' : 'Enable Google Document AI'}
                  </label>
                  <p className="text-xs text-gray-500 mt-1">
                    {language === 'vi' 
                      ? 'S·ª≠ d·ª•ng cho ph√¢n t√≠ch h·ªô chi·∫øu v√† t√†i li·ªáu trong qu·∫£n l√Ω thuy·ªÅn vi√™n'
                      : 'Used for passport and document analysis in crew management'
                    }
                  </p>
                </div>
                <label className="relative inline-flex items-center cursor-pointer">
                  <input
                    type="checkbox"
                    checked={config.document_ai?.enabled || false}
                    onChange={(e) => setConfig(prev => ({
                      ...prev,
                      document_ai: {
                        ...prev.document_ai,
                        enabled: e.target.checked
                      }
                    }))}
                    className="sr-only peer"
                  />
                  <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
              </div>

              {/* Google Document AI Configuration Fields */}
              {config.document_ai?.enabled && (
                <div className="space-y-4 pl-4 border-l-2 border-blue-200">
                  
                  {/* Project ID */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      {language === 'vi' ? 'Project ID *' : 'Project ID *'}
                    </label>
                    <input
                      type="text"
                      value={config.document_ai?.project_id || ''}
                      onChange={(e) => setConfig(prev => ({
                        ...prev,
                        document_ai: {
                          ...prev.document_ai,
                          project_id: e.target.value
                        }
                      }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder={language === 'vi' ? 'Nh·∫≠p Google Cloud Project ID' : 'Enter Google Cloud Project ID'}
                      required={config.document_ai?.enabled}
                    />
                  </div>

                  {/* Location */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      {language === 'vi' ? 'V√πng (Location) *' : 'Location *'}
                    </label>
                    <select
                      value={config.document_ai?.location || 'us'}
                      onChange={(e) => setConfig(prev => ({
                        ...prev,
                        document_ai: {
                          ...prev.document_ai,
                          location: e.target.value
                        }
                      }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                      <option value="us">US (United States)</option>
                      <option value="eu">EU (Europe)</option>
                      <option value="asia-northeast1">Asia Northeast 1 (Tokyo)</option>
                      <option value="asia-southeast1">Asia Southeast 1 (Singapore)</option>
                    </select>
                  </div>

                  {/* Processor ID */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      {language === 'vi' ? 'Processor ID *' : 'Processor ID *'}
                    </label>
                    <input
                      type="text"
                      value={config.document_ai?.processor_id || ''}
                      onChange={(e) => setConfig(prev => ({
                        ...prev,
                        document_ai: {
                          ...prev.document_ai,
                          processor_id: e.target.value
                        }
                      }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder={language === 'vi' ? 'Nh·∫≠p Document AI Processor ID' : 'Enter Document AI Processor ID'}
                      required={config.document_ai?.enabled}
                    />
                  </div>

                  {/* Document AI Apps Script URL */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      {language === 'vi' ? 'Document AI Apps Script URL *' : 'Document AI Apps Script URL *'}
                    </label>
                    <input
                      type="url"
                      value={config.document_ai?.apps_script_url || ''}
                      onChange={(e) => setConfig(prev => ({
                        ...prev,
                        document_ai: {
                          ...prev.document_ai,
                          apps_script_url: e.target.value
                        }
                      }))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder={language === 'vi' ? 'https://script.google.com/macros/s/..../exec' : 'https://script.google.com/macros/s/..../exec'}
                      required={config.document_ai?.enabled}
                    />
                    <p className="text-xs text-gray-500 mt-1">
                      {language === 'vi' 
                        ? 'URL c·ªßa Google Apps Script ri√™ng bi·ªát ƒë·ªÉ x·ª≠ l√Ω Document AI'
                        : 'Separate Google Apps Script URL for Document AI processing'
                      }
                    </p>
                  </div>

                  {/* Authentication Method */}
                  <div>
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                      <div className="flex items-center">
                        <span className="text-blue-600 mr-2">üîó</span>
                        <div>
                          <p className="text-sm font-medium text-blue-800">
                            {language === 'vi' ? 'X√°c th·ª±c Google Apps Script' : 'Google Apps Script Authentication'}
                          </p>
                          <p className="text-xs text-blue-700 mt-1">
                            {language === 'vi' 
                              ? 'Apps Script s·∫Ω s·ª≠ d·ª•ng OAuth c·ªßa Google ƒë·ªÉ truy c·∫≠p Document AI API'
                              : 'Apps Script uses Google OAuth to access Document AI API'
                            }
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Test Connection Button */}
                  <div>
                    <button
                      type="button"
                      onClick={async () => {
                        // Validate required fields before testing
                        if (!config.document_ai?.project_id || !config.document_ai?.processor_id) {
                          toast.error(language === 'vi' 
                            ? 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß Project ID v√† Processor ID tr∆∞·ªõc khi ki·ªÉm tra'
                            : 'Please fill in Project ID and Processor ID before testing'
                          );
                          return;
                        }
                        
                        try {
                          toast.info(language === 'vi' 
                            ? 'ƒêang ki·ªÉm tra k·∫øt n·ªëi Google Document AI...'
                            : 'Testing Google Document AI connection...'
                          );
                          
                          // Check if token exists
                          if (!token) {
                            throw new Error(language === 'vi' 
                              ? 'Ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.'
                              : 'Not logged in. Please login again.'
                            );
                          }
                          
                          const response = await axios.post(`${API}/test-document-ai`, {
                            project_id: config.document_ai.project_id,
                            location: config.document_ai.location,
                            processor_id: config.document_ai.processor_id
                          }, {
                            headers: { 'Authorization': `Bearer ${token}` }
                          });
                          
                          if (response.data.success) {
                            toast.success(language === 'vi' 
                              ? `K·∫øt n·ªëi th√†nh c√¥ng! Processor: ${response.data.processor_name || 'N/A'}`
                              : `Connection successful! Processor: ${response.data.processor_name || 'N/A'}`
                            );
                          } else {
                            toast.error(language === 'vi' 
                              ? `K·∫øt n·ªëi th·∫•t b·∫°i: ${response.data.message}`
                              : `Connection failed: ${response.data.message}`
                            );
                          }
                        } catch (error) {
                          console.error('Document AI test error:', error);
                          toast.error(language === 'vi' 
                            ? `L·ªói ki·ªÉm tra k·∫øt n·ªëi: ${error.response?.data?.detail || error.message}`
                            : `Connection test error: ${error.response?.data?.detail || error.message}`
                          );
                        }
                      }}
                      className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm transition-all"
                    >
                      {language === 'vi' ? 'Ki·ªÉm tra k·∫øt n·ªëi' : 'Test Connection'}
                    </button>
                  </div>

                  {/* Configuration Info */}
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <p className="text-sm text-yellow-800">
                      <strong>{language === 'vi' ? 'H∆∞·ªõng d·∫´n c·∫•u h√¨nh:' : 'Configuration Guide:'}</strong>
                    </p>
                    <ul className="text-xs text-yellow-700 mt-2 space-y-1 list-disc list-inside">
                      <li>
                        {language === 'vi' 
                          ? 'T·∫°o project trong Google Cloud Console' 
                          : 'Create project in Google Cloud Console'
                        }
                      </li>
                      <li>
                        {language === 'vi' 
                          ? 'K√≠ch ho·∫°t Document AI API' 
                          : 'Enable Document AI API'
                        }
                      </li>
                      <li>
                        {language === 'vi' 
                          ? 'T·∫°o Document AI processor (lo·∫°i: FORM_PARSER ho·∫∑c PASSPORT_PARSER)' 
                          : 'Create Document AI processor (type: FORM_PARSER or PASSPORT_PARSER)'
                        }
                      </li>
                      <li>
                        {language === 'vi' 
                          ? 'ƒê·∫£m b·∫£o Google Drive Configuration ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p' 
                          : 'Ensure Google Drive Configuration is already set up'
                        }
                      </li>
                      <li>
                        {language === 'vi' 
                          ? 'Google Apps Script s·∫Ω t·ª± ƒë·ªông s·ª≠ d·ª•ng authentication ƒë√£ c√≥' 
                          : 'Google Apps Script will automatically use existing authentication'
                        }
                      </li>
                    </ul>
                  </div>
                </div>
              )}
            </div>
          </div>

          <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <p className="text-sm text-blue-800">
              {language === 'vi' ? 
                'Ch√∫ √Ω: Thay ƒë·ªïi c·∫•u h√¨nh AI s·∫Ω ·∫£nh h∆∞·ªüng ƒë·∫øn t·∫•t c·∫£ t√≠nh nƒÉng ph√¢n t√≠ch t√†i li·ªáu v√† t√¨m ki·∫øm th√¥ng minh.' : 
                'Note: Changing AI configuration will affect all document analysis and smart search features.'
              }
            </p>
          </div>
          </div>
        </div>

        <div className="flex justify-end space-x-4 p-6 border-t border-gray-200 flex-shrink-0">
          <button
            onClick={onClose}
            className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all"
          >
            {language === 'vi' ? 'H·ªßy' : 'Cancel'}
          </button>
          <button
            onClick={() => {
              // Validate based on selected option
              if (config.use_emergent_key === false && (!config.api_key || config.api_key.trim() === '')) {
                alert(language === 'vi' ? 'Vui l√≤ng nh·∫≠p API key' : 'Please enter API key');
                return;
              }
              
              // Validate Google Document AI configuration if enabled
              if (config.document_ai?.enabled) {
                if (!config.document_ai?.project_id || !config.document_ai?.project_id.trim()) {
                  alert(language === 'vi' ? 'Vui l√≤ng nh·∫≠p Project ID cho Google Document AI' : 'Please enter Project ID for Google Document AI');
                  return;
                }
                if (!config.document_ai?.processor_id || !config.document_ai?.processor_id.trim()) {
                  alert(language === 'vi' ? 'Vui l√≤ng nh·∫≠p Processor ID cho Google Document AI' : 'Please enter Processor ID for Google Document AI');
                  return;
                }
                if (!config.document_ai?.apps_script_url || !config.document_ai?.apps_script_url.trim()) {
                  alert(language === 'vi' ? 'Vui l√≤ng nh·∫≠p Apps Script URL cho Google Document AI' : 'Please enter Apps Script URL for Google Document AI');
                  return;
                }
              }
              
              onSave();
            }}
            className="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all"
          >
            {language === 'vi' ? 'L∆∞u c·∫•u h√¨nh' : 'Save Configuration'}
          </button>
        </div>
      </div>
    </div>
  );
};

// Company Form Modal Component
const CompanyFormModal = ({ 
  companyData, 
  setCompanyData, 
  onClose, 
  onSubmit, 
  language, 
  isEdit = false,
  companyGdriveCurrentConfig,
  fetchCompanyGoogleDriveConfig,
  fetchCompanyGoogleDriveStatus,
  setShowCompanyGoogleDrive
}) => {
  const [logoFile, setLogoFile] = useState(null);
  const [uploading, setUploading] = useState(false);

  const handleOverlayClick = (e) => {
    if (e.target === e.currentTarget) {
      onClose();
    }
  };

  const handleSubmitWithLogo = async () => {
    try {
      setUploading(true);
      
      // First submit the company data (including logo_url if provided)
      const result = await onSubmit();
      
      // Only upload file if:
      // 1. User selected a file to upload
      // 2. Company was created/updated successfully
      // 3. User didn't provide a logo_url (URL takes priority)
      if (logoFile && result && !companyData.logo_url) {
        const companyId = result.id || companyData.id;
        if (companyId) {
          await handleLogoUpload(companyId);
        }
      }
    } catch (error) {
      console.error('Error submitting company:', error);
    } finally {
      setUploading(false);
    }
  };

  const handleLogoUpload = async (companyId) => {
    if (!logoFile) return;
    
    setUploading(true);
    try {
      const formData = new FormData();
      formData.append('file', logoFile);
      
      const response = await axios.post(`${API}/companies/${companyId}/upload-logo`, formData, {
        headers: {
          'Content-Type': 'multipart/form-data',
        }
      });
      
      toast.success(language === 'vi' ? 'Logo ƒë√£ ƒë∆∞·ª£c t·∫£i l√™n th√†nh c√¥ng!' : 'Logo uploaded successfully!');
      
      // Refresh companies list to show the new logo
      if (window.fetchCompanies) {
        window.fetchCompanies();
      }
      
    } catch (error) {
      toast.error(language === 'vi' ? 'Kh√¥ng th·ªÉ t·∫£i l√™n logo!' : 'Failed to upload logo!');
      console.error('Logo upload error:', error);
    } finally {
      setUploading(false);
    }
  };

  return (
    <div 
      className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]" 
      onClick={handleOverlayClick}
    >
      <div className="bg-white rounded-xl shadow-2xl p-8 max-w-6xl w-full max-h-[95vh] overflow-y-auto mx-4">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-2xl font-bold text-gray-800">
            {isEdit ? 
              (language === 'vi' ? 'Ch·ªânh s·ª≠a c√¥ng ty' : 'Edit Company') :
              (language === 'vi' ? 'Th√™m c√¥ng ty m·ªõi' : 'Add New Company')
            }
          </h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600 text-2xl leading-none"
          >
            √ó
          </button>
        </div>
        
        <div className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'T√™n c√¥ng ty (Ti·∫øng Vi·ªát)' : 'Company Name (Vietnamese)'} *
              </label>
              <input
                type="text"
                required
                value={companyData.name_vn}
                onChange={(e) => setCompanyData(prev => ({ ...prev, name_vn: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder={language === 'vi' ? 'Nh·∫≠p t√™n c√¥ng ty b·∫±ng ti·∫øng Vi·ªát' : 'Enter company name in Vietnamese'}
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'T√™n c√¥ng ty (Ti·∫øng Anh)' : 'Company Name (English)'} *
              </label>
              <input
                type="text"
                required
                value={companyData.name_en}
                onChange={(e) => setCompanyData(prev => ({ ...prev, name_en: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder={language === 'vi' ? 'Nh·∫≠p t√™n c√¥ng ty b·∫±ng ti·∫øng Anh' : 'Enter company name in English'}
              />
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'ƒê·ªãa ch·ªâ (Ti·∫øng Vi·ªát)' : 'Address (Vietnamese)'} *
              </label>
              <textarea
                required
                value={companyData.address_vn}
                onChange={(e) => setCompanyData(prev => ({ ...prev, address_vn: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                rows="3"
                placeholder={language === 'vi' ? 'Nh·∫≠p ƒë·ªãa ch·ªâ b·∫±ng ti·∫øng Vi·ªát' : 'Enter address in Vietnamese'}
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'ƒê·ªãa ch·ªâ (Ti·∫øng Anh)' : 'Address (English)'} *
              </label>
              <textarea
                required
                value={companyData.address_en}
                onChange={(e) => setCompanyData(prev => ({ ...prev, address_en: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                rows="3"
                placeholder={language === 'vi' ? 'Nh·∫≠p ƒë·ªãa ch·ªâ b·∫±ng ti·∫øng Anh' : 'Enter address in English'}
              />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {language === 'vi' ? 'M√£ s·ªë thu·∫ø' : 'Tax ID'} *
            </label>
            <input
              type="text"
              required
              value={companyData.tax_id}
              onChange={(e) => setCompanyData(prev => ({ ...prev, tax_id: e.target.value }))}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder={language === 'vi' ? 'Nh·∫≠p m√£ s·ªë thu·∫ø' : 'Enter tax ID'}
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Gmail</label>
              <input
                type="email"
                value={companyData.gmail}
                onChange={(e) => setCompanyData(prev => ({ ...prev, gmail: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="company@gmail.com"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Zalo</label>
              <input
                type="text"
                value={companyData.zalo}
                onChange={(e) => setCompanyData(prev => ({ ...prev, zalo: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder={language === 'vi' ? 'S·ªë ƒëi·ªán tho·∫°i Zalo' : 'Zalo phone number'}
              />
            </div>
          </div>

          {/* Company Logo Upload - Moved here for better visibility */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {language === 'vi' ? 'Logo c√¥ng ty' : 'Company Logo'}
            </label>
            
            {/* Logo URL Input */}
            <div className="mb-3">
              <label className="block text-xs font-medium text-gray-600 mb-1">
                {language === 'vi' ? 'URL Logo (Nh·∫≠p URL h√¨nh ·∫£nh)' : 'Logo URL (Enter image URL)'}
              </label>
              <input
                type="text"
                value={companyData.logo_url || ''}
                onChange={(e) => setCompanyData(prev => ({ ...prev, logo_url: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                placeholder="https://example.com/logo.png"
              />
              <p className="text-xs text-gray-500 mt-1">
                {language === 'vi' ? 'Ho·∫∑c nh·∫≠p URL tr·ª±c ti·∫øp c·ªßa logo' : 'Or enter logo URL directly'}
              </p>
            </div>

            {/* Logo File Upload */}
            <div>
              <label className="block text-xs font-medium text-gray-600 mb-1">
                {language === 'vi' ? 'Ho·∫∑c t·∫£i l√™n file' : 'Or upload file'}
              </label>
              <input
                type="file"
                accept="image/*"
                onChange={(e) => setLogoFile(e.target.files[0])}
                className="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
              />
              <p className="text-xs text-gray-500 mt-1">
                {language === 'vi' ? 'H·ªó tr·ª£: JPG, PNG, GIF (t·ªëi ƒëa 5MB)' : 'Supported: JPG, PNG, GIF (max 5MB)'}
              </p>
            </div>

            {/* Current Logo Preview */}
            {companyData.logo_url && (
              <div className="mt-3">
                <p className="text-xs font-medium text-gray-600 mb-2">
                  {language === 'vi' ? 'Xem tr∆∞·ªõc logo:' : 'Logo preview:'}
                </p>
                <img 
                  src={companyData.logo_url.startsWith('http') ? companyData.logo_url : `${API}${companyData.logo_url}`}
                  alt="Logo preview" 
                  className="w-20 h-20 object-contain border border-gray-200 rounded bg-gray-50"
                  onError={(e) => {
                    e.target.style.display = 'none';
                    e.target.nextSibling.style.display = 'block';
                  }}
                />
                <div className="hidden text-xs text-red-500 mt-1">
                  {language === 'vi' ? 'Kh√¥ng th·ªÉ t·∫£i logo' : 'Failed to load logo'}
                </div>
              </div>
            )}
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {language === 'vi' ? 'Th·ªùi h·∫°n s·ª≠ d·ª•ng h·ªá th·ªëng' : 'System Usage Expiry'}
            </label>
            <input
              type="date"
              value={companyData.system_expiry}
              onChange={(e) => setCompanyData(prev => ({ ...prev, system_expiry: e.target.value }))}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>

          {/* Company Google Drive Configuration */}
          <div>
            <h3 className="text-lg font-semibold mb-4 text-gray-800 flex items-center">
              <svg className="w-5 h-5 mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                <path d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"/>
                <path d="M8 6h4v2H8V6zM8 10h4v2H8v-2z"/>
              </svg>
              {language === 'vi' ? 'C·∫•u h√¨nh Google Drive c√¥ng ty' : 'Company Google Drive Configuration'}
            </h3>
            
            {/* Current Configuration Status */}
            {companyGdriveCurrentConfig && companyGdriveCurrentConfig.config && 
             companyGdriveCurrentConfig.config.web_app_url && companyGdriveCurrentConfig.config.folder_id && (
              <div className="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                <h4 className="font-medium text-green-800 mb-2">
                  {language === 'vi' ? 'C·∫•u h√¨nh hi·ªán t·∫°i:' : 'Current Configuration:'}
                </h4>
                <div className="text-sm text-green-700 space-y-1">
                  <div><strong>{language === 'vi' ? 'Ph∆∞∆°ng th·ª©c:' : 'Auth Method:'}</strong> {
                    companyGdriveCurrentConfig.config.auth_method === 'apps_script' 
                      ? 'Apps Script' 
                      : companyGdriveCurrentConfig.config.auth_method === 'oauth' 
                        ? 'OAuth 2.0' 
                        : 'Service Account'
                  }</div>
                  <div><strong>{language === 'vi' ? 'Folder ID:' : 'Folder ID:'}</strong> {companyGdriveCurrentConfig.config.folder_id}</div>
                  <div><strong>{language === 'vi' ? 'Web App URL:' : 'Web App URL:'}</strong> {companyGdriveCurrentConfig.config.web_app_url}</div>
                  {companyGdriveCurrentConfig.config.service_account_email && (
                    <div><strong>{language === 'vi' ? 'Account Email:' : 'Account Email:'}</strong> {companyGdriveCurrentConfig.config.service_account_email}</div>
                  )}
                  {companyGdriveCurrentConfig.last_sync && (
                    <div><strong>{language === 'vi' ? 'ƒê·ªìng b·ªô cu·ªëi:' : 'Last Sync:'}</strong> {new Date(companyGdriveCurrentConfig.last_sync).toLocaleString()}</div>
                  )}
                </div>
              </div>
            )}

            {/* Configuration Status Badge */}
            <div className="mb-4 flex items-center space-x-3">
              <div className={`px-3 py-1 rounded-full text-xs font-medium ${
                (companyGdriveCurrentConfig?.config?.web_app_url && companyGdriveCurrentConfig?.config?.folder_id)
                  ? 'bg-green-100 text-green-800' 
                  : 'bg-gray-100 text-gray-800'
              }`}>
                {(companyGdriveCurrentConfig?.config?.web_app_url && companyGdriveCurrentConfig?.config?.folder_id)
                  ? (language === 'vi' ? 'ƒê√£ c·∫•u h√¨nh' : 'Configured')
                  : (language === 'vi' ? 'Ch∆∞a c·∫•u h√¨nh' : 'Not configured')
                }
              </div>
              
              {(companyGdriveCurrentConfig?.config?.web_app_url && companyGdriveCurrentConfig?.config?.folder_id) && (
                <button
                  onClick={() => {
                    if (companyData.id) {
                      fetchCompanyGoogleDriveConfig(companyData.id);
                      fetchCompanyGoogleDriveStatus(companyData.id);
                      setShowCompanyGoogleDrive(true);
                    }
                  }}
                  className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-lg transition-all"
                >
                  {language === 'vi' ? 'ƒê·ªìng b·ªô ngay' : 'Sync Now'}
                </button>
              )}
            </div>

            {/* Configure Button */}
            <button
              onClick={() => {
                console.log('üîç Debug - Configure Company Google Drive clicked');
                console.log('   companyData:', companyData);
                console.log('   companyData.id:', companyData.id);
                
                if (companyData.id) {
                  console.log('‚úÖ Using companyData.id:', companyData.id);
                  fetchCompanyGoogleDriveConfig(companyData.id);
                  fetchCompanyGoogleDriveStatus(companyData.id);
                  setShowCompanyGoogleDrive(true);
                } else {
                  console.log('‚ùå No company ID found');
                  toast.warning(language === 'vi' ? 'Vui l√≤ng l∆∞u c√¥ng ty tr∆∞·ªõc khi c·∫•u h√¨nh Google Drive' : 'Please save company before configuring Google Drive');
                }
              }}
              className="w-full px-4 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all font-medium"
            >
              {language === 'vi' ? 'C·∫•u h√¨nh Google Drive c√¥ng ty' : 'Configure Company Google Drive'}
            </button>

            <div className="mt-3 bg-purple-50 border border-purple-200 rounded-lg p-3">
              <p className="text-sm text-purple-700">
                {language === 'vi' 
                  ? 'C·∫•u h√¨nh Google Drive ri√™ng cho c√¥ng ty n√†y. H·ªó tr·ª£ 3 ph∆∞∆°ng th·ª©c: Apps Script (ƒë∆°n gi·∫£n), OAuth 2.0 (khuy√™n d√πng), Service Account (c≈©).'
                  : 'Configure dedicated Google Drive for this company. Supports 3 methods: Apps Script (easiest), OAuth 2.0 (recommended), Service Account (legacy).'
                }
              </p>
            </div>
          </div>

          <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <h4 className="font-medium text-yellow-800 mb-2">
              {language === 'vi' ? 'L∆∞u √Ω:' : 'Note:'}
            </h4>
            <ul className="text-sm text-yellow-700 space-y-1">
              <li>‚Ä¢ {language === 'vi' ? 'Th√¥ng tin c√¥ng ty s·∫Ω ƒë∆∞·ª£c l∆∞u tr√™n Google Drive' : 'Company data will be stored on Google Drive'}</li>
              <li>‚Ä¢ {language === 'vi' ? 'Logo s·∫Ω ƒë∆∞·ª£c t·∫£i l√™n sau khi t·∫°o/c·∫≠p nh·∫≠t c√¥ng ty' : 'Logo will be uploaded after creating/updating company'}</li>
              <li>‚Ä¢ {language === 'vi' ? 'Ch·ªâ Super Admin m·ªõi c√≥ quy·ªÅn truy c·∫≠p t√≠nh nƒÉng n√†y' : 'Only Super Admin can access this feature'}</li>
            </ul>
          </div>
        </div>

        <div className="flex justify-end space-x-4 mt-8">
          <button
            onClick={onClose}
            className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all"
          >
            {language === 'vi' ? 'H·ªßy' : 'Cancel'}
          </button>
          <button
            onClick={handleSubmitWithLogo}
            disabled={uploading}
            className="px-6 py-2 bg-orange-600 hover:bg-orange-700 disabled:bg-gray-400 text-white rounded-lg transition-all flex items-center"
          >
            {uploading && <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>}
            {isEdit ?
              (language === 'vi' ? 'C·∫≠p nh·∫≠t c√¥ng ty' : 'Update Company') :
              (language === 'vi' ? 'T·∫°o c√¥ng ty' : 'Create Company')
            }
          </button>
        </div>
      </div>
    </div>
  );
};

// Edit User Modal Component
const EditUserModal = ({ userData, setUserData, onClose, onSubmit, language, companies, ships }) => {
  const [permissions, setPermissions] = useState({
    categories: [],
    departments: [],
    sensitivity_levels: [],
    permissions: []
  });

  // Update permissions when userData changes
  useEffect(() => {
    if (userData && userData.permissions) {
      setPermissions({
        categories: userData.permissions.categories || [],
        departments: userData.permissions.departments || [],
        sensitivity_levels: userData.permissions.sensitivity_levels || [],
        permissions: userData.permissions.permissions || []
      });
    } else {
      setPermissions({
        categories: [],
        departments: [],
        sensitivity_levels: [],
        permissions: []
      });
    }
  }, [userData]);

  const handleOverlayClick = (e) => {
    if (e.target === e.currentTarget) {
      onClose();
    }
  };

  const roleOptions = [
    { value: 'viewer', label: language === 'vi' ? 'Thuy·ªÅn vi√™n' : 'Crew' },
    { value: 'editor', label: language === 'vi' ? 'Sƒ© quan' : 'Ship Officer' },
    { value: 'manager', label: language === 'vi' ? 'C√°n b·ªô c√¥ng ty' : 'Company Officer' },
    { value: 'admin', label: language === 'vi' ? 'Qu·∫£n tr·ªã vi√™n' : 'Admin' },
    { value: 'super_admin', label: language === 'vi' ? 'Si√™u qu·∫£n tr·ªã' : 'Super Admin' }
  ];

  const categories = ['certificates', 'class_survey_reports', 'survey_reports', 'drawings_manuals', 'other_documents'];
  const departments = ['technical', 'operations', 'safety', 'commercial', 'crewing', 'ship_crew'];
  const sensitivityLevels = ['public', 'internal', 'confidential', 'restricted'];
  const permissionTypes = ['read', 'write', 'delete', 'manage_users', 'system_control'];

  const categoryNames = {
    certificates: language === 'vi' ? 'Ch·ª©ng ch·ªâ' : 'Certificates',
    class_survey_reports: language === 'vi' ? 'H·ªì s∆° ƒêƒÉng ki·ªÉm' : 'Class Survey Report',
    survey_reports: language === 'vi' ? 'B√°o c√°o ki·ªÉm tra' : 'Test Report',
    drawings_manuals: language === 'vi' ? 'B·∫£n v·∫Ω & H∆∞·ªõng d·∫´n' : 'Drawings & Manuals',
    other_documents: language === 'vi' ? 'T√†i li·ªáu kh√°c' : 'Other Documents'
  };

  const departmentNames = {
    technical: language === 'vi' ? 'K·ªπ thu·∫≠t' : 'Technical',
    operations: language === 'vi' ? 'V·∫≠n h√†nh' : 'Operations',
    safety: language === 'vi' ? 'An to√†n' : 'Safety',
    commercial: language === 'vi' ? 'Th∆∞∆°ng m·∫°i' : 'Commercial',
    crewing: language === 'vi' ? 'Thuy·ªÅn vi√™n' : 'Crewing',
    ship_crew: language === 'vi' ? 'Thuy·ªÅn b·ªô' : 'Ship Crew'
  };

  const sensitivityNames = {
    public: language === 'vi' ? 'C√¥ng khai' : 'Public',
    internal: language === 'vi' ? 'N·ªôi b·ªô' : 'Internal',
    confidential: language === 'vi' ? 'B√≠ m·∫≠t' : 'Confidential',
    restricted: language === 'vi' ? 'H·∫°n ch·∫ø' : 'Restricted'
  };

  const permissionNames = {
    read: language === 'vi' ? 'Xem' : 'Read',
    write: language === 'vi' ? 'Ghi' : 'Write',
    delete: language === 'vi' ? 'X√≥a' : 'Delete',
    manage_users: language === 'vi' ? 'Qu·∫£n l√Ω ng∆∞·ªùi d√πng' : 'Manage Users',
    system_control: language === 'vi' ? 'ƒêi·ªÅu khi·ªÉn h·ªá th·ªëng' : 'System Control'
  };

  // Check if user is ship crew to show/enable ship dropdown
  const isShipCrew = userData?.department === 'ship_crew';

  // Update user data with permissions when saving
  const handleSubmitWithPermissions = () => {
    setUserData(prev => ({ ...prev, permissions }));
    onSubmit();
  };

  return (
    <div 
      className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]" 
      onClick={handleOverlayClick}
    >
      <div className="bg-white rounded-xl shadow-2xl p-8 max-w-6xl w-full max-h-[95vh] overflow-y-auto mx-4">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-2xl font-bold text-gray-800">
            {language === 'vi' ? 'Ch·ªânh s·ª≠a ng∆∞·ªùi d√πng' : 'Edit User'}
          </h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600 text-2xl leading-none"
          >
            √ó
          </button>
        </div>
        
        <div className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'T√™n ƒëƒÉng nh·∫≠p' : 'Username'} *
              </label>
              <input
                type="text"
                required
                value={userData.username}
                onChange={(e) => setUserData(prev => ({ ...prev, username: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder={language === 'vi' ? 'Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p' : 'Enter username'}
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'H·ªç v√† t√™n' : 'Full Name'} *
              </label>
              <input
                type="text"
                required
                value={userData.full_name}
                onChange={(e) => setUserData(prev => ({ ...prev, full_name: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder={language === 'vi' ? 'Nh·∫≠p h·ªç v√† t√™n' : 'Enter full name'}
              />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
            <input
              type="email"
              value={userData.email}
              onChange={(e) => setUserData(prev => ({ ...prev, email: e.target.value }))}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder={language === 'vi' ? 'Nh·∫≠p email (kh√¥ng b·∫Øt bu·ªôc)' : 'Enter email (optional)'}
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'C√¥ng ty' : 'Company'} *
              </label>
              <select
                required
                value={userData.company || ''}
                onChange={(e) => setUserData(prev => ({ ...prev, company: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="">
                  {language === 'vi' ? 'Ch·ªçn c√¥ng ty' : 'Select company'}
                </option>
                {companies.map(company => (
                  <option key={company.id} value={company.name_vn}>
                    {language === 'vi' ? company.name_vn : company.name_en}
                  </option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'T√†u' : 'Ship'}
                {isShipCrew && <span className="text-red-500"> *</span>}
              </label>
              <select
                required={isShipCrew}
                disabled={!isShipCrew}
                value={isShipCrew ? (userData.ship || '') : ''}
                onChange={(e) => setUserData(prev => ({ ...prev, ship: e.target.value }))}
                className={`w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                  !isShipCrew ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : ''
                }`}
              >
                <option value="">
                  {isShipCrew 
                    ? (language === 'vi' ? 'Ch·ªçn t√†u' : 'Select ship')
                    : (language === 'vi' ? 'Ch·ªâ d√†nh cho Thuy·ªÅn b·ªô' : 'Ship Crew only')
                  }
                </option>
                {isShipCrew && ships.map(ship => (
                  <option key={ship.id} value={ship.name}>
                    {ship.name}
                  </option>
                ))}
              </select>
              {!isShipCrew && (
                <p className="text-xs text-gray-500 mt-1">
                  {language === 'vi' 
                    ? 'Ch·ªâ hi·ªÉn th·ªã khi ch·ªçn ph√≤ng ban "Thuy·ªÅn b·ªô"' 
                    : 'Only available for "Ship Crew" department'}
                </p>
              )}
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {language === 'vi' ? 'Ph√≤ng ban' : 'Department'} *
            </label>
            <select
              required
              value={userData.department || ''}
              onChange={(e) => setUserData(prev => ({ ...prev, department: e.target.value }))}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              {departments.map(dept => (
                <option key={dept} value={dept}>
                  {departmentNames[dept]}
                </option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {language === 'vi' ? 'Vai tr√≤' : 'Role'} *
            </label>
            <select
              required
              value={userData.role}
              onChange={(e) => setUserData(prev => ({ ...prev, role: e.target.value }))}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              {roleOptions.map(option => (
                <option key={option.value} value={option.value}>
                  {option.label}
                </option>
              ))}
            </select>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Zalo *
              </label>
              <input
                type="text"
                required
                value={userData.zalo || ''}
                onChange={(e) => setUserData(prev => ({ ...prev, zalo: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder={language === 'vi' ? 'S·ªë ƒëi·ªán tho·∫°i Zalo (b·∫Øt bu·ªôc)' : 'Zalo phone number (required)'}
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Gmail</label>
              <input
                type="email"
                value={userData.gmail || ''}
                onChange={(e) => setUserData(prev => ({ ...prev, gmail: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder={language === 'vi' ? 'ƒê·ªãa ch·ªâ Gmail (kh√¥ng b·∫Øt bu·ªôc)' : 'Gmail address (optional)'}
              />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {language === 'vi' ? 'M·∫≠t kh·∫©u m·ªõi' : 'New Password'}
            </label>
            <input
              type="password"
              value={userData.password || ''}
              onChange={(e) => setUserData(prev => ({ ...prev, password: e.target.value }))}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder={language === 'vi' ? 'ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng thay ƒë·ªïi' : 'Leave blank if no change'}
            />
            <p className="text-xs text-gray-500 mt-1">
              {language === 'vi' ? 'Ch·ªâ nh·∫≠p n·∫øu mu·ªën thay ƒë·ªïi m·∫≠t kh·∫©u' : 'Only enter if you want to change password'}
            </p>
          </div>

          {/* Permissions Section */}
          <div className="border-t pt-6">
            <h3 className="text-lg font-semibold mb-4 text-gray-800">
              {language === 'vi' ? 'Ph√¢n quy·ªÅn chi ti·∫øt' : 'Detailed Permissions'}
            </h3>
            
            {/* Current Permissions Summary */}
            <div className="mb-6 p-4 bg-gray-50 rounded-lg border">
              <h4 className="font-medium mb-3 text-gray-700">
                {language === 'vi' ? 'Tr·∫°ng th√°i ph√¢n quy·ªÅn hi·ªán t·∫°i:' : 'Current Permission Status:'}
              </h4>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                  <span className="font-medium text-blue-600">
                    {language === 'vi' ? 'Lo·∫°i t√†i li·ªáu:' : 'Categories:'}
                  </span>
                  <div className="text-gray-600">
                    {permissions.categories.length > 0 
                      ? permissions.categories.map(cat => categoryNames[cat]).join(', ')
                      : (language === 'vi' ? 'Ch∆∞a c√≥' : 'None')
                    }
                  </div>
                </div>
                <div>
                  <span className="font-medium text-green-600">
                    {language === 'vi' ? 'Ph√≤ng ban:' : 'Departments:'}
                  </span>
                  <div className="text-gray-600">
                    {permissions.departments.length > 0 
                      ? permissions.departments.map(dept => departmentNames[dept]).join(', ')
                      : (language === 'vi' ? 'Ch∆∞a c√≥' : 'None')
                    }
                  </div>
                </div>
                <div>
                  <span className="font-medium text-orange-600">
                    {language === 'vi' ? 'M·ª©c b·∫£o m·∫≠t:' : 'Security:'}
                  </span>
                  <div className="text-gray-600">
                    {permissions.sensitivity_levels.length > 0 
                      ? permissions.sensitivity_levels.map(level => sensitivityNames[level]).join(', ')
                      : (language === 'vi' ? 'Ch∆∞a c√≥' : 'None')
                    }
                  </div>
                </div>
                <div>
                  <span className="font-medium text-purple-600">
                    {language === 'vi' ? 'Quy·ªÅn h·∫°n:' : 'Permissions:'}
                  </span>
                  <div className="text-gray-600">
                    {permissions.permissions.length > 0 
                      ? permissions.permissions.map(perm => permissionNames[perm]).join(', ')
                      : (language === 'vi' ? 'Ch∆∞a c√≥' : 'None')
                    }
                  </div>
                </div>
              </div>
            </div>
            
            <div className="grid md:grid-cols-2 gap-6">
              {/* Document Categories */}
              <div>
                <h4 className="font-medium mb-3 text-gray-700 flex items-center justify-between">
                  <span>{language === 'vi' ? 'Lo·∫°i t√†i li·ªáu' : 'Document Categories'}</span>
                  <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">
                    {permissions.categories.length}/{categories.length}
                  </span>
                </h4>
                <div className="space-y-2 max-h-32 overflow-y-auto">
                  {categories.map(cat => (
                    <label key={cat} className="flex items-center">
                      <input
                        type="checkbox"
                        checked={permissions.categories.includes(cat)}
                        onChange={(e) => {
                          const newCats = e.target.checked
                            ? [...permissions.categories, cat]
                            : permissions.categories.filter(c => c !== cat);
                          setPermissions(prev => ({ ...prev, categories: newCats }));
                        }}
                        className="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                      />
                      <span className="text-sm">{categoryNames[cat]}</span>
                    </label>
                  ))}
                </div>
              </div>

              {/* Departments */}
              <div>
                <h4 className="font-medium mb-3 text-gray-700 flex items-center justify-between">
                  <span>{language === 'vi' ? 'Ph√≤ng ban' : 'Departments'}</span>
                  <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">
                    {permissions.departments.length}/{departments.length}
                  </span>
                </h4>
                <div className="space-y-2">
                  {departments.map(dept => (
                    <label key={dept} className="flex items-center">
                      <input
                        type="checkbox"
                        checked={permissions.departments.includes(dept)}
                        onChange={(e) => {
                          const newDepts = e.target.checked
                            ? [...permissions.departments, dept]
                            : permissions.departments.filter(d => d !== dept);
                          setPermissions(prev => ({ ...prev, departments: newDepts }));
                        }}
                        className="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                      />
                      <span className="text-sm">{departmentNames[dept]}</span>
                    </label>
                  ))}
                </div>
              </div>

              {/* Sensitivity Levels */}
              <div>
                <h4 className="font-medium mb-3 text-gray-700 flex items-center justify-between">
                  <span>{language === 'vi' ? 'M·ª©c ƒë·ªô b·∫£o m·∫≠t' : 'Sensitivity Levels'}</span>
                  <span className="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full">
                    {permissions.sensitivity_levels.length}/{sensitivityLevels.length}
                  </span>
                </h4>
                <div className="space-y-2">
                  {sensitivityLevels.map(level => (
                    <label key={level} className="flex items-center">
                      <input
                        type="checkbox"
                        checked={permissions.sensitivity_levels.includes(level)}
                        onChange={(e) => {
                          const newLevels = e.target.checked
                            ? [...permissions.sensitivity_levels, level]
                            : permissions.sensitivity_levels.filter(l => l !== level);
                          setPermissions(prev => ({ ...prev, sensitivity_levels: newLevels }));
                        }}
                        className="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                      />
                      <span className="text-sm">{sensitivityNames[level]}</span>
                    </label>
                  ))}
                </div>
              </div>

              {/* Permission Types */}
              <div>
                <h4 className="font-medium mb-3 text-gray-700 flex items-center justify-between">
                  <span>{language === 'vi' ? 'Lo·∫°i quy·ªÅn' : 'Permission Types'}</span>
                  <span className="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full">
                    {permissions.permissions.length}/{permissionTypes.length}
                  </span>
                </h4>
                <div className="space-y-2">
                  {permissionTypes.map(perm => (
                    <label key={perm} className="flex items-center">
                      <input
                        type="checkbox"
                        checked={permissions.permissions.includes(perm)}
                        onChange={(e) => {
                          const newPerms = e.target.checked
                            ? [...permissions.permissions, perm]
                            : permissions.permissions.filter(p => p !== perm);
                          setPermissions(prev => ({ ...prev, permissions: newPerms }));
                        }}
                        className="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                      />
                      <span className="text-sm">{permissionNames[perm]}</span>
                    </label>
                  ))}
                </div>
              </div>
            </div>

            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mt-4">
              <p className="text-sm text-yellow-700">
                {language === 'vi' 
                  ? 'üí° Quy·ªÅn chi ti·∫øt n√†y s·∫Ω ƒë∆∞·ª£c √°p d·ª•ng ngo√†i quy·ªÅn c∆° b·∫£n c·ªßa vai tr√≤ ƒë∆∞·ª£c ch·ªçn.' 
                  : 'üí° These detailed permissions will be applied in addition to the basic role permissions.'}
              </p>
            </div>
          </div>

          <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h4 className="font-medium text-blue-800 mb-2">
              {language === 'vi' ? 'L∆∞u √Ω:' : 'Note:'}
            </h4>
            <ul className="text-sm text-blue-700 space-y-1">
              <li>‚Ä¢ {language === 'vi' ? 'C√°c tr∆∞·ªùng c√≥ d·∫•u (*) l√† b·∫Øt bu·ªôc' : 'Fields marked with (*) are required'}</li>
              <li>‚Ä¢ {language === 'vi' ? 'Thay ƒë·ªïi vai tr√≤ s·∫Ω ·∫£nh h∆∞·ªüng ƒë·∫øn quy·ªÅn truy c·∫≠p' : 'Role changes will affect access permissions'}</li>
              <li>‚Ä¢ {language === 'vi' ? 'ƒê·ªÉ tr·ªëng m·∫≠t kh·∫©u n·∫øu kh√¥ng mu·ªën thay ƒë·ªïi' : 'Leave password blank if no change needed'}</li>
              <li>‚Ä¢ {language === 'vi' ? 'Ph√¢n quy·ªÅn chi ti·∫øt s·∫Ω b·ªï sung cho quy·ªÅn vai tr√≤ c∆° b·∫£n' : 'Detailed permissions supplement basic role permissions'}</li>
            </ul>
          </div>
        </div>

        <div className="flex justify-end space-x-4 mt-8">
          <button
            onClick={onClose}
            className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all"
          >
            {language === 'vi' ? 'H·ªßy' : 'Cancel'}
          </button>
          <button
            onClick={handleSubmitWithPermissions}
            className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all"
          >
            {language === 'vi' ? 'C·∫≠p nh·∫≠t' : 'Update'}
          </button>
        </div>
      </div>
    </div>
  );
};

// Add User Modal Component
const AddUserModal = ({ userData, setUserData, onClose, onSubmit, language, companies, ships }) => {
  const handleOverlayClick = (e) => {
    if (e.target === e.currentTarget) {
      onClose();
    }
  };

  const roleOptions = [
    { value: 'viewer', label: language === 'vi' ? 'Thuy·ªÅn vi√™n' : 'Crew' },
    { value: 'editor', label: language === 'vi' ? 'Sƒ© quan' : 'Ship Officer' },
    { value: 'manager', label: language === 'vi' ? 'C√°n b·ªô c√¥ng ty' : 'Company Officer' },
    { value: 'admin', label: language === 'vi' ? 'Qu·∫£n tr·ªã vi√™n' : 'Admin' },
    { value: 'super_admin', label: language === 'vi' ? 'Si√™u qu·∫£n tr·ªã' : 'Super Admin' }
  ];

  const departmentOptions = [
    { value: 'technical', label: language === 'vi' ? 'K·ªπ thu·∫≠t' : 'Technical' },
    { value: 'operations', label: language === 'vi' ? 'V·∫≠n h√†nh' : 'Operations' },
    { value: 'safety', label: language === 'vi' ? 'An to√†n' : 'Safety' },
    { value: 'commercial', label: language === 'vi' ? 'Th∆∞∆°ng m·∫°i' : 'Commercial' },
    { value: 'crewing', label: language === 'vi' ? 'Thuy·ªÅn vi√™n' : 'Crewing' },
    { value: 'ship_crew', label: language === 'vi' ? 'Thuy·ªÅn b·ªô' : 'Ship Crew' }
  ];

  // Check if user is ship crew to show/enable ship dropdown
  const isShipCrew = userData.department === 'ship_crew';

  return (
    <div 
      className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]" 
      onClick={handleOverlayClick}
    >
      <div className="bg-white rounded-xl shadow-2xl p-8 max-w-6xl w-full max-h-[95vh] overflow-y-auto mx-4">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-2xl font-bold text-gray-800">
            {language === 'vi' ? 'Th√™m ng∆∞·ªùi d√πng m·ªõi' : 'Add New User'}
          </h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600 text-2xl leading-none"
          >
            √ó
          </button>
        </div>
        
        <div className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'T√™n ƒëƒÉng nh·∫≠p' : 'Username'} *
              </label>
              <input
                type="text"
                required
                value={userData.username}
                onChange={(e) => setUserData(prev => ({ ...prev, username: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder={language === 'vi' ? 'Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p' : 'Enter username'}
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'H·ªç v√† t√™n' : 'Full Name'} *
              </label>
              <input
                type="text"
                required
                value={userData.full_name}
                onChange={(e) => setUserData(prev => ({ ...prev, full_name: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder={language === 'vi' ? 'Nh·∫≠p h·ªç v√† t√™n' : 'Enter full name'}
              />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
            <input
              type="email"
              value={userData.email}
              onChange={(e) => setUserData(prev => ({ ...prev, email: e.target.value }))}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder={language === 'vi' ? 'Nh·∫≠p email (kh√¥ng b·∫Øt bu·ªôc)' : 'Enter email (optional)'}
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {language === 'vi' ? 'M·∫≠t kh·∫©u' : 'Password'} *
            </label>
            <input
              type="password"
              required
              value={userData.password}
              onChange={(e) => setUserData(prev => ({ ...prev, password: e.target.value }))}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder={language === 'vi' ? 'Nh·∫≠p m·∫≠t kh·∫©u' : 'Enter password'}
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'C√¥ng ty' : 'Company'} *
              </label>
              <select
                required
                value={userData.company || ''}
                onChange={(e) => setUserData(prev => ({ ...prev, company: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="">
                  {language === 'vi' ? 'Ch·ªçn c√¥ng ty' : 'Select company'}
                </option>
                {companies.map(company => (
                  <option key={company.id} value={company.name_vn}>
                    {language === 'vi' ? company.name_vn : company.name_en}
                  </option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'T√†u' : 'Ship'}
                {isShipCrew && <span className="text-red-500"> *</span>}
              </label>
              <select
                required={isShipCrew}
                disabled={!isShipCrew}
                value={isShipCrew ? (userData.ship || '') : ''}
                onChange={(e) => setUserData(prev => ({ ...prev, ship: e.target.value }))}
                className={`w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                  !isShipCrew ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : ''
                }`}
              >
                <option value="">
                  {isShipCrew 
                    ? (language === 'vi' ? 'Ch·ªçn t√†u' : 'Select ship')
                    : (language === 'vi' ? 'Ch·ªâ d√†nh cho Thuy·ªÅn b·ªô' : 'Ship Crew only')
                  }
                </option>
                {isShipCrew && ships.map(ship => (
                  <option key={ship.id} value={ship.name}>
                    {ship.name}
                  </option>
                ))}
              </select>
              {!isShipCrew && (
                <p className="text-xs text-gray-500 mt-1">
                  {language === 'vi' 
                    ? 'Ch·ªâ hi·ªÉn th·ªã khi ch·ªçn ph√≤ng ban "Thuy·ªÅn b·ªô"' 
                    : 'Only available for "Ship Crew" department'}
                </p>
              )}
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {language === 'vi' ? 'Ph√≤ng ban' : 'Department'} *
            </label>
            <select
              required
              value={userData.department}
              onChange={(e) => setUserData(prev => ({ ...prev, department: e.target.value }))}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              {departmentOptions.map(option => (
                <option key={option.value} value={option.value}>
                  {option.label}
                </option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {language === 'vi' ? 'Vai tr√≤' : 'Role'} *
            </label>
            <select
              required
              value={userData.role}
              onChange={(e) => setUserData(prev => ({ ...prev, role: e.target.value }))}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              {roleOptions.map(option => (
                <option key={option.value} value={option.value}>
                  {option.label}
                </option>
              ))}
            </select>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Zalo *
              </label>
              <input
                type="text"
                required
                value={userData.zalo || ''}
                onChange={(e) => setUserData(prev => ({ ...prev, zalo: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder={language === 'vi' ? 'S·ªë ƒëi·ªán tho·∫°i Zalo (b·∫Øt bu·ªôc)' : 'Zalo phone number (required)'}
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Gmail</label>
              <input
                type="email"
                value={userData.gmail || ''}
                onChange={(e) => setUserData(prev => ({ ...prev, gmail: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder={language === 'vi' ? 'ƒê·ªãa ch·ªâ Gmail (kh√¥ng b·∫Øt bu·ªôc)' : 'Gmail address (optional)'}
              />
            </div>
          </div>

          <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h4 className="font-medium text-blue-800 mb-2">
              {language === 'vi' ? 'L∆∞u √Ω:' : 'Note:'}
            </h4>
            <ul className="text-sm text-blue-700 space-y-1">
              <li>‚Ä¢ {language === 'vi' ? 'T·∫•t c·∫£ tr∆∞·ªùng c√≥ d·∫•u (*) l√† b·∫Øt bu·ªôc' : 'All fields with (*) are required'}</li>
              <li>‚Ä¢ {language === 'vi' ? 'Ng∆∞·ªùi d√πng m·ªõi s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng tin ƒëƒÉng nh·∫≠p qua email' : 'New user will receive login credentials via email'}</li>
            </ul>
          </div>
        </div>

        <div className="flex justify-end space-x-4 mt-8">
          <button
            onClick={onClose}
            className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all"
          >
            {language === 'vi' ? 'H·ªßy' : 'Cancel'}
          </button>
          <button
            onClick={onSubmit}
            className="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-all"
          >
            {language === 'vi' ? 'T·∫°o ng∆∞·ªùi d√πng' : 'Create User'}
          </button>
        </div>
      </div>
    </div>
  );
};

// Add Record Modal Component
const AddRecordModal = ({ 
  onClose, 
  onSuccess, 
  language, 
  selectedShip, 
  setSelectedShip,
  availableCompanies, 
  ships,
  setShips, 
  fetchCertificates,
  parentAiConfig,
  isMultiCertProcessing,
  multiCertUploads,
  handleMultiCertUpload,
  uploadSummary,
  setMultiCertUploads,
  setUploadSummary,
  handleUploadToFolder,
  handleSkipFile,
  defaultTab,
  defaultDocumentType,
  duplicateQueue,
  // File Viewer Modal props
  showFileViewer,
  setShowFileViewer,
  fileViewerData,
  setFileViewerData,
  pendingManualReviews,
  handleManualReviewAction,
  duplicateResolutionModal,
  handleDuplicateResolution,
  setIsMultiCertProcessing
}) => {
  const API = `${process.env.REACT_APP_BACKEND_URL}/api`;
  const { user, token } = useAuth();
  
  
  // Tab structure for Add New Record
  const tabs = [
    { key: 'ship', name: language === 'vi' ? 'T√†u' : 'Ship', icon: 'üö¢' },
    { key: 'documents', name: language === 'vi' ? 'H·ªì s∆° t√†i li·ªáu' : 'Class & Flag Cert', icon: 'üìÅ' },
    { key: 'crew', name: language === 'vi' ? 'Thuy·ªÅn vi√™n' : 'Crew Records', icon: 'üë•' },
    { key: 'ism', name: language === 'vi' ? 'H·ªì s∆° ISM' : 'ISM Records', icon: 'üìã' },
    { key: 'isps', name: language === 'vi' ? 'H·ªì s∆° ISPS' : 'ISPS Records', icon: 'üõ°Ô∏è' },
    { key: 'mlc', name: language === 'vi' ? 'H·ªì s∆° MLC' : 'MLC Records', icon: '‚öñÔ∏è' },
    { key: 'supplies', name: language === 'vi' ? 'V·∫≠t t∆∞' : 'Supplies', icon: 'üì¶' }
  ];

  const [activeTab, setActiveTab] = useState(() => {
    // Use defaultTab if provided, otherwise use role-based logic  
    if (defaultTab) {
      return defaultTab;
    }
    // Default to 'documents' if user can't create ships
    const allowedRoles = ['manager', 'admin', 'super_admin'];
    return allowedRoles.includes(user?.role) ? 'ship' : 'documents';
  });

  // Document type selection state - use defaultDocumentType if provided
  const [selectedDocumentType, setSelectedDocumentType] = useState(defaultDocumentType || '');
  
  // Update selectedDocumentType when defaultDocumentType changes
  useEffect(() => {
    if (defaultDocumentType) {
      setSelectedDocumentType(defaultDocumentType);
    }
  }, [defaultDocumentType]);
  
  // File upload state for Certificate
  const [showFileUpload, setShowFileUpload] = useState(false);
  const [uploadingFile, setUploadingFile] = useState(false);
  const [selectedFile, setSelectedFile] = useState(null);
  
  // Ship selection dropdown state
  const [showShipDropdown, setShowShipDropdown] = useState(false);
  
  // For backward compatibility, map activeTab to recordType
  const recordType = selectedDocumentType || (activeTab === 'documents' ? 'certificate' : activeTab);
  // PDF Analysis state
  const [showPdfAnalysis, setShowPdfAnalysis] = useState(false);
  const [pdfFile, setPdfFile] = useState(null);
  const [pdfAnalyzing, setPdfAnalyzing] = useState(false);
  const [shipData, setShipData] = useState({
    name: '',
    imo_number: '',
    class_society: '',
    flag: '',
    gross_tonnage: '',
    deadweight: '',
    built_year: '',
    ship_owner: '',
    company: user?.company || '' // Auto-fill with user's company
  });
  const [certificateData, setCertificateData] = useState({
    ship_id: selectedShip?.id || '',
    cert_name: '',
    cert_abbreviation: '', // T√™n vi·∫øt t·∫Øt
    cert_no: '',
    cert_type: 'Full Term', // Lo·∫°i ch·ª©ng ch·ªâ
    issue_date: '',
    valid_date: '', // B√¢y gi·ªù l√† dropdown option
    custom_valid_date: '', // Cho tr∆∞·ªùng h·ª£p ch·ªçn custom date
    last_endorse: '',
    next_survey: '',
    next_survey_type: '', // ƒê√£ c√≥ nh∆∞ng th√™m v√†o state
    issued_by: '', // C·∫•p b·ªüi
    status: 'valid', // Tr·∫°ng th√°i
    notes: '', // Ghi ch√∫
    category: 'certificates',
    sensitivity_level: 'internal'
  });
  
  // Certificate file upload states for AddRecordModal  
  const [certificateFile, setCertificateFile] = useState(null);
  const [isCertificateAnalyzing, setIsCertificateAnalyzing] = useState(false);

  // Handle certificate file upload and auto-fill
  const handleCertificateFileUpload = async (file) => {
    try {
      if (!file) return;
      
      setCertificateFile(file);
      setIsCertificateAnalyzing(true);
      
      // Prepare form data for analysis
      const formData = new FormData();
      formData.append('files', file);
      
      if (!selectedShip?.id) {
        toast.error(language === 'vi' 
          ? '‚ùå Vui l√≤ng ch·ªçn t√†u tr∆∞·ªõc khi upload certificate'
          : '‚ùå Please select a ship before uploading certificate'
        );
        setIsCertificateAnalyzing(false);
        return;
      }
      
      // Use multi-upload endpoint for certificate analysis
      const response = await axios.post(`${API}/certificates/multi-upload?ship_id=${selectedShip.id}`, formData, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'multipart/form-data'
        }
      });
      
      if (response.data && response.data.results && response.data.results.length > 0) {
        const result = response.data.results[0];
        
        if (result.status === 'success' && result.analysis) {
          // Auto-fill certificate form with analysis data
          console.log('üéØ Certificate analysis successful:', result.analysis);
          
          // Map analysis data to certificate form fields
          const analysisData = result.analysis;
          
          // Helper function to format dates for certificate form (inside AddRecordModal)
          const formatCertDate = (dateStr) => {
            if (!dateStr || typeof dateStr !== 'string') return '';
            
            // Handle DD/MM/YYYY format
            if (dateStr.includes('/')) {
              const parts = dateStr.split('/');
              if (parts.length === 3) {
                const [day, month, year] = parts;
                if (day && month && year && year.length === 4) {
                  return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }
              }
            }
            
            // Handle YYYY-MM-DD format
            const isoPattern = /^\d{4}-\d{2}-\d{2}$/;
            if (isoPattern.test(dateStr.trim())) {
              return dateStr.trim();
            }
            
            // Handle ISO datetime
            if (dateStr.includes('T') || dateStr.includes('Z')) {
              const date = new Date(dateStr);
              if (!isNaN(date.getTime())) {
                const year = date.getUTCFullYear();
                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                const day = String(date.getUTCDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
              }
            }
            
            return '';
          };
          
          const autoFillData = {
            cert_name: analysisData.cert_name || analysisData.certificate_name || '',
            cert_no: analysisData.cert_no || analysisData.certificate_number || '',
            issue_date: formatCertDate(analysisData.issue_date),
            valid_date: formatCertDate(analysisData.valid_date || analysisData.expiry_date),
            issued_by: analysisData.issued_by || '',
            ship_id: selectedShip.id,
            category: 'certificates',
            sensitivity_level: 'internal'
          };
          
          // Filter out empty values
          const filledFields = Object.keys(autoFillData).filter(key => 
            autoFillData[key] && String(autoFillData[key]).trim()
          ).length;
          
          console.log('üìã Auto-filling certificate form with', filledFields, 'fields');
          
          // Update certificate form data - CRITICAL FIX
          setCertificateData(prev => ({
            ...prev,
            ...autoFillData
          }));
          
          // Show success message
          toast.success(language === 'vi' 
            ? `‚úÖ Ph√¢n t√≠ch certificate th√†nh c√¥ng! ƒê√£ ƒëi·ªÅn ${filledFields} tr∆∞·ªùng th√¥ng tin.`
            : `‚úÖ Certificate analysis successful! Auto-filled ${filledFields} fields.`
          );
          
        } else if (result.status === 'error') {
          toast.error(language === 'vi' 
            ? `‚ùå L·ªói ph√¢n t√≠ch certificate: ${result.message}`
            : `‚ùå Certificate analysis error: ${result.message}`
          );
        } else {
          toast.warning(language === 'vi' 
            ? '‚ö†Ô∏è Kh√¥ng th·ªÉ tr√≠ch xu·∫•t ƒë·∫ßy ƒë·ªß th√¥ng tin t·ª´ certificate'
            : '‚ö†Ô∏è Could not extract complete information from certificate'
          );
        }
      } else {
        toast.error(language === 'vi' 
          ? '‚ùå Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ server'
          : '‚ùå No response received from server'
        );
      }
      
    } catch (error) {
      console.error('Certificate analysis error:', error);
      toast.error(language === 'vi' 
        ? `‚ùå L·ªói ph√¢n t√≠ch certificate: ${error.response?.data?.detail || error.message}`
        : `‚ùå Certificate analysis error: ${error.response?.data?.detail || error.message}`
      );
    } finally {
      setIsCertificateAnalyzing(false);
    }
  };
  const [aiConfig, setAiConfig] = useState(null);
  const [showShipConfirmModal, setShowShipConfirmModal] = useState(false);
  const [pendingShipData, setPendingShipData] = useState(null);
  const [documentData, setDocumentData] = useState({
    title: '',
    category: 'other_documents',
    description: '',
    file: null
  });
  const [isSubmitting, setIsSubmitting] = useState(false);
  // Duplicate and mismatch modal states for AddRecordModal
  const [duplicateModal, setDuplicateModal] = useState({
    show: false,
    duplicates: [],
    currentFile: null,
    analysisResult: null,
    uploadResult: null,
    status: 'all'
  });
  const [mismatchModal, setMismatchModal] = useState({
    show: false,
    mismatchInfo: null,
    analysisResult: null,
    uploadResult: null
  });

  // Check if user can create ships (Company Officer role and above)
  const canCreateShip = () => {
    const allowedRoles = ['manager', 'admin', 'super_admin'];
    return allowedRoles.includes(user?.role);
  };
  // Multi-file upload functions will be rebuilt from scratch
  const handleLocalDuplicateResolution = (action) => {
    toast.info(language === 'vi' ? 'Ch·ª©c nƒÉng ƒëang ƒë∆∞·ª£c x√¢y d·ª±ng l·∫°i' : 'Feature is being rebuilt');
  };

  const handleMismatchResolution = (action) => {
    toast.info(language === 'vi' ? 'Ch·ª©c nƒÉng ƒëang ƒë∆∞·ª£c x√¢y d·ª±ng l·∫°i' : 'Feature is being rebuilt');
  };

  // Helper function to format date from DD/MM/YYYY to YYYY-MM-DD for HTML date inputs
  const convertLastDockingToDateTime = (mmYyyyString) => {
    if (!mmYyyyString || typeof mmYyyyString !== 'string') return null;
    
    try {
      // Handle MM/YYYY format (convert to first day of the month)
      const mmYyyyPattern = /^\d{1,2}\/\d{4}$/;
      if (mmYyyyPattern.test(mmYyyyString.trim())) {
        const [month, year] = mmYyyyString.trim().split('/');
        const paddedMonth = month.padStart(2, '0');
        // Convert to ISO datetime (first day of the month)
        return `${year}-${paddedMonth}-01T00:00:00Z`;
      }
      
      // If it's already a full date format, return as is
      if (mmYyyyString.includes('-') || mmYyyyString.includes('T')) {
        return mmYyyyString;
      }
      
      // If it's DD/MM/YYYY format, convert to ISO
      const ddMmYyyyPattern = /^\d{1,2}\/\d{1,2}\/\d{4}$/;
      if (ddMmYyyyPattern.test(mmYyyyString.trim())) {
        const [day, month, year] = mmYyyyString.trim().split('/');
        const paddedDay = day.padStart(2, '0');
        const paddedMonth = month.padStart(2, '0');
        return `${year}-${paddedMonth}-${paddedDay}T00:00:00Z`;
      }
      
      return null;
    } catch (error) {
      console.error('Error converting last docking date:', error);
      return null;
    }
  };

  // Helper function to convert passport date format (DD/MM/YYYY) to HTML date input format (YYYY-MM-DD)
  const convertPassportDateToInputFormat = (dateString) => {
    if (!dateString || typeof dateString !== 'string') return '';
    
    try {
      const trimmedDate = dateString.trim();
      
      // Handle DD/MM/YYYY format from Document AI passport analysis
      const ddmmyyyyPattern = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;
      const ddmmMatch = ddmmyyyyPattern.exec(trimmedDate);
      if (ddmmMatch) {
        const day = ddmmMatch[1].padStart(2, '0');
        const month = ddmmMatch[2].padStart(2, '0');
        const year = ddmmMatch[3];
        return `${year}-${month}-${day}`;  // Return YYYY-MM-DD for HTML date input
      }
      
      // Handle YYYY-MM-DD format (already correct)
      const yyyymmddPattern = /^(\d{4})-(\d{1,2})-(\d{1,2})$/;
      const yyyymmMatch = yyyymmddPattern.exec(trimmedDate);
      if (yyyymmMatch) {
        const year = yyyymmMatch[1];
        const month = yyyymmMatch[2].padStart(2, '0');
        const day = yyyymmMatch[3].padStart(2, '0');
        return `${year}-${month}-${day}`;
      }
      
      console.warn('Unsupported passport date format:', dateString);
      return '';
    } catch (error) {
      console.error('Error converting passport date to input format:', error);
      return '';
    }
  };

  // Helper function to convert date input (YYYY-MM-DD) to UTC ISO datetime
  const convertDateInputToUTC = (dateString) => {
    if (!dateString || typeof dateString !== 'string') return null;
    
    try {
      const trimmedDate = dateString.trim();
      
      // Handle YYYY-MM-DD format from HTML date inputs
      const isoPattern = /^\d{4}-\d{2}-\d{2}$/;
      if (isoPattern.test(trimmedDate)) {
        return `${trimmedDate}T00:00:00Z`;
      }
      
      // Handle DD/MM/YYYY format from Document AI passport analysis
      const ddmmyyyyPattern = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;
      const ddmmMatch = ddmmyyyyPattern.exec(trimmedDate);
      if (ddmmMatch) {
        const day = ddmmMatch[1].padStart(2, '0');
        const month = ddmmMatch[2].padStart(2, '0');
        const year = ddmmMatch[3];
        return `${year}-${month}-${day}T00:00:00Z`;
      }
      
      // Handle YYYY-MM-DD format from backend responses
      const yyyymmddPattern = /^(\d{4})-(\d{1,2})-(\d{1,2})$/;
      const yyyymmMatch = yyyymmddPattern.exec(trimmedDate);
      if (yyyymmMatch) {
        const year = yyyymmMatch[1];
        const month = yyyymmMatch[2].padStart(2, '0');
        const day = yyyymmMatch[3].padStart(2, '0');
        return `${year}-${month}-${day}T00:00:00Z`;
      }
      
      console.warn('Unsupported date format:', dateString);
      return null;
    } catch (error) {
      console.error('Error converting date input to UTC:', error);
      return null;
    }
  };

  const formatLastDockingForDisplay = (dateString) => {
    if (!dateString || typeof dateString !== 'string') return '';
    
    try {
      // Check if it's month/year only format (like "NOV 2020", "DEC. 2022")
      const monthYearPattern = /^[A-Z]{3,4}\.?\s+\d{4}$/i;
      if (monthYearPattern.test(dateString.trim())) {
        // Convert month name to number
        const parts = dateString.trim().split(/\s+/);
        const monthName = parts[0].replace('.', '').toUpperCase();
        const year = parts[1];
        
        const monthMap = {
          'JAN': '01', 'FEB': '02', 'MAR': '03', 'APR': '04', 'MAY': '05', 'JUN': '06',
          'JUL': '07', 'AUG': '08', 'SEP': '09', 'OCT': '10', 'NOV': '11', 'DEC': '12'
        };
        
        if (monthMap[monthName]) {
          return `${monthMap[monthName]}/${year}`;
        }
      }
      
      // Check if it's MM/YYYY format - return as is
      const mmYyyyPattern = /^\d{1,2}\/\d{4}$/;
      if (mmYyyyPattern.test(dateString.trim())) {
        const [month, year] = dateString.split('/');
        const paddedMonth = month.padStart(2, '0');
        return `${paddedMonth}/${year}`;
      }
      
      // If it's a full date (DD/MM/YYYY), preserve the full date format
      if (dateString.includes('/')) {
        const parts = dateString.split('/');
        if (parts.length === 3) {
          const [day, month, year] = parts;
          if (year && year.length === 4) {
            // Preserve full date format DD/MM/YYYY
            const paddedDay = day.padStart(2, '0');
            const paddedMonth = month.padStart(2, '0');
            return `${paddedDay}/${paddedMonth}/${year}`;
          }
        }
      }
      
      // Handle ISO date format - preserve full date
      const date = new Date(dateString);
      if (!isNaN(date.getTime())) {
        const day = date.getUTCDate().toString().padStart(2, '0');
        const month = (date.getUTCMonth() + 1).toString().padStart(2, '0');
        const year = date.getUTCFullYear();
        // Return full date format DD/MM/YYYY instead of MM/YYYY
        return `${day}/${month}/${year}`;
      }
      
      return dateString; // Return as is if cannot parse
    } catch (error) {
      console.error('Error formatting last docking date:', error);
      return dateString;
    }
  };

  const formatDateForInput = (dateString) => {
    if (!dateString || typeof dateString !== 'string') return '';
    
    try {
      // Handle DD/MM/YYYY format (from AI extraction)
      if (dateString.includes('/')) {
        const parts = dateString.split('/');
        if (parts.length === 3) {
          const [day, month, year] = parts;
          // Validate parts
          if (day && month && year && year.length === 4) {
            const paddedDay = day.padStart(2, '0');
            const paddedMonth = month.padStart(2, '0');
            return `${year}-${paddedMonth}-${paddedDay}`;
          }
        }
      }
      
      // Handle YYYY-MM-DD format directly (from AI ISO format) - NO timezone conversion needed
      const isoPattern = /^\d{4}-\d{2}-\d{2}$/;
      if (isoPattern.test(dateString.trim())) {
        return dateString.trim(); // Return as-is, perfect for HTML date input
      }
      
      // Handle ISO datetime format (YYYY-MM-DDTHH:mm:ss or with Z/timezone)
      if (dateString.includes('T') || dateString.includes('Z')) {
        const date = new Date(dateString);
        if (!isNaN(date.getTime())) {
          // Use UTC methods to prevent timezone shifts
          const year = date.getUTCFullYear();
          const month = String(date.getUTCMonth() + 1).padStart(2, '0');
          const day = String(date.getUTCDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
        }
      }
      
      return '';
    } catch (error) {
      console.warn('Date formatting error:', error, 'for date:', dateString);
      return '';
    }
  };

  const handlePdfAnalysis = async () => {
    if (!pdfFile) {
      toast.error(language === 'vi' ? 'Vui l√≤ng ch·ªçn file PDF!' : 'Please select a PDF file!');
      return;
    }

    setPdfAnalyzing(true);
    try {
      const formData = new FormData();
      formData.append('file', pdfFile);

      const response = await axios.post(`${API}/analyze-ship-certificate`, formData, {
        headers: {
          // Content-Type is automatically set by axios for FormData with proper boundary
        }
      });

      if (response.data.success) {
        // Debug: Log the complete response structure
        console.log('=== PDF ANALYSIS RESPONSE ===');
        console.log('Full response:', response);
        console.log('Response data:', response.data);
        console.log('Analysis data:', response.data.analysis);
        console.log('============================');
        
        // Check if analysis contains error information
        const analysisData = response.data.analysis || {};
        if (analysisData?.error) {
          toast.error(language === 'vi' 
            ? `‚ùå Ph√¢n t√≠ch th·∫•t b·∫°i: ${analysisData.error}`
            : `‚ùå Analysis failed: ${analysisData.error}`
          );
          return;
        }
        
        // Check if we have meaningful extracted data - RELAXED VALIDATION
        const validFields = Object.keys(analysisData).filter(key => {
          const value = analysisData[key];
          return value && 
                 String(value).trim() && 
                 String(value).toLowerCase() !== 'null' &&
                 String(value).toLowerCase() !== 'undefined' &&
                 !['confidence', 'processing_notes', 'error', 'processing_method', 'engine_used'].includes(key);
        });
        
        console.log('üìä Valid extracted fields:', validFields);
        console.log('üìä Analysis data structure:', JSON.stringify(analysisData, null, 2));
        
        // Debug specific expected fields
        const expectedFields = ['ship_name', 'imo_number', 'flag', 'class_society', 'gross_tonnage'];
        expectedFields.forEach(field => {
          console.log(`üîç ${field}: "${analysisData[field]}" (type: ${typeof analysisData[field]})`);
        });
        
        if (validFields.length === 0) {
          toast.warning(language === 'vi' 
            ? '‚ö†Ô∏è Kh√¥ng th·ªÉ tr√≠ch xu·∫•t th√¥ng tin t·ª´ PDF. Vui l√≤ng nh·∫≠p th·ªß c√¥ng.'
            : '‚ö†Ô∏è Could not extract information from PDF. Please enter manually.'
          );
          return;
        }
        
        // Auto-fill ship data with extracted information - FORCE UPDATE
        console.log('üìã Processing extracted data for auto-fill');
        
        // Convert extracted data to match frontend form field names
        // Enhanced to support ALL Ship Creation Form fields
        
        // SPECIAL LOGIC: For Full Term Class/Statutory certificates, use valid_date as special_survey_to_date
        // if special_survey_to_date is not explicitly provided by AI
        // Applies to: CSSC, CSSE, CSSR, IOPP, IAPP, ISPP, LL, CL, IMSBC, IMDG, and other statutory certificates
        let specialSurveyToDate = analysisData.special_survey_to_date;
        if (!specialSurveyToDate && analysisData.valid_date) {
          const certName = (analysisData.cert_name || '').toLowerCase();
          
          // List of Full Term Class/Statutory Certificate keywords
          // Only certificates with 5-year Special Survey Cycle validity
          const fullTermCertificates = [
            // Safety Certificates (SOLAS) - 5-year validity
            'cargo ship safety construction', 'cssc',
            'cargo ship safety equipment', 'csse',
            'cargo ship safety radio', 'cssr',
            'passenger ship safety', 
            
            // Pollution Prevention Certificates (MARPOL) - 5-year validity
            'international oil pollution prevention', 'iopp',
            'international air pollution prevention', 'iapp',
            'international sewage pollution prevention', 'ispp',
            
            // Load Line - 5-year validity
            'load line', 'll certificate',
            
            // Class Certificates - typically 5-year validity
            'class certificate', 'classification certificate',
            
            // Cargo Certificates - 5-year validity
            'international maritime solid bulk', 'imsbc',
            'international maritime dangerous goods', 'imdg'
          ];
          
          // Check if certificate name matches any Full Term certificate type
          const isFullTermCertificate = fullTermCertificates.some(keyword => 
            certName.includes(keyword)
          );
          
          if (isFullTermCertificate) {
            console.log('üîç Detected Full Term Class/Statutory certificate - using valid_date as special_survey_to_date');
            console.log('   Certificate:', analysisData.cert_name);
            console.log('   Valid Date:', analysisData.valid_date);
            specialSurveyToDate = analysisData.valid_date;
          }
        }
        
        const processedData = {
          // Basic Information Section (original fields)
          name: analysisData.ship_name || '', 
          imo_number: analysisData.imo_number || '',
          class_society: analysisData.class_society || '', 
          flag: analysisData.flag || '',
          gross_tonnage: analysisData.gross_tonnage ? String(analysisData.gross_tonnage) : '',
          deadweight: analysisData.deadweight ? String(analysisData.deadweight) : '',
          built_year: analysisData.built_year ? String(analysisData.built_year) : '',
          delivery_date: formatDateForInput(analysisData.delivery_date) || '',
          keel_laid: formatDateForInput(analysisData.keel_laid) || '',
          ship_owner: analysisData.ship_owner || '',
          
          // Detailed Ship Information Section (NEW fields from enhanced extraction)
          last_docking: formatLastDockingForDisplay(analysisData.last_docking) || '',
          last_docking_2: formatLastDockingForDisplay(analysisData.last_docking_2) || '', 
          next_docking: formatDateForInput(analysisData.next_docking) || '',
          last_special_survey: formatDateForInput(analysisData.last_special_survey) || '',
          last_intermediate_survey: formatDateForInput(analysisData.last_intermediate_survey) || '',
          
          // Anniversary Date & Special Survey Cycle (NEW fields)
          anniversary_date_day: analysisData.anniversary_date_day ? String(analysisData.anniversary_date_day) : '',
          anniversary_date_month: analysisData.anniversary_date_month ? String(analysisData.anniversary_date_month) : '',
          special_survey_from_date: formatDateForInput(analysisData.special_survey_from_date) || '',
          special_survey_to_date: formatDateForInput(specialSurveyToDate) || '' // Use computed value
        };
        
        console.log('üìù Processed data for form:', processedData);
        
        // Count how many fields we're actually filling
        const filledFields = Object.keys(processedData).filter(key => 
          processedData[key] && processedData[key].trim()
        ).length;
        
        console.log('üî¢ Number of fields to fill:', filledFields);
        
        if (filledFields === 0) {
          toast.warning(language === 'vi' 
            ? '‚ö†Ô∏è PDF ƒë∆∞·ª£c ph√¢n t√≠ch nh∆∞ng kh√¥ng t√¨m th·∫•y th√¥ng tin t√†u ph√π h·ª£p'
            : '‚ö†Ô∏è PDF analyzed but no suitable ship information found'
          );
          return;
        }
        
        // FORCE UPDATE: Use functional update and force re-render
        console.log('üîÑ FORCING form data update...');
        setShipData(prev => {
          const updatedData = {
            ...prev,
            ...processedData
          };
          console.log('üì§ Previous data:', prev);
          console.log('üì• Updated data:', updatedData);
          
          // Force a timeout to ensure state update
          setTimeout(() => {
            console.log('‚è∞ Checking if form updated after timeout...');
          }, 100);
          
          return updatedData;
        });
        
        // Show success message IMMEDIATELY
        toast.success(language === 'vi' 
          ? `‚úÖ Ph√¢n t√≠ch PDF th√†nh c√¥ng! ƒê√£ ƒëi·ªÅn ${filledFields} tr∆∞·ªùng th√¥ng tin t√†u.`
          : `‚úÖ PDF analysis completed! Auto-filled ${filledFields} ship information fields.`
        );
        
        // Show processing notes if available
        if (analysisData.processing_notes && analysisData.processing_notes.length > 0) {
          console.log('üìã Processing notes:', analysisData.processing_notes);
        }
        
        // Close modal after longer delay to show auto-filled data
        setTimeout(() => {
          console.log('üö™ Closing PDF analysis modal...');
          setShowPdfAnalysis(false);
        }, 2000);
        
      } else {
        // Handle API failure
        const errorMessage = response.data.message || response.data.error || 'Unknown error';
        console.error('‚ùå PDF analysis failed:', errorMessage);
        
        toast.error(language === 'vi' 
          ? `‚ùå Ph√¢n t√≠ch PDF th·∫•t b·∫°i: ${errorMessage}`
          : `‚ùå PDF analysis failed: ${errorMessage}`
        );
      }
    } catch (error) {
      console.error('PDF analysis error:', error);
      const errorMessage = error.response?.data?.message || error.message;
      toast.error(language === 'vi' ? `L·ªói ph√¢n t√≠ch PDF: ${errorMessage}` : `PDF analysis error: ${errorMessage}`);
    } finally {
      setPdfAnalyzing(false);
    }
  };

  const handleOverlayClick = (e) => {
    if (e.target === e.currentTarget) {
      onClose();
    }
  };

  const handleSubmitShip = async () => {
    try {
      setIsSubmitting(true);
      
      // Prepare ship payload with proper data cleaning
      const shipPayload = {
        name: shipData.name?.trim() || '',
        imo: shipData.imo_number?.trim() || null, // Frontend uses imo_number, backend expects imo
        flag: shipData.flag?.trim() || '',
        ship_type: shipData.class_society?.trim() || '', // Frontend uses class_society, backend expects ship_type
        gross_tonnage: shipData.gross_tonnage ? parseFloat(shipData.gross_tonnage) : null,
        deadweight: shipData.deadweight ? parseFloat(shipData.deadweight) : null,
        built_year: shipData.built_year ? parseInt(shipData.built_year) : null,
        delivery_date: convertDateInputToUTC(shipData.delivery_date),
        keel_laid: convertDateInputToUTC(shipData.keel_laid),
        // Convert Last Docking MM/YYYY format to datetime for backend
        last_docking: convertLastDockingToDateTime(shipData.last_docking),
        last_docking_2: convertLastDockingToDateTime(shipData.last_docking_2),
        next_docking: convertDateInputToUTC(shipData.next_docking),
        last_special_survey: convertDateInputToUTC(shipData.last_special_survey),
        last_intermediate_survey: convertDateInputToUTC(shipData.last_intermediate_survey),
        ship_owner: shipData.ship_owner?.trim() || '',
        company: shipData.company?.trim() || user?.company || ''
      };

      // Add Anniversary Date if provided
      if (shipData.anniversary_date_day && shipData.anniversary_date_month) {
        shipPayload.anniversary_date = {
          day: parseInt(shipData.anniversary_date_day),
          month: parseInt(shipData.anniversary_date_month),
          manual_override: true,
          auto_calculated: false,
          source_certificate_type: "Manual Entry"
        };
      }

      // Add Special Survey Cycle if provided
      if (shipData.special_survey_from_date && shipData.special_survey_to_date) {
        shipPayload.special_survey_cycle = {
          from_date: convertDateInputToUTC(shipData.special_survey_from_date),
          to_date: convertDateInputToUTC(shipData.special_survey_to_date),
          cycle_type: "IMO 5-year Standard",
          manual_override: true,
          auto_calculated: false
        };
      }
      
      // Remove null values to avoid database constraint issues
      Object.keys(shipPayload).forEach(key => {
        if (shipPayload[key] === null || shipPayload[key] === '') {
          if (key === 'imo') {
            delete shipPayload[key]; // Remove IMO entirely if empty
          } else if (['gross_tonnage', 'deadweight', 'built_year', 'delivery_date', 'keel_laid', 'last_docking', 'last_docking_2', 'next_docking', 'last_special_survey', 'last_intermediate_survey'].includes(key)) {
            delete shipPayload[key]; // Remove optional numeric/date fields if empty
          }
        }
      });
      
      console.log('Ship payload:', shipPayload); // Debug log
      
      const response = await axios.post(`${API}/ships`, shipPayload);
      const createdShip = response.data;
      
      // Show initial success message
      toast.success(language === 'vi' ? 'üö¢ T√†u ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng v√†o database!' : 'üö¢ Ship added to database successfully!');
      
      // Immediately add the new ship to the ships list (optimistic update)
      // This makes the ship appear instantly in the Ship List without waiting for API fetch
      setShips(prevShips => [...prevShips, createdShip]);
      
      // Close modal immediately after ship creation and UI update
      onSuccess('ship');
      
      // Start polling for Google Drive folder creation status (runs in background)
      if (createdShip.id) {
        toast.info(language === 'vi' ? 'üìÅ ƒêang t·∫°o folder structure tr√™n Google Drive...' : 'üìÅ Creating folder structure on Google Drive...');
        startGoogleDriveFolderPolling(createdShip.id, createdShip.name);
      }
    } catch (error) {
      console.error('Ship creation error:', error);
      
      // Enhanced error message handling
      let errorMessage = 'Unknown error occurred';
      
      if (error.response?.data) {
        const errorData = error.response.data;
        
        // Handle FastAPI validation errors (array of error objects)
        if (Array.isArray(errorData.detail)) {
          const errorMessages = errorData.detail.map(err => {
            if (typeof err === 'object' && err.msg) {
              const field = Array.isArray(err.loc) ? err.loc.join('.') : 'field';
              return `${field}: ${err.msg}`;
            }
            return String(err);
          });
          errorMessage = errorMessages.join(', ');
        } 
        // Handle single error message
        else if (typeof errorData.detail === 'string') {
          errorMessage = errorData.detail;
        }
        // Handle error objects
        else if (typeof errorData.detail === 'object') {
          errorMessage = JSON.stringify(errorData.detail);
        }
        // Handle other error formats
        else if (errorData.message) {
          errorMessage = errorData.message;
        }
      } else if (error.message) {
        errorMessage = error.message;
      }
      
      toast.error(language === 'vi' ? `Kh√¥ng th·ªÉ th√™m t√†u: ${errorMessage}` : `Failed to add ship: ${errorMessage}`);
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleSubmitCertificate = async () => {
    try {
      setIsSubmitting(true);
      
      // Prepare certificate payload with UTC-safe date conversion
      const certPayload = {
        ...certificateData,
        ship_id: selectedShip?.id || '',
        issue_date: convertDateInputToUTC(certificateData.issue_date),
        valid_date: convertDateInputToUTC(certificateData.valid_date),
        last_endorse: certificateData.last_endorse ? convertDateInputToUTC(certificateData.last_endorse) : null,
        next_survey: certificateData.next_survey ? convertDateInputToUTC(certificateData.next_survey) : null
      };
      
      const response = await axios.post(`${API}/certificates`, certPayload);
      toast.success(language === 'vi' ? 'Ch·ª©ng ch·ªâ ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng!' : 'Certificate added successfully!');
      
      onSuccess('certificate');
    } catch (error) {
      console.error('Certificate creation error:', error);
      const errorMessage = error.response?.data?.detail || error.message;
      
      toast.error(language === 'vi' 
        ? `Kh√¥ng th·ªÉ t·∫°o ch·ª©ng ch·ªâ: ${errorMessage}` 
        : `Failed to create certificate: ${errorMessage}`);
    } finally {
      setIsSubmitting(false);
    }
  };

  const checkShipExistence = (shipName) => {
    if (!shipName || shipName === 'Unknown_Ship') return false;
    
    // Check if ship exists in current ships list
    return ships.some(ship => 
      ship.name.toLowerCase().includes(shipName.toLowerCase()) ||
      shipName.toLowerCase().includes(ship.name.toLowerCase())
    );
  };

  const handleShipNotFound = (extractedShipName, fileData) => {
    setPendingShipData({
      shipName: extractedShipName,
      fileData: fileData,
      extractedInfo: fileData.extracted_info
    });
    setShowShipConfirmModal(true);
  };

  const handleShipConfirmation = async (createNewShip) => {
    if (createNewShip && pendingShipData) {
      // Close modal first
      setShowShipConfirmModal(false);
      shipConfirmDrag.resetPosition();
      
      // Switch to Ship tab and use Add Ship from Certificate
      setRecordType('ship');
      setShowPdfAnalysis(true);
      
      // Auto-fill ship data from extracted info
      const extractedInfo = pendingShipData.extractedInfo;
      setShipData({
        name: pendingShipData.shipName,
        imo: extractedInfo?.imo_number || '',
        ship_type: extractedInfo?.class_society || '',
        flag: extractedInfo?.flag || '',
        gross_tonnage: extractedInfo?.gross_tonnage || '',
        deadweight: extractedInfo?.deadweight || '',
        built_year: extractedInfo?.built_year || '',
        ship_owner: extractedInfo?.ship_owner || '',
        company: user?.company || ''
      });
      
      toast.success(
        language === 'vi' 
          ? `Chuy·ªÉn sang t·∫°o t√†u m·ªõi: ${pendingShipData.shipName}` 
          : `Switching to create new ship: ${pendingShipData.shipName}`
      );
    } else {
      // Cancel - just close modal
      setShowShipConfirmModal(false);
      shipConfirmDrag.resetPosition();
      toast.info(
        language === 'vi' 
          ? 'ƒê√£ h·ªßy th√™m certificate' 
          : 'Certificate addition cancelled'
      );
    }
    
    // Clear pending data
    setPendingShipData(null);
  };

  // Complete Ship Folder Structure Extraction from Homepage Sidebar
  const getCompleteShipFolderStructure = () => {
    try {
      // Extract complete structure from homepage sidebar (line 990-1032)
      const currentCategories = [
        { key: 'documents', name: 'Class & Flag Cert', icon: 'üìÅ' },
        { key: 'crew', name: 'Crew Records', icon: 'üë•' },
        { key: 'ism', name: 'ISM Records', icon: 'üìã' },
        { key: 'isps', name: 'ISPS Records', icon: 'üõ°Ô∏è' },
        { key: 'mlc', name: 'MLC Records', icon: '‚öñÔ∏è' },
        { key: 'supplies', name: 'Supplies', icon: 'üì¶' },
      ];
      
      const currentSubMenuItems = {
        documents: [
          { key: 'certificates', name: 'Certificates' },
          { key: 'class_survey_reports', name: 'Class Survey Report' },
          { key: 'survey_reports', name: 'Test Report' },
          { key: 'drawings_manuals', name: 'Drawings & Manuals' },
          { key: 'other_documents', name: 'Other Documents' },
        ],
        crew: [
        ],
        ism: [
          { key: 'ism_certificate', name: 'ISM Certificate' },
          { key: 'safety_procedures', name: 'Safety Procedures' },
          { key: 'audit_reports', name: 'Audit Reports' },
        ],
        isps: [
          { key: 'isps_certificate', name: 'ISPS Certificate' },
          { key: 'security_plan', name: 'Security Plan' },
          { key: 'security_assessments', name: 'Security Assessments' },
        ],
        mlc: [
          { key: 'mlc_certificate', name: 'MLC Certificate' },
          { key: 'labor_conditions', name: 'Labor Conditions' },
          { key: 'accommodation_reports', name: 'Accommodation Reports' },
        ],
        supplies: [
          { key: 'inventory', name: 'Inventory' },
          { key: 'purchase_orders', name: 'Purchase Orders' },
          { key: 'spare_parts', name: 'Spare Parts' },
        ],
      };
      
      // Build complete folder structure
      const folderStructure = {};
      
      currentCategories.forEach(category => {
        const categoryName = category.name; // Use English names for consistency
        const subfolders = currentSubMenuItems[category.key]?.map(item => item.name) || [];
        
        folderStructure[categoryName] = subfolders;
      });
      
      console.log('üìÅ Complete ship folder structure extracted from homepage sidebar:');
      console.log(`   Categories: ${Object.keys(folderStructure).length}`);
      console.log(`   Total subfolders: ${Object.values(folderStructure).flat().length}`);
      Object.entries(folderStructure).forEach(([category, subfolders]) => {
        console.log(`   ${category}: [${subfolders.join(', ')}]`);
      });
      
      return folderStructure;
      
    } catch (error) {
      console.error('Error extracting complete folder structure from homepage sidebar:', error);
      
      // Fallback to minimal structure if extraction fails
      const fallbackStructure = {
        'Class & Flag Cert': ['Certificates', 'Class Survey Report', 'Test Report', 'Drawings & Manuals', 'Other Documents'],
        'Crew Records': [],
        'ISM Records': ['ISM Certificate', 'Safety Procedures', 'Audit Reports'],
        'ISPS Records': ['ISPS Certificate', 'Security Plan', 'Security Assessments'],
        'MLC Records': ['MLC Certificate', 'Labor Conditions', 'Accommodation Reports'],
        'Supplies': ['Inventory', 'Purchase Orders', 'Spare Parts']
      };
      
      console.warn('‚ö†Ô∏è Using fallback complete folder structure:', fallbackStructure);
      return fallbackStructure;
    }
  };

  // Poll Google Drive folder creation status
  const startGoogleDriveFolderPolling = async (shipId, shipName) => {
    const maxPollingTime = 185000; // 185 seconds (slightly more than backend timeout)
    const pollingInterval = 3000; // 3 seconds
    const startTime = Date.now();
    
    const pollStatus = async () => {
      try {
        const response = await axios.get(`${API}/ships/${shipId}/gdrive-folder-status`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const status = response.data.gdrive_folder_status;
        
        if (status === 'completed') {
          toast.success(language === 'vi' 
            ? `‚úÖ Folder structure cho t√†u "${shipName}" ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng tr√™n Google Drive!`
            : `‚úÖ Folder structure for ship "${shipName}" created successfully on Google Drive!`
          );
          return; // Stop polling
        } else if (status === 'failed' || status === 'error') {
          const errorMsg = response.data.gdrive_folder_error || 'Unknown error';
          toast.error(language === 'vi'
            ? `‚ùå Kh√¥ng th·ªÉ t·∫°o folder cho t√†u "${shipName}": ${errorMsg}`
            : `‚ùå Failed to create folder for ship "${shipName}": ${errorMsg}`
          );
          return; // Stop polling
        } else if (status === 'timeout') {
          toast.warning(language === 'vi'
            ? `‚è∞ T·∫°o folder cho t√†u "${shipName}" b·ªã timeout sau 180 gi√¢y`
            : `‚è∞ Folder creation for ship "${shipName}" timed out after 180 seconds`
          );
          return; // Stop polling
        } else if (status === 'pending') {
          // Check if total polling time exceeded
          if (Date.now() - startTime > maxPollingTime) {
            toast.warning(language === 'vi'
              ? `‚è∞ H·∫øt th·ªùi gian ch·ªù t·∫°o folder cho t√†u "${shipName}"`
              : `‚è∞ Polling timeout for folder creation of ship "${shipName}"`
            );
            return; // Stop polling
          }
          // Continue polling
          setTimeout(pollStatus, pollingInterval);
        }
      } catch (error) {
        console.error('Error polling folder status:', error);
        toast.error(language === 'vi'
          ? `‚ùå L·ªói khi ki·ªÉm tra tr·∫°ng th√°i folder cho t√†u "${shipName}"`
          : `‚ùå Error checking folder status for ship "${shipName}"`
        );
      }
    };
    
    // Start polling after a short delay
    setTimeout(pollStatus, pollingInterval);
  };

  // Google Drive Ship Folder Creation with Complete Hierarchy Structure
  const createShipGoogleDriveFolder = async (shipName, companyId) => {
    try {
      console.log(`Creating complete Google Drive folder structure for ship: ${shipName}`);
      
      // Get complete folder structure from homepage sidebar
      const folderStructure = getCompleteShipFolderStructure();
      
      // Validate extracted structure
      if (!folderStructure || Object.keys(folderStructure).length === 0) {
        throw new Error('No folder structure found in homepage sidebar');
      }
      
      const totalCategories = Object.keys(folderStructure).length;
      const totalSubfolders = Object.values(folderStructure).flat().length;
      
      console.log(`üìã Using complete structure from homepage sidebar:`);
      console.log(`   Categories: ${totalCategories}`);
      console.log(`   Total subfolders: ${totalSubfolders}`);
      console.log(`üîÑ Structure sync: Homepage Sidebar ‚Üí Google Drive Complete Hierarchy`);
      
      // Call backend to create complete ship folder structure on Company Google Drive
      const response = await axios.post(`${API}/companies/${companyId}/gdrive/create-ship-folder`, {
        ship_name: shipName,
        folder_structure: folderStructure, // Send complete hierarchy
        source: 'homepage_sidebar_complete', // Indicate complete structure source
        total_categories: totalCategories,
        total_subfolders: totalSubfolders
      }, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (response.data.success) {
        console.log(`‚úÖ Complete ship folder structure created successfully:`, response.data);
        toast.success(
          language === 'vi' 
            ? `üìÅ ƒê√£ t·∫°o c·∫•u tr√∫c th∆∞ m·ª•c ho√†n ch·ªânh "${shipName}" v·ªõi ${totalCategories} danh m·ª•c v√† ${totalSubfolders} th∆∞ m·ª•c con`
            : `üìÅ Created complete "${shipName}" folder structure with ${totalCategories} categories and ${totalSubfolders} subfolders`
        );
        return response.data;
      } else {
        throw new Error(response.data.message || 'Failed to create ship folder structure');
      }
      
    } catch (error) {
      console.error('Error creating ship Google Drive folder structure:', error);
      const errorMessage = error.response?.data?.detail || error.message;
      
      // Show warning but don't fail ship creation
      toast.warning(
        language === 'vi'
          ? `‚ö†Ô∏è Ship ƒë√£ t·∫°o th√†nh c√¥ng nh∆∞ng kh√¥ng th·ªÉ t·∫°o c·∫•u tr√∫c th∆∞ m·ª•c Google Drive: ${errorMessage}`
          : `‚ö†Ô∏è Ship created successfully but failed to create Google Drive folder structure: ${errorMessage}`
      );
      
      return null;
    }
  };

  // handleMultiFileUpload function will be rebuilt from scratch

  const handleSubmitDocument = async () => {
    try {
      setIsSubmitting(true);
      // For now, create a basic document record (file upload can be enhanced later)
      const docPayload = {
        title: documentData.title,
        category: documentData.category,
        description: documentData.description,
        ship_id: selectedShip?.id || null
      };
      
      // This would need a separate endpoint for documents in the backend
      toast.info(language === 'vi' ? 'T√≠nh nƒÉng t·∫£i l√™n t√†i li·ªáu ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn' : 'Document upload feature is under development');
      onSuccess('document');
    } catch (error) {
      toast.error(language === 'vi' ? 'Kh√¥ng th·ªÉ th√™m t√†i li·ªáu!' : 'Failed to add document!');
      console.error('Document creation error:', error);
    } finally {
      setIsSubmitting(false);
    }
  };
  // Handle file upload to Google Drive Certificate folder
  const handleFileUpload = async () => {
    if (!selectedFile || !selectedShip) {
      toast.error(language === 'vi' 
        ? 'Vui l√≤ng ch·ªçn file v√† t√†u tr∆∞·ªõc khi upload!' 
        : 'Please select a file and ship before uploading!');
      return;
    }

    setUploadingFile(true);
    
    try {
      const formData = new FormData();
      formData.append('file', selectedFile);
      formData.append('ship_id', selectedShip.id);
      formData.append('folder_type', 'Certificate');

      const response = await axios.post(`${API}/upload-to-gdrive`, formData, {
        headers: { 
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'multipart/form-data'
        }
      });
      
      if (response.data.success) {
        toast.success(language === 'vi' 
          ? `‚úÖ ƒê√£ upload ${selectedFile.name} th√†nh c√¥ng l√™n Google Drive!` 
          : `‚úÖ Successfully uploaded ${selectedFile.name} to Google Drive!`);
        
        // Close modal and reset state
        setShowFileUpload(false);
        setSelectedFile(null);
        
        // Optionally refresh certificates list if needed
        if (selectedShip?.id) {
          await fetchCertificates(selectedShip.id);
        }
      } else {
        throw new Error(response.data.message || 'Upload failed');
      }
      
    } catch (error) {
      console.error('‚ùå File upload error:', error);
      
      let errorMessage = language === 'vi' 
        ? 'L·ªói khi upload file l√™n Google Drive!' 
        : 'Error uploading file to Google Drive!';
        
      if (error.response?.status === 404) {
        errorMessage = language === 'vi' 
          ? 'Kh√¥ng t√¨m th·∫•y Google Drive configuration cho c√¥ng ty!' 
          : 'Google Drive configuration not found for company!';
      } else if (error.response?.status === 403) {
        errorMessage = language === 'vi' 
          ? 'Kh√¥ng c√≥ quy·ªÅn upload file l√™n Google Drive!' 
          : 'No permission to upload file to Google Drive!';
      } else if (error.response?.data?.detail) {
        errorMessage = error.response.data.detail;
      }
      
      toast.error(errorMessage);
    } finally {
      setUploadingFile(false);
    }
  };

  const handleSubmit = () => {
    if (recordType === 'ship') {
      handleSubmitShip();
    } else if (recordType === 'certificate') {
      handleSubmitCertificate();
    } else if (recordType === 'document') {
      handleSubmitDocument();
    }
  };

  return (
    <div 
      className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]" 
      onClick={handleOverlayClick}
    >
      <div className="bg-white rounded-xl shadow-2xl p-8 max-w-6xl w-full max-h-[95vh] overflow-y-auto mx-4">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-2xl font-bold text-gray-800">
            {language === 'vi' ? 'Th√™m h·ªì s∆° m·ªõi' : 'Add New Record'}
          </h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600 text-2xl leading-none"
          >
            √ó
          </button>
        </div>

        {/* Tab Navigation */}
        <div className="mb-6">
          <div className="border-b border-gray-200">
            <nav className="-mb-px flex space-x-8" aria-label="Tabs">
              {tabs.map((tab) => {
                // Hide ship tab if user doesn't have permission
                if (tab.key === 'ship' && !canCreateShip()) {
                  return null;
                }
                
                const isActive = activeTab === tab.key;
                return (
                  <button
                    key={tab.key}
                    onClick={() => {
                      setActiveTab(tab.key);
                      // Reset document type selection when switching away from documents tab
                      if (tab.key !== 'documents') {
                        setSelectedDocumentType('');
                      } else if (tab.key === 'documents' && defaultDocumentType) {
                        // When switching to documents tab and we have a default, use it
                        setSelectedDocumentType(defaultDocumentType);
                      }
                    }}
                    className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center space-x-2 ${
                      isActive
                        ? 'border-blue-500 text-blue-600'
                        : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                    }`}
                  >
                    <span className="text-lg">{tab.icon}</span>
                    <span>{tab.name}</span>
                  </button>
                );
              })}
            </nav>
          </div>
          
          {/* Permission message for non-eligible users */}
          {!canCreateShip() && (
            <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
              <p className="text-sm text-yellow-800">
                <span className="font-medium">‚ÑπÔ∏è {language === 'vi' ? 'L∆∞u √Ω:' : 'Note:'}</span>
                {' '}
                {language === 'vi' 
                  ? 'Ch·ªâ c√≥ Company Officer tr·ªü l√™n m·ªõi c√≥ th·ªÉ t·∫°o h·ªì s∆° t√†u m·ªõi.'
                  : 'Only Company Officer and above can create new ship records.'
                }
              </p>
            </div>
          )}
        </div>

        {/* PDF Analysis Section for Ship */}
        {recordType === 'ship' && (
          <div className="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg">
            <div className="flex items-center justify-between">
              <div>
                <h4 className="font-medium text-blue-800 mb-1">
                  {language === 'vi' ? 'Th√™m t√†u m·ªõi t·ª´ Gi·∫•y ch·ª©ng nh·∫≠n' : 'Add Ship from Certificate'}
                </h4>
                <p className="text-sm text-blue-600">
                  {language === 'vi' ? 'Upload file PDF v√† AI s·∫Ω t·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin t√†u' : 'Upload PDF file and AI will auto-fill ship information'}
                </p>
              </div>
              <button
                type="button"
                onClick={() => setShowPdfAnalysis(true)}
                className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-all flex items-center"
              >
                <span className="mr-2">üìÑ</span>
                {language === 'vi' ? 'Upload PDF' : 'Upload PDF'}
              </button>
            </div>
          </div>
        )}

        {/* Tab Content */}
        
        {/* Documents Tab (Certificate + Class Survey Report) */}
        {activeTab === 'documents' && (
          <div className="mb-6">
            <h3 className="text-lg font-medium text-gray-900 mb-4">
              {language === 'vi' ? 'Ch·ªçn lo·∫°i t√†i li·ªáu' : 'Select document type'}
            </h3>
            <div className="grid grid-cols-5 gap-3 mb-6">
              <label className={`flex flex-col items-center p-3 border-2 rounded-lg cursor-pointer transition-all text-center ${
                selectedDocumentType === 'certificate' 
                  ? 'border-blue-500 bg-blue-50' 
                  : 'border-gray-200 hover:bg-gray-50'
              }`}>
                <input
                  type="radio"
                  name="documentType"
                  value="certificate"
                  checked={selectedDocumentType === 'certificate'}
                  onChange={() => setSelectedDocumentType('certificate')}
                  className="mb-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300"
                />
                <div className="font-medium text-gray-900 text-sm">
                  {language === 'vi' ? 'Ch·ª©ng ch·ªâ' : 'Certificate'}
                </div>
              </label>
              
              <label className={`flex flex-col items-center p-3 border-2 rounded-lg cursor-pointer transition-all text-center ${
                selectedDocumentType === 'survey_report' 
                  ? 'border-blue-500 bg-blue-50' 
                  : 'border-gray-200 hover:bg-gray-50'
              }`}>
                <input
                  type="radio"
                  name="documentType"
                  value="survey_report"
                  checked={selectedDocumentType === 'survey_report'}
                  onChange={() => setSelectedDocumentType('survey_report')}
                  className="mb-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300"
                />
                <div className="font-medium text-gray-900 text-sm">
                  {language === 'vi' ? 'H·ªì s∆° ƒêƒÉng ki·ªÉm' : 'Class Survey Report'}
                </div>
              </label>

              <label className="flex flex-col items-center p-3 border-2 border-gray-200 rounded-lg cursor-not-allowed transition-all text-center opacity-50">
                <input
                  type="radio"
                  name="documentType"
                  value="test_report"
                  disabled
                  className="mb-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300"
                />
                <div className="font-medium text-gray-900 text-sm">
                  {language === 'vi' ? 'Test Report' : 'Test Report'}
                </div>
              </label>

              <label className="flex flex-col items-center p-3 border-2 border-gray-200 rounded-lg cursor-not-allowed transition-all text-center opacity-50">
                <input
                  type="radio"
                  name="documentType"
                  value="drawings_manuals"
                  disabled
                  className="mb-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300"
                />
                <div className="font-medium text-gray-900 text-sm">
                  {language === 'vi' ? 'B·∫£n v·∫Ω & S·ªï tay' : 'Drawing & Manual'}
                </div>
              </label>

              <label className="flex flex-col items-center p-3 border-2 border-gray-200 rounded-lg cursor-not-allowed transition-all text-center opacity-50">
                <input
                  type="radio"
                  name="documentType"
                  value="other_documents"
                  disabled
                  className="mb-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300"
                />
                <div className="font-medium text-gray-900 text-sm">
                  {language === 'vi' ? 'T√†i li·ªáu kh√°c' : 'Other Documents'}
                </div>
              </label>
            </div>

            {/* Show selected form below the selection */}
            {selectedDocumentType && (
              <div className="border-t pt-6">
                <h4 className="text-md font-medium text-gray-700 mb-4">
                  {selectedDocumentType === 'certificate' 
                    ? (language === 'vi' ? 'T·∫°o Ch·ª©ng ch·ªâ m·ªõi' : 'Create New Certificate')
                    : selectedDocumentType === 'survey_report' 
                    ? (language === 'vi' ? 'T·∫°o H·ªì s∆° ƒêƒÉng ki·ªÉm m·ªõi' : 'Create New Class Survey Report')
                    : ''
                  }
                </h4>
              </div>
            )}
          </div>
        )}

        {/* Ship form moved to Ship tab - Certificate form remains clean */}

        {/* Certificate Form */}
        {activeTab === 'documents' && selectedDocumentType === 'certificate' && (
          <div className="space-y-3">
            {!selectedShip && (
              <div className="relative">
                <div 
                  className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 cursor-pointer hover:bg-yellow-100 transition-colors"
                  onMouseEnter={() => setShowShipDropdown(true)}
                  onMouseLeave={() => setShowShipDropdown(false)}
                >
                  <div className="flex items-center">
                    <svg className="w-5 h-5 text-yellow-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                      <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                    </svg>
                    <div className="flex-1">
                      <div className="flex items-center justify-between">
                        <p className="text-yellow-800 text-sm font-medium">
                          {language === 'vi' ? '‚ö†Ô∏è Ch∆∞a ch·ªçn t√†u' : '‚ö†Ô∏è No Ship Selected'}
                        </p>
                        <div className="text-yellow-600">
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                          </svg>
                        </div>
                      </div>
                      <p className="text-yellow-700 text-xs mt-1">
                        {language === 'vi' 
                          ? 'Hover ƒë·ªÉ ch·ªçn t√†u ho·∫∑c ch·ªçn t·ª´ danh s√°ch b√™n tr√°i. Certificate s·∫Ω ƒë∆∞·ª£c g√°n v√†o t√†u ƒë√£ ch·ªçn.'
                          : 'Hover to select a ship or choose from left sidebar. Certificates will be assigned to the selected ship.'
                        }
                      </p>
                    </div>
                  </div>
                </div>

                {/* Ship Selection Dropdown */}
                {showShipDropdown && (
                  <div 
                    className="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50 max-h-60 overflow-y-auto"
                    onMouseEnter={() => setShowShipDropdown(true)}
                    onMouseLeave={() => setShowShipDropdown(false)}
                  >
                    <div className="p-2">
                      <div className="text-xs font-medium text-gray-500 px-3 py-2 border-b">
                        {language === 'vi' ? 'Ch·ªçn t√†u:' : 'Select Ship:'}
                      </div>
                      {ships && ships.length > 0 ? (
                        <div className="max-h-48 overflow-y-auto">
                          {ships.map((ship) => (
                            <button
                              key={ship.id}
                              onClick={() => {
                                setSelectedShip(ship);
                                setCrewFilters({...crewFilters, ship_sign_on: ship.name});
                                setShowShipDropdown(false);
                                toast.success(language === 'vi' 
                                  ? `‚úÖ ƒê√£ ch·ªçn t√†u: ${ship.name}`
                                  : `‚úÖ Selected ship: ${ship.name}`);
                              }}
                              className="w-full text-left px-3 py-2 hover:bg-blue-50 rounded transition-colors flex items-center justify-between group"
                            >
                              <div>
                                <div className="font-medium text-gray-900 text-sm">{ship.name}</div>
                                <div className="text-xs text-gray-500">
                                  IMO: {ship.imo_number} ‚Ä¢ {ship.flag}
                                </div>
                              </div>
                              <div className="text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity">
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                                </svg>
                              </div>
                            </button>
                          ))}
                        </div>
                      ) : (
                        <div className="px-3 py-4 text-center text-gray-500 text-sm">
                          {language === 'vi' 
                            ? 'Kh√¥ng c√≥ t√†u n√†o. H√£y th√™m t√†u m·ªõi tr∆∞·ªõc.'
                            : 'No ships available. Please add a new ship first.'}
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>
            )}
            
            {/* Multi Cert Upload */}
            <div className="border-2 border-dashed border-blue-300 rounded-lg p-6 bg-blue-50">
              <div className="mb-4">
                {/* Layout 3 c·ªôt: Title + Guidelines + Upload Button */}
                <div className="flex items-start justify-between mb-3">
                  {/* C·ªôt 1: Title v√† AI Model */}
                  <div className="flex-1 pr-4">
                    <h3 className="text-lg font-semibold text-blue-900 mb-2">
                      üìã {language === 'vi' ? 'Multi Cert Upload' : 'Multi Cert Upload'}
                    </h3>
                    
                    {/* AI Model Display */}
                    <div className="flex items-center mb-2">
                      <span className="text-sm text-blue-700 mr-2">
                        {language === 'vi' ? 'Model AI ƒëang s·ª≠ d·ª•ng:' : 'AI Model in use:'}
                      </span>
                      <div className="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        <svg className="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z" />
                        </svg>
                        {aiConfig 
                          ? `${aiConfig.provider === 'emergent' ? 'Emergent LLM' : aiConfig.provider.charAt(0).toUpperCase() + aiConfig.provider.slice(1)} - ${aiConfig.model}`
                          : (language === 'vi' ? 'AI Model: ƒêang t·∫£i...' : 'AI Model: Loading...')
                        }
                      </div>
                    </div>
                  </div>

                  {/* C·ªôt 2: Upload Guidelines - Thu h·∫πp */}
                  <div className="w-72 mx-4 bg-blue-100 rounded-lg p-3">
                    <h4 className="text-sm font-medium text-blue-800 mb-2 flex items-center">
                      üìù {language === 'vi' ? 'H∆∞·ªõng d·∫´n Upload:' : 'Upload Guidelines:'}
                    </h4>
                    <ul className="text-xs text-blue-700 space-y-1">
                      <li>‚Ä¢ {language === 'vi' ? 'PDF, JPG, PNG' : 'PDF, JPG, PNG files'}</li>
                      <li>‚Ä¢ {language === 'vi' ? 'Max 50MB/file' : 'Max 50MB per file'}</li>
                      <li>‚Ä¢ {language === 'vi' ? 'AI t·ª± ƒë·ªông ph√¢n t√≠ch' : 'AI auto-analysis'}</li>
                    </ul>
                  </div>

                  {/* C·ªôt 3: Upload Button - Ngo√†i c√πng b√™n ph·∫£i */}
                  <div className="flex-shrink-0">
                    <label
                      htmlFor="multi-cert-upload"
                      className={`inline-flex items-center px-4 py-3 border border-transparent text-sm font-medium rounded-md transition-colors cursor-pointer ${
                        selectedShip && !isMultiCertProcessing
                          ? 'text-white bg-blue-600 hover:bg-blue-700 shadow-md'
                          : 'text-gray-400 bg-gray-300 cursor-not-allowed'
                      }`}
                    >
                      <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                      {isMultiCertProcessing 
                        ? (language === 'vi' ? '‚è≥ ƒêang x·ª≠ l√Ω...' : '‚è≥ Processing...')
                        : (language === 'vi' ? 'üìã Cert Upload' : 'üìã Cert Upload')
                      }
                      <input
                        id="multi-cert-upload"
                        name="multi-cert-upload"
                        type="file"
                        multiple
                        className="sr-only"
                        onChange={(e) => {
                          if (selectedShip && !isMultiCertProcessing) {
                            // Create auto-fill callback for AddRecordModal context
                            const autoFillCallback = (data, fieldCount) => {
                              console.log('üîÑ Auto-filling certificate form with data:', data);
                              setCertificateData(prev => ({
                                ...prev,
                                ...data
                              }));
                              
                              // Show auto-fill success message
                              toast.success(
                                language === 'vi' 
                                  ? `‚úÖ ƒê√£ t·ª± ƒë·ªông ƒëi·ªÅn ${fieldCount} tr∆∞·ªùng t·ª´ Certificate AI`
                                  : `‚úÖ Auto-filled ${fieldCount} fields from Certificate AI`
                              );
                            };
                            
                            handleMultiCertUpload(e.target.files, autoFillCallback);
                            e.target.value = ''; // Reset input
                          }
                        }}
                        disabled={!selectedShip || isMultiCertProcessing}
                        accept=".pdf,.jpg,.jpeg,.png"
                      />
                    </label>
                  </div>
                </div>

                {/* Warning message for no ship selected */}
                {!selectedShip && (
                  <div className="text-center mt-2">
                    <p className="text-sm text-orange-600">
                      ‚ö†Ô∏è {language === 'vi' 
                        ? 'Vui l√≤ng ch·ªçn t√†u tr∆∞·ªõc khi upload certificates'
                        : 'Please select a ship before uploading certificates'
                      }
                    </p>
                  </div>
                )}
              </div>

              {/* Upload Progress */}
              {multiCertUploads && multiCertUploads.length > 0 && (
                <div className="mt-6 space-y-3">
                  <div className="flex items-center justify-between">
                    <h4 className="font-medium text-gray-900 flex items-center">
                      {language === 'vi' ? 'üìä Ti·∫øn tr√¨nh x·ª≠ l√Ω' : 'üìä Processing Progress'}
                      {isMultiCertProcessing && (
                        <div className="ml-2 animate-spin">
                          <svg className="w-4 h-4 text-blue-500" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                          </svg>
                        </div>
                      )}
                    </h4>
                    
                    {!isMultiCertProcessing && (
                      <button
                        onClick={() => {
                          setMultiCertUploads([]);
                          setUploadSummary(null);
                        }}
                        className="text-xs px-3 py-1 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition-colors"
                      >
                        üóëÔ∏è {language === 'vi' ? 'X√≥a k·∫øt qu·∫£' : 'Clear Results'}
                      </button>
                    )}
                  </div>

                  {/* File Progress List */}
                  {multiCertUploads.map((fileUpload, index) => (
                    <div key={index} className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                      <div className="flex items-center justify-between mb-2">
                        <div className="flex items-center">
                          <div className={`w-3 h-3 rounded-full mr-3 ${
                            fileUpload.status === 'completed' ? 'bg-green-500' :
                            fileUpload.status === 'success_with_reference_note' ? 'bg-teal-500' :
                            fileUpload.status === 'failed' ? 'bg-red-500' :
                            fileUpload.status === 'skipped' ? 'bg-yellow-500' :
                            fileUpload.status === 'pending_duplicate' ? 'bg-orange-500' :
                            fileUpload.status === 'requires_manual_input' ? 'bg-purple-500' :
                            fileUpload.status === 'requires_manual_review' ? 'bg-indigo-500' :
                            'bg-blue-500'
                          }`}></div>
                          <span className="font-medium text-gray-900">{fileUpload.name}</span>
                          {fileUpload.size && (
                            <span className="text-sm text-gray-500 ml-2">
                              ({(fileUpload.size / 1024 / 1024).toFixed(2)} MB)
                            </span>
                          )}
                        </div>
                        <div className="text-sm text-gray-600">{fileUpload.progress}%</div>
                      </div>
                      
                      {/* Progress Bar */}
                      <div className="w-full bg-gray-200 rounded-full h-2 mb-3">
                        <div 
                          className={`h-2 rounded-full transition-all duration-300 ${
                            fileUpload.status === 'completed' ? 'bg-green-500' :
                            fileUpload.status === 'success_with_reference_note' ? 'bg-teal-500' :
                            fileUpload.status === 'failed' ? 'bg-red-500' :
                            fileUpload.status === 'skipped' ? 'bg-yellow-500' :
                            fileUpload.status === 'pending_duplicate' ? 'bg-orange-500' :
                            fileUpload.status === 'requires_manual_input' ? 'bg-purple-500' :
                            fileUpload.status === 'requires_manual_review' ? 'bg-indigo-500' :
                            'bg-blue-500'
                          }`}
                          style={{ width: `${fileUpload.progress}%` }}
                        />
                      </div>
                      
                      {/* Current Processing Status */}
                      <div className="text-sm font-medium mb-2 px-2 py-1 rounded-md bg-blue-50 text-blue-700 border border-blue-200">
                        {fileUpload.stage}
                      </div>
                      
                      {/* Marine Certificate Analysis Results */}
                      {fileUpload.status === 'completed' && fileUpload.is_marine_certificate && (
                        <div className="mt-3 p-3 bg-green-50 rounded-lg border border-green-200">
                          <h5 className="text-sm font-semibold text-green-700 mb-2">
                            ‚úÖ {language === 'vi' ? 'Marine Certificate - Th√¥ng tin tr√≠ch xu·∫•t' : 'Marine Certificate - Extracted Information'}
                          </h5>
                          <div className="text-sm space-y-1">
                            {fileUpload.cert_name && (
                              <div className="flex justify-between">
                                <span className="font-medium text-blue-600">{language === 'vi' ? 'T√™n ch·ª©ng ch·ªâ:' : 'Certificate Name:'}</span>
                                <span className="text-blue-800 text-xs max-w-xs truncate">{fileUpload.cert_name}</span>
                              </div>
                            )}
                            {fileUpload.cert_no && (
                              <div className="flex justify-between">
                                <span className="font-medium text-purple-600">{language === 'vi' ? 'S·ªë ch·ª©ng ch·ªâ:' : 'Certificate No:'}</span>
                                <span className="text-purple-800">{fileUpload.cert_no}</span>
                              </div>
                            )}
                            {fileUpload.valid_date && (
                              <div className="flex justify-between">
                                <span className="font-medium text-red-600">{language === 'vi' ? 'H·∫øt h·∫°n:' : 'Valid Until:'}</span>
                                <span className="text-red-800">{fileUpload.valid_date}</span>
                              </div>
                            )}
                            {fileUpload.issued_by && (
                              <div className="flex justify-between">
                                <span className="font-medium text-green-600">{language === 'vi' ? 'C·∫•p b·ªüi:' : 'Issued By:'}</span>
                                <span className="text-green-800 text-xs max-w-xs truncate">{fileUpload.issued_by}</span>
                              </div>
                            )}
                          </div>
                        </div>
                      )}
                      
                      {/* Manual Input Required - AI Extraction Failed */}
                      {fileUpload.status === 'requires_manual_input' && (
                        <div className="mt-3 p-3 bg-purple-50 rounded-lg border border-purple-200">
                          <h5 className="text-sm font-semibold text-purple-700 mb-2">
                            ü§ñ‚ùå {language === 'vi' ? 'AI kh√¥ng th·ªÉ tr√≠ch xu·∫•t ƒë·ªß th√¥ng tin - C·∫ßn nh·∫≠p th·ªß c√¥ng' : 'AI Extraction Failed - Manual Input Required'}
                          </h5>
                          <div className="text-sm space-y-2">
                            <div className="flex justify-between">
                              <span className="font-medium text-purple-600">
                                {language === 'vi' ? 'L√Ω do:' : 'Reason:'}
                              </span>
                              <span className="text-purple-800 text-xs">{fileUpload.manual_input_reason || 'Unknown'}</span>
                            </div>
                            {fileUpload.extraction_quality && (
                              <div className="bg-white p-2 rounded border">
                                <p className="text-xs text-purple-600 font-medium mb-1">
                                  {language === 'vi' ? 'Ch·∫•t l∆∞·ª£ng tr√≠ch xu·∫•t:' : 'Extraction Quality:'}
                                </p>
                                <div className="text-xs space-y-1">
                                  <div className="flex justify-between">
                                    <span>{language === 'vi' ? 'ƒê·ªô tin c·∫≠y:' : 'Confidence:'}</span>
                                    <span>{(fileUpload.extraction_quality.confidence_score * 100).toFixed(0)}%</span>
                                  </div>
                                  <div className="flex justify-between">
                                    <span>{language === 'vi' ? 'Tr∆∞·ªùng quan tr·ªçng:' : 'Critical fields:'}</span>
                                    <span>{fileUpload.extraction_quality.extracted_critical_fields}/{fileUpload.extraction_quality.total_critical_fields}</span>
                                  </div>
                                  <div className="flex justify-between">
                                    <span>{language === 'vi' ? 'ƒê·ªô d√†i vƒÉn b·∫£n:' : 'Text length:'}</span>
                                    <span>{fileUpload.extraction_quality.text_length} chars</span>
                                  </div>
                                </div>
                              </div>
                            )}
                            {fileUpload.manual_input_data && (
                              <div className="bg-white p-2 rounded border">
                                <p className="text-xs text-purple-600 font-medium mb-1">
                                  {language === 'vi' ? 'D·ªØ li·ªáu AI ƒë√£ tr√≠ch xu·∫•t:' : 'AI Extracted Data:'}
                                </p>
                                <div className="text-xs space-y-1">
                                  {Object.entries(fileUpload.manual_input_data.extracted_data).map(([key, value]) => (
                                    value && <div key={key} className="flex justify-between">
                                      <span className="capitalize">{key.replace('_', ' ')}:</span>
                                      <span className="text-purple-800 truncate max-w-32">{String(value).substring(0, 30)}{String(value).length > 30 ? '...' : ''}</span>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                            <div className="text-xs text-purple-600 mt-2 p-3 bg-purple-100 rounded border-l-4 border-purple-400">
                              <div className="flex items-start space-x-2">
                                <span className="text-purple-500 mt-0.5">üí°</span>
                                <div>
                                  <p className="font-medium mb-1">
                                    {language === 'vi' ? 'H∆∞·ªõng d·∫´n nh·∫≠p th·ªß c√¥ng:' : 'Manual Input Instructions:'}
                                  </p>
                                  <p className="mb-2">
                                    {language === 'vi' 
                                      ? 'AI kh√¥ng th·ªÉ tr√≠ch xu·∫•t ƒë·ªß th√¥ng tin t·ª´ file n√†y.' 
                                      : 'AI could not extract sufficient information from this file.'}
                                  </p>
                                  <p className="font-bold text-purple-800 text-sm animate-pulse bg-purple-200 px-2 py-1 rounded border border-purple-300">
                                    {language === 'vi' 
                                      ? 'üëá S·ª≠ d·ª•ng n√∫t "üìã Add Certificate" ph√≠a d∆∞·ªõi ƒë·ªÉ nh·∫≠p th·ªß c√¥ng th√¥ng tin certificate.' 
                                      : 'üëá Use the "üìã Add Certificate" button below to manually input certificate information.'}
                                  </p>
                                </div>
                              </div>
                            </div>
                          </div>
                          
                          {/* Action Buttons - Ch·ªâ c√≥ Skip */}
                          <div className="flex justify-end mt-3 pt-2 border-t border-purple-200">
                            <button
                              onClick={() => {
                                // Skip this file - mark as skipped
                                setMultiCertUploads(prev => prev.map((upload, idx) => 
                                  upload.name === fileUpload.name
                                    ? { ...upload, status: 'skipped', stage: language === 'vi' ? 'ƒê√£ b·ªè qua' : 'Skipped' }
                                    : upload
                                ));
                              }}
                              className="px-4 py-2 text-sm bg-gray-500 hover:bg-gray-600 text-white rounded-md transition-colors"
                            >
                              {language === 'vi' ? '‚è≠Ô∏è B·ªè qua file n√†y' : '‚è≠Ô∏è Skip this file'}
                            </button>
                          </div>
                        </div>
                      )}
                      
                      {/* Manual Review Required */}
                      {fileUpload.status === 'requires_manual_review' && (
                        <div className="mt-3 p-3 bg-orange-50 rounded-lg border border-orange-200">
                          <h5 className="text-sm font-semibold text-orange-700 mb-2">
                            üîç {language === 'vi' ? 'C·∫ßn xem x√©t th·ªß c√¥ng' : 'Manual Review Required'}
                          </h5>
                          <div className="text-sm space-y-2">
                            <div className="flex justify-between">
                              <span className="font-medium text-orange-600">
                                {language === 'vi' ? 'H·ªá th·ªëng ph√¢n lo·∫°i:' : 'System classified as:'}
                              </span>
                              <span className="text-orange-800 capitalize">{fileUpload.detected_category || 'unknown'}</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="font-medium text-orange-600">
                                {language === 'vi' ? 'ƒê·ªô tin c·∫≠y:' : 'Confidence:'}
                              </span>
                              <span className="text-orange-800 capitalize">{fileUpload.confidence || 'unknown'}</span>
                            </div>
                            <p className="text-xs text-orange-600 mt-2">
                              {language === 'vi' 
                                ? 'H·ªá th·ªëng kh√¥ng t·ª± ƒë·ªông nh·∫≠n di·ªán ƒë√¢y l√† Marine Certificate. Vui l√≤ng xem l·∫°i v√† x√°c nh·∫≠n.' 
                                : 'System did not automatically identify this as a Marine Certificate. Please review and confirm.'}
                            </p>
                          </div>
                          
                          {/* Action Buttons */}
                          <div className="flex justify-end space-x-2 mt-3 pt-2 border-t border-orange-200">
                            <button
                              onClick={() => {
                                const reviewData = pendingManualReviews.find(r => r.filename === fileUpload.name);
                                if (reviewData) handleManualReviewAction('view', reviewData);
                              }}
                              className="px-3 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors flex items-center"
                            >
                              <svg className="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                              </svg>
                              {language === 'vi' ? 'Xem' : 'View'}
                            </button>
                            
                            <button
                              onClick={() => {
                                const reviewData = pendingManualReviews.find(r => r.filename === fileUpload.name);
                                if (reviewData) handleManualReviewAction('skip', reviewData);
                              }}
                              className="px-3 py-1 text-xs bg-gray-500 hover:bg-gray-600 text-white rounded-md transition-colors flex items-center"
                            >
                              <svg className="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 9l3 3m0 0l-3 3m3-3H8m13 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              {language === 'vi' ? 'B·ªè qua' : 'Skip'}
                            </button>
                            
                            <button
                              onClick={() => {
                                const reviewData = pendingManualReviews.find(r => r.filename === fileUpload.name);
                                if (reviewData) handleManualReviewAction('confirm_marine', reviewData);
                              }}
                              className="px-3 py-1 text-xs bg-green-600 hover:bg-green-700 text-white rounded-md transition-colors flex items-center"
                            >
                              <svg className="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                              </svg>
                              {language === 'vi' ? 'X√°c nh·∫≠n Marine Cert' : 'Confirm Marine Cert'}
                            </button>
                          </div>
                        </div>
                      )}
                      
                      {/* Non-Marine Certificate */}
                      {fileUpload.status === 'skipped' && (
                        <div className="mt-3 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                          <h5 className="text-sm font-semibold text-yellow-700 mb-1">
                            ‚ö†Ô∏è {language === 'vi' ? 'Kh√¥ng ph·∫£i Marine Certificate' : 'Not a Marine Certificate'}
                          </h5>
                          <p className="text-xs text-yellow-600">
                            {language === 'vi' ? 'File n√†y ƒë√£ ƒë∆∞·ª£c b·ªè qua. Vui l√≤ng ki·ªÉm tra l·∫°i.' : 'This file was skipped. Please review manually.'}
                          </p>
                        </div>
                      )}
                      
                      {/* Requires User Choice */}
                      {fileUpload.status === 'requires_user_choice' && (
                        <div className="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                          <h5 className="text-sm font-semibold text-blue-700 mb-2">
                            üìÅ {language === 'vi' ? 'Ch·ªçn folder ƒë·ªÉ l∆∞u file' : 'Choose folder to save file'}
                          </h5>
                          <p className="text-xs text-blue-600 mb-3">
                            {fileUpload.message}
                          </p>
                          
                          {fileUpload.shipFolderExists ? (
                            <div className="space-y-2">
                              <p className="text-xs font-medium text-gray-700">
                                {language === 'vi' ? 'Folder c√≥ s·∫µn:' : 'Available folders:'}
                              </p>
                              <div className="flex flex-wrap gap-2">
                                {fileUpload.availableFolders?.map((folder, idx) => (
                                  <button
                                    key={idx}
                                    onClick={() => handleUploadToFolder(fileUpload.filename, folder)}
                                    className="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200 transition-colors"
                                  >
                                    üìÇ {folder}
                                  </button>
                                ))}
                                <button
                                  onClick={() => handleSkipFile(fileUpload.filename)}
                                  className="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition-colors"
                                >
                                  ‚è≠Ô∏è {language === 'vi' ? 'B·ªè qua' : 'Skip'}
                                </button>
                              </div>
                            </div>
                          ) : (
                            <div className="text-center">
                              <p className="text-xs text-red-600 mb-2">
                                {language === 'vi' ? 'C·∫ßn t·∫°o ship folder tr∆∞·ªõc' : 'Ship folder needs to be created first'}
                              </p>
                              <button
                                onClick={() => handleSkipFile(fileUpload.filename)}
                                className="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition-colors"
                              >
                                ‚è≠Ô∏è {language === 'vi' ? 'B·ªè qua' : 'Skip'}
                              </button>
                            </div>
                          )}
                        </div>
                      )}
                      
                      {/* Error Display */}
                      {fileUpload.status === 'failed' && fileUpload.error && (
                        <div className="mt-3 p-3 bg-red-50 rounded-lg border border-red-200">
                          <h5 className="text-sm font-semibold text-red-700 mb-1">‚ùå {language === 'vi' ? 'L·ªói' : 'Error'}</h5>
                          <p className="text-xs text-red-600">{fileUpload.error}</p>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}

              {/* Upload Summary */}
              {uploadSummary && (
                <div className="mt-6 p-4 bg-gray-50 rounded-lg border">
                  <h4 className="font-medium text-gray-900 mb-3">
                    üìä {language === 'vi' ? 'B√°o c√°o t·ªïng h·ª£p' : 'Summary Report'}
                  </h4>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div className="text-center">
                      <div className="text-2xl font-bold text-blue-600">{uploadSummary.total_files}</div>
                      <div className="text-gray-600">{language === 'vi' ? 'File upload' : 'Files Uploaded'}</div>
                    </div>
                    <div className="text-center">
                      <div className="text-2xl font-bold text-green-600">{uploadSummary.marine_certificates}</div>
                      <div className="text-gray-600">{language === 'vi' ? 'Marine Cert' : 'Marine Certificates'}</div>
                    </div>
                    <div className="text-center">
                      <div className="text-2xl font-bold text-purple-600">{uploadSummary.records_created}</div>
                      <div className="text-gray-600">{language === 'vi' ? 'Record t·∫°o' : 'Records Created'}</div>
                    </div>
                    <div className="text-center">
                      <div className="text-2xl font-bold text-yellow-600">{uploadSummary.non_marine_files}</div>
                      <div className="text-gray-600">{language === 'vi' ? 'File kh√°c' : 'Non-Marine'}</div>
                    </div>
                  </div>
                  
                  {uploadSummary.non_marine_files > 0 && (
                    <div className="mt-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                      <h5 className="text-sm font-medium text-yellow-800 mb-2">
                        ‚ö†Ô∏è {language === 'vi' ? 'File c·∫ßn ki·ªÉm tra l·∫°i:' : 'Files to Review:'}
                      </h5>
                      <ul className="text-xs text-yellow-700 space-y-1">
                        {uploadSummary.non_marine_list?.map((fileName, index) => (
                          <li key={index}>‚Ä¢ {fileName}</li>
                        ))}
                      </ul>
                    </div>
                  )}
                </div>
              )}
            </div>
            
            {/* OR Divider */}
            <div className="relative">
              <div className="absolute inset-0 flex items-center">
                <div className="w-full border-t border-gray-300" />
              </div>
              <div className="relative flex justify-center text-sm">
                <span className="px-2 bg-white text-gray-500">
                  {language === 'vi' ? 'HO·∫∂C t·∫°o th·ªß c√¥ng' : 'OR create manually'}
                </span>
              </div>
            </div>
            
            {/* Row 1: Certificate Name + Abbreviation + Number */}
            <div className="grid grid-cols-3 gap-3">
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">
                  {language === 'vi' ? 'T√™n ch·ª©ng ch·ªâ' : 'Certificate Name'} *
                </label>
                <input
                  type="text"
                  required
                  value={certificateData.cert_name}
                  onChange={(e) => setCertificateData(prev => ({ ...prev, cert_name: e.target.value }))}
                  className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                  placeholder={language === 'vi' ? 'Safety Management Cert' : 'Safety Management Cert'}
                />
              </div>
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">
                  {language === 'vi' ? 'T√™n vi·∫øt t·∫Øt' : 'Abbreviation'}
                </label>
                <input
                  type="text"
                  value={certificateData.cert_abbreviation}
                  onChange={(e) => setCertificateData(prev => ({ ...prev, cert_abbreviation: e.target.value }))}
                  className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                  placeholder={language === 'vi' ? 'SMC' : 'SMC'}
                />
              </div>
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">
                  {language === 'vi' ? 'S·ªë ch·ª©ng ch·ªâ' : 'Certificate No'} *
                </label>
                <input
                  type="text"
                  required
                  value={certificateData.cert_no}
                  onChange={(e) => setCertificateData(prev => ({ ...prev, cert_no: e.target.value }))}
                  className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                  placeholder={language === 'vi' ? 'S·ªë ch·ª©ng ch·ªâ' : 'Cert Number'}
                />
              </div>
            </div>

            {/* Row 2: Type + Issue Date + Valid Date */}
            <div className="grid grid-cols-3 gap-3">
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">
                  {language === 'vi' ? 'Lo·∫°i' : 'Type'} *
                </label>
                <select
                  required
                  value={certificateData.cert_type}
                  onChange={(e) => setCertificateData(prev => ({ ...prev, cert_type: e.target.value }))}
                  className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="Full Term">Full Term</option>
                  <option value="Interim">Interim</option>
                  <option value="Provisional">Provisional</option>
                  <option value="Short term">Short term</option>
                  <option value="Conditional">Conditional</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">
                  {language === 'vi' ? 'Ng√†y c·∫•p' : 'Issue Date'} *
                </label>
                <input
                  type="date"
                  required
                  value={certificateData.issue_date}
                  onChange={(e) => setCertificateData(prev => ({ ...prev, issue_date: e.target.value }))}
                  className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                />
              </div>
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">
                  {language === 'vi' ? 'Ng√†y h·∫øt h·∫°n' : 'Valid Date'}
                </label>
                <select
                  value={certificateData.valid_date}
                  onChange={(e) => setCertificateData(prev => ({ ...prev, valid_date: e.target.value }))}
                  className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="">{language === 'vi' ? 'Ch·ªçn ng√†y h·∫øt h·∫°n' : 'Select valid date'}</option>
                  <option value="permanent">{language === 'vi' ? 'Vƒ©nh vi·ªÖn' : 'Permanent'}</option>
                  <option value="1-year">{language === 'vi' ? '1 nƒÉm t·ª´ ng√†y c·∫•p' : '1 year from issue'}</option>
                  <option value="2-years">{language === 'vi' ? '2 nƒÉm t·ª´ ng√†y c·∫•p' : '2 years from issue'}</option>
                  <option value="3-years">{language === 'vi' ? '3 nƒÉm t·ª´ ng√†y c·∫•p' : '3 years from issue'}</option>
                  <option value="5-years">{language === 'vi' ? '5 nƒÉm t·ª´ ng√†y c·∫•p' : '5 years from issue'}</option>
                  <option value="custom-date">{language === 'vi' ? 'Ng√†y t·ª± ch·ªçn' : 'Custom date'}</option>
                </select>
                
                {/* Custom date input - hi·ªÉn th·ªã khi ch·ªçn "custom-date" */}
                {certificateData.valid_date === 'custom-date' && (
                  <input
                    type="date"
                    value={certificateData.custom_valid_date || ''}
                    onChange={(e) => setCertificateData(prev => ({ ...prev, custom_valid_date: e.target.value }))}
                    className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent mt-1"
                    placeholder={language === 'vi' ? 'Ch·ªçn ng√†y h·∫øt h·∫°n' : 'Select expiry date'}
                  />
                )}
              </div>
            </div>

            {/* Row 3: Last Endorse + Next Survey + Next Survey Type */}
            <div className="grid grid-cols-3 gap-3">
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">
                  {language === 'vi' ? 'X√°c nh·∫≠n cu·ªëi' : 'Last Endorse'}
                  {certificateData.cert_type !== 'Full Term' && (
                    <span className="text-xs text-gray-400 ml-1">(Full Term only)</span>
                  )}
                </label>
                <input
                  type="date"
                  value={certificateData.last_endorse}
                  onChange={(e) => setCertificateData(prev => ({ ...prev, last_endorse: e.target.value }))}
                  disabled={certificateData.cert_type !== 'Full Term'}
                  className={`w-full px-2 py-1.5 text-sm border rounded focus:ring-1 focus:ring-blue-500 ${
                    certificateData.cert_type !== 'Full Term' 
                      ? 'border-gray-200 bg-gray-50 text-gray-400 cursor-not-allowed'
                      : 'border-gray-300 focus:border-transparent'
                  }`}
                />
              </div>
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">
                  {language === 'vi' ? 'Ki·ªÉm tra ti·∫øp theo' : 'Next Survey'}
                </label>
                <input
                  type="date"
                  value={certificateData.next_survey}
                  onChange={(e) => setCertificateData(prev => ({ ...prev, next_survey: e.target.value }))}
                  className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                />
              </div>
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">
                  {language === 'vi' ? 'Lo·∫°i ki·ªÉm tra' : 'Survey Type'}
                </label>
                <select
                  value={certificateData.next_survey_type || ''}
                  onChange={(e) => setCertificateData(prev => ({ ...prev, next_survey_type: e.target.value }))}
                  className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="">{language === 'vi' ? 'Ch·ªçn lo·∫°i ki·ªÉm tra' : 'Select survey type'}</option>
                  <option value="Initial">{language === 'vi' ? 'Ki·ªÉm tra l·∫ßn ƒë·∫ßu' : 'Initial'}</option>
                  <option value="Annual">{language === 'vi' ? 'Ki·ªÉm tra h√†ng nƒÉm' : 'Annual'}</option>
                  <option value="Intermediate">{language === 'vi' ? 'Ki·ªÉm tra trung gian' : 'Intermediate'}</option>
                  <option value="Special">{language === 'vi' ? 'Ki·ªÉm tra ƒë·ªãnh k·ª≥' : 'Special'}</option>
                  <option value="Renewal">{language === 'vi' ? 'Ki·ªÉm tra c·∫•p m·ªõi' : 'Renewal'}</option>
                  <option value="Docking">{language === 'vi' ? 'Ki·ªÉm tra tr√™n ƒë√†' : 'Docking'}</option>
                  <option value="Other">{language === 'vi' ? 'Kh√°c' : 'Other'}</option>
                </select>
              </div>
            </div>

            {/* Row 4: Issued By + Status + Category */}
            <div className="grid grid-cols-3 gap-3">
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">
                  {language === 'vi' ? 'C·∫•p b·ªüi' : 'Issued By'} *
                </label>
                <input
                  type="text"
                  required
                  value={certificateData.issued_by}
                  onChange={(e) => setCertificateData(prev => ({ ...prev, issued_by: e.target.value }))}
                  className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                  placeholder={language === 'vi' ? 'DNV GL, Lloyd\'s...' : 'DNV GL, Lloyd\'s...'}
                />
              </div>
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">
                  {language === 'vi' ? 'Tr·∫°ng th√°i' : 'Status'} *
                </label>
                <select
                  required
                  value={certificateData.status}
                  onChange={(e) => setCertificateData(prev => ({ ...prev, status: e.target.value }))}
                  className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="valid">{language === 'vi' ? 'C√≥ hi·ªáu l·ª±c' : 'Valid'}</option>
                  <option value="expired">{language === 'vi' ? 'H·∫øt h·∫°n' : 'Expired'}</option>
                  <option value="over_due">{language === 'vi' ? 'Qu√° h·∫°n' : 'Over Due'}</option>
                  <option value="suspended">{language === 'vi' ? 'T·∫°m ng·ª´ng' : 'Suspended'}</option>
                  <option value="withdrawn">{language === 'vi' ? 'Thu h·ªìi' : 'Withdrawn'}</option>
                  <option value="pending">{language === 'vi' ? 'ƒêang ch·ªù' : 'Pending'}</option>
                </select>
              </div>
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">
                  {language === 'vi' ? 'Danh m·ª•c' : 'Category'} *
                </label>
                <input
                  type="text"
                  value={language === 'vi' ? 'Gi·∫•y ch·ª©ng nh·∫≠n' : 'Certificates'}
                  readOnly
                  className="w-full px-2 py-1.5 text-sm border border-gray-200 bg-gray-50 rounded text-gray-600 cursor-not-allowed"
                />
                <input
                  type="hidden"
                  value="certificates"
                  onChange={() => {}} // Keep certificates value for form submission
                />
              </div>
            </div>

            {/* Row 5: Sensitivity Level + Notes (2/3 width for notes) */}
            <div className="grid grid-cols-4 gap-3">
              <div>
                <label className="block text-xs font-medium text-gray-700 mb-1">
                  {language === 'vi' ? 'M·ª©c b·∫£o m·∫≠t' : 'Sensitivity'} *
                </label>
                <select
                  required
                  value={certificateData.sensitivity_level}
                  onChange={(e) => setCertificateData(prev => ({ ...prev, sensitivity_level: e.target.value }))}
                  className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="public">{language === 'vi' ? 'C√¥ng khai' : 'Public'}</option>
                  <option value="internal">{language === 'vi' ? 'N·ªôi b·ªô' : 'Internal'}</option>
                  <option value="confidential">{language === 'vi' ? 'B√≠ m·∫≠t' : 'Confidential'}</option>
                  <option value="restricted">{language === 'vi' ? 'H·∫°n ch·∫ø' : 'Restricted'}</option>
                </select>
              </div>
              <div className="col-span-3">
                <label className="block text-xs font-medium text-gray-700 mb-1">
                  {language === 'vi' ? 'Ghi ch√∫' : 'Notes'}
                </label>
                <textarea
                  value={certificateData.notes}
                  onChange={(e) => setCertificateData(prev => ({ ...prev, notes: e.target.value }))}
                  rows="2"
                  className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent resize-none"
                  placeholder={language === 'vi' 
                    ? 'Ghi ch√∫ b·ªï sung (t√πy ch·ªçn)...' 
                    : 'Additional notes (optional)...'}
                />
              </div>
            </div>
          </div>
        )}

        {/* Survey Report Form */}
        {activeTab === 'documents' && selectedDocumentType === 'survey_report' && (
          <div className="space-y-4">
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
              <div className="flex items-center">
                <div className="text-yellow-600 mr-3">üöß</div>
                <div>
                  <h4 className="text-sm font-medium text-yellow-800">
                    {language === 'vi' ? 'ƒêang ph√°t tri·ªÉn' : 'Under Development'}
                  </h4>
                  <p className="text-sm text-yellow-700 mt-1">
                    {language === 'vi' 
                      ? 'Ch·ª©c nƒÉng th√™m H·ªì s∆° ƒêƒÉng ki·ªÉm ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.' 
                      : 'Class Survey Report creation feature is under development.'}
                  </p>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Crew Records Tab */}
        {activeTab === 'crew' && (
          <div className="space-y-4">
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
              <div className="flex items-center">
                <div className="text-yellow-600 mr-3">üöß</div>
                <div>
                  <h4 className="text-sm font-medium text-yellow-800">
                    {language === 'vi' ? 'ƒêang ph√°t tri·ªÉn' : 'Under Development'}
                  </h4>
                  <p className="text-sm text-yellow-700 mt-1">
                    {language === 'vi' 
                      ? 'Ch·ª©c nƒÉng qu·∫£n l√Ω h·ªì s∆° thuy·ªÅn vi√™n ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.' 
                      : 'Crew Records management feature is under development.'}
                  </p>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ISM Records Tab */}
        {activeTab === 'ism' && (
          <div className="space-y-4">
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
              <div className="flex items-center">
                <div className="text-yellow-600 mr-3">üöß</div>
                <div>
                  <h4 className="text-sm font-medium text-yellow-800">
                    {language === 'vi' ? 'ƒêang ph√°t tri·ªÉn' : 'Under Development'}
                  </h4>
                  <p className="text-sm text-yellow-700 mt-1">
                    {language === 'vi' 
                      ? 'Ch·ª©c nƒÉng qu·∫£n l√Ω h·ªì s∆° ISM ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.' 
                      : 'ISM Records management feature is under development.'}
                  </p>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ISPS Records Tab */}
        {activeTab === 'isps' && (
          <div className="space-y-4">
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
              <div className="flex items-center">
                <div className="text-yellow-600 mr-3">üöß</div>
                <div>
                  <h4 className="text-sm font-medium text-yellow-800">
                    {language === 'vi' ? 'ƒêang ph√°t tri·ªÉn' : 'Under Development'}
                  </h4>
                  <p className="text-sm text-yellow-700 mt-1">
                    {language === 'vi' 
                      ? 'Ch·ª©c nƒÉng qu·∫£n l√Ω h·ªì s∆° ISPS ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.' 
                      : 'ISPS Records management feature is under development.'}
                  </p>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* MLC Records Tab */}
        {activeTab === 'mlc' && (
          <div className="space-y-4">
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
              <div className="flex items-center">
                <div className="text-yellow-600 mr-3">üöß</div>
                <div>
                  <h4 className="text-sm font-medium text-yellow-800">
                    {language === 'vi' ? 'ƒêang ph√°t tri·ªÉn' : 'Under Development'}
                  </h4>
                  <p className="text-sm text-yellow-700 mt-1">
                    {language === 'vi' 
                      ? 'Ch·ª©c nƒÉng qu·∫£n l√Ω h·ªì s∆° MLC ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.' 
                      : 'MLC Records management feature is under development.'}
                  </p>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Supplies Tab */}
        {activeTab === 'supplies' && (
          <div className="space-y-4">
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
              <div className="flex items-center">
                <div className="text-yellow-600 mr-3">üöß</div>
                <div>
                  <h4 className="text-sm font-medium text-yellow-800">
                    {language === 'vi' ? 'ƒêang ph√°t tri·ªÉn' : 'Under Development'}
                  </h4>
                  <p className="text-sm text-yellow-700 mt-1">
                    {language === 'vi' 
                      ? 'Ch·ª©c nƒÉng qu·∫£n l√Ω v·∫≠t t∆∞ ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.' 
                      : 'Supplies management feature is under development.'}
                  </p>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Ship Form */}
        {activeTab === 'ship' && (
          <div className="grid grid-cols-12 gap-4">
            
            {/* Basic Ship Information Section */}
            <div className="col-span-12">
              <h4 className="text-lg font-semibold text-gray-700 mb-3 pb-2 border-b">
                {language === 'vi' ? 'Th√¥ng tin c∆° b·∫£n' : 'Basic Information'}
              </h4>
            </div>
            
            {/* Ship Name - Full width */}
            <div className="col-span-6">
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'T√™n t√†u' : 'Ship Name'} *
              </label>
              <input
                type="text"
                required
                value={shipData.name}
                onChange={(e) => setShipData(prev => ({ ...prev, name: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                placeholder={language === 'vi' ? 'Nh·∫≠p t√™n t√†u' : 'Enter ship name'}
              />
            </div>

            {/* IMO - Short width */}
            <div className="col-span-3">
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'S·ªë IMO' : 'IMO Number'} *
              </label>
              <input
                type="text"
                required
                value={shipData.imo_number}
                onChange={(e) => setShipData(prev => ({ ...prev, imo_number: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                placeholder="1234567"
              />
            </div>

            {/* Flag - Medium width */}
            <div className="col-span-3">
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'C·ªù' : 'Flag'} *
              </label>
              <input
                type="text"
                required
                value={shipData.flag}
                onChange={(e) => setShipData(prev => ({ ...prev, flag: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                placeholder={language === 'vi' ? 'Vi·ªát Nam, Singapore...' : 'Vietnam, Singapore...'}
              />
            </div>

            {/* Class Society - Medium width */}
            <div className="col-span-4">
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'T·ªï ch·ª©c Ph√¢n c·∫•p' : 'Class Society'} *
              </label>
              <input
                type="text"
                required
                value={shipData.class_society}
                onChange={(e) => setShipData(prev => ({ ...prev, class_society: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                placeholder="DNV GL, ABS, LR..."
              />
            </div>

            {/* Ship Owner - Medium width */}
            <div className="col-span-4">
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'Ch·ªß t√†u' : 'Ship Owner'} *
              </label>
              <select
                required
                value={shipData.ship_owner}
                onChange={(e) => setShipData(prev => ({ ...prev, ship_owner: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
              >
                <option value="">{language === 'vi' ? 'Ch·ªçn ch·ªß t√†u' : 'Select ship owner'}</option>
                {availableCompanies.map(company => (
                  <option key={company.id} value={language === 'vi' ? company.name_vn : company.name_en}>
                    {language === 'vi' ? company.name_vn : company.name_en}
                  </option>
                ))}
              </select>
            </div>

            {/* Gross Tonnage - Short width */}
            <div className="col-span-2">
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'GT' : 'GT'}
              </label>
              <input
                type="number"
                value={shipData.gross_tonnage}
                onChange={(e) => setShipData(prev => ({ ...prev, gross_tonnage: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                placeholder="0"
              />
            </div>

            {/* Deadweight - Short width */}
            <div className="col-span-2">
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'DWT' : 'DWT'}
              </label>
              <input
                type="number"
                value={shipData.deadweight}
                onChange={(e) => setShipData(prev => ({ ...prev, deadweight: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                placeholder="0"
              />
            </div>

            {/* Delivery Date - Short width */}
            <div className="col-span-2">
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'Ng√†y giao' : 'Delivery Date'}
              </label>
              <input
                type="date"
                value={shipData.delivery_date || ''}
                onChange={(e) => setShipData(prev => ({ ...prev, delivery_date: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
              />
            </div>

            {/* Keel Laid - Short width */}
            <div className="col-span-2">
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'Keel Laid' : 'Keel Laid'}
              </label>
              <input
                type="date"
                value={shipData.keel_laid || ''}
                onChange={(e) => setShipData(prev => ({ ...prev, keel_laid: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
              />
            </div>

            {/* Company - Short width (locked) */}
            <div className="col-span-2">
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'C√¥ng ty' : 'Company'} *
              </label>
              <div className="relative">
                <select
                  required
                  disabled
                  value={shipData.company}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600 cursor-not-allowed text-sm"
                >
                  <option value={shipData.company}>
                    {shipData.company || (language === 'vi' ? 'C√¥ng ty c·ªßa b·∫°n' : 'Your company')}
                  </option>
                </select>
                <div className="absolute right-2 top-2 text-gray-400 text-sm">
                  üîí
                </div>
              </div>
            </div>

            {/* Survey & Maintenance Section */}
            <div className="col-span-12 mt-4">
              <h4 className="text-lg font-semibold text-gray-700 mb-3 pb-2 border-b">
                {language === 'vi' ? 'Th√¥ng tin Chi ti·∫øt T√†u (T√πy ch·ªçn)' : 'Detailed Ship Information (Optional)'}
              </h4>
            </div>

            {/* Row 1 - Docking Information */}
            <div className="col-span-3">
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'Last Docking 1' : 'Last Docking 1'}
              </label>
              <input
                type="text"
                value={shipData.last_docking || ''}
                onChange={(e) => setShipData(prev => ({ ...prev, last_docking: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                placeholder="11/2020"
              />
            </div>

            <div className="col-span-3">
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'Last Docking 2' : 'Last Docking 2'}
              </label>
              <input
                type="text"
                value={shipData.last_docking_2 || ''}
                onChange={(e) => setShipData(prev => ({ ...prev, last_docking_2: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                placeholder="08/2021"
              />
            </div>

            <div className="col-span-3">
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'Next Docking' : 'Next Docking'}
              </label>
              <input
                type="date"
                value={shipData.next_docking || ''}
                onChange={(e) => setShipData(prev => ({ ...prev, next_docking: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
              />
            </div>

            <div className="col-span-3">
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'Anniversary Date' : 'Anniversary Date'}
              </label>
              <div className="grid grid-cols-2 gap-2">
                <input
                  type="number"
                  min="1"
                  max="31"
                  value={shipData.anniversary_date_day || ''}
                  onChange={(e) => setShipData(prev => ({ ...prev, anniversary_date_day: e.target.value }))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                  placeholder="Day"
                />
                <select
                  value={shipData.anniversary_date_month || ''}
                  onChange={(e) => setShipData(prev => ({ ...prev, anniversary_date_month: e.target.value }))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                >
                  <option value="">Month</option>
                  <option value="1">Jan</option>
                  <option value="2">Feb</option>
                  <option value="3">Mar</option>
                  <option value="4">Apr</option>
                  <option value="5">May</option>
                  <option value="6">Jun</option>
                  <option value="7">Jul</option>
                  <option value="8">Aug</option>
                  <option value="9">Sep</option>
                  <option value="10">Oct</option>
                  <option value="11">Nov</option>
                  <option value="12">Dec</option>
                </select>
              </div>
            </div>

            {/* Row 2 - Survey Information */}
            <div className="col-span-3">
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'Last Special Survey' : 'Last Special Survey'}
              </label>
              <input
                type="date"
                value={shipData.last_special_survey || ''}
                onChange={(e) => setShipData(prev => ({ ...prev, last_special_survey: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
              />
            </div>

            <div className="col-span-3">
              <label className="block text-sm font-medium text-gray-700 mb-1">
                <span className="flex items-center">
                  {language === 'vi' ? 'Last Intermediate Survey' : 'Last Intermediate Survey'}
                  <div className="group relative ml-1">
                    <svg className="w-3 h-3 text-gray-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div className="absolute bottom-full left-0 mb-2 w-64 p-2 text-xs text-white bg-gray-800 rounded opacity-0 group-hover:opacity-100 transition-opacity z-10">
                      {language === 'vi' 
                        ? 'Ki·ªÉm tra trung gian th·ª±c hi·ªán gi·ªØa 2 Special Survey (th∆∞·ªùng 2.5-3 nƒÉm). B·∫Øt bu·ªôc theo quy ƒë·ªãnh IMO v√† Class Society.'
                        : 'Intermediate inspection conducted between Special Surveys (typically 2.5-3 years). Required by IMO and Class Society regulations.'}
                    </div>
                  </div>
                </span>
              </label>
              <input
                type="date"
                value={shipData.last_intermediate_survey || ''}
                onChange={(e) => setShipData(prev => ({ ...prev, last_intermediate_survey: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
              />
            </div>

            <div className="col-span-3">
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'Special Survey From Date' : 'Special Survey From Date'}
              </label>
              <input
                type="date"
                value={shipData.special_survey_from_date || ''}
                onChange={(e) => setShipData(prev => ({ ...prev, special_survey_from_date: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
              />
            </div>

            <div className="col-span-3">
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {language === 'vi' ? 'Special Survey To Date' : 'Special Survey To Date'}
              </label>
              <input
                type="date"
                value={shipData.special_survey_to_date || ''}
                onChange={(e) => setShipData(prev => ({ ...prev, special_survey_to_date: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
              />
            </div>
          </div>
        )}

        {/* File Upload Section for Certificate */}
        {showFileUpload && selectedDocumentType === 'certificate' && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]">
            <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-semibold text-gray-900">
                  {language === 'vi' ? 'Upload File Certificate' : 'Upload Certificate File'}
                </h3>
                <button
                  onClick={() => {
                    setShowFileUpload(false);
                    setSelectedFile(null);
                  }}
                  className="text-gray-400 hover:text-gray-600"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
              
              <div className="space-y-4">
                {/* File Selection */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    {language === 'vi' ? 'Ch·ªçn file Certificate' : 'Select Certificate File'}
                  </label>
                  <input
                    type="file"
                    accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                    onChange={(e) => setSelectedFile(e.target.files[0])}
                    className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                  />
                  {selectedFile && (
                    <p className="mt-2 text-sm text-gray-600">
                      {language === 'vi' ? 'ƒê√£ ch·ªçn:' : 'Selected:'} {selectedFile.name}
                    </p>
                  )}
                </div>

                {/* Upload Destination Info */}
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                  <div className="flex">
                    <div className="text-blue-600 mr-3">
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </div>
                    <div>
                      <h4 className="text-sm font-medium text-blue-800 mb-1">
                        {language === 'vi' ? 'Th√¥ng tin Upload' : 'Upload Information'}
                      </h4>
                      <p className="text-xs text-blue-700">
                        {language === 'vi' 
                          ? 'File s·∫Ω ƒë∆∞·ª£c upload l√™n Google Drive folder "Certificate" c·ªßa c√¥ng ty.'
                          : 'File will be uploaded to company\'s Google Drive "Certificate" folder.'}
                      </p>
                      {selectedShip && (
                        <p className="text-xs text-blue-700 mt-1">
                          {language === 'vi' ? 'T√†u:' : 'Ship:'} <strong>{selectedShip.name}</strong>
                        </p>
                      )}
                    </div>
                  </div>
                </div>

                {/* Action Buttons */}
                <div className="flex justify-end space-x-3 mt-6">
                  <button
                    onClick={() => {
                      setShowFileUpload(false);
                      setSelectedFile(null);
                    }}
                    disabled={uploadingFile}
                    className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all disabled:opacity-50"
                  >
                    {language === 'vi' ? 'H·ªßy' : 'Cancel'}
                  </button>
                  <button
                    onClick={() => {
                      // Handle file upload logic here
                      handleFileUpload();
                    }}
                    disabled={!selectedFile || uploadingFile}
                    className="px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white rounded-lg transition-all flex items-center"
                  >
                    {uploadingFile && <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>}
                    {language === 'vi' ? 'Upload File' : 'Upload File'}
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        <div className="flex justify-end space-x-4 mt-8">
          <button
            onClick={onClose}
            disabled={isSubmitting}
            className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all disabled:opacity-50"
          >
            {language === 'vi' ? 'H·ªßy' : 'Cancel'}
          </button>
          
          {/* Add File button - only show for Certificate in Documents tab */}
          {activeTab === 'documents' && selectedDocumentType === 'certificate' && (
            <button
              onClick={() => setShowFileUpload(true)}
              disabled={isSubmitting || uploadingFile}
              className="px-6 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white rounded-lg transition-all flex items-center"
            >
              {uploadingFile && <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>}
              {language === 'vi' ? 'üìÅ Th√™m File' : 'üìÅ Add File'}
            </button>
          )}
          
          <button
            onClick={handleSubmit}
            disabled={
              isSubmitting || 
              (recordType === 'certificate' && !selectedShip) ||
              (activeTab === 'documents' && !selectedDocumentType) ||
              ['crew', 'ism', 'isps', 'mlc', 'supplies'].includes(activeTab)
            }
            className="px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg transition-all flex items-center"
          >
            {isSubmitting && <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>}
            {activeTab === 'ship' 
              ? (language === 'vi' ? 'üö¢ Th√™m t√†u m·ªõi' : 'üö¢ Add New Ship')
              : selectedDocumentType === 'certificate'
              ? (language === 'vi' ? 'üìÑ Th√™m Certificate' : 'üìÑ Add Certificate')
              : selectedDocumentType === 'survey_report'
              ? (language === 'vi' ? 'üìã Th√™m H·ªì s∆° ƒêƒÉng ki·ªÉm' : 'üìã Add Class Survey Report')
              : activeTab === 'documents'
              ? (language === 'vi' ? 'Ch·ªçn lo·∫°i t√†i li·ªáu' : 'Select document type')
              : activeTab === 'crew'
              ? (language === 'vi' ? 'üë• Th√™m Thuy·ªÅn vi√™n' : 'üë• Add Crew Record')
              : activeTab === 'ism'
              ? (language === 'vi' ? 'üìã Th√™m ISM' : 'üìã Add ISM Record')
              : activeTab === 'isps'
              ? (language === 'vi' ? 'üõ°Ô∏è Th√™m ISPS' : 'üõ°Ô∏è Add ISPS Record')
              : activeTab === 'mlc'
              ? (language === 'vi' ? '‚öñÔ∏è Th√™m MLC' : '‚öñÔ∏è Add MLC Record')
              : activeTab === 'supplies'
              ? (language === 'vi' ? 'üì¶ Th√™m V·∫≠t t∆∞' : 'üì¶ Add Supplies')
              : (language === 'vi' ? 'Th√™m h·ªì s∆°' : 'Add Record')
            }
          </button>
        </div>
      </div>
      
      {/* PDF Analysis Modal */}
      {showPdfAnalysis && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[99999] p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md">
            <div className="flex justify-between items-center p-6 border-b border-gray-200">
              <h3 className="text-xl font-bold text-gray-800">
                {language === 'vi' ? 'Ph√¢n t√≠ch Gi·∫•y ch·ª©ng nh·∫≠n' : 'Certificate Analysis'}
              </h3>
              <button
                onClick={() => {
                  setShowPdfAnalysis(false);
                  setPdfFile(null);
                }}
                className="text-gray-400 hover:text-gray-600 text-2xl font-bold leading-none"
              >
                √ó
              </button>
            </div>
            
            <div className="p-6">
              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  {language === 'vi' ? 'Ch·ªçn file PDF (t·ªëi ƒëa 5MB)' : 'Select PDF file (max 5MB)'}
                </label>
                <input
                  type="file"
                  accept=".pdf"
                  onChange={(e) => {
                    const file = e.target.files[0];
                    if (file && file.size > 5 * 1024 * 1024) {
                      toast.error(language === 'vi' ? 'File qu√° l·ªõn! T·ªëi ƒëa 5MB' : 'File too large! Max 5MB');
                      return;
                    }
                    setPdfFile(file);
                  }}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>
              
              {pdfFile && (
                <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                  <p className="text-sm text-blue-800">
                    üìÑ {pdfFile.name} ({(pdfFile.size / 1024 / 1024).toFixed(2)}MB)
                  </p>
                </div>
              )}
              
              <div className="flex gap-3">
                <button
                  onClick={() => {
                    setShowPdfAnalysis(false);
                    setPdfFile(null);
                  }}
                  className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all"
                  disabled={pdfAnalyzing}
                >
                  {language === 'vi' ? 'H·ªßy' : 'Cancel'}
                </button>
                <button
                  onClick={handlePdfAnalysis}
                  disabled={pdfAnalyzing || !pdfFile}
                  className="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg transition-all flex items-center justify-center"
                >
                  {pdfAnalyzing ? (
                    <>
                      <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                      {language === 'vi' ? 'ƒêang ph√¢n t√≠ch...' : 'Analyzing...'}
                    </>
                  ) : (
                    language === 'vi' ? 'Ph√¢n t√≠ch PDF' : 'Analyze PDF'
                  )}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Duplicate Certificate Modal */}
      {duplicateModal.show && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70]">
          <div className="bg-white rounded-xl shadow-2xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div className="mb-6">
              <h3 className="text-xl font-bold text-red-600 mb-2">
                ‚ö†Ô∏è {language === 'vi' ? 'Ph√°t hi·ªán gi·∫•y ch·ª©ng nh·∫≠n tr√πng l·∫∑p' : 'Duplicate Certificate Detected'}
              </h3>
              <p className="text-gray-600">
                {language === 'vi' 
                  ? `File "${duplicateModal.currentFile}" c√≥ Certificate No v√† Cert Name tr√πng v·ªõi gi·∫•y ch·ª©ng nh·∫≠n ƒë√£ c√≥:`
                  : `File "${duplicateModal.currentFile}" has matching Certificate No and Cert Name with existing certificate:`}
              </p>
            </div>

            {/* Show duplicate certificates */}
            <div className="mb-6 max-h-60 overflow-y-auto">
              {duplicateModal.duplicates && duplicateModal.duplicates.map((duplicate, index) => (
                <div key={index} className="bg-red-50 border border-red-200 rounded-lg p-4 mb-3">
                  <div className="grid grid-cols-2 gap-4 text-sm">
                    <div>
                      <span className="font-medium text-gray-700">{language === 'vi' ? 'T√™n ch·ª©ng ch·ªâ:' : 'Cert Name:'}</span>
                      <p className="text-gray-900">{duplicate.existing_cert?.cert_name || 'N/A'}</p>
                    </div>
                    <div>
                      <span className="font-medium text-gray-700">{language === 'vi' ? 'S·ªë ch·ª©ng ch·ªâ:' : 'Cert No:'}</span>
                      <p className="text-gray-900">{duplicate.existing_cert?.cert_no || 'N/A'}</p>
                    </div>
                    <div>
                      <span className="font-medium text-gray-700">{language === 'vi' ? 'Ng√†y c·∫•p:' : 'Issue Date:'}</span>
                      <p className="text-gray-900">{formatDateDisplay(duplicate.existing_cert?.issue_date)}</p>
                    </div>
                    <div>
                      <span className="font-medium text-gray-700">{language === 'vi' ? 'Ng√†y h·∫øt h·∫°n:' : 'Valid Date:'}</span>
                      <p className="text-gray-900">{formatDateDisplay(duplicate.existing_cert?.valid_date)}</p>
                    </div>
                  </div>
                  <div className="mt-2 text-xs text-red-600">
                    {language === 'vi' ? 'ƒê·ªô tr√πng l·∫∑p:' : 'Similarity:'} {duplicate.similarity?.toFixed(1)}%
                  </div>
                </div>
              ))}
            </div>

            {/* Action buttons */}
            <div className="flex justify-end space-x-3">
              <button
                onClick={() => handleLocalDuplicateResolution('cancel')}
                className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all"
              >
                {language === 'vi' ? 'H·ªßy' : 'Cancel'}
              </button>
              <button
                onClick={() => handleLocalDuplicateResolution('overwrite')}
                className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-all"
              >
                {language === 'vi' ? 'Ghi ƒë√®' : 'Overwrite'}
              </button>
              <button
                onClick={() => handleLocalDuplicateResolution('keep_both')}
                className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all"
              >
                {language === 'vi' ? 'Gi·ªØ c·∫£ hai' : 'Keep Both'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Duplicate Resolution Modal */}
      {duplicateResolutionModal.show && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[80]">
          <div className="bg-white rounded-xl shadow-2xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div className="mb-6 relative">
              <h3 className="text-xl font-bold text-orange-600 mb-2">
                ‚ö†Ô∏è {language === 'vi' ? 'Ph√°t hi·ªán ch·ª©ng ch·ªâ tr√πng l·∫∑p' : 'Duplicate Certificate Detected'}
                {duplicateQueue.length > 1 && (
                  <span className="ml-2 text-sm font-medium text-gray-500 bg-gray-100 px-2 py-1 rounded">
                    {duplicateQueue.length > 1 
                      ? (language === 'vi' 
                          ? `C√≤n ${duplicateQueue.length - 1} tr√πng l·∫∑p n·ªØa`
                          : `${duplicateQueue.length - 1} more duplicates remaining`)
                      : ''}
                  </span>
                )}
              </h3>
              
              {/* Close button */}
              <button
                onClick={() => {
                  // Process next duplicate in queue (will close modal if no more duplicates)
                  processNextDuplicate();
                  
                  // Reset multi cert processing state when modal is closed
                  if (setIsMultiCertProcessing) {
                    setIsMultiCertProcessing(false);
                  }
                }}
                className="absolute top-0 right-0 text-gray-400 hover:text-gray-600 text-2xl font-bold"
              >
                √ó
              </button>
              <p className="text-gray-600">
                {language === 'vi' 
                  ? 'H·ªá th·ªëng ph√°t hi·ªán ch·ª©ng ch·ªâ c√≥ th·ªÉ tr√πng l·∫∑p. Vui l√≤ng xem x√©t th√¥ng tin b√™n d∆∞·ªõi v√† quy·∫øt ƒë·ªãnh:'
                  : 'System detected a potential duplicate certificate. Please review the information below and decide:'
                }
              </p>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              {/* Existing Certificate */}
              <div className="border border-red-200 rounded-lg p-4 bg-red-50">
                <h4 className="font-bold text-red-800 mb-3">
                  üìã {language === 'vi' ? 'Ch·ª©ng ch·ªâ ƒë√£ t·ªìn t·∫°i' : 'Existing Certificate'}
                </h4>
                {duplicateResolutionModal.duplicateInfo?.existing_certificate && (
                  <div className="space-y-2 text-sm">
                    <div>
                      <span className="font-medium text-gray-700">{language === 'vi' ? 'T√™n:' : 'Name:'}</span>
                      <p className="text-gray-900">{duplicateResolutionModal.duplicateInfo.existing_certificate.cert_name}</p>
                    </div>
                    <div>
                      <span className="font-medium text-gray-700">{language === 'vi' ? 'S·ªë ch·ª©ng ch·ªâ:' : 'Certificate No:'}</span>
                      <p className="text-gray-900">{duplicateResolutionModal.duplicateInfo.existing_certificate.cert_no}</p>
                    </div>
                    <div>
                      <span className="font-medium text-gray-700">{language === 'vi' ? 'Lo·∫°i:' : 'Type:'}</span>
                      <p className="text-gray-900">{duplicateResolutionModal.duplicateInfo.existing_certificate.cert_type}</p>
                    </div>
                    <div>
                      <span className="font-medium text-gray-700">{language === 'vi' ? 'Ng√†y c·∫•p:' : 'Issue Date:'}</span>
                      <p className="text-gray-900">{formatDateDisplay(duplicateResolutionModal.duplicateInfo.existing_certificate.issue_date)}</p>
                    </div>
                    <div>
                      <span className="font-medium text-gray-700">{language === 'vi' ? 'Ng√†y h·∫øt h·∫°n:' : 'Valid Date:'}</span>
                      <p className="text-gray-900">{formatDateDisplay(duplicateResolutionModal.duplicateInfo.existing_certificate.valid_date)}</p>
                    </div>
                    <div>
                      <span className="font-medium text-gray-700">{language === 'vi' ? 'C·∫•p b·ªüi:' : 'Issued By:'}</span>
                      <p className="text-gray-900">{duplicateResolutionModal.duplicateInfo.existing_certificate.issued_by || 'N/A'}</p>
                    </div>
                  </div>
                )}
              </div>

              {/* New Certificate */}
              <div className="border border-blue-200 rounded-lg p-4 bg-blue-50">
                <h4 className="font-bold text-blue-800 mb-3">
                  üìÑ {language === 'vi' ? 'Ch·ª©ng ch·ªâ m·ªõi (ƒëang upload)' : 'New Certificate (uploading)'}
                </h4>
                {duplicateResolutionModal.duplicateInfo?.new_certificate && (
                  <div className="space-y-2 text-sm">
                    <div>
                      <span className="font-medium text-gray-700">{language === 'vi' ? 'T√™n:' : 'Name:'}</span>
                      <p className="text-gray-900">{duplicateResolutionModal.duplicateInfo.new_certificate.cert_name}</p>
                    </div>
                    <div>
                      <span className="font-medium text-gray-700">{language === 'vi' ? 'S·ªë ch·ª©ng ch·ªâ:' : 'Certificate No:'}</span>
                      <p className="text-gray-900">{duplicateResolutionModal.duplicateInfo.new_certificate.cert_no}</p>
                    </div>
                    <div>
                      <span className="font-medium text-gray-700">{language === 'vi' ? 'Lo·∫°i:' : 'Type:'}</span>
                      <p className="text-gray-900">{duplicateResolutionModal.duplicateInfo.new_certificate.cert_type}</p>
                    </div>
                    <div>
                      <span className="font-medium text-gray-700">{language === 'vi' ? 'Ng√†y c·∫•p:' : 'Issue Date:'}</span>
                      <p className="text-gray-900">{formatDateDisplay(duplicateResolutionModal.duplicateInfo.new_certificate.issue_date)}</p>
                    </div>
                    <div>
                      <span className="font-medium text-gray-700">{language === 'vi' ? 'Ng√†y h·∫øt h·∫°n:' : 'Valid Date:'}</span>
                      <p className="text-gray-900">{formatDateDisplay(duplicateResolutionModal.duplicateInfo.new_certificate.valid_date)}</p>
                    </div>
                    <div>
                      <span className="font-medium text-gray-700">{language === 'vi' ? 'C·∫•p b·ªüi:' : 'Issued By:'}</span>
                      <p className="text-gray-900">{duplicateResolutionModal.duplicateInfo.new_certificate.issued_by || 'N/A'}</p>
                    </div>
                  </div>
                )}
              </div>
            </div>

            {/* Similarity Info */}
            <div className="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
              <h4 className="font-bold text-yellow-800 mb-2">
                üìä {language === 'vi' ? 'Th√¥ng tin tr√πng l·∫∑p' : 'Duplicate Information'}
              </h4>
              <p className="text-sm text-yellow-700">
                {language === 'vi' ? 'ƒê·ªô t∆∞∆°ng ƒë·ªìng:' : 'Similarity:'} 
                <span className="font-bold ml-1">{duplicateResolutionModal.duplicateInfo?.similarity || 0}%</span>
              </p>
              <p className="text-xs text-yellow-600 mt-1">
                {language === 'vi' 
                  ? 'S·ªë ch·ª©ng ch·ªâ kh·ªõp ch√≠nh x√°c, t√™n ch·ª©ng ch·ªâ c√≥ ƒë·ªô t∆∞∆°ng ƒë·ªìng >75%'
                  : 'Certificate number matches exactly, certificate name similarity >75%'
                }
              </p>
            </div>

            {/* File Info */}
            <div className="mb-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
              <h4 className="font-bold text-gray-800 mb-2">
                üìÅ {language === 'vi' ? 'Th√¥ng tin file' : 'File Information'}
              </h4>
              <p className="text-sm text-gray-700">
                <span className="font-medium">{language === 'vi' ? 'T√™n file:' : 'Filename:'}</span> {duplicateResolutionModal.fileName}
              </p>
            </div>

            {/* Action Buttons */}
            <div className="flex flex-col sm:flex-row gap-3 justify-end">
              <button
                onClick={() => handleDuplicateResolution('skip', setIsMultiCertProcessing)}
                className="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition duration-200 font-medium"
              >
                ‚è© {language === 'vi' ? 'Skip (B·ªè qua)' : 'Skip'}
                <div className="text-xs opacity-75 mt-1">
                  {language === 'vi' ? 'Kh√¥ng upload, kh√¥ng t·∫°o record' : 'Don\'t upload, don\'t create record'}
                </div>
              </button>
              <button
                onClick={() => handleDuplicateResolution('continue', setIsMultiCertProcessing)}
                className="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-200 font-medium"
              >
                ‚úÖ {language === 'vi' ? 'Continue (Ti·∫øp t·ª•c)' : 'Continue'}
                <div className="text-xs opacity-75 mt-1">
                  {language === 'vi' ? 'Ti·∫øp t·ª•c t·∫°o record' : 'Continue creating record'}
                </div>
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Ship Confirmation Modal */}
      {showShipConfirmModal && pendingShipData && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div 
            ref={shipConfirmDrag.modalRef}
            className="bg-white rounded-lg shadow-xl max-w-md w-full mx-4"
            style={{
              transform: `translate(${shipConfirmDrag.position.x}px, ${shipConfirmDrag.position.y}px)`,
              cursor: shipConfirmDrag.isDragging ? 'grabbing' : 'default',
              transition: shipConfirmDrag.isDragging ? 'none' : 'transform 0.2s ease-out'
            }}
          >
            <div 
              className="p-6"
              onMouseDown={shipConfirmDrag.handleMouseDown}
              style={{ cursor: 'grab' }}
            >
              <div className="flex items-center mb-4">
                <div className="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mr-4">
                  <svg className="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 15.5c-.77.833.192 2.5 1.732 2.5z" />
                  </svg>
                </div>
                <div>
                  <h3 className="text-lg font-medium text-gray-900">
                    {language === 'vi' ? 'T√†u ch∆∞a c√≥ trong danh s√°ch' : 'Ship not found in list'}
                  </h3>
                  <p className="text-sm text-gray-500">
                    {language === 'vi' ? 'T√†u n√†y ch∆∞a ƒë∆∞·ª£c th√™m v√†o h·ªá th·ªëng' : 'This ship is not yet added to the system'}
                  </p>
                </div>
              </div>
              
              <div className="mb-6">
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                  <p className="text-sm text-blue-800">
                    <span className="font-medium">{language === 'vi' ? 'T√™n t√†u t·ª´ gi·∫•y ch·ª©ng nh·∫≠n' : 'Ship name from certificate'}:</span>
                  </p>
                  <p className="text-lg font-bold text-blue-900 mt-1">
                    {pendingShipData.shipName}
                  </p>
                </div>
              </div>
              
              <div className="space-y-3">
                <button
                  onClick={() => handleShipConfirmation(true)}
                  className="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium"
                >
                  {language === 'vi' 
                    ? 'üö¢ T·ª± ƒë·ªông th√™m t√†u m·ªõi v√† ti·∫øp t·ª•c' 
                    : 'üö¢ Auto-add new ship and continue'}
                </button>
                
                <button
                  onClick={() => handleShipConfirmation(false)}
                  className="w-full bg-gray-100 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-200 transition-colors font-medium"
                >
                  {language === 'vi' 
                    ? '‚ùå H·ªßy b·ªè vi·ªác th√™m certificate' 
                    : '‚ùå Cancel certificate addition'}
                </button>
              </div>
              
              <div className="mt-4 text-center">
                <p className="text-xs text-gray-500">
                  {language === 'vi' 
                    ? 'Ch·ªçn "T·ª± ƒë·ªông th√™m t√†u m·ªõi" s·∫Ω chuy·ªÉn sang m·ª•c t·∫°o t√†u v·ªõi th√¥ng tin t·ª´ gi·∫•y ch·ª©ng nh·∫≠n'
                    : 'Selecting "Auto-add new ship" will switch to ship creation with certificate information'}
                </p>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* File Viewer Modal for Manual Review */}
      {showFileViewer && fileViewerData && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[95vh] flex flex-col">
            <div className="flex justify-between items-center px-6 py-4 border-b border-gray-200">
              <h3 className="text-xl font-bold text-blue-600 flex items-center">
                <svg className="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
                {language === 'vi' ? 'Xem x√©t file & Ph√¢n t√≠ch AI' : 'File Review & AI Analysis'}
              </h3>
              <button
                onClick={() => {
                  setShowFileViewer(false);
                  setFileViewerData(null);
                }}
                className="text-gray-400 hover:text-gray-600 text-2xl font-bold leading-none"
              >
                √ó
              </button>
            </div>
            
            <div className="p-6 flex-grow overflow-auto">
              <div className="mb-4">
                <h4 className="text-lg font-semibold text-gray-900 mb-2">{fileViewerData.filename}</h4>
                <div className="flex space-x-4 text-sm text-gray-600">
                  <span>
                    <strong>{language === 'vi' ? 'Ph√¢n lo·∫°i h·ªá th·ªëng:' : 'System Classification:'}</strong> 
                    <span className={`ml-1 px-2 py-1 rounded text-xs font-medium ${
                      fileViewerData.detected_category === 'certificates' 
                        ? 'bg-green-100 text-green-800'
                        : 'bg-orange-100 text-orange-800'
                    }`}>
                      {fileViewerData.detected_category}
                    </span>
                  </span>
                  <span>
                    <strong>{language === 'vi' ? 'ƒê·ªô tin c·∫≠y:' : 'Confidence:'}</strong> 
                    <span className="ml-1 capitalize text-orange-600">{fileViewerData.confidence}</span>
                  </span>
                </div>
              </div>
              
              {/* Two-column layout for file content and AI analysis */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                {/* Left Column: File Content */}
                <div className="space-y-4">
                  <h5 className="text-lg font-semibold text-gray-800 flex items-center">
                    <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    {language === 'vi' ? 'üìÑ N·ªôi dung file' : 'üìÑ File Content'}
                  </h5>
                  
                  {/* File Content Display */}
                  <div className="bg-gray-50 rounded-lg p-4 min-h-80 max-h-96 overflow-auto">
                {fileViewerData.content_type && fileViewerData.content_type.includes('pdf') ? (
                  <div className="space-y-4">
                    {/* PDF Viewer */}
                    <div className="bg-white rounded-lg border border-gray-300 min-h-80">
                      <div className="flex justify-between items-center p-3 bg-gray-100 rounded-t-lg border-b">
                        <h6 className="font-medium text-gray-800">PDF Preview</h6>
                        <button
                          onClick={() => {
                            // Download the file
                            const link = document.createElement('a');
                            link.href = `data:application/pdf;base64,${fileViewerData.content_b64}`;
                            link.download = fileViewerData.filename;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                          }}
                          className="text-sm px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors"
                        >
                          {language === 'vi' ? 'T·∫£i PDF' : 'Download PDF'}
                        </button>
                      </div>
                      <div className="p-2" style={{ height: '300px' }}>
                        <iframe
                          src={`data:application/pdf;base64,${fileViewerData.content_b64}`}
                          width="100%"
                          height="100%"
                          style={{ border: 'none', borderRadius: '4px' }}
                          title={fileViewerData.filename}
                        />
                      </div>
                    </div>
                  </div>
                ) : fileViewerData.content_type && fileViewerData.content_type.includes('image') ? (
                  <div className="space-y-4">
                    {/* Image Viewer */}
                    <div className="text-center bg-white rounded-lg border border-gray-300 p-4">
                      <img 
                        src={`data:${fileViewerData.content_type};base64,${fileViewerData.content_b64}`}
                        alt={fileViewerData.filename}
                        className="max-w-full max-h-80 mx-auto rounded-lg shadow-lg"
                        style={{ maxHeight: '320px', objectFit: 'contain' }}
                      />
                      <div className="mt-3 flex justify-center space-x-2">
                        <button
                          onClick={() => {
                            const link = document.createElement('a');
                            link.href = `data:${fileViewerData.content_type};base64,${fileViewerData.content_b64}`;
                            link.download = fileViewerData.filename;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                          }}
                          className="text-sm px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded transition-colors"
                        >
                          {language === 'vi' ? 'T·∫£i ·∫£nh' : 'Download Image'}
                        </button>
                        <button
                          onClick={() => {
                            const newWindow = window.open();
                            newWindow.document.write(`<img src="data:${fileViewerData.content_type};base64,${fileViewerData.content_b64}" style="max-width:100%; height:auto;" alt="${fileViewerData.filename}" />`);
                          }}
                          className="text-sm px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors"
                        >
                          {language === 'vi' ? 'M·ªü c·ª≠a s·ªï m·ªõi' : 'Open in New Window'}
                        </button>
                      </div>
                    </div>
                  </div>
                ) : (
                  <div className="text-center py-8 bg-white rounded-lg border border-gray-300">
                    <svg className="w-16 h-16 mx-auto text-gray-400 mb-4" fill="currentColor" viewBox="0 0 20 20">
                      <path fillRule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clipRule="evenodd" />
                    </svg>
                    <p className="text-gray-600">
                      {language === 'vi' 
                        ? 'Preview kh√¥ng kh·∫£ d·ª•ng cho lo·∫°i file n√†y'
                        : 'Preview not available for this file type'}
                    </p>
                  </div>
                )}
              </div>
                
                {/* Right Column: AI Analysis Summary */}
                <div className="space-y-4">
                  <h5 className="text-lg font-semibold text-gray-800 flex items-center">
                    <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    {language === 'vi' ? 'ü§ñ Ph√¢n t√≠ch AI' : 'ü§ñ AI Analysis'}
                  </h5>
                  
                  {/* AI Analysis Summary - Enhanced */}
                  <div className="bg-blue-50 rounded-lg border border-blue-200 p-4 max-h-96 overflow-auto">
                    {(() => {
                      const reviewData = pendingManualReviews.find(r => r.filename === fileViewerData.filename);
                      const analysis = fileViewerData.analysis || reviewData?.analysis || {};
                      
                      return (
                        <div className="space-y-4">
                          {/* Classification Summary */}
                          <div className="bg-white rounded-lg p-3 border border-blue-100">
                            <h6 className="text-sm font-semibold text-blue-700 mb-2 flex items-center">
                              <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                              </svg>
                              {language === 'vi' ? 'K·∫øt qu·∫£ ph√¢n lo·∫°i' : 'Classification Result'}
                            </h6>
                            <div className="grid grid-cols-1 gap-2">
                              <div className="flex items-center justify-between">
                                <span className="text-sm font-medium text-gray-600">
                                  {language === 'vi' ? 'Ph√¢n lo·∫°i:' : 'Category:'}
                                </span>
                                <span className={`px-3 py-1 rounded-full text-xs font-medium ${
                                  fileViewerData.detected_category === 'certificates' 
                                    ? 'bg-green-100 text-green-800'
                                    : 'bg-orange-100 text-orange-800'
                                }`}>
                                  {fileViewerData.detected_category || 'Unknown'}
                                </span>
                              </div>
                              <div className="flex items-center justify-between">
                                <span className="text-sm font-medium text-gray-600">
                                  {language === 'vi' ? 'ƒê·ªô tin c·∫≠y:' : 'Confidence:'}
                                </span>
                                <span className={`px-3 py-1 rounded-full text-xs font-medium ${
                                  fileViewerData.confidence === 'high' ? 'bg-green-100 text-green-800' :
                                  fileViewerData.confidence === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                                  'bg-red-100 text-red-800'
                                }`}>
                                  {fileViewerData.confidence || 'Unknown'}
                                </span>
                              </div>
                            </div>
                          </div>
                          
                          {/* Certificate Information */}
                          {analysis && Object.keys(analysis).length > 0 && (
                            <div className="bg-white rounded-lg p-3 border border-blue-100">
                              <h6 className="text-sm font-semibold text-blue-700 mb-3 flex items-center">
                                <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                {language === 'vi' ? 'Th√¥ng tin ƒë∆∞·ª£c tr√≠ch xu·∫•t' : 'Extracted Information'}
                              </h6>
                              
                              <div className="space-y-2">
                                {/* Certificate Details */}
                                {(analysis.cert_name || analysis.cert_no) && (
                                  <div className="bg-blue-50 rounded p-2 border-l-4 border-blue-400">
                                    <div className="text-xs font-medium text-blue-700 mb-1">Certificate Details</div>
                                    {analysis.cert_name && (
                                      <div className="flex justify-between items-start mb-1">
                                        <span className="text-xs text-blue-600 font-medium">Name:</span>
                                        <span className="text-xs text-blue-800 max-w-40 text-right">{analysis.cert_name}</span>
                                      </div>
                                    )}
                                    {analysis.cert_no && (
                                      <div className="flex justify-between items-center">
                                        <span className="text-xs text-blue-600 font-medium">Number:</span>
                                        <span className="text-xs text-blue-800">{analysis.cert_no}</span>
                                      </div>
                                    )}
                                  </div>
                                )}
                                
                                {/* Ship Information */}
                                {(analysis.ship_name || analysis.imo_number) && (
                                  <div className="bg-green-50 rounded p-2 border-l-4 border-green-400">
                                    <div className="text-xs font-medium text-green-700 mb-1">Ship Information</div>
                                    {analysis.ship_name && (
                                      <div className="flex justify-between items-center mb-1">
                                        <span className="text-xs text-green-600 font-medium">Ship Name:</span>
                                        <span className="text-xs text-green-800">{analysis.ship_name}</span>
                                      </div>
                                    )}
                                    {analysis.imo_number && (
                                      <div className="flex justify-between items-center">
                                        <span className="text-xs text-green-600 font-medium">IMO:</span>
                                        <span className="text-xs text-green-800">{analysis.imo_number}</span>
                                      </div>
                                    )}
                                  </div>
                                )}
                                
                                {/* Dates */}
                                {(analysis.issue_date || analysis.valid_date) && (
                                  <div className="bg-yellow-50 rounded p-2 border-l-4 border-yellow-400">
                                    <div className="text-xs font-medium text-yellow-700 mb-1">Important Dates</div>
                                    {analysis.issue_date && (
                                      <div className="flex justify-between items-center mb-1">
                                        <span className="text-xs text-yellow-600 font-medium">Issue Date:</span>
                                        <span className="text-xs text-yellow-800">{analysis.issue_date}</span>
                                      </div>
                                    )}
                                    {analysis.valid_date && (
                                      <div className="flex justify-between items-center">
                                        <span className="text-xs text-red-600 font-medium">Valid Until:</span>
                                        <span className="text-xs text-red-800 font-medium">{analysis.valid_date}</span>
                                      </div>
                                    )}
                                  </div>
                                )}
                                
                                {/* Authority */}
                                {analysis.issued_by && (
                                  <div className="bg-purple-50 rounded p-2 border-l-4 border-purple-400">
                                    <div className="text-xs font-medium text-purple-700 mb-1">Issuing Authority</div>
                                    <span className="text-xs text-purple-800">{analysis.issued_by}</span>
                                  </div>
                                )}
                                
                                {/* Survey Information */}
                                {(analysis.last_endorse || analysis.next_survey || analysis.next_survey_type) && (
                                  <div className="bg-orange-50 rounded p-2 border-l-4 border-orange-400">
                                    <div className="text-xs font-medium text-orange-700 mb-1">Survey Information</div>
                                    {analysis.last_endorse && (
                                      <div className="flex justify-between items-center mb-1">
                                        <span className="text-xs text-orange-600 font-medium">Last Endorse:</span>
                                        <span className="text-xs text-orange-800">{analysis.last_endorse}</span>
                                      </div>
                                    )}
                                    {analysis.next_survey && (
                                      <div className="flex justify-between items-center mb-1">
                                        <span className="text-xs text-orange-600 font-medium">Next Survey:</span>
                                        <span className="text-xs text-orange-800">{analysis.next_survey}</span>
                                      </div>
                                    )}
                                    {analysis.next_survey_type && (
                                      <div className="flex justify-between items-center">
                                        <span className="text-xs text-orange-600 font-medium">Survey Type:</span>
                                        <span className="text-xs text-orange-800 capitalize">{analysis.next_survey_type}</span>
                                      </div>
                                    )}
                                  </div>
                                )}
                                
                                {/* Additional Notes */}
                                {analysis.notes && (
                                  <div className="bg-gray-50 rounded p-2 border-l-4 border-gray-400">
                                    <div className="text-xs font-medium text-gray-700 mb-1">Additional Notes</div>
                                    <p className="text-xs text-gray-600">{analysis.notes}</p>
                                  </div>
                                )}
                              </div>
                            </div>
                          )}
                          
                          {/* Action Recommendation */}
                          <div className="bg-gray-50 rounded-lg p-3 border border-gray-200">
                            <h6 className="text-sm font-semibold text-gray-700 mb-2 flex items-center">
                              <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              {language === 'vi' ? 'ƒê·ªÅ xu·∫•t h√†nh ƒë·ªông' : 'Recommended Action'}
                            </h6>
                            {fileViewerData.detected_category === 'certificates' ? (
                              <div className="text-xs text-green-700 bg-green-100 p-2 rounded">
                                <div className="font-medium">‚úÖ {language === 'vi' ? 'X√°c nh·∫≠n Marine Certificate' : 'Confirm as Marine Certificate'}</div>
                                <div className="mt-1">{language === 'vi' ? 'H·ªá th·ªëng ƒë√£ ph√¢n lo·∫°i ƒë√∫ng.' : 'System classification appears correct.'}</div>
                              </div>
                            ) : (
                              <div className="text-xs text-orange-700 bg-orange-100 p-2 rounded">
                                <div className="font-medium">‚ö†Ô∏è {language === 'vi' ? 'C·∫ßn xem x√©t' : 'Review Required'}</div>
                                <div className="mt-1">
                                  {language === 'vi' 
                                    ? 'H·ªá th·ªëng kh√¥ng t·ª± ƒë·ªông nh·∫≠n di·ªán l√† Marine Certificate. Vui l√≤ng ki·ªÉm tra n·ªôi dung file v√† x√°c nh·∫≠n.'
                                    : 'System did not automatically classify as Marine Certificate. Please review file content and confirm.'}
                                </div>
                              </div>
                            )}
                          </div>
                        </div>
                      );
                    })()}
                  </div>
            </div>
            </div>
            
            {/* Close grid container */}
            </div>
              
            {/* Action Instructions */}
            <div className="mt-4 p-4 bg-green-50 rounded-lg border border-green-200">
                <h6 className="font-medium text-green-800 mb-2 flex items-center">
                  <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  {language === 'vi' ? 'H∆∞·ªõng d·∫´n quy·∫øt ƒë·ªãnh:' : 'Decision Guidelines:'}
                </h6>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  <div className="space-y-2">
                    <div className="flex items-start">
                      <span className="inline-block w-2 h-2 bg-red-500 rounded-full mt-2 mr-2 flex-shrink-0"></span>
                      <div>
                        <strong className="text-green-700">{language === 'vi' ? 'B·ªè qua n·∫øu:' : 'Skip if:'}</strong>
                        <ul className="text-green-600 ml-2 mt-1">
                          <li>‚Ä¢ {language === 'vi' ? 'Kh√¥ng ph·∫£i t√†i li·ªáu h√†ng h·∫£i' : 'Not a maritime document'}</li>
                          <li>‚Ä¢ {language === 'vi' ? 'B√°o c√°o test/b·∫£o tr√¨ thi·∫øt b·ªã' : 'Equipment test/maintenance report'}</li>
                          <li>‚Ä¢ {language === 'vi' ? 'T√†i li·ªáu th∆∞∆°ng m·∫°i/h√†nh ch√≠nh' : 'Commercial/administrative document'}</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                  <div className="space-y-2">
                    <div className="flex items-start">
                      <span className="inline-block w-2 h-2 bg-green-500 rounded-full mt-2 mr-2 flex-shrink-0"></span>
                      <div>
                        <strong className="text-green-700">{language === 'vi' ? 'X√°c nh·∫≠n Marine Cert n·∫øu:' : 'Confirm Marine Cert if:'}</strong>
                        <ul className="text-green-600 ml-2 mt-1">
                          <li>‚Ä¢ {language === 'vi' ? 'Ch·ª©ng ch·ªâ an to√†n/k·ªπ thu·∫≠t t√†u' : 'Ship safety/technical certificate'}</li>
                          <li>‚Ä¢ {language === 'vi' ? 'C√≥ t·ª´ kh√≥a: SOLAS, MARPOL, ISM, ISPS' : 'Contains: SOLAS, MARPOL, ISM, ISPS'}</li>
                          <li>‚Ä¢ {language === 'vi' ? 'C·∫•p b·ªüi C∆° quan H√†ng h·∫£i' : 'Issued by Maritime Authority'}</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            {/* Modal Action Buttons */}
            <div className="flex justify-end space-x-3 px-6 py-4 border-t border-gray-200">
              <button
                onClick={() => {
                  const reviewData = pendingManualReviews.find(r => r.filename === fileViewerData.filename);
                  if (reviewData) {
                    handleManualReviewAction('skip', reviewData);
                    setShowFileViewer(false);
                    setFileViewerData(null);
                  }
                }}
                className="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all"
              >
                {language === 'vi' ? 'B·ªè qua' : 'Skip'}
              </button>
              <button
                onClick={() => {
                  const reviewData = pendingManualReviews.find(r => r.filename === fileViewerData.filename);
                  if (reviewData) {
                    handleManualReviewAction('confirm_marine', reviewData);
                    setShowFileViewer(false);
                    setFileViewerData(null);
                  }
                }}
                className="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-all font-medium"
              >
                {language === 'vi' ? 'X√°c nh·∫≠n Marine Certificate' : 'Confirm Marine Certificate'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Removed from here - will be moved to HomePage level */}
    </div>
  );
};

// Additional components for Ships Page and Ship Detail Page would go here
const ShipsPage = () => <div>Ships Page - To be implemented</div>;
const ShipDetailPage = () => <div>Ship Detail Page - To be implemented</div>;

export default App;