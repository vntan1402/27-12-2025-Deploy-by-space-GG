<analysis>
The AI engineer's work primarily focused on enhancing the  module, specifically the  functionality. Initial efforts involved refactoring the  to handle single-file validation errors (ship mismatch) with a user-interactive modal (Continue/Cancel) instead of toasts. This required adding validation logic to the backend's  endpoint and implementing corresponding frontend UI. Subsequent iterations extended this modal-based error handling to duplicate certificate detection during single-file uploads. The engineer also addressed several critical user requests including adding editable Ship Name and IMO Number fields to the  and  modals with a 3-column layout, implementing background Google Drive file deletion upon certificate removal, and ensuring that user-edited certificate abbreviations are saved to the global mapping system. Most recently, a complex logic for calculating  and  was introduced for Audit Certificates in the backend, and its frontend trigger integrated.
</analysis>

<product_requirements>
The overarching goal is to migrate and enhance  functionalities into a new  module, focusing on . This involves a new  page with a 5-column ship card display and an 11-column data table. Key features include AI-powered PDF/JPG/PNG analysis (max 10MB) to auto-fill form fields, multi-file batch upload (max 10 files, 10MB each) with staggered processing and AI extraction, and Google Drive integration for file management. A context menu with various actions is required. For single-file uploads, AI analysis should only auto-fill for user review, requiring manual saving, while multi-file uploads auto-create records.

Recent updates explicitly requested:
1.  Replace toast notifications with a modal for single-file validation errors (e.g., Giấy chứng nhận của tàu khác, không thể lưu vào dữ liệu tàu hiện tại). The modal should offer Continue (add note: Giấy chứng nhận này của tàu khác, chỉ để tham khảo and proceed) or Cancel (stop).
2.  Implement the same modal-based user choice for **duplicate certificate detection** during single-file uploads.
3.  Display editable IMO and Ship Name fields in the , arranged in a 3-column layout, and store IMO in the DB. These fields should be filled by AI extraction, not pre-filled.
4.  Reconfigure  to mirror the new 3-column layout and fields of .
5.  Ensure  is updated in the global mapping list when editing an Audit Certificate.
6.  When deleting an Audit Certificate, perform Google Drive file deletion in the background, displaying a toast notification upon completion.
7.  Implement a complex  and  calculation logic for Audit Certificates based on certificate type (Interim, Short Term, Full Term, DMLC I/II/SSP) and specific date rules.
8.  The  calculation should be triggered when a user clicks an Update Next Survey button.
</product_requirements>

<key_technical_concepts>

-   **Frontend**: React.js (components, modals, state management, hooks), , , responsive design, form handling, file upload, context menus.
-   **Backend**: FastAPI (API endpoints, ), MongoDB (UUIDs), Google Apps Script (Google Drive integration), AI/LLM integration (Document AI for OCR and data extraction).
-   **Patterns**: V2 analysis-first, modular design, asynchronous operations, error handling, input validation, UI/UX consistency, background processing.
</key_technical_concepts>

<code_architecture>

-   ****: FastAPI application, central API.
    -   **Importance**: Handles all backend operations, AI integration, DB, and Google Drive.
    -   **Changes**: Added ship name validation, duplicate certificate detection, and ISM/ISPS/MLC category validation to  (single-file upload) and . Implemented  for approved single-file uploads, which creates DB records and uploads files without re-validating. Modified  and  to store  in the DB. Enhanced  to save user-defined abbreviations to the global mapping system. Updated  and  to perform background Google Drive file deletion using . Implemented  with complex logic for different certificate types and added  endpoint. Updated abbreviation mappings via API calls.
-   ****: Main page for ISM-ISPS-MLC module.
    -   **Importance**: Renders Audit Certificates, handles ship selection and integrates components.
    -   **Changes**: Implemented  to call the backend's  endpoint for a selected certificate. Added  state to manage UI feedback for the update process.
-   ****: Modal for adding audit certificates.
    -   **Importance**: Primary UI for certificate uploads, AI analysis, and manual data entry.
    -   **Changes**: Introduced state for , , , , , , . Added JSX for validation, duplicate, and category warning modals with Continue/Cancel options. Updated  to sequentially check for category, ship, and duplicate warnings, displaying the relevant modal. Modified  to use  (calling the new backend override endpoint) if  is true, bypassing standard multi-upload validation. Refactored the form layout to 3 columns and added editable  and  fields, correctly populating them with AI-extracted data.
-   ****: Modal for editing audit certificates.
    -   **Importance**: Provides UI for modifying existing certificate data.
    -   **Changes**: Refactored the entire form section to match the 3-column layout of , including new editable  and  fields.
-   ****: Action buttons for audit certificates.
    -   **Importance**: Provides various actions like add, delete, update.
    -   **Changes**: The Update Next Survey button (already present) is now wired up to a new handler in .
-   ****: Frontend service for Audit Certificate API calls.
    -   **Importance**: Abstracts API interactions for audit certificates.
    -   **Changes**: Confirmed to contain , , , , , , , , and  methods. A new function  was implicitly added/used to call the new backend  endpoint. A new function to trigger next survey recalculation was also added/used.
</code_architecture>

<pending_tasks>
-   Full testing of Sync from Drive functionality UI.
-   Bulk export/download for certificates via context menu.
-   Certificate File Viewer (embedded PDF viewer in modal, navigation, zoom, etc.).
-   Scalability improvements (load testing, Redis caching, query optimization, monitoring, sharding,  conversion, performance monitoring).
-   Implement toast notifications for Deleting files on Drive (start) and Successfully deleted X files (completion) for both  and .
-   Finish implementing the  component (for Crew Records).
-   Verify the background file deletion for crew records.
-   Implement Batch get Drive links with progress for .
</pending_tasks>

<current_work>
Immediately before this summary request, the AI engineer was implementing the  calculation logic for Audit Certificates. The user had provided detailed rules for calculating  and  based on the certificate type (Interim, Short Term, Full Term, DMLC I/II/SSP) and various date parameters.

The backend implementation is complete:
-   A new function  was created in  to encapsulate this complex calculation logic. This function was further refined based on user feedback (e.g., correcting Valid date - 30 months to Valid date - 2 years for Full Term certificates).
-   A new API endpoint  was created in  to trigger this specific calculation for a given certificate.

On the frontend:
-   The Update Next Survey button within  was identified as the trigger point.
-   The  function in  was implemented to make the API call to the new backend recalculation endpoint when this button is clicked.
-   A new state variable  was added to  to manage the loading/disabled state of the button during the update process.

The work is currently paused at the point of passing the  state down to the  component to visually indicate that the calculation is in progress.
</current_work>

<optional_next_step>
Pass  state to  component.
</optional_next_step>
