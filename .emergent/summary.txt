<analysis>
The previous AI engineer diligently addressed several critical issues and feature requests. Initially, debugging centered on the 's invisibility, resolved by correctly passing  and  props from . Subsequently, a persistent login failure for  was traced to a missing password hash in the database, necessitating a manual update and confirming backend login. The engineer then tackled deployment inconsistencies, such as outdated  content post-deploy, identifying and resolving frontend caching issues.

Significant effort was invested in understanding why  wasn't auto-created in production, leading to the discovery of MongoDB permission errors due to direct  calls instead of the  wrapper in . This was patched. A major architectural decision was made to decouple  from any specific company, allowing it to manage all entities. This required updates to  and , along with extensive permission updates across numerous backend API endpoints related to  (User Management, Google Drive, AI Configuration, Base Fee).

The final interactions involved clarifying MongoDB management in a managed environment (Emergent-provided) and addressing a lingering production 500 error for , which was ultimately diagnosed as a  having a non-existent company ID, reinforcing the need for direct database intervention via support. The last discussion focused on the immutability of database data during redeployments and the recommended path to correct the 's company field.
</analysis>

<product_requirements>
The application focuses on maritime document management with AI data extraction. Key requirements included enhancing AI extraction for specific fields, implementing a  role with comprehensive permissions across  (User Management, Company Management), and updating UI elements. Financial calculations were updated to use VND and revised formulas for monthly fees. Core stability fixes involved resolving production login issues and ensuring  auto-creation and full access. Company logo upload and display from Google Drive URLs were crucial. The  required content updates, dynamic data insertion, and a sidebar access button. A software expiry check feature was also implemented to restrict AI-related functionalities if expired.
</product_requirements>

<key_technical_concepts>
- **Frontend**: React.js (functional components, hooks, contexts, Portals), Axios, Tailwind CSS.
- **Backend**: FastAPI (API, Pydantic models, Dependency Injection), MongoDB (UUIDs, ).
- **Deployment**: Kubernetes ingress rules ( prefix for backend), Supervisorctl.
- **Patterns**: RESTful API, role-based access control, Google Drive API URL manipulation.
</key_technical_concepts>

<code_architecture>
The application utilizes a React.js frontend and a FastAPI/MongoDB backend.



- ****: Central API logic. Updated to include  routes, modified permission checks () for  across various endpoints (users, crew, companies, AI config, Google Drive integration, base fee, filtered users). Self-editing user profiles were enhanced.
- ****: Handles initial admin/company creation. Fixed critical bug by replacing direct  calls with  for proper permission handling. Modified to make  optional and prevent assigning a company to .
- ** (NEW)**: Provides new API endpoints for managing admin users in production without terminal access (, , ).
- ****: Added  and  variables.  was made optional.
- ****: Main content. Updated to use  for logo display.
- ****: Displays company details. Updated  for logo display.
- ****: Displays base fee. Updated to VND format.
- ****: Displays company details. Updated monthly fee calculation logic and currency to VND.
- ****: For company details. Updated logo preview with .
- ****: Manages company list. Updated Base Fee display to VND.
- ****: Displays company table. Updated Logo column with .
- ****: Edits user profiles. Removed self-restriction, allowed  to change company info for others.
- ****: Manages user list. Adjusted  checks for  privileges.
- ****: User guide. Content updated to reflect VND, new formulas, default Base Fee. Debugged rendering issues, specifically prop passing.
- ****: Navigation. Added User Guide button. Fixed  not rendering by passing  and  props.
- ****: Authentication context. Modified  logic to prevent  from fetching company expiry, addressing a production 500 error.
- ** (NEW)**: Utility functions for Google Drive URL conversion.
- ****: Centralized utility exports. Added export for .
</code_architecture>

<pending_tasks>
- Full testing of Sync from Drive functionality UI.
- Bulk export/download for certificates via context menu.
- Certificate File Viewer.
- Scalability improvements.
- Toast notifications for Deleting files on Drive for  and .
- Verify background file deletion for crew records.
- Comprehensive testing of the newly migrated  module (Phase 11).
- Address AI configuration for , resolve lookup discrepancies, and set up a default AI config.
- Resolve persistent Tesseract/Poppler installation issues to enable full OCR functionality.
- Confirm with the user if the Issued By abbreviation logic is now working as expected.
- Test the implemented backend background task for file movement in various scenarios (for Crew Records).
- Implement the gradual backend refactoring according to sidebar categories using the Strangler Fig Pattern.
- Simplify the Add New Ship process to create only a single folder per ship name in the company's root Google Drive.
- Update other frontend pages (besides ) to handle the .
- Add visual indicator for software expiry in the header/navbar.
- Resolve the persistent 500 error for company logo on  page (and potentially other pages).
</pending_tasks>

<current_work>
Immediately before this summary request, the AI engineer was addressing a user's concern about the  user in the production database having a  ID that did not exist, leading to a 500 Internal Server Error when trying to fetch company data after logging in. The user also inquired if redeploying would clear this old company association. The engineer explained that redeploying does not affect database data and that the 's  field would persist. The engineer recommended against redeploying to fix this specific issue and instead advised the user to contact Emergent Support to directly update the 's  field in the production database to an empty string. This would allow the  to manage all companies without encountering the 500 error.
</current_work>

<optional_next_step>
Draft an email/message for Emergent Support to update the 's company field.
</optional_next_step>
