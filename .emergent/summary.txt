<analysis>
The previous AI engineer demonstrated a systematic approach to developing and stabilizing the Ship Management System. Initial efforts focused on critical infrastructure: resolving OCR dependencies, correcting  for external access, and debugging core functionalities like login and document analysis. Key technical decisions included smart PDF classification and integrating Google Drive via Apps Script. Subsequently, the engineer enhanced the Certificate List UI, adding interactive elements like column controls and checkbox selection with a context menu. While a Move functionality was implemented, debugged across several iterations, and then removed per user request, significant work was also completed on dynamic Google Drive folder structures, Google Drive file deletion upon certificate removal, and ensuring UI refresh after operations. The latest activity involves diagnosing a Company Google Drive not configured error during new ship creation, despite Google Drive folders being correctly provisioned.
</analysis>

<product_requirements>
The Ship Management System - With AI Support manages maritime documents using React, FastAPI, and MongoDB. The system aims to enhance document processing, user experience, and stability.
1.  **System Stabilization**: Ensure Preview URL access and fix login/Pydantic validation.
2.  **AI Analysis Improvement**: Enhance Add New Ship and Multi Cert Upload by detecting PDF types (text/image) for optimized processing (direct text/OCR), fixing OCR fallbacks, and supporting JPG/PNG uploads.
3.  **Google Drive Integration**: Enable robust file viewing and management. A dynamic folder structure matching the Homepage sidebar should be created for new ships, with a fallback. Deleting a certificate must also delete its corresponding file on Google Drive.
4.  **Certificate List UI/UX**:
    *   Reorder columns: Status between Next Survey and Notes; Issued by between Next Survey and Status.
    *   Enable column resizing and sorting.
    *   Rename Inspection Records to Hồ sơ Đăng kiểm and Survey Reports to Báo cáo kiểm tra in Vietnamese.
    *   Certificates without Valid Date display Valid.
    *   Add checkbox selection with a right-click context menu (Open, Copy Link, Edit, Delete).
    *   Implement delete confirmation.
    *   Certificate list should auto-refresh after delete/move operations.
5.  **Codebase Cleanup**: Remove unused files. (Note: Move functionality was later removed per user request, including associated code cleanup).
</product_requirements>

<key_technical_concepts>
-   **FastAPI**: Backend REST API.
-   **React**: Frontend UI.
-   **MongoDB**: Data persistence.
-   **OCR (Tesseract, Google Vision API)**: Document text extraction.
-   **LLM Integration (Gemini)**: AI analysis.
-   **Google Drive API (via Apps Script)**: Document storage/management.
-   **Tailwind CSS**: Styling.
-   **Supervisor**: Process management.
-   **Pydantic**: Data validation.
-   **Poppler-utils, Tesseract-ocr**: System OCR dependencies.
</key_technical_concepts>

<code_architecture>
The application uses a full-stack architecture: React frontend, FastAPI backend, MongoDB database.



-   ****:
    -   **Importance**: Core backend logic.
    -   **Changes**:
        -   Refined user creation/validation for , .
        -   Implemented  and enhanced  for smart PDF/image processing.
        -   Fixed  and Google Drive file viewing.
        -   **Added **: Endpoint to list Google Drive folder structure (part of Move functionality, later removed).
        -   **Added  (DELETE)**: Endpoint for Google Drive file deletion.
        -   **Updated  (DELETE)**: Now calls  to delete the Google Drive file.
        -   **Added **: Endpoint to expose the current frontend sidebar structure to Google Apps Script for dynamic folder creation.
        -   **Modified **: Now passes  to Google Apps Script for dynamic structure fetching.
        -   **Added  (GET)**: Endpoint to fetch a single certificate's details, needed for MoveModal.
        -   **Removed  (POST)**: Entire endpoint and associated logic removed as part of Move functionality cleanup.
        -   **Updated  content**: Synchronized the structure it returns to match the frontend's Vietnamese categories.
-   ****:
    -   **Importance**: Centralizes OCR functionalities.
    -   **Changes**:
        -   Modified  to use  for better reliability.
        -   Added  to enable Google Vision API OCR.
-   ****:
    -   **Importance**: Main React component managing application state, rendering UI, handling user interactions, and making API calls.
    -   **Changes**:
        -   Updated  attributes for file inputs (JPG/PNG).
        -   Implemented UI logic for Certificate List: column reordering, sorting, resizing, checkbox selection, and context menu.
        -   Added  state and handlers.
        -   **Implemented  integration**: Added JSX and state variables (, ). *This functionality was later removed.*
        -   **Fixed  calls**: Ensured  is passed for both single and multi-certificate delete/move operations to trigger correct UI refresh.
        -   **Fixed  functions**: Added  header to API calls to correctly populate the ships dropdown.
        -   **Modified **: Updated logic to filter certificates based on  (category).
        -   **Removed all Move-related UI/state**: Removed  option from context menu,  function,  state, and Move Modal JSX.
-   ****:
    -   **Importance**: Custom CSS for UI components.
    -   **Changes**: Added styles for column resizing and tree-view structure in  (part of Move functionality, now defunct).
-   ****:
    -   **Importance**: Handled displaying folder structure and initiating certificate moves.
    -   **Changes**:
        -   **Created**: Implemented to show Google Drive folders (initially flat, then as a tree structure). Handled API calls for fetching folders and moving files. Used  for toasts.
        -   **Fixed errors**: Addressed Error loading folders by correctly deriving , and Error moving certificates by using correct backend endpoint and  callback.
        -   **Deleted**: The entire file was removed per user request.
-   ****:
    -   **Importance**: Utility script.
    -   **Changes**: Updated to include  and  fields and logic to delete existing users before creation.
-   ****:
    -   **Importance**: Python dependencies.
    -   **Changes**: Added , , , .
-   ****:
    -   **Importance**: Google Apps Script for Google Drive integration.
    -   **Changes**: This is the latest version. It includes , , , , , , and  actions. It was updated to dynamically fetch folder structure from the backend's  endpoint and has an updated fallback structure matching the frontend's Vietnamese categories. It also includes improved error handling for file/folder operations.
</code_architecture>

<pending_tasks>
-   **Debug Company Google Drive not configured error**: Investigate why  functionality reports this error, despite creating the folder structure correctly on Google Drive. The backend is reporting a 404, suggesting a configuration or lookup issue during the Apps Script interaction.
</pending_tasks>

<current_work>
Immediately before this summary request, the AI engineer was debugging an issue with the Add new record created successfully but failed to create Google Drive folder structure: Failed to create ship folder: 404: Company Google Drive not configured.

The following has been confirmed:
*   **Frontend Sidebar Structure**: The frontend's  defines the correct, updated sidebar categories (e.g., in Vietnamese).
*   **Backend **: This endpoint has been updated in  to correctly reflect the frontend's sidebar structure (with Vietnamese names) and responds successfully.
*   **Google Apps Script**: The  is updated to dynamically fetch the folder structure from the backend using the  provided by the backend. It also has a synchronized fallback structure.
*   **Google Drive Creation**: The actual folder structure is being created correctly on Google Drive.

The problem specifically lies in the backend's  during the  call to Google Apps Script. Despite folders being created, the backend encounters a 404: Company Google Drive not configured error, which implies a failure in accessing or validating the Google Drive configuration () or the associated Apps Script URL. The engineer has started investigating the backend ship creation logic.
</current_work>

<optional_next_step>
Investigate the backend's ship creation logic to debug why it fails to validate the Google Drive configuration despite successful folder creation.
</optional_next_step>
