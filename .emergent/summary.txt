<analysis>
The AI engineer's work revolved around the Add Crew From Passport feature, initially focusing on date standardization and fixing Google Drive upload issues. A key challenge was the Dual Apps Script architecture to handle cross-account Drive access, which itself required significant debugging for configuration loading, asynchronous calls, and permission issues. A critical Apps Script bug was identified where folders existed but couldn't be found during file upload. Concurrently, AI extraction for passport fields faced persistent accuracy problems, leading to prompt engineering, manual regex fallbacks, and ultimately, a direct regex extraction as the primary method to bypass AI interpretation issues. The latest work focuses on re-enabling System AI as the primary extraction method with a highly structured prompt, but an  in parsing the LlmChat response is currently blocking progress.
</analysis>

<product_requirements>
The Ship Management System needs to manage maritime certificates and crew records. The Add Crew From Passport feature is critical, allowing users to upload passports, use Google Document AI for summarization, save original and summary files to specific Google Drive folders (e.g.,  and ), and extract structured crew data using an application-configured AI (Gemini). Document AI configuration (Project ID, Location, Processor ID, Apps Script URL) must be in System Settings. Initial implementation faced challenges: date format standardization (DD/MM/YYYY), accurate AI field extraction, and robust Google Drive file management across different Google accounts. The user has specifically requested consistent date formatting, precise AI extraction (especially for Vietnamese names and places), and a refined folder structure for uploaded files, with System AI being the primary extraction method.
</product_requirements>

<key_technical_concepts>
-   **Full-stack Architecture:** React frontend, FastAPI backend, MongoDB.
-   **AI Integration:** Google Document AI (for text summarization), Google Gemini (via  for field extraction).
-   **Google Apps Script:** Secure intermediary for Google Drive operations.
-   **Dual Apps Script Architecture:** Separate Apps Scripts for Document AI processing (System) and file uploads (Company).
-   **Data Handling:** Base64, JSON, regex, ISO date standardization, UUIDs (instead of MongoDB ObjectIDs).
</key_technical_concepts>

<code_architecture>


-   ****
    -   **Summary:** Core FastAPI application, defines API endpoints and business logic.
    -   **Changes:**
        -   Refined  and extraction prompts.
        -    was implemented.
        -    uses .
        -   Fixed  for .
        -   Added  for regex-based extraction.
        -   Introduced an endpoint  for debugging Apps Script.
        -   Fixed  function's date conversion logic to handle  and  and store as UTC ISO strings.
        -   Removed old logic to reject AI results if EACH STARTING WITH was found.
        -   Implemented  to use  instead of mock data.
        -   Added  to map new structured AI output to existing backend fields.
        -   Modified  to incorporate the new structured prompt and conversion.
-   ****
    -   **Summary:** Manages Google Drive and Apps Script interactions.
    -   **Changes:** No direct changes in the trajectory, but its functionality for file upload was superseded by the dual apps script approach.
-   ** (New File)**
    -   **Summary:** Placeholder, functionality integrated into .
    -   **Changes:** No direct changes, its role was absorbed.
-   ** (New File)**
    -   **Summary:** Orchestrates calls to two separate Google Apps Scripts.
    -   **Changes:**
        -   Fixed  issue and configuration loading (from  to , later ).
        -   Updated  to fetch  correctly from MongoDB.
        -   Modified  to send  and use the  action.
        -   Adjusted parameters for passport and summary file uploads (, , ) to control folder structure:
            -   Passport:  (actual ship), , 
            -   Summary: , ,  (initially , then changed)
-   ****
    -   **Summary:** Main React UI, handles state and API calls.
    -   **Changes:** Implemented UI for Add Crew Modal and Document AI configuration. Auto-fill logic for extracted crew data. Removed Crew List, Crew Certificates, Medical Records from CREW RECORD section. The date input format  was implicitly mentioned.
-   ** (Initial User Provided Code - Chat Message 5)**
    -   **Summary:** Google Apps Script for handling various Drive operations, including .
    -   **Changes:** This was the base script that needed modifications.
-   ** (New File)**
    -   **Summary:** Initial AI-generated Apps Script to support passport workflow, handling dynamic folder paths.
    -   **Changes:** Introduced  to receive , , ,  from backend. This was later deprecated in favor of re-using .
-   ** (New File)**
    -   **Summary:** Refined Company Apps Script to retrieve  from backend, supporting dynamic folder creation for passports/summaries using .
    -   **Changes:** Updated to make  optional in  for direct folder uploads. Contains robust folder creation (, ).
-   ** (New File)**
    -   **Summary:** Manifest to declare  and  OAuth scopes.
    -   **Changes:** Created to guide user on proper permission configuration.
-   ** (New File)**
    -   **Summary:** Apps Script with enhanced debugging, error handling, and file verification.
    -   **Changes:** Added , detailed logging, and better error messages.
-   ** (New File)**
    -   **Summary:** Apps Script with robust folder lookup functions to fix Category folder not found bug.
    -   **Changes:** Introduced , , , and .

</code_architecture>

<pending_tasks>
-   Fix  when parsing the  response in the backend. This is preventing the System AI's structured prompt from being correctly processed.
-   Ensure the new structured prompt for System AI is fully utilized and extracts all required fields accurately.
</pending_tasks>

<current_work>
Immediately prior to this summary, the AI engineer was implementing the user's request to revert the primary field extraction method back to **System AI**, using a newly provided, highly structured prompt. This new prompt defines all required passport fields in a JSON format and provides a clear example output.

The  file was updated:
1.  The  function was modified to use the user's detailed structured prompt.
2.  A  function was implemented to map the fields from the new structured AI output (e.g., , ) to the existing backend's internal field names (e.g., , ).
3.  The logic was adjusted to ensure the System AI call (using  and Gemini) is the primary extraction method.
4.  An old logic that rejected AI responses containing EACH STARTING WITH was removed as it's no longer relevant with the new structured output format.
5.  Indentation errors were fixed in .

During testing, it was confirmed that the System AI is indeed being called with the new prompt and communicating with the Gemini API. However, a critical  was encountered when the backend attempted to process the response object returned by , indicating a parsing issue with the AI's output in the backend.
</current_work>

<optional_next_step>
Investigate and fix the  when parsing the  response in .
</optional_next_step>
