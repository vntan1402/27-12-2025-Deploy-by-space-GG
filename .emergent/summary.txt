<analysis>**original_problem_statement:**
The user's initial goal was to fix a broken user signature upload feature. This expanded into a series of bug fixes and UI/UX improvements. The core problem addressed in this session was a critical production-specific timeout error during Survey Report and Certificate uploads. The agent diagnosed that these timeouts were caused by long-running synchronous calls to external AI services (Google Document AI), which worked on the preview environment but failed on production due to stricter proxy timeouts.

**PRODUCT REQUIREMENTS from this session:**
- **(In Progress)** Implement a Smart Upload feature to solve the timeout issue. This involves:
    - A FAST PATH for PDFs with good quality text layers, processing them immediately without calling the slow Document AI.
    - A SLOW PATH for scanned PDFs or images, which processes them asynchronously in the background to avoid UI timeouts.
- **(In Progress)** Apply the Smart Upload logic to both Certificate and Survey Report uploads.
- **(In Progress)** For large Survey Reports (>15 pages) without a text layer, process only the first 10 and last 10 pages in the background.
- **(In Progress)** For PDF files with low-quality text layers, use a secondary AI (Gemini) to correct spelling and formatting errors before further processing.
- **(Completed)** Fix numerous bugs encountered during implementation, including  attribute errors, Pydantic validation errors, and a non-dismissing toast notification.
- **(Completed)** Add a fallback mechanism to extract the Certificate Number from the filename if AI fails to find it.
- **(Completed)** Add targeted OCR for headers/footers of scanned images to improve data extraction.

**User's preferred language**: Vietnamese

**what currently exists?**
The Smart Upload feature is partially implemented. The backend logic is mostly complete for both Certificates and Survey Reports.
- **FAST PATH:** The system detects if a PDF has a text layer. If so, it uses a new AI Text Correction feature (powered by Gemini) to clean up the text, then extracts data and completes the process synchronously in a few seconds.
- **SLOW PATH:** For scanned PDFs/images, the system creates a background task.
    - **Certificates:** The task runs the full Document AI analysis in the background. The frontend has been updated to poll for the task's status.
    - **Survey Reports (>15 pages):** The backend splits the PDF into the first 10 and last 10 pages and processes them. However, the frontend has not been updated yet to handle this background flow.
- The agent just updated the prompt for the AI Text Correction feature to improve its accuracy, but this change has not been tested.

**Last working item**:
-   **Last item agent was working:** The agent was improving the prompt used by the Gemini AI for the Text Layer Correction feature. The user reported that the initial version of the AI correction still left many spelling and formatting errors in the final summary. The agent updated the prompt in  to be more robust.
-   **Status:** IN PROGRESS
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** Manual testing. The user needs to re-upload the problematic file (), and the agent must check the backend logs and the generated summary file to verify the correction quality.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1: AI Text Correction is not robust enough (P0)**
    -   **Description:** The FAST PATH uses Gemini AI to correct poor-quality text layers. The initial implementation improved the text but still left many obvious errors (e.g., , ).
    -   **Attempted fixes:** The agent has just updated the prompt in  to be more explicit and provide more examples of corrections. This change needs to be tested.
    -   **Next debug checklist:**
        1. Restart the backend to apply the new prompt.
        2. Ask the user to re-upload the problematic file ().
        3. Check the backend logs for  messages.
        4. Examine the generated  file to verify if the text is now correctly fixed.
        5. If still not perfect, consider further prompt engineering.
    -   **Why fix this issue and what will be achieved with the fix?** The accuracy of the entire FAST PATH depends on high-quality text. Fixing this will improve data extraction and user trust.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Backend
    -   **Blocked on other issue:** None

-   **Issue 2: Result modal shows failure while toast shows success for SLOW PATH (P1)**
    -   **Description:** The user reported a UI bug where, for a file processed via the SLOW PATH (background task), the final results modal incorrectly shows a failure, while the toast notification correctly reports success.
    -   **Attempted fixes:** The agent fixed a backend crash ( setter error) that was causing the background task to fail, which may have been the root cause. This needs verification.
    -   **Next debug checklist:**
        1.  Ask the user to upload a scanned PDF/image file that will trigger the SLOW PATH.
        2.  Observe the UI behavior when the background task completes.
        3.  If the bug persists, debug the state management in  related to handling the polling response for completed tasks.
    -   **Why fix this issue and what will be achieved with the fix?** Provides a clear and accurate user experience for background uploads.
    -   **Status:** USER VERIFICATION PENDING
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Frontend
    -   **Blocked on other issue:** None

**In progress Task List**:
-   **Task 1: Complete the Smart Upload Feature (P0)**
    -   **Description:** The full feature, including frontend and backend for both Certificates and Survey Reports, needs to be completed and stabilized.
    -   **Where to resume:** First, test the fix for Issue #1 (AI Text Correction). Then, implement the frontend UI for the Survey Report's smart upload, which is currently missing the background polling and progress tracking.
    -   **What will be achieved with this?** A robust, fast, and non-blocking file upload experience for all major document types, definitively solving the original production timeout problem.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** Both
    -   **Blocked on something:** Waiting for user to test the latest AI correction improvement.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   (P1) Implement full frontend UI/UX for **Survey Report Smart Upload**, including background task polling and progress tracking.
    -   (P2) Run backend testing agent for a full regression test once the Smart Upload feature is fully stable.
    -   (P2) Implement SMS Procedures Page (Phase 2).
    -   (P2) Implement Record Template Page (Phase 3).
    -   (P2) Implement Ship Record Page (Phase 4).
-   **Future Tasks:**
    -   (P3) Plan and Implement CV Mail Merge Feature.
    -   (P3) Implement an Export/Import data feature in System Settings.

**Completed work in this session**
-   **Feature - Smart Upload Backend (DONE):**
    -   Implemented the core backend logic for the FAST PATH (text layer) and SLOW PATH (background processing) for both Certificates and Survey Reports.
    -   Created a background task management system using MongoDB (, ).
    -   Added new smart API endpoints ( for certificates).
    -   Refactored Survey Report analysis for large files to split them into the first 10 and last 10 pages.
-   **Feature - AI Text Layer Correction (DONE - V2):**
    -   Created a new utility () that uses Gemini AI to automatically fix spelling and formatting errors in low-quality text layers, making the FAST PATH more reliable.
-   **Feature - Smart Upload Frontend for Certificates (DONE):**
    -   Refactored  to call the new smart upload endpoint and handle both synchronous (FAST PATH) and asynchronous (SLOW PATH) responses, including polling for background task status.
-   **Bug Fixes (DONE):**
    -   Fixed a persistent toast notification bug in  by adding .
    -   Resolved multiple crashes in the background task logic related to  object recreation ( attribute error,  setter error).
    -   Fixed a Pydantic validation error by fetching the actual user from the DB instead of using an incomplete mock user in the background task.
    -   Installed Tesseract OCR and added logic for targeted OCR on scanned images to find .
    -   Added a fallback to extract  from the filename if AI analysis fails.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Frontend Login Form Validation Bug (Recurring):** A known recurring issue from previous sessions that has not been addressed.

**Known issue recurrence from previous fork**
-   **AI Incorrectly Extracts Certificate Name:** Recurrence count: 3+, Status: IN PROGRESS (being addressed by the new AI Text Correction feature).
-   **Frontend Login Form Validation Bug:** Recurrence count: 3+, Status: NOT STARTED

**Code Architecture**


**Key Technical Concepts**
-   **Hybrid Synchronous/Asynchronous Processing (Smart Upload):** The core architectural change. The system intelligently chooses between a fast, synchronous path for high-quality data and a robust, asynchronous background path for low-quality data, optimizing for both speed and reliability.
-   **AI-based Text Correction:** A novel approach using a text-generation LLM (Gemini) as a pre-processing step to clean up poor-quality OCR data from native PDF text layers. This is a creative, fast, and cost-effective alternative to using a full-blown OCR service on every file.
-   **Background Task Management:** Using FastAPI's  in combination with a dedicated MongoDB collection () to manage the state of long-running jobs, allowing the frontend to poll for status without blocking the UI.
-   **Strategic File Splitting:** For large, scanned survey reports, instead of processing all 60+ pages, the system now intelligently processes only the first 10 and last 10 pages, which are most likely to contain the key summary information, drastically reducing processing time and cost.

**key DB schema**
-   **upload_tasks** (NEW): A new MongoDB collection to track the status of asynchronous file uploads.
    -   : UUID
    -   : pending | processing | completed | failed
    -   : A list of file objects, each with its own status, progress, and result.
    -   , , , 

**changes in tech stack**
-   **tesseract-ocr**: Added as a system dependency for performing targeted OCR on image files.

**All files of reference**
-   **/app/backend/app/utils/text_layer_correction.py**: Contains the prompt and logic for the new AI Text Correction feature. This is the last file that was modified.
-   **/app/backend/app/services/ship_certificate_analyze_service.py**: Contains the core FAST PATH / SLOW PATH logic for certificates.
-   **/app/backend/app/services/survey_report_analyze_service.py**: Contains the core FAST PATH / SLOW PATH logic for survey reports, including the large file splitting logic.
-   **/app/frontend/src/components/ShipCertificates/AddShipCertificateModal.jsx**: Contains the full frontend implementation for the smart upload UI, including polling logic.
-   **/app/backend/app/services/upload_task_service.py**: The service that interacts with the new  MongoDB collection.

**Areas that need refactoring**:
-   The Survey Report upload flow on the frontend () needs to be refactored to use the new Smart Upload paradigm, similar to how  was updated. Currently, it uses an older, synchronous approach.

**key api endpoints**
-   : The new primary endpoint for certificate uploads. It immediately returns either the full result (FAST PATH) or a  (SLOW PATH).
-   : The new endpoint for polling the status of a background upload task.
-   : The existing endpoint for survey reports, which has been updated internally to use the new smart logic.

**Critical Info for New Agent**
-   **You must respond in Vietnamese.**
-   Your immediate task is to test the latest improvement to the **AI Text Correction** feature. The prompt was just updated. You need to restart the backend and ask the user to upload the file that previously failed () to verify the fix.
-   The next major pending task is on the **frontend**. The Survey Report upload page needs to be updated to use the full Smart Upload flow, including the UI for handling background tasks, just like the Certificate upload page.
-   The main architectural change, Smart Upload, is designed to solve production timeouts by distinguishing between files that can be processed quickly (FAST PATH) and those that need slow background processing (SLOW PATH).

**documents and test_reports created in this job**
-   None.

**Last 10 User Messages and any pending HUMAN messages**
-   user: tôi vừa thử upload lại, hãy check log
-   user: có thể dùng System AI để chỉnh sửa Text layer trước khi lưu vào Summary không
-   user: Text layer được trích xuất sai chính tả, không rõ nghĩa rất nhiều, có cách nào để chỉnh sửa thành nội dung có nghĩa giống cách Document AI xử lý không? dưới đây là ví dụ của Text layer
-   user: Tôi muốn sửa lại Quy trình xử lý file >15 trang (Survey Report) như sau: Xác định có text layer không , nếu có thì trích xuất text layer, tạo summary và trích xuất thông tin luôn, không cần spilt file. Nếu không có thì tiến hành split file/ lấy 10 trang đầu và 10 trang cuối. chỉ tiến hành gửi Document AI 2 chunk này để phân tích và tạo Summary ( chạy background giống Certificate) . Tiến hành OCR cho header và footer của trang đầu tiên chunk 1 để trích xuất Report Form ( gộp vào summary ). Hãy lập Plan để chỉnh sửa logic này
-   user: Class Survey Report đã có Smart Upload chưa, đối với file có nhiều trên 15 trang thì quy trìn xử lý thế nào
-   user: Toast ✅ Hoàn thành! Đã cập nhật Next Survey cho 2/2 chứng chỉ của tàu TRUONG MINH SEA không ẩn đi, cứ hiển thị liên tục
-   user: Targeted OCR chưa có trong Summary , hãy test bằng file tôi gửi
-   user: SLOW PATH chưa có OCR phần header và footer để trích xuất Cert No
-   user: Không dùng mock user, hãy dùng user admin1/123456
-   user: Result modal báo thất bại nhưng toast lại báo thành công khi upload file ảnh

**Project Health Check:**
-   **Broken:** The Survey Report upload feature on the frontend does not yet support the new asynchronous Smart Upload flow, which could lead to timeouts on production for large scanned files. The AI text correction quality is still under review.

**3rd Party Integrations**
-   **Google Drive API:** Used for all file and folder storage.
-   **Google Document AI:** Used for OCR and document analysis in the SLOW PATH.
-   **Emergent LLM Key (Gemini):** Now used for two purposes:
    1.  **AI Text Correction:** A new feature to clean up low-quality text layers in the FAST PATH.
    2.  **Field Extraction:** The original use case of extracting structured data from the summary text.
-   **Tesseract-OCR:** Newly added system dependency used for targeted OCR on image headers/footers to find specific fields like .

**Testing status**
-   **Testing agent used after significant changes:** NO
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None.
-   **Known regressions:** The Survey Report upload UI is now out of sync with the new backend capabilities and needs to be updated.

**Credentials to test flow:**
-   **system_admin** /  (Full access)
-   **crewing_manager** /  (Role: , department: )

**What agent forgot to execute**
-   The agent identified that the frontend for Survey Reports needs updating to support the new smart upload flow but has not started the implementation yet.
-   The agent has not yet fixed the long-standing Frontend Login Form Validation Bug.</analysis>
