<analysis>**original_problem_statement:**
The user's initial goal was to fix bugs and refine the business logic of a Ship Management System application. The focus has been on ensuring the calculation and display of certificate statuses, next survey dates, and AI-based data extraction from certificate documents align with complex, evolving user specifications.

PRODUCT REQUIREMENTS from this session:
1.  Verify and correct the logic for calculating Certificate Status to match the official documentation. (COMPLETED)
2.  Fix a bug causing an  error when adding new certificates. (COMPLETED)
3.  Fix sorting functionality for the Status, Next Survey, and Next Survey Type columns. (COMPLETED)
4.  Update the AI prompt to correctly extract the *latest* Last Endorse date when multiple endorsement dates are present in a document. (COMPLETED)
5.  Update the AI prompt to handle certificates (like DG, IMSBC) where the annual survey section is on the last page. (COMPLETED)
6.  Implement a dynamic, robust logic (instead of a hardcoded list) to determine if a certificate requires annual surveys, based on whether an Annual Survey Endorsement section exists in the document summary. (COMPLETED)
7.  Add a  flag to the database, controlled by the AI and a manual user checkbox, to drive the calculation logic. (COMPLETED)
8.  Add a UI checkbox (Endorsement Required) in the Edit Ship Certificate Modal for users to manually set the  flag. (COMPLETED)
9.  Correct the Next Survey calculation for renewal-only certificates (like ISPP) to show the expiry date with a  notation and ensure recalculation works. (COMPLETED)
10. Correct the Anniversary Date calculation to be based on the most common valid date from a list of key statutory certificates. (COMPLETED)
11. Fix a bug where manually edited Anniversary Date was not being saved. (COMPLETED)
12. Fix the Next Survey calculation for certificates with no  date, ensuring it correctly shows the 1st annual survey as due. (COMPLETED)
13. Fix the classification of Audit Certificates, correctly identifying Full Term certificates even when Interim keywords are present. (COMPLETED)
14. Increase the width of the Ship Certificate Processing Results Modal for better readability. (COMPLETED)

**User's preferred language**:
The user's primary language is **Vietnamese**. The next agent MUST respond in Vietnamese only.

**what currently exists?**
A full-stack Ship Management System application. The core logic for certificate analysis, status calculation, and next survey date calculation has been extensively refined and debugged throughout this session. A new system is in place using a  flag (set by AI during upload and manually editable via a new UI checkbox) to determine whether to calculate a 5-year annual survey cycle or treat the certificate as renewal-only. The logic for determining the ship's Anniversary Date has also been updated to a more robust method. All user-reported bugs from this session have been addressed.

**Last working item**:
-   **Last item agent was working:** The agent provided a detailed explanation of how the Next Audit date is calculated for Audit Certificates (DOC, ISM, ISPS, MLC) based on the logic in . This was in response to a user question. No code was being modified.
-   **Status:** NONE
-   **Agent Testing Done:** N/A
-   **Which testing method agent to use?** N/A (The last action was an explanation).
-   **User Testing Done:** N/A

**All Pending/In progress Issue list**:
There are no pending issues at the moment. All issues reported by the user in this session have been addressed and marked as completed by the user.

**In progress Task List**:
There are no tasks in progress.

**Upcoming and Future Tasks**
*   **Upcoming Tasks:**
    *   **(P0) Await user feedback on Next Audit calculation:** The user has just received an explanation of the Next Audit calculation logic. They are likely to review it and may request changes or report discrepancies, continuing the pattern of methodical logic verification seen throughout this session.

**Completed work in this session**
-   **Certificate Status Logic:** Aligned frontend  logic with documentation () across four files, ensuring Over Due and Due Soon statuses are displayed correctly for different certificate types.
-   **Backend  Bug:** Fixed a critical bug where  could return , causing crashes during certificate analysis. Corrected the pattern to  in five backend service/API files.
-   **Column Sorting:** Fixed sorting for Status, Next Survey, and Next Survey Type columns in certificate tables by implementing custom comparison logic that correctly handles calculated values and date formats with annotations (e.g., ).
-   **AI Prompt Enhancements:**
    -   **Latest Last Endorse:** Updated prompts in , , and  to instruct the AI to find all endorsement dates and return only the most recent one.
    -   ** Logic:** Implemented a robust, rule-based system for the AI to determine if a certificate requires annual surveys by looking for specific structured sections (e.g., Annual surveys, Periodical surveys with numbered entries, Signed, Place, Date) rather than a hardcoded list.
-   ** Feature:**
    -   **Database & AI:** Added a  boolean field to the certificate model. The AI now extracts and sets this flag during upload.
    -   **Calculation Logic:** Refactored  in  to use the  flag as the primary driver for its logic.
    -   **UI:** Added an Endorsement Required checkbox to the  to allow users to manually override this flag.
-   ** Calculation:**
    -   **Logic:** Reworked the  function in  to use the most frequently occurring valid date (day/month) from a specific list of statutory certificates (Class, SC, SE, etc.).
    -   **Save Bug:** Fixed a bug where manually editing the Anniversary Day/Month in the Ship Details modal was not being saved to the database.
-   **Next Survey Calculation Bugs:**
    -   **No Last Endorse:** Corrected  to ensure that if a certificate has no  date, the Next Survey correctly defaults to the 1st Annual Survey if its window is still open.
    -   **ISPP Renewal:** Fixed the logic to correctly calculate ISPP certificate's next survey as Renewal with a  notation and fixed the recalculation endpoint which was incorrectly skipping it.
-   **Audit Certificate Classification:** Improved the post-processing logic in  to correctly classify certificates as Full Term even when Interim keywords are also present, by prioritizing Full Term indicators.
-   **UI Improvement:** Increased the width of the  and adjusted column widths for better readability.

**Earlier issues found/mentioned but not fixed**
None.

**Known issue recurrence from previous fork**
None. The API key not valid issue from the previous fork was resolved prior to this session's start.

**Code Architecture**


**Key Technical Concepts**
-   **Frontend:** React, TailwindCSS, .
-   **Backend:** FastAPI, MongoDB (), Pydantic.
-   **Core Logic:** Complex, rule-based business logic for ship certificate management, heavily reliant on date calculations and conditional logic based on certificate types and content.
-   **AI Integration:** Google Gemini prompts for data extraction, with significant effort spent on refining instructions for accuracy and handling edge cases.

**key DB schema**
-   **certificates:** 
-   **ships:** 

**changes in tech stack**
None.

**All files of reference**
-   **Primary Logic Files (Heavily Modified):**
    -   : The core engine for calculating Next Survey. Contains all the rules for different certificate types.
    -   : The main AI prompt for standard ship certificates. Contains detailed rules for data extraction.
    -   : Contains AI prompt and post-processing logic for Audit certificates.
    -   : Contains frontend state and sorting logic for one of the main certificate tables.
    -   : Contains frontend state and sorting logic for the other main certificate table.
-   **Other Key Modified Files:**
    -   : UI for the new  checkbox.
    -   : Pydantic model updated with the  field.
    -   : API endpoint for recalculating next surveys.

**Critical Info for New Agent**
-   **The user is the expert:** The user has deep domain knowledge and is methodically testing every piece of business logic. Trust their reports and ask for clarification on rules.
-   ** is the new core concept:** The logic for  is now primarily driven by the  flag on the certificate document in the database.
    -   If , it calculates the 5-year annual survey cycle.
    -   If , it sets  to the  with  notation and  to Renewal.
-   **Legacy Certificates:** Certificates uploaded *before* this feature was added will have . The calculation logic has a fallback that uses a hardcoded list of renewal-only certificate keywords for these cases. To get the most accurate calculation, older certificates should be re-uploaded.
-   **AI Prompts are critical:** Significant work has gone into making the AI prompts in  very specific. When debugging AI extraction issues, always start by reviewing the detailed rules in the relevant  file.

**documents and test reports created in this job**
-   /app/test_result.md (Created to test backend status logic)

**Last 10 User Messages and any pending HUMAN messages**
10. **User:** Asks to treat all insurance certificates as renewal-only. (Completed)
9.  **User:** Points out a fundamental flaw: recalculating surveys doesn't re-read the file summary, leading to potential errors. Agrees to the agent's proposal to add a  flag to the DB. (Completed)
8.  **User:** Asks for the AI prompt to be more robust in identifying annual survey sections by looking for a specific structure (numbered entries, signed, place, date). (Completed)
7.  **User:** Requests a checkbox (Endorsement Required) in the Edit Certificate modal to manually control the  flag. (Completed)
6.  **User:** Asks to treat PERIODICAL SURVEY as equivalent to Annual surveys for AI detection. (Completed)
5.  **User:** Requests a change to the Anniversary Date calculation logic. (Completed)
4.  **User:** Reports a bug where manually editing the Anniversary Date doesn't save. (Completed)
3.  **User:** Reports a bug where  is calculated incorrectly when  is missing. (Completed)
2.  **User:** Reports a bug where Audit Certificates are misclassified as Interim instead of Full Term. (Completed)
1.  **User:** Asks for an explanation of how Next Audit is calculated. (Completed)

**Project Health Check:**
-   **Broken:** None reported. All identified issues have been resolved.
-   **Mocked:** None.

**3rd Party Integrations**
-   **Google Gemini:** Used for AI-based data extraction from certificate PDF summaries. The prompts have been heavily customized. Requires a User-provided key.
-   **MongoDB Atlas:** Cloud-hosted database for the production environment.

**Testing status**
-   **Testing agent used after significant changes:** YES, once early in the session for backend logic verification.
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** []
-   **Known regressions:** None.

**Credentials to test flow:**
-   **Local User:**  / 

**What agent forgot to execute**
The agent has been thorough and addressed every request made by the user in this session.</analysis>
