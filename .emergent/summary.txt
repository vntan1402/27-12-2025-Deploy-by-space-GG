<analysis>**original_problem_statement:**
The user's initial goal was to fix a broken user signature upload feature. This expanded into a series of bug fixes and UI/UX improvements. In the previous session, the focus was on a production-specific timeout error during Survey Report analysis. In this session, the user continued to report critical performance issues and timeouts in the production environment, this time related to both large Survey Reports and multi-file Certificate uploads. The user also reported several new bugs, including missing data in the UI and backend errors. The agent's work involved deep-diving into the performance discrepancies between the preview and production environments, implementing new diagnostic tools, and fixing several critical bugs discovered along the way.

**PRODUCT REQUIREMENTS from this session:**
- **(In Progress)** Investigate and resolve production-specific timeout errors for Survey Report and Certificate uploads.
- **(In Progress)** Implement a Bandwidth Test tool in the Admin Tools section to help diagnose network performance.
- **(Completed)** Fix a bug where the  was not being saved to the database for newly uploaded certificates, causing the UI to display No file name available.
- **(Completed)** Fix a critical backend error () that prevented background file cleanup tasks from running.
- **(Completed)** Fix multiple other backend errors found during debugging, including incorrect MongoDB queries ( vs ) and  errors on duplicate checks.
- **(Completed)** Increase the frontend timeout for certificate multi-uploads to 180 seconds to provide a larger buffer.
- **(Completed)** Add detailed timing logs (including Time to First Byte - TTFB) to the Document AI helper to precisely measure each step of the external API call.

**User's preferred language**: Vietnamese

**what currently exists?**
The application has several new bug fixes and a new Bandwidth Test diagnostic tool in the admin panel. The root cause of the production performance issues has been narrowed down. Initial theories about network bandwidth have been disproven by the new tool. The bottleneck was identified first in the PDF splitting process for large files (which took 62s on Production vs. 3s on Preview) and then, more importantly, in the inconsistent processing time of the first file in a batch by the external Google Document AI service (sometimes taking >150s, other times ~10s). Several critical backend bugs related to database queries and background tasks have been fixed. The agent has just added even more detailed timing logs to the backend, which have been deployed, to get a final, precise breakdown of where the time is spent during the slow requests.

**Last working item**:
-   **Last item agent was working:** The agent was analyzing the newest production logs for a multi-file certificate upload. These logs were generated after deploying code that added detailed timing breakdowns (Base64 encoding, payload building, TTFB, and response read time) to the  service. The user re-uploaded the exact same file that previously took 155s to process. The goal was to use the new detailed logs to pinpoint the exact step causing the massive, inconsistent delay.
-   **Status:** USER VERIFICATION PENDING
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** Manual testing by user. The user needs to provide the latest production logs from the re-upload of the problematic file. The agent is waiting for these logs to analyze.
-   **User Testing Done:** Y (User has performed the upload on production and has the logs).

**All Pending/In progress Issue list**:
-   **Issue 1: Inconsistent Production Timeout on File Uploads (P0)**
    -   **Description:** File uploads (both Survey Reports and Certificates) are experiencing extreme and inconsistent processing times on the production environment. A file that takes 155s to process one time might take only 8s the next. This causes frontend timeouts (120s/180s), but the backend often finishes successfully, leading to a confusing user experience where an error is shown but the file is actually created.
    -   **Attempted fixes:**
        -   Increased frontend timeouts to 180s-300s.
        -   Built Connectivity and Bandwidth testing tools, which confirmed good network bandwidth (~6 Mbps).
        -   Identified and logged a PDF splitting bottleneck for large reports (62s).
        -   Identified the first file is slow pattern (155s vs. ~13s for subsequent files), suggesting a cold start issue.
        -   Added a warmup ping before processing.
        -   Added detailed TTFB timing logs to  to isolate the slow step.
        -   Fixed several critical backend bugs ( call,  vs ,  errors).
    -   **Next debug checklist:**
        1.  Analyze the latest production logs from the user, which contain the new detailed  breakdown for the file that previously took 155s.
        2.  Identify which specific step is responsible for the long delay: Base64 encoding (CPU), Time To First Byte (network/external processing), or Response Read time.
        3.  If TTFB is the confirmed bottleneck, confirm the Background Processing solution with the user. This involves responding to the frontend immediately and handling the long-running AI analysis and GDrive uploads in a background task. This is the most robust solution to prevent UI timeouts regardless of processing time.
        4.  If the user agrees, implement the background processing logic for the multi-certificate upload flow.
    -   **Why fix this issue and what will be achieved with the fix?** This is a critical production issue blocking a core user workflow. Fixing it will make the file upload feature reliable and provide a good user experience by decoupling the UI from long-running backend processes.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Both.
    -   **Blocked on other issue:** None.
-   **Issue 2: AI Incorrectly Extracts Certificate Name (P3)**
    -   **Description:** A recurring issue where the AI analysis fails to extract the full name from certificate documents.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
-   **Issue 3: Frontend Login Form Validation Bug (P3)**
    -   **Description:** A known, recurring client-side validation error on the login form.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y

**In progress Task List**:
-   None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   (P1) Implement Background Processing for certificate and survey report uploads to provide a robust, long-term solution to the timeout issue.
    -   (P2) Run backend testing agent for a full regression test once the production performance issue is fully resolved.
    -   (P2) Implement SMS Procedures Page (Phase 2).
    -   (P2) Implement Record Template Page (Phase 3).
    -   (P2) Implement Ship Record Page (Phase 4).
-   **Future Tasks:**
    -   (P3) Plan and Implement CV Mail Merge Feature.
    -   (P3) Implement an Export/Import data feature in System Settings.

**Completed work in this session**
-   **New Feature - Bandwidth Test Tool (DONE):**
    -   Created a new backend endpoint .
    -   Created a new frontend component  in Admin Tools to test upload/download speeds to the external Google Apps Script service.
-   **Performance & Timeout Fixes (DONE):**
    -   Increased frontend timeout for certificate multi-uploads to 180s (, ).
    -   Added detailed timing logs (Base64 encoding, TTFB, response read) to  for granular performance analysis.
    -   Added a warmup ping to  to mitigate potential cold start issues.
-   **Critical Bug Fixes (DONE):**
    -   **Missing Filename:** Fixed a bug where the certificate  was not being saved to the database by passing it correctly through the analysis pipeline ().
    -   **Background Task Crash:** Fixed a  in  by correctly instantiating  before calling the  method.
    -   **Database Query Error:** Replaced incorrect  calls with the correct wrapper method  in .
    -   ** Error:** Added safe access () in  to prevent crashes when checking for duplicates if a field is missing.
    -   **Linting Errors:** Added missing  import in .

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: AI Incorrectly Extracts Certificate Name (Recurring):** A known recurring issue from previous sessions that has not been tackled yet.
-   **Issue 2: Frontend Login Form Validation Bug (Recurring):** Another known recurring issue from previous sessions that has not been addressed.

**Known issue recurrence from previous fork**
-   **AI Incorrectly Extracts Certificate Name:** Recurrence count: 3+, Status: NOT STARTED
-   **Frontend Login Form Validation Bug:** Recurrence count: 3+, Status: NOT STARTED

**Code Architecture**


**Key Technical Concepts**
-   **Inconsistent Production Performance:** The core problem is that identical operations have vastly different execution times on the production environment (8s vs 155s), pointing towards environmental factors (like cold starts or resource contention) rather than deterministic code logic.
-   **Time to First Byte (TTFB) Analysis:** The agent instrumented the code with detailed timing logs to measure TTFB for external API calls. This is a crucial debugging technique to distinguish between local processing (like Base64 encoding), network latency, and external service processing time.
-   **Synchronous vs. Asynchronous UX:** The current synchronous request-response model causes the frontend to time out while waiting for the backend. The agent correctly identified that even if the performance issue is resolved, a background processing model is a more robust architectural choice for long-running tasks to improve user experience.

**key DB schema**
-   **certificates**: Modified to ensure  field is correctly populated upon creation. No schema change, but data integrity was fixed.

**changes in tech stack**
-   None.

**All files of reference**
-   **/app/backend/app/utils/document_ai_helper.py**: The most recently modified file, containing the new detailed timing logs. The next agent must analyze logs generated from this code.
-   **/app/backend/app/services/certificate_multi_upload_service.py**: Contains the main loop for processing certificate uploads. This is where a background processing refactor would likely take place.
-   **/app/backend/app/utils/background_tasks.py**: Was fixed to correct a critical bug in how  was being called.
-   **/app/frontend/src/components/SystemSettings/AdminTools/BandwidthTest.jsx**: The new frontend component for the bandwidth test tool.
-   **/app/frontend/src/components/ShipCertificates/AddShipCertificateModal.jsx**: The frontend modal where the upload process is initiated and where timeouts were adjusted.

**Areas that need refactoring**:
-   The certificate and survey report upload flows should be refactored from a synchronous request-response model to an asynchronous, background job model. This will definitively solve the user-facing timeout issue and make the system more resilient to performance fluctuations of external services.

**key api endpoints**
-   : The primary endpoint under investigation for performance issues.
-   : A new diagnostic endpoint to test network throughput to Google Apps Script.

**Critical Info for New Agent**
-   **You must respond in Vietnamese.**
-   Your immediate task is to ask the user for the **latest production logs** for the file upload that previously took 155s. The code with detailed TTFB timing has been deployed, and these new logs are essential for the final diagnosis.
-   The core problem is **INCONSISTENT** performance on production, not consistently slow performance. A file that takes 155s one time can take 8s another. Bandwidth has been ruled out as the primary bottleneck.
-   The user has reported that even when the frontend times out, the files are often successfully created in the backend. This is a key piece of evidence. It confirms the backend process is completing, just too slowly for a synchronous request.
-   Based on all the evidence, the most robust long-term solution is to **refactor the upload process into a background job**. After analyzing the new timing logs, you should propose this solution to the user as the definitive fix for the timeout problem.

**documents and test_reports created in this job**
-   None.

**Last 10 User Messages and any pending HUMAN messages**
-   user: log chỉ share 100 log, có cách nào share nhiều hơn không
-   user: kiểm tra lại timing của từng file, so sánh với timing của Preview tôi vừa upload các file đó
-   user: Use deployment agent to identify the issues. Sharing build error logs...
-   user: chạy trên preview upload nhiều file cùng lúc với cùng app script không bị chậm. Tôi vừa upload 5 file đó trên Preview, hãy xem log để so sánh
-   user: Use deployment agent to identify the issues. Sharing build error logs...
-   user: có thể cho tôi biết file đầu tiên mất 155.07s gồm các bước xử lý nào, lâu nhất ở bước nào không
-   user: Use deployment agent to identify the issues. Sharing build error logs...
-   user: Preview và Production dùng chung Apps Script URL / Document AI config Bandwidth test trên Preview cho kết quả khoảng 6 Mbps Tôi vửa upload 5 file trên Preview, hãy xem log mới nhất để biết kết quả chi tiết
-   user: vấn đề là khi chạy preview thì không gặp vấn đề gì với cold start
-   user: Use deployment agent to identify the issues. Sharing build error logs...

**Project Health Check:**
-   **Broken:** The file upload feature on production is unreliable due to inconsistent, long processing times causing frontend timeouts. This is a critical issue impacting a core workflow.

**3rd Party Integrations**
-   **Google Drive API:** Used for all file and folder storage, accessed via a custom Google Apps Script. Its performance consistency from the production environment is under investigation.
-   **Emergent LLM Key (Gemini):** Uses  for AI document analysis.
-   **Pillow / opencv-python-headless:** Used on the backend for image processing and OCR.

**Testing status**
-   **Testing agent used after significant changes:** NO. The agent performed targeted manual testing of new features and bug fixes.
-   **Troubleshoot agent used after agent stuck in loop:** NO.
-   **Test files created:** None.
-   **Known regressions:** None.

**Credentials to test flow:**
-   **system_admin** /  (Full access)
-   **crewing_manager** /  (Role: , department: )
-   **Crew3** /  (Role: )

**What agent forgot to execute**
-   The agent correctly identified that background processing is the best solution but has not yet implemented it, pending final log analysis and user confirmation.
-   The two long-standing recurring issues (AI Incorrectly Extracts Certificate Name and Frontend Login Form Validation Bug) have not been addressed.</analysis>
