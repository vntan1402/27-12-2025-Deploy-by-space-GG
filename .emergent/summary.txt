<analysis>
The trajectory documents an intensive, iterative development process for a Ship Management System, primarily focused on UI/UX refinement, bug fixing, and enhancing a core AI data extraction feature. The work began with UI consistency tasks, such as synchronizing text in dropdown menus and ensuring data in the main table matched the edit forms. A significant feature was added to auto-refresh data in modals and lists after user actions like Quick Edit or Recalculate, which involved deep debugging of asynchronous state updates and API response handling.

The most substantial effort was dedicated to improving the AI's ability to extract data from uploaded certificate PDFs. The user reported that the AI failed to populate most fields when adding a new ship from a certificate. The debugging process was complex, starting from verifying the backend extraction logic, which was initially correct, to identifying the root cause in the backend's  function. This function was failing to map most of the extracted ship details. The AI prompt and the normalization logic were iteratively refined to successfully extract and map all required fields, including complex date formats for Keel Laid and Last Docking.

The final phase of work tackled persistent and subtle bugs related to data binding in the Edit Ship form and timezone-related date shifts. The Edit Ship form was not displaying detailed data because it was relying on an incomplete data object; this was fixed by fetching the full object details upon opening the modal. A recurring one-day date shift was traced to inconsistent date handling, which was addressed by creating and applying a universal UTC conversion function across the application. The last task involved debugging why this date shift was still occurring in some scenarios, identifying that the auto-refresh logic was not yet using the new universal UTC function.
</analysis>

<product_requirements>
The application is an AI-powered Ship Management System for maritime certificates.

**Core Requirements Implemented:**
1.  **AI Certificate Processing**: The system uses Google Gemini to extract data from PDF certificates to auto-populate forms for adding new ships. The AI logic has been significantly enhanced to extract a wide range of fields, including ship name, IMO, flag, class society, gross tonnage, and specific dates like Keel Laid, Delivery Date, and Last Docking.
2.  **UI/UX Consistency**:
    *   All UI text, including dropdown options (Survey Type) and labels (Next Survey Type), must be consistent and support Vietnamese translations as specified.
    *   The Edit Ship form must correctly display all existing data for a selected ship, including detailed information and correctly formatted dates.
3.  **Interactive UI**:
    *   A Quick Edit context menu allows users to change the Survey Type directly from the main certificate list.
    *   The certificate list must auto-refresh after a successful Quick Edit to reflect the latest data from the server.
    *   The Detailed Ship Information form must auto-refresh its fields immediately after a user triggers a Recalculate action (e.g., for Next Docking Date).
4.  **Data Integrity**: All date fields entered manually or extracted by AI must be handled consistently to avoid timezone-related date shifts. Data must be stored and retrieved reliably from the database.
</product_requirements>

<key_technical_concepts>
- **Full-stack Monoliths**: A monolithic React frontend () and a monolithic FastAPI backend ().
- **AI Integration**: Google Gemini is used for data extraction from PDFs. The backend contains complex logic for building dynamic prompts, calling the AI, and normalizing the JSON response.
- **React State Management**: Extensive use of  and  for managing complex UI state, including modals, context menus, and form data.
- **Asynchronous Operations**: Heavy use of  for API calls, with debugging focused on race conditions and state updates post-fetch.
- **Date & Timezone Handling**: Critical focus on resolving date shift bugs by consistently converting all date inputs to UTC () before sending them to the backend.
</key_technical_concepts>

<code_architecture>
The application follows a monorepo structure with a backend and frontend directory.



-   ****
    -   **Summary**: This single file contains the entire FastAPI backend, managing all API endpoints, database interactions with MongoDB (via Motor), Pydantic models, and the core business logic, including the AI data extraction prompts for Google Gemini.
    -   **Summary of Changes**:
        -   The AI extraction logic was heavily modified. The  function was updated to include more fields (, , ), which dynamically builds a more comprehensive AI prompt.
        -   The  function was significantly expanded to correctly parse and map the full, flat JSON response from the AI, resolving the critical bug where only a few fields were being auto-filled.
        -   The  endpoint's corresponding handler function ( in the frontend) was implicitly fixed by ensuring the frontend payload now includes all detailed ship information fields, which the backend was already capable of processing.

-   ****
    -   **Summary**: This monolithic React file contains the entire frontend application. It manages all application state, renders all UI components (tables, modals, forms), and handles API communication.
    -   **Summary of Changes**:
        -   **Text & Translation**: Numerous text labels and dropdown options were updated for consistency and to meet user's Vietnamese translation requests (e.g., Next Survey Type).
        -   **Auto-Refresh Logic**: The  function was modified to call  on success. Similarly, recalculation functions (, etc.) were updated to fetch the latest ship data and update the  state, refreshing the edit form in place.
        -   **Data Binding Fix**: The  handler for the Edit Ship button () was created to fetch the full ship details via a new API call () before opening the modal. This fixed the bug where the form appeared empty because it was previously using an incomplete  object.
        -   **Date & Timezone Fix**: A universal date conversion function, , was created and applied to all date fields in both the Add Ship and Edit Ship submission payloads to prevent timezone-related date shifts. A scope issue with this function was also fixed by defining it within the Add Ship modal component.
        -   **AI Auto-fill Formatting**: The  function was modified to preserve the full date (DD/MM/YYYY) if extracted by the AI, instead of always converting it to MM/YYYY.

</code_architecture>

<pending_tasks>
- The user canceled the request to modify the Next Survey calculation logic by comparing it against the Valid Date. No other major feature requests are pending. The primary pending work is a bug fix.
</pending_tasks>

<current_work>
The most recent task was to investigate and fix a recurring date shift issue. The user reported that dates were off by one day, indicating a timezone problem.

The previous engineer correctly identified that different parts of the application were handling date conversions inconsistently. A robust solution was partially implemented by creating a universal function, , to standardize dates to UTC format before sending them to the backend. This fix was successfully applied to the Add Ship and Edit Ship form submission logic.

However, the work was paused right after discovering that this fix was not yet applied everywhere. Specifically, the auto-refresh logic within the recalculation functions (e.g., ) was still using a simple , which is susceptible to local timezone variations and was the likely cause of the recurring date shift bug. The immediate task is to refactor these remaining functions to use the new, consistent UTC conversion method.
</current_work>

<optional_next_step>
I will now fix the remaining timezone inconsistency by updating the auto-refresh logic in the recalculation functions to use the standardized  and  helper functions, ensuring all date handling is timezone-safe.
</optional_next_step>
