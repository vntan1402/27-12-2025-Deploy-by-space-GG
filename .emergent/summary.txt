<analysis>
The trajectory details the AI engineer's work on the  application, focusing on two main feature developments: System Google Drive configuration and the Add New Ship flow. Initial work involved debugging persistent Not authenticated errors with the Google Apps Script proxy. After extensive troubleshooting, including multiple Apps Script deployments (with and without API keys), comparing frontend V1 and V2, and backend permission checks, the root cause was identified as  directly using  instead of the authenticated  instance. This was fixed, successfully connecting the Apps Script. Subsequently, the user requested UI adjustments to the HomePage (removing sub-menu, adding company logo) which were completed. The current task involves implementing the Add New Ship feature, including modifying sidebar text, building a new modal with specific form layouts, and integrating AI-powered certificate analysis for ship data. The engineer is currently restructuring the  file to accommodate extensive form fields and logic.
</analysis>

<product_requirements>
The primary goal was to migrate  to a modular  with core features like authentication, layout, ship certificate display, user, and company management. New features include:
- **AI Config Module**: Integration into System Settings, displaying current provider/model, and configuration modal.
- **System Google Drive Configuration**: Initially for connecting via Apps Script, later expanded to include Sync to Drive (DB backup), Sync from Drive (DB restore), and daily auto-backup. This feature involved securing the Apps Script proxy with API keys (later made optional/dynamic) and ensuring robust connectivity.
- **UI Enhancements**: Removing the sub-menu bar from the HomePage and adding a dynamic company logo banner.
- **Add New Ship Flow**: Changing sidebar button text, implementing a full form for adding new ships with specific layout requirements (e.g., Company dropdown showing only current user's company), redirecting to Ship Detail page on success, and initiating a background task for Google Drive folder structure creation, including Add ship from Certificate with AI analysis.
</product_requirements>

<key_technical_concepts>
- **Frontend**: React.js, Context API (Auth), React Router, custom hooks,  (with custom  instance for authentication).
- **Backend**: FastAPI, MongoDB (using UUIDs, ISO strings for DateTime), Pydantic, JWT authentication, APScheduler for scheduled tasks.
- **Integrations**: Google Drive API (via Apps Script proxy), API Key authentication.
- **Deployment**: Google Apps Script Web App deployments, Kubernetes ingress rules.
</key_technical_concepts>

<code_architecture>

-   **backend/server.py**: FastAPI app.
    -   *Changes*: Added  endpoint (modified  to  for test connection), and  (for company-specific Drive). Implemented .
-   **frontend/src/pages/HomePage.jsx**: Main user dashboard.
    -   *Changes*: Removed  component, added  fetching and rendering logic with a new banner UI. Integrated .
-   **frontend/src/components/Layout/CategoryMenu.jsx**: Sidebar menu component.
    -   *Changes*: Updated ADD_NEW_RECORD button text to ADD_NEW_SHIP.
-   **frontend/src/components/SystemSettings/SystemGoogleDrive/SystemGoogleDriveModal.jsx**: Modal for GDrive configuration.
    -   *Changes*: Replaced direct  calls with  methods to ensure JWT authentication headers are sent, resolving Not authenticated errors.
-   **frontend/src/components/Ships/AddShipModal.jsx**: (New file, currently being modified) Form for adding new ships.
    -   *Changes*: Initial creation and subsequent layout adjustments based on user feedback, including reorganizing Basic Information and Technical Details fields, and placeholder for Add ship from Certificate with AI Analysis.
-   **GOOGLE_APPS_SCRIPT_V3_SECURE.js**: (New file) Secure Apps Script proxy.
    -   *Summary*: Dynamic  from request, masked sensitive logging, and enhanced  to search by subfolder name.
</code_architecture>

<pending_tasks>
- The Sync from Drive (restore database) functionality UI integration and full testing in the frontend are still pending.
- The Add New Ship modal () requires further layout adjustments and the implementation of the Add ship from Certificate with AI Analysis feature.
</pending_tasks>

<current_work>
Immediately before this summary request, the AI engineer was implementing the Add New Ship feature. This involved:
1.  **Sidebar Button Text Update**: Changed Add new record to Add New Ship in .
2.  **AddShipModal Component**: Created  and integrated it into .
3.  **Layout Refinements**: Applied several layout changes to  based on user feedback. This included fixing a Failed to load company info error, ensuring the Company field displays the company name, renaming Ship Type / Class Society to Class Society, moving Ship Owner to the same row as Company, and arranging Survey Dates fields into a 4-field row.
4.  **Implementing AI Certificate Analysis**: Began the process of adding Add ship from Certificate with AI Analysis to , reviewing V1 frontend code and backend APIs ().
The engineer is currently in the process of restructuring and updating  to accommodate the complex form layout and the AI certificate analysis feature. The file content is becoming extensive.
</current_work>

<optional_next_step>
Complete the implementation of the Add ship from Certificate with AI Analysis feature and the remaining layout adjustments in .
</optional_next_step>
