<analysis>
The AI engineer's work in this trajectory covers several critical enhancements and bug fixes for the Ship Management System. Initially, the focus was on refining UI layouts and addressing specific frontend display issues. This progressed to implementing robust backend logic for certificate duplicate detection and an automated Upcoming Surveys notification system, which involved complex date handling and state management across both frontend and backend. The work was highly iterative, with constant user feedback guiding adjustments to UI elements, date calculation logic, and sequential modal displays. Key challenges included debugging React state synchronization, ensuring consistent date formatting, and fine-tuning business logic for various certificate types. The final identified task is fixing a critical bug in the Edit Certificate modal where the save button fails to trigger an update.
</analysis>

<product_requirements>
The AI-powered Ship Management System streamlines maritime certificate management using Google Gemini for PDF parsing, auto-populating ship and certificate forms, ensuring UTC date consistency, and providing a responsive UI with optimistic updates. Users can perform full CRUD operations on ships and certificates.

Recent and ongoing enhancements:
*   Refactoring the Add New Record modal into a tabbed interface (Ship, Document Portfolio, etc.) with improved field layouts and checkbox selections.
*   Implementing Auto Rename File for Google Drive integration.
*   Fixing a Built Year field bug.
*   Implementing an Over Due status for certificates.
*   Enhancing certificate duplicate detection with date normalization.
*   Developing an Upcoming Surveys notification system after login, displaying certificates nearing their survey window (defined by  date ±/(-) 3 months, or  to  for Condition Certificates, or  to  for Initial SMC/ISSC/MLC).
*   User feedback on UI adjustments (layout, font sizes), sequential duplicate handling, and accurate display of certificate details drives continuous refinement. The current focus is on a critical bug where editing certificates in the full modal does not save changes.
</product_requirements>

<key_technical_concepts>
-   **Full-stack Monorepo:** React frontend, FastAPI backend, MongoDB.
-   **AI Integration (Google Gemini):** PDF data extraction, dynamic prompt engineering.
-   **Asynchronous UI Updates:** Optimistic updates, React state management.
-   **System-Wide UTC Date Handling:** Essential for consistency.
-   **Google Apps Script Integration:** File operations (renaming).
-   **Sequential UI Flow:** Managing multi-step user interactions.
</key_technical_concepts>

<code_architecture>


-   ****
    -   **Summary:** FastAPI application for API endpoints, MongoDB, Pydantic models, and AI logic.
    -   **Summary of Changes:**
        -   **Duplicate Detection:** Modified  to normalize date formats before comparison, resolving .
        -   **Upcoming Surveys API:** Added  endpoint to fetch certificates within a survey window. This involved:
            -   Initial implementation to check certificates within ±90 days of current date.
            -   Updated logic to calculate survey window (, ) based on each certificate's  type (+/- 3 months for most, -3 months for Special Survey,  to  for Condition Certificate,  to  for Initial SMC/ISSC/MLC).
            -   Refined status classification (, , ) and included  in response.
            -   Bug fix for  certificates by allowing Initial SMC/ISSC/MLC certificates to proceed even without a  date.
            -   Bug fix to correctly identify certificate types (SMC, ISSC, MLC) using their full names instead of abbreviations.
        -   **Next Survey Calculation:** Detailed explanation of  logic, including IMO 5-year cycle, anniversary date priority, and specific rules for different certificate types. Special cases for Radio/GMDSS and MLC certificates for  were removed.
        -   **Certificate Update Endpoint:**  logic was confirmed to be working correctly from the backend perspective.

-   ****
    -   **Summary:** Manages Google Drive interactions via Apps Script.
    -   **Summary of Changes:** No direct changes in this trajectory, but was referenced for file auto-renaming feature previously.

-   ****
    -   **Summary:** Monolithic React file for the entire frontend.
    -   **Summary of Changes:**
        -   **Detailed Ship Information Layout:** Reorganized fields into a compact 2-row layout within the Ship tab of the Add New Record modal. Field spans and styling (text size, color, padding, border-radius) were adjusted multiple times based on user feedback (e.g., 2-2-3-2-3, then 3-3-3-1-2 distribution for Row 1; 3-3-3-3 for Row 2, then split Special Survey Cycle into From Date and To Date). Anniversary Date was initially split then reverted to a single field with two inputs.
        -   **Date Formatting Utility:** Added  helper function after imports to ensure consistent date rendering across the application and fix time shift issues in the Duplicate Resolution Modal.
        -   **Duplicate Resolution Modal:**
            -   Updated to use the new  utility function to fix time shift in  and  sections.
            -   Implemented sequential duplicate resolution: Added  state and  function. When multiple duplicates are detected, they are processed one by one. Modal now displays a counter ().
            -   Passed ,  as props to  to resolve runtime errors.
        -   **Add Certificate Button Logic:** Modified to automatically open the Add New Record modal to the Document Portfolio tab and pre-select Certificate document type. This involved adding  state and passing it as a prop.
        -   **Upcoming Surveys Notification Modal:**
            -   Implemented a new modal to display upcoming certificate surveys.
            -   Integrated  function into the login success flow to automatically show the modal.
            -   Initially debugged and fixed modal display issues (e.g.,  runtime errors due to incorrect prop passing or scope issues, resolved by restarting frontend and correctly passing states).
            -   Added a temporary test button to manually trigger the modal for debugging, later removed.
            -   Moved the  definition and rendering from  to the  component and ensured  and  states are correctly managed at the  level.
            -   Added a dedicated Upcoming Survey button next to Update Next Survey to manually trigger the modal.
            -   Updated display logic within the modal to reflect new window rules (e.g., Sắp đến hạn, Quá hạn, Sắp tới statuses).
        -   **Full Edit Modal:** Identified a critical bug where the Save button in the full edit modal does not trigger a PUT request to the backend.

-   ****
    -   **Summary:** Documents UTC date handling principles.
    -   **Summary of Changes:** No direct changes in this trajectory.

-   ****
    -   **Summary:** New documentation detailing certificate status logic.
    -   **Summary of Changes:** No direct changes in this trajectory.
</code_architecture>

<pending_tasks>
- Fix the critical bug where the Save button in the Edit Certificate modal (full edit) does not trigger a PUT request to update certificate data on the backend.
</pending_tasks>

<current_work>
The AI engineer was immediately working on debugging a critical frontend bug in the Edit Certificate modal. When a user edits a certificate using the full modal and clicks the Save button, the changes are not persisted. Automated frontend testing confirmed that the Save button does not trigger any PUT request to the backend API, although the backend API itself for updating certificates was verified as functional. This implies an issue with the event handler or form submission logic specifically within the full edit modal, located around lines 5173-5200 in . The last action involved inspecting the  function as a potential point of failure within the save logic.
</current_work>

<optional_next_step>
I will investigate the Save button's event handler in  to ensure it correctly triggers the PUT request and handles date conversion.
</optional_next_step>
